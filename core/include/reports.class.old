<?php
class reports extends AJAX_library {


	function reports($passedHash=NULL) {
		global $db;

		if ($passedHash)
			$this->current_hash = $passedHash;
		else
			$this->current_hash = $_SESSION['id_hash'];

		$this->form = new form;
		$this->db =& $db;

		# For those instances where we're using unbuffered queries, instantiate a new db object
		$this->db_obj = new DBLayer(DB_HOST, DB_USERNAME, DB_PASSWORD, DB_NAME);

		$this->content['class_name'] = get_class($this);

		$this->p = new permissions($this->current_hash);

		$this->sys = new system_config($this->current_hash);
		$this->sys->fetch_users();
		$this->user_name[] = "All Sales Reps";
		$this->user_hash[] = "";
		for ($i = 0; $i < count($this->sys->user_info); $i++) {
			$this->user_name[] = stripslashes($this->sys->user_info[$i]['full_name']);
			$this->user_hash[] = $this->sys->user_info[$i]['user_hash'];
		}
		// Limit user list if permission checked for Trac #1221
		if ($this->p->ck('proposals', 'S')) {
			$this->sales_name[] = $_SESSION['my_name'];
			$this->sales_hash[] = $_SESSION['id_hash'];
		} else {
			$this->sales_name = $this->user_name;
			$this->sales_hash = $this->user_hash;
			array_shift($this->sales_name);
			array_shift($this->sales_hash);
		}

		$this->sys->fetch_groups();
		for ($i = 0; $i < count($this->sys->group_info); $i++) {
			$this->group_name[] = $this->sys->group_info[$i]['group_name'];
			$this->group_hash[] = $this->sys->group_info[$i]['group_hash'];
		}
		return;
	}

	function doit() {
		global $err, $errStr;

		$this->check = new Validator;

		$action = $_POST['action'];
		$btn = $_POST['actionBtn'];

		$this->popup_id = $_POST['popup_id'];
		$this->content['popup_controls']['popup_id'] = $this->popup_id;

		$active_search = $_POST['active_search'];
		if ($active_search)
			$this->active_search = $active_search;

		if ($action)
			return $this->$action();

		return;
	}

	function fetch_report_settings($report_hash) {
		if (!$report_hash)
			return;

		$result = $this->db->query("SELECT *
									FROM `reports`
									WHERE `report_hash` = '$report_hash'");
		if ($row = $this->db->fetch_assoc($result)) {
			$this->current_report = $row;
			$str = explode("|", $this->current_report['str']);
			for ($i = 0; $i < count($str); $i++) {
				list($var, $val) = explode('=', $str[$i]);
				if (ereg("&", $val))
					$val = explode("&", $val);

				$this->current_report[$var] = $val;
			}
			if ($this->current_report['method_vars'])
				$this->current_report['method_vars'] = unserialize(stripslashes($this->current_report['method_vars']));

			$this->report_hash = $report_hash;

			$result = $this->db->query("SELECT `user_hash` , `group_hash`
										FROM `reports_share`
										WHERE `report_hash` = '".$this->report_hash."'");
			while ($row = $this->db->fetch_assoc($result)) {
				if ($row['user_hash'])
					$this->current_report['sales_rep_share'][] = $row['user_hash'];
				elseif ($row['group_hash'])
					$this->current_report['group_share'][] = $row['group_hash'];
			}
			if (count($this->current_report['sales_rep_share']) || count($this->current_report['group_share']))
				$this->current_report['share'] = 1;

			return true;
		}
		return false;
	}

	function doit_cash_disp() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$detail = $this->current_report['detail'];
			if ($timeframe == 13) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$vendor_filter = $this->current_report['vendor_filter'];
			if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);

		} else {
			$timeframe = $_POST['timeframe'];
			$detail = $_POST['detail'];
			if ($timeframe == 13) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$vendor_filter = $_POST['customer_vendor_filter'];
			if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);
		}

		if ($from_report = $_POST['from_report']) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$detail = $this->current_report['detail'];
			if ($timeframe == 13) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
		}
		$save = $_POST['save'];
		$saved_cat = "cash_disp";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		$from_report = $_POST['from_report'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if (($timeframe == 13 && !$sort_from_date) || ($timeframe == 13 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}

		if ($this->content['error'])
			return;

		switch ($timeframe) {
			//Today
			case 1:
			$sql_p[] = "check_register.check_date = '".date("Y-m-d")."'";
			break;

			//Yesterday
			case 2:
			$sql_p[] = "check_register.check_date = '".date("Y-m-d", strtotime(date("Y-m-d")." -1 day"))."'";
			break;

			//This week
			case 3:
			$week_start = date("Y-m-d", strtotime(date("Y-m-d")." -".date("w")." days"));
			$week_end = date("Y-m-d", strtotime(date("Y-m-d")." +".(6 - date("w"))." days"));
			$sql_p[] = "check_register.check_date BETWEEN '$week_start' AND '$week_end'";
			break;

			//Last week
			case 4:
			$last_week = date("Y-m-d", strtotime(date("Y-m-d")." -1 week"));
			$week_start = date("Y-m-d", strtotime($last_week." -".date("w")." days"));
			$week_end = date("Y-m-d", strtotime($last_week." +".(6 - date("w", strtotime($last_week)))." days"));
			$sql_p[] = "check_register.check_date BETWEEN '$week_start' AND '$week_end'";
			break;

			//This month
			case 5:
			$sql_p[] = "check_register.check_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-".date("t"))."'";
			break;

			//Last Month
			case 6:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}
			$sql_p[] = "check_register.check_date BETWEEN '".$year."-".$month."-01' AND '".$year."-".$month."-".date("t", strtotime($year."-".$month."-01"))."'";
			break;

			//This qtr
			case 7:
			$current_qtr = get_quarter();
			list($start, $end) = get_quarter_dates($current_qtr);
			$sql_p[] = "check_register.check_date BETWEEN '".$start."' AND '".$end."'";
			break;

			//Last qtr
			case 8:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start, $end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "check_register.check_date BETWEEN '".$start."' AND '".$end."'";
			break;

			//This period
			case 9:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "check_register.check_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//Last period
			case 10:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "check_register.check_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//This year
			case 11:
			$sql_p[] = "check_register.check_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			break;

			//Last year
			case 12:
			$sql_p[] = "check_register.check_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			break;

			//Date range
			case 13:
			if ($sort_from_date && $sort_to_date)
				$sql_p[] = "check_register.check_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
			else
				$sql_p[] = "check_register.check_date >= '".$sort_from_date."'";
			break;

		}

		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter, 'add_quotes', "'");
			$sql_p[] = "vendor_payables.vendor_hash IN (".implode(" , ", $vendor_filter).")";
			array_walk($vendor_filter, 'strip_quotes');
		}
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|detail=$detail|vendor_filter=".@implode("&", $vendor_filter);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT vendor_payment.payment_hash , vendor_payment.check_no , vendor_payment.account_hash ,
								    SUM(vendor_payment.payment_amount) AS total_payment , check_register.check_date ,
									check_register.void , vendor_payables.vendor_hash , vendor_payables.type ,
									vendors.vendor_name ,
								    CASE
								    WHEN vendor_payables.type = 'R'
									  	THEN customers.customer_name
									  	ELSE 0
								   	END AS customer_name
									FROM `vendor_payment`
									LEFT JOIN `vendor_payables` ON vendor_payables.invoice_hash = vendor_payment.invoice_hash
									LEFT JOIN `check_register` ON check_register.check_no = vendor_payment.check_no AND check_register.account_hash = vendor_payment.account_hash
									LEFT JOIN `customers` ON customers.customer_hash = vendor_payables.vendor_hash
									LEFT JOIN `vendors` ON vendors.vendor_hash = vendor_payables.vendor_hash
									WHERE check_register.void = 0 ".($sql ? "AND ".$sql : NULL)."
									GROUP BY vendor_payables.vendor_hash , vendor_payment.check_no");
		while ($row = $this->db->fetch_assoc($result)) {
			$payment[$row['vendor_hash']][$row['check_no']][] = $row;
			$vendor_name[$row['vendor_hash']] = ($row['type'] == 'R' ? stripslashes($row['customer_name']) : stripslashes($row['vendor_name']));

			if ($detail) {
				$amount = $date = $invoice_no = '';
				$amount_arr = $date_arr = $invoice_no_arr = array();
				$result2 = $this->db->query("SELECT vendor_payables.invoice_no , vendor_payables.invoice_date ,
											vendor_payment.payment_amount as amount , vendor_payables.invoice_hash , vendor_payables.type
											FROM `vendor_payables`
											LEFT JOIN `vendor_payment` ON vendor_payment.invoice_hash = vendor_payables.invoice_hash
											WHERE vendor_payables.vendor_hash = '".$row['vendor_hash']."' AND vendor_payment.check_no = '".$row['check_no']."' AND vendor_payment.account_hash = '".$row['account_hash']."'
											ORDER BY vendor_payables.invoice_date");
				while ($row2 = $this->db->fetch_assoc($result2)) {
					if ($doit_print)
						 $invoice_no_arr[] = ($row2['type'] == 'R' ? "Customer Refund " : ($row2['type'] == 'D' ? "Deposit " : "Invoice ")) . ($row2['invoice_no'] ? $row2['invoice_no'] : "Unassigned");
					else
						$invoice_no .= "<div style=\"font-size:8pt;\">".($row2['type'] == 'R' ?
							"Customer Refund" : ($row2['type'] == 'D' ? "Deposit" : "Invoice")) ." <a href=\"javascript:void(0);\" onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'popup_id=invoice_detail', 'invoice_hash=".$row2['invoice_hash']."');\" class=\"link_standard\" title=\"View this invoice\">".($row2['invoice_no'] ? $row2['invoice_no'] : "Unassigned")."</a></div>";

					if ($doit_print)
						$date_arr[] = $row2['invoice_date'];
					else
						$date .= "<div style=\"font-size:8pt;\">".date(DATE_FORMAT, strtotime($row2['invoice_date']))."</div>";

					if ($doit_print)
						$amount_arr[] = $row2['amount'];
					else
						$amount .= "<div style=\"font-size:8pt;\">$".number_format($row2['amount'], 2)."</div>";

				}

				$this->detail[$row['vendor_hash']][$row['check_no']]['invoice_no'] = ($doit_print ? $invoice_no_arr : $invoice_no);
				$this->detail[$row['vendor_hash']][$row['check_no']]['date'] = ($doit_print ? $date_arr : $date);
				$this->detail[$row['vendor_hash']][$row['check_no']]['amount'] = ($doit_print ? $amount_arr : $amount);
			}

		}

		//Asending order
		if (is_array($vendor_name)) {
			asort($vendor_name);
			while (list($vendor_hash, $name) = each($vendor_name)) {
				$this->payment[$vendor_hash] = $payment[$vendor_hash];
				$this->vendor_name[$vendor_hash] = $name;
			}
		}
		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->cash_disp(1);
		return;


	}

	function fetch_invoice_payments() {
		$payment_hash = $this->ajax_vars['payment_hash'];
		$check_no = $this->ajax_vars['check_no'];
		$vendor_hash = $this->ajax_vars['vendor_hash'];
		$report_hash = $this->ajax_vars['report_hash'];

		$this->fetch_report_settings($report_hash);

		$result = $this->db->query("SELECT vendor_payables.invoice_no , vendor_payables.invoice_date ,
									vendor_payment.payment_amount as amount , vendor_payables.invoice_hash , vendor_payables.type
									FROM `vendor_payables`
									LEFT JOIN `vendor_payment` ON vendor_payment.invoice_hash = vendor_payables.invoice_hash
									WHERE vendor_payables.vendor_hash = '$vendor_hash' AND vendor_payment.check_no = '$check_no'
									ORDER BY vendor_payables.invoice_date");
		while ($row = $this->db->fetch_assoc($result)) {
			$invoice_no .= "
			<div style=\"font-size:8pt;\">".($row['type'] == 'D' ?
				"Deposit" : ($row['type'] == 'R' ? "Customer Refund" : "Invoice")) . " <a href=\"javascript:void(0);\" onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'popup_id=invoice_detail', 'invoice_hash=".$row['invoice_hash']."');\" class=\"link_standard\" title=\"View this invoice\">".$row['invoice_no']."</a>
			</div>";
			$date .= "
			<div style=\"font-size:8pt;\">".date(DATE_FORMAT, strtotime($row['invoice_date']))."</div>";
			$amount .= "
			<div style=\"font-size:8pt;\">$".number_format($row['amount'], 2)."</div>";
		}

		$this->content['html']['payment_details_invoice_'.$payment_hash] = $invoice_no;
		$this->content['html']['payment_details_date_'.$payment_hash] = $date;
		$this->content['html']['payment_details_amount_'.$payment_hash] = $amount;
		$this->content['jscript'] = "toggle_display('payment_details_".$payment_hash."', 'block');";
		return;
	}


	function cash_disp($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"4\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Cash Disbursements Report").($this->p->ck('reports', 'V', 'cash_disp') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'cash_disp', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=cash_disp', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it_xls', 'type=cash_disp', 'report_hash=".$this->report_hash."', 'popup_id=xls_win');\" ><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:40%;text-align:left;\">Payee</td>
					<td style=\"width:20%;\">Check No.</td>
					<td style=\"width:20%;\" class=\"num_field\">Check Date</td>
					<td class=\"num_field\">Check Amount</td>
				</tr>";

			if (is_array($this->payment)) {
				while (list($vendor_hash, $check_array) = each($this->payment)) {
					$k = 0;
					$total_payments = 0;
					$check_table = '';
					while (list($check_no, $check_data) = each($check_array)) {
						$total_check_payment = 0;
						for ($i = 0; $i < count($check_data); $i++) {
							$total_payments += $check_data[$i]['total_payment'];
							$check_table .= "
							<tr>
								<td style=\"background-color:#ffffff;font-weight:bold;\">".($k == 0 ? stripslashes($this->vendor_name[$vendor_hash]) : NULL)."</td>
								<td style=\"background-color:#ffffff;\">
									<a href=\"javascript:void(0);\" onClick=\"if(\$('payment_details_".$check_data[$i]['payment_hash']."').getStyle('display')=='block'){toggle_display('payment_details_".$check_data[$i]['payment_hash']."', 'none');\$('payment_details_invoice_".$check_data[$i]['payment_hash']."').innerHTML='';\$('payment_details_amount_".$check_data[$i]['payment_hash']."').innerHTML='';\$('payment_details_date_".$check_data[$i]['payment_hash']."').innerHTML='';} else{agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'fetch_invoice_payments', 'check_no=".$check_data[$i]['check_no']."', 'vendor_hash=".$vendor_hash."', 'payment_hash=".$check_data[$i]['payment_hash']."', 'report_hash=".$this->report_hash."');}\" class=\"link_standard\" title=\"View invoices paid by this receipt\">".($check_data[$i]['check_no'] !== NULL ?
										$check_data[$i]['check_no'] : "Unassigned")."
									</a>
								</td>
								<td style=\"background-color:#ffffff;\" class=\"num_field\">".($check_data[$i]['check_date'] ? date(DATE_FORMAT, strtotime($check_data[$i]['check_date'])) : NULL)."</td>
								<td style=\"background-color:#ffffff;\" class=\"num_field\">$".number_format($check_data[$i]['total_payment'], 2)."</td>
							</tr>
							<tr id=\"payment_details_".$check_data[$i]['payment_hash']."\" style=\"display:".($this->current_report['detail'] ? "block" : "none").";\">
								<td style=\"background-color:#ffffff;\"></td>
								<td style=\"background-color:#ffffff;\" id=\"payment_details_invoice_".$check_data[$i]['payment_hash']."\" class=\"num_field\">".($this->current_report['detail'] ? $this->detail[$vendor_hash][$check_data[$i]['check_no']]['invoice_no'] : NULL)."</td>
								<td style=\"background-color:#ffffff;\" id=\"payment_details_date_".$check_data[$i]['payment_hash']."\" class=\"num_field\">".($this->current_report['detail'] ? $this->detail[$vendor_hash][$check_data[$i]['check_no']]['date'] : NULL)."</td>
								<td style=\"background-color:#ffffff;\" id=\"payment_details_amount_".$check_data[$i]['payment_hash']."\"class=\"num_field\">".($this->current_report['detail'] ? $this->detail[$vendor_hash][$check_data[$i]['check_no']]['amount'] : NULL)."</td>
							</tr>";
							$k++;
						}
					}
					if ($vendor_hash) {
						$tbl .=
						$check_table ."
						<tr>
							<td colspan=\"4\" style=\"background-color:#cccccc;\"></td>
						</tr>";
						$grand_total += $total_payments;
					}
				}
			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"4\">There are no results to show.</td>
				</tr>";

			$tbl .= "
				<tr style=\"background-color:#ffffff;\" >
					<td style=\"padding-top:25px;background-color:#efefef;\" colspan=\"3\"></td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:12pt;background-color:#efefef;\" class=\"num_field\">$".number_format($grand_total, 2)."</td>
				</tr>
			</table>".
			$this->form->close_form();

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_cash_disp');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_cash_disp', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Cash Disbursements Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("Today",
																		  "Yesterday",
																		  "This Week",
																		  "Last Week",
																    	  "This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																		  "To Date",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9,
																		  10,
																		  11,
																		  12,
																		  '*',
																		  13), "onChange=if(this.options[this.selectedIndex].value==13){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 13 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Invoice Detail?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("detail", array("Show Detail View", "Show Simple View"), $this->current_report['detail'], array(1, 0), "blank=1")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer_vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
														$tbl .= "<div id=\"customer_vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}


	function doit_po_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$paginate = $_POST['paginate'];
		$from_saved = $this->ajax_vars['from_saved'];

		if(($report_hash && ($doit_print || $from_saved)) || ($paginate)){
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 13) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$vendor_filter = $this->current_report['vendor_filter'];
			$sales_rep_match = $this->current_report['sales_rep_match'];
	        if ($sales_rep_match && !is_array($sales_rep_match))
	            $sales_rep_match = array($sales_rep_match);

		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 13) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$vendor_filter = $_POST['customer_vendor_filter'];
			$sales_rep_match = $_POST['sales_rep_match'];
		}

		if ($vendor_filter && !is_array($vendor_filter))
			$vendor_filter = array($vendor_filter);
		if ($sales_rep_match && !is_array($sales_rep_match))
			$sales_rep_match = array($sales_rep_match);
		if ($paginate = $_POST['paginate']) {
			$this->fetch_report_settings($report_hash);
			$p = $_POST['p'];
		}


		if ($from_report = $_POST['from_report']) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 13) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
		}

		$save = $_POST['save'];
		$saved_cat = "po_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		$from_report = $_POST['from_report'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if (($timeframe == 13 && !$sort_from_date) || ($timeframe == 13 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}

		if ($this->content['error'])
			return;

		switch ($timeframe) {
			//Today
			case 1:
			$sql_p[] = "purchase_order.po_date = '".date("Y-m-d")."'";
			$this->report_title = "Purchase orders dated ".date(DATE_FORMAT);
			break;

			//Yesterday
			case 2:
			$sql_p[] = "purchase_order.po_date = '".date("Y-m-d", strtotime(date("Y-m-d")." -1 day"))."'";
			$this->report_title = "Purchase orders dated ".date(DATE_FORMAT, strtotime(date("Y-m-d")." -1 day"));
			break;

			//This week
			case 3:
			$week_start = date("Y-m-d", strtotime(date("Y-m-d")." -".date("w")." days"));
			$week_end = date("Y-m-d", strtotime(date("Y-m-d")." +".(6 - date("w"))." days"));
			$sql_p[] = "purchase_order.po_date BETWEEN '$week_start' AND '$week_end'";
			$this->report_title = "Purchase orders dated between ".date(DATE_FORMAT, strtotime($week_start))." and ".date(DATE_FORMAT, strtotime($week_end));
			break;

			//Last week
			case 4:
			$last_week = date("Y-m-d", strtotime(date("Y-m-d")." -1 week"));
			$week_start = date("Y-m-d", strtotime($last_week." -".date("w")." days"));
			$week_end = date("Y-m-d", strtotime($last_week." +".(6 - date("w", strtotime($last_week)))." days"));
			$sql_p[] = "purchase_order.po_date BETWEEN '$week_start' AND '$week_end'";
			$this->report_title = "Purchase orders dated between ".date(DATE_FORMAT, strtotime($week_start))." and ".date(DATE_FORMAT, strtotime($week_end));
			break;

			//This month
			case 5:
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-".date("t"))."'";
			$this->report_title = "Purchase orders dated between ".date(DATE_FORMAT, strtotime(date("Y-m-01")))." and ".date(DATE_FORMAT, strtotime(date("Y-m-".date("t"))));
			break;

			//Last Month
			case 6:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}
			$sql_p[] = "purchase_order.po_date BETWEEN '".$year."-".$month."-01' AND '".$year."-".$month."-".date("t", strtotime($year."-".$month."-01"))."'";
			$this->report_title = "Purchase orders dated between ".date(DATE_FORMAT, strtotime(date($year."-".$month."-01")))." and ".date(DATE_FORMAT, strtotime(date($year."-".$month."-".date("t", strtotime($year."-".$month."-01")))));
			break;

			//This Quarter
			case 7:
			list($this->report_date_start, $this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")), date("Y"));
			$sql_p[] = "purchase_order.po_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$this->report_title = "Purchase orders dated between ".date(DATE_FORMAT, strtotime($this->report_date_start))." and ".date(DATE_FORMAT, strtotime($this->report_date_end));
			break;

			//Last Quarter
			case 8:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $date) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "purchase_order.po_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$this->report_title = "Purchase orders dated between ".date(DATE_FORMAT, strtotime($this->report_date_start))." and ".date(DATE_FORMAT, strtotime($this->report_date_end));
			break;

			//This period
			case 9:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$this->report_title = "Purchase orders dated between ".date(DATE_FORMAT, strtotime($period_info['period_start']))." and ".date(DATE_FORMAT, strtotime($period_info['period_end']));
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//Last period
			case 10:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$this->report_title = "Purchase orders dated between ".date(DATE_FORMAT, strtotime($period_info['period_start']))." and ".date(DATE_FORMAT, strtotime($period_info['period_end']));
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//This year
			case 11:
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			$this->report_title = "Purchase orders dated ".date("Y");
			break;

			//Last year
			case 12:
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			$this->report_title = "Purchase orders dated ".(date("Y")-1);
			break;

			//Date range
			case 13:
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = "purchase_order.po_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = "Purchase orders dated between ".date(DATE_FORMAT, strtotime($sort_from_date))." and ".date(DATE_FORMAT, strtotime($sort_to_date));
			} else {
				$sql_p[] = "purchase_order.po_date >= '".$sort_from_date."'";
				$this->report_title = "Purchase orders dated after ".date(DATE_FORMAT, strtotime($sort_from_date));
			}
			break;

			//To Date
			case '*':
				$this->report_title  = "Purchase orders as of ".date(DATE_FORMAT);
				break;

		}

		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter, 'add_quotes', "'");
			$sql_p[] = "purchase_order.vendor_hash IN (".implode(" , ", $vendor_filter).")";
			array_walk($vendor_filter, 'strip_quotes');
		}
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			$sales_rep_match = array_unique($sales_rep_match);
			$sales_rep_match = array_values($sales_rep_match);
			array_walk($sales_rep_match, 'add_quotes', "'");
			$sql_p[] = "proposals.sales_hash IN (".implode(" , ", $sales_rep_match).")";
			array_walk($sales_rep_match, 'strip_quotes');
		}
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|vendor_filter=".@implode("&", $vendor_filter)."|sales_rep_match=".@implode("&", $sales_rep_match);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		//Count first
		$result = $this->db->query("SELECT COUNT(*) AS Total
									FROM `purchase_order`
									LEFT JOIN `line_items` ON line_items.po_hash = purchase_order.po_hash
									LEFT JOIN `proposals` ON proposals.proposal_hash = purchase_order.proposal_hash
									WHERE ".($sql ?
                                        $sql." AND " : NULL)."purchase_order.deleted = 0
									GROUP BY line_items.po_hash");
		$this->po_total = $this->db->num_rows($result);
		if ($paginate) {
			$num_pages = ceil($this->po_total / 30);
			$p = (!isset($p) || $p <= 1 || $p > $num_pages) ? 1 : $p;
			$start_from = 30 * ($p - 1);
			$end = $start_from + 30;
			if ($end > $this->po_total);
				$end = $this->po_total;

			$this->ajax_vars['p'] = $p;
		} else {
			$start_from = 0;
			$end = 30;
			if ($end > $this->po_total);
				$end = $this->po_total;
		}
		if ($this->po_total > 0) {
			$result = $this->db->query("SELECT purchase_order.po_hash , purchase_order.po_no , purchase_order.proposal_hash ,
										purchase_order.po_date , purchase_order.order_amount , purchase_order.vendor_hash , proposals.proposal_no ,
										proposals.proposal_descr , proposals.sales_hash , customers.customer_name , vendors.vendor_name,
										users.full_name , SUM(line_items.qty * line_items.sell) AS ext_sell
										FROM `purchase_order`
										LEFT JOIN `proposals` ON proposals.proposal_hash = purchase_order.proposal_hash
										LEFT JOIN `vendors` ON vendors.vendor_hash = purchase_order.vendor_hash
										LEFT JOIN `line_items` ON line_items.po_hash = purchase_order.po_hash
										LEFT JOIN `customers` ON customers.customer_hash = proposals.customer_hash
										LEFT JOIN `users` ON users.id_hash = proposals.sales_hash
										WHERE ".($sql ?
                                            $sql." AND " : NULL)."purchase_order.deleted = 0
										GROUP BY line_items.po_hash
										LIMIT $start_from , $end");
			while ($row = $this->db->fetch_assoc($result)) {
				$po[$row['vendor_hash']][$row['proposal_hash']][] = $row;
				$this->vendor[$row['vendor_hash']] = $row['vendor_name'];
			}

			//Asending order
			@asort($this->vendor);
			if (is_array($this->vendor)) {
				while (list($hash, $name) = each($this->vendor))
					$this->po[$hash] =& $po[$hash];
			}
		}
		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->po_report(1);
		return;


	}

	function po_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);

			$p = $this->ajax_vars['p'];
			$order = $this->ajax_vars['order'];
			$order_dir = $this->ajax_vars['order_dir'];

			$num_pages = ceil($this->po_total / 30);
			$p = (!isset($p) || $p <= 1 || $p > $num_pages) ? 1 : $p;
			$start_from = 30 * ($p - 1);

			$end = $start_from + 30;
			if ($end > $this->po_total)
				$end = $this->po_total;

			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"4\">".($this->po_total ? "
						<div style=\"float:right;padding-right:15px;\">
						".paginate_jscript($num_pages, $p, 'sf_loadcontent', 'cf_loadcontent', 'reports', 'doit_po_report', $order, $order_dir, "'report_hash=".$this->report_hash."', 'paginate=1'")."
						</div>" : NULL)."
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Purchase Order Report").($this->p->ck('reports', 'V', 'po') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'po_report', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp; &nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=po_report', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>";
			if (is_array($this->po)) {
				while (list($vendor_hash, $proposal_array) = each($this->po)) {
					$vendor_total = 0;
					$inside_tbl = '';
					while (list($proposal_hash, $proposal_list) = each($proposal_array)) {
						$inside_tbl .= "
						<div style=\"font-weight:bold;font-size:12px;margin-bottom:3px;\">
							<div style=\"font-weight:normal;float:right;\">Sales Rep: ".stripslashes($proposal_list[0]['full_name'])."</div>
							Proposal: <a href=\"javascript:void(0);\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$proposal_hash."', 'popup_id=proposal_win', 'from_report=1');\" title=\"View proposal\" class=\"link_standard\">".$proposal_list[0]['proposal_no']."</a>
							 : ".stripslashes($proposal_list[0]['customer_name'])."
						</div>
						<table style=\"width:100%;border:1px solid #cccccc\" cellpadding=\"3\" cellspacing=\"0\">
							<tr>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;\">PO No.</td>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;padding-left:15px;\">Date</td>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">Order Cost</td>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">Sell Amount</td>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>
							</tr>";
						$total_cost = $total_sell = $total_profit = 0;
						for ($i = 0; $i < count($proposal_list); $i++) {
							$total_cost += $proposal_list[$i]['order_amount'];
							$total_sell += $proposal_list[$i]['ext_sell'];
							$total_profit += ($proposal_list[$i]['ext_sell'] - $proposal_list[$i]['order_amount']);
							$inside_tbl .= "
							<tr >
								<td style=\"font-size:10px;border-bottom:1px solid #cccccc;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('purchase_order', 'sf_loadcontent', 'show_popup_window', 'edit_po', 'proposal_hash=".$proposal_hash."', 'po_hash=".$proposal_list[$i]['po_hash']."', 'popup_id=po_win');\" class=\"link_standard\" title=\"View purchase order\">".$proposal_list[$i]['po_no']."</a></td>
								<td style=\"font-size:10px;border-bottom:1px solid #cccccc;\">".date(DATE_FORMAT, strtotime($proposal_list[$i]['po_date']))."</td>
								<td style=\"font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">$".number_format($proposal_list[$i]['order_amount'], 2)."</td>
								<td style=\"font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">$".number_format($proposal_list[$i]['ext_sell'], 2)."</td>
								<td style=\"font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">".($proposal_list[$i]['ext_sell'] - $proposal_list[$i]['order_amount'] < 0 ?
									"($".number_format(($proposal_list[$i]['ext_sell'] - $proposal_list[$i]['order_amount']) * -1, 2).")" : "$".number_format($proposal_list[$i]['ext_sell'] - $proposal_list[$i]['order_amount'], 2))."
								</td>
								<td class=\"num_field\" style=\"font-size:10px;border-bottom:1px solid #cccccc;" .
    							( defined('MARGIN_FLAG') && bccomp( math::gp_margin( array(
	        							'cost'   =>  $proposal_list[$i]['order_amount'],
	        							'sell'   =>  $proposal_list[$i]['ext_sell']
	    							) ), (float)MARGIN_FLAG, 4) == -1 ?
    	    							"color:#ff0000;" : NULL
	    						) . "\">" .
	    						(float)bcmul( math::gp_margin( array(
		    						'cost'   =>  $proposal_list[$i]['order_amount'],
		    						'sell'   =>  $proposal_list[$i]['ext_sell']
	    						) ), 100, 4) . "%
	    						</td>
							</tr>";
						}

						$inside_tbl .= "
							<tr >
								<td style=\"font-size:10px;\">&nbsp;</td>
								<td style=\"font-size:10px;\">&nbsp;</td>
								<td style=\"font-size:10px;\" class=\"num_field\">$".number_format($total_cost, 2)."</td>
								<td style=\"font-size:10px;\" class=\"num_field\">$".number_format($total_sell, 2)."</td>
								<td style=\"font-size:10px;\" class=\"num_field\">".($total_sell - $total_cost < 0 ?
									"($".number_format(($total_sell - $total_cost) * -1, 2).")" : "$".number_format($total_sell - $total_cost, 2))."
								</td>
								<td style=\"font-size:10px;" .
        						( defined('MARGIN_FLAG') && bccomp( math::gp_margin( array(
	        						'cost'    =>  $total_cost,
	        						'sell'    =>  $total_sell
	        						) ), (float)MARGIN_FLAG, 4) == -1 ?
    	        						"color:#ff0000;" : NULL
	        					) . "\" class=\"num_field\">" .
	        					(float)bcmul( math::gp_margin( array(
		        					'cost'    =>  $total_cost,
		        					'sell'    =>  $total_sell
	        					) ), 100, 4) . "%
	        					</td>
							</tr>
						</table>";

						$vendor_total = bcadd($vendor_total, $total_cost, 2);
					}
					$tbl .= "
					<tr style=\"background-color:#ffffff;\">
						<td colspan=\"4\">
							<div style=\"float:right;font-size:13px;margin-top:15px;font-weight:bold;\">
								$".number_format($vendor_total, 2)."
							</div>
							<div style=\"font-weight:bold;margin-left:15px;margin-top:15px;font-size:13px;\">
								<a href=\"javascript:void(0);\" onClick=\"submit_form(\$('popup_id').form, 'reports', 'exec_post', 'refresh_form', 'action=doit_backlog_report', 'vendor_filter[]=".$vendor_hash."', 'from_report=1');\" title=\"Filter to this vendor\" class=\"link_standard\">".$this->vendor[$vendor_hash]."</a>
							</div>
							<div style=\"margin:10px 0 10px 25px;\">".$inside_tbl."</div>
						</td>
					</tr>";
					$grand_total += $vendor_total;
				}
				$tbl .= "
					<tr style=\"background-color:#ffffff;\">
						<td style=\"font-weight:bold;font-size:13px;vertical-align:bottom;padding-top:15px;text-align:right;\" colspan=\"4\">
							<table cellpadding=\"3\">
								<tr>
									<td style=\"text-align:right;\">Purchase Order Total: </td>
									<td style=\"text-align:left;\"> $".number_format($grand_total, 2)."</td>
								</tr>
							</table>
						</td>
					</tr>";

			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"4\">There are no results to show.</td>
				</tr>";

			$tbl .= "
			</table>".
			$this->form->close_form();

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);

			$tbl = $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_po_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_po_report', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Purchase Order Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("Today",
																		  "Yesterday",
																		  "This Week",
																		  "Last Week",
																    	  "This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																		  "To Date",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9,
																		  10,
																		  11,
																		  12,
																		  '*',
																		  13), "onChange=if(this.options[this.selectedIndex].value==13){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 13 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer_vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
														$tbl .= "<div id=\"customer_vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]", $this->sales_name, (is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')), $this->sales_hash, "multiple", "blank=1", "size=4", "style=width:200px;", ($this->p->ck('proposals', 'S') ? "disabled" : NULL))."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_cash_receipts() {

		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ( $_POST['rm'] == 1 && $_POST['report_hash'] ) {

			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";

			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_report = $_POST['from_report'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ( $report_hash && ( $doit_print || $from_report || $from_saved ) ) {

			$this->fetch_report_settings($report_hash);

			$timeframe = $this->current_report['timeframe'];
			$detail = $this->current_report['detail'];

			if ( $timeframe == 13 ) {

				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}

			$customer_filter = $this->current_report['customer_filter'];
			if ( $customer_filter && ! is_array($customer_filter) )
				$customer_filter = array($customer_filter);

		} else {

			$detail = $_POST['detail'];
			$timeframe = $_POST['timeframe'];
			if ( $timeframe == 13 ) {

				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}

			$customer_filter = $_POST['customer_filter'];
		}

		$save = $_POST['save'];
		$saved_cat = "cash_receipts";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];

		if ( ! $save )
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);

		if ( $save && ! $report_name ) {

			$e = 1;
			$this->set_error_msg("In order to save this report you must give the report a name.");
		}

		if ( $save && ! $report_hash ) {

			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '{$this->current_hash}' AND `saved` = 1 AND `report_name` = '" . addslashes($report_name) . "'");
			if ( $this->db->result($result, 0, 'Total') ) {

				$e = 1;
				$this->set_error_msg("You already have a report saved under the same name! Please make sure you are not creating a duplicate.");
			}
		}

		if ( $share && ! count($sales_rep_share) && ! count($group_share) ) {

			$e = 1;
			$this->set_error_msg("In order to share this report please select a user or group to share to.");
		}

		if ( ( $timeframe == 13 && ! $sort_from_date ) || ( $timeframe == 13 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date) ) ) {

			$e = 1;
			$this->set_error_msg("The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.");
		}

		if ( $e )
			return $this->__trigger_error(NULL, E_USER_NOTICE, __FILE__, __LINE__, 1);

		switch ( $timeframe ) {

			//Today
			case 1:
			$sql_p[] = "customer_payment.receipt_date = '".date("Y-m-d")."'";
			break;

			//Yesterday
			case 2:
			$sql_p[] = "customer_payment.receipt_date = '".date("Y-m-d", strtotime(date("Y-m-d")." -1 day"))."'";
			break;

			//This week
			case 3:
			$week_start = date("Y-m-d", strtotime(date("Y-m-d")." -".date("w")." days"));
			$week_end = date("Y-m-d", strtotime(date("Y-m-d")." +".(6 - date("w"))." days"));
			$sql_p[] = "customer_payment.receipt_date BETWEEN '$week_start' AND '$week_end'";
			break;

			//Last week
			case 4:
			$last_week = date("Y-m-d", strtotime(date("Y-m-d")." -1 week"));
			$week_start = date("Y-m-d", strtotime($last_week." -".date("w")." days"));
			$week_end = date("Y-m-d", strtotime($last_week." +".(6 - date("w", strtotime($last_week)))." days"));
			$sql_p[] = "customer_payment.receipt_date BETWEEN '$week_start' AND '$week_end'";
			break;

			//This month
			case 5:
			$sql_p[] = "customer_payment.receipt_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-".date("t"))."'";
			break;

			//Last Month
			case 6:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}
			$sql_p[] = "customer_payment.receipt_date BETWEEN '".$year."-".$month."-01' AND '".$year."-".$month."-".date("t", strtotime($year."-".$month."-01"))."'";
			break;

			//This qtr
			case 7:
			$current_qtr = get_quarter();
			list($start, $end) = get_quarter_dates($current_qtr);

			$sql_p[] = "customer_payment.receipt_date BETWEEN '".$start."' AND '".$end."'";
			break;

			//Last qtr
			case 8:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start, $end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "customer_payment.receipt_date BETWEEN '".$start."' AND '".$end."'";
			break;

			//This period
			case 9:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//Last period
			case 10:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//This year
			case 11:
			$sql_p[] = "customer_payment.receipt_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			break;

			//Last year
			case 12:
			$sql_p[] = "customer_payment.receipt_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			break;

			//Date range
			case 13:
			if ($sort_from_date && $sort_to_date)
				$sql_p[] = "customer_payment.receipt_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
			else
				$sql_p[] = "customer_payment.receipt_date >= '".$sort_from_date."'";
			break;

		}

		if ( is_array($customer_filter) && count($customer_filter) ) {

			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter, 'add_quotes', "'");

			$sql_p[] = "customer_invoice.customer_hash IN (" . implode(", ", $customer_filter) . ")";
			array_walk($customer_filter, 'strip_quotes');
		}

		if ( $sql_p )
			$this->sql = $sql = implode(" AND ", $sql_p);

		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|detail=$detail|customer_filter=" . implode("&", $customer_filter);

		if ( ! $report_hash ) {

			$report_hash = rand_hash('reports', 'report_hash');

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}

		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT
	                            		customer_payment.payment_hash,
	                            		customer_payment.check_no,
	                            		SUM( customer_payment.receipt_amount ) AS total_reciept,
	                            		customer_payment.receipt_date,
										customer_invoice.customer_hash,
										customer_invoice.invoice_to,
										customers.customer_name,
									    CASE
									    WHEN customer_invoice.invoice_to = 'V' THEN
										  	vendors.vendor_name ELSE
										  	0
									   	END AS vendor_name
									FROM customer_payment
									LEFT JOIN customer_invoice ON customer_invoice.invoice_hash = customer_payment.invoice_hash AND customer_invoice.deleted = 0
                                    LEFT JOIN proposals ON proposals.proposal_hash = customer_invoice.proposal_hash
									LEFT JOIN customers ON customers.customer_hash = customer_invoice.customer_hash
									LEFT JOIN vendors ON vendors.vendor_hash = customer_invoice.customer_hash
									WHERE " .
                            		( $sql ?
										"$sql AND " : NULL
                            		) . "customer_payment.reconciled = 0 AND ISNULL( customer_payment.applied_from ) AND customer_payment.deleted = 0
									GROUP BY customer_invoice.customer_hash, customer_payment.check_no
									ORDER BY customers.customer_name, customer_payment.check_no ASC");
		while ( $row = $this->db->fetch_assoc($result) ) {

			$this->payment[ $row['customer_hash'] ][ $row['check_no'] ][] = $row;
			$this->customer_name[ $row['customer_hash'] ] = ( $row['invoice_to'] == 'V' ? stripslashes($row['vendor_name']) : stripslashes($row['customer_name']) );
			if ( $detail ) {

				$amount = $date = $invoice_no = '';
				$amount_arr = $date_arr = $invoice_no_arr = array();
				$r_2 = $this->db->query("SELECT
	                        				 customer_invoice.invoice_no,
	                        				 customer_invoice.invoice_date,
	                        				 customer_invoice.proposal_hash,
											 customer_payment.receipt_amount AS amount,
											 customer_invoice.invoice_hash,
											 customer_invoice.type,
											 customer_payment.receipt_date
										 FROM customer_invoice
										 LEFT JOIN customer_payment ON customer_payment.invoice_hash = customer_invoice.invoice_hash AND customer_payment.deleted = 0
										 WHERE customer_invoice.customer_hash = '{$row['customer_hash']}' AND customer_payment.check_no = '{$row['check_no']}' AND customer_payment.reconciled = 0 AND customer_payment.deleted = 0 " .
										 ( $this->sql ?
    										 " AND {$this->sql} " : NULL
										 ) . "
										 ORDER BY customer_invoice.invoice_date");
				while ( $row2 = $this->db->fetch_assoc($r_2) ) {

					if ( $doit_print ) {

						$invoice_no_arr[] = $row2['invoice_no'];
						$date_arr[] = date(DATE_FORMAT, strtotime($row2['receipt_date']));
						$amount_arr[] = $row2['amount'];
					} else {

						$invoice_no .= "
						<div style=\"font-size:8pt;\">" .
						( $row2['type'] == 'D' ?
							"<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'new_deposit', 'popup_id=invoice_detail', 'invoice_hash={$row2['invoice_hash']}', 'proposal_hash={$row2['proposal_hash']}');\" class=\"link_standard\" title=\"View this deposit\">Deposit</a>" : "Invoice <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'popup_id=invoice_detail', 'invoice_hash={$row2['invoice_hash']}');\" class=\"link_standard\" title=\"View this invoice\">{$row2['invoice_no']}</a>"
						) . "
						</div>";

						$date .= "
						<div style=\"font-size:8pt;\">" . date(DATE_FORMAT, strtotime($row2['receipt_date'])) . "</div>";

						$amount .= "
						<div style=\"font-size:8pt;\">" .
						( bccomp($row2['amount'], 0, 2) == -1 ?
    						"(\$" . number_format( (float)bcmul($row2['amount'], -1, 2), 2) . ")" : "\$" . number_format($row2['amount'], 2)
						) . "
						</div>";
					}
				}

				if ( $doit_print ) {

					$this->detail[ $row['customer_hash'] ][ $row['check_no'] ]['invoice_no'] = $invoice_no_arr;
					$this->detail[ $row['customer_hash'] ][ $row['check_no'] ]['date'] = $date_arr;
					$this->detail[ $row['customer_hash'] ][ $row['check_no'] ]['amount'] = $amount_arr;
				} else {

					$this->detail[ $row['customer_hash'] ][ $row['check_no'] ]['invoice_no'] = $invoice_no;
					$this->detail[ $row['customer_hash'] ][ $row['check_no'] ]['date'] = $date;
					$this->detail[ $row['customer_hash'] ][ $row['check_no'] ]['amount'] = $amount;
				}
			}
		}

		# Asending order
		#if (is_array($customer_name)) {
		#	@ksort($customer_name);
		#	while (list($customer_hash, $name) = each($customer_name)) {
		#		$this->payment[$customer_hash] = $payment[$customer_hash];
		#		$this->customer_name[$customer_hash] = $customer_name[$customer_hash];
		#	}
		#}

        # $this->customer_name =& $customer_name;

		if ( $from_report )
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';

		if ( ! $doit_print )
			$this->content['html']['place_holder'] = $this->cash_receipts(1);

		return;
	}

	function fetch_invoice_receipts() {
		$payment_hash = $this->ajax_vars['payment_hash'];
		$check_no = $this->ajax_vars['check_no'];
		$customer_hash = $this->ajax_vars['customer_hash'];
		$report_hash = $this->ajax_vars['report_hash'];
		$sql = base64_decode($this->ajax_vars['sql']);

		$this->fetch_report_settings($report_hash);

		$result = $this->db->query("SELECT customer_invoice.invoice_no , customer_invoice.invoice_date , customer_invoice.proposal_hash ,
									customer_payment.receipt_amount AS amount , customer_invoice.invoice_hash , customer_invoice.type , customer_payment.receipt_date
									FROM `customer_invoice`
									LEFT JOIN `customer_payment` ON customer_payment.invoice_hash = customer_invoice.invoice_hash
									WHERE customer_invoice.customer_hash = '$customer_hash' AND customer_payment.check_no = '$check_no' AND customer_payment.reconciled = 0 AND customer_payment.deleted = 0".
									($sql ? " AND $sql" : NULL)."
									ORDER BY customer_invoice.invoice_date");
		while ($row = $this->db->fetch_assoc($result)) {
			$invoice_no .= "
			<div style=\"font-size:8pt;\">".($row['type'] == 'D' ?
				"<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'new_deposit', 'popup_id=invoice_detail', 'invoice_hash=".$row['invoice_hash']."', 'proposal_hash=".$row['proposal_hash']."');\" class=\"link_standard\" title=\"View this deposit\">Deposit</a>" : "Invoice <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'popup_id=invoice_detail', 'invoice_hash=".$row['invoice_hash']."');\" class=\"link_standard\" title=\"View this invoice\">".$row['invoice_no']."</a>")."
			</div>";
			$date .= "
			<div style=\"font-size:8pt;\">".date(DATE_FORMAT, strtotime($row['receipt_date']))."</div>";
			$amount .= "
			<div style=\"font-size:8pt;\">$".number_format($row['amount'], 2)."</div>";
		}

		$this->content['html']['receipt_details_invoice_'.$payment_hash] = $invoice_no;
		$this->content['html']['receipt_details_date_'.$payment_hash] = $date;
		$this->content['html']['receipt_details_amount_'.$payment_hash] = $amount;
		$this->content['jscript'] = "toggle_display('receipt_details_".$payment_hash."', 'block');";
		return;
	}

	function cash_receipts($step=NULL) {

		$this->unlock("_");

		if ( $step ) {

			$this->fetch_report_settings($this->report_hash);

			$tbl =
			$this->form->form_tag() .
			$this->form->hidden( array(
    			'test'       => 1,
    			'popup_id'   => ''
			) ) . "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"4\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">" .
							( $this->current_report['saved'] ?
								stripslashes($this->current_report['report_name']) : "Cash Receipts Report"
							) .
							( $this->p->ck('reports', 'V', 'cash_receipts') ?
    							"<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
									[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'cash_receipts', 'popup_id=report_filter', 'report_hash={$this->report_hash}');\" class=\"link_standard\">Update Report Settings</a></small>]
								</span>" : NULL
							) . "
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=cash_receipts', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it_xls', 'type=cash_receipts', 'report_hash=".$this->report_hash."', 'popup_id=xls_win')\"><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:40%;text-align:left;\">Customer</td>
					<td style=\"width:20%;\">Check No.</td>
					<td style=\"width:20%;\" class=\"num_field\">Receipt Date</td>
					<td class=\"num_field\">Receipt Amount</td>
				</tr>";

			if ( $this->payment ) {

				while ( list($customer_hash, $check_array) = each($this->payment) ) {

					$total_receipts = 0;
					$check_table = '';

					while ( list($check_no, $check_data) = each($check_array) ) {

						$total_check_receipt = 0;
						for ( $i = 0; $i < count($check_data); $i++ ) {

							$total_check_receipt = bcadd($total_check_receipt, $check_data[$i]['total_reciept'], 2);
							$total_receipts = bcadd($total_receipts, $check_data[$i]['total_reciept'], 2);

							$check_table .= "
							<tr>
								<td style=\"background-color:#ffffff;\"></td>
								<td style=\"background-color:#ffffff;\">
									<a href=\"javascript:void(0);\" onClick=\"if(\$('receipt_details_{$check_data[$i]['payment_hash']}').getStyle('display')=='block'){toggle_display('receipt_details_{$check_data[$i]['payment_hash']}', 'none');\$('receipt_details_invoice_{$check_data[$i]['payment_hash']}').innerHTML='';\$('receipt_details_amount_{$check_data[$i]['payment_hash']}').innerHTML='';\$('receipt_details_date_{$check_data[$i]['payment_hash']}').innerHTML='';} else{agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'fetch_invoice_receipts', 'check_no={$check_data[$i]['check_no']}', 'customer_hash={$customer_hash}', 'payment_hash={$check_data[$i]['payment_hash']}', 'report_hash={$this->report_hash}', 'sql=" . base64_encode($this->sql) . "');}\" class=\"link_standard\" title=\"View invoices paid by this receipt\">" .
									( $check_data[$i]['check_no'] ?
										$check_data[$i]['check_no'] : "Unassigned"
									) . "
									</a>
								</td>
								<td style=\"background-color:#ffffff;\" class=\"num_field\">" . date(DATE_FORMAT, strtotime($check_data[$i]['receipt_date'])) . "</td>
								<td style=\"background-color:#ffffff;\" class=\"num_field\">" .
								( bccomp($total_check_receipt, 0, 2) == -1 ?
    								"(\$" . number_format( (float)bcmul($total_check_receipt, -1, 2), 2) . ")" : "\$" . number_format($total_check_receipt, 2)
								) . "
								</td>
							</tr>
							<tr id=\"receipt_details_{$check_data[$i]['payment_hash']}\" style=\"display:" . ( $this->current_report['detail'] ? "block" : "none" ) . ";\">
								<td style=\"background-color:#ffffff;\"></td>
								<td style=\"background-color:#ffffff;\" id=\"receipt_details_invoice_".$check_data[$i]['payment_hash']."\" class=\"num_field\">" .
    							( $this->current_report['detail'] ?
        							$this->detail[ $customer_hash ][ $check_data[$i]['check_no'] ]['invoice_no'] : NULL
        						) . "
        						</td>
								<td style=\"background-color:#ffffff;\" id=\"receipt_details_date_{$check_data[$i]['payment_hash']}\" class=\"num_field\">" .
								( $this->current_report['detail'] ?
    								$this->detail[ $customer_hash ][ $check_data[$i]['check_no'] ]['date'] : NULL
    							) . "
    							</td>
								<td style=\"background-color:#ffffff;\" id=\"receipt_details_amount_{$check_data[$i]['payment_hash']}\" class=\"num_field\">" .
								( $this->current_report['detail'] ?
    								$this->detail[ $customer_hash ][ $check_data[$i]['check_no'] ]['amount'] : NULL
    							) . "
    							</td>
							</tr>";
						}
					}

					if ( $customer_hash ) {

						$tbl .= "
						<tr>
							<td style=\"background-color:#ffffff;font-weight:bold;\">" . stripslashes($this->customer_name[ $customer_hash ]) . "</td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\"></td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\"></td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\"></td>
						</tr>
						$check_table
						<tr>
							<td colspan=\"3\" style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;\">&nbsp;</td>
							<td style=\"background-color:#ffffff;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">
    							<div style=\"padding-top:10px;border-top:2px solid #cccccc;width:95%;\">" .
								( bccomp($total_receipts, 0, 2) == -1 ?
	    							"(\$" . number_format( (float)bcmul($total_receipts, -1, 2), 2) . ")" : "\$" . number_format($total_receipts, 2)
								) . "
								</div>
							</td>
						</tr>";

						$grand_total = bcadd($grand_total, $total_receipts, 2);
					}
				}

			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"border-top:1px solid #8f8f8f;padding-top:15px;\" colspan=\"4\">There are no results to show.</td>
				</tr>";


			$tbl .= "
				<tr style=\"background-color:#ffffff;\" >
					<td style=\"padding-top:25px;background-color:#efefef;\" colspan=\"3\"></td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:12pt;background-color:#efefef;\" class=\"num_field\">" .
        			( bccomp($grand_total, 0, 2) == -1 ?
            			"(\$" . number_format( (float)bcmul($grand_total, -1, 2), 2) . ")" : "\$" . number_format($grand_total, 2)
        			) . "
        			</td>
				</tr>
			</table>" .
			$this->form->close_form();

			return $tbl;

		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_cash_receipts');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_cash_receipts', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Cash Receipts Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("Today",
																		  "Yesterday",
																		  "This Week",
																		  "Last Week",
																    	  "This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																		  "To Date",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9,
																		  10,
																		  11,
																		  12,
																		  '*',
																		  13), "onChange=if(this.options[this.selectedIndex].value==13){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 13 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Invoice Detail?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("detail", array("Show Detail View", "Show Simple View"), $this->current_report['detail'], array(1, 0), "blank=1")."</td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

    function doit_ar() {
        $date = date("U") - 3600;
        $result = $this->db->query("DELETE FROM `reports`
                                    WHERE `saved` = 0 AND `timestamp` <= '$date'");

        if ($_POST['rm'] == 1 && $_POST['report_hash']) {
            $this->db->query("DELETE reports.* , reports_share.*
                              FROM `reports`
                              LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
                              WHERE reports.report_hash = '".$_POST['report_hash']."'");
            $this->content['action'] = 'close';
            $this->content['page_feedback'] = "Report has been deleted.";
            $this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
            return;
        }

        $doit_print = $_POST['doit_print'];
        $report_hash = $_POST['report_hash'];
        $from_saved = $this->ajax_vars['from_saved'];

        if ($doit_print && $report_hash || $from_saved) {
            $this->fetch_report_settings($report_hash);

            $timeframe = $this->current_report['timeframe'];
            if ($timeframe == 5) {
                $sort_from_date = $this->current_report['sort_from_date'];
                $sort_to_date = $this->current_report['sort_to_date'];
            }
            $age1 = $this->current_report['age1'];
            $age2 = $this->current_report['age2'];
            $age3 = $this->current_report['age3'];
            $sales_rep_match = $this->current_report['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);

            $customer_filter = $this->current_report['customer_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);

            $contact_detail = $this->current_report['contact_detail'];
            $showdetail = $this->current_report['showdetail'];
            $invoices_paid = $this->current_report['invoices_paid'];
        } else {
            $timeframe = $_POST['timeframe'];
            if ($timeframe == 5) {
                $sort_from_date = $_POST['sort_from_date'];
                $sort_to_date = $_POST['sort_to_date'];
            }
            $age1 = $_POST['age1'];
            $age2 = $_POST['age2'];
            $age3 = $_POST['age3'];
            $sales_rep_match = $_POST['sales_rep_match'];
            $customer_filter = $_POST['customer_vendor_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);

            $sales_rep_match = $_POST['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);

            $contact_detail = $_POST['contact_detail'];
            $showdetail = $_POST['showdetail'];
            $invoices_paid = $_POST['invoices_paid'];
        }

        /*
        $report_date_t = $report_date;
        //Invoice Date (1) or Due Date (2)
        if ($report_date == 1)
            $report_date = "customer_invoice.invoice_date";
        else
            $report_date = "ADDDATE(customer_invoice.invoice_date, t2.payterms)";
        */

        $save = $_POST['save'];
        $saved_cat = "ar_report";
        $report_name = $_POST['report_name'];
        $report_descr = $_POST['report_descr'];
        $share = $_POST['share'];
        $sales_rep_share = $_POST['sales_rep_share'];
        $group_share = $_POST['group_share'];
        if (!$save)
            unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
        if ($save && !$report_name) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
        }
        if ($save && !$report_hash) {
            $result = $this->db->query("SELECT COUNT(*) AS Total
                                        FROM `reports`
                                        WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
            if ($this->db->result($result)) {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
            }
        }
        if ($share && !count($sales_rep_share) && !count($group_share)) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
        }

        if (($timeframe == 5 && $sort_to_date && $sort_from_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you select a valid date range.";
        }
        if (!$age1 || !$age2 || !$age3 || $age3 < $age2 || $age3 < $age1 || $age2 < $age1 || strspn($age1, "0123456789") != strlen($age1) || strspn($age2, "0123456789") != strlen($age2) || strspn($age3, "0123456789") != strlen($age3) || $age1 <= 0 || $age2 <= 0 || $age3 <= 0) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "Please enter valid aging schedules. Each of the 3 schedules must be specified and Age 3 must be greater than Age 2, Age 2 greater than Age 1, etc.";
        }

        if ($this->content['error'])
            return;

        switch ($timeframe) {
            case 1:
            $sql_p[] = "t1.invoice_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
            //$sql_p_sub[] = "customer_payment.receipt_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
            $this->report_title = " dated this year, ".date("Y");
            break;

            case 2:
            $sql_p[] = "t1.invoice_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
            //$sql_p_sub[] = "customer_payment.receipt_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
            $this->report_title = " dated last year, ".date("Y", strtotime(date("Y-m-d")." -1 year"));
            $compare_date = date("Y-12-31", strtotime(date("Y-m-d")." -1 year"));
            break;

            case 3:
            $period_info = get_period_info(date("Y-m-d"));
            if ($period_info['period_start']) {
                $sql_p[] = "t1.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
                //$sql_p_sub[] = "customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
                $this->report_title = " dated within the current period, between ".date(DATE_FORMAT, strtotime($period_info['period_start']))." and ".date(DATE_FORMAT, strtotime($period_info['period_end']));
            } else {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
                return;
            }
            break;

            case 4:
            $period_info = get_previous_period(date("Y-m-d"));
            if ($period_info['period_start']) {
                $sql_p[] = "t1.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
                //$sql_p_sub[] = "customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
                $this->report_title = " dated last period, between ".date(DATE_FORMAT, strtotime($period_info['period_start']))." and ".date(DATE_FORMAT, strtotime($period_info['period_end']));
                $compare_date = date("Y-m-d", strtotime($period_info['period_end']));
            } else {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
                return;
            }
            break;

            case 5:
            if ($sort_from_date && $sort_to_date) {
                $sql_p[] = "t1.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
                //$sql_p_sub[] = "customer_payment.receipt_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
                if (strtotime($sort_to_date) < strtotime(date("Y-m-d")))
                    $compare_date = date("Y-m-d", strtotime($sort_to_date));

                $this->report_title = " dated between ".date(DATE_FORMAT, strtotime($sort_from_date))." and ".date(DATE_FORMAT, strtotime($sort_to_date));
            } elseif (!$sort_to_date && $sort_from_date) {
                $sql_p[] = "t1.invoice_date >= '".$sort_from_date."'";
                //$sql_p_sub[] = "customer_payment.receipt_date >= '".$sort_from_date."'";
                $this->report_title = " dated on or after ".date(DATE_FORMAT, strtotime($sort_from_date));
            } elseif ($sort_to_date && !$sort_from_date) {
                $sql_p[] = "t1.invoice_date <= '".$sort_to_date."'";
                //$sql_p_sub[] = "customer_payment.receipt_date <= '".$sort_to_date."'";
                if (strtotime($sort_to_date) < strtotime(date("Y-m-d")))
                    $compare_date = date("Y-m-d", strtotime($sort_to_date));

                $this->report_title = " dated on or before ".date(DATE_FORMAT, strtotime($sort_to_date));
            } elseif (!$sort_from_date && !$sort_to_date)
                unset($timeframe);

            break;

            default:
                $this->report_title = " dated as of ".date(DATE_FORMAT);
        }


        if ( is_array($sales_rep_match) && count($sales_rep_match) ) {
            array_walk($sales_rep_match, 'add_quotes', "'");
            $sql_p[] = "t7.sales_hash IN (" . implode(", ", $sales_rep_match) . ")";
            array_walk($sales_rep_match, 'strip_quotes');
        }
        if ( is_array($customer_filter) && count($customer_filter) ) {
            $customer_filter = array_unique($customer_filter);
            $customer_filter = array_values($customer_filter);
            array_walk($customer_filter, 'add_quotes', "'");
            $sql_p[] = "t1.customer_hash IN (" . implode(", ", $customer_filter) . ")";
            array_walk($customer_filter, 'strip_quotes');
        }

        /*
        if ($invoices_paid == 1) {
            $sql_p[] = "
            (
                (
                    customer_invoice.type = 'I'
                    AND
                    (
                        ISNULL(customer_payment.total_amount_paid) AND ROUND(customer_invoice.amount, 2) > 0 AND ROUND(customer_invoice.amount, 2) - customer_invoice.deposit_applied > 0
                    )
                    OR
                    (
                        !ISNULL(customer_payment.total_amount_paid) AND ROUND(customer_invoice.amount, 2) - customer_invoice.deposit_applied - customer_payment.total_amount_paid != 0
                    )
                )".($deposits ? "
                OR
                (
                    customer_invoice.type = 'D'
                    AND
                    (
                        (
                            !ISNULL(t2.total_applied_deposits)
                            AND ROUND(customer_invoice.amount, 2) - t2.total_applied_deposits > 0
                        )".($timeframe == '*' ? "
                        OR
                        (
                            ISNULL(t2.total_applied_deposits)
                            AND customer_invoice.balance != 0
                        )" : NULL)."
                    )
                )" : NULL)."
            )";
            $sql_p_sub_alt = "(customer_invoice.type = 'I' AND (ISNULL(customer_payment.total_amount_paid) AND ROUND(customer_invoice.amount, 2) > 0 AND ROUND(customer_invoice.amount, 2) - customer_invoice.deposit_applied > 0) OR ROUND(customer_invoice.amount, 2) - customer_invoice.deposit_applied - customer_payment.total_amount_paid != 0)";//.($deposits ?
                         // " OR (customer_invoice.type = 'D' AND (ISNULL(t2.total_applied_deposits) OR (!ISNULL(t2.total_applied_deposits) AND customer_invoice.amount - t2.total_applied_deposits > 0)))" : NULL).")";
            $this->report_title = "Unpaid invoices".$this->report_title;
        }
        if ($invoices_paid == 2) {
            $sql_p[] = "(ROUND(customer_invoice.amount, 2) <= 0 OR ROUND(customer_invoice.amount, 2) - customer_invoice.deposit_applied - customer_payment.total_amount_paid <= 0)";
            $sql_p_sub_alt = "(ROUND(customer_invoice.amount, 2) <= 0 OR ROUND(customer_invoice.amount, 2) - customer_invoice.deposit_applied - customer_payment.total_amount_paid <= 0)";
            $this->report_title = "Invoices paid in full".$this->report_title;
        }
        */
        if ($invoices_paid == 1) {
            $having_p[] = "balance_total != 0";
            $this->report_title = "Invoices with an open balance".$this->report_title;
        }
        if ($invoices_paid == 2) {
            $having_p[] = "balance_total = 0";
            $this->report_title = "Invoice with a zero balance".$this->report_title;
        }
        if ($sql_p)
            $sql = implode(" AND ", $sql_p);
        if ($having_p)
            $having = implode(" AND ", $having_p);

        if ($sql_p_sub)
            $sql_sub = implode(" AND ", $sql_p_sub);

        $str = "timeframe=$timeframe|sort_from_date=$sort_from_date|showdetail=$showdetail|sort_to_date=$sort_to_date|age1=$age1|age2=$age2|age3=$age3|sales_rep_match=".@implode("&", $sales_rep_match)."|customer_filter=".@implode("&", $customer_filter)."|invoices_paid=$invoices_paid|contact_detail=$contact_detail";

        if (!$report_hash) {
            $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
            while (global_classes::key_exists('reports', 'report_hash', $report_hash))
                $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

            $this->db->query("INSERT INTO `reports`
                              (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
                              VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

            if ($share && (count($group_share) || count($sales_rep_share))) {
                for ($i = 0; $i < count($group_share); $i++)
                    $this->db->query("INSERT INTO `reports_share`
                                      (`report_hash` , `group_hash`)
                                      VALUES ('$report_hash' , '".$group_share[$i]."')");

                for ($i = 0; $i < count($sales_rep_share); $i++)
                    $this->db->query("INSERT INTO `reports_share`
                                      (`report_hash` , `user_hash`)
                                      VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
            }
        } elseif (!$from_saved) {
            $existing = true;
            $this->db->query("UPDATE `reports`
                              SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
                              WHERE `report_hash` = '$report_hash'");

            if (!$share)
                $this->db->query("DELETE FROM `reports_share`
                                  WHERE `report_hash` = '".$this->report_hash."'");
            else {
                if (!is_array($sales_rep_share))
                    $sales_rep_share = array();
                if (!is_array($group_share))
                    $group_share = array();

                //Share or revoke to users
                $result = $this->db->query("SELECT `user_hash`
                                            FROM `reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_users[] = $row['user_hash'];

                if (!is_array($current_share_users))
                    $current_share_users = array();

                $to_remove = array_diff($current_share_users, $sales_rep_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `reports_share`
                                          WHERE `user_hash` = '".$current_share_users[$i]."'");
                }
                $to_add = array_diff($sales_rep_share, $current_share_users);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `reports_share`
                                          (`report_hash` , `user_hash`)
                                          VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
                }

                //Share or revoke to groups
                $result = $this->db->query("SELECT `group_hash`
                                            FROM `reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_groups[] = $row['group_hash'];

                if (!is_array($current_share_groups))
                    $current_share_groups = array();

                $to_remove = array_diff($current_share_groups, $group_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `reports_share`
                                          WHERE `group_hash` = '".$current_share_groups[$i]."'");
                }
                $to_add = array_diff($group_share, $current_share_groups);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `reports_share`
                                          (`report_hash` , `group_hash`)
                                          VALUES ('$report_hash' , '".$group_share[$i]."'");
                }
            }
        }
        $this->report_hash = $report_hash;

        $result = $this->db->query(
            "SELECT " .
            ( $showdetail == 1 ?
                "t1.customer_hash, SUM( t1.amount ) AS total_receivable, SUM(t6.total_receipts) AS total_receipts,
                SUM( IFNULL( t2.total_applied_deposits, 0 ) ) AS total_applied_deposits,
                SUM( t1.deposit_applied ) AS deposit_applied, "
                :
                "t1.invoice_hash, t1.invoice_no, t1.invoice_date, ADDDATE( t1.invoice_date, t2.payterms ) AS due_date,
                t2.payterms AS payment_terms, t1.type, t1.customer_hash, t1.proposal_hash, t3.proposal_no,
                t3.proposal_descr, t1.invoice_to, t1.amount AS total_receivable, t6.total_receipts AS total_receipts,
                IFNULL( t2.total_applied_deposits, 0 ) AS total_applied_deposits, t1.deposit_applied AS deposit_applied,
                t8.contact_hash, t8.contact_name, t8.contact_phone1, t8.contact_phone2, t8.contact_mobile, t8.contact_fax,
                t8.contact_email, "
            ) . "
	        CASE
	        WHEN ISNULL( t5.customer_name ) THEN
	            t4.vendor_name ELSE
	            t5.customer_name
            END AS customer_name,
            SUM(
                CASE
                WHEN DATEDIFF( " . ( $compare_date ? " '$compare_date' " : "CURDATE( )" ) . ", ADDDATE(t1.invoice_date, t2.payterms) ) <= 0 THEN
                    ROUND( t1.amount - t1.deposit_applied - IFNULL( t6.total_receipts, 0 ), 2) ELSE
                    0
                END
            ) AS balance_current,
            SUM(
                CASE
                WHEN DATEDIFF( " . ( $compare_date ? " '$compare_date' " : "CURDATE( )" ) . ", ADDDATE(t1.invoice_date, t2.payterms) ) BETWEEN 1 AND $age1 THEN
                    ROUND( t1.amount - t1.deposit_applied - IFNULL( t6.total_receipts, 0 ), 2) ELSE
                    0
                END
            ) AS balance_sched1,
            SUM(
                CASE
                WHEN DATEDIFF( " . ( $compare_date ? " '$compare_date' " : "CURDATE( )" ) . ", ADDDATE(t1.invoice_date, t2.payterms) ) BETWEEN " . ( $age1 + 1 ) . " AND $age2 THEN
                    ROUND( t1.amount - t1.deposit_applied - IFNULL( t6.total_receipts, 0 ), 2) ELSE
                    0
                END
            ) AS balance_sched2,
            SUM(
                CASE
                WHEN DATEDIFF( " . ( $compare_date ? " '$compare_date' " : "CURDATE( )" ) . ", ADDDATE(t1.invoice_date, t2.payterms) ) >= " . ( $age2 + 1 ) . " THEN
                    ROUND( t1.amount - t1.deposit_applied - IFNULL( t6.total_receipts, 0 ), 2) ELSE
                    0
                END
            ) AS balance_sched3,
            SUM( ROUND( t1.amount - t1.deposit_applied - IFNULL( t6.total_receipts, 0 ), 2) ) AS balance_total
            FROM customer_invoice t1
            LEFT JOIN proposals t3 ON t3.proposal_hash = t1.proposal_hash
            LEFT JOIN (
                SELECT invoice_hash,
	                CASE
	                WHEN t2.invoice_to = 'C' THEN
		                (
		                    SELECT
			                    CASE
			                    WHEN ( ! ISNULL( customers.payment_terms ) ) THEN
			                        customers.payment_terms ELSE
			                        " . DEFAULT_CUST_PAY_TERMS . "
			                    END
		                    FROM customers
		                    WHERE customers.customer_hash = t2.customer_hash
		                ) ELSE
	                    30
	                END AS payterms,
                    CASE
                    WHEN t2.type = 'D' THEN
                        (
                            SELECT SUM( customer_payment.receipt_amount )
                            FROM customer_invoice
                            LEFT JOIN customer_payment ON customer_payment.invoice_hash = customer_invoice.invoice_hash AND customer_payment.deleted = 0
                            WHERE customer_payment.applied_from = t2.invoice_hash AND customer_invoice.deleted = 0 " .
                            ( $sql_sub ?
                                "AND $sql_sub " : NULL
                            ) . "
                        ) ELSE
                        0
                    END AS total_applied_deposits
                FROM customer_invoice t2
            ) AS t2 ON t2.invoice_hash = t1.invoice_hash
            LEFT JOIN (
                SELECT invoice_hash, SUM( receipt_amount ) AS total_receipts
                FROM customer_payment
                WHERE " .
                ( $compare_date ? "
                    customer_payment.receipt_date <= '$compare_date' AND " : NULL
                ) . "customer_payment.deleted = 0
                GROUP BY customer_payment.invoice_hash
            ) AS t6 ON t6.invoice_hash = t1.invoice_hash
            LEFT JOIN vendors t4 ON t4.vendor_hash = t1.customer_hash
            LEFT JOIN customers t5 ON t5.customer_hash = t1.customer_hash " .
            ( preg_match('/\bt7\..*\b/', $sql) ? "
                LEFT JOIN proposals t7 ON t7.proposal_hash = t1.proposal_hash" : NULL
            ) . "
            LEFT JOIN customer_contacts t8 on t8.contact_hash = t3.customer_contact
            WHERE " .
            ( $sql ?
                "$sql AND " : NULL
            ) . "t1.type = 'I' AND t1.deleted = 0
            GROUP BY " .
            ( $showdetail == 1 ?
                "t1.customer_hash " : "t1.invoice_hash "
            ) .
            ( $having ?
                "HAVING $having" : NULL
            )
        );
        while ( $row = $this->db->fetch_assoc($result) ) {
            if ( $row['customer_hash'] ) {
            	if ( ! $sort_list[ $row['customer_hash'] ] )
                    $sort_list[ $row['customer_hash'] ] = ( $row['customer_name'] ? stripslashes($row['customer_name']) : stripslashes($row['vendor_name']) );

                $result_list[ $row['customer_hash'] ] = $row;
                if ( $showdetail == 2 ) {
                	if ( $row['proposal_hash'] )
                        $this->invoice_detail[ $row['customer_hash'] ][ $row['proposal_hash'] ][] = $row;
                    else
                        $this->invoice_detail[ $row['customer_hash'] ][] = $row;
                }
            }
        }

        # Search against any customer credits
        $r = $this->db->query(
            "SELECT " .
            ( $showdetail == 1 ?
                "t1.customer_hash, SUM( t1.amount * -1 ) AS total_receivable, SUM( t3.total_applied ) AS total_credit_applied, "
                :
		        "t1.credit_hash, t1.credit_no, t1.credit_date AS invoice_date, t1.customer_hash, t1.proposal_hash, t4.proposal_no,
		        t4.proposal_descr, ( t1.amount * -1 ) AS total_receivable, IFNULL( t3.total_applied, 0 ) AS total_credit_applied,
		        t5.contact_hash, t5.contact_name, t5.contact_phone1, t5.contact_phone2, t5.contact_mobile, t5.contact_fax,
                t5.contact_email, 'C' AS type, "
		    ) . "
		    t2.customer_name,
		    SUM(
		        CASE
		        WHEN DATEDIFF( " . ( $compare_date ? " '$compare_date' " : "CURDATE( )" ) . ", t1.credit_date ) <= 0 THEN
		            ( ( t1.amount - IFNULL( t3.total_applied, 0 ) ) * -1 ) ELSE
		            0
		        END
		    ) AS balance_current,
		    SUM(
		        CASE
		        WHEN DATEDIFF( " . ( $compare_date ? " '$compare_date' " : "CURDATE( )" ) . ", t1.credit_date ) BETWEEN 1 AND $age1 THEN
		            ( ( t1.amount - IFNULL( t3.total_applied, 0 ) ) * -1 ) ELSE
		            0
		        END
		    ) AS balance_sched1,
		    SUM(
		        CASE
		        WHEN DATEDIFF( " . ( $compare_date ? " '$compare_date' " : "CURDATE( )" ) . ", t1.credit_date ) BETWEEN " . ( $age1 + 1 ) . " AND $age2 THEN
		            ( ( t1.amount - IFNULL( t3.total_applied, 0 ) ) * -1 ) ELSE
		            0
		        END
		    ) AS balance_sched2,
		    SUM(
		        CASE
		        WHEN DATEDIFF( " . ( $compare_date ? " '$compare_date' " : "CURDATE( )" ) . ", t1.credit_date ) >= " . ( $age2 + 1 ) . " THEN
		            ( ( t1.amount - IFNULL( t3.total_applied, 0 ) ) * -1 ) ELSE
		            0
		        END
		    ) AS balance_sched3,
		    SUM( ( t1.amount - IFNULL( t3.total_applied, 0 ) ) * -1 ) AS balance_total
		    FROM customer_credit t1
		    LEFT JOIN customers t2 ON t2.customer_hash = t1.customer_hash
		    LEFT JOIN (
		        SELECT
    		        applied_from,
    		        SUM( receipt_amount ) AS total_applied
		        FROM customer_payment
		        WHERE deleted = 0
		        GROUP BY applied_from
		    ) t3 ON t3.applied_from = t1.credit_hash
		    LEFT JOIN proposals t4 ON t4.proposal_hash = t1.proposal_hash
		    LEFT JOIN customer_contacts t5 on t5.contact_hash = t4.customer_contact
		    WHERE " .
		    ( $sql ?
		        preg_replace('/t1.invoice_date/', 't1.credit_date', $sql) . ' AND ' : NULL
		    ) . "t1.deleted = 0
		    GROUP BY " .
		    ( $showdetail == 1 ?
		        "t1.customer_hash " : "t1.credit_hash "
		    ) .
		    ( $having ?
    		    "HAVING $having" : NULL
		    )
        );
        while ( $row = $this->db->fetch_assoc($r) ) {

            if ( $row['customer_hash'] ) {
            	if ( ! $sort_list[ $row['customer_hash'] ] )
                    $sort_list[ $row['customer_hash'] ] = stripslashes( $row['customer_name'] );

                if ( $showdetail == 2 ) {

                	if ( ! $result_list[ $row['customer_hash'] ] )
                    	$result_list[ $row['customer_hash'] ] = $row;

                	if ( $row['proposal_hash'] )
                        $this->invoice_detail[ $row['customer_hash'] ][ $row['proposal_hash'] ][] = $row;
                    else
                        $this->invoice_detail[ $row['customer_hash'] ]['__UNAPPLIED__'][] = $row;

                } else {

                	if ( $result_list[ $row['customer_hash'] ] ) {

                		$result_list[ $row['customer_hash'] ]['balance_current'] = bcadd($result_list[ $row['customer_hash'] ]['balance_current'], $row['balance_current'], 2);
                		$result_list[ $row['customer_hash'] ]['balance_sched1'] = bcadd($result_list[ $row['customer_hash'] ]['balance_sched1'], $row['balance_sched1'], 2);
                		$result_list[ $row['customer_hash'] ]['balance_sched2'] = bcadd($result_list[ $row['customer_hash'] ]['balance_sched2'], $row['balance_sched2'], 2);
                		$result_list[ $row['customer_hash'] ]['balance_sched3'] = bcadd($result_list[ $row['customer_hash'] ]['balance_sched3'], $row['balance_sched3'], 2);
                		$result_list[ $row['customer_hash'] ]['balance_total'] = bcadd($result_list[ $row['customer_hash'] ]['balance_total'], $row['balance_total'], 2);
                	} else
                        $result_list[ $row['customer_hash'] ] = $row;
                }
            }
        }

        //Asending order
        asort($sort_list);
        if (is_array($sort_list)) {
            while (list($hash, $name) = each($sort_list))
                $this->results[$hash] =& $result_list[$hash];
        }
        if ($from_report)
            $this->content['action'] = 'continue';
        else
            $this->content['action'] = 'close';

        $this->total = count($this->results);
        if ($doit_print)
            return;

        $this->content['html']['place_holder'] = $this->ar_report(1);
        return;
    }

	function fetch_shared_reports() {
		$result = $this->db->query("SELECT `group_hash`
									FROM `user_subscribe`
									WHERE `id_hash` = '".$this->current_hash."'");
		while ($row = $this->db->fetch_assoc($result))
			$group[] = "'".$row['group_hash']."'";

		$result = $this->db->query("SELECT reports.timestamp , reports.saved_catagory , reports.report_hash , reports.report_name , reports.report_descr
									FROM `reports`
									LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
									WHERE reports_share.user_hash = '".$this->current_hash."'".(is_array($group) ? " OR reports_share.group_hash IN (".implode(" , ", $group).")" : NULL)."
									ORDER BY reports.timestamp ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			if (!$this->shared_reports[$row['report_hash']] && !$this->custom_reports[$row['report_hash']])
				$this->shared_reports[$row['report_hash']] = $row;
		}
	}

	function fetch_custom_reports() {
		$result = $this->db->query("SELECT  reports.timestamp , reports.saved_catagory , reports.report_hash , reports.report_name , reports.report_descr
									FROM `reports`
									WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1
									ORDER BY reports.timestamp ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			if (!$this->shared_reports[$row['report_hash']] && !$this->custom_reports[$row['report_hash']])
				$this->custom_reports[$row['report_hash']] = $row;
		}
	}

	function doit_bookings_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$doit_print = $_POST['doit_print'];
		$doit_excel = $_POST['doit_excel'];
		$from_saved = $this->ajax_vars['from_saved'];

		$report_hash = ($_POST['report_hash'] ? $_POST['report_hash'] : $this->ajax_vars['report_hash']);
		if ($report_hash)
			$this->fetch_report_settings($report_hash);

		if ($doit_print || $doit_excel || $from_saved) {
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$sales_rep_match = $this->current_report['sales_rep_match'];
			$proposal_filter = $this->current_report['proposal_filter'];
			if ($proposal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);
			$customer_filter = $this->current_report['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
			$detail = $this->current_report['detail'];
		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$sales_rep_match = $_POST['sales_rep_match'];
			$proposal_filter = $_POST['proposal_filter'];
			if ($proposal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);
			$customer_filter = $_POST['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
			$detail = $_POST['detail'];
		}



		$save = $_POST['save'];
		$saved_cat = "bookings_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		$custom_contract = $_POST['custom_contract'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if (($timeframe == 5 && !$sort_from_date) || ($timeframe == 5 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}

		if ($this->content['error'])
			return;

		switch ($timeframe) {
			//This year
			case 1:
			$this->report_title = "Year To Date ".date(DATE_FORMAT, strtotime(date("Y-m-d")));
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			break;

			//last year
			case 2:
			$this->report_title = "Year Ending ".date("Y", strtotime(date("Y-m-d")." -1 year"));
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			break;

			//current period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
				$sql_p[] = "purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//previous period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
				$sql_p[] = "purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			case 5:
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = "purchase_order.po_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = date(DATE_FORMAT, strtotime($sort_from_date))." thru ".date(DATE_FORMAT, strtotime($sort_to_date));
			} else {
				$sql_p[] = "purchase_order.po_date >= '".$sort_from_date."'";
				$this->report_title = "From ".date(DATE_FORMAT, strtotime($sort_from_date))." To Present";
			}
			break;

			//This Month
			case 6:
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT, strtotime(date("Y-m-t")));
			break;

			//Last Month
			case 7:
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y-m-01", strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT, strtotime(date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))));
			break;

			default:
			$this->report_title = "To Date";
			break;
		}

        if (@in_array("", $sales_rep_match) && count($sales_rep_match) > 1)
            unset($sales_rep_match[array_search("", $sales_rep_match)]);
        elseif (@in_array("", $sales_rep_match) && count($sales_rep_match) == 1)
            unset($sales_rep_match);

		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match, 'add_quotes', "'");
			$sql_p_sub[] = "proposals.sales_hash IN (".implode(" , ", $sales_rep_match).")";
			array_walk($sales_rep_match, 'strip_quotes');
		}
		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter, 'add_quotes', "'");
			$sql_p_sub[] = "proposals.customer_hash IN (".implode(" , ", $customer_filter).")";
			array_walk($customer_filter, 'strip_quotes');
		}

        if (is_array($proposal_filter) && count($proposal_filter)) {
            array_walk($proposal_filter, 'add_quotes', "'");
            $sql_p_sub[] = "proposals.proposal_hash IN (".implode(" , ", $proposal_filter).")";
            array_walk($proposal_filter, 'strip_quotes');
        }
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);
        if ($sql_p_sub)
            $sql_sub = implode(" AND ", $sql_p_sub);


		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|detail=$detail|sales_rep=".@implode("&", $sales_rep_match)."|customer_filter=".@implode("&", $customer_filter)."|proposal_filter=".@implode("&", $proposal_filter);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

        $result = $this->db->query("SELECT SUM(purchase_order.order_amount) AS total_true_po_amount , proposals.proposal_no ,
                                    proposals.proposal_descr , proposals.customer_hash , proposals.sales_hash ,
                                    proposals.proposal_hash as parent_proposal_hash , users.full_name ,
                                    purchase_order.po_hash AS parent_po_hash ,
                                    (
                                         SELECT customers.customer_name
                                         FROM customers
                                         WHERE customers.customer_hash = proposals.customer_hash
                                    ) AS customer_name ,
                                    (
                                        SELECT SUM(line_items.cost * line_items.qty)
                                        FROM `line_items`
                                        LEFT JOIN `purchase_order` ON purchase_order.po_hash = line_items.po_hash
                                        WHERE line_items.proposal_hash = parent_proposal_hash".($sql ? " AND " . $sql : NULL)."
                                    ) AS total_po_cost ,
                                    (
									    SELECT SUM(vp.amount)
										FROM vendor_payables vp
										LEFT JOIN purchase_order po
										ON vp.po_hash = po.po_hash
										WHERE po.proposal_hash = parent_proposal_hash AND vp.deleted = 0 and vp.type = 'C'".($sql ? " AND ".$sql : NULL)."
                                    ) AS total_po_credits ,
                                    (
                                        SELECT SUM(line_items.sell * line_items.qty)
                                        FROM `line_items`
                                        LEFT JOIN `purchase_order` ON purchase_order.po_hash = line_items.po_hash
                                        WHERE line_items.proposal_hash = parent_proposal_hash".($sql ? " AND " . $sql : NULL)."
                                    ) AS total_po_sell ,
                                    (
                                        SELECT COUNT(work_orders.obj_id)
                                        FROM work_orders
                                        WHERE work_orders.proposal_hash = parent_proposal_hash
                                    ) AS total_wo
                                    FROM `purchase_order`
                                    LEFT JOIN `proposals` ON proposals.proposal_hash = purchase_order.proposal_hash
                                    LEFT JOIN `users` ON users.id_hash = proposals.sales_hash
                                    WHERE ".($sql ?
                                        $sql." AND " : NULL).($sql_sub ?
                                            $sql_sub." AND " : NULL)."purchase_order.deleted = 0
                                    GROUP BY proposals.proposal_hash
                                    ORDER BY proposals.proposal_no");
        $proposal_no = $cost = $sell = $gp = '';
        while ($row = $this->db->fetch_assoc($result)) {
        	// Calculate po_cost by subtracting applied credits. Added for Trac #1448
        	$row['total_po_cost'] = bcsub($row['total_po_cost'], $row['total_po_credits']);

            //Get the work order cost
            $work_order_cost = $work_order_sell = 0;
            if ($row['total_wo'] > 0) {
	            $r = $this->db->query("SELECT (SUM(line_items.cost * line_items.qty) / COUNT(work_order_items.obj_id)) AS c ,
	                                   (SUM(line_items.sell * line_items.qty) / COUNT(work_order_items.obj_id)) AS s
	                                   FROM purchase_order
	                                   LEFT JOIN work_order_items ON work_order_items.po_hash = purchase_order.po_hash
	                                   LEFT JOIN work_orders ON work_orders.order_hash = work_order_items.order_hash
	                                   LEFT JOIN line_items ON line_items.work_order_hash = work_orders.order_hash
	                                   WHERE purchase_order.proposal_hash = '".$row['parent_proposal_hash']."' AND ".($sql ?
	                                       $sql." AND " : NULL).
	                                   "(!ISNULL(line_items.work_order_hash) AND line_items.work_order_hash != '') AND purchase_order.deleted = 0
	                                   GROUP BY work_order_items.order_hash");
	            while ($row2 = $this->db->fetch_assoc($r)) {
	                $work_order_cost += $row2['c'];
	                $work_order_sell += $row2['s'];
	            }
            }
            if (!is_array($results[$row['sales_hash']]))
                $results[$row['sales_hash']] = array();

			if (!isset($order_by[$row['sales_hash']]))
				$order_by[$row['sales_hash']] = $row['full_name'];

            $results[$row['sales_hash']]['sales_hash'] = $row['sales_hash'];
            $results[$row['sales_hash']]['full_name'] = $row['full_name'];
            $results[$row['sales_hash']]['total_sell'] += ($row['total_po_sell'] + $work_order_sell);
            $results[$row['sales_hash']]['total_cost'] += ($row['total_po_cost'] + $work_order_cost);



            if ($detail == 1) {

                $row['total_po_cost'] = ($row['total_po_cost'] + $work_order_cost);
                $row['total_po_sell'] = ($row['total_po_sell'] + $work_order_sell);

            	if ( $doit_print || $doit_excel ) {

            		$results[ $row['sales_hash'] ]['detail'][] = array(
                		"prop_details"	=>
                		( strlen($row['customer_name']) > 25 ?
                    		stripslashes( substr($row['customer_name'], 0, 23) ) . "..." : stripslashes($row['customer_name'])
                    	) . " [{$row['proposal_no']}] " .
                        ( strlen($row['proposal_descr']) > 55 ?
                            stripslashes( substr($row['proposal_descr'], 0, 53) ) . "..." : stripslashes($row['proposal_descr'])
                        ),
            			"po_cost"		=>	$row['total_po_cost'],
	                    "po_sell"		=>	$row['total_po_sell'],
	                    "po_gp"			=>	(float)bcmul( math::gp_margin( array(
                            'cost'  =>  $row['total_po_cost'],
                            'sell'  =>  $row['total_po_sell']
                        ) ), 100, 4)
                    );
            	} else {
	                $results[$row['sales_hash']]['detail'] .= "
	                <tr cid=\"c_".$row['sales_hash']."\" class=\"white_bg\" onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className='white_bg'\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$row['parent_proposal_hash']."', 'popup_id=proposal_win', 'from_report=1');\" title=\"View this proposal\">
	                    <td style=\"font-size:8pt;width:525px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
	                        <i>".(strlen($row['customer_name']) > 25 ?
	                            stripslashes(substr($row['customer_name'], 0, 23))."..." : stripslashes($row['customer_name']))."
	                        </i>
	                        &nbsp;[".$row['proposal_no']."]&nbsp;".
	                        (strlen($row['proposal_descr']) > 55 ?
	                            stripslashes(substr($row['proposal_descr'], 0, 53))."..." : stripslashes($row['proposal_descr']))."
	                    </td>
	                    <td style=\"font-size:8pt;width:150px;border-bottom:1px solid #cccccc;padding:2px 5px;\" class=\"num_field\">
	                        $".number_format($row['total_po_cost'], 2)."
	                    </td>
	                    <td style=\"font-size:8pt;width:150px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
	                        $".number_format($row['total_po_sell'], 2)."
	                    </td>
	                    <td style=\"font-size:8pt;padding:2px 5px;width:75px;border-bottom:1px solid #cccccc;" .
                        ( defined('MARGIN_FLAG') && bccomp( math::gp_margin( array(
		                        'cost'  =>  $row['total_po_cost'],
		                        'sell'  =>  $row['total_po_sell']
	                        ) ), (float)MARGIN_FLAG, 4) == -1 || bccomp( bcmul( math::gp_margin( array(
	                            'cost'  =>  $row['total_po_cost'],
	                            'sell'  =>  $row['total_po_sell']
	                        ) ), 100, 4), 0, 4) == -1 ?
                                "color:#ff0000;" : NULL
                        ) . "\" class=\"num_field\">" .
                            ( bccomp( bcmul( math::gp_margin( array(
                                'cost'  =>  $row['total_po_cost'],
                                'sell'  =>  $row['total_po_sell']
                            ) ), 100, 4), 0, 4) == -1 ?
                                "(" . (float)bcmul( bcmul( math::gp_margin( array(
                                    'cost'  =>  $row['total_po_cost'],
                                    'sell'  =>  $row['total_po_sell']
                                ) ), 100, 4), -1, 4) . "%)"
                                :
                                (float)bcmul( math::gp_margin( array(
                                    'cost'  =>  $row['total_po_cost'],
                                    'sell'  =>  $row['total_po_sell']
                                ) ), 100, 4) . "%"
                            ) . "
	                    </td>
	                </tr>";
            	}
            }
        }

		if ( is_array($order_by) ) {

			asort($order_by);
			while ( list($sales_hash, $nothing) = each($order_by) )
				$this->results[ $sales_hash ] =& $results[ $sales_hash ];
		}


		$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->bookings_report(1);

		return;
	}

	function fetch_indiv_bookings() {
		$sales_hash = $this->ajax_vars['sales_hash'];
		$report_hash = $this->ajax_vars['report_hash'];

		$this->fetch_report_settings($report_hash);

		switch ($this->current_report['timeframe']) {
			//This year
			case 1:
			$this->report_title = "Year To Date ".date(DATE_FORMAT, strtotime(date("Y-m-d")));
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y-01-01")."' AND '".date("Y-12-31")."'";
			break;

			//last year
			case 2:
			$this->report_title = "Year Ending ".date("Y", strtotime(date("Y-m-d")." -1 year"));
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y-01-01", strtotime(date("Y-m-d")." -1 year"))."' AND '".date("Y-12-31", strtotime(date("Y-m-d")." -1 year"))."'";
			break;

			//current period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
			$sql_p[] = "purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			break;

			//previous period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
			$sql_p[] = "purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			break;

			case 5:
			if ($this->current_report['sort_from_date'] && $this->current_report['sort_to_date']) {
				$sql_p[] = "purchase_order.po_date BETWEEN '".$this->current_report['sort_from_date']."' AND '".$this->current_report['sort_to_date']."'";
				$this->report_title = date(DATE_FORMAT, strtotime($this->current_report['sort_from_date']))." thru ".date(DATE_FORMAT, strtotime($this->current_report['sort_to_date']));
			} else {
				$sql_p[] = "purchase_order.po_date >= '".$this->current_report['sort_from_date']."'";
				$this->report_title = "From ".date(DATE_FORMAT, strtotime($this->current_report['sort_from_date']))." To Present";
			}
			break;

			//This Month
			case 6:
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT, strtotime(date("Y-m-t")));
			break;

			//Last Month
			case 7:
			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y-m-01", strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT, strtotime(date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))));
			break;
		}

		if (is_array($this->current_report['sales_rep_match']) && count($this->current_report['sales_rep_match'])) {
			array_walk($this->current_report['sales_rep_match'], 'add_quotes', "'");
			$sql_p_sub[] = "proposals.sales_hash IN (".implode(" , ", $this->current_report['sales_rep_match']).")";
			array_walk($this->current_report['sales_rep_match'], 'strip_quotes');
		}
        if ((is_array($this->current_report['proposal_filter']) && count($this->current_report['proposal_filter'])) || ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))) {
        	if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
                $this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);

            array_walk($this->current_report['proposal_filter'], 'add_quotes', "'");
            $sql_p_sub[] = "proposals.proposal_hash IN (".implode(" , ", $this->current_report['proposal_filter']).")";
            array_walk($this->current_report['proposal_filter'], 'strip_quotes');
        }
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);
		if ($sql_p_sub)
            $sql_sub = implode(" AND ", $sql_p_sub);

		$result = $this->db->query("SELECT SUM(purchase_order.order_amount) AS total_true_po_amount , proposals.customer_hash ,
		                           proposals.proposal_no , proposals.proposal_hash as parent_proposal_hash ,
		                           proposals.proposal_descr , purchase_order.po_hash AS parent_po_hash ,
		                           (
                                        SELECT customers.customer_name
                                        FROM customers
                                        WHERE customers.customer_hash = proposals.customer_hash
		                           ) AS customer_name ,
									(
										SELECT SUM(line_items.cost * line_items.qty)
										FROM `line_items`
										LEFT JOIN `purchase_order` ON purchase_order.po_hash = line_items.po_hash
										WHERE line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
									) AS total_po_cost ,
									(
									    SELECT SUM(vp.amount)
										FROM vendor_payables vp
										LEFT JOIN purchase_order po
										ON vp.po_hash = po.po_hash
										WHERE po.proposal_hash = parent_proposal_hash AND vp.deleted = 0 and vp.type = 'C'".($sql ? " AND ".$sql : NULL)."
                                    ) AS total_po_credits ,
									(
										SELECT SUM(line_items.sell * line_items.qty)
										FROM `line_items`
										LEFT JOIN `purchase_order` ON purchase_order.po_hash = line_items.po_hash
										WHERE line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
									) AS total_po_sell ,
                                    (
                                        SELECT COUNT(work_orders.obj_id)
                                        FROM work_orders
                                        WHERE work_orders.proposal_hash = parent_proposal_hash
                                    ) AS total_wo
									FROM `purchase_order`
                                    LEFT JOIN `proposals` ON proposals.proposal_hash = purchase_order.proposal_hash
									WHERE proposals.sales_hash = '$sales_hash' AND ".($sql ?
                                        $sql." AND " : NULL).($sql_sub ?
                                            $sql_sub." AND " : NULL).
                                    "purchase_order.deleted = 0
									GROUP BY proposals.proposal_hash
									ORDER BY proposals.proposal_no");
		while ($row = $this->db->fetch_assoc($result)) {
			// Calculate po_cost by subtracting applied credits. Added for Trac #1448
        	$row['total_po_cost'] = bcsub($row['total_po_cost'], $row['total_po_credits']);

			//Get the work order cost
			$work_order_cost = $work_order_sell = 0;
			if ($row['total_wo']) {
	            $r = $this->db->query("SELECT (SUM(line_items.cost * line_items.qty) / COUNT(work_order_items.obj_id)) AS c ,
	                                   (SUM(line_items.sell * line_items.qty) / COUNT(work_order_items.obj_id)) AS s
	                                   FROM purchase_order
	                                   LEFT JOIN work_order_items ON work_order_items.po_hash = purchase_order.po_hash
	                                   LEFT JOIN work_orders ON work_orders.order_hash = work_order_items.order_hash
	                                   LEFT JOIN line_items ON line_items.work_order_hash = work_orders.order_hash
	                                   WHERE purchase_order.proposal_hash = '".$row['parent_proposal_hash']."' AND ".($sql ?
	                                       $sql." AND " : NULL)."
	                                   !ISNULL(line_items.work_order_hash) AND purchase_order.deleted = 0
	                                   GROUP BY work_order_items.order_hash");
	            while ($row2 = $this->db->fetch_assoc($r)) {
	                $work_order_cost += $row2['c'];
	                $work_order_sell += $row2['s'];
	            }
	            $row['total_po_sell'] = ($row['total_po_sell'] + $work_order_sell);
	            $row['total_po_cost'] = ($row['total_po_cost'] + $work_order_cost);
			}
			$tbl .= "<tr cid=\"c_{$sales_hash}\" class=\"white_bg\" onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className='white_bg'\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$row['parent_proposal_hash']."', 'popup_id=proposal_win', 'from_report=1');\" title=\"View this proposal\"><td style=\"font-size:8pt;width:525px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\"><i>" . ( strlen($row['customer_name']) > 25 ? stripslashes( substr($row['customer_name'], 0, 23) ) . "..." : stripslashes($row['customer_name']) ) . "</i>&nbsp;[{$row['proposal_no']}]&nbsp;" . ( strlen($row['proposal_descr']) > 45 ? stripslashes( substr($row['proposal_descr'], 0, 43) ) . "..." : stripslashes($row['proposal_descr']) ) . "</td><td style=\"font-size:8pt;width:150px;border-bottom:1px solid #cccccc;padding:2px 5px;\" class=\"num_field\">\$" . number_format($row['total_po_cost'], 2) . "</td><td style=\"font-size:8pt;width:150px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">\$" . number_format($row['total_po_sell'], 2) . "</td><td style=\"font-size:8pt;padding:2px 5px;width:75px;border-bottom:1px solid #cccccc;" . ( defined('MARGIN_FLAG') && bccomp( math::gp_margin( array('cost' => $row['total_po_cost'], 'sell' => $row['total_po_sell'] ) ), (float)MARGIN_FLAG, 4) == -1 || bccomp( bcmul( math::gp_margin( array('cost' => $row['total_po_cost'], 'sell' => $row['total_po_sell']) ), 100, 4), 0, 4) == -1 ? "color:#ff0000;" : NULL ) . "\" class=\"num_field\">" . ( bccomp( bcmul( math::gp_margin( array('cost' => $row['total_po_cost'], 'sell' => $row['total_po_sell'])), 100, 4), 0, 4) == -1 ? "(" . (float)bcmul( bcmul( math::gp_margin( array('cost' => $row['total_po_cost'], 'sell' => $row['total_po_sell'])), 100, 4), -1, 4) . "%)" : (float)bcmul( math::gp_margin( array('cost' => $row['total_po_cost'], 'sell' => $row['total_po_sell'])), 100, 4) . "%" ) . "</td></tr>";
		}

        $tbl = str_replace("'", "\'", $tbl);
        $this->content['jscript'] = "\$('po_details_{$sales_hash}').insert({after:'{$tbl}'});";

		return;
	}

	function bookings_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\" >
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"4\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Bookings Report").($this->p->ck('reports', 'V', 'bookings') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'bookings_report', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<div style=\"margin-left:20px;margin-bottom:5px;margin-top:10px;\">
							<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it_xls', 'type=bookings_report', 'report_hash=".$this->report_hash."', 'popup_id=xls_win')\"><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>
						</div>
						<div style=\"text-align:center;margin-top:15px;font-weight:bold;\">
							Sales Bookings ".$this->report_title."
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:525px;text-align:left;\">Sales Rep</td>
					<td style=\"width:150px;\" class=\"num_field\">Total Net</td>
					<td style=\"width:150px;\" class=\"num_field\">Total Sell</td>
					<td style=\"width:75px;text-align:right;\">Margin</td>
				</tr>";

				while (list($sales_hash, $data) = each($this->results)) {
					if ($sales_hash) {
						$tbl .= "
						<tr id=\"po_details_".$sales_hash."\">
							<td style=\"background-color:#ffffff;font-weight:bold;\">
								<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"if(hide_row('".$sales_hash."')){return;}else{agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'fetch_indiv_bookings', 'sales_hash=".$sales_hash."', 'report_hash=".$this->report_hash."');}\" title=\"View individual bookings for this sales rep\">".stripslashes($data['full_name'])."</a>

							</td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\">$".number_format($data['total_cost'], 2)."</td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\">$".number_format($data['total_sell'], 2)."</td>
							<td style=\"" .
    						( defined('MARGIN_FLAG') && bccomp( math::gp_margin( array(
		    						'cost'    =>  $data['total_cost'],
		    						'sell'    =>  $data['total_sell']
        						) ), (float)MARGIN_FLAG, 4) == -1 || bccomp( bcmul( math::gp_margin( array(
            						'cost'    =>  $data['total_cost'],
            						'sell'    =>  $data['total_sell']
        						) ), 100, 4), 0, 4) == -1 ?
            						"color:#ff0000;" : NULL
        					) . "background-color:#ffffff;\" class=\"num_field\">" .
							( bccomp( bcmul( math::gp_margin( array(
	    							'cost'   =>  $data['total_cost'],
	    							'sell'   =>  $data['total_sell']
								) ), 100, 4), 0, 4) == -1 ?
    								"(" .
    								(float)bcmul( bcmul( math::gp_margin( array(
            							'cost'  =>  $data['total_cost'],
            							'sell'  =>  $data['total_sell']
        							) ), 100, 4), -1, 4) . "%)"
        							:
        							(float)bcmul( math::gp_margin( array(
            							'cost'  =>  $data['total_cost'],
            							'sell'  =>  $data['total_sell']
        							) ), 100, 4) . "%"
    						) . "
							</td>
						</tr>" .
    					( $data['detail'] ?
    						$data['detail'] : NULL
    					) . "
						<tr>
							<td colspan=\"4\" style=\"background-color:#cccccc;\"></td>
						</tr>";

						$total_sell = bcadd($total_sell, $data['total_sell'], 2);
						$total_cost = bcadd($total_cost, $data['total_cost'], 2);
					}
				}

				if ( ! $this->results )
                    $tbl .= "
                    <tr>
                        <td style=\"padding-top:25px;background-color:#ffffff;\" colspan=\"4\">There are no results to display.</td>
                    </tr>";

				$tbl .= "
				<tr>
					<td style=\"padding-top:25px;background-color:#efefef;\"></td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:10pt;background-color:#efefef;\" class=\"num_field\">\$" . number_format($total_cost, 2) . "</td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:10pt;background-color:#efefef;\" class=\"num_field\">\$" . number_format($total_sell, 2) . "</td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:10pt;background-color:#efefef;" .
    				( defined('MARGIN_FLAG') && bccomp( math::gp_margin( array(
	        				'cost'  =>  $total_cost,
	        				'sell'  =>  $total_sell
        				) ), (float)MARGIN_FLAG, 4) || bccomp( bcmul( math::gp_margin( array(
            				'cost'  =>  $total_cost,
            				'sell'  =>  $total_sell
        				) ), 100, 4), 0, 4) == -1 ?
            				"color:#ff0000;" : NULL
            		) . "\" class=\"num_field\">" .
					( bccomp( bcmul( math::gp_margin( array(
    	    				'cost' =>  $total_cost,
	    					'sell' =>  $total_sell
						) ), 100, 4), 0, 4) == -1 ?
							"(" .
    						(float)bcmul( bcmul( math::gp_margin( array(
        						'cost'    =>  $total_cost,
        						'sell'    =>  $total_sell
    						) ), 100, 4), -1, 4)
    						. "%)"
    						:
    						bcmul( math::gp_margin( array(
        						'cost'    =>  $total_cost,
        						'sell'    =>  $total_sell
    						) ), 100, 4) . "%"
    				) . "
					</td>
				</tr>
			</table>";

			$this->content['jscript'][] = "
			hide_row = function() {
                var sales_hash = arguments[0];
                var tbl_el = $$('tr[cid=c_'+sales_hash+']');
                if (tbl_el.length) {
	                var i=0, c;
	                while (c = tbl_el[i++]) {
	                   c.remove();
	                }
	                return true;
                }

                return false;
    		}";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);
			if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
                $this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);

			$tbl = $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_bookings_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_bookings_report', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Bookings Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe", array("All dates", "Bookings dated this year", "Bookings dated last year", "Bookings from the current period", "Bookings from the previous period", "Bookings dated this month", "Bookings dated last month", "A specific date range"), $this->current_report['timeframe'], array('*', 1, 2, 3, 4, 6, 7, 5), "onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Bookings Details?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("detail", array("Show Detailed View", "Show Simple View"), $this->current_report['detail'], array(1, 0), "blank=1")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]", ($this->p->ck('proposals', 'S') ? $this->sales_name : array_merge(array("All Sales Reps"), $this->user_name)), (is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')), ($this->p->ck('proposals', 'S') ? $this->sales_hash : array_merge(array(''), $this->user_hash)), "multiple", "blank=1", "size=4", "style=width:200px;", ($this->p->ck('proposals', 'S') ? "disabled" : NULL))."</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
                                                if (is_array($this->current_report['customer_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
                                                        $tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=proposal",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
                                                if (is_array($this->current_report['proposal_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++)
                                                        $tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_invoiced_sales_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}
		$report_hash = ($_POST['report_hash'] ? $_POST['report_hash'] : $this->ajax_vars['report_hash']);
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && $from_saved) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$sales_rep_match = $this->current_report['sales_rep_match'];
			$customer_filter = $this->current_report['customer_filter'];
			$detail = $this->current_report['detail'];
		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$sales_rep_match = $_POST['sales_rep_match'];
			$customer_filter = $_POST['customer_filter'];
			$detail = $_POST['detail'];
		}

		$save = $_POST['save'];
		$saved_cat = "invoiced_sales";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if (($timeframe == 5 && !$sort_from_date) || ($timeframe == 5 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}

		if ($this->content['error'])
			return;

		switch ($timeframe) {
			//This year
			case 1:
			$this->report_title = "Year To Date ".date(DATE_FORMAT, strtotime(date("Y-m-d")));
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			break;

			//last year
			case 2:
			$this->report_title = "Year Ending ".date("Y", strtotime(date("Y-m-d")." -1 year"));
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			break;

			//current period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//previous period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			case 5:
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = date(DATE_FORMAT, strtotime($sort_from_date))." thru ".date(DATE_FORMAT, strtotime($sort_to_date));
			} else {
				$sql_p[] = "customer_invoice.invoice_date >= '".$sort_from_date."'";
				$sub_sql_p[] = "customer_invoice.invoice_date >= '".$sort_from_date."'";
				$this->report_title = "From ".date(DATE_FORMAT, strtotime($sort_from_date))." To Present";
			}
			break;

			//This Month
			case 6:
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT, strtotime(date("Y-m-t")));
			break;

			//Last Month
			case 7:
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01", strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))."'";
			$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01", strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT, strtotime(date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))));
			break;

			default:
			$this->report_title = "To Date";
			break;
		}

		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match, 'add_quotes', "'");
			$sql_p[] = "proposals.sales_hash IN (".implode(" , ", $sales_rep_match).")";
			array_walk($sales_rep_match, 'strip_quotes');
		}
		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter, 'add_quotes', "'");
			$sql_p[] = "customer_invoice.customer_hash IN (".implode(" , ", $customer_filter).")";
			$sub_sql_p[] = "customer_invoice.customer_hash IN (".implode(" , ", $customer_filter).")";
			array_walk($customer_filter, 'strip_quotes');
		}
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);
		if ($sub_sql_p)
			$sub_sql = implode(" AND ", $sub_sql_p);

		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|detail=$detail|sales_rep=".@implode("&", $sales_rep_match)."|customer_filter=".@implode("&", $customer_filter);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

        $result = $this->db->query("SELECT proposals.proposal_no , proposals.proposal_descr ,
                                   proposals.sales_hash , proposals.proposal_hash as parent_proposal_hash ,
                                   proposals.customer_hash , users.full_name ,
                                   (
                                        SELECT customers.customer_name
                                        FROM customers
                                        WHERE customers.customer_hash = proposals.customer_hash
                                   ) AS customer_name ,
                                   (
                                        SELECT SUM(line_items.cost * line_items.qty)
                                        FROM `line_items`
                                        LEFT JOIN `customer_invoice` ON customer_invoice.invoice_hash = line_items.invoice_hash
                                        WHERE line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
								   ) AS total_invoice_costs ,
								   (
										SELECT SUM(vp.amount)
										FROM vendor_payables vp
										LEFT JOIN purchase_order po
										ON vp.po_hash = po.po_hash
										WHERE po.proposal_hash = parent_proposal_hash AND vp.deleted = 0 and vp.type = 'C'".($sql ? " AND ".$sql : NULL)."
                                   ) AS total_invoice_credits ,
                                   (
                                        SELECT SUM(line_items.sell * line_items.qty)
                                        FROM `line_items`
                                        LEFT JOIN `customer_invoice` ON customer_invoice.invoice_hash = line_items.invoice_hash
                                        WHERE line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
                                    ) AS total_invoice_sell
                                    FROM `customer_invoice`
                                    LEFT JOIN `proposals` ON proposals.proposal_hash = customer_invoice.proposal_hash
                                    LEFT JOIN `users` ON users.id_hash = proposals.sales_hash
                                    WHERE ".($sql ?
        								$sql." AND " : NULL).
        							"customer_invoice.type = 'I' AND customer_invoice.deleted = 0
                                    GROUP BY proposals.proposal_hash
                                    ORDER BY proposals.proposal_no");
        $proposal_no = $cost = $sell = $gp = '';
        while ($row = $this->db->fetch_assoc($result)) {
            if (!is_array($this->results[$row['sales_hash']]))
                $this->results[$row['sales_hash']] = array();

			$row['total_invoice_cost'] = bcsub($row['total_invoice_costs'], $row['total_invoice_credits']);
            $this->results[$row['sales_hash']]['sales_hash'] = $row['sales_hash'];
            $this->results[$row['sales_hash']]['full_name'] = $row['full_name'];
            $this->results[$row['sales_hash']]['total_sell'] += $row['total_invoice_sell'];
            $this->results[$row['sales_hash']]['total_cost'] += $row['total_invoice_cost'];

            if ($detail == 1) {
                $this->results[$row['sales_hash']]['detail'] .= "
                <tr cid=\"c_".$row['sales_hash']."\" class=\"white_bg\" onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className='white_bg'\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$row['parent_proposal_hash']."', 'popup_id=proposal_win', 'from_report=1');\" title=\"View this proposal\">
                    <td style=\"font-size:8pt;width:525px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
                        <i>".(strlen($row['customer_name']) > 25 ?
                            stripslashes(substr($row['customer_name'], 0, 23))."..." : stripslashes($row['customer_name']))."
                        </i>
                        &nbsp;[".$row['proposal_no']."]&nbsp;".
                        (strlen($row['proposal_descr']) > 55 ?
                            stripslashes(substr($row['proposal_descr'], 0, 53))."..." : stripslashes($row['proposal_descr']))."
                    </td>
                    <td style=\"font-size:8pt;width:150px;border-bottom:1px solid #cccccc;padding:2px 5px;\" class=\"num_field\">
                        $".number_format($row['total_invoice_sell'], 2)."
                    </td>
                    <td style=\"font-size:8pt;width:150px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
                        $".number_format($row['total_invoice_cost'], 2)."
                    </td>
                    <td style=\"font-size:8pt;padding:2px 5px;width:75px;border-bottom:1px solid #cccccc;" .
                    ( defined('MARGIN_FLAG') && bccomp( math::gp_margin( array(
	                        'cost'  =>  $row['total_invoice_cost'],
	                        'sell'  =>  $row['total_invoice_sell']
                        ) ), (float)MARGIN_FLAG, 4) == -1 || bccomp( bcmul( math::gp_margin( array(
                            'cost'  =>  $row['total_invoice_cost'],
                            'sell'  =>  $row['total_invoice_sell']
                        ) ), 100, 4), 0, 4) == -1 ?
                            "color:#ff0000;" : NULL
                    ) . "\" class=\"num_field\">" .
                    ( bccomp( bcmul( math::gp_margin( array(
                        'cost'  =>  $row['total_invoice_cost'],
                        'sell'  =>  $row['total_invoice_sell']
                    ) ), 100, 4), 0, 4) == -1 ?
                        "(" .
                        (float)bcmul( bcmul( math::gp_margin( array(
                            'cost'  =>  $row['total_invoice_cost'],
                            'sell'  =>  $row['total_invoice_sell']
                        ) ), 100, 4), -1, 4)
                        . "%)"
                        :
                        (float)bcmul( math::gp_margin( array(
	                        'cost'  =>  $row['total_invoice_cost'],
	                        'sell'  =>  $row['total_invoice_sell']
                        ) ), 100, 4)
                        . "%"
                    ) . "
                    </td>
                </tr>";
            }
        }

		$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->invoiced_sales(1);

		return;
	}

	function fetch_indiv_invoices() {
		$sales_hash = $this->ajax_vars['sales_hash'];
		$report_hash = $this->ajax_vars['report_hash'];

		$this->fetch_report_settings($report_hash);

		switch ($this->current_report['timeframe']) {
			//This year
			case 1:
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			break;

			//last year
			case 2:
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			break;

			//current period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			break;

			//previous period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			break;

			case 5:
			if ($this->current_report['sort_from_date'] && $this->current_report['sort_to_date']) {
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$this->current_report['sort_from_date']."' AND '".$this->current_report['sort_to_date']."'";
			} else {
				$sql_p[] = "customer_invoice.invoice_date >= '".$this->current_report['sort_from_date']."'";
			}
			break;

			//This Month
			case 6:
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			break;

			//Last Month
			case 7:
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01", strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))."'";
			break;
		}

		if (is_array($this->current_report['sales_rep_match']) && count($this->current_report['sales_rep_match'])) {
			array_walk($this->current_report['sales_rep_match'], 'add_quotes', "'");
			$sql_p[] = "proposals.sales_hash IN (".implode(" , ", $this->current_report['sales_rep_match']).")";
			array_walk($this->current_report['sales_rep_match'], 'strip_quotes');
		}
		if (is_array($this->current_report['customer_filter']) && count($this->current_report['customer_filter'])) {
			$customer_filter = array_unique($this->current_report['customer_filter']);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter, 'add_quotes', "'");
			$sql_p[] = "customer_invoice.customer_hash IN (".implode(" , ", $customer_filter).")";
			array_walk($customer_filter, 'strip_quotes');
		}
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$result = $this->db->query("SELECT proposals.proposal_no , proposals.proposal_descr ,
		                           proposals.proposal_hash as parent_proposal_hash , proposals.customer_hash ,
                                   (
                                        SELECT customers.customer_name
                                        FROM customers
                                        WHERE customers.customer_hash = proposals.customer_hash
                                   ) AS customer_name ,
								   (
                                        SELECT SUM(line_items.cost * line_items.qty)
                                        FROM `line_items`
                                        LEFT JOIN `customer_invoice` ON customer_invoice.invoice_hash = line_items.invoice_hash
                                        WHERE line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
								   ) AS total_invoice_costs ,
								   (
										SELECT SUM(vp.amount)
										FROM vendor_payables vp
										LEFT JOIN purchase_order po
										ON vp.po_hash = po.po_hash
										WHERE po.proposal_hash = parent_proposal_hash AND vp.deleted = 0 and vp.type = 'C'".($sql ? " AND ".$sql : NULL)."
                                    ) AS total_invoice_credits ,
                                    (
                                        SELECT SUM(line_items.sell * line_items.qty)
                                        FROM `line_items`
                                        LEFT JOIN `customer_invoice` ON customer_invoice.invoice_hash = line_items.invoice_hash
                                        WHERE line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
                                    ) AS total_invoice_sell
									FROM `customer_invoice`
									LEFT JOIN `proposals` ON proposals.proposal_hash = customer_invoice.proposal_hash
									WHERE proposals.sales_hash = '$sales_hash' AND customer_invoice.type = 'I' AND customer_invoice.deleted = 0 ".($sql ? "
										AND " . $sql : NULL)."
									GROUP BY proposals.proposal_hash
									ORDER BY proposals.proposal_no");
		while ($row = $this->db->fetch_assoc($result)) {
			$row['total_invoice_cost'] = bcsub($row['total_invoice_costs'], $row['total_invoice_credits']);
            $row['total_invoice_sell'] = ($row['total_invoice_sell'] + $row['total_wo_sell']);
            $row['total_invoice_cost'] = ($row['total_invoice_cost'] + $row['total_wo_cost']);

            $_margin = math::gp_margin( array(
	            'cost'  =>  $row['total_invoice_cost'],
	            'sell'  =>  $row['total_invoice_sell']
            ) );
            $tbl .= "<tr cid=\"c_{$sales_hash}\" class=\"white_bg\" onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className='white_bg'\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash={$row['parent_proposal_hash']}', 'popup_id=proposal_win', 'from_report=1');\" title=\"View this proposal\"><td style=\"font-size:8pt;width:525px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\"><i>" . ( strlen($row['customer_name']) > 25 ? stripslashes( substr($row['customer_name'], 0, 23) ) . "..." : stripslashes($row['customer_name']) ) . "</i>&nbsp;[{$row['proposal_no']}]&nbsp;" . ( strlen($row['proposal_descr']) > 45 ? stripslashes( substr($row['proposal_descr'], 0, 43) ) . "..." : stripslashes($row['proposal_descr']) ) . "</td><td style=\"font-size:8pt;width:150px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">\$" . number_format($row['total_invoice_sell'], 2) . "</td><td style=\"font-size:8pt;width:150px;border-bottom:1px solid #cccccc;padding:2px 5px;\" class=\"num_field\">\$" . number_format($row['total_invoice_cost'], 2) . "</td><td style=\"font-size:8pt;padding:2px 5px;width:75px;border-bottom:1px solid #cccccc;" . ( defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 || bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ? "color:#ff0000;" : NULL ) . "\" class=\"num_field\">" . ( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ? "(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . "%)" : (float)bcmul($_margin, 100, 4) . "%" ) . "</td></tr>";
        }

        $tbl = str_replace("'", "\'", $tbl);
        $this->content['jscript'] = "\$('invoice_details_{$sales_hash}').insert({after:'{$tbl}'});";

		return;
	}

	function invoiced_sales($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\" >
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"4\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Invoiced Sales Report").($this->p->ck('reports', 'V', 'invoiced_sales') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'invoiced_sales', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<div style=\"margin-left:20px;margin-bottom:5px;margin-top:10px;\">
							<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							&nbsp;&nbsp;
						</div>
						<div style=\"text-align:center;margin-top:15px;font-weight:bold;\">
							Invoiced Sales ".$this->report_title."
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:525px;text-align:left;\">Sales Rep</td>
					<td style=\"width:150px;\" class=\"num_field\">Total Invoiced Sales</td>
					<td style=\"width:150px;\" class=\"num_field\">Total Invoiced Cost</td>
					<td style=\"width:75px;\" class=\"num_field\">GP Margin</td>
				</tr>";
				$total_cost = $total_sell = 0;
				while (list($sales_hash, $data) = each($this->results)) {
					if ($sales_hash) {
						$tbl .= "
						<tr id=\"invoice_details_".$sales_hash."\">
							<td style=\"width:525px;background-color:#ffffff;font-weight:bold;\">
								<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"if(hide_row('".$sales_hash."')){return;}else{agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'fetch_indiv_invoices', 'sales_hash=".$sales_hash."', 'report_hash=".$this->report_hash."');}\" title=\"View invoice details\">".stripslashes($data['full_name'])."</a>
							</td>
							<td style=\"width:150px;background-color:#ffffff;\" class=\"num_field\">$".number_format($data['total_sell'], 2)."</td>
							<td style=\"width:150px;background-color:#ffffff;\" class=\"num_field\">$".number_format($data['total_cost'], 2)."</td>
							<td style=\"width:75px;" .
    						( defined('MARGIN_FLAG') && bccomp( math::gp_margin( array(
	        						'cost'    =>  $data['total_cost'],
	        						'sell'    =>  $data['total_sell']
	    						) ), (float)MARGIN_FLAG, 4) == -1 || bccomp( bcmul( math::gp_margin( array(
	        						'cost'    =>  $data['total_cost'],
	        						'sell'    =>  $data['total_sell']
	    						) ), 100, 4), 0, 4) == -1 ?
	        						"color:#ff0000;" : NULL
        					) . "background-color:#ffffff;\" class=\"num_field\">" .
							( bccomp( bcmul( math::gp_margin( array(
	    							'cost'   =>  $data['total_cost'],
	    							'sell'   =>  $data['total_sell']
								) ), 100, 4), 0, 4) == -1 ?
	                                "(" .
									bcmul( bcmul( math::gp_margin( array(
		    							'cost'   =>  $data['total_cost'],
		    							'sell'   =>  $data['total_sell']
									) ), 100, 4), -1, 4) .
									"%)"
									:
									bcmul( math::gp_margin( array(
									'cost'  =>  $data['total_cost'],
									'sell'  =>  $data['total_sell']
									) ), 100, 4) . "%"
							) . "
							</td>
						</tr>" .
						( $data['detail'] ?
    						$data['detail'] : NULL
    					) . "
						<tr>
							<td colspan=\"4\" style=\"background-color:#cccccc;\"></td>
						</tr>";

						$total_cost = bcadd($total_cost, $data['total_cost'], 2);
						$total_sell = bcadd($total_sell, $data['total_sell'], 2);
					}
				}

				$_margin = math::gp_margin( array(
					'cost'  =>  $total_cost,
					'sell'  =>  $total_sell
				) );

				$tbl .= "
				<tr>
					<td style=\"padding-top:25px;background-color:#efefef;\"></td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:12pt;background-color:#efefef;\" class=\"num_field\">\$" . number_format($total_sell, 2) . "</td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:12pt;background-color:#efefef;\" class=\"num_field\">\$" . number_format($total_cost, 2) . "</td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:12pt;background-color:#efefef;" .
    				( defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 || bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ?
        				"color:#ff0000;" : NULL
    				) . "\" class=\"num_field\">" .
					( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ?
						"(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . "%)" : (float)bcmul($_margin, 100, 4) . "%"
					) . "
					</td>
				</tr>
			</table>";

            $this->content['jscript'][] = "
            hide_row = function() {
                var sales_hash = arguments[0];
                var tbl_el = $$('tr[cid=c_'+sales_hash+']');
                if (tbl_el.length) {
                    var i=0, c;
                    while (c = tbl_el[i++]) {
                       c.remove();
                    }
                    return true;
                }

                return false;
            }";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			$tbl = $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_invoiced_sales_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_invoiced_sales_report', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Invoiced Sales Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe", array("All dates", "Invoiced sales dated this year", "Invoiced sales dated last year", "Invoiced sales from the current period", "Invoiced sales from the previous period", "Invoiced sales dated this month", "Invoiced sales dated last month", "A specific date range"), $this->current_report['timeframe'], array('*', 1, 2, 3, 4, 6, 7, 5), "onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Invoiced Sales Details?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("detail", array("Show Detailed View", "Show Simple View"), $this->current_report['detail'], array(1, 0), "blank=1")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]", $this->sales_name, (is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')), $this->sales_hash, "multiple", "blank=1", "size=4", "style=width:200px;", ($this->p->ck('proposals', 'S') ? "disabled" : NULL))."</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
                                                if (is_array($this->current_report['customer_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
                                                        $tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_vendor_discounting() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$expire_date = $this->current_report['expire_date'];
			$vendor_filter = $this->current_report['vendor_filter'];
			$customer_filter = $this->current_report['customer_filter'];
			$discount_id = trim($this->current_report['discount_id']);
			$showdetail = $this->current_report['showdetail'];
			$showexpired = $this->current_report['showexpired'];
		} else {
			$timeframe = $_POST['timeframe'];
			$expire_date = $_POST['expire_date'];
			$vendor_filter = $_POST['vendor_filter'];
			$customer_filter = $_POST['customer_filter'];
			$discount_id = trim($_POST['discount_id']);
			$showdetail = $_POST['showdetail'];
			$showexpired = $_POST['showexpired'];
		}

		if ($discount_id) {
			$discount_in = explode("\n", $discount_id);
			$c = count($discount_in);
			for ($i = 0; $i < $c; $i++) {
				if (!$discount_in[$i])
					unset($discount_in[$i]);
			}
		}

		$save = $_POST['save'];
		$saved_cat = "vendor_discounting";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($timeframe == 7 && !$expire_date) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The expire on date you specified is invalid! Please make sure you include an expire on date.";
		}

		if ($this->content['error'])
			return;

		switch ($timeframe) {
			//This year
			case 5:
			$sql_p[] = "discounting.discount_expiration_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			break;

			//Last year
			case 6:
			$sql_p[] = "discounting.discount_expiration_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			break;

			//this period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				//$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
				$sql_p[] = "discounting.discount_expiration_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//next period
			case 11:
			$period_info = get_period_info(date("Y-m-d"));
			$period_info = get_period_info(date("Y-m-d", strtotime($period_info['period_end']." +5 days")));
			if ($period_info['period_start']) {
				//$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
				$sql_p[] = "discounting.discount_expiration_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//last period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				//$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
				$sql_p[] = "discounting.discount_expiration_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//This Quarter
			case 1:
			list($start, $end) = get_quarter_dates(get_quarter(date("Y-m-d")), date("Y"));
			$sql_p[] = "discounting.discount_expiration_date BETWEEN '".$start."' AND '".$end."'";
			break;

			//Next Quarter
			case 10:
			list($start, $end) = get_quarter_dates(get_quarter(date("Y-m-d")), date("Y"));
			$d = date("Y-m-d", strtotime($end." +5 days"));
			list($start, $end) = get_quarter_dates(get_quarter($d), date("Y", strtotime($d)));
			$sql_p[] = "discounting.discount_expiration_date BETWEEN '".$start."' AND '".$end."'";
			break;

			//Last Quarter
			case 2:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $date) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start, $end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "discounting.discount_expiration_date BETWEEN '".$start."' AND '".$end."'";
			break;

			case 7:
			if ($expire_date)
				$sql_p[] = "discounting.discount_expiration_date = '".$expire_date."'";

			break;
		}
		if ($showexpired)
			$sql_p[] = "discounting.discount_expiration_date >= '".date("Y-m-d")."'";

		if ($vendor_filter && !is_array($vendor_filter)) {
			$vendor_filter = array($vendor_filter);
		}
		if ($customer_filter && !is_array($customer_filter)) {
			$customer_filter = array($customer_filter);
		}

		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter, 'add_quotes', "'");
			$sql_p[] = "discounting.vendor_hash IN (".implode(" , ", $vendor_filter).")";
			array_walk($vendor_filter, 'strip_quotes');
		}

		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter, 'add_quotes', "'");
			$sql_p[] = "discounting.customer_hash IN (".implode(" , ", $customer_filter).")";
			array_walk($customer_filter, 'strip_quotes');
		}

		if (is_array($discount_in) && count($discount_in)) {
			$discount_in = array_unique($discount_in);
			$discount_in = array_values($discount_in);
			array_walk($discount_in, 'add_quotes', "'");
			$sql_p[] = "discounting.discount_id IN (".implode(" , ", $discount_in).")";
			array_walk($discount_in, 'strip_quotes');
		}

		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$str = "timeframe=$timeframe|expire_date=$expire_date|showexpired=$showexpired|showdetail=$showdetail|vendor_filter=".@implode("&", $vendor_filter)."|customer_filter=".@implode("&", $customer_filter)."|discount_id=$discount_id";

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT vendors.vendor_name , customers.customer_name , discounting.*
									FROM `discounting`
									LEFT JOIN `vendors` ON vendors.vendor_hash = discounting.vendor_hash
									LEFT JOIN `customers` ON customers.customer_hash = discounting.customer_hash".($sql ? "
									WHERE ".$sql : NULL)."
									GROUP BY discounting.discount_hash
									ORDER BY customers.customer_name");

		while ($row = $this->db->fetch_assoc($result)) {
			$sort_list[$row['vendor_hash']] = $row['vendor_name'];
			$results[$row['vendor_hash']][$row['discount_hash']][] = $row;
			if ($showdetail == 2) {
				$result2 = $this->db->query("SELECT discount_details.* , vendor_products.product_name
											 FROM `discount_details`
											 LEFT JOIN vendor_products ON vendor_products.product_hash = discount_details.product_hash
											 WHERE discount_details.discount_hash = '".$row['discount_hash']."'");
				while ($row2 = $this->db->fetch_assoc($result2))
					$this->discount_details[$row['discount_hash']][] = $row2;
			}
		}
		//Asending order
		if (is_array($sort_list)) {
			asort($sort_list);
			if (is_array($sort_list)) {
				while (list($hash, $name) = each($sort_list))
					$this->results[$hash] = $results[$hash];
			}
		}

		if ($doit_print)
			return;

		$this->content['action'] = 'close';
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->vendor_discounting(1);
		return;
	}

	function show_discount_details() {
		$report_hash = $this->ajax_vars['report_hash'];
		$discount_hash = $this->ajax_vars['discount_hash'];

		$result = $this->db->query("SELECT discount_details.* , vendor_products.product_name
									FROM `discount_details`
									LEFT JOIN vendor_products ON vendor_products.product_hash = discount_details.product_hash
									WHERE discount_details.discount_hash = '".$discount_hash."'
									ORDER BY vendor_products.product_name , discount_details.item_no ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			unset($frf_item);
			if ($row['discount_frf']) {
				$discount_frf = explode("|", $row['discount_frf']);
				$frf_item = array();
				for ($k = 0; $k < count($discount_frf); $k++) {
					list($a, $b) = explode("=", $discount_frf[$k]);
					$a = str_replace("discount", "product", $a);
					$frf_item[$a] = $b;
				}
			}
			$sell = '';
			$tbl .= "
			<tr>
				<td style=\"vertical-align:top;background-color:#efefef;\">".($row['product_hash'] == '*' ?
					"All Products" : $row['product_name']).($frf_item || $row['discount_frf_quoted'] ?
					"<div style=\"margin:5px 0 0 5px;font-style:italic;\">".($frf_item ?
						"<div>
							If under ".math::format_num($frf_item['product_frf_amount'])." ".($frf_item['product_frf_amount_type'] == 'L' ? "
								List" : "Net")."
							<div style=\"padding:5px;\">
								Then add ".($frf_item['product_frf_amount_add_type'] == 'P' ?
									($frf_item['product_frf_amount_add']*100)."% of ".($frf_item['product_frf_amount_add_type_of'] == 'L' ? "
										List" : "Net") : math::format_num($frf_item['product_frf_amount_add']))."
							</div>" : NULL).($charges['product_frf_quoted'] ? "
						</div>" : NULL).($row['discount_frf_quoted'] ?
							"This freight needs to be quoted!" : NULL)."
					</div>" : NULL)."
				</td>
				<td style=\"vertical-align:top;background-color:#ffffff;\">".($row['item_no'] ?
                    trim($row['item_no']) : "&nbsp;")."
                </td>";
				if ($row['discount_type'] == 'F') {
					$tbl .= "
					<td class=\"num_field\" style=\"vertical-align:top;background-color:#ffffff;\">";
					$tbl .= ($row['buy_discount1'] != 0 ?
					($row['buy_discount1'] * 100)."%" : "&nbsp;").($row['buy_discount2'] != 0 ?
						"&nbsp;".($row['buy_discount2'] * 100)."%" : NULL).($row['buy_discount3'] != 0 ?
							"&nbsp;".($row['buy_discount3'] * 100)."%" : NULL).($row['buy_discount4'] != 0 ?
								"&nbsp;".($row['buy_discount4'] * 100)."%" : NULL).($row['buy_discount5'] != 0 ?
									"&nbsp;".($row['buy_discount5'] * 100)."%" : NULL)."
					</td>";
				} else {
					$tbl .= "
					<td style=\"vertical-align:top;background-color:#ffffff;\">";
					for ($i = 1; $i < 7; $i++) {
						if ($row['tier'.$i.'_from'] != 0) {
							$tbl .= "
							<div style=\"margin-bottom:5px;\">
								<div style=\"float:right;\">".($row['tier'.$i.'_buy_discount'] * 100)."%</div>".($row['tier'.$i.'_to'] != 0 ? "
								From $".number_format($row['tier'.$i.'_from'], 2)." To $".number_format($row['tier'.$i.'_to'], 2) : "Over $".number_format($row['tier'.$i.'_from'], 2))."
							</div>";
							$sell .= ($row['tier'.$i.'_sell_discount'] != 0 ? "
							<div style=\"margin-bottom:5px;\">".($row['tier'.$i.'_sell_discount'] * 100)."%</div>" : "&nbsp;");
						}
					}
					$tbl .= "
					</td>";
				}
				$tbl .= "
				<td class=\"num_field\" style=\"vertical-align:top;background-color:#ffffff;\">";
				if ($row['discount_type'] == 'F')
					$tbl .= ($row['sell_discount'] != 0 ?
						($row['sell_discount'] * 100)."%" : "&nbsp;")."
					</td>";
				else
					$tbl .= $sell."
					</td>";

				if ($row['discount_type'] == 'F')
					$tbl .= "
					<td class=\"num_field\" style=\"vertical-align:top;background-color:#ffffff;\">".($row['gp_margin'] != 0 ?
						($row['gp_margin'] * 100)."%" : "&nbsp;")."
					</td>";
				else
					$tbl .= "
					<td style=\"vertical-align:top;background-color:#ffffff;\" class=\"num_field\">&nbsp;</td>";

				$tbl .= "
			</tr>";
		}
		if (!$tbl)
			$tbl .= "
			<tr>
				<td colspan=\"4\" style=\"background-color:#ffffff;\">There are no product discounts defined for this vendor discount</td>
			</tr>";

		$this->content['html']['discount_details_'.$discount_hash] = "
		<table style=\"width:100%;background-color:#cccccc;\" cellpadding=\"3\" cellspacing=\"1\">
			<tr>
				<td style=\"font-weight:bold;background-color:#efefef;\">Product</td>
				<td style=\"font-weight:bold;background-color:#efefef;\">Item No.</td>
				<td style=\"font-weight:bold;background-color:#efefef;\" class=\"num_field\">Buy Discount</td>
				<td style=\"font-weight:bold;background-color:#efefef;\" class=\"num_field\">Sell Discount</td>
				<td style=\"font-weight:bold;background-color:#efefef;\" class=\"num_field\">GP Margin</td>
			</tr>" . $tbl ."
		</table>";
		$this->content['jscript'] = "toggle_display('discount_details_".$discount_hash."', 'block');";
		return;
	}

	function vendor_discounting($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Vendor Discounting Report").($this->p->ck('reports', 'V', 'vendor_discounting') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'vendor_discounting', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp; &nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=vendor_discounting', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:400px;text-align:left;padding-left:25px;\">Type</td>
					<td style=\"width:200px;\">Discount ID</td>
					<td style=\"width:150;\" class=\"num_field\">Effective Date</td>
					<td style=\"width:150px;\" class=\"num_field\">Expiration Date</td>
				</tr>";
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				while (list($vendor_hash, $discount_array) = each($this->results)) {
					reset($discount_array);
					$current = current($discount_array);
					$tbl .= "
					<tr>
						<td colspan=\"4\" style=\"font-weight:bold;background-color:#ffffff;\">".stripslashes($current[0]['vendor_name'])."</td>
					</tr>";

					while (list($discount_hash, $details) = each($discount_array)) {
						$tbl .= "
						<tr>
							<td style=\"padding-left:25px;background-color:#ffffff;\">
								<a href=\"javascript:void(0);\" onClick=\"if(\$('discount_details_".$discount_hash."').getStyle('display')=='block'){toggle_display('discount_details_".$discount_hash."', 'none');} else{agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'show_discount_details', 'report_hash=".$this->report_hash."', 'discount_hash=".$discount_hash."');}\" title=\"Show/Hide discount details\" class=\"link_standard\">
    								".($details[0]['discount_type'] == 'C' ?
        								"Customer Discount : ".stripslashes($details[0]['customer_name']) : "Standard Discount".($details[0]['discount_descr'] ?
    									" (".$details[0]['discount_descr'].")" : NULL))."
								</a>
							</td>
							<td style=\"background-color:#ffffff;\">".$details[0]['discount_id']."</td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\">".date(DATE_FORMAT, strtotime($details[0]['discount_effective_date']))."</td>
							<td style=\"background-color:#ffffff;".((strtotime($details[0]['discount_expiration_date']) - strtotime(date("Y-m-d"))) / 86400 <= 0 ? "color:#ff0000;" : ((strtotime($details[0]['discount_expiration_date']) - strtotime(date("Y-m-d"))) / 86400 <= 30 ? "color:#ffcc33;" : NULL))."\" class=\"num_field\">".date(DATE_FORMAT, strtotime($details[0]['discount_expiration_date']))."</td>
						</tr>
						<tr>
							<td colspan=\"4\" style=\"padding-left:25px;background-color:#ffffff;width:100%;\" >
								<div style=\"display:".($this->current_report['showdetail'] == 2 ? "block" : "none").";\" id=\"discount_details_".$discount_hash."\">";
								if ($this->current_report['showdetail'] == 2) {
									$tbl .= "
									<table style=\"width:100%;background-color:#cccccc;\" cellpadding=\"3\" cellspacing=\"1\">
										<tr>
											<td style=\"font-weight:bold;background-color:#efefef;\">Product</td>
											<td style=\"font-weight:bold;background-color:#efefef;\">Item No.</td>
											<td style=\"font-weight:bold;background-color:#efefef;\" class=\"num_field\">Buy Discount</td>
											<td style=\"font-weight:bold;background-color:#efefef;\" class=\"num_field\">Sell Discount</td>
											<td style=\"font-weight:bold;background-color:#efefef;\" class=\"num_field\">GP Margin</td>
										</tr>";
									for ($i = 0; $i < count($this->discount_details[$discount_hash]); $i++) {
										unset($frf_item);
										if ($this->discount_details[$discount_hash][$i]['discount_frf']) {
											$discount_frf = explode("|", $this->discount_details[$discount_hash][$i]['discount_frf']);
											$frf_item = array();
											for ($k = 0; $k < count($discount_frf); $k++) {
												list($a, $b) = explode("=", $discount_frf[$k]);
												$a = str_replace("discount", "product", $a);
												$frf_item[$a] = $b;
											}
										}
										$sell = '';
										$tbl .= "
										<tr>
											<td style=\"vertical-align:top;background-color:#efefef;\">".($this->discount_details[$discount_hash][$i]['product_hash'] == '*' ?
												"All Products" : $this->discount_details[$discount_hash][$i]['product_name']).($frf_item || $this->discount_details[$discount_hash][$i]['discount_frf_quoted'] ?
													"<div style=\"margin:5px 0 0 5px;\">".($frf_item?
														"<div>
															If under ".math::format_num($frf_item['product_frf_amount'])." ".($frf_item['product_frf_amount_type'] == 'L' ? "
																List" : "Net")."
															<div style=\"padding:5px;\">
																Then add ".($frf_item['product_frf_amount_add_type'] == 'P' ?
																	($frf_item['product_frf_amount_add']*100)."% of ".($frf_item['product_frf_amount_add_type_of'] == 'L' ? "
																		List" : "Net") : math::format_num($frf_item['product_frf_amount_add']))."
															</div>" : NULL).($charges['product_frf_quoted'] ? "
														</div>" : NULL).($this->discount_details[$discount_hash][$i]['discount_frf_quoted'] ?
															"This freight needs to be quoted!" : NULL)."
													</div>" : NULL)."
											</td>
											<td style=\"vertical-align:top;background-color:#ffffff;\">".($this->discount_details[$discount_hash][$i]['item_no'] ?
                                                trim($this->discount_details[$discount_hash][$i]['item_no']) : "&nbsp;")."
                                            </td>";
											if ($this->discount_details[$discount_hash][$i]['discount_type'] == 'F') {
												$tbl .= "
												<td class=\"num_field\" style=\"background-color:#ffffff;vertical-align:top;\">";
												$tbl .= ($this->discount_details[$discount_hash][$i]['buy_discount1'] != 0 ?
												($this->discount_details[$discount_hash][$i]['buy_discount1'] * 100)."%" : "&nbsp;").($this->discount_details[$discount_hash][$i]['buy_discount2'] != 0 ?
													"&nbsp;".($this->discount_details[$discount_hash][$i]['buy_discount2'] * 100)."%" : NULL).($this->discount_details[$discount_hash][$i]['buy_discount3'] != 0 ?
														"&nbsp;".($this->discount_details[$discount_hash][$i]['buy_discount3'] * 100)."%" : NULL).($this->discount_details[$discount_hash][$i]['buy_discount4'] != 0 ?
															"&nbsp;".($this->discount_details[$discount_hash][$i]['buy_discount4'] * 100)."%" : NULL).($this->discount_details[$discount_hash][$i]['buy_discount5'] != 0 ?
																"&nbsp;".($this->discount_details[$discount_hash][$i]['buy_discount5'] * 100)."%" : NULL)."
												</td>";
											} else {
												$tbl .= "
												<td style=\"background-color:#ffffff;vertical-align:top;\">";
												for ($j = 1; $j < 7; $j++) {
													if ($this->discount_details[$discount_hash][$i]['tier'.$j.'_from'] != 0) {
														$tbl .= "
														<div style=\"margin-bottom:5px;\">
															<div style=\"float:right;\">".($this->discount_details[$discount_hash][$i]['tier'.$j.'_buy_discount'] * 100)."%</div>".($this->discount_details[$discount_hash][$i]['tier'.$j.'_to'] != 0 ? "
															From $".number_format($this->discount_details[$discount_hash][$i]['tier'.$j.'_from'], 2)." To $".number_format($this->discount_details[$discount_hash][$i]['tier'.$j.'_to'], 2) : "Over $".number_format($this->discount_details[$discount_hash][$i]['tier'.$j.'_from'], 2))."
														</div>";
														$sell .= ($this->discount_details[$discount_hash][$i]['tier'.$j.'_sell_discount'] != 0 ? "
														<div style=\"margin-bottom:5px;\">".($this->discount_details[$discount_hash][$i]['tier'.$j.'_sell_discount'] * 100)."%</div>" : "N/A</div>");
													}
												}
												$tbl .= "
												</td>";
											}
											$tbl .= "
											<td class=\"num_field\" style=\"vertical-align:top;background-color:#ffffff;\">";
											if ($this->discount_details[$discount_hash][$i]['discount_type'] == 'F')
												$tbl .= ($this->discount_details[$discount_hash][$i]['sell_discount'] != 0 ?
													($this->discount_details[$discount_hash][$i]['sell_discount'] * 100)."%" : "&nbsp;")."
												</td>";
											else
												$tbl .= $sell."
												</td>";

											if ($this->discount_details[$discount_hash][$i]['discount_type'] == 'F')
												$tbl .= "
												<td class=\"num_field\" style=\"background-color:#ffffff;vertical-align:top;\">".($this->discount_details[$discount_hash][$i]['gp_margin'] != 0 ?
													($this->discount_details[$discount_hash][$i]['gp_margin'] * 100)."%" : "&nbsp;")."
												</td>";
											else
												$tbl .= "
												<td style=\"background-color:#ffffff;vertical-align:top;\" class=\"num_field\">&nbsp;</td>";

											$tbl .= "
										</tr>";
									}
									if (!$this->discount_details[$discount_hash])
										$tbl .= "
										<tr>
											<td style=\"background-color:#ffffff;\" colspan=\"5\">There are no product discounts defined for this vendor discount</td>
										</tr>";

									$tbl .= "
									</table>";
								}
							$tbl .= "
								</div>
							</td>
						</tr>";

					}
				}
			} else
				$tbl .= "
				<tr>
					<td colspan=\"4\" style=\"background-color:#ffffff;\">Your report returned an empty result.</td>
				</tr>";

			$tbl .= "
			</table>";
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
				$this->current_report['customer_filter'] = array($this->current_report['customer_filter']);


			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $this->report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_vendor_discounting');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_vendor_discounting', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Vendor Discounting Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Search discounts by<br />expiration date?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe", array("Discounts Expiring This Quarter", "Discounts Expiring Next Quarter", "Discounts That Expired Last Quarter", "Discounts Expiring This Period", "Discounts Expiring Next Period", "Discounts That Expired Last Period", "Discounts Expiring This Year", "Discounts That Expired Last Year", "Discounts Expiring on a Specific Date"), $this->current_report['timeframe'], array(1, 10, 2, 3, 11, 4, 5, 6, 7), "onChange=if(this.options[this.selectedIndex].value==7){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 7 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"expire_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'expire_date\', true, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 7 && $this->current_report['expire_date'] ? $this->current_report['expire_date'] : ''.date("Y-m-d").'')."\', 1, \'expire_date_holder\')', 500);";
												$tbl .= "
												</div>
												<div style=\"margin-top:10px;\">
													".$this->form->checkbox("name=showexpired", "value=1", ($this->current_report['showexpired'] == 1 ? "checked" : NULL))."
													&nbsp;
													Hide expired discounts?
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">
												Search by discount ID:
												<div style=\"margin-top:5px;font-style:italic;\">
													<small>Separate multiple discounts by line break</small>
												</div>
											</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->text_area("name=discount_id", "value=".$this->current_report['discount_id'], "rows=3", "cols=35")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Discount Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail", array("Show Simple View", "Show Detail View"), $this->current_report['showdetail'], array('1', '2'), "blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_vendor_balance() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 9) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$vendor_filter = $this->current_report['vendor_filter'];
			$showdetail = $this->current_report['showdetail'];
		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 9) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$vendor_filter = $_POST['vendor_filter'];
			$showdetail = $_POST['showdetail'];
		}

		if ($vendor_filter && !is_array($vendor_filter))
			$vendor_filter = array($vendor_filter);

		$save = $_POST['save'];
		$saved_cat = "vendor_balance";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if (($timeframe == 9 && !$sort_from_date) || ($timeframe == 9 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}

		if ($this->content['error'])
			return;

		switch ($timeframe) {
			// All dates
			case '*':
				$sql_p[] = "vendor_payables.invoice_date <= '".date("Y-m-d")."'";
				$this->report_title = "Invoices Dated Before ".date(DATE_FORMAT);
			break;

			// Today
			case 1:
			$sql_p[] = "vendor_payables.invoice_date = '".date("Y-m-d")."'";
			$this->report_title = "Invoices Dated ".date(DATE_FORMAT);
			break;

			// Yesterday
			case 2:
			$sql_p[] = "vendor_payables.invoice_date = '".date("Y-m-d", strtotime(date("Y-m-d")." -1 day"));
			$this->report_title = "Invoices Dated ".date(DATE_FORMAT, strtotime(date("Y-m-d")." -1 day"));
			break;

			//This Quarter
			case 3:
			list($this->report_date_start, $this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")), date("Y"));
			$sql_p[] = "vendor_payables.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$this->report_title = "Invoices Dated Between ".date(DATE_FORMAT, strtotime($this->report_date_start))." and ".date(DATE_FORMAT, strtotime($this->report_date_end));
			break;

			//Last Quarter
			case 4:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $date) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "vendor_payables.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$this->report_title = "Invoices Dated Between ".date(DATE_FORMAT, strtotime($this->report_date_start))." and ".date(DATE_FORMAT, strtotime($this->report_date_end));
			break;

			//This Period
			case 5:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = "vendor_payables.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			$this->report_title = "Invoices Dated Between ".date(DATE_FORMAT, strtotime($this->report_date_start))." and ".date(DATE_FORMAT, strtotime($this->report_date_end));
			break;

			//Last Period
			case 6:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = "vendor_payables.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			$this->report_title = "Invoices Dated Between ".date(DATE_FORMAT, strtotime($this->report_date_start))." and ".date(DATE_FORMAT, strtotime($this->report_date_end));
			break;

			//This Year
			case 7:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t", strtotime(date("Y-".($month + 11)."-01")));
			$sql_p[] = "vendor_payables.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$this->report_title = "Invoices Dated Between ".date(DATE_FORMAT, strtotime($this->report_date_start))." and ".date(DATE_FORMAT, strtotime($this->report_date_end));
			break;

			//Last Year
			case 8:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t", strtotime(date($last_year."-".($month + 11)."-01")));
			$sql_p[] = "vendor_payables.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$this->report_title = "Invoices Dated Between ".date(DATE_FORMAT, strtotime($this->report_date_start))." and ".date(DATE_FORMAT, strtotime($this->report_date_end));
			break;

			// A specific date range
			case 9:
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = "vendor_payables.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = "Invoices Dated Between ".date(DATE_FORMAT, strtotime($sort_from_date))." and ".date(DATE_FORMAT, strtotime($sort_to_date));
			} else {
				$sql_p[] = "vendor_payables.invoice_date >= '".$sort_from_date."'";
				$this->report_title = "Invoices Dated Between ".date(DATE_FORMAT, strtotime($sort_from_date))." and ".date(DATE_FORMAT);
			}
			break;
		}

		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter, 'add_quotes', "'");
			$sql_p[] = "vendor_payables.vendor_hash IN (".implode(" , ", $vendor_filter).")";
			array_walk($vendor_filter, 'strip_quotes');
		}
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|showdetail=$showdetail|sort_to_date=$sort_to_date|vendor_filter=".@implode("&", $vendor_filter);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT vendor_payables.invoice_hash , vendor_payables.invoice_no , vendor_payables.amount ,
									vendor_payables.balance , vendor_payables.invoice_date , vendor_payables.due_date , vendor_payables.vendor_hash , vendor_payables.type ,
									vendor_payables.po_hash, purchase_order.po_no , proposals.proposal_no , proposals.proposal_descr ,
									vendors.vendor_name as vendor_name
									FROM vendor_payables
									LEFT JOIN purchase_order ON purchase_order.po_hash = vendor_payables.po_hash AND purchase_order.deleted = 0
									LEFT JOIN proposals ON proposals.proposal_hash = purchase_order.proposal_hash
									LEFT JOIN vendors ON vendors.vendor_hash = vendor_payables.vendor_hash
									WHERE ".($sql ?
										$sql." AND " : NULL)." ((vendor_payables.type = 'I' OR vendor_payables.type = 'D' OR vendor_payables.type = 'C') AND vendor_payables.balance != 0 AND vendor_payables.deleted = 0)
									GROUP BY vendor_payables.invoice_hash");

		while ($row = $this->db->fetch_assoc($result)) {
			$sort_list[$row['vendor_hash']] = $row['vendor_name'];

			$results[$row['vendor_hash']][$row['po_hash']][] = $row;
			//$this->results_totals[$row['customer_hash']] = array("balance_total"	=>	$row['balance_total'] + $this->results_totals[$row['customer_hash']]['balance_total'],
																 //"balance_current"	=>	$row['balance_current'] + $this->results_totals[$row['customer_hash']]['balance_current'],
																 //"balance_sched1"	=>	$row['balance_sched1'] + $this->results_totals[$row['customer_hash']]['balance_sched1'],
																 //"balance_sched2"	=>	$row['balance_sched2'] + $this->results_totals[$row['customer_hash']]['balance_sched2'],
																 //"balance_sched3"	=>	$row['balance_sched3'] + $this->results_totals[$row['customer_hash']]['balance_sched3']);
		}


		//Asending order
		if (is_array($sort_list)) {
			asort($sort_list);
			if (is_array($sort_list)) {
				while (list($hash, $name) = each($sort_list))
					$this->results[$hash] = $results[$hash];
			}
		}
		$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->vendor_balance(1);
		return;
	}

	function vendor_balance($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Vendor Balance Report").($this->p->ck('reports', 'V', 'vendor_balance') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'vendor_balance', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp; &nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=vendor_balance', 'report_hash=".$this->report_hash."')\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:100px;text-align:left;padding-left:50px;\">Date</td>
					<td style=\"width:400;\">Type</td>
					<td style=\"width:75px;\">Due Date</td>
					<td style=\"width:112px;text-align:right;\">Amount</td>
					<td style=\"width:112px;text-align:right;\">Balance</td>
				</tr>";
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				while (list($vendor_hash, $po_array) = each($this->results)) {
					$vendor_total  = $vendor_balance = 0;
					reset($po_array);
					$current = current($po_array);
					$tbl .= "
					<tr>
						<td colspan=\"5\" style=\"font-weight:bold;background-color:#ffffff;font-size:10pt;\">".$current[0]['vendor_name']."</td>
					</tr>";
					while (list($po_hash, $details) = each($po_array)) {
						if ($this->current_report['showdetail'] == 2)
							$tbl .= ($po_hash ? "
							<tr>
								<td colspan=\"5\" style=\"font-weight:bold;background-color:#ffffff;padding-left:25px;padding-top:5px;\">
									Purchase Order: ".$details[0]['po_no']."
								</td>
							</tr>" : "
							<tr>
								<td colspan=\"5\" style=\"background-color:#ffffff;padding-top:5px;\">&nbsp;</td>
							</tr>");
						$amt = $bal = 0;
						for ($i = 0; $i < count($details); $i++) {
							unset($style1, $style2, $amount1, $amount2);

							if ($details[$i]['type'] == 'D' || $details[$i]['type'] == 'C') {
								$amt -= $details[$i]['amount'];
								$bal -= $details[$i]['balance'];
								$vendor_total -= $details[$i]['amount'];
								$vendor_balance -= $details[$i]['balance'];
								$total -= $details[$i]['amount'];
								$total_balance -= $details[$i]['balance'];
								if ($details[$i]['amount'] > 0)
									$style1 = "color:#ff0000;";
								if ($details[$i]['balance'] > 0)
									$style2 = "color:#ff0000;";

								if ($details[$i]['amount'] > 0)
									$amount1 = "($".number_format($details[$i]['amount'], 2).")";
								else
									$amount1 = "$".number_format($details[$i]['amount'] * -1, 2);

								if ($details[$i]['balance'] > 0)
									$amount2 = "($".number_format($details[$i]['balance'], 2).")";
								else
									$amount2 = "$".number_format($details[$i]['balance'] * -1, 2);

							} else {
								$amt += $details[$i]['amount'];
								$bal += $details[$i]['balance'];
								$vendor_total += $details[$i]['amount'];
								$vendor_balance += $details[$i]['balance'];
								$total += $details[$i]['amount'];
								$total_balance += $details[$i]['balance'];
								if ($details[$i]['amount'] < 0)
									$style1 = "color:#ff0000;";
								if ($details[$i]['balance'] < 0)
									$style2 = "color:#ff0000;";

								if ($details[$i]['amount'] < 0)
									$amount1 = "($".number_format($details[$i]['amount'] * -1, 2).")";
								else
									$amount1 = "$".number_format($details[$i]['amount'], 2);

								if ($details[$i]['balance'] < 0)
									$amount2 = "($".number_format($details[$i]['balance'] * -1, 2).")";
								else
									$amount2 = "$".number_format($details[$i]['balance'], 2);
							}

							if ($this->current_report['showdetail'] == 2)
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;padding-left:".($po_hash ? "50" : "50")."px;\">".$details[$i]['invoice_date']."</td>
									<td style=\"background-color:#ffffff;\">
										<a href=\"javascript:void(0);\" onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$details[$i]['invoice_hash']."', 'popup_id=line_item');\" class=\"link_standard\">".($details[$i]['type'] == 'D' ? "Deposit" : ($details[$i]['type'] == 'I' ? "Bill" : "Vendor Credit")." ".$details[$i]['invoice_no'])."</a>
									</td>
									<td style=\"background-color:#ffffff;\">".($details[$i]['type'] != 'D' ?
										date(DATE_FORMAT, strtotime($details[$i]['due_date'])) : "&nbsp;")."</td>
									<td style=\"background-color:#ffffff;".$style1."\" class=\"num_field\">".$amount1."</td>
									<td style=\"background-color:#ffffff;".$style2."\" class=\"num_field\">".$amount2."</td>
								</tr>";
						}
						if ($this->current_report['showdetail'] == 2 && count($details) > 1)
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;\" colspan=\"3\"></td>
								<td style=\"background-color:#ffffff;border-top:1px solid #cccccc;".($amt < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($amt < 0 ?
									"($".number_format($amt * -1, 2).")" : "$".number_format($amt, 2))."
								</td>
								<td style=\"background-color:#ffffff;border-top:1px solid #cccccc;".($bal < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($bal < 0 ?
									"($".number_format($bal * -1, 2).")" : "$".number_format($bal, 2))."
								</td>
							</tr>";
					}
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;padding-bottom:10px;padding-top:10px;font-size:10pt;font-weight:bold;border-bottom:1px solid #cccccc;\" colspan=\"3\">".($this->current_report['showdetail'] == 2 ? "Total for ".$current[0]['vendor_name'] : "&nbsp;")."</td>
						<td style=\"background-color:#ffffff;padding-bottom:10px;padding-top:10px;".($this->current_report['showdetail'] == 2 ? "border-top:1px solid #cccccc;" : NULL)."font-weight:bold;border-bottom:1px solid #cccccc;".($vendor_total < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($vendor_total < 0 ?
							"($".number_format($vendor_total * -1, 2).")" : "$".number_format($vendor_total, 2))."
						</td>
						<td style=\"background-color:#ffffff;padding-bottom:10px;".($this->current_report['showdetail'] == 2 ? "border-top:1px solid #cccccc;" : NULL)."font-weight:bold;border-bottom:1px solid #cccccc;".($vendor_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($vendor_balance < 0 ?
							"($".number_format($vendor_balance * -1, 2).")" : "$".number_format($vendor_balance, 2))."
						</td>
					</tr>";
				}
			}
			$tbl .= "
			<tr>
				<td style=\"background-color:#ffffff;padding-bottom:10px;font-size:12pt;font-weight:bold;padding-top:15px;\" colspan=\"3\">Total Vendor Balance</td>
				<td style=\"background-color:#ffffff;padding-bottom:10px;font-weight:bold;font-size:10pt;padding-top:15px;".($total < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total < 0 ?
					"($".number_format($total * -1, 2).")" : "$".number_format($total, 2))."
				</td>
				<td style=\"background-color:#ffffff;padding-bottom:10px;font-weight:bold;font-size:10pt;padding-top:15px;".($total_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_balance < 0 ?
					"($".number_format($total_balance * -1, 2).")" : "$".number_format($total_balance, 2))."
				</td>
			</tr>";
			$tbl .= "
			</table>";
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_vendor_balance');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_vendor_balance', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Vendor Balance Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe", array("All dates", "Today", "Yesterday", "This Quarter", "Last Quarter", "This Period", "Last Period", "This year", "Last year", "A specific date range"), $this->current_report['timeframe'], array('*', 1, 2, 3, 4, 5, 6, 7, 8, 9), "onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail", array("Show Detail View", "Show Simple View"), $this->current_report['showdetail'], array('2', '1'), "blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_customer_balance() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 9) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$showdetail = $this->current_report['showdetail'];
			$customer_filter = $this->current_report['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);

		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 9) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$customer_filter = $_POST['customer_filter'];
			$showdetail = $_POST['showdetail'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
		}

		$save = $_POST['save'];
		$saved_cat = "customer_balance";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if (($timeframe == 9 && !$sort_from_date) || ($timeframe == 9 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}

		if ($this->content['error'])
			return;

		switch ($timeframe) {
			// To Date
			case '*':
				$this->report_date = date("Y-m-d");
				$sql_p[] = "customer_invoice.invoice_date <= '".$this->report_date."'";
			break;

			// Today
			case 1:
				$sql_p[] = "customer_invoice.invoice_date = '".date("Y-m-d");
			break;

			// Yesterday
			case 2:
				$sql_p[] = "customer_invoice.invoice_date = '".date("Y-m-d", strtotime(date("Y-m-d")." -1 day"));
			break;

			// This Quarter
			case 3:
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")), date("Y"));
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			// Last Quarter
			case 4:
				$current_qtr = get_quarter();
				if ($current_qtr == 1) {
					$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
					list($this->report_date_start, $this->report_date_end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
				} else
					list($this->report_date_start, $this->report_date_end) = get_quarter_dates($current_qtr - 1, date("Y"));
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			// This Period
			case 5:
				$period_info = get_period_info(date("Y-m-d"));
				if ($period_info['period_start']) {
					$this->report_date_start = $period_info['period_start'];
					$this->report_date_end = $period_info['period_end'];
					$sql_p[] = "customer_invoice.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
				} else {
					$this->content['error'] = 1;
					$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
					return;
				}
			break;

			// Last Period
			case 6:
				$period_info = get_previous_period(date("Y-m-d"));
				if ($period_info['period_start']) {
					$this->report_date_start = $period_info['period_start'];
					$this->report_date_end = $period_info['period_end'];
					$sql_p[] = "customer_invoice.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
				} else {
					$this->content['error'] = 1;
					$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
					return;
				}
			break;

			// This Year
			case 7:
				list($month, $day) = explode("/", FISCAL_YEAR_START);
				if (!$month || !$day)
					$month = $day = 1;
				$this->report_date_start = date("Y")."-".$month."-".$day;
				$this->report_date_end = date("Y")."-".($month + 11)."-".date("t", strtotime(date("Y-".($month + 11)."-01")));
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			// Last Year
			case 8:
				list($month, $day) = explode("/", FISCAL_YEAR_START);
				if (!$month || !$day)
					$month = $day = 1;
				$last_year = date("Y") - 1;
				$this->report_date_start = $last_year."-".$month."-".$day;
				$this->report_date_end = $last_year."-".($month + 11)."-".date("t", strtotime(date($last_year."-".($month + 11)."-01")));
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			// Specific Date Range
			case 9:
				if ($sort_from_date && $sort_to_date) {
					$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
					$this->report_date_start = $sort_from_date;
					$this->report_date_end = $sort_to_date;
				} else {
					$sql_p[] = "customer_invoice.invoice_date >= '".$sort_from_date."'";
					$this->report_date_start = $sort_from_date;
				}
			break;
		}

		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter, 'add_quotes', "'");
			$sql_p[] = "customer_invoice.customer_hash IN (".implode(" , ", $customer_filter).")";
			array_walk($customer_filter, 'strip_quotes');
		}
		if ($sql_p)
			$sql = " AND ".implode(" AND ", $sql_p);

		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|showdetail=$showdetail|sort_to_date=$sort_to_date|customer_filter=".@implode("&", $customer_filter);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT customer_invoice.invoice_hash , customer_invoice.invoice_no , customer_invoice.amount ,
									customer_invoice.balance , customer_invoice.invoice_date , customer_invoice.customer_hash , customer_invoice.type ,
									customer_invoice.proposal_hash, proposals.proposal_no , proposals.proposal_descr ,
									customer_invoice.invoice_to , customers.customer_name as customer_name , customers.payment_terms ,
								    CASE
								    WHEN ISNULL(customers.customer_name)
									  	THEN vendors.vendor_name
									  	ELSE 0
								   	END AS vendor_name
									FROM customer_invoice
									LEFT JOIN proposals ON proposals.proposal_hash = customer_invoice.proposal_hash
									LEFT JOIN customers ON customers.customer_hash = customer_invoice.customer_hash
									LEFT JOIN vendors ON vendors.vendor_hash = customer_invoice.customer_hash
									WHERE ((customer_invoice.type = 'I' AND customer_invoice.balance != 0) OR (customer_invoice.type = 'D' AND customer_invoice.balance != 0)) AND customer_invoice.deleted = 0 ".($sql ?
										$sql : NULL)."
									GROUP BY customer_invoice.invoice_hash");

		while ($row = $this->db->fetch_assoc($result)) {
			$sort_list[$row['customer_hash']] = ($row['customer_name'] ? stripslashes($row['customer_name']) : stripslashes($row['vendor_name']));

			$results[$row['customer_hash']][$row['proposal_hash']][] = $row;
			//$this->results_totals[$row['customer_hash']] = array("balance_total"	=>	$row['balance_total'] + $this->results_totals[$row['customer_hash']]['balance_total'],
																 //"balance_current"	=>	$row['balance_current'] + $this->results_totals[$row['customer_hash']]['balance_current'],
																 //"balance_sched1"	=>	$row['balance_sched1'] + $this->results_totals[$row['customer_hash']]['balance_sched1'],
																 //"balance_sched2"	=>	$row['balance_sched2'] + $this->results_totals[$row['customer_hash']]['balance_sched2'],
																 //"balance_sched3"	=>	$row['balance_sched3'] + $this->results_totals[$row['customer_hash']]['balance_sched3']);
		}


		//Asending order
		if (is_array($sort_list)) {
			asort($sort_list);
			if (is_array($sort_list)) {
				while (list($hash, $name) = each($sort_list))
					$this->results[$hash] = $results[$hash];
			}
		}
		$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->customer_balance(1);
		return;
	}

	function customer_balance($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Customer Balance Report").($this->p->ck('reports', 'V', 'customer_balance') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'customer_balance', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=customer_balance', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:100px;text-align:left;padding-left:50px;\">Date</td>
					<td style=\"width:400;\">Type</td>
					<td style=\"width:75px;\">Due Date</td>
					<td style=\"width:112px;text-align:right;\">Amount</td>
					<td style=\"width:112px;text-align:right;\">Balance</td>
				</tr>";
			$customers = new customers($this->current_hash);
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				while (list($customer_hash, $proposal_array) = each($this->results)) {
					$customer_total  = $customer_balance = 0;
					reset($proposal_array);
					$current = current($proposal_array);
					$tbl .= "
					<tr>
						<td colspan=\"5\" style=\"font-weight:bold;background-color:#ffffff;font-size:10pt;\">".($current[0]['invoice_to'] == 'C' ? $current[0]['customer_name'] : $current[0]['vendor_name'])."</td>
					</tr>";
					while (list($proposal_hash, $details) = each($proposal_array)) {
						if ($this->current_report['showdetail'] == 2)
							$tbl .= "
							<tr>
								<td colspan=\"5\" style=\"font-weight:bold;background-color:#ffffff;padding-left:25px;padding-top:5px;\">".($proposal_hash ? "
									Proposal: ".$details[0]['proposal_no']." - ".$details[0]['proposal_descr'] : "Unapplied Deposits")."
								</td>
							</tr>";
						$amt = $bal = 0;
						for ($i = 0; $i < count($details); $i++) {
							unset($style1, $style2, $amount1, $amount2);

							if ($details[$i]['type'] == 'D') {
								$amt -= $details[$i]['amount'];
								$bal -= $details[$i]['balance'];
								$customer_total -= $details[$i]['amount'];
								$customer_balance -= $details[$i]['balance'];
								$total -= $details[$i]['amount'];
								$total_balance -= $details[$i]['balance'];
								if ($details[$i]['amount'] > 0)
									$style1 = "color:#ff0000;";
								if ($details[$i]['balance'] > 0)
									$style2 = "color:#ff0000;";

								if ($details[$i]['amount'] > 0)
									$amount1 = "($".number_format($details[$i]['amount'], 2).")";
								else
									$amount1 = "$".number_format($details[$i]['amount'] * -1, 2);

								if ($details[$i]['balance'] > 0)
									$amount2 = "($".number_format($details[$i]['balance'], 2).")";
								else
									$amount2 = "$".number_format($details[$i]['balance'] * -1, 2);

							} else {
								$amt += $details[$i]['amount'];
								$bal += $details[$i]['balance'];
								$customer_total += $details[$i]['amount'];
								$customer_balance += $details[$i]['balance'];
								$total += $details[$i]['amount'];
								$total_balance += $details[$i]['balance'];
								if ($details[$i]['amount'] < 0)
									$style1 = "color:#ff0000;";
								if ($details[$i]['balance'] < 0)
									$style2 = "color:#ff0000;";

								if ($details[$i]['amount'] < 0)
									$amount1 = "($".number_format($details[$i]['amount'] * -1, 2).")";
								else
									$amount1 = "$".number_format($details[$i]['amount'], 2);

								if ($details[$i]['balance'] < 0)
									$amount2 = "($".number_format($details[$i]['balance'] * -1, 2).")";
								else
									$amount2 = "$".number_format($details[$i]['balance'], 2);
							}

							if ($this->current_report['showdetail'] == 2)
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;padding-left:50px;\">".$details[$i]['invoice_date']."</td>
									<td style=\"background-color:#ffffff;\">
										<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', '".($details[$i]['type'] == 'D' ? "new_deposit" : "edit_invoice")."', 'invoice_hash=".$details[$i]['invoice_hash']."', 'proposal_hash=".$proposal_hash."', 'popup_id=line_item');\" class=\"link_standard\">".($details[$i]['type'] == 'D' ? "Deposit" : "Invoice ".$details[$i]['invoice_no'])."</a>
									</td>
									<td style=\"background-color:#ffffff;\">".($details[$i]['type'] != 'D' ?
										((is_numeric($details[$i]['payment_terms']) && $details[$i]['payment_terms'] == 0) || (!is_numeric($details[$i]['payment_terms']) && DEFAULT_CUST_PAY_TERMS == 0) ? " Upon Receipt" : date(DATE_FORMAT, strtotime($details[$i]['invoice_date']." +".(is_numeric($details[$i]['payment_terms']) ? $details[$i]['payment_terms'] : DEFAULT_CUST_PAY_TERMS)." days"))) : "&nbsp;")."</td>
									<td style=\"background-color:#ffffff;".$style1."\" class=\"num_field\">".$amount1."</td>
									<td style=\"background-color:#ffffff;".$style2."\" class=\"num_field\">".$amount2."</td>
								</tr>";
						}
						if ($this->current_report['showdetail'] == 2 && count($details) > 1)
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;\" colspan=\"3\"></td>
								<td style=\"background-color:#ffffff;border-top:1px solid #cccccc;".($amt < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($amt < 0 ?
									"($".number_format($amt * -1, 2).")" : "$".number_format($amt, 2))."
								</td>
								<td style=\"background-color:#ffffff;border-top:1px solid #cccccc;".($bal < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($bal < 0 ?
									"($".number_format($bal * -1, 2).")" : "$".number_format($bal, 2))."
								</td>
							</tr>";
					}
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;padding-bottom:10px;font-size:10pt;font-weight:bold;border-bottom:1px solid #cccccc;\" colspan=\"3\">".($this->current_report['showdetail'] == 2 ? "Total for ".($current[0]['invoice_to'] == 'C' ? stripslashes($current[0]['customer_name']) : stripslashes($current[0]['vendor_name'])) : "&nbsp;")."</td>
						<td style=\"background-color:#ffffff;padding-bottom:10px;".($this->current_report['showdetail'] == 2 ? "border-top:1px solid #cccccc;" : NULL)."font-weight:bold;border-bottom:1px solid #cccccc;".($customer_total < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($customer_total < 0 ?
							"($".number_format($customer_total * -1, 2).")" : "$".number_format($customer_total, 2))."
						</td>
						<td style=\"background-color:#ffffff;padding-bottom:10px;".($this->current_report['showdetail'] == 2 ? "border-top:1px solid #cccccc;" : NULL)."font-weight:bold;border-bottom:1px solid #cccccc;".($customer_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($customer_balance < 0 ?
							"($".number_format($customer_balance * -1, 2).")" : "$".number_format($customer_balance, 2))."
						</td>
					</tr>";
				}
			}
			$tbl .= "
			<tr>
				<td style=\"background-color:#ffffff;padding-bottom:10px;font-size:12pt;font-weight:bold;padding-top:15px;\" colspan=\"3\">Total Customer Balance</td>
				<td style=\"background-color:#ffffff;padding-bottom:10px;border-top:1px solid #cccccc;font-weight:bold;font-size:10pt;padding-top:15px;".($total < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total < 0 ?
					"($".number_format($total * -1, 2).")" : "$".number_format($total, 2))."
				</td>
				<td style=\"background-color:#ffffff;padding-bottom:10px;border-top:1px solid #cccccc;font-weight:bold;font-size:10pt;padding-top:15px;".($total_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_balance < 0 ?
					"($".number_format($total_balance * -1, 2).")" : "$".number_format($total_balance, 2))."
				</td>
			</tr>";
			$tbl .= "
			</table>";
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_customer_balance');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_customer_balance', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Customer Balance Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe", array("All dates", "Today", "Yesterday", "Current Quarter", "Previous Quarter", "Current Period", "Previous Period", "Current year", "Previous year", "A specific date range"), $this->current_report['timeframe'], array('*', 1, 2, 3, 4, 5, 6, 7, 8, 9), "onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail", array("Show Detail View", "Show Simple View"), $this->current_report['showdetail'], array('2', '1'), "blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

    function ar_report($step=NULL) {
        $this->unlock("_");

        if ($step) {
            $this->fetch_report_settings($this->report_hash);
            $tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
            <table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:970px;margin-top:0;\">
                <tr>
                    <td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"9\">
                        <h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
                            ".($this->current_report['saved'] ?
                                $this->current_report['report_name'] : "Accounts Receivable Report").($this->p->ck('reports', 'V', 'ar') ? "
                            <span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
                                [<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'ar_report', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
                            </span>" : NULL)."
                            <div style=\"margin-left:15px;margin-top:10px;margin-bottom:10px;font-size:10pt;\">".$this->report_title."</div>
                        </h3>
                        <div style=\"margin-left:20px;margin-bottom:5px;\">
                            <small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
                            &nbsp;&nbsp;
                            <a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=ar_report', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
                        </div>
                    </td>
                </tr>
                <tr class=\"thead\" style=\"font-weight:bold;\">
                    <td style=\"width:200px;text-align:left;padding:15px 5px 5px 25px;vertical-align:bottom;\">".($this->current_report['showdetail'] == 2 ? "Invoice No." : "&nbsp;")."</td>
                    <td style=\"width:110px;padding:5px;vertical-align:bottom;\">".($this->current_report['showdetail'] == 2 ? "Date" : "&nbsp;")."</td>
                    <td style=\"width:90px;padding:5px;vertical-align:bottom;\">".($this->current_report['showdetail'] == 2 ? "Due Date" : "&nbsp;")."</td>
                    <td style=\"width:120x;padding:5px;vertical-align:bottom;\" class=\"num_field\">Orig Amt</td>
                    <td style=\"width:120px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Balance</td>
                    <td style=\"width:115px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Current</td>
                    <td style=\"width:115px;padding:5px;vertical-align:bottom;\" class=\"num_field\">".$this->current_report['age1']." Days</td>
                    <td style=\"width:115px;padding:5px;vertical-align:bottom;\" class=\"num_field\">".$this->current_report['age2']." Days</td>
                    <td style=\"width:115px;padding:5px;vertical-align:bottom;\" class=\"num_field\">".$this->current_report['age3']." Days</td>
                </tr>";

            if (is_array($this->results)) {

                $k = 0;
                while ( list($customer_hash, $proposal_array) = each($this->results) ) {

                    $total_invoice = $total_balance = $total_current = $total_sched1 = $total_sched2 = $total_sched3 = 0;
                    reset($proposal_array);

                    $tbl .= "
                    <tr style=\"background-color:".($this->current_report['showdetail'] == 2 ? "#efefef;" : ($k % 2 == 0 ? "#ffffff" : "#efefef"))."\">
                        <td colspan=\"3\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".stripslashes($proposal_array['customer_name'])."</td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0 ?
                                "Amount" : "&nbsp;") : ($proposal_array['total_receivable'] < 0 ?
                                    "($".number_format($proposal_array['total_receivable'] * -1, 2).")" : "$".number_format($proposal_array['total_receivable'], 2)))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0  ?
                                "Balance" : "&nbsp;") : ($proposal_array['balance_total'] < 0 ?
                                    "($".number_format($proposal_array['balance_total'] * -1, 2).")" : "$".number_format($proposal_array['balance_total'], 2)))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0  ?
                                "Current" : "&nbsp;") : ($proposal_array['balance_current'] < 0 ?
                                    "($".number_format($proposal_array['balance_current'] * -1, 2).")" : "$".number_format($proposal_array['balance_current'], 2)))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0  ?
                                $this->current_report['age1']." Days" : "&nbsp;") : ($proposal_array['balance_sched1'] < 0 ?
                                    "($".number_format($proposal_array['balance_sched1'] * -1, 2).")" : "$".number_format($proposal_array['balance_sched1'], 2)))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0  ?
                                $this->current_report['age2']." Days" : "&nbsp;") : ($proposal_array['balance_sched2'] < 0 ?
                                    "($".number_format($proposal_array['balance_sched2'] * -1, 2).")" : "$".number_format($proposal_array['balance_sched2'], 2)))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0  ?
                                $this->current_report['age3']." Days" : "&nbsp;") : ($proposal_array['balance_sched3'] < 0 ?
                                    "($".number_format($proposal_array['balance_sched3'] * -1, 2).")" : "$".number_format($proposal_array['balance_sched3'], 2)))."
                        </td>
                    </tr>";

                    $k++;
                    if ( $this->current_report['showdetail'] == 2 ) {

                    	reset($this->invoice_detail[$customer_hash]);
                        while ( list($proposal_hash, $details) = each($this->invoice_detail[$customer_hash]) ) {

                            if ( $details[0]['proposal_no'] ) { // Show contact info for Trac #1395

                                $tbl .= "
                                <tr>
                                    <td colspan=\"9\" style=\"vertical-align:top;font-size:8pt;background-color:#ffffff;padding-left:25px;padding-top:5px;border-top:1px solid #efefef;\">" .
                                    ( $proposal_hash && $proposal_hash != '__UNAPPLIED__' ? "
										Proposal: <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=$proposal_hash', 'popup_id=proposal_win', 'from_report=1');\">".$details[0]['proposal_no']."</a> - ".$details[0]['proposal_descr'] : "&nbsp;"
									) .
									( $this->current_report['contact_detail'] == 2 && $details[0]['contact_hash'] ?
                                        "<div style=\"margin-top:5px;width:65%;\">
                                            <fieldset style=\"padding-left:5px;padding-bottom:5px;margin-left:25px;padding-left:10px;\">
                                                <legend style=\"font-size:8pt;\">Customer Contact</legend>" .
                                                ( $details[0]['contact_name'] || $details[0]['contact_email'] ?
                                                    ( $details[0]['contact_name'] ?
                                                        "{$details[0]['contact_name']}&nbsp;&nbsp;" : NULL
                                                    ) .
                                                    ( $details[0]['contact_email'] ?
                                                        $details[0]['contact_email'] : NULL
                                                    ) .
                                                    "<br />" : NULL
                                                ) .
                                                ( $details[0]['contact_phone1'] || $details[0]['contact_phone2'] ?
                                                    ( $details[0]['contact_phone1'] ?
                                                        "{$details[0]['contact_phone1']}&nbsp;(p)&nbsp;&nbsp;" : NULL
                                                    ) .
                                                    ( $details[0]['contact_phone2'] ?
                                                        "{$details[0]['contact_phone2']}&nbsp;(p)&nbsp;&nbsp;" : NULL
                                                    ) .
                                                    "<br />" : NULL
                                                ) .
                                                ( $details[0]['contact_mobile'] || $details[0]['contact_fax'] ?
                                                    ( $details[0]['contact_mobile'] ?
                                                        "{$details[0]['contact_mobile']}&nbsp;(m)&nbsp;&nbsp;" : NULL
                                                    ) .
                                                    ( $details[0]['contact_fax'] ?
                                                        "{$details[0]['contact_fax']}&nbsp;(f)&nbsp;&nbsp;" : NULL
                                                    ) .
                                                    "<br />" : NULL
                                                ) . "
                                            </fieldset>
                                        </div>" : "&nbsp;"
                                    ) . "
									</td>
                                </tr>";
                            }

                            for ( $i = 0; $i < count( $details ); $i++ ) {

                                $total_balance = bcadd($total_balance, $details[$i]['balance_total'], 2);
                                $total_invoice = bcadd($total_invoice, $details[$i]['total_receivable'], 2);

                                $total_current += $details[$i]['balance_current'];
                                $total_sched1 += $details[$i]['balance_sched1'];
                                $total_sched2 += $details[$i]['balance_sched2'];
                                $total_sched3 += $details[$i]['balance_sched3'];

                                $tbl .= "
                                <tr>
                                    <td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\">" .
                                    ( $details[$i]['type'] == 'I' ? "
                                        <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash={$details[$i]['invoice_hash']}', 'proposal_hash=$proposal_hash', 'popup_id=line_item');\" class=\"link_standard\">{$details[$i]['invoice_no']}</a>" : NULL
                                    ) .
                                    ( $details[$i]['type'] == 'D' ? "
                                        <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'new_deposit', 'invoice_hash={$details[$i]['invoice_hash']}', 'proposal_hash=$proposal_hash', 'popup_id=line_item');\" class=\"link_standard\">" . ( ! $proposal_hash ? "Unapplied " : NULL ) . "Deposit</a>" : NULL
                                    ) .
                                    ( $details[$i]['type'] == 'C' && $details[$i]['credit_hash'] ? "
                                        <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_credits', 'sf_loadcontent', 'show_popup_window', 'edit_credit', 'credit_hash={$details[$i]['credit_hash']}', 'popup_id=line_item');\" class=\"link_standard\">Credit {$details[$i]['credit_no']}</a>" : NULL
                                    ) .
                                    "
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($details[$i]['invoice_date']))."</td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\">" .
                                    ( $details[$i]['due_date'] ?
                                        date(DATE_FORMAT, strtotime($details[$i]['due_date'])) : "&nbsp;"
                                    ) . "
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['total_receivable'] < 0 ?
                                        "($".number_format($details[$i]['total_receivable'] * -1, 2).")" : "$".number_format($details[$i]['total_receivable'], 2))."
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_total'] < 0 ?
                                        "($".number_format(($details[$i]['balance_total'] * -1), 2).")" : "$".number_format($details[$i]['balance_total'], 2))."
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_current'] != 0 ?
                                        ($details[$i]['balance_current'] < 0 ?
                                            "($".number_format($details[$i]['balance_current'] * -1, 2).")" : "$".number_format($details[$i]['balance_current'], 2)) : NULL)."
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_sched1'] != 0 ?
                                        ($details[$i]['balance_sched1'] < 0 ?
                                            "($".number_format($details[$i]['balance_sched1'] * -1, 2).")" : "$".number_format($details[$i]['balance_sched1'], 2)) : NULL)."
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_sched2'] != 0 ?
                                        ($details[$i]['balance_sched2'] < 0 ?
                                            "($".number_format($details[$i]['balance_sched2'] * -1, 2).")" : "$".number_format($details[$i]['balance_sched2'], 2)) : NULL)."
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_sched3'] != 0 ?
                                        ($details[$i]['balance_sched3'] < 0 ?
                                            "($".number_format($details[$i]['balance_sched3'] * -1, 2).")" : "$".number_format($details[$i]['balance_sched3'], 2)) : NULL)."
                                    </td>
                                </tr>";
                            }
                        }

                        $grand_total['invoice'] = bcadd($grand_total['invoice'], $total_invoice, 2);
                        $grand_total['balance'] = bcadd($grand_total['balance'], $total_balance, 2);
                        $grand_total['current'] = bcadd($grand_total['current'], $total_current, 2);
                        $grand_total['sched1'] = bcadd($grand_total['sched1'], $total_sched1, 2);
                        $grand_total['sched2'] = bcadd($grand_total['sched2'], $total_sched2, 2);
                        $grand_total['sched3'] = bcadd($grand_total['sched3'], $total_sched3, 2);

                        $tbl .= "
                        <tr>
                            <td style=\"font-size:8pt;background-color:#ffffff;\" colspan=\"3\"></td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:95%;\">".($total_invoice < 0 ?
                                    "($".number_format($total_invoice * -1, 2).")" : "$".number_format($total_invoice, 2))."
                                </div>
                            </td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:95%;\">".($total_balance < 0 ?
                                    "($".number_format($total_balance * -1, 2).")" : "$".number_format($total_balance, 2))."
                                </div>
                            </td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">".(bccomp($total_current, 0, 2) != 0 ? "
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:95%;\">".($total_current < 0 ?
                                    "($".number_format($total_current * -1, 2).")" : "$".number_format($total_current, 2))."
                                </div>" : NULL)."
                            </td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">".(bccomp($total_sched1, 0, 2) != 0 ? "
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:95%;\">".($total_sched1 < 0 ?
                                    "($".number_format($total_sched1 * -1, 2).")" : "$".number_format($total_sched1, 2))."
                                </div>" : NULL)."
                            </td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">".(bccomp($total_sched2, 0, 2) != 0 ? "
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:95%;\">".($total_sched2 < 0 ?
                                    "($".number_format($total_sched2 * -1, 2).")" : "$".number_format($total_sched2, 2))."
                                </div>" : NULL)."
                            </td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">".(bccomp($total_sched3, 0, 2) != 0 ? "
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:95%;\">".($total_sched3 < 0 ?
                                    "($".number_format($total_sched3 * -1, 2).")" : "$".number_format($total_sched3, 2))."
                                </div>" : NULL)."
                            </td>
                        </tr>";
                    } else {

                        $grand_total['invoice'] = bcadd($grand_total['invoice'], $proposal_array['total_receivable'], 2);
                        $grand_total['balance'] = bcadd($grand_total['balance'], $proposal_array['balance_total'], 2);
                        $grand_total['current'] = bcadd($grand_total['current'], $proposal_array['balance_current'], 2);
                        $grand_total['sched1'] = bcadd($grand_total['sched1'], $proposal_array['balance_sched1'], 2);
                        $grand_total['sched2'] = bcadd($grand_total['sched2'], $proposal_array['balance_sched2'], 2);
                        $grand_total['sched3'] = bcadd($grand_total['sched3'], $proposal_array['balance_sched3'], 2);
                    }
                }
            }

            $grand_total_all = $grand_total['current'] + $grand_total['sched1'] + $grand_total['sched2'] + $grand_total['sched3'];

            $tbl .= "
                    <tr >
                        <td style=\"background-color:#ffffff;font-size:8pt;padding:40px 5px 10px 0;\" colspan=\"3\">&nbsp;</td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding:40px 5px 10px 0;\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">
                                $".number_format($grand_total['invoice'], 2)."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding:40px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">".($grand_total['balance'] < 0 ?
                                "($".number_format($grand_total['balance']*-1).")" : "$".number_format($grand_total['balance'], 2))."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding:40px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">".($grand_total['current'] < 0 ?
                                "($".number_format($grand_total['current'] * -1, 2).")" : "$".number_format($grand_total['current'], 2))."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding:40px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">".($grand_total['sched1'] < 0 ?
                                "($".number_format($grand_total['sched1'] * -1, 2).")" : "$".number_format($grand_total['sched1'], 2))."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding:40px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">".($grand_total['sched2'] < 0 ?
                                "($".number_format($grand_total['sched2'] * -1, 2).")" : "$".number_format($grand_total['sched2'], 2))."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding:40px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">".($grand_total['sched3'] < 0 ?
                                "($".number_format($grand_total['sched3'] * -1, 2).")" : "$".number_format($grand_total['sched3'], 2))."
                            </div>
                        </td>
                    </tr>
            </table>";

            return $tbl;
        } else {
            $report_hash = $this->ajax_vars['report_hash'];
            $this->fetch_report_settings($report_hash);

            array_shift($this->user_name);
            array_shift($this->user_hash);

            $this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
            if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
                unset($report_hash);

            if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
                $this->current_report['customer_filter'] = array($this->current_report['customer_filter']);
            //$tbl = "<pre>".print_r($this->current_report, 1)."</pre>";
            $tbl .= $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
            $this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
            <div class=\"panel\" id=\"report_filter_table\">
                <div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
                    <h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
                        <p id=\"feedback_message".$this->popup_id."\"></p>
                </div>
                <table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
                    <tr>
                        <td style=\"padding:0;\">
                             <div style=\"background-color:#ffffff;height:100%;\">
                                <div style=\"margin:15px 35px;\">
                                    <div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
                                        ".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_ar');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
                                            "&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_ar', 'rm=1');") : NULL)."
                                    </div>
                                    <h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
                                        $this->current_report['report_name'] : "Accounts Receivable Report")."</h3>
                                    <table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">".
                                                $this->form->select("timeframe", array("All invoice dates", "Invoices dated this year", "Invoices dated last year", "Invoices from the current period", "Invoices from the previous period", "A specific date range"), $this->current_report['timeframe'], array('*', 1, 2, 3, 4, 5), "onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
                                                <div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
                                                    <span id=\"sort_from_date_holder\"></span>
                                                    <span id=\"sort_to_date_holder\"></span>";
                                                $jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
                                                $jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
                                                $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">How should the aging<br />schedule be shown?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=age1", "value=".($this->current_report['age1'] ? $this->current_report['age1'] : ACCOUNT_AGING_SCHED1), "size=3", "style=text-align:right;padding-right:5px;")." days
                                                <br />
                                                ".$this->form->text_box("name=age2", "value=".($this->current_report['age2'] ? $this->current_report['age2'] : ACCOUNT_AGING_SCHED2), "size=3", "style=text-align:right;padding-right:5px;")." days
                                                <br />
                                                ".$this->form->text_box("name=age3", "value=".($this->current_report['age3'] ? $this->current_report['age3'] : ACCOUNT_AGING_SCHED3), "size=3", "style=text-align:right;padding-right:5px;")." days
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]", $this->sales_name, (is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')), $this->sales_hash, "multiple", "blank=1", "size=4", "style=width:200px;", ($this->p->ck('proposals', 'S') ? "disabled" : NULL))."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer_vendor",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
                                                if (is_array($this->current_report['customer_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
                                                        $tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Should the report reflect<br />paid or unpaid invoices?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("invoices_paid",
                                                                       array("Show only invoices with an open balance", "Show only invoices with a zero balance"),
                                                                       $this->current_report['invoices_paid'],
                                                                       array(1, 2))."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Display Contact Details?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("contact_detail", array("Hide Customer Contact Detail", "Show Customer Contact Detail"), $this->current_report['contact_detail'], array('1', '2'), "blank=1")."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("showdetail", array("Show Detail View", "Show Simple View"), $this->current_report['showdetail'], array('2', '1'), "blank=1")."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
                                                <div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
                                                    What should the report be called?
                                                    <br />
                                                    ".$this->form->text_box("name=report_name",
                                                                            "value=".$this->current_report['report_name'],
                                                                            "autocomplete=off",
                                                                            "size=30",
                                                                            "style=margin-top:5px;margin-bottom:10px;"
                                                                            )."
                                                    <br />
                                                    Optional description for the report:
                                                    <br />
                                                    ".$this->form->text_area("name=report_descr",
                                                                            "value=".$this->current_report['report_descr'],
                                                                            "rows=3",
                                                                            "cols=50",
                                                                            "style=margin-top:5px;"
                                                                            )."
                                                    <div style=\"padding-top:5px\">
                                                        ".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
                                                        <div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
                                                            Share to the following users:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                            Share to the following groups:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>".
            $this->form->close_form();

            $this->content['popup_controls']["cmdTable"] = $tbl;
            $this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
            $this->content['jscript'] = $jscript;

            return;
        }
    }

	function doit_ar_reconcile() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && $from_saved) {
			$ar_amt = $this->current_report['ar_amt'];
			$payment_req = $this->current_report['payment_req'];
			$customer_filter = $this->current_report['customer_vendor_filter'];
			if ($customer_filter && !is_array($customer_filter))
	            $customer_filter = array($customer_filter);
		} else {
			$ar_amt = $_POST['ar_amt'];
			$payment_req = $_POST['payment_req'];
			$customer_filter = $_POST['customer_vendor_filter'];
			if ($customer_filter && !is_array($customer_filter))
	            $customer_filter = array($customer_filter);
		}
		$save = $_POST['save'];
		$saved_cat = "ar_reconcile";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if (!$ar_amt || $ar_amt <= 0 || strspn($ar_amt, "0123456789.") != strlen($ar_amt)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "Please enter a minimum reconciliation amount in order to continue. This amount must be greater than zero.";
		}
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($this->content['error'])
			return;

		if (is_array($customer_filter) && count($customer_filter)) {
			array_walk($customer_filter, 'add_quotes', "'");
			$sql_p[] = "customer_invoice.customer_hash IN (".implode(" , ", $customer_filter).")";
			array_walk($customer_filter, 'strip_quotes');
		}
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$str = "ar_amt=$ar_amt|customer_filter=".@implode("&", $customer_filter)."|payment_req=$payment_req";

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT customer_invoice.invoice_no , customer_invoice.invoice_no , customer_invoice.invoice_hash ,
									customer_invoice.amount , customer_invoice.balance ,
									COUNT(customer_payment.payment_hash) AS total_payment ,
									customer_invoice.invoice_date ,
								    CASE
								    WHEN ISNULL(customers.customer_name)
									  	THEN vendors.vendor_name
									  	ELSE 0
								   	END AS vendor_name , customers.payment_terms , customer_invoice.customer_hash , vendors.vendor_name , customers.customer_name
									FROM customer_invoice
									LEFT JOIN customer_payment ON customer_payment.invoice_hash = customer_invoice.invoice_hash AND customer_payment.deleted = 0
									LEFT JOIN customers ON customers.customer_hash = customer_invoice.customer_hash
									LEFT JOIN vendors ON vendors.vendor_hash = customer_invoice.customer_hash
									WHERE ".($sql ?
    									$sql." AND " : NULL)."customer_invoice.type = 'I' AND customer_invoice.deleted = 0 AND
									customer_invoice.balance != 0 AND ".($payment_req ?
									    "customer_invoice.balance != customer_invoice.amount AND " : NULL).
									"customer_invoice.balance <= '$ar_amt'
									GROUP BY customer_invoice.invoice_hash".($payment_req ? "
									HAVING total_payment > 0" : NULL));
		while ($row = $this->db->fetch_assoc($result)) {
			$results[$row['customer_hash']][] = $row;
			$sort_list[$row['customer_hash']] = ($row['customer_name'] ? stripslashes($row['customer_name']) : stripslashes($row['vendor_name']));
		}
		if (is_array($sort_list)) {
			asort($sort_list);
			while (list($customer_hash, $detail) = each($sort_list))
				$this->results[$customer_hash] = $results[$customer_hash];
		}


		$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->ar_reconcile(1);
		$this->content['jscript'][] = "setTimeout('DateInput(\'reconcile_date\', \'true\', \'YYYY-MM-DD\', \'".date("Y-m-d")."\', 1, \'reconcile_date_holder\', \'&nbsp;&nbsp;Date:\')', 1000);";
		return;

	}

	function doit_ar_exec_reconcile() {

		$invoice_reconcile = $_POST['invoice_reconcile'];
		$reconcile_acct = $_POST['reconcile_acct'];
		$reconcile_acct_hash = $_POST['reconcile_acct_hash'];
		$reconcile_date = $_POST['reconcile_date'];
		list($year, $month, $day) = explode("-", $reconcile_date);

		$submit_btn = 'reconcile_btn';
		if ( ! checkdate($month, $day, $year) )
			return $this->__trigger_error("The date you entered is invalid. Please make sure you enter a valid date.", E_USER_NOTICE, __FILE__, __LINE__, 1, false, $submit_btn);

		for ( $i = 0; $i < count($invoice_reconcile); $i++ ) {

			if ( $invoice_reconcile[$i] )
				$invoice[] = $invoice_reconcile[$i];
		}

		if ( ! $reconcile_acct || ( $reconcile_acct && !$reconcile_acct_hash ) ) {

			$this->set_error('error_acct');
			return $this->__trigger_error( ( ! $reconcile_acct ? "Please enter the account that you wish to reconcile your outstanding invoices into." : "We can't seem to find the account you selected below. Please make sure you are selecting a valid account from the list displayed." ) , E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);
		}

		if ( $invoice ) {

			$customer_invoice = new customer_invoice($this->current_hash);
			$accounting = new accounting($this->current_hash);

			if ( ! $accounting->fetch_account_record($reconcile_acct_hash) )
                return $this->__trigger_error("System error encountered when attempting to lookup chart of account record. Please reload window and try again. <!-- Tried fetching account [ $reconcile_acct_hash ] -->", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

            if ( $accounting->current_account['account_action'] == 'CR' )
                $credit_account = true;

			for ( $i = 0; $i < count($invoice); $i++ ) {

                if ( ! $this->db->start_transaction() )
                    return $this->__trigger_error("{$this->db->db_errno} - {$this->db->db_error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

				if ( ! $customer_invoice->fetch_invoice_record($invoice[$i]) )
				    return $this->__trigger_error("System error encountered when attempting to lookup invoice record. Please reload window and try again. <!-- Tried fetching invoice [ {$invoice[$i]} ] -->", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

				$payment_hash = rand_hash('customer_payment', 'payment_hash');

				if ( ! $this->db->query("INSERT INTO customer_payment
        								(
	        								timestamp,
	        								last_change,
	        								payment_hash,
	        								invoice_hash,
	        								receipt_amount,
	        								applied_from,
	        								reconciled,
	        								receipt_date,
	        								receipt_type,
	        								comments
        								)
        								VALUES
        								(
	        								UNIX_TIMESTAMP(),
	        								'{$this->current_hash}',
	        								'$payment_hash',
	        								'{$customer_invoice->invoice_hash}',
	        								'{$customer_invoice->current_invoice['balance']}', " .
	        								( $reconcile_acct_hash ?
    	        								"'$reconcile_acct_hash'" : "NULL"
    	        							) . ",
	        								1,
	        								'$reconcile_date',
	        								'RC',
	        								'Reconciled and closed [" . date(DATE_FORMAT) . "]'
        								)")
                ) {

                	return $this->__trigger_error("{$this->db->db_errno} - {$this->db->db_error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);
                }

				if ( ! $this->db->query("UPDATE customer_invoice t1
        								 SET
            								 t1.timestamp = UNIX_TIMESTAMP(),
            								 t1.last_change = '{$this->current_hash}',
            								 t1.reconciled = 1,
            								 t1.paid_in_full = 1,
            								 t1.balance = 0
        								 WHERE t1.invoice_hash = '{$customer_invoice->invoice_hash}'")
                ) {

                	return $this->__trigger_error("{$this->db->db_errno} - {$this->db->db_error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);
                }

                $accounting->start_transaction( array(
					'ar_payment_hash'  =>  $payment_hash,
					'ar_invoice_hash'  =>  $customer_invoice->invoice_hash,
					'customer_hash'    =>  $customer_invoice->current_invoice['customer_hash'],
					'proposal_hash'    =>  $customer_invoice->current_invoice['proposal_hash']
                ) );

                $audit_id = $accounting->audit_id();

				if ( ! $accounting->exec_trans($audit_id, $reconcile_date, DEFAULT_AR_ACCT, bcmul($customer_invoice->current_invoice['balance'], -1, 2), 'AD', "Auto Reconciliation - Invoice {$customer_invoice->current_invoice['invoice_no']}") )
				    return $this->__trigger_error("{$accounting->err['errno']} - {$accounting->err['err']}", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

				$reconcile_amt = $customer_invoice->current_invoice['balance'];
				if ( $credit_account )
				    $reconcile_amt = bcmul($reconcile_amt, -1, 2);

				if ( ! $accounting->exec_trans($audit_id, $reconcile_date, $reconcile_acct_hash, $reconcile_amt, 'AD', "Auto Reconciliation - Invoice {$customer_invoice->current_invoice['invoice_no']}") )
				    return $this->__trigger_error("{$accounting->err['errno']} - {$accounting->err['err']}", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

                if ( ! $accounting->end_transaction() )
                    return $this->__trigger_error("{$accounting->err['errno']} - {$accounting->err['err']}", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

                $this->db->end_transaction();
			}

			$this->content['page_feedback'] = "Outstanding invoices have been reconciled and closed.";
			$this->content['action'] = 'continue';
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";

		} else {

			$this->content['page_feedback'] = "Nothing selected. No changes have been made.";
			$this->content['action'] = 'continue';
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
		}

		return;
	}

	function ar_reconcile($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$acct = new accounting($this->current_hash);
			if (defined('AUTO_WIP_CLEARING_ACCT'))
				$acct->fetch_account_record(AUTO_WIP_CLEARING_ACCT);

			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<div id=\"feedback_holder\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
				<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
					<p id=\"feedback_message\"></p>
			</div>
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px 10px 0 10px;\" colspan=\"6\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Accounts Receivable Reconciliation Report").($this->p->ck('reports', 'V', 'ar_reconcile') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'ar_reconcile', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						</div>
						<div style=\"float:right;margin-bottom:0;margin-top:0;font-weight:normal;\">
							<table>
								<tr>
									<td>
										<span id=\"error_acct\">Reconciliation Account: </span>
										".$this->form->text_box("name=reconcile_acct",
																"value=".($acct->account_hash ? ($acct->current_account['account_no'] ? $acct->current_account['account_no']." - " : NULL).$acct->current_account['account_name'] : NULL),
																"autocomplete=off",
																"onBlur=key_clear();",
																"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('payables', 'reconcile_acct', 'reconcile_acct_hash', 1);}",
                                                                "onKeyUp=if(ka==false && this.value){key_call('payables', 'reconcile_acct', 'reconcile_acct_hash', 1);}",
																"onKeyDown=clear_values('reconcile_acct_hash');").
										$this->form->hidden(array("reconcile_acct_hash" => ($acct->account_hash ? $acct->account_hash : '')))."
										<a href=\"javascript:void(0);\" onClick=\"position_element(\$('keyResults'), findPos(\$('reconcile_acct'), 'top')+20, findPos(\$('reconcile_acct'), 'left')+1);key_list('payables', 'reconcile_acct', 'reconcile_acct_hash', '*');\"><img src=\"images/arrow_down.gif\" border=\"0\" alt=\"Show all accounts\" /></a>
									</td>
									<td style=\"padding-right:15px;\" id=\"reconcile_date_holder\"></td>
								</tr>
							</table>
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:200px;text-align:left;padding-left:25px;\">Invoice No.</td>
					<td style=\"width:150px;padding:5px;\">Invoice Date</td>
					<td style=\"width:150px;padding:5px;\">Due Date</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Net Invoiced</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Received</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Balance</td>
				</tr>";
			if (is_array($this->results)) {
				$k = 0;
				while (list($customer_hash, $invoice_array) = each($this->results)) {
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" colspan=\"6\">".($invoice_array[0]['customer_name'] ? stripslashes($invoice_array[0]['customer_name']) : stripslashes($invoice_array[0]['vendor_name']))."</td>
					</tr>";
					for ($i = 0; $i < count($invoice_array); $i++) {
						$tbl .= "
						<tr>
							<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\">
								".$this->form->checkbox("name=invoice_reconcile[]", "value=".$invoice_array[$i]['invoice_hash'], "checked")."&nbsp;
								<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$invoice_array[$i]['invoice_hash']."', 'proposal_hash=$proposal_hash', 'popup_id=line_item');\" class=\"link_standard\">Invoice ".$invoice_array[$i]['invoice_no']."</a>
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($invoice_array[$i]['invoice_date']))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($invoice_array[$i]['invoice_date']." +".($invoice_array[$i]['payment_terms'] ? $invoice_array[$i]['payment_terms'] : DEFAULT_CUST_PAY_TERMS)." days"))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['amount'], 2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['amount'] - $invoice_array[$i]['balance'], 2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_array[$i]['balance'] < 0 ?
								"($".number_format($invoice_array[$i]['balance'] * -1, 2).")" : "$".number_format($invoice_array[$i]['balance'], 2))."</td>
						</tr>";
					}
				}
				$tbl .= "
				<tr>
					<td colspan=\"6\" style=\"background-color:#ffffff;padding:25px 10px 10px 10px;text-align:right;\">
						".$this->form->button("value=Perform Reconciliation",
                    						  "id=reconcile_btn",
                    						  "onClick=if(confirm('Are you sure you want to reconcile the outstanding invoices selected above? This action will close those outstanding balances mark the invoices as paid in full.')){submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_ar_exec_reconcile');this.disabled=1}")."
					</td>
				</tr>";
			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"6\">There are no results to show.</td>
				</tr>";

			$tbl .= "
			</table>";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

            if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
                $this->current_report['customer_filter'] = array($this->current_report['customer_filter']);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_ar_reconcile');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_ar_reconcile', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Accounts Receivable Reconciliation")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">What is the maximum outstanding<br />A/R amount to reconcile?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->text_box("name=ar_amt", "value=".(defined('AUTO_WIP_MIN_AMT') ? AUTO_WIP_MIN_AMT : $this->current_report['ar_amt']), "size=10", "style=text-align:right;", "onBlur=if(this.value){formatCurrency(this.value)}")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer_vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
														$tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Require at least 1 payment<br />against invoice in order to reconcile?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->checkbox("name=payment_req", "value=1", ($this->current_report['payment_req'] || !$this->current_report ? "checked" : NULL))."</td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_ap_reconcile() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && $from_saved) {
			$ap_amt = $this->current_report['ap_amt'];
			$vendor_filter = $this->current_report['vendor_filter'];
		} else {
			$ap_amt = $_POST['ap_amt'];
			$vendor_filter = $_POST['vendor_filter'];
		}

		$save = $_POST['save'];
		$saved_cat = "ap_reconcile";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if (!$ap_amt || $ap_amt <= 0 || strspn($ap_amt, "0123456789.") != strlen($ap_amt)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "Please enter a minimum reconciliation amount in order to continue. This amount must be greater than zero.";
		}
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($this->content['error'])
			return;

		if (is_array($vendor_filter) && count($vendor_filter)) {
			array_walk($vendor_filter, 'add_quotes', "'");
			$sql_p[] = "proposals.sales_hash IN (".implode(" , ", $sales_rep_match).")";
			array_walk($vendor_filter, 'strip_quotes');
		}
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$str = "ap_amt=$ap_amt|vendor_filter=".@implode("&", $vendor_filter);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;



		$result = $this->db->query("SELECT vendor_payables.invoice_no , vendor_payables.invoice_no , vendor_payables.invoice_hash ,
									vendor_payables.amount , vendor_payables.balance , COUNT(vendor_payment.payment_hash) AS total_payment ,
									vendor_payables.invoice_date , vendor_payables.due_date , vendor_payables.vendor_hash , vendors.vendor_name
									FROM vendor_payables
									LEFT JOIN vendor_payment ON vendor_payment.invoice_hash = vendor_payables.invoice_hash
									LEFT JOIN vendors ON vendors.vendor_hash = vendor_payables.vendor_hash
									WHERE vendor_payables.type = 'I' AND vendor_payables.balance != 0 AND vendor_payables.amount != vendor_payables.balance AND vendor_payables.deleted = 0 AND vendor_payables.balance <= '$ap_amt'
									GROUP BY vendor_payables.invoice_hash
									HAVING total_payment > 0");
		while ($row = $this->db->fetch_assoc($result)) {
			$results[$row['vendor_hash']][] = $row;
			$sort_list[$row['vendor_hash']] = $row['vendor_name'];
		}
		if (is_array($sort_list)) {
			asort($sort_list);
			while (list($vendor_hash, $detail) = each($sort_list))
				$this->results[$vendor_hash] = $results[$vendor_hash];
		}


		$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->ap_reconcile(1);
		return;

	}

	function ap_reconcile($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"6\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Accounts Payable Reconciliation").($this->p->ck('reports', 'V', 'ap') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'ap_reconcile', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:200px;text-align:left;padding-left:25px;\">Invoice No.</td>
					<td style=\"width:150px;padding:5px;\">Invoice Date</td>
					<td style=\"width:150px;padding:5px;\">Due Date</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Net Invoiced</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Amount Paid</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Balance</td>
				</tr>";
			if (is_array($this->results)) {
				$k = 0;
				while (list($customer_hash, $invoice_array) = each($this->results)) {
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" colspan=\"6\">".($invoice_array[0]['customer_name'] ? stripslashes($invoice_array[0]['customer_name']) : stripslashes($invoice_array[0]['vendor_name']))."</td>
					</tr>";
					for ($i = 0; $i < count($invoice_array); $i++) {
						$tbl .= "
						<tr>
							<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$invoice_array[$i]['invoice_hash']."', 'popup_id=line_item');\" class=\"link_standard\">Invoice ".$invoice_array[$i]['invoice_no']."</a></td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($invoice_array[$i]['invoice_date']))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($invoice_array[$i]['due_date']))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['amount'], 2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['amount'] - $invoice_array[$i]['balance'], 2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;".($invoice_array[$i]['amount'] - $invoice_array[$i]['balance'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($invoice_array[$i]['balance'] < 0 ?
								"($".number_format($invoice_array[$i]['balance'] * -1, 2).")" : "$".number_format($invoice_array[$i]['balance'], 2))."</td>
						</tr>";
					}
				}

			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"6\">There are no results to show.</td>
				</tr>";

			$tbl .= "
			</table>";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_ap_reconcile');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_ap_reconcile', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Accounts Payable Reconciliation")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">What is the minimum outstanding<br />A/P amount to reconcile?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->text_box("name=ap_amt", "value=".(defined('AUTO_WIP_MIN_AMT') ? AUTO_WIP_MIN_AMT : $this->current_report['ap_amt']), "size=10", "style=text-align:right;", "onBlur=if(this.value){formatCurrency(this.value)}")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".($this->current_report['vendor_filter'] ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_wip_reconcile() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		if ($_POST['report_hash'] && $_POST['from_exec']) {
			$from_exec = 1;
            $report_hash = $_POST['report_hash'];
		} else {
			$report_hash = $_POST['report_hash'];
			$from_saved = $this->ajax_vars['from_saved'];
        }
		if ($report_hash && ($from_shared || $from_exec)) {
			$this->fetch_report_settings($report_hash);

			$timeframe = $this->current_report['timeframe'];
			$wip_amt = $this->current_report['wip_amt'];
			$vendor_filter = $this->current_report['vendor_filter'];
			$proposal_filter = $this->current_report['proposal_filter'];
		} else {
			$timeframe = $_POST['timeframe'];
			$wip_amt = $_POST['wip_amt'];
			$vendor_filter = $_POST['vendor_filter'];
			$proposal_filter = $_POST['proposal_filter'];
		}

		$save = $_POST['save'];
		$saved_cat = "wip_reconcile";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);

        # Validate user input
        switch ($timeframe) {
        	# This year
            case 1:
            $sql_1 = "invoice_date BETWEEN '" . date('Y') . "' AND '" . date('Y') . "-12-31'";
            $this->report_title = " dated this year, ".date("Y");
            break;

            # Last year
            case 2:
            $sql_1 = "invoice_date BETWEEN '" . date('Y', strtotime(date('Y-m-d') . ' -1 year')) . "-01-01' AND '" . date('Y', strtotime(date('Y-m-d') . ' -1 year')) . "-12-31'";
            $this->report_title = " dated last year, ".date("Y", strtotime(date("Y-m-d")." -1 year"));
            break;

            # Current period
            case 3:
            $period_info = get_period_info(date("Y-m-d"));
            if ($period_info['period_start']) {
                $sql_1 = "invoice_date BETWEEN '{$period_info['period_start']}' AND '{$period_info['period_end']}'";
                $this->report_title = " dated within the current period, between " . date(DATE_FORMAT, strtotime($period_info['period_start'])) . " and " . date(DATE_FORMAT, strtotime($period_info['period_end']));
            } else {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
                return;
            }
            break;

            # Prev period
            case 4:
            $period_info = get_previous_period(date("Y-m-d"));
            if ($period_info['period_start']) {
                $sql_1 = "invoice_date BETWEEN '{$period_info['period_start']}' AND '{$period_info['period_end']}'";
                $this->report_title = " dated last period, between " . date(DATE_FORMAT, strtotime($period_info['period_start'])) . " and " . date(DATE_FORMAT, strtotime($period_info['period_end']));
            } else {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
                return;
            }
            break;

            # Date range
            case 5:
            $sort_from_date = $_POST['sort_from_date'];
            $sort_to_date = $_POST['sort_to_date'];

            if ( $sort_from_date && $sort_to_date && strtotime( $sort_to_date ) >= strtotime( $sort_from_date ) ) {
                $sql_1 = "invoice_date BETWEEN '$sort_from_date' AND '$sort_to_date'";
                $this->report_title = " dated between ".date(DATE_FORMAT, strtotime($sort_from_date))." and ".date(DATE_FORMAT, strtotime($sort_to_date));
            } elseif ( $sort_from_date ) {
                $sql_1 = "invoice_date >= '$sort_from_date'";
                $this->report_title = " dated on or after ".date(DATE_FORMAT, strtotime($sort_from_date));
                unset($sort_to_date);
            } elseif ( $sort_to_date ) {
                $sql_1 = "invoice_date <= '$sort_to_date'";
                $this->report_title = " dated on or before ".date(DATE_FORMAT, strtotime($sort_to_date));
                unset($sort_from_date);
            } else
                unset($timeframe, $sort_from_date, $sort_to_date);

            break;

            //This Month
            case 6:
            $sql_1 = "invoice_date BETWEEN '" . date("Y-m-01") . "' AND '" . date("Y-m-t") . "'";
            $this->report_title = " dated month ending ".date(DATE_FORMAT, strtotime(date("Y-m-t")));
            break;

            //Last Month
            case 7:
            $sql_1 = "invoice_date BETWEEN '" . date("Y-m-01", strtotime( date("Y-m-d") . " -1 month") ) . "' AND '" . date("Y-m-t", strtotime( date("Y-m-d") . " -1 month") ) . "'";
            $this->report_title = " dated month ending " . date(DATE_FORMAT, strtotime( date("Y-m-t", strtotime( date("Y-m-d") . " -1 month") ) ) );
            break;

            default:
                $this->report_title = " dated as of " . date(DATE_FORMAT);
        }

		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($this->content['error'])
			return;

		if ($vendor_filter && !is_array($vendor_filter))
            $vendor_filter = array($vendor_filter);

		if (is_array($vendor_filter) && count($vendor_filter)) {
			array_walk($vendor_filter, 'add_quotes', "'");
			$sql_p[] = "t1.vendor_hash IN (".implode(" , ", $vendor_filter).")";
			array_walk($vendor_filter, 'strip_quotes');
		}

		if ($proposal_filter && !is_array($proposal_filter))
            $proposal_filter = array($proposal_filter);

        if (is_array($proposal_filter) && count($proposal_filter)) {
            array_walk($proposal_filter, 'add_quotes', "'");
            $sql_p[] = "t4.proposal_hash IN (".implode(" , ", $proposal_filter).")";
            array_walk($proposal_filter, 'strip_quotes');
        }

		if ( $sql_p )
			$sql = implode(" AND ", $sql_p);

		$str = "wip_amt=$wip_amt|vendor_filter=".@implode("&", $vendor_filter)."|proposal_filter=".@implode("&", $proposal_filter)."|timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|wip_account=";

		if (!$report_hash) {



			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$default_wip_account = fetch_sys_var('DEFAULT_WIP_ACCT');
		$this->report_hash = $report_hash;

		$this->db_obj->query("CREATE TEMPORARY TABLE _tmp_wip_reconcile
                              SELECT t1.po_hash, t1.proposal_hash, IFNULL(t2.reconciled, 0) AS Reconciled,
							  IFNULL(t3.WIP_Debits, 0) AS WIP_Debits, IFNULL( t4.Wip_Credits, 0) AS WIP_Credits
							  FROM purchase_order t1
                              LEFT JOIN (
                                  SELECT po_hash, SUM( amount ) AS reconciled
                                  FROM purchase_order_reconcile " .
                                  ( $sql_1 ?
                                      "WHERE " . str_replace('invoice_date', 'date', $sql_1) : NULL
                                  ) . "
                                  GROUP BY po_hash ) t2 ON t2.po_hash = t1.po_hash
							  LEFT JOIN (
							      SELECT t3_1.po_hash,
							      ROUND( SUM(
							          CASE
							          WHEN t3_1.type = 'C' THEN
    							          ( t3_2.amount * -1 )
							          WHEN t3_1.type = 'D' THEN
							              ( t3_2.amount - ( t3_1.amount - t3_1.balance ) ) ELSE
  							              ( t3_2.amount )
							          END
							      ), 2) AS WIP_Debits
							      FROM vendor_payables t3_1
							      RIGHT JOIN vendor_payable_expenses t3_2 ON t3_2.invoice_hash = t3_1.invoice_hash AND t3_2.account_hash = '$default_wip_account'
							      WHERE " .
							      ( $sql_1 ?
							          "$sql_1 AND " : NULL
							      ) . "t3_1.deleted = 0
							      GROUP BY t3_1.po_hash ) t3 ON t3.po_hash = t1.po_hash
							  LEFT JOIN (
							      SELECT t4_2.po_hash, ROUND( SUM( t4_2.cost * t4_2.qty ), 2) AS Wip_Credits
							      FROM customer_invoice t4_1
							      RIGHT JOIN line_items t4_2 ON t4_2.invoice_hash = t4_1.invoice_hash AND t4_2.wip_account_hash = '$default_wip_account' AND t4_2.invoice_hash != '' AND t4_2.direct_bill_amt != 'C'
							      WHERE " .
							      ( $sql_1 ?
							          "$sql_1 AND " : NULL
							      ) . "t4_1.deleted = 0
 							      GROUP BY t4_2.po_hash ) t4 ON t4.po_hash = t1.po_hash
							  WHERE " .
							  ( $sql ?
							      "$sql AND " : NULL
							  ) . "t1.deleted = 0
							  GROUP BY t1.po_hash
							  HAVING ( ( WIP_Debits + Reconciled ) - WIP_Credits ) != 0 " .
                              ( $wip_amt && bccomp($wip_amt, 0, 2) ?
                                  "AND ( ( WIP_Debits + Reconciled ) - WIP_Credits ) BETWEEN '" . bcmul($wip_amt, -1, 2) . "' AND '$wip_amt'" : NULL
                              ) );

        $this->db_obj->query("CREATE INDEX proposal_hash ON _tmp_wip_reconcile ( proposal_hash(32) )");

		$this->content['action'] = ($from_exec ? 'continue' : 'close');

		$this->content['html']['place_holder'] = $this->wip_reconcile(1);
		$this->content['jscript'][] = "setTimeout('DateInput(\'reconcile_date\', \'true\', \'YYYY-MM-DD\', \'".date("Y-m-d")."\', 1, \'reconcile_date_holder\', \'&nbsp;&nbsp;Date:\')', 50);";

		return;
	}

	function doit_wip_exec_reconcile() {

		$wip_po = $_POST['wip_po'];
		$reconcile_acct = $_POST['wip_clearing_acct'];
		$reconcile_acct_hash = $_POST['wip_clearing_acct_hash'];
		$reconcile_date = $_POST['reconcile_date'];
		$default_wip_account = $_POST['wip_account'];
		$balance = $_POST['balance'];

		$submit_btn = 'reconcile_btn';

		list($year, $month, $day) = explode("-", $reconcile_date);
		if ( ! checkdate($month, $day, $year) )
            return $this->__trigger_error("The date you entered is not a valid date. Please check your input and enter a valid posting date.", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

		if ( ! $reconcile_acct || ( $reconcile_acct && ! $reconcile_acct_hash ) ) {

			$this->set_error('error_acct');
			return $this->__trigger_error( ( ! $reconcile_acct ? "Please enter the account that you wish to reconcile your outstanding invoices into." : "We can't seem to find the account you selected below. Please make sure you are selecting a valid account from the list displayed." ), E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);
		}

		$accounting = new accounting($this->current_hash);

        if ( $accounting->period_ck($reconcile_date) )
            return $this->__trigger_error($accounting->closed_err, E_USER_NOTICE, __FILE__, __LINE__, 1, false, $submit_btn);

        if ( ! $accounting->fetch_account_record($reconcile_acct_hash) )
            return $this->__trigger_error("System error encountered when attempting to lookup chart of account record. Please reload window and try again. <!-- Tried fetching account [ $reconcile_acct_hash ] -->", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

        $exp_account_action = $accounting->current_account['account_action'];

        if ( ! $this->db->start_transaction() )
            return $this->__trigger_error("{$this->db->db_errno} - {$this->db->db_error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

		for ( $i = 0; $i < count( $wip_po ); $i++ ) {

			$po_hash = $wip_po[$i];
			if ( ! bccomp($balance[ $po_hash ], 0, 2) )
                continue;

			$amount = $db_amount = bcmul($balance[ $po_hash ], -1, 2);

	        $result = $this->db->query("SELECT t1.po_no, t1.vendor_hash, t1.proposal_hash
                                        FROM purchase_order t1
                                        WHERE t1.po_hash = '$po_hash' AND t1.deleted = 0
                                        GROUP BY t1.po_hash");
			if ( $row = $this->db->fetch_assoc($result) ) {

                $vendor_hash = $row['vendor_hash'];
                $proposal_hash = $row['proposal_hash'];
                $po_no = $row['po_no'];

	            $accounting->start_transaction( array(
    	            'vendor_hash'      =>  $vendor_hash,
    	            'proposal_hash'    =>  $proposal_hash
                ) );

                $audit_id = $accounting->audit_id();

	            if ( ! $accounting->exec_trans($audit_id, $reconcile_date, $default_wip_account, $amount, 'AD', "WIP Auto Reconciliation - PO $po_no.") )
	                return $this->__trigger_error("{$accounting->err['errno']} - {$accounting->err['err']}", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

                if ( $exp_account_action == 'DR' )
                    $amount = bcmul($amount, -1, 2);

	            if ( ! $accounting->exec_trans($audit_id, $reconcile_date, $reconcile_acct_hash, $amount, 'AD', "WIP Auto Reconciliation - PO $po_no.") )
	                return $this->__trigger_error("{$accounting->err['errno']} - {$accounting->err['err']}", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

	            if ( ! $accounting->end_transaction() )
                    return $this->__trigger_error("{$accounting->err['errno']} - {$accounting->err['err']}", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);

                $hash_key = rand_hash('purchase_order_reconcile', 'obj_hash');
                if ( ! $this->db->query("INSERT INTO purchase_order_reconcile
                                         VALUES
                                         (
	                                         '$hash_key',
	                                         UNIX_TIMESTAMP(),
	                                         '{$this->current_hash}',
	                                         '$po_hash',
	                                         '$reconcile_acct_hash',
	                                         '$reconcile_date',
	                                         '$db_amount'
                                         )")
                ) {

                	return $this->__trigger_error("{$this->db->db_errno} - {$this->db->db_error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);
                }

	            $update = true;

			} else
                return $this->__trigger_error("An error occurred when trying to fetch one or more purchase orders for reconciliation. Please refresh your report and try again.", E_USER_ERROR, __FILE__, __LINE__, 1, false, $submit_btn);
		}

        $this->db->end_transaction();

        $this->content['action'] = 'continue';
		if ( $update ) {

			$this->content['page_feedback'] = "Outstanding WIP balances have been reconciled and posted. The report is being updated to reflect the changes.";
			$this->content['jscript_action'] = "submit_form(\$('test').form, 'reports', 'exec_post', 'refresh_form', 'action=doit_wip_reconcile', 'from_exec=1');";

			return;
		}

        $this->content['page_feedback'] = "No PO balances were selected, therefore no changes have been made.";
    	$this->content['submit_btn'] = "reconcile_btn";
	}

	function wip_reconcile($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$acct = new accounting($this->current_hash);
			if (defined('AUTO_WIP_CLEARING_ACCT'))
				$acct->fetch_account_record(AUTO_WIP_CLEARING_ACCT);

            // Trac #1372 - WIP account types limited to P&L accounts
            if ( ! in_array($acct->current_account['account_type'], array('IN', 'EX', 'CG')) )
                unset($acct->account_hash, $acct->current_account);

			$this->fetch_report_settings($this->report_hash);
            $default_wip_account = fetch_sys_var('DEFAULT_WIP_ACCT');

			$tbl =
			$this->form->form_tag() .
			$this->form->hidden( array(
    			'test'           => 1,
    			'report_hash'    =>  $this->report_hash,
    			'wip_amt'        =>  $this->current_report['wip_amt'],
			    'wip_account'    =>  $default_wip_account
			) ) . "
            <div id=\"feedback_holder\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
                <h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
                    <p id=\"feedback_message\"></p>
            </div>
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:895px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"7\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "WIP Reconciliation Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'wip_reconcile', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						<div style=\"float:right;margin-bottom:0;margin-top:0;font-weight:normal;\">
							<table>
								<tr>
									<td>
										<span id=\"error_acct\">Reconciliation Account: </span>
										".$this->form->text_box("name=wip_clearing_acct",
																"value=".($acct->account_hash ? ($acct->current_account['account_no'] ? $acct->current_account['account_no']." - " : NULL).$acct->current_account['account_name'] : NULL),
																"autocomplete=off",
																"onBlur=key_clear();",
																"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('payables', 'wip_clearing_acct', 'wip_clearing_acct_hash', 1);}",
                                                                "onKeyUp=if(ka==false && this.value){key_call('payables', 'wip_clearing_acct', 'wip_clearing_acct_hash', 1);}",
																"onKeyDown=clear_values('wip_clearing_acct_hash');").
										$this->form->hidden(array("wip_clearing_acct_hash" => ($acct->account_hash ? $acct->account_hash : '')))."
										<a href=\"javascript:void(0);\" onClick=\"position_element(\$('keyResults'), findPos(\$('wip_clearing_acct'), 'top')+20, findPos(\$('wip_clearing_acct'), 'left')+1);key_list('payables', 'wip_clearing_acct', 'wip_clearing_acct_hash', '*');\"><img src=\"images/arrow_down.gif\" border=\"0\" alt=\"Show all accounts\" /></a>
									</td>
									<td style=\"padding-right:15px;\" id=\"reconcile_date_holder\"></td>
								</tr>
							</table>
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
                    <td style=\"width:125px;text-align:left;padding-left:25px;\">
                        ".$this->form->checkbox("name=check_all",
										        "value=1",
                                                "onClick=checkall(document.getElementsByName('wip_po[]'), this.checked);")."
                        &nbsp;
                        PO No.
                    </td>
                    <td style=\"width:150px;text-align:left;\">Vendor</td>
					<td style=\"width:100px;text-align:left;\">Last Entry</td>
					<td style=\"width:125px;text-align:right;\">WIP Debits</td>
					<td style=\"width:125px;text-align:right;\">WIP Credits</td>
					<td style=\"width:125px;text-align:right;\">Reconciled</td>
					<td style=\"width:125px;text-align:right;\">Balance</td>
				</tr>";

            $m = $total_dr = $total_cr = $total_bal = $total_rec = 0;
            $r = $this->db_obj->query("SELECT t1.proposal_hash, COUNT( t1.po_hash ) AS cnt, t2.proposal_no, t2.proposal_descr, t3.customer_name
                                       FROM _tmp_wip_reconcile t1
                                       LEFT JOIN proposals t2 ON t2.proposal_hash = t1.proposal_hash
                                       LEFT JOIN customers t3 ON t3.customer_hash = t2.customer_hash
                                       GROUP BY t1.proposal_hash
                                       ORDER BY t2.proposal_no ASC");
            while ( $row = $this->db_obj->fetch_assoc($r) ) {

                $m++;
                $tbl .= "
                <tr style=\"background-color:#efefef;\">
                    <td colspan=\"7\" style=\"padding-left:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;padding-top:10px;padding-bottom:5px;\">
                        Proposal: <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash={$row['proposal_hash']}', 'popup_id=proposal_win', 'from_report=1')\">{$row['proposal_no']}</a> -
                        {$row['customer_name']} - {$row['proposal_descr']}
                    </td>
                </tr>";

                $l = 0;
                $res_2 = $this->db_obj->query("SELECT t1.po_hash, t1.WIP_Debits, t1.WIP_Credits, t1.Reconciled, t2.po_no, t2.po_date, t3.vendor_name
                                               FROM _tmp_wip_reconcile t1
                                               LEFT JOIN purchase_order t2 ON t2.po_hash = t1.po_hash
                                               LEFT JOIN vendors t3 ON t3.vendor_hash = t2.vendor_hash
                                               WHERE t1.proposal_hash = '{$row['proposal_hash']}'
                                               ORDER BY t2.po_no ASC");
                while ( $row_2 = $this->db_obj->fetch_assoc( $res_2 ) ) {

                    unset($last_entry);
                    if ( $row_2['po_hash'] ) {
                        $res_3 = $this->db->query("SELECT DISTINCT t1.invoice_date
                                                   FROM vendor_payables t1
                                                   RIGHT JOIN vendor_payable_expenses t2 ON t2.invoice_hash = t1.invoice_hash AND t2.account_hash = '$default_wip_account'
                                                   WHERE t1.po_hash = '{$row_2['po_hash']}' AND t1.deleted = 0
                                                   UNION ALL
                                                   SELECT DISTINCT t1.invoice_date
                                                   FROM customer_invoice AS t1
                                                   RIGHT JOIN line_items t2 ON t2.invoice_hash = t1.invoice_hash AND t2.wip_account_hash = '$default_wip_account' AND t2.direct_bill_amt != 'C'
                                                   WHERE t2.po_hash = '{$row_2['po_hash']}' AND t1.deleted = 0
                                                   UNION ALL
                                                   SELECT DISTINCT t1.date AS invoice_date
												   FROM purchase_order_reconcile t1
												   WHERE t1.po_hash = '{$row_2['po_hash']}'
                                                   ORDER BY invoice_date DESC
                                                   LIMIT 1");
                        if ( $row_3 = $this->db->fetch_assoc( $res_3 ) )
                            $last_entry = $row_3['invoice_date'];

                    }

                    $balance = bcsub(bcadd($row_2['WIP_Debits'], $row_2['Reconciled'], 2), $row_2['WIP_Credits'], 2);

                    $total_dr = bcadd($total_dr, $row_2['WIP_Debits'], 2);
                    $total_cr = bcadd($total_cr, $row_2['WIP_Credits'], 2);
                    $total_rec  = bcadd($total_rec, $row_2['Reconciled'], 2);
                    $total_bal = bcadd($total_bal, $balance, 2);

                    $tbl .= "
                    <tr style=\"background-color:#ffffff\">
                        <td style=\"padding-left:25px;$padding\">".
                            $this->form->checkbox("name=wip_po[]",
                                                  "value={$row_2['po_hash']}") .
                            $this->form->hidden( array( "balance[{$row_2['po_hash']}]" => $balance ) ) . "
                            &nbsp;
                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('purchase_order', 'sf_loadcontent', 'show_popup_window', 'edit_po', 'po_hash={$row_2['po_hash']}', 'proposal_hash={$row['proposal_hash']}', 'popup_id=line_item')\">{$row_2['po_no']}</a>
                        </td>
                        <td style=\"$padding\">{$row_2['vendor_name']}</td>
                        <td style=\"text-align:left;$padding\">" .
                        ( $last_entry ?
                            date(DATE_FORMAT, strtotime($last_entry)) : NULL
                        ) . "
                        </td>
                        <td style=\"text-align:right;$padding\">" .
                        ( bccomp($row_2['WIP_Debits'], 0, 2) == -1 ?
                            "(\$" . number_format(bcmul($row_2['WIP_Debits'], -1, 2), 2) . ")" : "\$" . number_format($row_2['WIP_Debits'], 2)
                        ) . "
                        </td>
                        <td style=\"text-align:right;$padding\">" .
                        ( bccomp($row_2['WIP_Credits'], 0, 2) == -1 ?
                            "(\$" . number_format(bcmul($row_2['WIP_Credits'], -1, 2), 2).")" : "\$" . number_format($row_2['WIP_Credits'], 2)
                        ) . "
                        </td>
                        <td style=\"text-align:right;$padding\">" .
                        ( bccomp($row_2['Reconciled'], 0, 2) == -1 ?
                            "(\$" . number_format(bcmul($row_2['Reconciled'], -1, 2), 2) . ")" : "\$" . number_format($row_2['Reconciled'], 2)
                        ) . "
                        </td>
                        <td style=\"text-align:right;$padding\">".
                        ( bccomp($balance, 0, 2) == -1 ?
                            "(\$" . number_format(bcmul($balance, -1, 2), 2) . ")" : "\$" . number_format($balance, 2)
                        ) . "
                        </td>
                    </tr>";

                     $l++;
                     unset($padding);
				}

			}

			if ( $m )
                $tbl .= "
                <tr>
                    <td colspan=\"3\" style=\"background-color:#ffffff\"></td>
                    <td style=\"text-align:right;background-color:#ffffff\">
                        <div style=\"margin-top:20px;border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">" .
                        ( bccomp($total_dr, 0, 2) == -1 ?
                            "(\$" . number_format(bcmul($total_dr, -1, 2), 2) . ")" : "\$" . number_format($total_dr, 2)
                        ) . "
                        </div>
                    </td>
                    <td style=\"text-align:right;background-color:#ffffff\">
                        <div style=\"margin-top:20px;border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">" .
                        ( bccomp($total_cr, 0, 2) == -1 ?
                            "(\$" . number_format(bcmul($total_cr, -1, 2), 2) . ")" : "\$" . number_format($total_cr, 2)
                        ) . "
                        </div>
                    </td>
                    <td style=\"text-align:right;background-color:#ffffff\">
                        <div style=\"margin-top:20px;border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">" .
                        ( bccomp($total_rec, 0, 2) == -1 ?
                            "(\$" . number_format(bcmul($total_rec, -1, 2), 2) . ")" : "\$" . number_format($total_rec, 2)
                        ) . "
                        </div>
                    </td>
                    <td style=\"text-align:right;background-color:#ffffff\">
                        <div style=\"margin-top:20px;border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">" .
                        ( bccomp($total_bal, 0, 2) == -1 ?
                            "(\$" . number_format(bcmul($total_bal, -1, 2), 2) . ")" : "\$" . number_format($total_bal, 2)
                        ) . "
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan=\"7\" style=\"border-top:1px solid #cccccc;background-color:#ffffff;padding:25px 10px 10px 10px;text-align:right;\">
                        ".$this->form->button("value=Perform Reconciliation",
                                              "id=reconcile_btn",
                                              "onClick=if(confirm('Are you sure you want to reconcile the selected outstanding WIP balances? This action will close those outstanding balances.')){submit_form(\$('test').form, 'reports', 'exec_post', 'refresh_form', 'action=doit_wip_exec_reconcile');this.disabled=1}")."
                    </td>
                </tr>";
			else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"7\">There are no results to show.</td>
				</tr>";

			$tbl .= "
			</table>".
			$this->form->close_form();

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

            if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
                $this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
            if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
                $this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_wip_reconcile');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_commission_report', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "WIP Reconciliation Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Filter results by timeframe:</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">" .
                                                $this->form->select(
                                                    "timeframe",
                                                    array(
                                                        "All WIP entries",
                                                        "WIP entries dated this year",
                                                        "WIP entries dated last year",
                                                        "WIP entries from the current period",
                                                        "WIP entries from the previous period",
                                                        "WIP entries from the current month",
                                                        "WIP entries from the previous month",
                                                        "A specific date range"
                                                    ),
                                                    $this->current_report['timeframe'],
                                                    array('*', 1, 2, 3, 4, 6, 7, 5),
                                                    "onChange=if( this.options[ this.selectedIndex ].value == 5 ) { toggle_display('date_range', 'block'); } else { toggle_display('date_range', 'none'); }",
                                                    "blank=1"
                                                ) . "
                                                <div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
                                                    <span id=\"sort_from_date_holder\"></span>
                                                    <span id=\"sort_to_date_holder\"></span>";
                                                $jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
                                                $jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
                                                $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">
    											Display WIP entries with an<br />open balance of up to:
                                            </td>
											<td style=\"background-color:#ffffff;\">\$" .
                                                $this->form->text_box(
                                                    "name=wip_amt",
                                                    "value=". ( $this->current_report ? number_format($this->current_report['wip_amt'], 2) : ( defined('AUTO_WIP_MIN_AMT') ? AUTO_WIP_MIN_AMT : NULL ) ),
                                                    "size=7",
                                                    "style=text-align:right;",
                                                    "onFocus=this.select();",
                                                    "onBlur=this.value=formatCurrency(this.value);"
                                                ) . "
                                                <span style=\"font-style:italic;font-size:90%;padding-left:5px;\">Optional</span>
        									</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;\">
    											Filter WIP entries by vendor:
            								</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".($this->current_report['vendor_filter'] ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;\">
                                                Filter WIP entries by proposal:
                                            </td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=proposal",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
                                                if (is_array($this->current_report['proposal_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++)
                                                        $tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_commission_report($local=NULL) {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);

			$late_tier = $this->current_report['late_tier'];
			if ($late_tier == 3) {
				$day = $this->current_report['day'];
				$com_action = $this->current_report['com_action'];
				$com_rate = $this->current_report['com_rate'];
			}
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$req = $this->current_report['req'];
			$sales_rep_match = $this->current_report['sales_rep_match'];
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);
		} else {
			$late_tier = $_POST['late_tier'];
			if ($late_tier == 3) {
				$day = $_POST['day'];
				$com_action = $_POST['com_action'];
				$com_rate = $_POST['com_rate'];
			}
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}

			$req = $_POST['req'];
			$sales_rep_match = $_POST['sales_rep_match'];
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);

		}

		if ($local)
			$proposal_hash = $local;

		$save = $_POST['save'];
		$saved_cat = "commission_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if (($timeframe == 5 && !$sort_from_date) || ($timeframe == 5 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}

		if ($this->content['error'])
			return;

		//  Add timeframe filter for ticket #360
		switch ($timeframe) {
			case 1:
			$sql_date_iif = "customer_invoice.invoice_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			$sql_date_pif = "customer_payment.receipt_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			$this->report_title = "Dated ".date("Y");
			break;

			case 2:
			$sql_date_iif = "customer_invoice.invoice_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01'";
			$sql_date_pif = "customer_payment.receipt_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01'";
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01'";
			$this->report_title = "Dated ".(date("Y") -  1);
			break;

			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_date_iif = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sql_date_pif = "customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$this->report_title = "Dated Between ".date(DATE_FORMAT, strtotime($period_info['period_start']))." and ".date(DATE_FORMAT, strtotime($period_info['period_end']));
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_date_iif = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sql_date_pif = "customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$this->report_title = "Dated Between ".date(DATE_FORMAT, strtotime($period_info['period_start']))." and ".date(DATE_FORMAT, strtotime($period_info['period_end']));
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			case 5:
			if ($sort_from_date && $sort_to_date) {
				$sql_date_iif = "customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$sql_date_pif = "customer_payment.receipt_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = "Dated Between ".date(DATE_FORMAT, strtotime($sort_from_date))." and ".date(DATE_FORMAT, strtotime($sort_to_date));
			} else {
				$sql_date_pif = "customer_payment.receipt_date >= '".$sort_from_date."'";
				$sql_p[] = "customer_invoice.invoice_date >= '".$sort_from_date."'";
				$this->report_title = "Dated Between ".date(DATE_FORMAT, strtotime($sort_from_date))." and ".date(DATE_FORMAT);
			}
			break;

			default:
				$this->report_title = "As of ".date(DATE_FORMAT);
		}
		// SQL statment for specific dates of commission report
		if ($sql_d)
			$sql_d = implode($sql_d);
		if (@in_array("IIP", $req))
			$req_invoiced = 1;
		// Invoiced in Full
		if (@in_array("IIF", $req)) {
			$sql_h[] = "total_uninvoiced_lines = 0";
			/*$sql_p[] = "(SELECT COUNT(proposals.obj_id)
               					FROM proposals
               					LEFT JOIN line_items ON line_items.proposal_hash = proposals.proposal_hash
			   					WHERE line_items.proposal_hash = parent_proposal_hash AND line_items.active != 1 AND line_items.invoice_hash = '') = 0";*/
		}
		// Paid in Full
		if (@in_array("PIF", $req)) {
			$sql_h[] = "total_amount_received >= total_amount_invoiced";
/*			$sql_p[] = "(SELECT SUM(customer_payment.receipt_amount)
				   FROM customer_invoice
				   LEFT JOIN customer_payment ON customer_payment.invoice_hash = customer_invoice.invoice_hash
				   WHERE $sql_date_pif
				  ) >= customer_invoice.amount ";*/
		}
		if (@in_array("PRF", $req)) {
			$prf_percent = $_POST['prf_percent'];
		}
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match, 'add_quotes', "'");
			$sql_p[] = "proposals.sales_hash IN (".implode(" , ", $sales_rep_match).")";
			array_walk($sales_rep_match, 'strip_quotes');
		}

		if ($sql_p)
			$sql = implode(" AND ", $sql_p);
		if ($sql_h)
			$having = implode(" AND ", $sql_h);

		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|late_tier=$late_tier|day=".@implode("&", $day)."|com_action=".@implode("&", $com_action)."|com_rate=".@implode("&", $com_rate)."|req=".@implode("&", $req)."|prf_percent=$prf_percent|sales_rep_match=".@implode("&", $sales_rep_match);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT proposals.proposal_no, proposals.proposal_hash AS parent_proposal_hash , proposals.commission_team ,
									proposals.proposal_descr, users.full_name, users.commission_hash AS user_commission,
									proposals.sales_hash , proposals.customer_hash , customers.gsa , customers.customer_name ,
									customer_invoice.invoice_hash as parent_invoice_hash ,
									(
										SELECT SUM(customer_invoice.amount - customer_invoice.balance)
										FROM `customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I' AND customer_invoice.deleted = 0
									) AS total_amount_received ,
									(
										SELECT SUM(customer_invoice.amount)
										FROM `customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'D' AND customer_invoice.deleted = 0
									) AS total_deposit_received ,
									(
										SELECT SUM(customer_invoice.amount)
										FROM `customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I' AND customer_invoice.deleted = 0
									) AS total_amount_invoiced ,
									COUNT(line_items.invoice_hash) AS total_line_items ,
									(
									SELECT COUNT(*)
									FROM `line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND `invoice_hash` = '' AND `active` = 1
									) AS total_uninvoiced_lines ,
									vendor_products.product_name , vendor_products.product_hash as parent_product_hash ,
									(
										SELECT SUM(line_items.cost * line_items.qty)
										FROM `line_items`
										WHERE `proposal_hash` = parent_proposal_hash AND `active` = 1 AND
											CASE
											WHEN ISNULL(parent_product_hash)
												THEN ISNULL(`product_hash`)
												ELSE `product_hash` = parent_product_hash
											END
									) AS total_product_cost ,
									(
										SELECT SUM(vp.amount)
										FROM vendor_payables vp
										LEFT JOIN purchase_order po
										ON vp.po_hash = po.po_hash
										WHERE po.proposal_hash = parent_proposal_hash AND vp.deleted = 0 and vp.type = 'C'
                                    ) AS total_product_credits ,
									(
										SELECT SUM(line_items.sell * line_items.qty)
										FROM `line_items`
										WHERE `proposal_hash` = parent_proposal_hash AND `active` = 1 AND
											CASE
											WHEN ISNULL(parent_product_hash)
												THEN ISNULL(`product_hash`)
												ELSE `product_hash` = parent_product_hash
											END
									) AS total_product_sell ,
									(
										SELECT SUM(vendor_payables.amount)
										FROM `vendor_payables`
										LEFT JOIN `purchase_order` ON purchase_order.po_hash = vendor_payables.po_hash AND purchase_order.deleted = 0
										WHERE purchase_order.proposal_hash = parent_proposal_hash AND vendor_payables.type = 'I' AND vendor_payables.deleted = 0
									) AS total_payables ,
									(
										SELECT SUM(vendor_payables.amount)
										FROM `vendor_payables`
										LEFT JOIN `purchase_order` ON purchase_order.po_hash = vendor_payables.po_hash AND purchase_order.deleted = 0
										WHERE purchase_order.proposal_hash = parent_proposal_hash AND vendor_payables.type = 'D' AND vendor_payables.deleted = 0
									) AS total_payable_deposits ,
									commissions_paid.cost , commissions_paid.amount AS previous_commission_paid
									FROM line_items
									LEFT JOIN proposals ON proposals.proposal_hash = line_items.proposal_hash
									LEFT JOIN customer_invoice ON customer_invoice.invoice_hash = line_items.invoice_hash AND customer_invoice.deleted = 0
									LEFT JOIN vendor_products ON vendor_products.product_hash = line_items.product_hash
									LEFT JOIN customers ON customers.customer_hash = proposals.customer_hash
									LEFT JOIN users ON users.id_hash = proposals.sales_hash
									LEFT JOIN commissions_paid ON commissions_paid.proposal_hash = line_items.proposal_hash
									LEFT JOIN ( SELECT invoice_hash , SUM(receipt_amount) AS total_amount_paid , deleted
									            FROM customer_payment
									            GROUP BY invoice_hash
									           ) AS customer_payment ON customer_payment.invoice_hash = customer_invoice.invoice_hash AND customer_payment.deleted = 0
									WHERE (commissions_paid.paid_in_full = 0 OR ISNULL(commissions_paid.paid_in_full)) AND ".($proposal_hash ?
										"line_items.proposal_hash = '$proposal_hash' AND " : NULL).
									"line_items.status > 0 ".($req_invoiced ? "
										AND line_items.invoice_hash != ''" : NULL).
									($sql ? "
										AND ".$sql : NULL)."
									GROUP BY line_items.proposal_hash , line_items.product_hash".($having ? "
										HAVING ".$having : NULL));
		while ($row = $this->db->fetch_assoc($result)) {
			if ($row['total_line_items'] > 0) {
				$row['total_payables_received'] = $row['total_payables'];
				if ($row['total_payable_deposits'])
					$row['total_payables_received'] -= $row['total_payable_deposits'];

				//$order_by[$row['parent_proposal_hash']] = $row['proposal_no'];
				$this->results[$row['sales_hash']][$row['parent_proposal_hash']][] = $row;
			}
		}
		$this->overhead_record = array();
		$this->commission_rule = array();

		$sys_config = new system_config($this->current_hash);
		if (is_array($this->results)) {
			reset($this->results);
			while (list($sales_hash, $proposal_array) = each($this->results)) {
				while (list($proposal_hash, $detail) = each($proposal_array)) {
					unset($overhead);
					$result = $this->db->query("SELECT `overhead_hash` , `type`
												FROM `overhead_rules`
												WHERE `active` = 1
												  AND (('".date("Y-m-d")."' BETWEEN `effective_date` AND `expiration_date`) OR (`effective_date` = '' AND `expiration_date` = '') OR (`effective_date` != '' AND ".date("Y-m-d")." >= `effective_date`) OR (`expiration_date` != '' AND ".date("Y-m-d")." <= `expiration_date`))
												  AND ((`type` = 'C' AND `customer_hash` = '".$detail[0]['customer_hash']."') ".($detail[0]['gsa'] ? "
													  OR `type` = 'G'" : NULL)."
														   OR `type` = 'D')");
					while ($row = $this->db->fetch_assoc($result))
						$overhead[$row['type']] = $row;

					if ($overhead['C'])
						$overhead_hash = $overhead['C']['overhead_hash'];
					elseif ($overhead['G'])
						$overhead_hash = $overhead['G']['overhead_hash'];
					elseif ($overhead['D'])
						$overhead_hash = $overhead['D']['overhead_hash'];

					if ($overhead_hash) {
						if (!$this->overhead_record[$overhead_hash]) {
							$sys_config->fetch_overhead_record($overhead_record);
							$this->overhead_record[$overhead_record] = $sys_config->current_overhead;
						}

						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$this->overhead_record[$overhead_record]['rate'],
																				'apply_to'	=>	$this->overhead_record[$overhead_record]['apply_to']);
					} elseif (defined('OVERHEAD_TYPE')) {
						$overhead_rate = (float)OVERHEAD_RATE;

						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$overhead_rate,
																				'apply_to'	=>	OVERHEAD_TYPE);
					}
					//Get any memo costs
					unset($memo);
					$result = $this->db->query("SELECT *
												FROM `memo_costs`
												WHERE `proposal_hash` = '$proposal_hash' AND deleted = 0");
					while ($row = $this->db->fetch_assoc($result))
						$memo[] = $row;

					if ($memo)
						$this->results_misc[$proposal_hash]['MEMO'] = $memo;

					//Get any job costs
					unset($job_cost);
					$result = $this->db->query("SELECT *
												FROM vendor_payable_expenses t2
					                            LEFT JOIN vendor_payables t1 ON t1.invoice_hash = t2.invoice_hash
												WHERE `proposal_hash` = '$proposal_hash' AND t1.deleted = 0");
					while ($row = $this->db->fetch_assoc($result))
						$job_cost[] = $row;

					if ($job_cost)
						$this->results_misc[$proposal_hash]['JOB_COST'] = $job_cost;

					unset($com);
					//Get the commission
					$result = $this->db->query("SELECT `commission_hash` , `type`
												FROM `commission_tables`
												WHERE `active` = 1
												  AND (('".date("Y-m-d")."' BETWEEN `effective_date` AND `expiration_date`) OR (`effective_date` = '' AND `expiration_date` = '') OR (`effective_date` != '' AND ".date("Y-m-d")." >= `effective_date`) OR (`expiration_date` != '' AND ".date("Y-m-d")." <= `expiration_date`))
												  AND ((`type` = 'C' AND `customer_hash` = '".$detail[0]['customer_hash']."') ".($detail[0]['gsa'] ? "
													  OR `type` = 'G'" : NULL).($detail[0]['user_commission'] ? "
														   OR (`type` = 'D' AND `commission_hash` = '".$detail[0]['user_commission']."')" : NULL).")");
					while ($row = $this->db->fetch_assoc($result))
						$com[$row['type']] = $row;

					if ($com['C']) {
						if (!$this->commission_rule[$com['C']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['C']['commission_hash']);
							$this->commission_rule[$com['C']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['C']['commission_hash']];
					} elseif ($com['G']) {
						if (!$this->commission_rule[$com['G']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['G']['commission_hash']);
							$this->commission_rule[$com['G']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['G']['commission_hash']];
					} elseif ($com['D']) {
						if (!$this->commission_rule[$com['D']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['D']['commission_hash']);
							$this->commission_rule[$com['D']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['D']['commission_hash']];
					}
				}
			}
		}
		$this->content['action'] = 'close';

		$this->total = count($this->results);
		if ($local)
			return true;
		else
			$this->content['html']['place_holder'] = $this->commission_report(1);
		return;
	}

	function commission_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'popup_id' => '', 'report_hash' => $this->report_hash))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Commission Report").($this->p->ck('reports', 'V', 'commissions') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'commission_report', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
					</td>
				</tr>
				<tr>
					<td style=\"text-align:left;width:500px;padding:5px;background-color:#ffffff\" colspan=\"3\">
						<h5 style=\"margin-bottom:5px;color:#00477f;margin-left:20px;\">".$this->report_title."</h5>
					</td>
					<td style=\"background-color:#ffffff\" colspan=\"4\"></td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:350px;text-align:left;padding-left:50px;\">Product</td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
				</tr>";
			$customers = new customers($this->current_hash);
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				reset($this->results);
				while (list($sales_hash, $proposal_array) = each($this->results)) {
					unset($inner_tbl);
					$sales_commission = $total_invoiced = $total_received = $total_sales_cost = $total_deposits = $k = 0;
					while (list($proposal_hash, $product_array) = each($proposal_array)) {
						if ($this->results_misc[$proposal_hash]['COMM']) {
							$comm_paid = 1;
							$inner_tbl .= ($k > 0 ?"
							<tr>
								<td colspan=\"5\" style=\"background-color:#cccccc;\"></td>
							</tr>" : NULL)."
							<tr>
								<td colspan=\"5\" style=\"font-size:8pt;background-color:#ffffff;padding-left:25px;padding-top:5px;\">
									".$this->form->hidden(array('proposal_owner['.$proposal_hash.']' => $sales_hash))."
									".$this->form->checkbox("name=proposal[".$proposal_hash."]",
															"value=1",
															"checked")."
									&nbsp;
									Proposal: <a href=\"javascript:void(0);\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=$proposal_hash', 'popup_id=proposal_win', 'from_report=1');\" class=\"link_standard\">".$product_array[0]['proposal_no']."</a> - ".$product_array[0]['proposal_descr']."
									<div style=\"padding-top:5px;\">".stripslashes($product_array[0]['customer_name'])."</div>
								</td>
							</tr>";

							$k++;
							$total_sell = $total_cost = $total_profit = 0;

							for ( $i = 0; $i < count($product_array); $i++ ) {

								$_margin = math::gp_margin( array(
									'cost'  =>  $product_array[$i]['total_product_cost'],
									'sell'  =>  $product_array[$i]['total_product_sell']
								) );

								$inner_tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".($product_array[$i]['product_name'] ? stripslashes($product_array[$i]['product_name']) : "Miscellaneous")."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($product_array[$i]['total_product_sell'], 2)."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($product_array[$i]['total_product_cost'], 2).$this->form->hidden(array('cost['.$proposal_hash.'][]' => $product_array[$i]['total_product_cost']))."</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;" .
    								( bccomp( bcsub($product_array[$i]['total_product_sell'], $product_array[$i]['total_product_cost'], 2), 0, 2) == -1 ?
        								"color:#ff0000;" : NULL
    								) . "\">" .
    								( bccomp( bcsub($product_array[$i]['total_product_sell'], $product_array[$i]['total_product_cost'], 2), 0, 2) == -1 ?
										"(\$" . number_format( bcmul( bcsub($product_array[$i]['total_product_sell'], $product_array[$i]['total_product_cost'], 2), -1, 2), 2) . ")"
        								:
        								"\$" . number_format( bcsub($product_array[$i]['total_product_sell'], $product_array[$i]['total_product_cost'], 2), 2)
        							) . "
									</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;" .
        							( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 || defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 ?
            							"color:red;" : NULL
            						) . "\">" .
            						( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ?
										"(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . "%)" : (float)bcmul($_margin, 100, 4) . "%"
            						) . "
									</td>
								</tr>";

								$total_sell = bcadd($total_sell, $product_array[$i]['total_product_sell'], 2);
								$total_cost = bcadd($total_cost, $product_array[$i]['total_product_cost'], 2);
							}

							// Reduce costs if credits are applied to po #1451
							if ($product_array[0]['total_product_credits']) {
								$inner_tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">Credits Deducted From POs</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
									<td style=\"font-size:8pt;background-color:#ffffff;color:red;\" class=\"num_field\">($".number_format($product_array[0]['total_product_credits'], 2).")".$this->form->hidden(array('cost['.$proposal_hash.'][]' => $product_array[0]['total_product_credits']))."</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								</tr>";
								$total_cost -= $product_array[0]['total_product_credits'];
							}
							if ($this->results_misc[$proposal_hash]['OVERHEAD'] && $this->results_misc[$proposal_hash]['OVERHEAD']['rate']) {
								if ($this->results_misc[$proposal_hash]['OVERHEAD']['apply_to'] == 'C')
									$overhead_factor = _round($total_cost * $this->results_misc[$proposal_hash]['OVERHEAD']['rate'], 2);
								elseif ($this->results_misc[$proposal_hash]['OVERHEAD']['apply_to'] == 'S')
									$overhead_factor = _round($total_sell * $this->results_misc[$proposal_hash]['OVERHEAD']['rate'], 2);

								$inner_tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">Company Overhead Factor</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($overhead_factor, 2).$this->form->hidden(array('cost['.$proposal_hash.'][]' => $overhead_factor))."</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								</tr>";
								$total_cost += $overhead_factor;
							}
							if ($this->results_misc[$proposal_hash]['MEMO']) {
								for ($i = 0; $i < count($this->results_misc[$proposal_hash]['MEMO']); $i++) {
									$inner_tbl .= "
									<tr>
										<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".(strlen($this->results_misc[$proposal_hash]['MEMO'][$i]['descr']) > 45 ?
											substr($this->results_misc[$proposal_hash]['MEMO'][$i]['descr'], 0, 42)."..." : $this->results_misc[$proposal_hash]['MEMO'][$i]['descr'])."
										</td>
										<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
										<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($this->results_misc[$proposal_hash]['MEMO'][$i]['amount'], 2).$this->form->hidden(array('cost['.$proposal_hash.'][]' => $this->results_misc[$proposal_hash]['MEMO'][$i]['amount']))."</td>
										<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
										<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									</tr>";
									$total_cost += $this->results_misc[$proposal_hash]['MEMO'][$i]['amount'];
								}
							}
							if ($this->results_misc[$proposal_hash]['JOB_COST']) {
								for ($i = 0; $i < count($this->results_misc[$proposal_hash]['JOB_COST']); $i++) {
									$inner_tbl .= "
									<tr>
										<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".(strlen($this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo']) > 45 ?
											substr($this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo'], 0, 42)."..." : $this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo'])."
										</td>
										<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
										<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($this->results_misc[$proposal_hash]['JOB_COST'][$i]['amount'], 2).$this->form->hidden(array('cost['.$proposal_hash.'][]' => $this->results_misc[$proposal_hash]['JOB_COST'][$i]['amount']))."</td>
										<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
										<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									</tr>";
									$total_cost += $this->results_misc[$proposal_hash]['JOB_COST'][$i]['amount'];
								}
							}
							$inner_tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\"id=\"memo_descr_".$proposal_hash."\"></td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"memo_cost_".$proposal_hash."\"></td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
							</tr>";
							unset($neg_gp);
							$blended_gp = math::gp_margin( array(
								'cost'   =>  $total_cost,
								'sell'   =>  $total_sell
							) );

							if ( bccomp($blended_gp, 0, 4) == -1 ) {

								$blended_gp = (float)bcmul($blended_gp, -1, 4);
								$neg_gp = true;
							}

							unset($com_rate, $com_due);
							while (list($tier, $rule_array) = each($this->results_misc[$proposal_hash]['COMM']['rules'])) {
								if ($blended_gp >= $rule_array['tier_start'] && (floor($blended_gp * 100) * .01) <= $rule_array['tier_end']) {
									if ($rule_array['tier_action'] == 'P') {
										$com_rate = _round($blended_gp, 4);
										$com_due = _round(($total_sell - $total_cost) * $com_rate, 2);
									} elseif ($rule_array['tier_action'] == 1) {
										$com_rate = $rule_array['tier_rate'];
										$com_due = _round(($total_sell - $total_cost) * $com_rate, 2);
									}
								}
							}

							if ( $neg_gp ) {

								$blended_gp = (float)bcmul($blended_gp, -1, 4);
								$com_rate = (float)bcmul($com_rate, -1, 4);
							}

							$_margin = math::gp_margin( array(
								'cost'   =>  $total_cost,
								'sell'   =>  $total_sell
							) );

							$inner_tbl .= "
							<tr >
								<td style=\"background-color:#ffffff;padding-left:50px;\">
									[<span style=\"font-size:8pt;\"><a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_memo_cost', 'proposal_hash=$proposal_hash', 'popup_id=memo_win', 'commission_hash=".$this->results_misc[$proposal_hash]['COMM']['commission_hash']."', 'from=commission');\">new memo cost</a></span>]
								</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;".($total_sell < 0 ? "color:#ff0000;" : NULL)."\" id=\"total_sell_".$proposal_hash."\">
										".$this->form->hidden(array('total_sell['.$proposal_hash.']' => $total_sell, 'commission_used['.$proposal_hash.']' => $this->results_misc[$proposal_hash]['COMM']['commission_hash'])).($total_sell < 0 ?
											"($".number_format($total_sell * -1, 2).")" : "$".number_format($total_sell, 2))."
									</div>
								</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;".($total_cost < 0 ? "color:#ff0000;" : NULL)."\" id=\"total_cost_".$proposal_hash."\">".($total_cost < 0 ?
										"($".number_format($total_cost * -1, 2).")" : "$".number_format($total_cost, 2))."
									</div>
								</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;".($total_sell - $total_cost < 0 ? "color:#ff0000;" : NULL)."\" id=\"total_profit_".$proposal_hash."\">".($total_sell - $total_cost < 0 ?
										"($".number_format(($total_sell - $total_cost) * -1, 2).")" : "$".number_format($total_sell - $total_cost, 2))."
									</div>
								</td>
								<td class=\"num_field\" class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;" .
									( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 || defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 ?
    									"color:#ff0000;" : NULL
									) . "\" id=\"total_gp_{$proposal_hash}\">" .
									( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ?
										"(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . "%)" : (float)bcmul($_margin, 100, 4) . "%"
    								) . "
									</div>
								</td>
							</tr>
							<tr>
								<td style=\"padding-bottom:15px;padding-top:8px;background-color:#ffffff;font-size:8pt;padding-left:25px;\" colspan=\"5\">
									<div style=\"margin-bottom:5px;\" >
										Net Invoiced: <span id=\"net_invoiced_".$proposal_hash."\">$".number_format($product_array[0]['total_amount_invoiced'], 2)."</span>
										&nbsp;&nbsp;
										".$this->form->hidden(array("received[".$proposal_hash."]" => $product_array[0]['total_amount_received'], "deposits[".$proposal_hash."]" => $product_array[0]['total_deposit_received']))."
										Received: $".number_format($product_array[0]['total_amount_received'], 2)."
										&nbsp;&nbsp;
										Deposits: $".number_format($product_array[0]['total_deposit_received'], 2)."
										&nbsp;&nbsp;
										Total Payables: $".number_format($product_array[0]['total_payables_received'], 2)."
									</div>
									<div style=\"margin-bottom:5px;\" >
										Commission Rate: <span id=\"commission_rate_".$proposal_hash."\">".($com_rate * 100)."%</span> (".$this->form->hidden(array("commission_rate[".$proposal_hash."]" => $com_rate)).$this->results_misc[$proposal_hash]['COMM']['name'].")".($product_array[0]['previous_commission_paid'] ? "
										&nbsp;
										Previous Commissions Paid: $".number_format($product_array[0]['previous_commission_paid'], 2).$this->form->hidden(array('previous_commission_paid['.$proposal_hash.']' => $product_array[0]['previous_commission_paid'])) : NULL)."
									</div>
									<div style=\"margin-bottom:5px;\">
										Commission Owed:
										".$this->form->text_box("name=commission_owed[".$proposal_hash."]",
																"id=commission_owed_".$proposal_hash,
																"value=".number_format($com_due - $product_array[0]['previous_commission_paid'], 2),
																"size=8",
																"style=text-align:right;font-size:8pt;",
																"onBlur=if(this.value){this.value=formatCurrency(this.value);}")."
										&nbsp;
										[<a href=\"javascript:void(0);\" onClick=\"submit_form(\$('test').form, 'reports', 'exec_post', 'refresh_form', 'action=adjust_memo_cost', 'recalc=".$proposal_hash."');\" class=\"link_standard\">recalculate</a>]
										&nbsp;&nbsp;
										Paid In Full:
										&nbsp;
										".$this->form->checkbox("name=paid_in_full[".$proposal_hash."]", "value=1", "checked")."
									</div>
								</td>
							</tr>";

							$total_invoiced += $total_sell;
							$total_received += $product_array[0]['total_amount_received'];
							$sales_commission += ($com_due - $product_array[0]['previous_commission_paid']);
							$total_deposits += $product_array[0]['total_deposit_received'];
							$total_sales_cost += $total_cost;
						}
					}
					if ($inner_tbl) {
						$tbl .= "
						<tr style=\"background-color:#efefef;\">
							<td style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".stripslashes($this->user_name($sales_hash))."</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Sell</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Cost</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>
						</tr>"
						. $inner_tbl;
						$all_commission += $sales_commission;
						$sales_commission_array[$sales_hash] = array('full_name'			=>	$this->user_name($sales_hash),
																     'total_invoiced' 	    =>	$total_invoiced,
																     'total_received'		=>  $total_received,
																     'total_cost'			=>	$total_sales_cost,
																     'total_deposits'		=>	$total_deposits,
																     'total_profit'			=>  ($total_invoiced - $total_cost),
																     'total_commission'		=>  $sales_commission);
					}
				}
				if ($all_commission) {
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;\" colspan=\"5\">
							<div style=\"margin-bottom:10px;margin-top:20px;\">
								".$this->form->button("value=Recalculate Totals",
													  "id=recalc_btn",
													  "onClick=this.disabled=1;fuck_off();")."
							</div>
							<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"width:100%;margin-top:0;\">
								<tr style=\"background-color:#efefef;\">
									<td style=\"padding:5px;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\">Sales Rep</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Net Invoiced</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Received</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Deposits</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Actual Cost</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Commission Owed</td>
								</tr>";
							while (list($sales_hash, $sales_array) = each($sales_commission_array)) {

								$_margin = math::gp_margin( array(
									'cost'  =>  $sales_array['total_cost'],
									'sell'  =>  $sales_array['total_invoiced']
								) );

								$tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;\">".$this->form->hidden(array('sales_array['.$sales_hash.']' => 1)).$sales_array['full_name']."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;".($sales_array['total_invoiced'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\" id=\"total_invoiced_".$sales_hash."\">".($sales_array['total_invoiced'] < 0 ?
										"($".number_format($sales_array['total_invoiced'] * -1, 2).")" : "$".number_format($sales_array['total_invoiced'], 2))."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;".($sales_array['total_received'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\" id=\"total_received_".$sales_hash."\">".($sales_array['total_received'] < 0 ?
										"($".number_format($sales_array['total_received'] * -1, 2).")" : "$".number_format($sales_array['total_received'], 2))."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;".($sales_array['total_deposits'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\" id=\"total_deposits_".$sales_hash."\">".($sales_array['total_deposits'] < 0 ?
										"($".number_format($sales_array['total_deposits'] * -1, 2).")" : "$".number_format($sales_array['total_deposits'], 2))."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;".($sales_array['total_cost'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\" id=\"total_cost_".$sales_hash."\">".$this->form->hidden(array('current_cost_'.$sales_hash => $sales_array['total_cost'])).($sales_array['total_cost'] < 0 ?
										"($".number_format($sales_array['total_cost'] * -1, 2).")" : "$".number_format($sales_array['total_cost'], 2))."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;".($sales_array['total_invoiced'] - $sales_array['total_cost'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\" id=\"total_profit_".$sales_hash."\">".($sales_array['total_invoiced'] - $sales_array['total_cost'] < 0 ?
										"($".number_format(($sales_array['total_invoiced'] - $sales_array['total_cost']) * -1, 2).")" : "$".number_format(($sales_array['total_invoiced'] - $sales_array['total_cost']), 2))."
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;" .
    								( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 || defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 ?
        								"color:#ff0000;" : NULL
    								) . "\" class=\"num_field\" id=\"total_gp_{$sales_hash}\">" .
    								( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ?
										"(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . "%)" : (float)bcmul($_margin, 100, 4) . "%"
    								) . "
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;".($sales_array['total_commission'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\" id=\"total_commission_".$sales_hash."\">
										".$this->form->hidden(array('current_commission_'.$sales_hash => $sales_array['total_commission'])).($sales_array['total_commission'] < 0 ?
											"($".number_format($sales_array['total_commission'] * -1, 2).")" : "$".number_format($sales_array['total_commission'], 2))."
									</td>
								</tr>";
								$total_net_invoiced += $sales_array['total_invoiced'];
								$total_net_received += $sales_array['total_received'];
								$total_net_cost += $sales_array['total_cost'];
								$total_net_deposits += $sales_array['total_deposits'];
							}

							$_margin = math::gp_margin( array(
								'cost'   =>  $total_net_cost,
								'sell'   =>  $total_net_invoiced
							) );

							$tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">&nbsp;</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;".($total_net_invoiced < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_invoiced\">".($total_net_invoiced < 0 ?
											"($".number_format($total_net_invoiced * -1, 2).")" : "$".number_format($total_net_invoiced, 2))."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;".($total_net_received < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_received\">".($total_net_received < 0 ?
											"($".number_format($total_net_received * -1, 2).")" : "$".number_format($total_net_received, 2))."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;".($total_net_deposits < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_deposits\">".($total_net_deposits < 0 ?
											"($".number_format($total_net_deposits * -1, 2).")" : "$".number_format($total_net_deposits, 2))."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;".($total_net_cost < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_cost\">".($total_net_cost < 0 ?
											"($".number_format($total_net_cost * -1, 2).")" : "$".number_format($total_net_cost, 2))."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;".($total_net_invoiced - $total_net_cost < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_profit\">".($total_net_invoiced - $total_net_cost < 0 ?
											"($".number_format(($total_net_invoiced - $total_net_cost) * -1, 2).")" : "$".number_format($total_net_invoiced - $total_net_cost, 2))."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;".($total_net_invoiced < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;" .
            							( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 || defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 ?
                							"color:#ff0000;" : NULL
            							) . "\" id=\"total_margin\">" .
            							( bccomp( bcmul($_margin, 100, 4), 0, 4) ?
											"(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . "%)" : (float)bcmul($_margin, 100, 4) . "%"
            							) . "
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;".($all_commission < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_commission\">".($all_commission < 0 ?
											"($".number_format($all_commission * -1, 2).")" : "$".number_format($all_commission, 2))."
										</div>
									</td>
								</tr>
							</table>
							<div style=\"margin-top:45px;margin-bottom:15px;margin-right:45px;text-align:right;\">
								<div style=\"padding-bottom:5px;\" id=\"pay_date_holder\">";
									$this->content['jscript'][] = "setTimeout('DateInput(\'pay_date\', \'true\', \'YYYY-MM-DD\', \'".date("Y-m-d")."\', 1, \'pay_date_holder\', \'Commission Date: \')', 45);";
								$tbl .= "
								</div>
								".$this->form->button("value=Post Commissions", "onClick=if(confirm('Are you sure you want to post commissions? All proposals will be updated with the commission settings you have input above.')){submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=post_commission');}")."
							</div>
						</td>
					</tr>";
				}
			}
			if (!$this->results || !$comm_paid)
				$tbl .= "
				<tr>
					<td colspan=\"5\" style=\"padding:25px 0px 5px 5px;background-color:#ffffff;\">Your commission report is empty.</td>
				</tr>";

			$tbl .= "
			</table>".$this->form->close_form();

			$this->content['jscript'][] = "
			fuck_off = function() {
				\$('total_invoiced').innerHTML='<img src=\'images/content_loader.gif\' />';
				\$('total_received').innerHTML='<img src=\'images/content_loader.gif\' />';
				\$('total_deposits').innerHTML='<img src=\'images/content_loader.gif\' />';
				\$('total_cost').innerHTML='<img src=\'images/content_loader.gif\' />';
				\$('total_profit').innerHTML='<img src=\'images/content_loader.gif\' />';
				\$('total_margin').innerHTML='<img src=\'images/content_loader.gif\' />';
				\$('total_commission').innerHTML='<img src=\'images/content_loader.gif\' />';
				window.setTimeout('submit_form(\$(\'test\').form, \'reports\', \'exec_post\', \'refresh_form\', \'action=adjust_memo_cost\');', 100);
			}";

			return $tbl;
		} else {
			$action_out = array("commission at", "no commission");
			$action_in = array(1, 0);

			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			$tbl = $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_commission_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_commission_report', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Commissions Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"";
/*										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe", array("All dates", "This year", "Last year", "Current period", "Previous period", "A specific date range"), $this->current_report['timeframe'], array('*', 1, 2, 3, 4, 5), "onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr> */
									$tbl .= "	<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">How should commissions<br />be tiered for late payments?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("late_tier", array("No Late Payment Tier", "Pay Full Commission Through 90 Days, Then No Commission", "Pay Full Commission Through 120 Days, Then No Commission", "Create A Custom Late Payment Commission Tier"), $this->current_report['late_tier'], array(0, 1, 2, 3), "blank=1", "style=width:400px", "onChange=if(this.options[this.selectedIndex].value == 3){toggle_display('late_tier_holder".$this->popup_id."', 'block')}else{toggle_display('late_tier_holder".$this->popup_id."', 'none')}")."
												<div style=\"padding-top:5px;display:".($this->current_report['late_tier'] == 3 ? "block" : "none").";\" id=\"late_tier_holder".$this->popup_id."\">
													<table style=\"width:100%;\" cellpadding=\"5\">
														<tr>
															<td style=\"background-color:#cccccc;border:1px solid #00477f;\" nowrap>
																<div style=\"padding-bottom:10px;\" id=\"tier_content_holder".$this->popup_id."\">";
																if ($this->report_hash && $this->current_report['late_tier'] == 3) {
																	$i = 0;
																	$tbl .= $this->form->hidden(array('tier_complete' => 1));
																	while (list($d, $day) = each($this->current_report['day'])) {
																		$tbl .= $this->form->hidden(array('day[]'			=>	$day,
																										  'com_action[]'	=>	$this->current_report['com_action'][$i],
																										  'com_rate[]'		=>	$this->current_report['com_rate'][$i]))."
																		<div style=\"padding-bottom:10px;\">
																			<span><a href=\"javascript:void(0);\" onClick=\"submit_form(\$('popup_id').form, 'reports', 'exec_post', 'refresh_form', 'action=new_commission_tier', 'undo=".$i."', 'report_hash=".$this->report_hash."')\"><img src=\"images/b_drop_small.gif\" alt=\"Undo to this tier\" border=\"0\" /></a></span>
																			If Over ".$day." Days
																			then ".$action_out[array_search($this->current_report['com_action'][$i], $action_in)].($this->current_report['com_action'][$i] == '1' ?
																				" ".$this->current_report['com_rate'][$i]." % of commission rate" : NULL)."
																		</div>";

																		$i++;
																	}
																} else
																	$tbl .= "
																	If Over ".$this->form->text_box("name=day[]", "value=", "size=5", "style=text-align:right;")." Days
																	then ".$this->form->select("com_action[]", $action_out, (!$this->report_hash ? 1 : $this->current_report['a']), $action_in, "blank=1", "onChange=if(this.options[this.selectedIndex].value==1){\$('rate_holder_0').style.visibility='visible';}else{\$('rate_holder_0').style.visibility='hidden'}")."&nbsp;
																	<span id=\"rate_holder_0\" style=\"visibility:visible;\">".$this->form->text_box("name=com_rate[]", "value=", "size=5")."&nbsp;% of commission rate</span>";

																$tbl .= "
																</div>
																<div style=\"text-align:right;padding:15px 75px 10px 0;display:".($this->report_hash ? "none" : "block")."\" id=\"commission_plus_btn".$this->popup_id."\">
																	<a href=\"javascript:void(0);\" onClick=\"submit_form(\$('popup_id').form, 'reports', 'exec_post', 'refresh_form', 'action=new_commission_tier')\"><img src=\"images/plus.gif\" border=\"0\" /></a>
																</div>
															</td>
														</tr>
													</table>
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">In order to pay commissions, <br />proposals must be:</td>
											<td style=\"background-color:#ffffff;\">
												<div>".$this->form->checkbox("name=req[]", "value=IIP", (@in_array('IIP', $this->current_report['req']) || $this->current_report['req'] ? "checked" : NULL))."&nbsp;Commissionable line items must be invoiced</div>
												<div style=\"padding-top:5px;\">".$this->form->checkbox("name=req[]", "value=IIF", (@in_array('IIF', $this->current_report['req']) || $this->current_report['req'] == 'IIF' ? "checked" : NULL))."&nbsp;Proposal must be invoiced in full</div>
												<div style=\"padding-top:5px;\">".$this->form->checkbox("name=req[]", "value=PIF", (@in_array('PIF', $this->current_report['req']) || $this->current_report['req'] == 'PIF' ? "checked" : NULL))."&nbsp;Invoices must be paid in full</div>
												<div style=\"padding-top:5px;\">".$this->form->checkbox("name=req[]", "value=PRF", (@in_array('PRF', $this->current_report['req']) || $this->current_report['req'] == 'PRF' ? "checked" : NULL), "onClick=if(this.checked){toggle_display('prf', 'block')}else{toggle_display('prf', 'none')}")."&nbsp;Proposal payables must be received in full</div>
												<div style=\"margin:5px 25px;display:".(@in_array('PRF', $this->current_report['req']) || $this->current_report['req'] == 'PRF' ? "block" : "none")."\" id=\"prf\">
													Or received within ".
													$this->form->text_box("name=prf_percent",
																		  "value=".$this->current_report['prf_percent'],
																		  "size=2",
																		  "style=text-align:right;")." %
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]", $this->sales_name, (is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')), $this->sales_hash, "multiple", "blank=1", "size=4", "style=width:200px;", ($this->p->ck('proposals', 'S') ? "disabled" : NULL))."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function new_commission_tier() {
		$day = $_POST['day'];
		$com_action = $_POST['com_action'];
		$com_rate = $_POST['com_rate'];
		$undo = $_POST['undo'];
		$report_hash = $_POST['report_hash'];
		$tier_complete = $_POST['tier_complete'];

		$action_out = array("commission at", "no commission");
		$action_in = array(1, 0);

		if (!is_array($day)) {
			$day = array($day);
			$com_action = array($com_action);
			$com_rate = array($com_rate);
		}

		for ($i = 0; $i < count($day); $i++) {
			if (is_numeric($undo) && $undo == $i)
				break;

			if ($tier_action[$i] == '1')
				$com_rate[$i] *= 1;

			if ($i == count($day) - 1 && $day[$i] <= $day[$i-1]) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "The commission date value you entered (".$day[$i].") is invalid. The value for this tier must be greater than ".($day[$i-1]).".";
				return;
			}
			if ($com_action[$i] == '1' && ($com_rate[$i] <= 0 || $com_rate[$i] > 100)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "The commission rate you entered for this day (".$day[$i].") is invalid. Please enter a valid commission rate (i.e. 10 for 10%).";
				return;
			}
			if (!is_numeric($undo) && !$tier_complete && strspn($day[$i], "0123456789") != strlen($day[$i])) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "When entering commission tiers, please enter only whole numbers.";
				return;
			}
			$tbl .= $this->form->hidden(array('day[]'			=>	$day[$i],
											  'com_action[]'	=>	$com_action[$i],
											  'com_rate[]'		=>	$com_rate[$i]))."
			<div style=\"padding-bottom:10px;\">
				<span><a href=\"javascript:void(0);\" onClick=\"submit_form(\$('popup_id').form, 'reports', 'exec_post', 'refresh_form', 'action=new_commission_tier', 'undo=".$i."', 'report_hash=$report_hash')\"><img src=\"images/b_drop_small.gif\" alt=\"Undo to this tier\" border=\"0\" /></a></span>
				If Over ".$day[$i]." Days
				then ".$action_out[array_search($com_action[$i], $action_in)].($com_action[$i] == '1' ?
					" ".$com_rate[$i]." % of commission rate" : NULL)."
			</div>";

			$tier_val = $day[$i];
		}
		$this->content['action'] = 'continue';
		$this->content['html']['tier_content_holder'.$this->popup_id] = $tbl . "
		<div style=\"padding-bottom:10px;\">
			If Over ".$this->form->text_box("name=day[]", "value=", "size=5", "style=text-align:right;")." Days
			then ".$this->form->select("com_action[]", $action_out, 1, $action_in, "blank=1", "onChange=if(this.options[this.selectedIndex].value==1){\$('rate_holder').style.visibility='visible';}else{\$('rate_holder').style.visibility='hidden'}")."&nbsp;
			<span id=\"rate_holder\" style=\"visibility:visible;\">".$this->form->text_box("name=com_rate[]", "value=", "size=5")."&nbsp;% of commission rate</span>
		</div>";
		$this->content['jscript'] = "toggle_display('commission_plus_btn".$this->popup_id."', 'block');";
		return;
	}

	function adjust_memo_cost() {
		$proposal_hash = $_POST['proposal_hash'];
		$memo_hash = $_POST['memo_hash'];
		$commission_hash = $_POST['commission_hash'];
		$recalc = $_POST['recalc'];

		//Array of all proposals to be paid commission on
		$proposal = $_POST['proposal'];
		while (list($tmp_proposal_hash, $on) = each($proposal)) {
			if ($on)
				$include_proposal[$tmp_proposal_hash] = 1;
		}
		$sales_array = $_POST['sales_array'];
		$commission_owed = $_POST['commission_owed'];
		$proposal_owner = $_POST['proposal_owner'];
		$sell = $_POST['total_sell'];
		$cost = $_POST['cost'];
		$received = $_POST['received'];
		$deposits = $_POST['deposits'];
		$commission_used = $_POST['commission_used'];
		$previous_commission_paid = $_POST['previous_commission_paid'];

		$sales_hash = $proposal_owner[$proposal_hash];
		while (list($tmp_proposal_hash, $dollars) = each($commission_owed)) {
			if ($include_proposal[$tmp_proposal_hash]) {
				if ((!$memo_hash || ($memo_hash && $proposal_hash != $tmp_proposal_hash)) && (!$recalc || ($recalc && $recalc != $tmp_proposal_hash)))
					$comm_array[$proposal_owner[$tmp_proposal_hash]] += preg_replace('/[^-.0-9]/', "", $dollars);

				$sell_array[$proposal_owner[$tmp_proposal_hash]] += $sell[$tmp_proposal_hash];
				$received_array[$proposal_owner[$tmp_proposal_hash]] += $received[$tmp_proposal_hash];
				$deposits_array[$proposal_owner[$tmp_proposal_hash]] += $deposits[$tmp_proposal_hash];
				for ($i = 0; $i < count($cost[$tmp_proposal_hash]); $i++)
					$cost_array[$proposal_owner[$tmp_proposal_hash]] += $cost[$tmp_proposal_hash][$i];
			}
		}
		if ($memo_hash || $recalc) {
			if ($recalc) {
				$proposal_hash = $recalc;
				$commission_hash = $commission_used[$proposal_hash];
			} else {
				$p = new payables($this->current_hash);
				$p->fetch_memo_cost_record($memo_hash);
				$memo_amount = $p->current_memo['amount'];

				$this->content['jscript'][] = "\$('memo_descr_$proposal_hash').insert( {bottom: '<div style=\"padding-bottom:3px;\">".$p->current_memo['descr']."</div>' });";
				$this->content['jscript'][] = "\$('memo_cost_$proposal_hash').insert( {bottom: '<div style=\"padding-bottom:3px;\">$".number_format($p->current_memo['amount'], 2).$this->form->hidden(array('cost['.$proposal_hash.'][]' => $p->current_memo['amount']))."</div>' });";
			}
			$proposal_cost_array = $cost[$proposal_hash];
			$proposal_sell = $sell[$proposal_hash];
			for ($i = 0; $i < count($proposal_cost_array); $i++)
				$proposal_cost += $proposal_cost_array[$i];

			if ($memo_hash) {
				$proposal_cost += $memo_amount;
				$cost_array[$proposal_owner[$proposal_hash]] += $memo_amount;
			}
			$profit = $proposal_sell - $proposal_cost;
			$previous = $previous_commission_paid[$proposal_hash];

			$s = new system_config($this->current_hash);
			$s->fetch_commission_record($commission_hash);
			$proposal_gp = math::gp_margin( array(
				'cost'   =>  $proposal_cost,
				'sell'   =>  $proposal_sell
			) );
			if ( bccomp($proposal_gp, 0, 4) == -1 ) {

				$proposal_gp = (float)bcmul($proposal_gp, -1, 4);
				$neg_gp = true;
			}

			while (list($tier, $rule_array) = each($s->current_commission['rules'])) {
				if ($proposal_gp >= $rule_array['tier_start'] && (floor($proposal_gp * 100) * .01) <= $rule_array['tier_end']) {
					if ($rule_array['tier_action'] == 'P') {
						$com_rate = _round($proposal_gp, 4);
						$com_due = _round(($proposal_sell - $proposal_cost) * $com_rate, 2);
						if ($previous)
							$com_due -= $previous;
					} elseif ($rule_array['tier_action'] == 1) {
						$com_rate = $rule_array['tier_rate'];
						$com_due = _round(($proposal_sell - $proposal_cost) * $com_rate, 2);
						if ($previous)
							$com_due -= $previous;
					}
				}
			}

			if ( $neg_gp ) {

				$proposal_gp = (float)bcmul($proposal_gp, -1, 4);
				$com_rate = (float)bcmul($com_rate, -1, 4);
			}
			$comm_array[$proposal_owner[$proposal_hash]] += $com_due;
			$this->content['html']['total_cost_'.$proposal_hash] = ($proposal_cost < 0 ? "<span style=\"color:#ff0000;\">($".number_format($proposal_cost * -1, 2).")</span>" : "$".number_format($proposal_cost, 2));
			$this->content['html']['total_gp_'.$proposal_hash] = (defined('MARGIN_FLAG') && $proposal_gp < MARGIN_FLAG ? "<span style=\"color:#ff0000;\">".($proposal_gp * 100)."%</span>" : ($proposal_gp * 100)."%");
			$this->content['html']['total_profit_'.$proposal_hash] = ($profit < 0 ? "<span style=\"color:#ff0000;\">($".number_format($profit * -1, 2).")</span>" : "$".number_format($profit, 2));
			$this->content['html']['commission_rate_'.$proposal_hash] = ($com_rate * 100)."%";
			$this->content['value']['commission_owed_'.$proposal_hash] = number_format($com_due, 2);
		}

		//Sales Rep Totals
		while (list($sales_hash, $on) = each($sales_array)) {
			$current_commission = $_POST['current_commission_'.$sales_hash];
			$current_cost = $_POST['current_cost_'.$sales_hash];
			if (bccomp($current_commission, $comm_array[$sales_hash]) != 0 || bccomp($current_cost, $cost_array[$sales_hash]) != 0) {

				$_margin = math::gp_margin( array(
					'cost'  =>  $cost_array[ $sales_hash ],
					'sell'  =>  $sell_array[ $sales_hash ]
				) );

				$update = true;
				$this->content['html']['total_commission_'.$sales_hash] = $this->form->hidden(array('current_commission_'.$sales_hash => $comm_array[$sales_hash])).($comm_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format($comm_array[$sales_hash], 2).")</span>" : "$".number_format($comm_array[$sales_hash], 2));
				$this->content['html']['total_invoiced_'.$sales_hash] = ($sell_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format($sell_array[$sales_hash] * -1, 2).")</span>" : "$".number_format($sell_array[$sales_hash], 2));
				$this->content['html']['total_received_'.$sales_hash] = ($received_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format($received_array[$sales_hash] * -1, 2).")</span>" : "$".number_format($received_array[$sales_hash], 2));
				$this->content['html']['total_deposits_'.$sales_hash] = ($deposits_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format($deposits_array[$sales_hash] * -1, 2).")</span>" : "$".number_format($deposits_array[$sales_hash], 2));
				$this->content['html']['total_cost_'.$sales_hash] = $this->form->hidden(array('current_cost_'.$sales_hash => $cost_array[$sales_hash])).($cost_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format($cost_array[$sales_hash] * -1, 2).")</span>" : "$".number_format($cost_array[$sales_hash], 2));
				$this->content['html']['total_profit_'.$sales_hash] = ($sell_array[$sales_hash] - $cost_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format(($sell_array[$sales_hash] - $cost_array[$sales_hash]) * -1, 2).")</span>" : "$".number_format($sell_array[$sales_hash] - $cost_array[$sales_hash], 2));
				$this->content['html']['total_gp_'.$sales_hash] =
				( bccomp($cost_array[ $sales_hash ], 0, 4) && bccomp($sell_array[ $sales_hash ], 0, 4) ?
    				( defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 ?
        				"<span style=\"color:#ff0000;\">" . (float)bcmul($_margin, 100, 4) . "%</span>" : (float)bcmul($_margin, 100, 4) . "%"
	    			) : "&nbsp;"
    			);
			}
		}

		$_margin = math::gp_margin( array(
			'cost'    =>  array_sum($cost_array),
			'sell'    =>  array_sum($sell_array)
		) );

		//Grand Totals
		//if ($update) {
			$this->content['html']['total_invoiced'] = "$".number_format(array_sum($sell_array), 2);
			$this->content['html']['total_received'] = "$".number_format(array_sum($received_array), 2);
			$this->content['html']['total_deposits'] = "$".number_format(array_sum($deposits_array), 2);
			$this->content['html']['total_commission'] = "$".number_format(array_sum($comm_array), 2);
			$this->content['html']['total_cost'] = "$".number_format(array_sum($cost_array), 2);
			$this->content['html']['total_profit'] = (array_sum($sell_array) - array_sum($cost_array) < 0 ? "<span style=\"color:#ff0000;\">($".number_format(array_sum($sell_array) - array_sum($cost_array), 2).")</span>" : "$".number_format(array_sum($sell_array) - array_sum($cost_array), 2));
			$this->content['html']['total_margin'] =
			( defined('MARGIN_FLAG') && bccomp($_margin, MARGIN_FLAG, 4) == -1 ?
    			"<span style=\"color:#ff0000;\">" . (float)bcmul($_margin, 100, 4) . "%</span>" : (float)bcmul($_margin, 100, 4) . "%"
			);
		//}
		if (!$recalc)
			$this->content['jscript'][] = "\$('recalc_btn').disabled=0;";

		$this->content['action'] = 'continue';
		return;
	}

	function post_commission() {
		$report_hash = $_POST['report_hash'];
		$this->fetch_report_settings($report_hash);

		$req = $this->current_report['req'];
		if (@in_array("IIP", $req))
			$req_invoiced = 1;

		if (@in_array("IIF", $req))
			$sql_h[] = "total_uninvoiced_lines = 0";

		if (@in_array("PIF", $req))
			$sql_h[] = "total_amount_received >= total_amount_invoiced";

		if ($sql_h)
			$having = implode(" AND ", $sql_h);

		$sales_array = $_POST['sales_array'];

		//Array of all proposals to be paid commission on
		$proposal = $_POST['proposal'];
		$sales_array = $_POST['sales_array'];
		$commission_owed = $_POST['commission_owed'];
		$paid_in_full = $_POST['paid_in_full'];
		$commission_rate = $_POST['commission_rate'];
		$proposal_owner = $_POST['proposal_owner'];
		$sell = $_POST['total_sell'];
		$cost = $_POST['cost'];
		$received = $_POST['received'];
		$commission_used = $_POST['commission_used'];
		$pay_date = $_POST['pay_date'];
		$previous_commission_paid = $_POST['previous_commission_paid'];

		while (list($tmp_proposal_hash, $on) = each($proposal)) {
			if ($on) {
				$proposal_commission = preg_replace('/[^-.0-9]/', "", $commission_owed[$tmp_proposal_hash]);
				$previous_commission = preg_replace('/[^-.0-9]/', "", $previous_commission_paid[$tmp_proposal_hash]);
				$comm_array[$proposal_owner[$tmp_proposal_hash]] += $proposal_commission;
				$sell_array[$proposal_owner[$tmp_proposal_hash]] += $sell[$tmp_proposal_hash];
				$received_array[$proposal_owner[$tmp_proposal_hash]] += $received[$tmp_proposal_hash];
				for ($i = 0; $i < count($cost[$tmp_proposal_hash]); $i++)
					$cost_array[$proposal_owner[$tmp_proposal_hash]] += $cost[$tmp_proposal_hash][$i];

				$commission_hash = md5(global_classes::get_rand_id(32, "global_classes"));
				while (global_classes::key_exists('commissions_paid', 'commission_hash', $commission_hash))
					$commission_hash = md5(global_classes::get_rand_id(32, "global_classes"));

				$result = $this->db->query("SELECT line_items.item_hash , commissions_paid.cost , commissions_paid.commission_hash ,
											(
												SELECT SUM(customer_invoice.amount - customer_invoice.balance)
												FROM `customer_invoice`
												WHERE `proposal_hash` = '$tmp_proposal_hash' AND `type` = 'I' AND customer_invoice.deleted = 0
											) AS total_amount_received ,
											(
												SELECT SUM(customer_invoice.amount - customer_invoice.tax)
												FROM `customer_invoice`
												WHERE `proposal_hash` = '$tmp_proposal_hash' AND `type` = 'I' AND customer_invoice.deleted = 0
											) AS total_amount_invoiced ,
											(
												SELECT SUM(customer_invoice.amount)
												FROM `customer_invoice`
												WHERE `proposal_hash` = '$tmp_proposal_hash' AND `type` = 'D' AND customer_invoice.deleted = 0
											) AS total_deposits_received ,
											(
												SELECT COUNT(line_items.obj_id)
												FROM `line_items`
												WHERE `proposal_hash` = '$tmp_proposal_hash'
											) AS total_line_items ,
											(
												SELECT COUNT(line_items.obj_id)
												FROM `line_items`
												WHERE `proposal_hash` = '$tmp_proposal_hash' AND `invoice_hash` = ''
											) AS total_uninvoiced_lines
											FROM line_items
											LEFT JOIN commissions_paid ON commissions_paid.commission_hash = line_items.commission_hash
											WHERE line_items.proposal_hash = '$tmp_proposal_hash' AND (commissions_paid.paid_in_full = 0 OR ISNULL(commissions_paid.commission_hash)) AND line_items.status > 0 ".($req_invoiced ? "AND line_items.invoice_hash != ''" : NULL).($having ? "
											HAVING ".$having : NULL));
				while ($row = $this->db->fetch_assoc($result)) {
					if ($row['commission_hash'])
						$commission_exists = $commission_hash = $row['commission_hash'];

					if (!$row['commission_hash'])
						$this->db->query("UPDATE `line_items`
										  SET `commission_hash` = '$commission_hash'
										  WHERE `item_hash` = '".$row['item_hash']."'");
				}
				if ($commission_exists) {
					if ($previous_commission != 0)
						$proposal_commission += $previous_commission;

					$this->db->query("UPDATE `commissions_paid`
									  SET `timestamp` = ".time()." , `last_change` = '".$this->current_hash."' , `paid_date` = '$pay_date' ,
									  `paid_in_full` = '".$paid_in_full[$tmp_proposal_hash]."' , `rate` = '".$commission_rate[$tmp_proposal_hash]."' ,
									  `amount` = '$proposal_commission' , ".($previous_commission ? "`previous_amount` = '$previous_commission' , " : NULL)." `cost` = '".@array_sum($cost[$tmp_proposal_hash])."'
									  WHERE `commission_hash` = '$commission_exists'");
				} else
					$this->db->query("INSERT INTO `commissions_paid`
									  (`timestamp` , `last_change` , `paid_date` , `proposal_hash` , `commission_hash` , `paid_in_full` , `rate` , `user_hash` , `amount` , `cost`)
									  VALUES (".time()." , '".$this->current_hash."' , '$pay_date' , '$tmp_proposal_hash' , '$commission_hash' , '".$paid_in_full[$tmp_proposal_hash]."' , '".$commission_rate[$tmp_proposal_hash]."' , '".$proposal_owner[$tmp_proposal_hash]."' , '$proposal_commission' , '".@array_sum($cost[$tmp_proposal_hash])."')");

			}
		}
		reset($comm_array);

		$sum_tbl = "
		<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"width:100%;margin-top:0;\">
			<tr style=\"background-color:#efefef;\">
				<td style=\"padding:5px;font-weight:bold;border-bottom:1px solid #cccccc;width:80%;\">Sales Rep</td>
				<td style=\"vertical-align:bottom;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Commission Paid</td>
			</tr>";
		while (list($sales_hash, $on) = each($sales_array)) {
			$sum_tbl .= "
			<tr>
				<td style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;\">".stripslashes($this->user_name($sales_hash))."</td>
				<td style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;\" class=\"num_field\">$".number_format($comm_array[$sales_hash], 2)."</td>
			</tr>";
			$total_commission += $comm_array[$sales_hash];
		}
		$sum_tbl .= "
			<tr>
				<td style=\"background-color:#efefef;padding-left:50px;\">&nbsp;</td>
				<td style=\"font-weight:bold;background-color:#efefef;\" class=\"num_field\">
					<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
						$".number_format($total_commission, 2)."
					</div>
				</td>
			</tr>
		</table>";

		$sum_tbl = "
		<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
			<tr>
				<td style=\"width:100%;background-color:#ffffff;padding:10px;\">
					<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
						".($this->current_report['saved'] ?
							$this->current_report['report_name'] : "Commission Report Summary")."
					</h3>
					<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
				</td>
			</tr>
			<tr>
				<td style=\"width:100%;background-color:#ffffff;padding:10px;\">".$sum_tbl."</td>
			</tr>
		</table>";
		$this->content['html']['place_holder'] = $sum_tbl;
		$this->content['action'] = 'continue';
		return;
	}

	function doit_job_costing($local=NULL) {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$timeframe = $this->current_report['timeframe'];
			$sort_from_date = $this->current_report['sort_from_date'];
			$sort_to_date = $this->current_report['sort_to_date'];

			$sales_rep_match = $this->current_report['sales_rep_match'];
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);

			$customer_filter = $this->current_report['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);

			$proposal_filter = $this->current_report['proposal_filter'];
			if ($proposal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);
		} else {
			$timeframe = $_POST['timeframe'];
			$sort_from_date = $_POST['sort_from_date'];
			$sort_to_date = $_POST['sort_to_date'];

			$sales_rep_match = $_POST['sales_rep_match'];
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);

			$customer_filter = $_POST['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);

			$proposal_filter = $_POST['proposal_filter'];
			if ($proposal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);
		}
		$save = $_POST['save'];
		$saved_cat = "job_costing";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		if ((($timeframe == 25 || $timeframe == 26 || $timeframe == 27) && !$sort_from_date) || (($timeframe == 25 || $timeframe == 26 || $timeframe == 27) && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}

		switch ($timeframe) {
			//booked this month
			case 1:

			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-".date("t"))."'";
			break;
			//invoiced this month
			case 2:

			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-".date("t"))."'";
			break;
			//created this month
			case 3:
			$sql_p[] = "proposals.creation_date BETWEEN '".strtotime(date("Y-m-01"))."' AND '".strtotime(date("Y-m-".date("t")))."'";
			break;
			//booked last month
			case 4:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}

			$sql_p[] = "purchase_order.po_date BETWEEN '".$year."-".$month."-01' AND '".$year."-".$month."-".date("t", strtotime($year."-".$month."-01"))."'";
			break;
			//invoiced last month
			case 5:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}

			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$year."-".$month."-01' AND '".$year."-".$month."-".date("t", strtotime($year."-".$month."-01"))."'";
			break;
			//created last month
			case 6:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}
			$sql_p[] = "proposals.creation_date BETWEEN '".strtotime($year."-".$month."-01")."' AND '".strtotime($year."-".$month."-".date("t", strtotime($year."-".$month."-01")))."'";
			break;
			//booked this quarter
			case 7:

			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start, $end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "purchase_order.po_date BETWEEN '".$start."' AND '".$end."'";
			break;
			//invoiced this quarter
			case 8:

			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start, $end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$start."' AND '".$end."'";
			break;
			//created this quarter
			case 9:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start, $end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "proposals.creation_date BETWEEN '".strtotime($start)."' AND '".strtotime($end)."'";
			break;
			//Booked last quarter
			case 10:

			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start, $end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "purchase_order.po_date BETWEEN '".$start."' AND '".$end."'";
			break;
			//invoiced last quarter
			case 11:

			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start, $end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$start."' AND '".$end."'";
			break;
			//created last quarter
			case 12:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start, $end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "customer_invoice.creation_date BETWEEN '".strtotime($start)."' AND '".strtotime($end)."'";
			break;
			//booked this period
			case 13:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			//invoiced this period
			case 14:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			//created this period
			case 15:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "proposals.creation_date BETWEEN '".strtotime($period_info['period_start'])."' AND '".strtotime($period_info['period_end'])."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			//booked last period
			case 16:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			//invoiced last period
			case 17:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			//created last period
			case 18:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = "proposals.creation_date BETWEEN '".strtotime($period_info['period_start'])."' AND '".strtotime($period_info['period_end'])."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			//booked this year
			case 19:

			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			break;
			//invoiced this year
			case 20:

			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			break;
			//created this year
			case 21:
			$sql_p[] = "proposals.creation_date BETWEEN '".strtotime(date("Y-01-01"))."' AND '".strtotime(date("Y-12-31"))."'";
			break;
			//booked last year
			case 22:

			$sql_p[] = "purchase_order.po_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			break;
			//invoiced last year
			case 23:

			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			break;
			//created last year
			case 24:
			$sql_p[] = "proposals.creation_date BETWEEN '".date("Y-01-01", strtotime(date("Y-m-d")." -1 year"))."' AND '".date("Y-12-31", strtotime(date("Y-m-d")." -1 year"))."'";
			break;

			// Booked between specific dates
			case 25:
			$this->report_date_start = $sort_from_date;
			$this->report_date_end = $sort_to_date;
			if ($sort_from_date && $sort_to_date)
				$sql_p[] = "purchase_order.po_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
			else
				$sql_p[] = "purchase_order.po_date >= '".$sort_from_date."'";
			break;

			// Invoiced between specific dates
			case 26:
			$this->report_date_start = $sort_from_date;
			$this->report_date_end = $sort_to_date;
			if ($sort_from_date && $sort_to_date)
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
			else
				$sql_p[] = "customer_invoice.invoice_date >= '".$sort_from_date."'";
			break;

			// Created between specific dates
			case 27:
			$this->report_date_start = $sort_from_date;
			$this->report_date_end = $sort_to_date;
			if ($sort_from_date && $sort_to_date)
				$sql_p[] = "proposals.creation_date BETWEEN '".strtotime($sort_from_date)."' AND '".strtotime($sort_to_date)."'";
			else
				$sql_p[] = "proposals.creation_date >= '".strtotime($sort_from_date)."'";
			break;
		}

		if ($this->content['error'])
			return;

		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match, 'add_quotes', "'");
			$sql_p[] = "proposals.sales_hash IN (".implode(" , ", $sales_rep_match).")";
			array_walk($sales_rep_match, 'strip_quotes');
		}
        if (is_array($customer_filter) && count($customer_filter)) {
			array_walk($customer_filter, 'add_quotes', "'");
			$sql_p[] = "proposals.customer_hash IN (".implode(" , ", $customer_filter).")";
			array_walk($customer_filter, 'strip_quotes');
		}
		if (is_array($proposal_filter) && count($proposal_filter)) {
			array_walk($proposal_filter, 'add_quotes', "'");
			$sql_p[] = "proposals.proposal_hash IN (".implode(" , ", $proposal_filter).")";
			array_walk($proposal_filter, 'strip_quotes');
		}
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);
		if ($sql_h)
			$having = implode(" AND ", $sql_h);

		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|proposal_filter=".implode("&", $proposal_filter)."|customer_filter=".implode("&", $customer_filter)."|sales_rep_match=".@implode("&", $sales_rep_match);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT proposals.proposal_no, proposals.proposal_hash AS parent_proposal_hash ,
									proposals.proposal_descr, users.full_name,
									proposals.sales_hash , proposals.customer_hash , customers.gsa , customers.customer_name ,
									customer_invoice.invoice_hash as parent_invoice_hash ,
									(
										SELECT SUM(customer_invoice.amount - customer_invoice.balance)
										FROM `customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I' AND customer_invoice.deleted = 0
									) AS total_amount_received ,
									(
										SELECT SUM(customer_invoice.amount)
										FROM `customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'D' AND customer_invoice.deleted = 0
									) AS total_deposit_received ,
									(
										SELECT SUM(customer_invoice.amount)
										FROM `customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I' AND customer_invoice.deleted = 0
									) AS total_amount_invoiced ,
									COUNT(line_items.invoice_hash) AS total_line_items ,
									(
									SELECT COUNT(*)
									FROM `line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND `invoice_hash` = ''
									) AS total_uninvoiced_lines ,
									vendor_products.product_name , vendor_products.product_hash as parent_product_hash ,
									(
									SELECT SUM(line_items.cost * line_items.qty)
									FROM `line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND
									CASE
									WHEN ISNULL(parent_product_hash)
										THEN ISNULL(`product_hash`)
									ELSE `product_hash` = parent_product_hash
									END
									) AS total_product_cost ,
									(
										SELECT SUM(vp.amount)
										FROM vendor_payables vp
										LEFT JOIN purchase_order po
										ON vp.po_hash = po.po_hash
										WHERE po.proposal_hash = parent_proposal_hash AND vp.deleted = 0 and vp.type = 'C'
                                    ) AS total_product_credits ,
									(
									SELECT SUM(line_items.sell * line_items.qty)
									FROM `line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND
									CASE
									WHEN ISNULL(parent_product_hash)
										THEN ISNULL(`product_hash`)
									ELSE `product_hash` = parent_product_hash
									END
									) AS total_product_sell ,
									(
									SELECT SUM(vendor_payables.amount)
									FROM `vendor_payables`
									LEFT JOIN `purchase_order` ON purchase_order.po_hash = vendor_payables.po_hash AND purchase_order.deleted = 0
									WHERE purchase_order.proposal_hash = parent_proposal_hash AND vendor_payables.deleted = 0
									) AS total_payables_received
									FROM line_items
									LEFT JOIN proposals ON proposals.proposal_hash = line_items.proposal_hash
									LEFT JOIN customer_invoice ON customer_invoice.invoice_hash = line_items.invoice_hash AND customer_invoice.deleted = 0
									LEFT JOIN purchase_order ON purchase_order.po_hash = line_items.po_hash AND purchase_order.deleted = 0
									LEFT JOIN vendor_products ON vendor_products.product_hash = line_items.product_hash
									LEFT JOIN customers ON customers.customer_hash = proposals.customer_hash
									LEFT JOIN users ON users.id_hash = proposals.sales_hash".($sql ? "
									WHERE ".$sql : NULL)."
									GROUP BY line_items.proposal_hash , line_items.product_hash".($having ? " HAVING ".$having : NULL));
		while ($row = $this->db->fetch_assoc($result)) {
			if ($row['total_line_items'] > 0)
				$this->results[$row['sales_hash']][$row['parent_proposal_hash']][] = $row;
		}
		$this->overhead_record = array();
		$this->commission_rule = array();

		$sys_config = new system_config($this->current_hash);
		if (is_array($this->results)) {
			reset($this->results);
			while (list($sales_hash, $proposal_array) = each($this->results)) {
				while (list($proposal_hash, $detail) = each($proposal_array)) {
					unset($overhead);
					$result = $this->db->query("SELECT `overhead_hash` , `type`
												FROM `overhead_rules`
												WHERE `active` = 1
												  AND (('".date("Y-m-d")."' BETWEEN `effective_date` AND `expiration_date`) OR (`effective_date` = '' AND `expiration_date` = '') OR (`effective_date` != '' AND ".date("Y-m-d")." >= `effective_date`) OR (`expiration_date` != '' AND ".date("Y-m-d")." <= `expiration_date`))
												  AND ((`type` = 'C' AND `customer_hash` = '".$detail[0]['customer_hash']."') ".($detail[0]['gsa'] ? "
													  OR `type` = 'G'" : NULL)."
														   OR `type` = 'D')");
					while ($row = $this->db->fetch_assoc($result))
						$overhead[$row['type']] = $row;

					if ($overhead['C'])
						$overhead_hash = $overhead['C']['overhead_hash'];
					elseif ($overhead['G'])
						$overhead_hash = $overhead['G']['overhead_hash'];
					elseif ($overhead['D'])
						$overhead_hash = $overhead['D']['overhead_hash'];

					if ($overhead_hash) {
						if (!$this->overhead_record[$overhead_hash]) {
							$sys_config->fetch_overhead_record($overhead_record);
							$this->overhead_record[$overhead_record] = $sys_config->current_overhead;
						}

						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$this->overhead_record[$overhead_record]['rate'],
																				'apply_to'	=>	$this->overhead_record[$overhead_record]['apply_to']);
					} elseif (defined('OVERHEAD_TYPE')) {
						$overhead_rate = (float)OVERHEAD_RATE;

						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$overhead_rate,
																				'apply_to'	=>	OVERHEAD_TYPE);
					}
					//Get any memo costs
					unset($memo);
					$result = $this->db->query("SELECT *
												FROM `memo_costs`
												WHERE `proposal_hash` = '$proposal_hash' AND deleted = 0");
					while ($row = $this->db->fetch_assoc($result))
						$memo[] = $row;

					if ($memo)
						$this->results_misc[$proposal_hash]['MEMO'] = $memo;

					//Get any job costs
					unset($job_cost);
					$result = $this->db->query("SELECT *
												FROM vendor_payable_expenses t1
					                            LEFT JOIN vendor_payables t2 ON t2.invoice_hash = t1.invoice_hash
												WHERE t1.proposal_hash = '$proposal_hash' AND t2.deleted = 0");
					while ($row = $this->db->fetch_assoc($result))
						$job_cost[] = $row;

					if ($job_cost)
						$this->results_misc[$proposal_hash]['JOB_COST'] = $job_cost;

				}
			}
		}
		$this->content['action'] = 'close';

		$this->total = count($this->results);
		if ($local)
			return true;
		else
			$this->content['html']['place_holder'] = $this->job_costing(1);
		return;
	}


	function job_costing($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => '', 'report_hash' => $this->report_hash))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Job Costing Report").($this->p->ck('reports', 'V', 'job_costing') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'job_costing', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:350px;text-align:left;padding-left:50px;\">Product</td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
				</tr>";
			$customers = new customers($this->current_hash);
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				reset($this->results);
				while (list($sales_hash, $proposal_array) = each($this->results)) {
					unset($inner_tbl);
					$sales_commission = $total_invoiced = $total_received = $total_sales_cost = $total_deposits = $k = 0;
					while (list($proposal_hash, $product_array) = each($proposal_array)) {
						$inner_tbl .= ($k > 0 ?"
						<tr>
							<td colspan=\"5\" style=\"background-color:#cccccc;\"></td>
						</tr>" : NULL)."
						<tr>
							<td colspan=\"5\" style=\"font-size:8pt;background-color:#ffffff;padding-left:25px;padding-top:5px;\">
								Proposal: <a href=\"javascript:void(0);\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$proposal_hash."', 'popup_id=proposal_win', 'from_report=1');\" title=\"View proposal\" class=\"link_standard\">".$product_array[0]['proposal_no']."</a> - ".$product_array[0]['proposal_descr']."
								<div style=\"padding-top:5px;\">".stripslashes($product_array[0]['customer_name'])."</div>
							</td>
						</tr>";
						$k++;
						$total_sell = $total_cost = $total_profit = 0;
						for ($i = 0; $i < count($product_array); $i++) {

							$_margin = math::gp_margin( array(
    							'cost'   =>  $product_array[$i]['total_product_cost'],
    							'sell'   =>  $product_array[$i]['total_product_sell']
							) );

							$inner_tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">" . ( $product_array[$i]['product_name'] ? stripslashes($product_array[$i]['product_name']) : "Miscellaneous")."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($product_array[$i]['total_product_sell'], 2)."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($product_array[$i]['total_product_cost'], 2)."</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;".($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost'] < 0 ? "color:#ff0000;" : NULL)."\">".($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost']  < 0 ? "
									($".number_format(($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost']) * -1, 2).")" : "$".number_format($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost'], 2))."
								</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;" .
    							( defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) ?
        							"color:red;" : NULL
    							) . "\">" . (float)bcmul($_margin, 100, 4) . "%
    							</td>
							</tr>";

							$total_sell = bcadd($total_sell, $product_array[$i]['total_product_sell'], 2);
							$total_cost = bcadd($total_cost, $product_array[$i]['total_product_cost'], 2);
						}


						// Reduce costs if credits are applied to po #1449
						if ($product_array[0]['total_product_credits']) {
							$inner_tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">Credits Deducted From POs</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
								<td style=\"font-size:8pt;background-color:#ffffff;color:red;\" class=\"num_field\">($".number_format($product_array[0]['total_product_credits'], 2).")</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
							</tr>";
							$total_cost -= $product_array[0]['total_product_credits'];
						}
						if ($this->results_misc[$proposal_hash]['OVERHEAD'] && $this->results_misc[$proposal_hash]['OVERHEAD']['rate']) {
							if ($this->results_misc[$proposal_hash]['OVERHEAD']['apply_to'] == 'C')
								$overhead_factor = _round($total_cost * $this->results_misc[$proposal_hash]['OVERHEAD']['rate'], 2);
							elseif ($this->results_misc[$proposal_hash]['OVERHEAD']['apply_to'] == 'S')
								$overhead_factor = _round($total_sell * $this->results_misc[$proposal_hash]['OVERHEAD']['rate'], 2);

							$inner_tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">Company Overhead Factor</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($overhead_factor, 2)."</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
							</tr>";
							$total_cost += $overhead_factor;
						}
						if ($this->results_misc[$proposal_hash]['MEMO']) {
							for ($i = 0; $i < count($this->results_misc[$proposal_hash]['MEMO']); $i++) {
								$inner_tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".(strlen($this->results_misc[$proposal_hash]['MEMO'][$i]['descr']) > 45 ?
										substr($this->results_misc[$proposal_hash]['MEMO'][$i]['descr'], 0, 42)."..." : $this->results_misc[$proposal_hash]['MEMO'][$i]['descr'])."
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($this->results_misc[$proposal_hash]['MEMO'][$i]['amount'], 2)."</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								</tr>";
								$total_cost += $this->results_misc[$proposal_hash]['MEMO'][$i]['amount'];
							}
						}
						if ($this->results_misc[$proposal_hash]['JOB_COST']) {
							for ($i = 0; $i < count($this->results_misc[$proposal_hash]['JOB_COST']); $i++) {
								$inner_tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".(strlen($this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo']) > 45 ?
										substr($this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo'], 0, 42)."..." : $this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo'])."
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($this->results_misc[$proposal_hash]['JOB_COST'][$i]['amount'], 2)."</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								</tr>";
								$total_cost += $this->results_misc[$proposal_hash]['JOB_COST'][$i]['amount'];
							}
						}

						$blended_gp = math::gp_margin( array(
							'cost'    =>  $total_cost,
							'sell'    =>  $total_sell
						) );
						$inner_tbl .= "
						<tr >
							<td style=\"background-color:#ffffff;padding-left:50px;\"></td>
							<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_sell_".$proposal_hash."\">
									$".number_format($total_sell, 2)."
								</div>
							</td>
							<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_cost_".$proposal_hash."\">
									$".number_format($total_cost, 2)."
								</div>
							</td>
							<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_profit_".$proposal_hash."\">".($total_sell - $total_cost < 0 ?
									"<span style=\"color:#ff0000;\">($".number_format(($total_sell - $total_cost) * -1, 2).")</span>" : "$".number_format($total_sell - $total_cost, 2))."
								</div>
							</td>
							<td class=\"num_field\" class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_gp_".$proposal_hash."\">" .
								( defined('MARGIN_FLAG') && bccomp($blended_gp, (float)MARGIN_FLAG, 4) == -1 ?
									"<span style=\"color:#ff0000;\">" . (float)bcmul($blended_gp, 100, 4) . "%</span>" : (float)bcmul($blended_gp, 100, 4) . "%"
								) . "
								</div>
							</td>
						</tr>
						<tr>
							<td style=\"padding-bottom:15px;padding-top:8px;background-color:#ffffff;font-size:8pt;padding-left:25px;\" colspan=\"5\">
								<div style=\"margin-bottom:5px;\" >
									Net Invoiced: <span id=\"net_invoiced_".$proposal_hash."\">$".number_format($product_array[0]['total_amount_invoiced'], 2)."</span>
									&nbsp;&nbsp;
									Received: $".number_format($product_array[0]['total_amount_received'], 2)."
								</div>
							</td>
						</tr>";

						$total_invoiced += $total_sell;
						$total_received += $product_array[0]['total_amount_received'];
						$sales_commission += ($com_due - $product_array[0]['previous_commission_paid']);
						$total_sales_cost += $total_cost;
					}
					if ($inner_tbl) {
						$tbl .= "
						<tr style=\"background-color:#efefef;\">
							<td style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".stripslashes($this->user_name($sales_hash))."</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Sell</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Cost</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>
						</tr>"
						. $inner_tbl;
						$sales_commission_array[$sales_hash] = array('full_name'			=>	$this->user_name($sales_hash),
																     'total_invoiced' 	    =>	$total_invoiced,
																     'total_received'		=>  $total_received,
																     'total_cost'			=>	$total_sales_cost,
																     'total_profit'			=>  ($total_invoiced - $total_cost),
																     'total_commission'		=>  $sales_commission);
					}
				}

				$tbl .= "
				<tr>
					<td style=\"background-color:#ffffff;\" colspan=\"5\">
						<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"width:100%;margin-top:0;\">
							<tr style=\"background-color:#efefef;\">
								<td style=\"padding:5px;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\">Sales Rep</td>
								<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Net Invoiced</td>
								<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Received</td>
								<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Actual Cost</td>
								<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
								<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>

							</tr>";
						while (list($sales_hash, $sales_array) = each($sales_commission_array)) {

							$_margin = math::gp_margin( array(
    							'cost'   =>  $sales_array['total_cost'],
    							'sell'   =>  $sales_array['total_invoiced']
							) );

							$tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;\">".$sales_array['full_name']."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_invoiced_".$sales_hash."\">$".number_format($sales_array['total_invoiced'], 2)."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_received_".$sales_hash."\">$".number_format($sales_array['total_received'], 2)."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_cost_".$sales_hash."\">"."$".number_format($sales_array['total_cost'], 2)."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_profit_".$sales_hash."\">".($sales_array['total_invoiced'] - $sales_array['total_cost'] < 0 ?
									"<span style=\"color:#ff0000;\">($".number_format(($sales_array['total_invoiced'] - $sales_array['total_cost']), 2).")" : "$".number_format(($sales_array['total_invoiced'] - $sales_array['total_cost']), 2))."
								</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_gp_".$sales_hash."\">" .
    							( defined('MARGIN_FLAG') && bccomp($_margin, MARGIN_FLAG, 4) == -1 ?
									"<span style=\"color:#ff0000;\">" . (float)bcmul($_margin, 100, 4) . "%</span>" : (float)bcmul($_margin, 100, 4) . "%"
    							) . "
								</td>
							</tr>";

							$total_net_invoiced += $sales_array['total_invoiced'];
							$total_net_received += $sales_array['total_received'];
							$total_net_cost += $sales_array['total_cost'];
							$total_net_deposits += $sales_array['total_deposits'];
						}

						$_margin = math::gp_margin( array(
							'cost'    =>  $total_net_cost,
							'sell'    =>  $total_net_invoiced
						) );

						$tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">&nbsp;</td>
								<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_invoiced\">
										$".number_format($total_net_invoiced, 2)."
									</div>
								</td>
								<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_received\">
										$".number_format($total_net_received, 2)."
									</div>
								</td>
								<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_cost\">
										$".number_format($total_net_cost, 2)."
									</div>
								</td>
								<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_profit\">".($total_net_invoiced - $total_net_cost < 0 ?
										"<span style=\"color:#ff0000;\">($".number_format($total_net_invoiced - $total_net_cost, 2).")</span>" : "$".number_format($total_net_invoiced - $total_net_cost, 2))."
									</div>
								</td>
								<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_margin\">" .
            						( defined('MARGIN_FLAG') && bccomp($_margin, MARGIN_FLAG, 4) == -1 ?
										"<span style=\"color:#ff0000;\">" . (float)bcmul($_margin, 100, 4) . "%</span>" : (float)bcmul($_margin, 100, 4) . "%"
            						) . "
									</div>
								</td>
							</tr>
						</table>
					</td>
				</tr>";
			}
			if (!$this->results)
				$tbl .= "
				<tr>
					<td colspan=\"5\" style=\"padding:25px 0px 5px 5px;background-color:#ffffff;\">Your commission report is empty.</td>
				</tr>";

			$tbl .= "
			</table>".$this->form->close_form();

			return $tbl;
		} else {

			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			$tbl = $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_job_costing');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_job_costing', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Job Costing Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("Proposals Booked This Month",
																    	  "Proposals Invoiced This Month",
																    	  "Proposals Created This Month",
																    	  "Proposals Booked Last Month",
																          "Proposals Invoiced Last Month",
																    	  "Proposals Created Last Month",
																    	  "Proposals Booked This Quarter",
																    	  "Proposals Invoiced Quarter",
																    	  "Proposals Created Quarter",
																    	  "Proposals Booked Last Quarter",
																          "Proposals Invoiced Last Quarter",
																    	  "Proposals Created Last Quarter",
																    	  "Proposals Booked This Period",
																    	  "Proposals Invoiced This Period",
																    	  "Proposals Created This Period",
																    	  "Proposals Booked Last Period",
																    	  "Proposals Invoiced Last Period",
																    	  "Proposals Created Last Period",
																    	  "Proposals Booked This Year",
																    	  "Proposals Invoiced This Year",
																      	  "Proposals Created This Year",
																    	  "Proposals Booked Last Year",
																      	  "Proposals Invoiced Last Year",
																    	  "Proposals Created Last Year",
																    	  "Proposals Booked Within a specific date range",
																          "Proposals Invoiced Within a specific date range",
																    	  "Proposals Created Within a specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9,
																		  10,
																		  11,
																		  12,
																		  13,
																		  14,
																		  15,
																		  16,
																		  17,
																		  18,
																		  19,
																		  20,
																		  21,
																		  22,
																		  23,
																		  24,
																		  25,
																		  26,
																		  27), "onChange=if(this.options[this.selectedIndex].value==25||this.options[this.selectedIndex].value==26||this.options[this.selectedIndex].value==27){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 25 || $this->current_report['timeframe'] == 26 || $this->current_report['timeframe'] == 27 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 25 || $this->current_report['timeframe'] == 26 || $this->current_report['timeframe'] == 27 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 25 || $this->current_report['timeframe'] == 26 || $this->current_report['timeframe'] == 27 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]", $this->sales_name, (is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')), $this->sales_hash, "multiple", "blank=1", "size=4", "style=width:200px;", ($this->p->ck('proposals', 'S') ? "disabled" : NULL))."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=proposal",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
												if (is_array($this->current_report['proposal_filter'])) {
													for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++)
														$tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function commissions_paid_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => '', 'report_hash' => $this->report_hash))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:1000px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Commissions Paid Report").($this->p->ck('reports', 'V', 'commissions') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'commissions_paid_report', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp; &nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=commissions_paid', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:350px;text-align:left;padding-left:50px;\">Product</td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
				</tr>";
			$customers = new customers($this->current_hash);
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				reset($this->results);
				while (list($sales_hash, $proposal_array) = each($this->results)) {
					unset($inner_tbl);
					$total_commission_paid = $previous_commission_paid = $current_commission_paid = $grand_total_sell = $grand_total_cost = $k = 0;
					while (list($commission_hash, $product_array) = each($proposal_array)) {
						$comm_paid = 1;
						$inner_tbl .= ($k > 0 ?"
						<tr>
							<td colspan=\"5\" style=\"background-color:#cccccc;\"></td>
						</tr>" : NULL)."
						<tr>
							<td colspan=\"5\" style=\"font-size:8pt;background-color:#ffffff;padding-left:20px;padding-top:5px;\">
								&nbsp;
								Proposal: <a href=\"javascript:void(0);\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$product_array[0]['proposal_hash']."', 'popup_id=proposal_win', 'from_report=1');\" title=\"View proposal\" class=\"link_standard\">".$product_array[0]['proposal_no']."</a> - ".$product_array[0]['proposal_descr']."
								<div style=\"padding-top:5px;padding-left:10px;\">".stripslashes($product_array[0]['customer_name'])."</div>
							</td>
						</tr>";

						$k++;
						$commission_paid = $total_sell = $total_cost = $total_profit = 0;
						for ( $i = 0; $i < count($product_array); $i++ ) {

							$_margin = math::gp_margin( array(
								'cost'   =>  $product_array[$i]['total_product_cost'],
								'sell'   =>  $product_array[$i]['total_product_sell']
							) );

							$inner_tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">" .
    							( $product_array[$i]['product_name'] ?
        							stripslashes($product_array[$i]['product_name']) : "Miscellaneous"
        						) . "
        						</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">\$" . number_format($product_array[$i]['total_product_sell'], 2) . "</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">\$" . number_format($product_array[$i]['total_product_cost'], 2) . "</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;" .
        						( bccomp( bcsub($product_array[$i]['total_product_sell'], $product_array[$i]['total_product_cost'], 2), 0, 2) == -1 ?
            						"color:#ff0000;" : NULL
        						) .
        						"\">" .
        						( bccomp( bcsub($product_array[$i]['total_product_sell'], $product_array[$i]['total_product_cost'], 2), 0, 2) == -1 ?
									"(\$" . number_format( bcmul( bcsub($product_array[$i]['total_product_sell'], $product_array[$i]['total_product_cost'], 2), -1, 2), 2) . ")" : "\$" . number_format( bcsub($product_array[$i]['total_product_sell'], $product_array[$i]['total_product_cost'], 2), 2)
        						) . "
								</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;" .
        						( defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 ?
            						"color:red;" : NULL
            					) .
            					"\">" . (float)bcmul($_margin, 100, 4) . "%</td>
							</tr>";

							$total_sell = bcadd($total_sell, $product_array[$i]['total_product_sell']);
							$total_cost = bcadd($total_cost, $product_array[$i]['total_product_cost']);
						}

						$commission_paid = $product_array[0]['amount'];
						$total_commission_paid = bcadd($total_commission_paid, bcadd($commission_paid, $product_array[0]['previous_amount']));
						$previous_commission_paid = bcadd($previous_commission_paid, $product_array[0]['previous_amount']);
						$current_commission_paid = bcadd($current_commission_paid, $commission_paid);
						$grand_total_sell = bcadd($grand_total_sell, $total_sell);
						$grand_total_cost = bcadd($grand_total_cost, $total_cost);

						$_margin = math::gp_margin( array(
							'cost'    =>  $total_cost,
							'sell'    =>  $total_sell
						) );

						$inner_tbl .= "
						<tr >
							<td style=\"background-color:#ffffff;padding-left:50px;\"></td>
							<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">\$" . number_format($total_sell, 2)."</div>
							</td>
							<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">\$".number_format($total_cost, 2)."</div>
							</td>
							<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">" .
        						( bccomp( bcsub($total_sell, $total_cost, 2), 0, 2) == -1 ?
									"<span style=\"color:#ff0000;\">(\$" . number_format( bcmul( bcsub($total_sell, $total_cost, 2), -1, 2), 2) . ")</span>" : "\$" . number_format( bcsub($total_sell, $total_cost, 2), 2)
        						) . "
								</div>
							</td>
							<td class=\"num_field\" class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">" .
								( defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 ?
                                    "<span style=\"color:#ff0000;\">" . (float)bcmul($_margin, 100, 4) . "%</span>" : (float)bcmul($_margin, 100, 4) . "%"
								) . "
								</div>
							</td>
						</tr>
						<tr>
							<td style=\"padding-bottom:15px;padding-top:8px;background-color:#ffffff;font-size:8pt;padding-left:25px;\" colspan=\"5\">
								<div style=\"margin-bottom:5px;\" >
								    <table>".(bccomp($product_array[0]['previous_amount'], 0) ? "
                                        <tr>
                                            <td style=\"text-align:right;\">Previous Commissions Paid: </td>
                                            <td>$".number_format($product_array[0]['previous_amount'], 2)."</td>
                                        </tr>" : NULL)."
                                        <tr>
                                            <td style=\"text-align:right;\">Current Commissions Paid: </td>
                                            <td>$".number_format($commission_paid, 2)."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;\">Total Commissions Paid: </td>
                                            <td>$".number_format(bcadd($commission_paid, $product_array[0]['previous_amount'], 2), 2)."</td>
                                        </tr>
								    </table>
									<div style=\"padding-top:5px;\">
									Paid On: ".date(DATE_FORMAT, strtotime($product_array[0]['paid_date'])).($product_array[0]['paid_in_full'] ? "
										<span style=\"padding-left:5px;font-style:italic\">
											This commission is paid in full
										</span>" : NULL)."
									</div>
								</div>
							</td>
						</tr>";
					}
					if ($inner_tbl) {
						$tbl .= "
						<tr style=\"background-color:#efefef;\">
							<td style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".stripslashes($this->user_name($sales_hash))."</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Sell</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Cost</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>
						</tr>"
						. $inner_tbl;
						$all_total_commission = bcadd($all_commission, bcadd($total_commission_paid, $previous_commission_paid));
						$all_current_commission = bcadd($all_current_commission, $current_commission_paid);
						$all_previous_commission = bcadd($all_previous_commission, $previous_commission_paid);
						$sales_commission_array[$sales_hash] = array('full_name'			=>	$this->user_name($sales_hash),
																     'total_sell'			=>  $grand_total_sell,
																     'total_cost'			=>	$grand_total_cost,
																     'total_profit'			=>  bcsub($total_sell, $total_cost),
						                                             'previous_commission'  =>  $previous_commission_paid,
						                                             'current_commission'   =>  $current_commission_paid,
																     'total_commission'		=>  $total_commission_paid);
					}
				}
				// Add totals for ticket #257
				if (bccomp($all_total_commission, 0) || bccomp($all_current_commission, 0) || bccomp($all_previous_commission, 0)) {
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;\" colspan=\"5\">
							<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"width:100%;margin-top:0;\">
								<tr style=\"background-color:#efefef;\">
									<td style=\"padding:5px;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\">Sales Rep</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Total Sell</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Total Cost</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Total Profit</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Total Margin</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Previous Comm</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Current Comm</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Total Comm</td>
								</tr>";

							while ( list($sales_hash, $sales_array) = each($sales_commission_array) ) {

								$_margin = math::gp_margin( array(
									'cost'  =>  $sales_array['total_cost'],
									'sell'  =>  $sales_array['total_sell']
								) );

								$tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;\">" .
        								$this->form->hidden( array(
            								"sales_array[$sales_hash]"  =>  1
        								) ) .
        								stripslashes($sales_array['full_name']) . "
        							</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_sell_".$sales_hash."\">$".number_format($sales_array['total_sell'], 2)."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_cost_".$sales_hash."\">".$this->form->hidden(array('current_cost_'.$sales_hash => $sales_array['total_cost']))."$".number_format($sales_array['total_cost'], 2)."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_profit_".$sales_hash."\">".($sales_array['total_sell'] - $sales_array['total_cost'] < 0 ?
										"<span style=\"color:#ff0000;\">($".number_format(($sales_array['total_sell'] - $sales_array['total_cost']), 2).")" : "$".number_format(($sales_array['total_sell'] - $sales_array['total_cost']), 2))."
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_gp_".$sales_hash."\">" .
        							( defined('MARGIN_FLAG') && bccomp($_margin, MARGIN_FLAG, 4) == -1 ?
										"<span style=\"color:#ff0000;\">" . (float)bcmul($_margin, 100, 4) . "%</span>" : (float)bcmul($_margin, 100, 4) . "%"
        							) . "
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"previous_commission_".$sales_hash."\">" .
										$this->form->hidden( array(
    										"previous_commission_{$sales_hash}"   =>  $sales_array['previous_commission']
										) ) .
										"\$" . number_format($sales_array['previous_commission'], 2) . "
									</td>
                                    <td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"current_commission_".$sales_hash."\">" .
                                        $this->form->hidden( array(
                                            "current_commission_{$sales_hash}"  =>  $sales_array['current_commission']
                                        ) ) .
                                        "\$" . number_format($sales_array['current_commission'], 2) . "
                                    </td>
                                    <td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_commission_".$sales_hash."\">" .
                                        $this->form->hidden( array(
                                            "current_commission_{$sales_hash}"  =>  $sales_array['total_commission']
                                        ) ) .
                                        "\$" . number_format($sales_array['total_commission'], 2) . "
                                    </td>
								</tr>";

								$total_net_sell = bcadd($total_net_sell, $sales_array['total_sell']);
								$total_net_cost = bcadd($total_net_cost, $sales_array['total_cost']);
								$grand_total_commission_paid = bcadd($grand_total_commission_paid, $sales_array['total_commission']);
								$grand_current_commission_paid = bcadd($grand_current_commission_paid, $sales_array['current_commission']);
								$grand_previous_commission_paid = bcadd($grand_previous_commission_paid, $sales_array['previous_commission']);
							}

							$_margin = math::gp_margin( array(
								'cost'   =>  $total_net_cost,
								'sell'   =>  $total_net_sell
							) );

							$tbl .= "
								<tr>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_sell\">
											$".number_format($total_net_sell, 2)."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_cost\">
											$".number_format($total_net_cost, 2)."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_profit\">".($total_net_sell - $total_net_cost < 0 ?
											"<span style=\"color:#ff0000;\">($".number_format($total_net_sell - $total_net_cost, 2).")</span>" : "$".number_format($total_net_sell - $total_net_cost, 2))."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_margin\">" .
            							( defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 ?
											"<span style=\"color:#ff0000;\">" . (float)bcmul($_margin, 100, 4) . "%</span>" : (float)bcmul($_margin, 100, 4) . "%"
            							) . "
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"previous_commission\">
											$".number_format($grand_previous_commission_paid, 2)."
										</div>
									</td>
                                    <td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
                                        <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"current_commission\">
                                            $".number_format($grand_current_commission_paid, 2)."
                                        </div>
                                    </td>
                                    <td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
                                        <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_commission\">
                                            $".number_format($grand_total_commission_paid, 2)."
                                        </div>
                                    </td>
								</tr>
							</table>
						</td>
					</tr>";
				}
			}
			if (!$this->results || !$comm_paid)
				$tbl .= "
				<tr>
					<td colspan=\"5\" style=\"padding:25px 0px 5px 5px;background-color:#ffffff;\">Your commission report is empty.</td>
				</tr>";

			$tbl .= "
			</table>".$this->form->close_form();

			return $tbl;
		} else {
			$action_out = array("commission at", "no commission");
			$action_in = array(1, 0);

			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			$tbl = $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_commissions_paid_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_commission_report', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Commissions Paid Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9), "onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=proposal",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
												if (is_array($this->current_report['proposal_filter'])) {
													for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++)
														$tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">
    											".$this->form->select("sales_rep_match[]",
											                          $this->sales_name,
											                          (is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')),
											                          $this->sales_hash,
											                          "multiple",
											                          "blank=1",
											                          "size=4",
											                          "style=width:200px;")."
                                            </td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_commissions_paid_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$sales_rep_match = $this->current_report['sales_rep'];
			$proposal_filter = $this->current_report['proposal_filter'];
			$sort_from_date = $this->current_report['sort_from_date'];
			$sort_to_date = $this->current_report['sort_to_date'];
		} else {
			$timeframe = $_POST['timeframe'];
			$sales_rep_match = $_POST['sales_rep_match'];
			$proposal_filter = $_POST['proposal_filter'];
			$sort_from_date = $_POST['sort_from_date'];
			$sort_to_date = $_POST['sort_to_date'];
		}

		if ($proposal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);
		if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);

		$save = $_POST['save'];
		$saved_cat = "commissions_paid_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if (($timeframe == 9 && !$sort_from_date) || ($timeframe == 9 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}

		if ($this->content['error'])
			return;

		if (is_array($proposal_filter) && count($proposal_filter)) {
			$proposal_filter = array_unique($proposal_filter);
			$proposal_filter = array_values($proposal_filter);
			array_walk($proposal_filter, 'add_quotes', "'");
			$sql_p[] = "commissions_paid.proposal_hash IN (".implode(" , ", $proposal_filter).")";
			array_walk($proposal_filter, 'strip_quotes');
		}
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match, 'add_quotes', "'");
			$sql_p[] = "commissions_paid.user_hash IN (".implode(" , ", $sales_rep_match).")";
			array_walk($sales_rep_match, 'strip_quotes');
		}

		switch ($timeframe) {
			//This Month
			case 1:
			$this->report_date_start = date("Y-m-01");
			$this->report_date_end = date("Y-m-t");
			$sql_p[] = "commissions_paid.paid_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//Last Month
			case 2:
			$this->report_date_start = date("Y-m-01", strtotime(date("Y-m-d")." -1 month"));
			$this->report_date_end = date("Y-m-t", strtotime(date("Y-m-d")." -1 month"));
			$sql_p[] = "commissions_paid.paid_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//This Quarter
			case 3:
			list($this->report_date_start, $this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")), date("Y"));
			$sql_p[] = "commissions_paid.paid_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//Last Quarter
			case 4:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "commissions_paid.paid_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//This Period
			case 5:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = "commissions_paid.paid_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//Last Period
			case 6:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = "commissions_paid.paid_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//This Year
			case 7:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t", strtotime(date("Y-".($month + 11)."-01")));
			$sql_p[] = "commissions_paid.paid_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//Last Year
			case 8:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t", strtotime(date($last_year."-".($month + 11)."-01")));
			$sql_p[] = "commissions_paid.paid_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//Specific Date
			case 9:
			$this->report_date_start = $sort_from_date;
			$this->report_date_end = $sort_to_date;
			$sql_p[] = "commissions_paid.paid_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;
		}

		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|proposal_filter=".@implode("&", $proposal_filter)."|sales_rep=".@implode("&", $sales_rep_match);


		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT commissions_paid.* , commissions_paid.commission_hash AS parent_commission_hash ,
		                            proposals.proposal_hash as parent_proposal_hash ,
									proposals.proposal_no , proposals.proposal_descr , customers.customer_name ,
									vendor_products.product_name , users.full_name ,
									(
										SELECT SUM(customer_invoice.amount - customer_invoice.balance)
										FROM `customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I' AND customer_invoice.deleted = 0
									) AS total_amount_received ,
									(
										SELECT SUM(customer_invoice.amount)
										FROM `customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'D' AND customer_invoice.deleted = 0
									) AS total_deposit_received ,
									(
										SELECT SUM(customer_invoice.amount) - SUM(customer_invoice.tax)
										FROM `customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I' AND customer_invoice.deleted = 0
									) AS total_amount_invoiced ,
									COUNT(line_items.invoice_hash) AS total_line_items ,
									(
									SELECT COUNT(*)
									FROM `line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND `invoice_hash` = ''
									) AS total_uninvoiced_lines ,
									vendor_products.product_name , vendor_products.product_hash as parent_product_hash ,
									(
									SELECT SUM(line_items.cost * line_items.qty)
									FROM `line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND `product_hash` = parent_product_hash AND `commission_hash` = parent_commission_hash
									) AS total_product_cost ,
									(
									SELECT SUM(line_items.sell * line_items.qty)
									FROM `line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND `product_hash` = parent_product_hash AND `commission_hash` = parent_commission_hash
									) AS total_product_sell
									FROM `commissions_paid`
									LEFT JOIN proposals ON proposals.proposal_hash = commissions_paid.proposal_hash
									LEFT JOIN customers ON customers.customer_hash = proposals.customer_hash
									LEFT JOIN line_items ON line_items.commission_hash = commissions_paid.commission_hash
									LEFT JOIN vendor_products ON vendor_products.product_hash = line_items.product_hash
									LEFT JOIN users ON users.id_hash = commissions_paid.user_hash".($sql ? "
									WHERE ".$sql : NULL)."
									GROUP BY commissions_paid.commission_hash , commissions_paid.proposal_hash , line_items.product_hash");
		while ($row = $this->db->fetch_assoc($result)) {
			if ($row['total_line_items'] > 0)
				$this->results[$row['user_hash']][$row['commission_hash']][] = $row;
		}

		/*
		$sys_config = new system_config($this->current_hash);
		if (is_array($this->results)) {
			reset($this->results);
			while (list($sales_hash, $proposal_array) = each($this->results)) {
				while (list($proposal_hash, $detail) = each($proposal_array)) {
					unset($overhead);
					$result = $this->db->query("SELECT `overhead_hash` , `type`
												FROM `overhead_rules`
												WHERE `active` = 1
												  AND (('".date("Y-m-d")."' BETWEEN `effective_date` AND `expiration_date`) OR (`effective_date` = '' AND `expiration_date` = '') OR (`effective_date` != '' AND ".date("Y-m-d")." >= `effective_date`) OR (`expiration_date` != '' AND ".date("Y-m-d")." <= `expiration_date`))
												  AND ((`type` = 'C' AND `customer_hash` = '".$detail[0]['customer_hash']."') ".($detail[0]['gsa'] ? "
													  OR `type` = 'G'" : NULL)."
														   OR `type` = 'D')");
					while ($row = $this->db->fetch_assoc($result))
						$overhead[$row['type']] = $row;

					if ($overhead['C'])
						$overhead_hash = $overhead['C']['overhead_hash'];
					elseif ($overhead['G'])
						$overhead_hash = $overhead['G']['overhead_hash'];
					elseif ($overhead['D'])
						$overhead_hash = $overhead['D']['overhead_hash'];

					if ($overhead_hash) {
						if (!$this->overhead_record[$overhead_hash]) {
							$sys_config->fetch_overhead_record($overhead_record);
							$this->overhead_record[$overhead_record] = $sys_config->current_overhead;
						}

						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$this->overhead_record[$overhead_record]['rate'],
																				'apply_to'	=>	$this->overhead_record[$overhead_record]['apply_to']);
					} elseif (defined('OVERHEAD_TYPE')) {
						$overhead_rate = (float)OVERHEAD_RATE;

						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$overhead_rate,
																				'apply_to'	=>	OVERHEAD_TYPE);
					}
					//Get any memo costs
					unset($memo);
					$result = $this->db->query("SELECT *
												FROM `memo_costs`
												WHERE `proposal_hash` = '$proposal_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$memo[] = $row;

					if ($memo)
						$this->results_misc[$proposal_hash]['MEMO'] = $memo;

					//Get any job costs
					unset($job_cost);
					$result = $this->db->query("SELECT *
												FROM `vendor_payable_expenses`
												WHERE `proposal_hash` = '$proposal_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$job_cost[] = $row;

					if ($job_cost)
						$this->results_misc[$proposal_hash]['JOB_COST'] = $job_cost;

					unset($com);
					//Get the commission
					$result = $this->db->query("SELECT `commission_hash` , `type`
												FROM `commission_tables`
												WHERE `active` = 1
												  AND (('".date("Y-m-d")."' BETWEEN `effective_date` AND `expiration_date`) OR (`effective_date` = '' AND `expiration_date` = '') OR (`effective_date` != '' AND ".date("Y-m-d")." >= `effective_date`) OR (`expiration_date` != '' AND ".date("Y-m-d")." <= `expiration_date`))
												  AND ((`type` = 'C' AND `customer_hash` = '".$detail[0]['customer_hash']."') ".($detail[0]['gsa'] ? "
													  OR `type` = 'G'" : NULL).($detail[0]['user_commission'] ? "
														   OR (`type` = 'D' AND `commission_hash` = '".$detail[0]['user_commission']."')" : NULL).")");
					while ($row = $this->db->fetch_assoc($result))
						$com[$row['type']] = $row;

					if ($com['C']) {
						if (!$this->commission_rule[$com['C']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['C']['commission_hash']);
							$this->commission_rule[$com['C']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['C']['commission_hash']];
					} elseif ($com['G']) {
						if (!$this->commission_rule[$com['G']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['G']['commission_hash']);
							$this->commission_rule[$com['G']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['G']['commission_hash']];
					} elseif ($com['D']) {
						if (!$this->commission_rule[$com['D']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['D']['commission_hash']);
							$this->commission_rule[$com['D']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['D']['commission_hash']];
					}
				}
			}
		}
		*/
		$this->content['action'] = 'close';

		$this->total = count($this->results);
		if ($local)
			return true;
		else
			$this->content['html']['place_holder'] = $this->commissions_paid_report(1);
		return;
	}

	function balance_sheet($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);

			$tbl = "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" >
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Balance Sheet").($this->p->ck('reports', 'V', 'balance_sheet') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'balance_sheet', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<div style=\"margin-left:20px;margin-bottom:5px;margin-top:10px;\">
							<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=balance_sheet', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
						</div>
					</td>
				</tr>";
			$accounts = array('CA' => array(),
							  'FA' => array(),
							  'CL' => array(),
							  'LL' => array(),
							  'EQ' => array());
			$acct = new accounting($this->current_hash);
			if (substr(trim($this->current_report['sql']), 0, 3) == 'AND')
                $this->current_report['sql'] = substr(trim($this->current_report['sql']), 3);

			$result = $this->db->query("SELECT accounts.account_name , accounts.account_no , journal.account_hash , account_types.type_code ,
										ROUND( SUM(journal.debit), 2) AS debit_total, ROUND( SUM(journal.credit), 2) AS credit_total,
										ROUND( SUM(
											CASE
											WHEN account_types.account_type = 'DR' THEN
	                                            ( journal.debit - journal.credit ) ELSE
	                                            ( journal.credit - journal.debit )
	                                        END
	                                    ), 2) AS balance
										FROM `journal`
										LEFT JOIN `accounts` ON accounts.account_hash = journal.account_hash
										LEFT JOIN `account_types` ON account_types.type_code = accounts.account_type
										WHERE ".($this->current_report['sql'] ?
                                            stripslashes($this->current_report['sql']). " AND " : NULL).
										"account_types.account_side = 'B' ".($this->current_report['hide_close'] ?
                                            "AND journal.trans_type <> 'CL'" : NULL)."
										GROUP BY journal.account_hash");
			while ($row = $this->db->fetch_assoc($result)) {
				$accounts[ $row['type_code'] ][ $row['account_hash'] ] = $row['account_name'];
				$account_detail[ $row['account_hash'] ][0]['total'] = $row['balance'];
			}

			if ($this->compare) {
				$date = $this->report_date;
				for ($i = 1; $i <= $this->compare; $i++) {
					switch ($this->timeframe) {
						//To Date
						case '*':
						list($year, $month, $day) = explode("-", $date);
						$date = (--$year)."-".$month."-".$day;
						$compare_date[] = $date;
						$sql = "journal.date < '".$date."'";

						break;

						//This Month
						case 1:
						list($year, $month, $day) = explode("-", $date);
						if ($month == 1) {
							$date = (--$year)."-12-".date("t", strtotime($year."-12-01"));
						} else
							$date = $year."-".(--$month)."-".date("t", strtotime($year."-".$month."-01"));

						$compare_date[] = $date;
						$sql = "journal.date < '".$date."'";
						break;

						//Last Month
						case 2:
						list($year, $month, $day) = explode("-", $date);
						if ($month == 1) {
							$date = (--$year)."-12-".date("t", strtotime($year."-12-01"));
						} else
							$date = $year."-".(--$month)."-".date("t", strtotime($year."-".$month."-01"));

						$compare_date[] = $date;
						$sql = "journal.date < '".$date."'";
						break;

						//This Quarter
						case 3:
						$current_qtr = get_quarter($date);
						if ($current_qtr == 1) {
							$previous_qtr = get_quarter(strtotime($date." -4 months"));
							list($start, $date) = get_quarter_dates($previous_qtr, date("Y", strtotime($date." -4 months")));
						} else
							list($start, $date) = get_quarter_dates($current_qtr - 1, date("Y", strtotime($date)));

						$compare_date[] = $date;
						$sql = "journal.date < '".$date."'";
						break;

						//Last Quarter
						case 4:
						$current_qtr = get_quarter($date);
						if ($current_qtr == 1) {
							$previous_qtr = get_quarter(strtotime($date." -4 months"));
							list($start, $date) = get_quarter_dates($previous_qtr, date("Y", strtotime($date." -4 months")));
						} else
							list($start, $date) = get_quarter_dates($current_qtr - 1, date("Y", strtotime($date)));

						$compare_date[] = $date;
						$sql = "journal.date < '".$date."'";
						break;

						//This Period
						case 5:
						$period_info = get_previous_period($date);
						if ($period_info['period_end']) {
							$date = $period_info['period_end'];
							$compare_date[] = $date;
							$sql = "journal.date < '".$date."'";
						}
						break;

						//Last Period
						case 6:
						$period_info = get_previous_period($date);
						if ($period_info['period_end']) {
							$date = $period_info['period_end'];
							$compare_date[] = $date;
							$sql = "journal.date < '".$date."'";
						}
						break;

						//This Year
						case 7:
						list($year, $month, $day) = explode("-", $date);
						$date = (--$year)."-".$month."-".date("t", strtotime($year."-".$month."-01"));
						$compare_date[] = $date;
						$sql = "journal.date < '".$date."'";
						break;

						//Last Year
						case 8:
						list($year, $month, $day) = explode("-", $date);
						$date = (--$year)."-".$month."-".date("t", strtotime($year."-".$month."-01"));
						$compare_date[] = $date;
						$sql = "journal.date < '".$date."'";
						break;

						//Specific Date
						case 9:
						list($year, $month, $day) = explode("-", $date);
						$year--;
						if ($day > date("t", strtotime($year."-".$month."-01")))
							$day = date("t", strtotime($year."-".$month."-01"));

						$date = $year."-".$month."-".$day;
						$compare_date[] = $date;
						$sql = "journal.date < '".$date."'";
						break;
					}
					$result = $this->db->query("SELECT accounts.account_name , accounts.account_no , journal.account_hash , account_types.type_code ,
												ROUND( SUM( journal.debit ), 2) AS debit_total , ROUND( SUM( journal.credit ), 2) AS credit_total,
												ROUND( SUM(
													CASE
													WHEN account_types.account_type = 'DR' THEN
                                                        ( journal.debit - journal.credit ) ELSE
                                                        ( journal.credit - journal.debit ) ELSE
                                                    END
											    ), 2) AS balance
												FROM `journal`
												LEFT JOIN `accounts` ON accounts.account_hash = journal.account_hash
												LEFT JOIN `account_types` ON account_types.type_code = accounts.account_type
												WHERE ".($sql ?
													$sql . " AND " : NULL).
											    "account_types.account_side = 'B' ".($this->current_report['hide_close'] ?
                                                    "AND journal.trans_type <> 'CL'" : NULL)."
												GROUP BY journal.account_hash");
					while ($row = $this->db->fetch_assoc($result)) {
						$accounts[ $row['type_code'] ][ $row['account_hash'] ] = $row['account_name'];
						$account_detail[ $row['account_hash'] ][$i]['total'] = $row['balance'];
					}
				}
			}
			if (is_array($accounts)) {
				if ($this->compare)
					$colspan = $this->compare + 2;
				else {
					$this->compare = 0;
					$colspan = 2;
				}

				$tbl .= "
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\">
						<div style=\"margin-bottom:8px;\">
						</div>
						<table style=\"background-color:#cccccc;\" cellpadding=\"5\" cellspacing=\"1\">
							<tr>
								<td style=\"text-align:center;width:500px;background-color:#efefef;\" colspan=\"".$colspan."\">
									<h4 style=\"margin-bottom:5px;color:#00477f;\">".(defined('MY_COMPANY_NAME') ?
										MY_COMPANY_NAME : NULL).(!$this->compare ? "
										<div style=\"margin-top:8px;font-size:10px;\">As of ".date("F d, Y", strtotime($this->report_date))."</div>" : NULL)."
									</h4>
								</td>
							</tr>
							<tr>
								<td ".(!$this->compare ? "colspan=\"2\"" : NULL)." style=\"background-color:#ffffff;font-weight:bold;".(!$this->compare ? "width:250px;" : NULL)."\">Assets</td>";
							if ($this->compare) {
								for ($i = 0; $i <= $this->compare; $i++)
									$tbl .= "
									<td style=\"background-color:#ffffff;font-weight:bold;text-align:center;\">".($i == 0 ?
										date("F d, Y", strtotime($this->report_date)) : date("F d, Y", strtotime($compare_date[$i-1])))."
									</td>";
							}
							$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#ffffff;\" colspan=\"".$colspan."\">Current Assets</td>
							</tr>";
						$ca =& $accounts['CA'];
						while (list($account_hash, $info) = each($ca)) {
							unset($inner, $activity);
                            for ($i = 0; $i <= $this->compare; $i++) {
                            	if ($account_detail[$account_hash][$i]['total'] != 0)
                                    $activity = 1;

                                $total_ca[$i] += $account_detail[$account_hash][$i]['total'];
                                $inner .= "
                                <td style=\"background-color:#ffffff;".($account_detail[$account_hash][$i]['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($account_detail[$account_hash][$i]['total'] < 0 ?
                                    "($".number_format(($account_detail[$account_hash][$i]['total'] * -1), 2).")" : "$".number_format($account_detail[$account_hash][$i]['total'], 2))."
                                </td>";
                            }

                            if ($activity || (!$activity && !$this->current_report['hide_empty']))
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;padding-left:15px;\">".$info."</td>
									".$inner."
								</tr>";
						}
						$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;font-weight:bold;\">Total Current Assets</td>";
								for ($i = 0; $i <= $this->compare; $i++)
									$tbl .= "
									<td style=\"background-color:#ffffff;font-weight:bold;".($total_ca[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_ca[$i] < 0 ?
										"($".number_format(($total_ca[$i] * -1), 2).")" : "$".number_format($total_ca[$i], 2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#ffffff;padding-top:15px;\" colspan=\"".$colspan."\">Long Term Assets</td>
							</tr>";
						$fa =& $accounts['FA'];
						while (list($account_hash, $info) = each($fa)) {
							unset($inner, $activity);
                            for ($i = 0; $i <= $this->compare; $i++) {
                                if ($account_detail[$account_hash][$i]['total'] != 0)
                                    $activity = 1;

                                $total_fa[$i] += $account_detail[$account_hash][$i]['total'];
                                $inner .= "
                                <td style=\"background-color:#ffffff;".($account_detail[$account_hash][$i]['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($account_detail[$account_hash][$i]['total'] < 0 ?
                                    "($".number_format(($account_detail[$account_hash][$i]['total'] * -1), 2).")" : "$".number_format($account_detail[$account_hash][$i]['total'], 2))."
                                </td>";
                            }

                            if ($activity || (!$activity && !$this->current_report['hide_empty']))
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;padding-left:15px;\">".$info."</td>
									".$inner."
								</tr>";
						}
						$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;font-weight:bold;\">Total Long Term Assets</td>";
								for ($i = 0; $i <= $this->compare; $i++)
									$tbl .= "
									<td style=\"background-color:#ffffff;font-weight:bold;".($total_fa[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_fa[$i] < 0 ?
										"($".number_format(($total_fa[$i] * -1), 2).")" : "$".number_format($total_fa[$i], 2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#efefef;padding-top:25px;font-size:14px;font-weight:bold;\">Total Assets</td>";
								for ($i = 0; $i <= $this->compare; $i++)
									$tbl .= "
									<td style=\"background-color:#efefef;font-weight:bold;padding-top:25px;font-size:14px;".($total_fa[$i] + $total_ca[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_fa[$i] + $total_ca[$i] < 0 ?
										"($".number_format((($total_fa[$i] + $total_ca[$i]) * -1), 2).")" : "$".number_format($total_fa[$i] + $total_ca[$i], 2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td colspan=\"".$colspan."\" style=\"background-color:#ffffff;font-weight:bold;width:250px;padding-top:15px;\">Liabilities</td>
							</tr>
							<tr>
								<td style=\"background-color:#ffffff;\" colspan=\"".$colspan."\">Current Liabilities</td>
							</tr>";
						$cl =& $accounts['CL'];
						while (list($account_hash, $info) = each($cl)) {
                            unset($inner, $activity);
                            for ($i = 0; $i <= $this->compare; $i++) {
                                if ($account_detail[$account_hash][$i]['total'] != 0)
                                    $activity = 1;

                                $total_cl[$i] += $account_detail[$account_hash][$i]['total'];
                                $inner .= "
                                <td style=\"background-color:#ffffff;".($account_detail[$account_hash][$i]['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($account_detail[$account_hash][$i]['total'] < 0 ?
                                    "($".number_format(($account_detail[$account_hash][$i]['total'] * -1), 2).")" : "$".number_format($account_detail[$account_hash][$i]['total'], 2))."
                                </td>";

                            }
                            if ($activity || (!$activity && !$this->current_report['hide_empty']))
                                $tbl .= "
                                <tr>
                                    <td style=\"background-color:#ffffff;padding-left:15px;\">".$info."</td>
                                    ".$inner."
                                </tr>";
						}
						$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;font-weight:bold;\">Total Current Liabilities</td>";
								for ($i = 0; $i <= $this->compare; $i++)
									$tbl .= "
									<td style=\"background-color:#ffffff;font-weight:bold;".($total_cl[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_cl[$i] < 0 ?
										"($".number_format(($total_cl[$i] * -1), 2).")" : "$".number_format($total_cl[$i], 2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#ffffff;padding-top:15px;\" colspan=\"".$colspan."\">Long Term Liabilities</td>
							</tr>";
						$ll =& $accounts['LL'];
						while (list($account_hash, $info) = each($ll)) {
							unset($inner, $activity);
                            for ($i = 0; $i <= $this->compare; $i++) {
                                if ($account_detail[$account_hash][$i]['total'] != 0)
                                    $activity = 1;

                                $total_ll[$i] += $account_detail[$account_hash][$i]['total'];
                                $inner .= "
                                <td style=\"background-color:#ffffff;".($account_detail[$account_hash][$i]['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($account_detail[$account_hash][$i]['total'] < 0 ?
                                    "($".number_format(($account_detail[$account_hash][$i]['total'] * -1), 2).")" : "$".number_format($account_detail[$account_hash][$i]['total'], 2))."
                                </td>";
                            }

                            if ($activity || (!$activity && !$this->current_report['hide_empty']))
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;padding-left:15px;\">".$info."</td>
									".$inner."
								</tr>";
						}
						$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;font-weight:bold;\">Total Long Term Liabilities</td>";
								for ($i = 0; $i <= $this->compare; $i++)
									$tbl .= "
									<td style=\"background-color:#ffffff;font-weight:bold;".($total_ll[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_ll[$i] < 0 ?
										"($".number_format(($total_ll[$i] * -1), 2).")" : "$".number_format($total_ll[$i], 2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#efefef;padding-top:25px;font-size:14px;font-weight:bold;\">Total Liabilities</td>";
								for ($i = 0; $i <= $this->compare; $i++)
									$tbl .= "
									<td style=\"background-color:#efefef;font-weight:bold;padding-top:25px;font-size:14px;".($total_cl[$i] + $total_ll[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_cl[$i] + $total_ll[$i] < 0 ?
										"($".number_format((($total_cl[$i] + $total_ll[$i]) * -1), 2).")" : "$".number_format($total_cl[$i] + $total_ll[$i], 2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#ffffff;font-weight:bold;width:250px;padding-top:15px;\" colspan=\"".$colspan."\">Shareholder's Equity</td>
							</tr>";
						$eq =& $accounts['EQ'];
						while (list($account_hash, $info) = each($eq)) {
                            unset($inner, $activity);
                            for ($i = 0; $i <= $this->compare; $i++) {
                                if ($account_detail[$account_hash][$i]['total'] != 0)
                                    $activity = 1;

                                $total_eq[$i] += $account_detail[$account_hash][$i]['total'];
                                $inner .= "
                                <td style=\"background-color:#ffffff;".($account_detail[$account_hash][$i]['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($account_detail[$account_hash][$i]['total'] < 0 ?
                                    "($".number_format(($account_detail[$account_hash][$i]['total'] * -1), 2).")" : "$".number_format($account_detail[$account_hash][$i]['total'], 2))."
                                </td>";
                            }

                            if ($activity || (!$activity && !$this->current_report['hide_empty']))
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;padding-left:15px;\">".$info."</td>
									".$inner."
								</tr>";
						}
						$tbl .= "
							<tr>
								<td style=\"background-color:#efefef;padding-top:25px;font-size:14px;font-weight:bold;\">Total Shareholder's Equity</td>";
								for ($i = 0; $i <= $this->compare; $i++)
									$tbl .= "
									<td style=\"background-color:#efefef;font-weight:bold;".($total_eq[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_eq[$i] < 0 ?
										"($".number_format(($total_eq[$i] * -1), 2).")" : "$".number_format($total_eq[$i], 2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#efefef;padding-top:25px;font-size:15px;font-weight:bold;\">Total Liabilities and Equity</td>";
								for ($i = 0; $i <= $this->compare; $i++) {
									$total_liab = $total_cl[$i] + $total_ll[$i] + $total_eq[$i];
									$tbl .= "
									<td style=\"background-color:#efefef;font-weight:bold;padding-top:25px;font-size:14px;".($total_liab < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_liab < 0 ?
										"($".number_format(($total_liab * -1), 2).")" : "$".number_format($total_liab, 2))."
									</td>";
								}
								$tbl .= "
							</tr>
						</table>
					</td>
				</tr>";
			} else
				$tbl .= "
				<tr>
					<td colspan=\"6\" style=\"background-color:#ffffff;\">Your report returned no results.</td>
				</tr>";

			$tbl .= "
			</table>";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_balance_sheet');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_ar', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Balance Sheet")."
									</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("To Date",
																    	  "Through This Month",
																    	  "Through Last Month",
																    	  "Through This Quarter",
																    	  "Through Last Quarter",
																    	  "Through This Period",
																    	  "Through Last Period",
																    	  "Through This Year",
																    	  "Through Last Year",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array('*',
																		  1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9), "onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;Through:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Comparison: </td>
											<td style=\"background-color:#ffffff;vertical-align:top;padding-top:10px;\">".$this->form->select("compare", array("No Comparison", "Compare Against Previous Cycle", "Compare Against Previous 2 Cycles", "Compare Against Previous 3 Cycles"), $this->current_report['compare'], array(0, 1, 2, 3), "blank=1")."</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Hide accounts with a zero balance?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=hide_empty",
                                                                        "value=1",
                                                                        ($this->current_report['hide_empty'] || !$this->current_report ? "checked" : NULL))."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Exclude year-end closing entries?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=hide_close",
                                                                        "value=1",
                                                                        ($this->current_report['hide_close'] ? "checked" : NULL))."
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_balance_sheet() {
		$date = date("U") - 43200;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);

			$hide_empty = $this->current_report['hide_empty'];
			$hide_close = $this->current_report['hide_close'];
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 9)
				$sort_to_date = $this->current_report['sort_to_date'];

			if ($compare = $this->current_report['compare'])
				$this->compare = $compare;
		} else {
			$timeframe = $_POST['timeframe'];

			$hide_empty = $_POST['hide_empty'];
			$hide_close = $_POST['hide_close'];
			if ($timeframe == 9)
				$sort_to_date = $_POST['sort_to_date'];

			if ($compare = $_POST['compare'])
				$this->compare = $compare;
		}


		$save = $_POST['save'];
		$saved_cat = "balance_sheet";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];


		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($timeframe == 9 && !$sort_to_date) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The date you specified is invalid! Please make sure you specify a date to report through.";
		}
		if ($this->content['error'])
			return;

		switch ($timeframe) {
			//To Date
			case '*':
			$this->report_date = date('Y-m-d');
			$sql_p[] = "journal.date <= '{$this->report_date}'";
			break;

			//This Month
			case 1:
			$this->report_date = date('Y-m-t');
			$sql_p[] = "journal.date <= '{$this->report_date}'";
			break;

			//Last Month
			case 2:
			$this->report_date = date('Y-m-t', strtotime(date('Y-m-d') . ' -1 month'));
			$sql_p[] = "journal.date <= '{$this->report_date}'";
			break;

			//This Quarter
			case 3:
			list($start, $end) = get_quarter_dates(get_quarter( date('Y-m-d') ), date('Y'));
			$this->report_date = $end;
			$sql_p[] = "journal.date <= '{$this->report_date}'";
			break;

			//Last Quarter
			case 4:
			$current_qtr = get_quarter( date("Y-m-d") );
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d") . " -4 months")));
				list($start, $end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d") . " -4 months")));
			} else
				list($start, $end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$this->report_date = $end;
			$sql_p[] = "journal.date <= '{$this->report_date}'";
			break;

			//This Period
			case 5:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_end']) {
				$this->report_date = $period_info['period_end'];
				$sql_p[] = "journal.date <= '{$this->report_date}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//Last Period
			case 6:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_end']) {
				$this->report_date = $period_info['period_end'];
				$sql_p[] = "journal.date <= '{$this->report_date}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//This Year
			case 7:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date = date("Y") . "-" . ( $month + 11 ) . "-" . date("t", strtotime(date("Y-" . ( $month + 11 ) . "-01")));
			$sql_p[] = "journal.date <= '{$this->report_date}'";
			break;

			//Last Year
			case 8:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;

			$last_year = date("Y") - 1;
			$this->report_date = $last_year . "-" . ( $month + 11 ) . "-" . date("t", strtotime(date($last_year . "-" . ( $month + 11 ) . "-01")));
			$sql_p[] = "journal.date <= '{$this->report_date}'";
			break;

			//Specific Date
			case 9:
			$this->report_date = $sort_to_date;
			$sql_p[] = "journal.date <= '{$this->report_date}'";
			break;
		}

		$this->timeframe = $timeframe;

		if ($this->report_date)
			$method_vars['report_date'] = $this->report_date;

		if ($sql_p)
			$sql = " AND ".implode(" AND ", $sql_p);

		$str = "timeframe=$timeframe|sort_to_date=$sort_to_date|compare=$compare|hide_empty=$hide_empty|hide_close=$hide_close";

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `sql` , `method_vars`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".addslashes($sql)."' , '".addslashes(serialize($method_vars))."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' , `sql` = '".addslashes($sql)."' , `method_vars` = '".addslashes(serialize($method_vars))."'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}

		$this->report_hash = $report_hash;
		if ($doit_print)
            return;

		$this->content['action'] = 'close';
		$this->content['html']['place_holder'] = $this->balance_sheet(1);
		return;
	}

	function print_it() {

		$popup_id = ( $this->ajax_vars['popup_id'] ? $this->ajax_vars['popup_id'] : $_POST['popup_id'] );
		$this->popup_id = $this->content['popup_controls']['popup_id'] = ( $popup_id ? $popup_id : 'popup_win' . rand(500, 5000) );
		$this->content['popup_controls']['popup_title'] = "Run Reports";
		$report_hash = $this->ajax_vars['report_hash'];
		$type = $this->ajax_vars['type'];

		$tbl .= "
        <div style=\"background-color:#ffffff;width:100%;height:100%;margin:0;text-align:left;\">
            <div id=\"loading{$this->popup_id}\" style=\"width:100%;padding-top:50px;padding-bottom:45px;text-align:center;\">
                <h3 style=\"color:#00477f;margin-bottom:5px;display:block;\" id=\"link_fetch{$this->popup_id}\">Loading Document...</h3>
                <div id=\"link_img_holder{$this->popup_id}\" style=\"display:block;\"><img src=\"images/file_loading.gif\" /></div>
            </div>
            <iframe src=\"print.php?t=" . base64_encode($type) . "&h=$report_hash\" width=\"98%\" height=\"100%\" style=\"z-index:100;display:none;\" onReadyStateChange=\"if(this.readyState == 4 || this.readyState == 'complete'){toggle_display('loading{$this->popup_id}', 'none');this.style.display='block'}\"></iframe>
            <div style=\"padding-top:10px;text-align:left;\">
                <small>[<a href=\"print.php?t=" . base64_encode($type) . "&h=$report_hash\" target=\"_blank\" class=\"link_standard\">Open in a separate window</a>]</small>
            </div>
        </div>";

		$this->content['popup_controls']["cmdTable"] = $tbl;
	}

	/**
	 * Creates the iframe for exporting reports and lists to excel.  Updated for #265 to allow a search hash.
	 *
	 */
	function print_it_xls() {
		$report_hash = $this->ajax_vars['report_hash'];
		$type = $this->ajax_vars['type'];
		$title = $this->ajax_vars['title'];
		$active_search = $this->ajax_vars['active_search'];
		$this->popup_id = $this->content['popup_controls']['popup_id'] = ($this->ajax_vars['popup_id'] ? $this->ajax_vars['popup_id'] : $_POST['popup_id']);
		$this->content['popup_controls']['popup_title'] = "Export ".($title ? $title : "Reports")." to Spreadsheet";

		$tbl .= "
		<div style=\"background-color:#ffffff;width:100%;height:100%;margin:0;text-align:left;\">

			<iframe src=\"xls_print.php?t=".base64_encode($type)."&h=".$report_hash."&s=$active_search\" width=\"98%\" height=\"100%\" style=\"z-index:100;display:none;\" ></iframe>
			<div style=\"margin-bottom:5px;margin-left:10px;\">
			<br> Right click on the link below, click 'Save Target As' and select a location on your computer.
                <div style=\"margin-top:15px;margin-left:20px;\">
                    <span style=\"margin-right:5px;\"><a href=\"xls_print.php?t=".base64_encode($type)."&h=".$report_hash."&s=$active_search\" target=\"_blank\" class=\"link_standard\"><img src=\"images/excel.gif\" border=\"0\" /></a></span>
    				<a href=\"xls_print.php?t=".base64_encode($type)."&h=".$report_hash."&s=$active_search\" target=\"_blank\" class=\"link_standard\">Save ".($title ? $title : "Report")."</a>
				</div>
			</div>
			<div style=\"padding-top:10px;text-align:left;\">
				<small>[<a href=\"xls_print.php?t=".base64_encode($type)."&h=".$report_hash."&s=$active_search\" target=\"_blank\" class=\"link_standard\">Open in a separate window</a>]</small>
			</div>
		</div>";
		$this->content['popup_controls']["cmdTable"] = $tbl;
	}

	function check_reconcile($step=NULL) {
		$this->unlock("_");

		$result = $this->db->query("SELECT t1.check_no , t1.check_date , t1.amount , t1.memo , t2.customer_name ,
		                            t3.vendor_name , t4.account_no , t4.account_name , t4.account_hash
							  		FROM check_register t1
									LEFT JOIN customers t2 ON t2.customer_hash = t1.payee
									LEFT JOIN vendors t3 ON t3.vendor_hash = t1.payee
									LEFT JOIN accounts t4 ON t4.account_hash = t1.account_hash
									WHERE t1.cleared = 0 AND t1.void = 0
							  		ORDER BY t1.check_no ASC");
		while ($row = $this->db->fetch_assoc($result))
			$check[] = $row;

        $this->content['jscript'][] = "
        var clear_timer = false;

        var clear_keys = new Hash();
        var private_clear_keys = new Hash();
        clearCheck = function() {
            var ck_no = arguments[0];
            var clear_flag = arguments[1];
            var ck_split = ck_no.split('\|');

            clear_keys.set(ck_no, (clear_flag == 1 ? 1 : 0));

            if (clear_flag == 1) {
                \$('clear_1_'+ck_split[0]+'_'+ck_split[1]).show();
                \$('clear_2_'+ck_split[0]+'_'+ck_split[1]).hide();
            } else {
                \$('clear_2_'+ck_split[0]+'_'+ck_split[1]).show();
                \$('clear_1_'+ck_split[0]+'_'+ck_split[1]).hide();
            }

            if (clear_timer == false)
                clear_timer = window.setTimeout('clearPost()', 1000);
        }
        clearPost = function() {
            private_clear_keys = clear_keys.clone();
            clear_keys = new Hash();

            agent.call('accounting', 'sf_loadcontent', 'cf_loadcontent', 'toggle_clear_flag', 'from_report=1', private_clear_keys.toQueryString());

            clear_timer = false;
        }";

		$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1))."
		<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
			<tr>
				<td style=\"width:100%;background-color:#ffffff;padding:10px;\" >
					<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
						".($this->current_report['saved'] ?
							$this->current_report['report_name'] : "Check Reconciliation Report")."
					</h3>
					<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
						<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
					</div>
				</td>
			</tr>
			<tr>
				<td style=\"width:100%;background-color:#ffffff;padding:10px;\">
					<table style=\"width:100%;\" cellpadding=\"3\">
						<tr>
							<td style=\"font-weight:bold;width:10%;padding-bottom:5px;\">Check No.</td>
							<td style=\"font-weight:bold;width:30%;padding-bottom:5px;\">Account</td>
							<td style=\"font-weight:bold;width:15%;padding-bottom:5px;\">Check Date</td>
							<td style=\"font-weight:bold;width:30%;padding-bottom:5px;\">Payee</td>
							<td style=\"font-weight:bold;width:15%;padding-bottom:5px;\" class=\"num_field\">Amount</td>
							<td></td>
						</tr>";
					for ($i = 0; $i < count($check); $i++) {
						$tbl .= "
						<tr>
							<td ".($i < count($check) - 1 ? "border-bottom:1px solid #cccccc;\"" : NULL).">".$check[$i]['check_no']."</td>
							<td ".($i < count($check) - 1 ? "border-bottom:1px solid #cccccc;\"" : NULL).">".($check[$i]['account_no'] ?
                                $check[$i]['account_no']." : " : NULL).$check[$i]['account_name']."
                            </td>
							<td ".($i < count($check) - 1 ? "border-bottom:1px solid #cccccc;\"" : NULL).">".date(DATE_FORMAT, strtotime($check[$i]['check_date']))."</td>
							<td ".($i < count($check) - 1 ? "border-bottom:1px solid #cccccc;\"" : NULL).">".($check[$i]['customer_name'] ?
								stripslashes($check[$i]['customer_name']) : stripslashes($check[$i]['vendor_name']))."
							</td>
							<td ".($i < count($check) - 1 ? "border-bottom:1px solid #cccccc;\"" : NULL)." class=\"num_field\">$".number_format($check[$i]['amount'], 2)."</td>
							<td ".($i < count($check) - 1 ? "border-bottom:1px solid #cccccc;\"" : NULL).">
                                <div id=\"clear_1_".$check[$i]['check_no']."_".$check[$i]['account_hash']."\" style=\"display:none\">
                                    <img src=\"images/check.gif\" border=\"0\" alt=\"Remove cleared flag from this check\" onMouseOver=\"this.style.cursor='pointer';\" onClick=\"clearCheck('".$check[$i]['check_no']."|".$check[$i]['account_hash']."', 0);\" />
                                </div>
                                <div id=\"clear_2_".$check[$i]['check_no']."_".$check[$i]['account_hash']."\">".
                                    $this->form->checkbox("name=cleared_".$check[$i]['check_no']."_".$check[$i]['account_hash'],
                                                          "value=1",
                                                          "onClick=if(!this.disabled){clearCheck('".$check[$i]['check_no']."|".$check[$i]['account_hash']."', this.checked);this.checked=0;}")."
                                </div>
							</td>
						</tr>";
					}
					$tbl .= "
					</table>
                </td>
            </tr>
		</table>".$this->form->close_form();

		$this->content['html']['place_holder'] = $tbl;
	}

	function doit_customize() {

	}

	function customize() {
		$tbl = $this->form->form_tag().
		$this->form->hidden(array('test' => 1, 'popup_id' => $this->popup_id))."
		<div class=\"panel\">
			<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
				<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
					<p id=\"feedback_message".$this->popup_id."\"></p>
			</div>
			<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
				<tr>
					<td style=\"padding:0;\">
						 <div style=\"background-color:#ffffff;height:100%;\">
							<div style=\"margin:15px 35px;\">
								<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
									".$this->form->button("value=Save", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_customize');")."
								</div>
								<h3 style=\"margin-bottom:5px;color:#00477f;\">
									Customize Your Income Statement
								</h3>
								<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
									<tr>
										<td style=\"background-color:#ffffff;vertical-align:top;padding-top:10px;\">
											<div style=\"margin-top:15px;margin-left:5px;font-weight:bold;\">
										</td>
									</tr>
								</table>
							</div>
						</div>
					</td>
				</tr>
			</table>
		</div>".
		$this->form->close_form();

		$this->content['popup_controls']["cmdTable"] = $tbl;
		$this->content['popup_controls']['popup_title'] = "Customize Your Report";

		return;
	}

	function income_statement($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" >
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Income Statement").($this->p->ck('reports', 'V', 'income_stmtm') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'income_statement', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
								&nbsp;
								<!--
								[<small><a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'customize', 'report=income_statement', 'popup_id=customize_it');\">Customize Report</a></small>]
								-->
							</span>" : NULL)."
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=income', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
						</div>
					</td>
				</tr>";

            $accounts =& $this->accounts;
            if (is_array($accounts)) {
                $tbl .= "
                <tr>
                    <td style=\"width:100%;background-color:#ffffff;padding:10px;\">
                        <table style=\"border:1px solid #cccccc;\" cellpadding=\"5\" cellspacing=\"0\">
                            <tr>
                                <td style=\"text-align:center;width:600px;background-color:#efefef;border-bottom:1px solid #cccccc;\" colspan=\"2\">
                                    <h4 style=\"margin-bottom:5px;color:#00477f;\">".(defined('MY_COMPANY_NAME') ?
                                        MY_COMPANY_NAME : NULL)."
                                        <div style=\"margin-top:8px;font-size:10px;\">
                                            Income Statement
                                            <br />
                                            ".($this->report_date_start ? date("F j, Y", strtotime($this->report_date_start))." - " : "Through ").date("F j, Y", strtotime($this->report_date_end))."
                                        </div>
                                    </h4>
                                </td>
                            </tr>
                            <tr>
                                <td style=\"background-color:#ffffff;font-weight:bold;\" colspan=\"2\">Income</td>
                            </tr>";
                            $in =& $accounts['IN'];
                            $total_in = 0;
                            while (list($account_hash, $info) = each($in)) {
                                if ($info['total'] != 0 || !$this->current_report['hide_empty'] || $info['placeholder'] == 1 || $this->child[$account_hash]) {
                                    $total_in += $info['total'];
                                    $tbl .= "
                                    <tr>
                                        <td style=\"background-color:#ffffff;padding-left:15px;border-bottom:1px solid #efefef;\">".($info['account_no'] ? $info['account_no']." - " : NULL).$info['account_name']."</td>
                                        <td style=\"background-color:#ffffff;border-bottom:1px solid #efefef;".($info['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($info['total'] < 0 ?
                                            "($".number_format(($info['total'] * -1), 2).")" : "$".number_format($info['total'], 2))."
                                        </td>
                                    </tr>";
                                    // Display child accounts if any
                                    if ($this->child[$account_hash]) {
                                        $child_total = $info['total'];
                                        reset($this->child[$account_hash]);
                                        $k = 0;
                                        while (list($child_hash, $child_info) = each($this->child[$account_hash])) {
                                            if ($child_info['total'] != 0 || !$this->current_report['hide_empty']) {
                                                $k++;
                                                $total_in += $child_info['total'];
                                                $child_total += $child_info['total'];
                                                $tbl .= "
                                                <tr>
                                                    <td style=\"background-color:#ffffff;padding-left:30px;".($k < count($this->child[$account_hash]) ? "border-bottom:1px solid #efefef;" : NULL)."\">".($child_info['account_no'] ? $child_info['account_no']." - " : NULL).$child_info['account_name']."</td>
                                                    <td style=\"background-color:#ffffff;".($k < count($this->child[$account_hash]) ? "border-bottom:1px solid #efefef;" : NULL).($child_info['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($child_info['total'] < 0 ?
                                                        "($".number_format(($child_info['total'] * -1), 2).")" : "$".number_format($child_info['total'], 2))."
                                                    </td>
                                                </tr>";
                                            }
                                        }
                                        if ($k > 0)
                                            $tbl .= "
                                            <tr>
                                                <td style=\"background-color:#ffffff;padding-left:30px;padding-bottom:10px;\">&nbsp;</td>
                                                <td style=\"background-color:#ffffff;padding-bottom:10px;".($info['total'] < 0 ? "color:#ff0000;" : NULL)."border-top:1px dashed #000000;width:20%;\" class=\"num_field\">".($child_total < 0 ?
                                                    "($".number_format(($child_total * -1), 2).")" : "$".number_format($child_total, 2))."
                                                </td>
                                            </tr>";
                                    }
                                }
                            }

                            $tbl .= "
                            <tr>
                                <td style=\"border-top:1px solid #cccccc;border-right:1px solid #cccccc;padding-left:15px;font-weight:bold;\">Total Income</td>
                                <td style=\"border-top:1px solid #cccccc;background-color:#efefef;font-weight:bold;".($total_in < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_in < 0 ?
                                    "($".number_format(($total_in * -1), 2).")" : "$".number_format($total_in, 2))."
                                </td>
                            </tr>
                            <tr>
                                <td colspan=\"2\" style=\"border-top:1px solid #cccccc;background-color:#ffffff;font-weight:bold;width:250px;padding-top:15px;\">Cost of Goods Sold</td>
                            </tr>";

                            $cg =& $accounts['CG'];
                            $total_cg = 0;
                            while (list($account_hash, $info) = each($cg)) {
                                if ($info['total'] != 0 || !$this->current_report['hide_empty'] || $info['placeholder'] == 1 || $this->child[$account_hash]) {
                                    $total_cg += $info['total'];
                                    $tbl .= "
                                    <tr>
                                        <td style=\"background-color:#ffffff;padding-left:15px;border-bottom:1px solid #efefef;\">".($info['account_no'] ? $info['account_no']." - " : NULL).$info['account_name']."</td>
                                        <td style=\"background-color:#ffffff;border-bottom:1px solid #efefef;".($info['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($info['total'] < 0 ?
                                            "($".number_format(($info['total'] * -1), 2).")" : "$".number_format($info['total'], 2))."
                                        </td>
                                    </tr>";
                                    if ($this->child[$account_hash]) {
                                        $child_total = $info['total'];
                                        reset($this->child[$account_hash]);
                                        $k = 0;
                                        while (list($child_hash, $child_info) = each($this->child[$account_hash])) {
                                            if ($child_info['total'] != 0 || !$this->current_report['hide_empty']) {
                                                $k++;
                                                $child_total += $child_info['total'];
                                                $total_cg += $child_info['total'];
                                                $tbl .= "
                                                <tr>
                                                    <td style=\"background-color:#ffffff;padding-left:30px;".($k < count($this->child[$account_hash]) ? "border-bottom:1px solid #efefef;" : NULL)."\">".($child_info['account_no'] ? $child_info['account_no']." - " : NULL).$child_info['account_name']."</td>
                                                    <td style=\"background-color:#ffffff;".($k < count($this->child[$account_hash]) ? "border-bottom:1px solid #efefef;" : NULL).($child_info['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($child_info['total'] < 0 ?
                                                        "($".number_format(($child_info['total'] * -1), 2).")" : "$".number_format($child_info['total'], 2))."
                                                    </td>
                                                </tr>";
                                            }
                                        }
                                        if ($k > 0)
                                            $tbl .= "
                                            <tr>
                                                <td style=\"background-color:#ffffff;padding-left:30px;padding-bottom:10px;\">&nbsp;</td>
                                                <td style=\"background-color:#ffffff;padding-bottom:10px;".($info['total'] < 0 ? "color:#ff0000;" : NULL)."border-top:1px dashed #000000;width:20%;\" class=\"num_field\">".($child_total < 0 ?
                                                    "($".number_format(($child_total * -1), 2).")" : "$".number_format($child_total, 2))."
                                                </td>
                                            </tr>";
                                    }
                                }
                            }

                            $total_gp = _round(bcsub($total_in, $total_cg, 4), 2);

                            $tbl .= "
                            <tr>
                                <td style=\"border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;border-right:1px solid #cccccc;padding-left:15px;font-weight:bold;\">Total Cost of Goods Sold</td>
                                <td style=\"border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;font-weight:bold;".($total_cg < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_cg < 0 ?
                                    "($".number_format(($total_cg * -1), 2).")" : "$".number_format($total_cg, 2))."
                                </td>
                            </tr>
                            <tr>
                                <td style=\"background-color:#ffffff;padding-top:5px;\" colspan=\"2\">&nbsp;</td>
                            </tr>
                            <tr>
                                <td style=\"font-size:15px;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">Gross Profit</td>
                                <td style=\"font-weight:bold;font-size:15px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;".($total_gp < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_gp < 0 ?
                                    "($".number_format(($total_gp * -1), 2).")" : "$".number_format($total_gp, 2))."
                                </td>
                            </tr>
                            <tr>
                                <td colspan=\"2\" style=\"background-color:#ffffff;font-weight:bold;width:250px;padding-top:15px;\">Expenses</td>
                            </tr>";

                            $ex =& $accounts['EX'];
                            $total_ex = 0;
                            while (list($account_hash, $info) = each($ex)) {
                                if ($info['total'] != 0 || !$this->current_report['hide_empty'] || $info['placeholder'] == 1 || $this->child[$account_hash]) {
                                    $total_ex += $info['total'];
                                    $tbl .= "
                                    <tr>
                                        <td style=\"background-color:#ffffff;padding-left:15px;border-bottom:1px solid #efefef;\">".($info['account_no'] ? $info['account_no']." - " : NULL).$info['account_name']."</td>
                                        <td style=\"background-color:#ffffff;border-bottom:1px solid #efefef;".($info['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($info['total'] < 0 ?
                                            "($".number_format(($info['total'] * -1), 2).")" : "$".number_format($info['total'], 2))."
                                        </td>
                                    </tr>";
                                    if ($this->child[$account_hash]) {
                                        $child_total = $info['total'];
                                        reset($this->child[$account_hash]);
                                        $k = 0;
                                        while (list($child_hash, $child_info) = each($this->child[$account_hash])) {
                                            if ($child_info['total'] != 0 || !$this->current_report['hide_empty']) {
                                                $k++;
                                                $child_total += $child_info['total'];
                                                $total_ex += $child_info['total'];
                                                $tbl .= "
                                                <tr>
                                                    <td style=\"background-color:#ffffff;padding-left:30px;".($k < count($this->child[$account_hash]) ? "border-bottom:1px solid #efefef;" : NULL)."\">".($child_info['account_no'] ? $child_info['account_no']." - " : NULL).$child_info['account_name']."</td>
                                                    <td style=\"background-color:#ffffff;".($k < count($this->child[$account_hash]) ? "border-bottom:1px solid #efefef;" : NULL).($child_info['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($child_info['total'] < 0 ?
                                                        "($".number_format(($child_info['total'] * -1), 2).")" : "$".number_format($child_info['total'], 2))."
                                                    </td>
                                                </tr>";
                                            }
                                        }
                                        if ($k > 0)
                                            $tbl .= "
                                            <tr>
                                                <td style=\"background-color:#ffffff;padding-left:30px;padding-bottom:10px;\">&nbsp;</td>
                                                <td style=\"background-color:#ffffff;padding-bottom:10px;".($info['total'] < 0 ? "color:#ff0000;" : NULL)."border-top:1px dashed #000000;width:20%;\" class=\"num_field\">".($child_total < 0 ?
                                                    "($".number_format(($child_total * -1), 2).")" : "$".number_format($child_total, 2))."
                                                </td>
                                            </tr>";
                                    }
                                }
                            }

                            $tbl .= "
                            <tr>
                                <td style=\"border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;border-right:1px solid #cccccc;padding-left:15px;font-weight:bold;\">Total Expenses</td>
                                <td style=\"border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;font-weight:bold;".($total_ex < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_ex < 0 ?
                                    "($".number_format(($total_ex * -1), 2).")" : "$".number_format($total_ex, 2))."
                                </td>
                            </tr>";

                            $net_income = _round(bcsub($total_gp, $total_ex, 4), 2);

                            $tbl .= "
                            <tr>
                                <td style=\"background-color:#ffffff;padding-top:5px;\" colspan=\"2\">&nbsp;</td>
                            </tr>
                            <tr>
                                <td style=\"font-size:15px;font-weight:bold;border-top:1px solid #cccccc;background-color:#efefef;\">Net Profit</td>
                                <td style=\"font-weight:bold;font-size:15px;border-top:1px solid #cccccc;background-color:#efefef;".($net_income < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($net_income < 0 ?
                                    "($".number_format(($net_income * -1), 2).")" : "$".number_format($net_income, 2))."
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>";
            }

            $tbl .= "
            </table>";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_income_statement');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_income_statement', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Income Statement")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("To Date",
																    	  "This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array('*',
																		  1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9), "onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Hide accounts with a zero balance?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=hide_empty",
                                                                        "value=1",
                                                                        ($this->current_report['hide_empty'] || !$this->current_report ? "checked" : NULL))."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Exclude year-end closing entries?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=hide_close",
                                                                        "value=1",
                                                                        ($this->current_report['hide_close'] ? "checked" : NULL))."
                                            </td>
                                        </tr>
										<!--<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Comparison: </td>
											<td style=\"background-color:#ffffff;vertical-align:top;padding-top:10px;\">".$this->form->select("compare", array("No Comparison", "Compare Against Previous Cycle", "Compare Against Previous 2 Cycles", "Compare Against Previous 3 Cycles"), $this->current_report['compare'], array(0, 1, 2, 3), "blank=1")."</td>
										</tr>-->
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_income_statement($report_hash=NULL) {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}
		$from = $_POST['from'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($from == 'download' || $doit_print || $from_saved) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$compare = $this->current_report['compare'];
			$hide_empty = $this->current_report['hide_empty'];
			$hide_close = $this->current_report['hide_close'];
			if ($timeframe == 9) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
		} else {
			$report_hash = $_POST['report_hash'];
			$timeframe = $_POST['timeframe'];
			$hide_empty = $_POST['hide_empty'];
			$hide_close = $_POST['hide_close'];
			if ($timeframe == 9) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}

			if ($compare = $_POST['compare'])
				$this->compare = $compare;
		}
		$save = $_POST['save'];
		$saved_cat = "income_statement";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];


		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if (($timeframe == 9 && !$sort_from_date) || ($timeframe == 9 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		if ($this->content['error'])
			return;

		switch ($timeframe) {
			//To Date
			case '*':
			$this->report_date_end = date("Y-m-d");
			$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			break;

			//This Month
			case 1:
			$this->report_date_start = date("Y-m-01");
			$this->report_date_end = date("Y-m-t");
			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//Last Month
			case 2:
			$this->report_date_start = date("Y-m-01", strtotime(date("Y-m-d")." -1 month"));
			$this->report_date_end = date("Y-m-t", strtotime(date("Y-m-d")." -1 month"));
			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//This Quarter
			case 3:
			list($this->report_date_start, $this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")), date("Y"));
			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//Last Quarter
			case 4:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($start, $date) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//This Period
			case 5:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//Last Period
			case 6:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//This Year
			case 7:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t", strtotime(date("Y-".($month + 11)."-01")));
			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//Last Year
			case 8:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t", strtotime(date($last_year."-".($month + 11)."-01")));
			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;

			//Specific Date
			case 9:
			$this->report_date_start = $sort_from_date;
			$this->report_date_end = $sort_to_date;
			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			break;
		}

		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		if ($from != 'download' && !$doit_print) {
			$str = "timeframe=$timeframe|compare=$compare|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|hide_empty=$hide_empty|hide_close=$hide_close";
			if (!$report_hash) {
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
				while (global_classes::key_exists('reports', 'report_hash', $report_hash))
					$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

				$this->db->query("INSERT INTO `reports`
								  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `sql`)
								  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".addslashes($sql)."')");

				if ($share && (count($group_share) || count($sales_rep_share))) {
					for ($i = 0; $i < count($group_share); $i++)
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."')");

					for ($i = 0; $i < count($sales_rep_share); $i++)
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
				}
			} elseif (!$from_saved) {
				$existing = true;
				$this->db->query("UPDATE `reports`
								  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' , `sql` =  '".addslashes($sql)."'
								  WHERE `report_hash` = '$report_hash'");

				if (!$share)
					$this->db->query("DELETE FROM `reports_share`
									  WHERE `report_hash` = '".$this->report_hash."'");
				else {
					if (!is_array($sales_rep_share))
						$sales_rep_share = array();
					if (!is_array($group_share))
						$group_share = array();

					//Share or revoke to users
					$result = $this->db->query("SELECT `user_hash`
												FROM `reports_share`
												WHERE `report_hash` = '$report_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$current_share_users[] = $row['user_hash'];

					if (!is_array($current_share_users))
						$current_share_users = array();

					$to_remove = array_diff($current_share_users, $sales_rep_share);
					if (is_array($to_remove)) {
						while (list($i) = each($to_remove))
							$this->db->query("DELETE FROM `reports_share`
											  WHERE `user_hash` = '".$current_share_users[$i]."'");
					}
					$to_add = array_diff($sales_rep_share, $current_share_users);
					if (is_array($to_add)) {
						while (list($i) = each($to_add))
							$this->db->query("INSERT INTO `reports_share`
											  (`report_hash` , `user_hash`)
											  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
					}

					//Share or revoke to groups
					$result = $this->db->query("SELECT `group_hash`
												FROM `reports_share`
												WHERE `report_hash` = '$report_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$current_share_groups[] = $row['group_hash'];

					if (!is_array($current_share_groups))
						$current_share_groups = array();

					$to_remove = array_diff($current_share_groups, $group_share);
					if (is_array($to_remove)) {
						while (list($i) = each($to_remove))
							$this->db->query("DELETE FROM `reports_share`
											  WHERE `group_hash` = '".$current_share_groups[$i]."'");
					}
					$to_add = array_diff($group_share, $current_share_groups);
					if (is_array($to_add)) {
						while (list($i) = each($to_add))
							$this->db->query("INSERT INTO `reports_share`
											  (`report_hash` , `group_hash`)
											  VALUES ('$report_hash' , '".$group_share[$i]."'");
					}
				}
			}
		}
		$accounts = array('EX' => array(),
						  'IN' => array(),
						  'CG' => array());
		$acct = new accounting($this->current_hash);
		$result = $this->db->query("SELECT accounts.account_no , accounts.account_name , accounts.parent_hash ,
								    accounts.account_no , journal.account_hash , account_types.type_code ,
									ROUND( SUM( journal.debit ), 2) AS debit_total , ROUND( SUM( journal.credit ), 2) AS credit_total,
									ROUND( SUM(
                                        CASE
                                        WHEN account_types.account_type = 'DR' THEN
                                            ( journal.debit - journal.credit ) ELSE
                                            ( journal.credit - journal.debit )
                                        END
                                    ), 2) AS balance
									FROM `journal`
									LEFT JOIN `accounts` ON accounts.account_hash = journal.account_hash
									LEFT JOIN `account_types` ON account_types.type_code = accounts.account_type
									WHERE ".($sql ?
                                        $sql . " AND " : NULL)."account_types.account_side = 'P' ".($hide_close ? "
                                        AND journal.trans_type <> 'CL'" : NULL)."
									GROUP BY journal.account_hash");
		while ($row = $this->db->fetch_assoc($result)) {

			if ($row['parent_hash']) {
				$order['c'][ $row['account_hash'] ] = $row['account_no'];
				$type[ $row['account_hash'] ] = $row['parent_hash'];
				$child[ $row['parent_hash'] ][ $row['account_hash'] ] = array("account_name" => $row['account_name'],
																	          "account_no"	 => $row['account_no'],
																	          "total"		 => $row['balance']);
			} else {
				$order['p'][ $row['account_hash'] ] = $row['account_no'];
				$type[ $row['account_hash'] ] = $row['type_code'];
				$accounts[ $row['type_code'] ][ $row['account_hash'] ] = array("account_name" => $row['account_name'],
																		       "account_no"	  => $row['account_no'],
																		       "total"		  => $row['balance']);
			}
		}
		while (list($parent_hash, $child_hash) = each($child)) {
		    if (!isset($accounts['IN'][$parent_hash]) && !isset($accounts['EX'][$parent_hash]) && !isset($accounts['CG'][$parent_hash])) {
                $acct->fetch_account_record($parent_hash);

                $type[$acct->account_hash] = $acct->current_account['account_type'];
                $order['p'][$acct->account_hash] = $acct->current_account['account_no'];
                $accounts[$acct->current_account['account_type']][$parent_hash] = array('account_name'  =>  $acct->current_account['account_name'],
                                                                                        'account_no'    =>  $acct->current_account['account_no'],
                                                                                        'placeholder'   =>  1,
                                                                                        'total'         =>  0);
		    }
		}

		if (!$hide_empty) {
            $r = $this->db->query("SELECT accounts.account_hash , accounts.account_no ,
                                   accounts.account_name , account_types.type_code ,
                                   accounts.parent_hash , COUNT(journal.obj_id) AS t
                                   FROM accounts
                                   LEFT JOIN journal ON journal.account_hash = accounts.account_hash
                                   LEFT JOIN account_types ON account_types.type_code = accounts.account_type
                                   WHERE account_types.account_side = 'P'
                                   GROUP BY accounts.account_hash
                                   ORDER BY accounts.account_no");
            while ($row = $this->db->fetch_assoc($r)) {
            	if ($row['parent_hash'] && !isset($accounts[$row['type_code']][$row['parent_hash']])) {
                	$acct->fetch_account_record($row['parent_hash']);
                	$order['p'][$acct->account_hash] = $acct->current_account['account_no'];
                    $accounts[$row['type_code']][$acct->account_hash] = array("account_name"    =>  $acct->current_account['account_name'],
                                                                              "account_no"      =>  $acct->current_account['account_no'],
                                                                              "total"           =>  0,
                                                                              "placeholder"     =>  1);
                }
                if ($row['parent_hash'] && !isset($child[$row['parent_hash']][$row['account_hash']])) {
                	$order['c'][$row['account_hash']] = $row['account_no'];
                	$type[$row['account_hash']] = $row['parent_hash'];
                    $child[$row['parent_hash']][$row['account_hash']] = array("account_name"    =>  $row['account_name'],
                                                                              "account_no"      =>  $row['account_no'],
                                                                              "total"           =>  0,
                                                                              "placeholder"     =>  1);
                }
                if (!$row['parent_hash'] && !isset($accounts[$row['type_code']][$row['account_hash']])) {
                	$order['p'][$row['account_hash']] = $row['account_no'];
					$type[$row['account_hash']] = $row['parent_hash'];
                    $accounts[$row['type_code']][$row['account_hash']] = array("account_name"    =>  $row['account_name'],
                                                                               "account_no"      =>  $row['account_no'],
                                                                               "total"           =>  0,
                                                                               "placeholder"     =>  1);
                }
            }
		}

		//Sort
		natsort($order['p']);
		while (list($account_hash, $nothing) = each($order['p']))
            $this->accounts[$type[$account_hash]][$account_hash] =& $accounts[$type[$account_hash]][$account_hash];

		natsort($order['c']);
		while (list($account_hash, $nothing) = each($order['c']))
            $this->child[$type[$account_hash]][$account_hash] =& $child[$type[$account_hash]][$account_hash];

		$this->report_hash = $report_hash;

		if ($from == 'download')
			return;
		else {
			$this->content['action'] = 'close';
			$this->content['html']['place_holder'] = $this->income_statement(1);
		}
		return;
	}

	function trail_bal_details() {

		if ( $local = func_get_arg(0) ) {

			$account_hash = func_get_arg(1);
			$timeframe = func_get_arg(2);

			$report_hash = $this->report_hash;

		} else {

			$account_hash = $this->ajax_vars['account_hash'];
			$timeframe = $this->ajax_vars['timeframe'];
			$report_hash = $this->ajax_vars['report_hash'];
			$detail_date = $this->ajax_vars['detail_date'];
			$this->report_date_start = $this->ajax_vars['report_date_start'];
	        $this->report_date_end = $this->ajax_vars['report_date_end'];
			$detail_date_end = $this->ajax_vars['detail_date_end'];

		}

		$accounting = new accounting($this->current_hash);
		if ( ! $accounting->fetch_account_record($account_hash) )
    		return $this->__trigger_error("System error encountered when attempting to lookup account record. Please reload window and try again. <!-- Tried fetching account [ $account_hash ] -->", E_USER_ERROR, __FILE__, __LINE__, 1);

		$type = $accounting->current_account['account_action'];
		$account_name = ( $accounting->current_account['account_no'] ? "{$accounting->current_account['account_no']} " : NULL ) . stripslashes($accounting->current_account['account_name']);

		unset($accounting);

		if ( ! $timeframe ) {

			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
		}

		switch ( $timeframe ) {

			case '*': # To Date

			$this->report_date_end = date("Y-m-d");
			if ( ! $detail_date )
				$detail_date = date("Y-m-d", strtotime("{$this->report_date_end} -30 days"));
			else
				$detail_date = date("Y-m-d", strtotime("$detail_date -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while ( strtotime($loop_date) >= strtotime( ( defined('SYSTEM_START_DATE') ? SYSTEM_START_DATE : date("2007-m-d") ) ) ) {

				$result = $this->db->query("SELECT COUNT( * ) AS Total
											FROM journal t1
											WHERE t1.account_hash = '$account_hash' AND t1.date BETWEEN '$loop_date' AND DATE_FORMAT( DATE_ADD($loop_date, INTERVAL 30 DAY), '%Y-%m-%d')
											GROUP BY t1.audit_id");
				$loop_total += (int)$this->db->num_rows($result);
				$loop_date = date("Y-m-d", strtotime("$loop_date -30 days"));
				if ( $loop_total >= 50 )
					break;
			}

			if ( $loop_total < 50 ) {

				unset($detail_date);
				$sql = "t1.date <= '{$this->report_date_end}'";
			} else
				$sql = "t1.date BETWEEN '$detail_date' AND '{$this->report_date_end}'";

			break;

			case 1: # Through This Month

			$this->report_date_end = date("Y-m-t");
			if ( ! $detail_date )
				$detail_date = date("Y-m-01");
			else
				$detail_date = date("Y-m-d", strtotime("$detail_date -30 days"));

			$sql = "t1.date BETWEEN '$detail_date' AND '{$this->report_date_end}'";

			break;

			case 3: # Through Last Month

			$this->report_date_end = date("Y-m-t", strtotime( date("Y-m-d") . " -1 month"));
			if ( ! $detail_date )
				$detail_date = date("Y-m-01", strtotime( date("Y-m-d") . " -1 month"));
			else
				$detail_date = date("Y-m-d", strtotime("$detail_date -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while ( strtotime($loop_date) >= strtotime( ( defined('SYSTEM_START_DATE') ? SYSTEM_START_DATE : date("2007-m-d") ) ) ) {

				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM journal t1
											WHERE t1.account_hash = '$account_hash' AND t1.date BETWEEN '$loop_date' AND DATE_FORMAT( DATE_ADD($loop_date, INTERVAL 30 DAY), '%Y-%m-%d')
											GROUP BY t1.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d", strtotime("$loop_date -30 days"));
				if ( $loop_total >= 50 )
					break;
			}

			if ( $loop_total < 50 ) {

				unset($detail_date);
				$sql = "t1.date <= '{$this->report_date_end}'";
			} else
				$sql = "t1.date BETWEEN '$detail_date' AND '{$this->report_date_end}'";

			break;

			case 5: # Through This Quarter

			list($this->report_date_start, $this->report_date_end) = get_quarter_dates( get_quarter( date("Y-m-d") ), date("Y") );
			if ( ! $detail_date )
				$detail_date = $this->report_date_start;
			else
				$detail_date = date("Y-m-d", strtotime("$detail_date -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while ( strtotime($loop_date) >= strtotime( ( defined('SYSTEM_START_DATE') ? SYSTEM_START_DATE : date("2007-m-d") ) ) ) {

				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM journal t1
											WHERE t1.account_hash = '$account_hash' AND t1.date BETWEEN '$loop_date' AND DATE_FORMAT( DATE_ADD($loop_date, INTERVAL 30 DAY), '%Y-%m-%d')
											GROUP BY t1.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d", strtotime("$loop_date -30 days"));
				if ( $loop_total >= 50 )
					break;
			}
			if ( $loop_total < 50 ) {

				unset($detail_date);
				$sql = "t1.date <= '{$this->report_date_end}'";
			} else
				$sql = "t1.date BETWEEN '$detail_date' AND '{$this->report_date_end}'";

			break;

			//Through Last Quarter
			case 7:
			$current_qtr = get_quarter( date("Y-m-d") );
			if ( $current_qtr == 1 ) {

				$previous_qtr = get_quarter( date("Y-m-d", strtotime( date("Y-m-d") . " -4 months") ) );
				list($report_date_start, $date) = get_quarter_dates($previous_qtr, date("Y", strtotime( date("Y-m-d") . " -4 months") ) );
			} else
				list($report_date_start, $this->report_date_end) = get_quarter_dates( $current_qtr - 1, date("Y") );

			if ( ! $detail_date )
				$detail_date = $report_date_start;
			else
				$detail_date = date("Y-m-d", strtotime("$detail_date -30 days"));


			$loop_date = $detail_date;
			$loop_total = 0;
			while ( strtotime($loop_date) >= strtotime( ( defined('SYSTEM_START_DATE') ? SYSTEM_START_DATE : date("2007-m-d") ) ) ) {
				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM journal t1
											WHERE t1.account_hash = '$account_hash' AND t1.date BETWEEN '$loop_date' AND DATE_FORMAT( DATE_ADD($loop_date, INTERVAL 30 DAY), '%Y-%m-%d')
											GROUP BY journal.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d", strtotime("$loop_date -30 days"));
				if ( $loop_total >= 50 )
					break;
			}
			if ( $loop_total < 50 ) {

				unset($detail_date);
				$sql = "t1.date <= '{$this->report_date_end}'";
			} else
				$sql = "t1.date BETWEEN '$detail_date' AND '{$this->report_date_end}'";

			break;

			case 9: # Through This Period

			$period_info = get_period_info( date("Y-m-d") );
			$report_date_start = $period_info['period_start'];
			$this->report_date_end = $period_info['period_end'];

			if ( ! $detail_date )
				$detail_date = $report_date_start;
			else
				$detail_date = date("Y-m-d", strtotime("$detail_date -30 days"));


			$loop_date = $detail_date;
			$loop_total = 0;
			while ( strtotime($loop_date) >= strtotime(SYSTEM_START_DATE) ) {

				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM journal t1
											WHERE t1.account_hash = '$account_hash' AND t1.date BETWEEN '$loop_date' AND DATE_FORMAT( DATE_ADD($loop_date, INTERVAL 30 DAY), '%Y-%m-%d')
											GROUP BY t1.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d", strtotime("$loop_date -30 days"));
				if ( $loop_total >= 50 )
					break;
			}
			if ( $loop_total < 50 ) {

				unset($detail_date);
				$sql = "t1.date <= '{$this->report_date_end}'";
			} else
				$sql = "t1.date BETWEEN '$detail_date' AND '{$this->report_date_end}'";

			break;

			//Through Last Period
			case 11:
			$period_info = get_previous_period( date("Y-m-d") );

			$report_date_start = $period_info['period_start'];
			$this->report_date_end = $period_info['period_end'];

			if ( ! $detail_date )
				$detail_date = $report_date_start;
			else
				$detail_date = date("Y-m-d", strtotime("$detail_date -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while ( strtotime($loop_date) >= strtotime(SYSTEM_START_DATE) ) {

				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM journal t1
											WHERE t1.account_hash = '$account_hash' AND t1.date BETWEEN '$loop_date' AND DATE_FORMAT( DATE_ADD($loop_date, INTERVAL 30 DAY), '%Y-%m-%d')
											GROUP BY t1.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d", strtotime("$loop_date -30 days"));
				if ( $loop_total >= 50 )
					break;
			}
			if ( $loop_total < 50 ) {

				unset($detail_date);
				$sql = "t1.date <= '{$this->report_date_end}'";
			} else
				$sql = "t1.date BETWEEN '$detail_date' AND '{$this->report_date_end}'";

			break;

			case 13: # Through This Year

			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if ( ! $month || ! $day )
				$month = $day = 1;

			$report_date_start = date("Y-$month-$day");
			$this->report_date_end = date("Y-" . ($month + 11) . "-" . date("t", strtotime( date("Y-" . ($month + 11) . "-01") ) ) );

			if ( ! $detail_date )
				$detail_date = $report_date_start;
			else
				$detail_date = date("Y-m-d", strtotime("$detail_date -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while ( strtotime($loop_date) >= strtotime(SYSTEM_START_DATE) ) {

				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM journal t1
											WHERE t1.account_hash = '$account_hash' AND t1.date BETWEEN '$loop_date' AND DATE_FORMAT( DATE_ADD($loop_date, INTERVAL 30 DAY), '%Y-%m-%d')
											GROUP BY t1.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d", strtotime("$loop_date -30 days"));
				if ( $loop_total >= 50 )
					break;
			}
			if ( $loop_total < 50 ) {

				unset($detail_date);
				$sql = "t1.date <= '{$this->report_date_end}'";
			} else
				$sql = "t1.date BETWEEN '$detail_date' AND '{$this->report_date_end}'";

			break;

			case 15: # Through Last Year

			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if ( ! $month || ! $day )
				$month = $day = 1;

			$last_year = date("Y") - 1;
			$report_date_start = "{$last_year}-{$month}-{$day}";
			$this->report_date_end = "{$last_year}-" . ( $month + 11 ) . "-" . date("t", strtotime( date("{$last_year}-" . ( $month + 11 ) . "-01") ) );

			if ( ! $detail_date )
				$detail_date = $report_date_start;
			else
				$detail_date = date("Y-m-d", strtotime("$detail_date -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while ( strtotime($loop_date) >= strtotime(SYSTEM_START_DATE) ) {

				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM journal t1
											WHERE t1.account_hash = '$account_hash' AND t1.date BETWEEN '$loop_date' AND DATE_FORMAT( DATE_ADD($loop_date, INTERVAL 30 DAY), '%Y-%m-%d')
											GROUP BY t1.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d", strtotime("$loop_date -30 days"));
				if ( $loop_total >= 50 )
					break;
			}
			if ( $loop_total < 50 ) {

				unset($detail_date);
				$sql = "t1.date <= '{$this->report_date_end}'";
			} else
				$sql = "t1.date BETWEEN '$detail_date' AND '{$this->report_date_end}'";

			break;

			case 17: # Through Specific Date

			if ( ! $detail_date )
				$detail_date = date("Y-m-d", strtotime("{$this->report_date_end} -30 days"));
			else
				$detail_date = date("Y-m-d", strtotime("$detail_date -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while ( strtotime($loop_date) >= strtotime(SYSTEM_START_DATE) ) {

				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM journal t1
											WHERE t1.account_hash = '$account_hash' AND t1.date BETWEEN '$loop_date' AND DATE_FORMAT( DATE_ADD($loop_date, INTERVAL 30 DAY), '%Y-%m-%d')
											GROUP BY t1.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d", strtotime("$loop_date -30 days"));
				if ( $loop_total >= 50 )
					break;
			}
			if ( $loop_total < 50 ) {

				unset($detail_date);
				$sql = "t1.date <= '".($detail_date_end ? $detail_date_end : $this->report_date_end)."'";
			} else
				$sql = "t1.date BETWEEN '".$detail_date."' AND '{$this->report_date_end}'";

			break;

			# Selected Time Period Only, Not Through Date
			case 2:
			case 4:
			case 6:
			case 8:
			case 10:
			case 12:
			case 14:
			case 16;
			case 18:

            unset($detail_date);
            $sql = "t1.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";

			break;
		}

        if ( $this->current_report['customer_filter'] && is_array($this->current_report['customer_filter']) ) {

            $customer_filter = array_unique($this->current_report['customer_filter']);
            $customer_filter = array_values($customer_filter);

            array_walk($customer_filter, 'add_quotes', "'");
            $sql_p[] = "t1.customer_hash IN (" . implode(", ", $customer_filter) . ")";
            array_walk($customer_filter, 'strip_quotes');
        }

        if ( $this->current_report['proposal_filter'] && is_array($this->current_report['proposal_filter']) ) {

            $proposal_filter = array_unique($this->current_report['proposal_filter']);
            $proposal_filter = array_values($proposal_filter);

            array_walk($proposal_filter, 'add_quotes', "'");
            $sql_p[] = "t1.proposal_hash IN (" . implode(", ", $proposal_filter) . ")";
            array_walk($proposal_filter, 'strip_quotes');
        }

        if ( $sql_p )
            $sql = ( $sql ? "$sql AND " : NULL ) . implode(" AND ", $sql_p);

		if ( $detail_date ) # Get the opening balance, if one exists
			$sub_query = "
			(
    			SELECT " .
    			( $type == 'DR' ?
                    "ROUND( SUM( journal.debit ), 2) - ROUND( SUM( journal.credit ), 2)" : "ROUND( SUM(journal.credit ), 2) - ROUND( SUM(journal.debit ), 2)"
    			) . "
				FROM `journal`
				WHERE journal.account_hash = '$account_hash' AND journal.date <= '$detail_date') AS previous_balance";

        # TODO1: Get starting balance
        # TODO2: Subquery valid_ar/valid_ap

        $result = $this->db->query("SELECT
	                                    t1.*,
	                                    t1.check_no AS payment_check_no,
	                                    t2.account_name,
	                                    t2.account_no,
	                                    t3.proposal_no,
	                                    t3.proposal_descr,
	                                    t4.invoice_no AS ar_invoice_no,
	                                    t5.invoice_no AS ap_invoice_no,
	                                    t6.customer_name,
	                                    t7.vendor_name,
	                                    t8.full_name
                                    FROM journal t1
                                    LEFT JOIN accounts t2 ON t2.account_hash = t1.account_hash
                                    LEFT JOIN proposals t3 ON t3.proposal_hash = t1.proposal_hash
                                    LEFT JOIN customer_invoice t4 ON t4.invoice_hash = t1.ar_invoice_hash
                                    LEFT JOIN vendor_payables t5 ON t5.invoice_hash = t1.ap_invoice_hash
                                    LEFT JOIN customers t6 ON t6.customer_hash = t1.customer_hash
                                    LEFT JOIN vendors t7 ON t7.vendor_hash = t1.vendor_hash
                                    LEFT JOIN users t8 ON t8.id_hash = t1.id_hash
                                    WHERE t1.account_hash = '$account_hash' " .
                                    ( $sql ?
                                        " AND $sql " : NULL
                                    ) . "
                                    ORDER BY t1.date ASC, t1.obj_id ASC");
		while ( $row = $this->db->fetch_assoc($result) ) {

			$i++;
			$debit = $credit = 0;
			$amount = bcsub($row['debit'], $row['credit'], 4);

			switch ( $type ) {

				case 'DR':

				if ( bccomp($amount, 0, 2) == 1 )
					$debit = $amount;
				else
					$credit = bcmul($amount, -1, 4);

				break;

				case 'CR':
				if ($amount < 0)
					$credit = $amount * -1;
				else
					$debit = $amount;
				break;
			}
			switch ($row['trans_type']) {
				case 'AR':
				case 'CR':
				if ($row['ar_invoice_hash'] && $row['valid_ar'])
					$onClick = "onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', '".($row['trans_type'] == 'AR' ? "edit_invoice" : "new_deposit")."', 'invoice_hash=".$row['ar_invoice_hash']."', 'popup_id=line_item');\"";

                if ($row['trans_type'] == 'AR')
                    $row['memo'] = str_replace("Customer Invoice: ", "", $row['memo']);

                if ($row['ar_invoice_no'] && !ereg($row['ar_invoice_no'], $row['memo']))
                    $row['memo'] .= "&nbsp;".$row['ar_invoice_no'];

                $title = ($row['trans_type'] == 'CR' ? "Customer Receipt" : "Customer Invoice");
				break;

				case 'AP':
				case 'CD':
				if ($row['ap_invoice_hash'] && $row['valid_ap'])
					$onClick = "onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$row['ap_invoice_hash']."', 'popup_id=line_item');\"";

                if ($row['ap_invoice_no'] && !ereg($row['ap_invoice_no'], $row['memo']))
                    $row['memo'] .= "&nbsp;".$row['ap_invoice_no'];

				$title = ($row['trans_type'] == 'CD' ? "Payment" : "Vendor Invoice");
				break;

				case 'ME':
				//if ($journal_info[$j]['record_hash'])
					//$onClick = "onClick=\"agent.call('proposals', 'sf_loadcontent', 'cf_loadcontent', 'edit_invoice', 'invoice_hash=".$journal_info[$j]['record_hash']."', 'popup_id=line_item');\"";
				$title = "Credit Memo";
				break;

				case 'GJ':
				//if ($journal_info[$j]['record_hash'])
					//$onClick = "onClick=\"agent.call('proposals', 'sf_loadcontent', 'cf_loadcontent', 'edit_invoice', 'invoice_hash=".$journal_info[$j]['record_hash']."', 'popup_id=line_item');\"";
				$title = "General Journal";
				break;

				case 'AD':
				$title = "Adjustment";
				break;
			}

			if ($i == 1 && $row['previous_balance']) {
				if(!$this->doit_print) {
					$a = "
					<tr>
					    <td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;padding-left:20px;border-top:1px solid #cccccc;border-right:1px solid #cccccc;\">
                            <div style=\"width:369px;\">
	    					    <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'trail_bal_details', 'account_hash=".$account_hash."', 'report_hash=".$this->report_hash."', 'detail_date=".$detail_date."')\" title=\"Show more detail\">
	        					    Previous Balance
	        					</a> As Of ".date(DATE_FORMAT, strtotime($detail_date))."
	        				</div>
            			</td>
					    <td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;padding:1px;border-top:1px solid #cccccc;border-right:1px solid #cccccc;\" class=\"num_field\">
                            <div style=\"width:197px;\">
	    					    ".(($type == 'DR' && $row['previous_balance'] > 0) || ($type == 'CR' && $row['previous_balance'] < 0) ?
	        					    "$".number_format(($row['previous_balance'] < 0 ?
	                					($row['previous_balance'] * -1) : $row['previous_balance']), 2) : "&nbsp;")."
                            </div>
    					</td>
					    <td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;padding:1px;border-top:1px solid #cccccc;padding-right:5px;\" class=\"num_field\">
                            <div style=\"width:175px;\">
	    					    ".(($type == 'CR' && $row['previous_balance'] > 0) || ($type == 'DR' && $row['previous_balance'] < 0) ?
	        					    "$".number_format(($row['previous_balance'] < 0 ?
	                					($row['previous_balance'] * -1) : $row['previous_balance']), 2) : "&nbsp;")."
                            </div>
    					</td>
					</tr>";
				} else {
					$a[] = "Previous Balance As Of ".date(DATE_FORMAT, strtotime($detail_date));
					$b[] = (($type == 'DR' && $row['previous_balance'] > 0) || ($type == 'CR' && $row['previous_balance'] < 0) ? "$".number_format(($row['previous_balance'] < 0 ? ($row['previous_balance'] * -1) : $row['previous_balance']), 2) : "");
					$c[] = (($type == 'CR' && $row['previous_balance'] > 0) || ($type == 'DR' && $row['previous_balance'] < 0) ? "$".number_format(($row['previous_balance'] < 0 ? ($row['previous_balance'] * -1) : $row['previous_balance']), 2) : "");
				}
			}

			if (!$this->doit_print) {
                $a .= "
                <tr>
                    <td style=\"font-size:8pt;padding-left:20px;border-top:1px solid #cccccc;border-right:1px solid #cccccc;\" class=\"white_bg\" ".($onClick ? "onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className='white_bg'\" $onClick " : NULL).">
						<div style=\"width:369px;\">
                            <div>
	    						<span ".($row['full_name'] ?
		                            "title=\"Created by ".stripslashes($row['full_name'])."\"" : NULL).">
	    	                            ".date(DATE_FORMAT, strtotime($row['date'])).($row['timestamp'] ?
		                                "&nbsp;".date(TIMESTAMP_FORMAT, $row['timestamp']) : NULL)."&nbsp;
		                        </span>".
		                        ($title ?
		                            $title : NULL)."
                            </div>".
	                        ($row['customer_name'] || $row['vendor_name'] ? "
	                            <i>".($row['customer_name'] ?
	                                stripslashes($row['customer_name']) : stripslashes($row['vendor_name']))."</i>".($row['memo'] ?
                                        " - " : NULL) : NULL).
	                        ($row['memo'] ?
	                            stripslashes($row['memo']) : NULL)."
                        </div>
                    </td>
                    <td class=\"num_field\" style=\"background-color:#ffffff;font-size:8pt;padding-left:5px;border-top:1px solid #cccccc;border-right:1px solid #cccccc;vertical-align:bottom;\">
                        <div style=\"width:197px;\">
                            ".($debit > 0 ? "$".number_format($debit, 2) : "&nbsp;")."
                        </div>
                    </td>
                    <td class=\"num_field\" style=\"vertical-align:bottom;background-color:#ffffff;font-size:8pt;padding-right:5px;border-top:1px solid #cccccc;\">
                        <div style=\"width:175px;\">
                            ".($credit > 0 ? "$".number_format($credit, 2) : "&nbsp;")."
                        </div>
                    </td>
                </tr>";
			} else {
				if ($this->doit_excel) {
					$a[] = $title;
					$b[] = $debit;
					$c[] = $credit;
					$d[] = date(DATE_FORMAT, strtotime($row['date']));
					$e[] = $row['proposal_no'];
					$f[] = $row['memo'];
				} else {
					$a[] = $title . " ". date(DATE_FORMAT, strtotime($row['date'])).($row['memo'] ? " - ".stripslashes($row['memo']) : NULL);
					$b[] = $debit;
					$c[] = $credit;
				}
			}

		}

		if (!$this->doit_print) {
            $a = "
            <div style=\"width:833px;overflow-x:hidden;overflow-y:scroll;".($i > 10 ? "height:275px;" : NULL)."\">
            <table style=\"background-color:#cccccc;\" cellpadding=\"5\" cellspacing=\"0\">
                <tr>
                    <td style=\"background-color:#efefef;font-weight:bold;font-size:8pt;padding-left:20px;border-right:1px solid #cccccc;\">
                        <div style=\"width:385px;\">
	                        Reference
	                        <span style=\"margin-left:5px;font-style:italic;\">$account_name</span>
                        </div>
                    </td>
                    <td style=\"background-color:#efefef;font-weight:bold;font-size:8pt;padding-left:5px;border-right:1px solid #cccccc\" class=\"num_field\">
                        <div style=\"width:202px;\">
                            Debit
                        </div>
                    </td>
                    <td style=\"background-color:#efefef;font-weight:bold;font-size:8pt;border-right:1px solid #cccccc;padding-right:5px;\" class=\"num_field\">
                        <div style=\"width:185px;\">
                            Credit
                        </div>
                    </td>
                </tr>".($a ?
                $a : "
                <tr>
                    <td style=\"background-color:#ffffff;font-size:8pt;padding-left:20px;border-top:1px solid #cccccc;border-right:1px solid #cccccc;\" colspan=\"3\">".($detail_date ? "<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'trail_bal_details', 'account_hash=".$account_hash."', 'report_hash=".$this->report_hash."', 'detail_date=".$detail_date."')\" title=\"Show more detail\">No Activity</a> As Of ".date(DATE_FORMAT, strtotime($detail_date)) : "No Activity")."</td>
                </tr>")."
                <tr>
                    <td style=\"background-color:#efefef;border-top:1px solid #cccccc;height:10px;\" colspan=\"3\"></td>
                </tr>
            </table>
            </div>";
		} elseif (!$this->doit_excel) {
			$par = $a;
			$deb = $b;
			$cre = $c;
		}

		if ($local) {
		    if ($this->doit_print) {
		    	if ($this->doit_excel)
			    	return array($a, $b, $c, $d, $e, $f);
			    else
			    	return array($par, $deb, $cre);
		    } else
			    return array($a);
	    } else {
			$this->content['html']['detail_'.$account_hash] = $a;
			$this->content['jscript'] = array("toggle_display('detailtr_".$account_hash."', 'block');");
		}

		return;
	}

	function trial_balance($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" >
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Trial Balance").($this->p->ck('reports', 'V', 'trial_balance') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'trial_balance', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'trial_balance', 'popup_id=report_filter', 'show_print_options=1', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'trial_balance', 'popup_id=report_filter', 'show_xls_options=1', 'report_hash=".$this->report_hash."');\"><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>
						</div>
					</td>
				</tr>";
			$detail =& $this->detail;
			if (is_array($detail)) {
				$tbl .= "
				<tr>
					<td style=\"width:900px;background-color:#ffffff;padding:10px;\">
						<table style=\"background-color:#cccccc;width:800px;\" cellpadding=\"5\" cellspacing=\"1\">
							<tr>
								<td style=\"text-align:center;width:800px;background-color:#efefef;\" colspan=\"".($this->current_report['detail'] == 2 ? "5" : "3")."\">
									<h4 style=\"margin-bottom:5px;color:#00477f;\">".(defined('MY_COMPANY_NAME') ?
										MY_COMPANY_NAME : NULL)."
										<div style=\"margin-top:8px;font-size:10px;\">
											Trial Balance
											<br />".($this->report_date_start ?
    											"Between Dates ".date(DATE_FORMAT, strtotime($this->report_date_start)). " and ".date(DATE_FORMAT, strtotime($this->report_date_end)) : "Through ".date(DATE_FORMAT, strtotime($this->report_date_end)))."
										</div>
									</h4>
								</td>
							</tr>
							<tr>
								<td style=\"background-color:#ffffff;\"><div style=\"width:400px\">&nbsp;</div></td>
								<td style=\"background-color:#ffffff;text-align:center;font-weight:bold;text-align:right;\"><div style=\"width:200px;\">Debit</div></td>
								<td style=\"background-color:#ffffff;text-align:center;font-weight:bold;text-align:right;\"><div style=\"width:200px;\">Credit</div></td>
							</tr>";

						for ($i = 0; $i < count($detail); $i++) {
							$debit = $credit = 0;
							if ($detail[$i]['account_hash'] && $detail[$i]['account_name'] && $detail[$i]['account_hash'] != DEFAULT_PROFIT_ACCT) {
								if (($detail[$i]['account_action'] == 'DR' && $detail[$i]['total'] > 0) || ($detail[$i]['account_action'] == 'CR' && $detail[$i]['total'] < 0)) {
									if ($detail[$i]['total'] < 0)
										$detail[$i]['total'] *= -1;

									$debit = $detail[$i]['total'];
									$debit_total += $debit;
								} elseif (($detail[$i]['account_action'] == 'CR' && $detail[$i]['total'] > 0) || ($detail[$i]['account_action'] == 'DR' && $detail[$i]['total'] < 0)) {
									if ($detail[$i]['total'] < 0)
										$detail[$i]['total'] *= -1;

									$credit = $detail[$i]['total'];
									$credit_total += $credit;
								}

								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;font-weight:bold;\">
                                        <div style=\"width:400px;\">
										<a href=\"javascript:void(0);\" onClick=\"if(\$('detailtr_".$detail[$i]['account_hash']."').getStyle('display')=='block'){toggle_display('detailtr_".$detail[$i]['account_hash']."', 'none');\$('detail_".$detail[$i]['account_hash']."').innerHTML='';} else{agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'trail_bal_details', 'account_hash=".$detail[$i]['account_hash']."', 'report_hash=".$this->report_hash."', 'report_date_start=".$this->report_date_start."', 'report_date_end=".$this->report_date_end."')}\" class=\"link_standard\" title=\"Show trial balance details for this account\">
										    ".($detail[$i]['account_no'] ? $detail[$i]['account_no']." - " : NULL).$detail[$i]['account_name']."
										</a>
									</td>
									<td style=\"background-color:#ffffff;\" class=\"num_field\">
                                        <div style=\"width:200px;\">".($debit > 0 ?
    										"$".number_format($debit, 2) : "&nbsp;")."
                                        </div>
									</td>
									<td style=\"background-color:#ffffff;\" class=\"num_field\">
                                        <div style=\"width:200px;\">".($credit > 0 ?
    										"$".number_format($credit, 2) : "&nbsp;")."
    									</div>
									</td>
								</tr>
								<tr style=\"display:".($this->current_report['detail'] == 2 ? "block" : "none")."\" id=\"detailtr_".$detail[$i]['account_hash']."\">
								    <td colspan=\"3\" style=\"padding:0;width:800px;\" id=\"detail_".$detail[$i]['account_hash']."\">".($this->current_report['detail'] == 2 ?
        								$this->sub_detail[$detail[$i]['account_hash']] : NULL)."
        							</td>
								</tr>";
							}
						}
							$tbl .= "
							<tr>
								<td  style=\"background-color:#efefef;\"><div style=\"width:400px;\">&nbsp;</div></td>
								<td style=\"background-color:#efefef;font-weight:bold;padding-top:25px;font-size:14px;\" class=\"num_field\">
                                    <div style=\"width:200px;\">".($debit_total > 0 ? "
                                        $".number_format($debit_total, 2) : "&nbsp;")."
                                    </div>
                                </td>
								<td style=\"background-color:#efefef;font-weight:bold;padding-top:25px;font-size:14px;\" class=\"num_field\">
								    <div style=\"width:200px;\">".($credit_total > 0 ? "
    								    $".number_format($credit_total, 2) : NULL)."
    								</div>
        						</td>
							</tr>
						</table>
					</td>
				</tr>";
			}

			$tbl .= "
			</table>";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$show_print_options = $this->ajax_vars['show_print_options'];
			$show_xls_options = $this->ajax_vars['show_xls_options'];

			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
                $this->current_report['customer_filter'] = array($this->current_report['customer_filter']);

            if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
                $this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);

			$account_array[''] = "All Accounts";
            $r = $this->db->query("SELECT `account_no` , `account_name` , `account_hash`
                                   FROM `accounts`
                                   WHERE `account_hash` != '".DEFAULT_PROFIT_ACCT."'
                                   ORDER BY accounts.account_no ASC");
            while ($row = $this->db->fetch_assoc($r))
                $account_array[$row['account_hash']] = ($row['account_no'] ? $row['account_no']." - " : NULL).$row['account_name'];

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".($show_print_options ?
                                			$this->form->button("value=Print Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_trial_balance', 'from_print_options=1');")
											 : ($show_xls_options ? $this->form->button("value=Export Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_trial_balance', 'from_xls_options=1');")
											 		: $this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_trial_balance');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
													"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_trial_balance', 'rm=1');") : NULL)))."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : ($show_xls_options ? "Export " : ($show_print_options ? "Print " : NULL))."Trial Balance")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("To Date",
																    	  "Through This Month",
																    	  "This Month Only",
																    	  "Through Last Month",
																    	  "Last Month Only",
																    	  "Through This Quarter",
																    	  "This Quarter Only",
																    	  "Through Last Quarter",
																    	  "Last Quarter Only",
																    	  "Through This Period",
																    	  "This Period Only",
																    	  "Through Last Period",
																    	  "Last Period Only",
																    	  "Through This Year",
																    	  "This Year Only",
																    	  "Through Last Year",
																    	  "Last Year Only",
																    	  "A Specific Date Range"),
																	$this->current_report['timeframe'],
																	array('*', 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 18),
																	"onChange=if(this.options[this.selectedIndex].value==18){toggle_display('timeframe_holder', 'block');}else{toggle_display('timeframe_holder', 'none');}",
                                                                    "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 18 ? "block" : "none").";\" id=\"timeframe_holder\">
												    <span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>
												</div>
											</td>
										</tr>
										<tr>
										    <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be filtered to specific account(s)?</td>
										    <td style=\"background-color:#ffffff;\">
										        ".$this->form->select("account_filter[]",
																	   array_values($account_array),
																	   $this->current_report['account_filter'],
																	   array_keys($account_array),
																	   "multiple",
																	   "blank=1",
																	   "size=4",
																	   "style=width:300px;")."
										    </td>
										</tr>
										<tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Hide accounts with no activity?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=hide_empty",
																	    "value=1",
																	    ($this->current_report['hide_empty'] || !$this->current_report ? "checked" : NULL))."
                                            </td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=proposal",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
                                                if (is_array($this->current_report['proposal_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++)
                                                        $tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer_vendor",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
                                                if (is_array($this->current_report['customer_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
                                                        $tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;\">Show Detail? </td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("detail", array("Simple View", "Detail View"), $this->current_report['detail'], array(1, 2), "blank=1")."</td>
										</tr>".(!$show_print_options && !$show_xls_options ? "
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>" : NULL). "
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

            $jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 18 && $this->current_report['sort_from_date'] && $this->current_report['sort_from_date'] != '0000-00-00' ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
            $jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 18 && $this->current_report['sort_to_date'] && $this->current_report['sort_to_date'] != '0000-00-00' ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_trial_balance() {

		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		// Determine where this function call came from and set appropriate variables
		$report_hash = $_POST['report_hash'];
		$doit_print = $this->doit_print = $_POST['doit_print'];
		$doit_excel = $this->doit_excel = $_POST['doit_excel'];
		$from_saved = $this->ajax_vars['from_saved'];

		$from_print_options = $_POST['from_print_options'];
		$from_xls_options = $_POST['from_xls_options'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($from_xls_options || $from_print_options)
			$doit_print = $this->doit_print = 1;


		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);
			$account_filter = $this->current_report['account_filter'];
			if ($account_filter && !is_array($account_filter))
			    $account_filter = array($account_filter);

			$timeframe = $this->current_report['timeframe'];
			$detail = $this->current_report['detail'];
			$sort_to_date = $this->current_report['sort_to_date'];
			$sort_from_date = $this->current_report['sort_from_date'];
			$hide_empty = $this->current_report['hide_empty'];

			$customer_filter = $this->current_report['customer_vendor_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);

			$proposal_filter = $this->current_report['proposal_filter'];
            if ($proposal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter);

		} else {
			$timeframe = $_POST['timeframe'];
            $account_filter = $_POST['account_filter'];
            if ($account_filter && !is_array($account_filter))
                $account_filter = array($account_filter);

			$sort_to_date = $_POST['sort_to_date'];
			$sort_from_date = $_POST['sort_from_date'];
			$detail = $_POST['detail'];
			$hide_empty = $_POST['hide_empty'];

            $customer_filter = $_POST['customer_vendor_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);

            $proposal_filter = $_POST['proposal_filter'];
            if ($proposal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter);
		}

		if (count($account_filter) > 1 && $account_filter[0] == '')
            array_shift($account_filter);
		elseif (count($account_filter) == 1 && $account_filter[0] == '')
            unset($account_filter);

		$save = $_POST['save'];
		$saved_cat = "trial_balance";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($timeframe == 18 && ((!$sort_to_date && !$sort_from_date) || ($sort_to_date && $sort_from_date && strtotime($sort_from_date) >= strtotime($sort_to_date)))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The date range you specified is invalid! Please make sure you include a valid date range.";
		}
		if ($this->content['error'])
			return;

		switch ($timeframe) {
			//To Date
			case '*':
			$this->report_date_end = date("Y-m-d");
			$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			break;

			//Through This Month
			case 1:
			unset($this->report_date_start);
			$this->report_date_end = date("Y-m-t");
			$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			break;

			//This Month Only
			case 2:
			$this->report_date_start = date("Y-m-01");
			$this->report_date_end = date("Y-m-t");

			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$sql_p2[] = "journal.date < '{$this->report_date_start}'";
			break;

			//Through Last Month
			case 3:
			unset($this->report_date_start);
			$this->report_date_end = date("Y-m-t", strtotime(date("Y-m-d")." -1 month"));
			$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			break;

			//Last Month Only
			case 4:
			$this->report_date_start = date("Y-m-01", strtotime(date("Y-m-d")." -1 month"));
			$this->report_date_end = date("Y-m-t", strtotime(date("Y-m-d")." -1 month"));
			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$sql_p2[] = "journal.date < '{$this->report_date_start}'";
			break;


			//Through This Quarter
			case 5:
			list($this->report_date_start, $this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")), date("Y"));
			unset($this->report_date_start);
			$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			break;

			//This Quarter Only
			case 6:
			list($this->report_date_start, $this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")), date("Y"));
			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$sql_p2[] = "journal.date < '{$this->report_date_start}'";
			break;

			//Through Last Quarter
			case 7:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates($current_qtr - 1, date("Y"));

			unset($this->report_date_start);
			$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			break;

			//Last Quarter Only
			case 8:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d", strtotime(date("Y-m-d")." -4 months")));
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates($previous_qtr, date("Y", strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates($current_qtr - 1, date("Y"));

			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$sql_p2[] = "journal.date < '{$this->report_date_start}'";
			break;

			//Through This Period
			case 9:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				unset($this->report_date_start);
				$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//This Period Only
			case 10:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
				$sql_p2[] = "journal.date < '{$this->report_date_start}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//Through Last Period
			case 11:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				unset($this->report_date_start);
				$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//Last Period Only
			case 12:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
				$sql_p2[] = "journal.date < '{$this->report_date_start}'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//Through This Year
			case 13:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t", strtotime(date("Y-".($month + 11)."-01")));
			unset($this->report_date_start);
			$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			break;

			//This Year Only
			case 14:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t", strtotime(date("Y-".($month + 11)."-01")));
			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$sql_p2[] = "journal.date < '{$this->report_date_start}'";
			break;

			//Through Last Year
			case 15:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t", strtotime(date($last_year."-".($month + 11)."-01")));
			unset($this->report_date_start);
			$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			break;

			//Last Year Only
			case 16:
			list($month, $day) = explode("/", FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t", strtotime(date($last_year."-".($month + 11)."-01")));
			$sql_p[] = "journal.date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			$sql_p2[] = "journal.date < '{$this->report_date_start}'";
			break;

			//Through a Specific Date
			case 17:
			$this->report_date_end = $sort_to_date;
			$sql_p[] = "journal.date <= '{$this->report_date_end}'";
			break;

			//A Specific Date Range
			case 18:
			$this->report_date_start = $sort_from_date;
			$this->report_date_end = $sort_to_date;
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = "journal.date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$sql_p2[] = "journal.date <= '{$this->report_date_start}'";
			} elseif ($sort_from_date && !$sort_to_date) {
				$sql_p[] = "journal.date >= '{$this->report_date_start}'";
				$sql_p2[] = "journal.date < '{$this->report_date_start}'";
			} else {
				$sql_p[] = "journal.date <= '{$this->report_date_end}'";
				unset($this->report_date_start);
			}
			break;

		}
		if ($account_filter && is_array($account_filter)) {
			array_walk($account_filter, 'add_quotes', "'");
			$sql_p[] = "journal.account_hash IN (".implode(", ", $account_filter).")";
			$sql_p2[] = "journal.account_hash IN (".implode(", ", $account_filter).")";
			array_walk($account_filter, 'strip_quotes');
		}
        if (is_array($customer_filter) && count($customer_filter)) {
            $customer_filter = array_unique($customer_filter);
            $customer_filter = array_values($customer_filter);
            array_walk($customer_filter, 'add_quotes', "'");
            $sql_p[] = "journal.customer_hash IN (".implode(" , ", $customer_filter).")";
            array_walk($customer_filter, 'strip_quotes');
        }

        if (is_array($proposal_filter) && count($proposal_filter)) {
            $proposal_filter = array_unique($proposal_filter);
            $proposal_filter = array_values($proposal_filter);
            array_walk($proposal_filter, 'add_quotes', "'");
            $sql_p[] = "journal.proposal_hash IN (".implode(" , ", $proposal_filter).")";
            array_walk($proposal_filter, 'strip_quotes');
        }


		if ($sql_p)
			$sql = implode(" AND ", $sql_p);
		if ($sql_p2)
			$sql2 = implode(" AND ", $sql_p2);

		$str = "timeframe=$timeframe|detail=$detail|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|account_filter=".@implode("&", $account_filter)."|hide_empty=$hide_empty|customer_filter=".@implode("&", $customer_filter)."|vendor_filter=".@implode("&", $vendor_filter)."|proposal_filter=".@implode("&", $proposal_filter);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `sql`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".addslashes($sql)."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' , `sql` = '".addslashes($sql)."'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		$acct = new accounting($this->current_hash);
		$result = $this->db->query("SELECT accounts.account_name , accounts.account_no , journal.account_hash ,
									journal.audit_id , journal.date , journal.memo ,
									ROUND( SUM( journal.debit ), 2) AS debit_total , ROUND( SUM( journal.credit ), 2) AS credit_total,
									ROUND( SUM(
										CASE
										WHEN account_types.account_type = 'DR' THEN
	                                        ( journal.debit - journal.credit ) ELSE
	                                        ( journal.credit - journal.debit )
	                                    END
	                                ), 2) AS balance
									FROM `journal`
									LEFT JOIN `accounts` ON accounts.account_hash = journal.account_hash
									LEFT JOIN account_types ON account_types.type_code = accounts.account_type" . ( $sql ? "
									WHERE " . $sql : NULL ) . "
									GROUP BY journal.account_hash
									ORDER BY accounts.account_no ASC");

		if ($sql2) {
				$result2 = $this->db->query("SELECT accounts.account_name , accounts.account_no , journal.account_hash ,
											journal.audit_id , journal.date , journal.memo ,
											ROUND( SUM( journal.debit ), 2) AS debit_total , ROUND( SUM( journal.credit ), 2) AS credit_total,
		                                    ROUND( SUM(
		                                        CASE
		                                        WHEN account_types.account_type = 'DR' THEN
		                                            ( journal.debit - journal.credit ) ELSE
		                                            ( journal.credit - journal.debit )
		                                        END
		                                    ), 2) AS balance
											FROM `journal`
											LEFT JOIN `accounts` ON accounts.account_hash = journal.account_hash
											LEFT JOIN account_types ON account_types.type_code = accounts.account_type" . ( $sql ? "
											WHERE " . $sql2 : NULL ) . "
											GROUP BY journal.account_hash
											ORDER BY accounts.account_no ASC");
				$open_bal = array();
				while ($row2 = $this->db->fetch_assoc($result2)) {
					$open_bal[ $row2['account_hash'] ] = $row2['balance'];
				}

		}
		$i = 0;
		$detail_sort = array();
		while ($row = $this->db->fetch_assoc($result)) {
			$acct->fetch_account_record($row['account_hash']);
    		$total = $row['balance'];

			if (!$hide_empty)
    			$detail_sort[] = $row['account_no'];

			$detail_array[$row['account_no']] = array("account_no"		    =>		$row['account_no'],
												      "account_name"		=>		$row['account_name'],
												      "account_hash"		=>		$row['account_hash'],
												      "audit_id"			=>		$row['audit_id'],
												      "date"				=>		$row['date'],
												      "memo"				=>		$row['memo'],
												      "total"				=>		$row['balance'],
													  "open_bal"			=>		( $open_bal[ $row['account_hash'] ] ? $open_bal[ $row['account_hash'] ] : NULL ),
												      "account_action"	    =>		$acct->current_account['account_action']);
			if ($detail == 2) {
				if ($doit_print)
					$par = $this->trail_bal_details(1, $row['account_hash'], $timeframe);
				else
					list($par) = $this->trail_bal_details(1, $row['account_hash'], $timeframe);

				$this->sub_detail[$row['account_hash']] = $par;
			}
			$i++;
		}

		if (!$hide_empty) {
			$r = $this->db->query("SELECT accounts.account_no , accounts.account_name , accounts.account_hash ,
			                       account_types.account_type AS account_action
			                       FROM `accounts`
			                       LEFT JOIN `account_types` ON account_types.type_code = accounts.account_type
			                       ORDER BY accounts.account_no ASC");
			while ($row = $this->db->fetch_assoc($r)) {
                if (((is_array($account_filter) && in_array($row['account_hash'], $account_filter)) || !is_array($account_filter)) && !in_array($row['account_no'], $detail_sort)) {
                    $detail_sort[] = $row['account_no'];
                    $detail_array[$row['account_no']] = array("account_no"      =>      $row['account_no'],
                                                              "account_name"    =>      $row['account_name'],
                                                              "account_hash"    =>      $row['account_hash'],
                                                              "account_action"  =>      $row['account_action']);
                }
			}

			$detail_sort = array_unique($detail_sort);
			sort($detail_sort);
			for ($i = 0; $i < count($detail_sort); $i++)
                $this->detail[] = $detail_array[$detail_sort[$i]];

		} else {
			while (list($acct_no, $acct_ar) = each($detail_array))
                $this->detail[] = $acct_ar;

		}
        unset($detail_array);

		if ($from_print_options) {
			$this->content['action'] = 'close';
			$this->content['jscript'][] = "agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=trial_balance', 'report_hash=".$report_hash."', 'popup_id=print_win')";
			return;
		}
		if ($from_xls_options) {
			$this->content['action'] = 'close';
			$this->content['jscript'][] = "agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it_xls', 'type=trial_balance', 'report_hash=".$report_hash."', 'popup_id=xls_win')";
			return;
		}

		// Added for Trac #1028
		if ($doit_print || $doit_excel)
			return;

		$this->content['action'] = 'close';
		$this->content['html']['place_holder'] = $this->trial_balance(1);
		return;
	}

	function doit_backlog_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = ($_POST['report_hash'] ? $_POST['report_hash'] : $this->ajax_vars['report_hash']);
        $limit_start = $this->ajax_vars['limit_start'];
        $total_rows = $this->ajax_vars['total_rows'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $limit_start || $from_saved)) {
			$this->fetch_report_settings($report_hash);

			$proposal_filter = $this->current_report['proposal_filter'];
			if ($proposal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);

			$customer_filter = $this->current_report['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);

			// Add vendor filter for Trac #1295
			$vendor_filter = $this->current_report['vendor_filter'];
			if ($vendor_filter && !is_array($vendor_filter))
				$vendor_filter = array($vendor_filter);

			// Add product filter for Trac #1295
			$product_match = $this->current_report['product_match'];
			if ($product_match && !is_array($product_match))
				$product_match = array($product_match);

			$sales_rep_match = $this->current_report['sales_rep_match'];
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);

            $designer_match = $this->current_report['designer_match'];
            if ($designer_match && !is_array($designer_match))
                $designer_match = array($designer_match);

            $sales_coord_match = $this->current_report['sales_coord_match'];
            if ($sales_coord_match && !is_array($sales_coord_match))
                $sales_coord_match = array($sales_coord_match);

            $proj_mngr_match = $this->current_report['proj_mngr_match'];
            if ($proj_mngr_match && !is_array($proj_mngr_match))
                $proj_mngr_match = array($proj_mngr_match);

			$report_detail = $this->current_report['report_detail'];
			$detail = $this->current_report['detail'];
			$zero_sell = $this->current_report['zero_sell'];
			$work_orders_unack = $this->current_report['work_orders_unack'];
		} else {
			$sales_rep_match = $_POST['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);

            $designer_match = $_POST['designer_match'];
            if ($designer_match && !is_array($designer_match))
                $designer_match = array($designer_match);

            $sales_coord_match = $_POST['sales_coord_match'];
            if ($sales_coord_match && !is_array($sales_coord_match))
                $sales_coord_match = array($sales_coord_match);

            $proj_mngr_match = $_POST['proj_mngr_match'];
            if ($proj_mngr_match && !is_array($proj_mngr_match))
                $proj_mngr_match = array($proj_mngr_match);

			$customer_filter = $_POST['customer_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);

			// Add vendor filter for Trac #1295
			$vendor_filter = $_POST['vendor_filter'];
            if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);

			// Add product filter for Trac #1295
			$product_match = $_POST['product_match'];
			if ($product_match && !is_array($product_match))
				$product_match = array($product_match);

			$proposal_filter = $_POST['proposal_filter'];
            if ($proposal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter);

			$report_detail = $_POST['report_detail'];
			$detail = $_POST['detail'];

			$save = $_POST['save'];
			$saved_cat = "backlog_report";
			$report_name = $_POST['report_name'];
			$report_descr = $_POST['report_descr'];
			$share = $_POST['share'];
			$sales_rep_share = $_POST['sales_rep_share'];
			$group_share = $_POST['group_share'];
			$zero_sell = $_POST['zero_sell'];
			$work_orders_unack = $_POST['work_orders_unack'];
		}
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($this->content['error'])
			return;

        if (@in_array("", $sales_rep_match) && count($sales_rep_match) > 1)
            unset($sales_rep_match[array_search("", $sales_rep_match)]);
        elseif (@in_array("", $sales_rep_match) && count($sales_rep_match) == 1)
            unset($sales_rep_match);

		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match, 'add_quotes', "'");
			$sql_p[] = "proposals.sales_hash IN (".implode(" , ", $sales_rep_match).")";
			array_walk($sales_rep_match, 'strip_quotes');
		}

        if (@in_array("", $sales_coord_match) && count($sales_coord_match) > 1)
            unset($sales_coord_match[array_search("", $sales_coord_match)]);
        elseif (@in_array("", $sales_coord_match) && count($sales_coord_match) == 1)
            unset($sales_coord_match);

	    if (is_array($sales_coord_match) && count($sales_coord_match)) {
            array_walk($sales_coord_match, 'add_quotes', "'");
            $sql_p[] = "proposals.sales_coord_hash IN (".implode(" , ", $sales_coord_match).")";
            array_walk($sales_coord_match, 'strip_quotes');
        }

        if (@in_array("", $designer_match) && count($designer_match) > 1)
            unset($designer_match[array_search("", $designer_match)]);
        elseif (@in_array("", $designer_match) && count($designer_match) == 1)
            unset($designer_match);

        if (is_array($designer_match) && count($designer_match)) {
            array_walk($designer_match, 'add_quotes', "'");
            $sql_p[] = "proposals.designer_hash IN (".implode(" , ", $designer_match).")";
            array_walk($designer_match, 'strip_quotes');
        }

        if (@in_array("", $proj_mngr_match) && count($proj_mngr_match) > 1)
            unset($proj_mngr_match[array_search("", $proj_mngr_match)]);
        elseif (@in_array("", $proj_mngr_match) && count($proj_mngr_match) == 1)
            unset($proj_mngr_match);

        if (is_array($proj_mngr_match) && count($proj_mngr_match)) {
            array_walk($proj_mngr_match, 'add_quotes', "'");
            $sql_p[] = "proposals.proj_mngr_hash IN (".implode(" , ", $proj_mngr_match).")";
            array_walk($proj_mngr_match, 'strip_quotes');
        }

		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter, 'add_quotes', "'");
			$sql_p[] = "proposals.customer_hash IN (".implode(" , ", $customer_filter).")";
			array_walk($customer_filter, 'strip_quotes');
		}

		// Add vendor filter for Trac #1295
		if (is_array($vendor_filter) && count($vendor_filter)) {
            $vendor_filter = array_unique($vendor_filter);
            $vendor_filter = array_values($vendor_filter);
            array_walk($vendor_filter, 'add_quotes', "'");
            $sql_p[] = "line_items.vendor_hash IN (".implode(" , ", $vendor_filter).")";
            array_walk($vendor_filter, 'strip_quotes');
        }

        // Add product filter for Trac #1295
		if (is_array($product_match) && count($product_match)) {
			$product_match = array_unique($product_match);
			$product_match = array_values($product_match);
			array_walk($product_match, 'add_quotes', "'");
			$sql_p[] = "line_items.product_hash IN (".implode(" , ", $product_match).")";
			array_walk($product_match, 'strip_quotes');
		}
		if (is_array($proposal_filter) && count($proposal_filter)) {
			$proposal_filter = array_unique($proposal_filter);
			$proposal_filter = array_values($proposal_filter);
			array_walk($proposal_filter, 'add_quotes', "'");
			$sql_p[] = "proposals.proposal_hash IN (".implode(" , ", $proposal_filter).")";
			array_walk($proposal_filter, 'strip_quotes');
		}
		//Lines remaining to be invoiced
		if ($report_detail == 1) {
			$sql_p[] = "line_items.status > 0 AND line_items.invoice_hash = ''".(!$zero_sell ? " AND line_items.sell != 0" : NULL);
		    $having_p[] = "proposal_fully_invoiced > 0 AND proposal_booked > 0";
		    $this->report_title = "Line items remaining to be invoiced";
		//Partially booked proposals, lines remaining to be booked
		} elseif ($report_detail == 2) {
			$sql_p[] = "line_items.status = 0";
		    $having_p[] = "proposal_fully_invoiced > 0 AND proposal_booked > 0";
		    $this->report_title = "Proposals partially booked showing line items remaining to be booked";
		//Booked by not yet received
		} elseif ($report_detail == 3) {
			$sql_p[] = "line_items.status > 0 AND (ISNULL(line_items.receive_date) OR line_items.receive_date = '' OR line_items.receive_date = '0000-00-00')";
		    $having_p[] = "proposal_booked > 0";
		    $this->report_title = "Line items booked but not yet received";
		//Booked but not yet shipped
		} elseif ($report_detail == 4) {
			$sql_p[] = "line_items.status > 0 AND (ISNULL(line_items.ship_date) OR line_items.ship_date = '' OR line_items.ship_date = '0000-00-00')";
		    $having_p[] = "proposal_booked > 0";
		    $this->report_title = "Line items booked but not yet shipped";
		//Booked but not yet delivered
		} elseif ($report_detail == 5) {
			$sql_p[] = "line_items.status > 0 AND (ISNULL(line_items.deliver_date) OR line_items.deliver_date = '' OR line_items.deliver_date = '0000-00-00')";
			$this->report_title = "Line items booked but not yet delivered";
        //Booked and received, but not yet invoiced
		} elseif ($report_detail == 6) {
			$sql_p[] = "line_items.status > 0 AND line_items.invoice_hash = ''".(!$zero_sell ? " AND line_items.sell != 0" : NULL)." AND !ISNULL(line_items.receive_date) AND line_items.receive_date != '' AND line_items.receive_date != '0000-00-00'";
		    $having_p[] = "proposal_booked > 0";
		    $this->report_title = "Line items booked and received but not yet invoiced";
		//Booked, shipped, not yet invoiced
		} elseif ($report_detail == 7) {
			$sql_p[] = "line_items.status > 0 AND line_items.invoice_hash = ''".(!$zero_sell ? " AND line_items.sell != 0" : NULL)." AND !ISNULL(line_items.ship_date) AND line_items.ship_date != '' AND line_items.ship_date != '0000-00-00'";
		    $having_p[] = "proposal_booked > 0";
		    $this->report_title = "Line items booked and shipped but not yet invoiced";
		//Booked, shipped, received, not yet invoiced
		} elseif ($report_detail == 8) {
			$sql_p[] = "line_items.status > 0 AND line_items.invoice_hash = ''".(!$zero_sell ? " AND line_items.sell != 0" : NULL)." AND !ISNULL(line_items.ship_date) AND line_items.ship_date != '' AND line_items.ship_date != '0000-00-00' AND !ISNULL(line_items.receive_date) AND line_items.receive_date != '' AND line_items.receive_date != '0000-00-00'";
		    $having_p[] = "proposal_booked > 0";
		    $this->report_title = "Line items booked, shipped and received but not yet invoiced";
		//Proposals not yet booked
		} elseif ($report_detail == 9) {
			$sql_p[] = "line_items.status = 0";
			$this->report_title = "Proposals not yet booked";
	    //Booked, invoiced and paid in full
		} elseif ($report_detail == 10) {
		    $having_p[] = "total_customer_receipts >= total_invoiced_dollars";
		    $this->report_title = "Booked, invoiced and paid in full";
		} elseif ($report_detail == 11) {
            $having_p[] = "proposal_booked > 0 AND proposal_commissioned < proposal_booked";
            $this->report_title = "Booked, invoiced but not yet commissioned";
        // Line items booked but not yet acknowledged. Ignore or include work orders based on work orders check box for Trac #1302
        } elseif ($report_detail == 12) {
            $having_p[] = "proposal_booked > 0";
            $sql_p[] = "(ISNULL(line_items.ack_no) OR line_items.ack_no = '')".(!$work_orders_unack ? " AND (ISNULL(line_items.work_order_hash) OR line_items.work_order_hash = '')" : NULL);
            $this->report_title = "Line items booked, but not yet acknowledged";
        //Booked.  Added for Trac #1295
		} elseif ($report_detail == 13) {
			$sql_p[] = "line_items.status > 0";
			$this->report_title = "Line items booked";
		}

		if ($sql_p)
			$sql = implode(" AND ", $sql_p);
        if ($having_p)
            $having = implode(" AND ", $having_p);

		$str = "sales_rep_match=".@implode("&", $sales_rep_match)."|zero_sell=$zero_sell|work_orders_unack=$work_orders_unack|customer_filter=".@implode("&", $customer_filter)."|vendor_filter=".@implode("&", $vendor_filter)."|report_detail=$report_detail|product_match=".@implode("&", $product_match)."|proposal_filter=".@implode("&", $proposal_filter)."|custom_contract=$custom_contract|detail=$detail";

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$max_memory = server_info('memory_limit');
		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT ".(!$limit_start ? "SQL_CALC_FOUND_ROWS" : NULL)." proposals.obj_id AS pobj_id ,
		                            proposals.proposal_hash , proposals.proposal_no  ,
									proposals.creation_date , proposals.sales_hash ,
									proposals.proposal_descr , proposals.customer_hash ,
									(
										SELECT SUM(line_items.sell * line_items.qty)
										FROM `line_items` WHERE proposal_hash = proposals.proposal_hash
									) AS total_sell ,
									(
                                        SELECT customers.customer_name
                                        FROM customers
                                        WHERE customers.customer_hash = proposals.customer_hash
                                    ) AS customer_name ,
									(
										SELECT purchase_order.po_date
										FROM `purchase_order`
										WHERE `proposal_hash` = proposals.proposal_hash AND purchase_order.deleted = 0
										ORDER BY purchase_order.po_date ASC
										LIMIT 1
									) AS po_date ,
									(
										SELECT SUM(customer_invoice.amount - customer_invoice.tax)
										FROM `customer_invoice`
										WHERE customer_invoice.proposal_hash = proposals.proposal_hash AND customer_invoice.type = 'I' AND customer_invoice.deleted = 0
									) AS total_invoiced,
									(
										SELECT SUM(customer_payment.receipt_amount)
										FROM `customer_invoice`
										LEFT JOIN `customer_payment` ON customer_payment.invoice_hash = customer_invoice.invoice_hash AND customer_payment.deleted = 0
										WHERE customer_invoice.proposal_hash = proposals.proposal_hash AND customer_invoice.type = 'I' AND customer_invoice.deleted = 0
									) AS total_received ,
									(
										SELECT SUM(customer_payment.receipt_amount)
										FROM `customer_invoice`
										LEFT JOIN `customer_payment` ON customer_payment.invoice_hash = customer_invoice.invoice_hash AND customer_payment.deleted = 0
										WHERE customer_invoice.proposal_hash = proposals.proposal_hash AND customer_invoice.type = 'D' AND customer_invoice.deleted = 0
									) AS total_deposits ,
									(
									    SELECT COUNT(line_items.obj_id)
									    FROM line_items
									    WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.status > 0
									) AS proposal_booked ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.commission_hash != ''
                                    ) AS proposal_commissioned ,
									(
									    SELECT COUNT(line_items.obj_id)
									    FROM line_items
									    WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.status = 1 AND line_items.invoice_hash = ''
									) AS proposal_fully_invoiced ,
									(
									    SELECT SUM(line_items.sell * line_items.qty)
									    FROM line_items
									    WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.status = 1 AND line_items.invoice_hash != ''
									) AS total_invoiced_dollars ,
                                    (
                                        SELECT SUM(customer_payment.receipt_amount)
                                        FROM customer_payment
                                        LEFT JOIN customer_invoice ON customer_invoice.invoice_hash = customer_payment.invoice_hash AND customer_invoice.deleted = 0
                                        WHERE customer_invoice.proposal_hash = proposals.proposal_hash AND customer_invoice.type = 'I' AND customer_payment.deleted = 0
                                    ) AS total_customer_receipts , users.full_name AS sales_rep
									FROM `proposals`
									LEFT JOIN `line_items` ON line_items.proposal_hash = proposals.proposal_hash
                                    LEFT JOIN `users` ON users.id_hash = proposals.sales_hash".($sql ? "
									WHERE ".$sql : NULL)."
									GROUP BY proposals.proposal_hash".($having ? "
									HAVING ".$having : NULL)."
									ORDER BY users.full_name , proposals.creation_date ASC".($limit_start ? "
									LIMIT $limit_start , $total_rows" : NULL));
		while ($row = $this->db->fetch_assoc($result)) {
			// Calculate amount remaining to invoice for Trac #1510
			$row['to_invoice'] = bcsub($row['total_sell'], $row['total_invoiced'], 2);
			if ($row['sales_hash'])
    			$this->backlog[$row['sales_hash']][$row['proposal_hash']][] = $row;

            if (!$limit_start && $detail == 1 && $k < 10 && !$doit_print)
                $this->sub_detail[$row['proposal_hash']] = $this->show_po_details($row['proposal_hash'], 'backlog');
    		if ($k > 0 && $k % 10 == 0 && !$doit_print) {
                if ($k > 200 || bcdiv(memory_get_usage(), $max_memory, 4) >= .8) {
                    $this->limit_start = $k + 1 + ($limit_start ? $limit_start : 0);

				    if ($detail != 1 || !$this->total_rows || !is_numeric($this->total_rows)) {
						$r = $this->db->query("SELECT FOUND_ROWS() AS t");
						$this->total_rows = $this->db->result($r, 0, 't');
				    }
                    $this->db->free_result($result);
                    break;
                }
    		}
    		$k++;
		}
		if (!$limit_start)
			$this->content['action'] = 'close';
		else
			$this->content['action'] = 'continue';

        unset($str);

        if ($limit_start) {
            if ($this->ajax_vars['sales_map'])
                $this->sales_map = explode("|", $this->ajax_vars['sales_map']);

            $str = $this->backlog_report(1, $limit_start);

            $temp = tempnam(SITE_ROOT.'core/tmp', 'pre_');
            $fh = fopen($temp, 'w');
            fwrite($fh, trim($str));
            fclose($fh);

            unset($str);
            $file_str = file($temp);
            for ($i = 0; $i < count($file_str); $i++)
                $str .= trim(str_replace("'", "\'", $file_str[$i]));

            unlink($temp);
            $this->content['jscript'][] = "\$('table_content_control').insert({before:'".$str."'});";
        } elseif (!$doit_print)
            $this->content['html']['place_holder'] = $this->backlog_report(1);

        if ($this->limit_start) {
            if ($this->sales_map)
                $sales_keys = array_values($this->sales_map);

            $this->content['jscript'][] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'doit_backlog_report', 'report_hash=".$this->report_hash."', 'limit_start=".$this->limit_start."', 'total_rows=".$this->total_rows."'".($sales_keys ? ", 'sales_map=".@implode("|", $sales_keys)."'" : NULL).");";
        } elseif (!$doit_print)
            $this->content['jscript'][] = "remote_fetch();";

		return;
	}

	function backlog_totals() {
		$report_hash = $this->ajax_vars['report_hash'];
        if ($_SESSION['backlog_total'][$report_hash]) {
        	$total_cost = $total_sell = $i = $k = 0;
        	$jump_to[] = "<tr>";
        	$sales_array = array();
            while (list($sales_hash, $total_array) = each($_SESSION['backlog_total'][$report_hash])) {

				$sales_array[$k] = array(
					'sales_hash'  =>  $sales_hash,
            	                         'cost'        =>  $total_array['cost'],
            	    'sell'        =>  $total_array['sell']
				);

                $total_cost += $total_array['cost'];
                $total_sell += $total_array['sell'];

				$jump_to[] = "<td style=\"padding-bottom:5px;font-size:8pt;\"><a href=\"#{$sales_hash}\" class=\"link_standard\">" . stripslashes($this->user_name($sales_hash) ) ."</td>";
                if ($i > 0 && $i % 2 == 0) {
                    $jump_to[] = "</tr>";
                    $jump_to[] = "<tr>";
                    $i = 0;
                } else
                    $i++;

                $k++;
            }
            unset($margin_flag);

            if ($jump_to && count($sales_array) > 1) {
            	if ($jump_to[count($jump_to)-1] == "<tr>")
                    array_pop($jump_to);

                $this->content['html']['jump_to_table'] = "<table style=\"width:95%;text-align:right;\"><tr><td style=\"padding-bottom:5px;padding-left:15px;font-size:8pt;text-align:left;\" colspan=\"3\">Jump to Sales Rep:</td></tr>".implode("\n", $jump_to)."</table>";
            } else
                $this->content['html']['jump_to_table'] = "";

			$this->content['jscript'][] = "\$('print_holder').setStyle({'visibility' : 'visible'});";
			# Sales Totals
            if (count($sales_array) > 0) {
            	for ($i = 0; $i < count($sales_array); $i++) {

					$_margin = math::gp_margin( array(
						'cost'	=>	$sales_array[$i]['cost'],
						'sell'	=>	$sales_array[$i]['sell']
					) );

					$str = "<tr style=\"background-color:#ffffff;\"><td style=\"text-align:right;background-color:#efefef;font-size:10pt;font-weight:bold;vertical-align:middle;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc\"><table style=\"text-align:right;\"><tr><td style=\"text-align:right;padding-right:15px;padding-left:10px;vertical-align:bottom;\" nowrap>Total for ".stripslashes($this->user_name($sales_array[$i]['sales_hash'])).":</td><td style=\"width:75px;font-size:8pt;\"><div style=\"border-top:1px dashed #000000;width:100%;padding-top:5px;\">".($sales_array[$i]['cost'] < 0 ? "($".number_format($sales_array[$i]['cost'] * -1, 2).")" : "$".number_format($sales_array[$i]['cost'], 2))."</div></td><td style=\"width:75px;font-size:8pt;\"><div style=\"border-top:1px dashed #000000;width:100%;padding-top:5px;\">".($sales_array[$i]['sell'] < 0 ? "($".number_format($sales_array[$i]['sell'] * -1, 2).")" : "$".number_format($sales_array[$i]['sell'], 2))."</div></td><td style=\"width:75px;font-size:8pt;\"><div style=\"border-top:1px dashed #000000;width:100%;padding-top:5px;\">".($sales_array[$i]['sell'] - $sales_array[$i]['cost'] < 0 ? "($".number_format(($sales_array[$i]['sell'] - $sales_array[$i]['cost']) * -1, 2).")" : "$".number_format($sales_array[$i]['sell'] - $sales_array[$i]['cost'], 2))."</div></td><td style=\"padding-right:30px;width:50px;font-size:8pt;\"><div style=\"border-top:1px dashed #000000;width:100%;padding-top:5px;\">" . ( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ? "(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . ")" : (float)bcmul($_margin, 100, 4) ) . "%</div></td></tr></table></td></tr><tr><td style=\"background-color:#ffffff;\">&nbsp;</td></tr>";

            		if ($i == count($sales_array) - 1)
                        $placeholder = 'table_content_control';
            		else
                        $placeholder = 'sales_content_'.$sales_array[$i+1]['sales_hash'];

                    $this->content['jscript'][] = "\$('".$placeholder."').insert({before:'".$str."'});";
            	}
            }

			$_margin = math::gp_margin( array(
				'cost'	=>	$total_cost,
				'sell'	=>	$total_sell
			) );

            $this->content['html']['report_cost_top'] = $this->content['html']['report_cost'] = ($total_cost < 0 ? "($".number_format($total_cost * -1, 2).")" : "$".number_format($total_cost, 2));
            $this->content['html']['report_sell_top'] = $this->content['html']['report_sell'] = ($total_sell < 0 ? "($".number_format($total_sell * -1, 2).")" : "$".number_format($total_sell, 2));
			$this->content['html']['report_profit_top'] = $this->content['html']['report_profit'] =
			( bccomp( bcsub($total_sell, $total_cost, 2), 0, 2) == -1 ?
				"(\$" . number_format( bcmul( bcsub($total_sell, $total_cost, 2), -1, 2), 2) . ")" : "\$" . number_format( bcsub($total_sell, $total_cost, 2), 2)
			);
			if ( defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 )
                $margin_flag = true;

			$this->content['html']['report_margin_top'] = $this->content['html']['report_margin'] =
			( $margin_flag ?
				"<span style=\"color:#ff0000;\">" : NULL
			) .
			( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ?
				"(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . ")" : (float)bcmul($_margin, 100, 4)
			) . "%" .
			( $margin_flag ?
				"</span>" : NULL
			);

            unset($_SESSION['backlog_total'][$report_hash]);
        } else
            $this->content['html']['jump_to_table'] = "";
	}

	function user_name($user_hash) {
		$result = $this->db->query("SELECT `full_name`
									FROM `users`
									WHERE `id_hash` = '$user_hash'");

		return $this->db->result($result);
	}

	function fetch_backlog_items($proposal_hash, $obj_id=NULL, $totals=NULL) {
		$backlog_items = array();
		$num_items = 0;
        $zero_sell = $this->current_report['zero_sell'];

		//Remaining to be invoiced
        if ($this->current_report['report_detail'] == 1)
            $sql = "line_items.status > 0 AND line_items.invoice_hash = ''".(!$zero_sell ? " AND line_items.sell != 0" : NULL);
        //Partially booked proposals, lines remaining to be booked
        elseif ($this->current_report['report_detail'] == 2)
            $sql = "line_items.status = 0";
        //Booked by not yet received
        elseif ($this->current_report['report_detail'] == 3)
            $sql = "line_items.status > 0 AND (ISNULL(line_items.receive_date) OR line_items.receive_date = '' OR line_items.receive_date = '0000-00-00')";
        //Booked but not yet shipped
        elseif ($this->current_report['report_detail'] == 4)
            $sql = "line_items.status > 0 AND (ISNULL(line_items.ship_date) OR line_items.ship_date = '' OR line_items.ship_date = '0000-00-00')";
        //Booked but not yet delivered
        elseif ($this->current_report['report_detail'] == 5)
            $sql = "line_items.status > 0 AND (ISNULL(line_items.deliver_date) OR line_items.deliver_date = '' OR line_items.deliver_date = '0000-00-00')";
        //Booked and received, but not yet invoiced
        elseif ($this->current_report['report_detail'] == 6)
            $sql = "line_items.status > 0 AND line_items.invoice_hash = ''".(!$zero_sell ? " AND line_items.sell != 0" : NULL)." AND !ISNULL(line_items.receive_date) AND line_items.receive_date != '' AND line_items.receive_date != '0000-00-00'";
        //Booked, shipped, not yet invoiced
        elseif ($this->current_report['report_detail'] == 7)
            $sql = "line_items.status > 0 AND line_items.invoice_hash = ''".(!$zero_sell ? " AND line_items.sell != 0" : NULL)." AND !ISNULL(line_items.ship_date) AND line_items.ship_date != '' AND line_items.ship_date != '0000-00-00'";
        //Booked, shipped, received, not yet invoiced
        elseif ($this->current_report['report_detail'] == 8)
            $sql = "line_items.status > 0 AND line_items.invoice_hash = ''".(!$zero_sell ? " AND line_items.sell != 0" : NULL)." AND !ISNULL(line_items.ship_date) AND line_items.ship_date != '' AND line_items.ship_date != '0000-00-00' AND !ISNULL(line_items.receive_date) AND line_items.receive_date != '' AND line_items.receive_date != '0000-00-00'";
        //Proposals not yet booked
        elseif ($this->current_report['report_detail'] == 9)
            $sql = "line_items.status = 0";
		// Line items booked but not yet acknowledged. Ignore work orders for Trac #1302
		elseif ($this->current_report['report_detail'] == 12)
            $sql_p = "line_items.status = 0 AND (ISNULL(line_items.ack_no) OR line_items.ack_no = '')".(!$work_orders_unack ? " AND (ISNULL(line_items.work_order_hash) OR line_items.work_order_hash = '')" : NULL);
        // Line items booked
        elseif ($this->current_report['report_detail'] == 13)
            $sql = "line_items.status > 0";

		// Add vendor filter for Trac #1295
		if ($vendor_filter = $this->current_report['vendor_filter']) {
            if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);
            $vendor_filter = array_unique($vendor_filter);
            $vendor_filter = array_values($vendor_filter);
            array_walk($vendor_filter, 'add_quotes', "'");
            if ($sql)
            	$sql .= " AND line_items.vendor_hash IN (".implode(" , ", $vendor_filter).")";
            else
            	$sql = "line_items.vendor_hash IN (".implode(" , ", $vendor_filter).")";
		}

        if ($totals) {
            $result = $this->db->query("SELECT line_items.proposal_hash ,
                                        SUM(line_items.qty * line_items.cost) AS ext_cost ,
										SUM(line_items.qty * line_items.sell) AS ext_sell ,
										(
										    SELECT proposals.sales_hash
										    FROM proposals
										    WHERE proposals.proposal_hash = line_items.proposal_hash
										) AS sales_hash
										FROM line_items
										WHERE line_items.proposal_hash = ".($obj_id ? "
										                                              ( SELECT proposals.proposal_hash
										                                                FROM proposals
										                                                WHERE proposals.obj_id = $proposal_hash
										                                              )" : "'$proposal_hash'").($sql ? "
										AND ".$sql : NULL)."
										GROUP BY line_items.proposal_hash");
            $backlog_items = $this->db->fetch_assoc($result);
        } else {
			$result = $this->db->query("SELECT ".($obj_id ? "line_items.proposal_hash , " : NULL)."line_items.item_hash , line_items.item_no , line_items.qty ,
			                            line_items.item_descr , (line_items.qty * line_items.cost) AS ext_cost ,
			                            (line_items.qty * line_items.sell) AS ext_sell , line_items.po_hash ,
			                            line_items.ship_date , line_items.receive_date , line_items.ack_no ,
			                            (
	                                        SELECT proposals.sales_hash
	                                        FROM proposals
	                                        WHERE proposals.proposal_hash = line_items.proposal_hash
			                            ) AS sales_hash
										FROM `line_items`
										WHERE line_items.proposal_hash = ".($obj_id ?
	    									"(
	        									SELECT proposals.proposal_hash
	        									FROM proposals
	        									WHERE proposals.obj_id = $proposal_hash
	    									)" : "'$proposal_hash'").($sql ?
	        									" AND ".$sql : NULL));
			while ($row = $this->db->fetch_assoc($result))
				$backlog_items[($row['po_hash'] ? $row['po_hash'] : "UNORDERED")][] = $row;

			// Add applied credits for Trac #1447
			$result = $this->db->query("SELECT vp.amount as credit_amount , vp.invoice_hash as credit_hash , vp.invoice_no as credit_no , vp.po_hash
										FROM vendor_payables vp
										LEFT JOIN purchase_order po ON vp.po_hash = po.po_hash
										WHERE po.proposal_hash = ". ($obj_id ?"
											(
	        									SELECT proposals.proposal_hash
	        									FROM proposals
	        									WHERE proposals.obj_id = $proposal_hash
	    									)" : "'$proposal_hash'")." AND vp.deleted = 0 and vp.type = 'C'");
			while ($row = $this->db->fetch_assoc($result))
				$backlog_items[($row['po_hash'] ? $row['po_hash'] : "UNORDERED")][] = $row;

        }

		return $backlog_items;
	}

	function backlog_report($step=NULL, $active_limit_start=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);

			$_margin = math::gp_margin( array(
				'cost'	=>	$report_totals['cost'],
				'sell'	=>	$report_totals['sell']
			) );

			$tbl =
			( ! $active_limit_start ?
				"<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;vertical-align:top;\">
					    <a name=\"top\"></a>
                        <div style=\"float:right;margin-right:10px;width:50%;\" id=\"jump_to_table\"><div style=\"float:right;padding-right:15px;\">Loading Report...</div></div>
							<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">" .
			( $this->current_report['saved'] ?
			stripslashes($this->current_report['report_name']) : "Backlog Report"
			) .
			( $this->p->ck('reports', 'V', 'backlog') ?
									"<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
			[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'backlog_report', 'popup_id=report_filter', 'report_hash={$this->report_hash}');\" class=\"link_standard\">Update Report Settings</a></small>]
			</span>" : NULL
			) . "
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
			<a href=\"javascript:void(0);\" style=\"visibility:hidden;\" id=\"print_holder\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=backlog_report', 'report_hash={$this->report_hash}');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr style=\"background-color:#ffffff;\">
                    <td style=\"text-align:right;background-color:#efefef;font-size:10pt;font-weight:bold;vertical-align:middle;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc\">
                        <table style=\"text-align:right;\">
                            <tr>
                                <td style=\"text-align:right;padding-right:15px;padding-left:10px;vertical-align:bottom;\" nowrap>Report Total:</td>
                                <td style=\"width:75px;font-size:8pt;\">
                                    <div style=\"width:100%;padding-top:5px;\" id=\"report_cost_top\">".($this->current_report['detail'] != 1 ?
                                        ($report_totals['cost'] < 0 ?
                                            "($".number_format($report_totals['cost'] * -1, 2).")" : "$".number_format($report_totals['cost'], 2)) : "<img src=\"images/content_loader.gif\" />")."
                                    </div>
                                </td>
                                <td style=\"width:75px;font-size:8pt;\">
                                    <div style=\"width:100%;padding-top:5px;\" id=\"report_sell_top\">".($this->current_report['detail'] != 1 ?
                                        ($report_totals['sell'] < 0 ?
                                            "($".number_format($report_totals['sell'] * -1, 2).")" : "$".number_format($report_totals['sell'], 2)) : "<img src=\"images/content_loader.gif\" />")."
                                    </div>
                                </td>
                                <td style=\"width:75px;font-size:8pt;\">
                                    <div style=\"width:100%;padding-top:5px;\" id=\"report_profit_top\">".($this->current_report['detail'] != 1 ?
                                        ($report_totals['sell'] - $report_totals['cost'] < 0 ?
                                            "($".number_format(($report_totals['sell'] - $report_totals['cost']) * -1, 2).")" : "$".number_format($report_totals['sell'] - $report_totals['cost'], 2)) : "<img src=\"images/content_loader.gif\" />")."
                                    </div>
                                </td>
                                <td style=\"padding-right:30px;width:50px;font-size:8pt;\">
	                                    <div style=\"width:100%;padding-top:5px;\" id=\"report_margin_top\">" .
			( $this->current_report['detail'] != 1 ?
			( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ?
	                                            "(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . ")" : (float)bcmul($_margin, 100, 4)
			) . "%" : "<img src=\"images/content_loader.gif\" />"
			) . "
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
				</tr>
				<tr>
					<td style=\"background-color:#ffffff;\">&nbsp;</td>
					</tr>" : NULL
			);

            if (!$_SESSION['backlog_total'][$this->report_hash])
                $_SESSION['backlog_total'][$this->report_hash] = array();

			if (is_array($this->backlog)) {
				while (list($sales_hash, $proposal_array) = each($this->backlog)) {
					reset($proposal_array);
                    $sales_totals = array();
					$sales_rep = current($proposal_array);

					if (!$_SESSION['backlog_total'][$this->report_hash][$sales_hash])
                        $_SESSION['backlog_total'][$this->report_hash][$sales_hash] = array('cost'  =>  0,
                                                                                            'sell'  =>  0);

                    $tbl .=
                    (!$active_limit_start || ($active_limit_start && (!is_array($this->sales_map) || !in_array($sales_hash, $this->sales_map))) ?
                        ($z > 0 || $active_limit_start ?
                            "<tr>
                                <td style=\"background-color:#ffffff;padding-top:10px;\">&nbsp;</td>
                            </tr>" : NULL)."
	                    <tr id=\"sales_content_".$sales_hash."\" style=\"background-color:#ffffff;\">
	                        <td style=\"background-color:#efefef;font-size:10pt;font-weight:bold;vertical-align:middle;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc\">
                                <div style=\"float:right;text-align:right;\">
                                    <table style=\"text-align:right;\" border=\"0\">
                                        <tr>
                                            <td style=\"width:75px;font-size:8pt;\"><div>Ext Cost</div></td>
                                            <td style=\"width:75px;font-size:8pt;\"><div>Ext Sell</div></td>
                                            <td style=\"width:75px;font-size:8pt;\"><div>Profit</div></td>
                                            <td style=\"width:50px;font-size:8pt;padding-right:30px;\"><div>GP</div></td>
                                        </tr>
                                    </table>
                                </div>
    	                        <a name=\"".$sales_hash."\" style=\"text-decoration:none;\">".stripslashes($sales_rep[0]['sales_rep'])."</a>".($z > 0 ? "
								<span style=\"padding-left:10px;\"><a href=\"#top\" class=\"link_standard\" style=\"font-size:8pt;\">top</a></span>" : NULL)."
    						</td>
	                    </tr>" : NULL)."
                    <tr>
                        <td style=\"background-color:#ffffff;\" colspan=\"2\">";

                    $z++;

                    unset($sales_rep);
                    if (!is_array($this->sales_map) || !in_array($sales_hash, $this->sales_map))
                        $this->sales_map[] = $sales_hash;

					while (list($proposal_hash, $proposal_list) = each($proposal_array)) {
						$sales_rep = $proposal_list[0]['sales_rep'];

						$tbl .= "
						<div style=\"margin:10px 5px;\">
							<table style=\"width:100%;border:1px solid #cccccc;margin-bottom:10px;\">
								<tr>
									<td style=\"vertical-align:top;font-weight:bold;\" colspan=\"3\">
									    <div style=\"margin-bottom:5px;\">
									        ".stripslashes($proposal_list[0]['customer_name'])."
									    </div>
										Proposal : <a href=\"javascript:void(0);\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$proposal_hash."', 'popup_id=proposal_win', 'from_report=1');\" class=\"link_standard\" title=\"Jump to this proposal\">".$proposal_list[0]['proposal_no']."</a> - ".(strlen($proposal_list[0]['proposal_descr']) > 72 ?
											substr($proposal_list[0]['proposal_descr'], 0, 69)."..." : $proposal_list[0]['proposal_descr'])."
									</td>
								</tr>
								<tr>
									<td style=\"vertical-align:top;width:33%;padding-top:10px;padding-left:20px;\">
										Created: ".date(DATE_FORMAT, $proposal_list[0]['creation_date'])."
									</td>
									<td style=\"vertical-align:top;width:33%;padding-top:10px;padding-left:20px;\">
										Amount Invoiced: $".number_format($proposal_list[0]['total_invoiced'], 2)."
									</td>
									<td style=\"vertical-align:top;width:33%;padding-top:10px;padding-left:20px;\">
										Amount Received: $".number_format($proposal_list[0]['total_received'], 2)."
									</td>
								</tr>
								<tr>
									<td style=\"vertical-align:top;width:33%;padding-left:20px;\">".($this->current_report['report_detail'] == 9 ?
										"&nbsp;" : "Booked: ".date(DATE_FORMAT, strtotime($proposal_list[0]['po_date'])))."
									</td>
									<td style=\"vertical-align:top;width:33%;padding-left:20px;\">
										Remaining To Invoice: $".number_format($proposal_list[0]['to_invoice'], 2)."
									</td>
									<td style=\"vertical-align:top;width:33%;padding-left:20px;\">
										Deposits Received: $".number_format($proposal_list[0]['total_deposits'], 2)."
									</td>
								</tr>
								<tr>
									<td colspan=\"3\">
                                        <div style=\"margin:10px;\">
                                            <div style=\"font-size:8pt;margin-bottom:5px;\" >
                                                <img src=\"images/expand.gif\" />
                                                &nbsp;
                                                <a href=\"javascript:void(0);\" onClick=\"if((\$('po_holder".$proposal_hash."').readAttribute('style') && \$('po_holder".$proposal_hash."').getStyle('display')=='block') || \$('po_holder".$proposal_hash."').readAttribute('style') == ''){toggle_display('po_holder".$proposal_hash."', 'none');\$('po_holder".$proposal_hash."').innerHTML='';} else{agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'show_po_details', 'proposal_hash=".$proposal_hash."', 'report_type=backlog', 'report_hash=".$this->report_hash."');}\" title=\"Show/Hide Proposal Details\" class=\"link_standard\">Show Purchase Order Details</a>
                                            </div>
                                            <div id=\"po_holder".$proposal_hash."\" >".($this->current_report['detail'] == 1 ?
                                                ($this->sub_detail[$proposal_hash] ?
                                                    $this->sub_detail[$proposal_hash] : "<img src=\"images/content_loader.gif\" content_holder=\"1\" content_id=\"".$proposal_list[0]['pobj_id']."\" style=\"margin-left:20px;margin-top:5px;\" />") : "<img src=\"images/placeholder.gif\" simple_holder=\"1\" content_id=\"".$proposal_list[0]['pobj_id']."\" />")."
                                            </div>
                                        </div>
            						</td>
								</tr>
							</table>
                        </div>";
					}

					$tbl .= "
    					</td>
					</tr>";
				}
			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\">There are no results to show.</td>
				</tr>";

			if ( ! $active_limit_start ) {

				$_margin = math::gp_margin( array(
					'cost'	=>	$report_totals['cost'],
					'sell'	=>	$report_totals['sell']
				) );

	                $tbl .= "
	                <tr id=\"table_content_control\">
	                    <td style=\"background-color:#ffffff;padding-top:10px;\">&nbsp;</td>
	                </tr>
	                <tr style=\"background-color:#ffffff;\">
	                    <td style=\"text-align:right;background-color:#efefef;font-size:10pt;font-weight:bold;vertical-align:middle;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc\">
	                        <table style=\"text-align:right;\">
	                            <tr>
	                                <td style=\"text-align:right;padding-right:15px;padding-left:10px;vertical-align:bottom;\" nowrap>Report Total:</td>
	                                <td style=\"width:75px;font-size:8pt;\">
	                                    <div style=\"border-top:1px dashed #000000;width:100%;padding-top:5px;\" id=\"report_cost\">".($this->current_report['detail'] != 1 ?
	                                        ($report_totals['cost'] < 0 ?
	                                            "($".number_format($report_totals['cost'] * -1, 2).")" : "$".number_format($report_totals['cost'], 2)) : "<img src=\"images/content_loader.gif\" />")."
	                                    </div>
	                                </td>
	                                <td style=\"width:75px;font-size:8pt;\">
	                                    <div style=\"border-top:1px dashed #000000;width:100%;padding-top:5px;\" id=\"report_sell\">".($this->current_report['detail'] != 1 ?
	                                        ($report_totals['sell'] < 0 ?
	                                            "($".number_format($report_totals['sell'] * -1, 2).")" : "$".number_format($report_totals['sell'], 2)) : "<img src=\"images/content_loader.gif\" />")."
	                                    </div>
	                                </td>
                                    <td style=\"width:75px;font-size:8pt;\">
                                        <div style=\"border-top:1px dashed #000000;width:100%;padding-top:5px;\" id=\"report_profit\">".($this->current_report['detail'] != 1 ?
                                            ($report_totals['sell'] - $report_totals['cost'] < 0 ?
                                                "($".number_format(($report_totals['sell'] - $report_totals['cost']) * -1, 2).")" : "$".number_format($report_totals['sell'] - $report_totals['cost'], 2)) : "<img src=\"images/content_loader.gif\" />")."
                                        </div>
                                    </td>
	                                <td style=\"padding-right:30px;width:50px;font-size:8pt;\">
	                                    <div style=\"border-top:1px dashed #000000;width:100%;padding-top:5px;\" id=\"report_margin\">" .
				( $this->current_report['detail'] != 1 ?
				( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ?
	                                            "(" . bcmul( bcmul($_margin, 100, 4), -1, 4) . ")" : (float)bcmul($_margin, 100, 4)
				) . "%" : "<img src=\"images/content_loader.gif\" />"
				) . "
	                                    </div>
	                                </td>
	                            </tr>
	                        </table>
	                    </td>
	                </tr>
                </table>";
			}

            if (!$active_limit_start) {
                $jscript = '
                remote_fetch = function() {
                    if (agent.in_progress == true) {
                        setTimeout("remote_fetch();", 1000);
                        return;
                    }
                    var pending = $$(\'img[content_holder=1]\');
                    var i=0, c, str=\'\', atr;
                    while (c = pending[i++]) {
                        var yes = true;
                        if (i > 30)
                            break;

                        if (atr = c.readAttribute(\'content_id\'))
                            str += atr + \'|\';

                    }
                    if (yes)
                        agent.call(\'reports\', \'sf_loadcontent\', \'cf_loadcontent\', \'show_po_details\', \'report_hash='.$this->report_hash.'\', \'report_type=backlog\', \'pstr=\' + str);
                    else {
                        var pending = $$(\'img[simple_holder=1]\');
                        if (pending && pending.length > 0) {
		                    var i=0, c, str=\'\', atr;
		                    while (c = pending[i++]) {
		                        var yes = true;

		                        if (atr = c.readAttribute(\'content_id\'))
		                            str += atr + \'|\';

		                    }
		                    if (yes)
                                agent.call(\'reports\', \'sf_loadcontent\', \'cf_loadcontent\', \'show_po_details\', \'report_hash='.$this->report_hash.'\', \'report_type=backlog\', \'simple_view=1\', \'pstr=\' + str);
                        }
                        populate_totals();
                    }
                }
                populate_totals = function() {
                    if (agent.in_progress == true) {
                        setTimeout("populate_totals()", 1000);
                        return;
                    }
                    agent.call(\'reports\', \'sf_loadcontent\', \'cf_loadcontent\', \'backlog_totals\', \'report_hash='.$this->report_hash.'\');
                }';
                $this->content['jscript'][] = $jscript;
            }

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			unset($_SESSION['backlog_total'][$report_hash]);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
				$this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);
			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
				$this->current_report['customer_filter'] = array($this->current_report['customer_filter']);
			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
			if ($this->current_report['product_match'] && !is_array($this->current_report['product_match']))
				$this->current_report['product_match'] = array($this->current_report['product_match']);

/*
			$result = $this->db->query("SELECT vendor_products.product_name , vendor_products.product_hash , vendors.vendor_hash , vendors.vendor_name
										FROM `vendor_products`
										LEFT JOIN `vendors` ON vendors.vendor_hash = vendor_products.vendor_hash
										ORDER BY vendors.vendor_name , vendor_products.product_name");
			while ($row = $this->db->fetch_assoc($result)) {
				$vendor[($row['vendor_hash'] ? $row['vendor_hash'] : "DEFAULT")] = ($row['vendor_name'] ? $row['vendor_name'] : MY_COMPANY_NAME);
				$products[($row['vendor_hash'] ? $row['vendor_hash'] : "DEFAULT")][] = array("name" =>	stripslashes($row['product_name']),
																						     "hash" =>	$row['product_hash']);
			}
			while (list($vendor_hash, $product_array) = each($products)) {
				$select .= "
				<optgroup label=\"".$vendor[$vendor_hash]."\">";
				for ($i = 0; $i < count($product_array); $i++)
					$select .= "
					<option value=\"".$product_array[$i]['hash']."\" ".(@in_array($product_array[$i]['hash'], $this->current_report['product_match']) ? "selected=\"selected\"" : NULL).">".$product_array[$i]['name']."</option>";
				$select .= "
				</optgroup>";
			}
			$product_select = "
			<select name=\"product_match[]\" class=\"txtSearch\" size=\"6\" style=\"width:400px;\" multiple>
				".$select."
			</select>";
*/

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			$tbl = $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_backlog_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_backlog_report', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Backlog Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=vendor",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
                                                if (is_array($this->current_report['vendor_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
                                                        $tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=proposal",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
												if (is_array($this->current_report['proposal_filter'])) {
													for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++)
														$tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">What do you want to show?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->select("report_detail",
                                                                      array("Line items remaining to be invoiced",
                                                                            "Partially booked with line items remaining to be booked",
                                                                            "Line items booked but not yet received",
                                                                            "Line items booked but not yet shipped",
                                                                            "Line items booked but not yet delivered",
                                                                            "Line items booked and not yet fully acknowledged",
                                                                            "Line items booked and shipped but not yet invoiced",
                                                                            "Line items booked and received but not yet invoiced",
                                                                            "Line items booked, shipped and received but not yet invoiced",
                                                                            "Lines items booked, invoiced and paid in full",
                                                                            "Lines items booked, invoiced, but not yet commissioned",
                                                                            "Proposals not yet booked",
                                                                      		"Line items booked"),
                                                                      $this->current_report['report_detail'],
                                                                      array(1, 2, 3, 4, 5, 12, 7, 6, 8, 10, 11, 9, 13),
                                                                      "blank=1")."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Include zero sell items?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->checkbox("name=zero_sell", "value=1", ($this->current_report['zero_sell'] ? "checked" : NULL))."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show work order lines as unacknowledged?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->checkbox("name=work_orders_unack", "value=1", ($this->current_report['work_orders_unack'] ? "checked" : NULL))."</td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]", ($this->p->ck('proposals', 'S') ? $this->sales_name : array_merge(array("All Sales Reps"), $this->user_name)), (is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')), ($this->p->ck('proposals', 'S') ? $this->sales_hash : array_merge(array(''), $this->user_hash)), "multiple", "blank=1", "size=4", "style=width:200px;", ($this->p->ck('proposals', 'S') ? "disabled" : NULL))."</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales coordinator?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("sales_coord_match[]", array_merge(array("All Sales Reps"), $this->user_name), $this->current_report['sales_coord_match'], array_merge(array(''), $this->user_hash), "multiple", "blank=1", "size=4", "style=width:200px;")."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by designer?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("designer_match[]", array_merge(array("All Sales Reps"), $this->user_name), $this->current_report['designer_match'], array_merge(array(''), $this->user_hash), "multiple", "blank=1", "size=4", "style=width:200px;")."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by project manager?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("proj_mngr_match[]", array_merge(array("All Sales Reps"), $this->user_name), $this->current_report['proj_mngr_match'], array_merge(array(''), $this->user_hash), "multiple", "blank=1", "size=4", "style=width:200px;")."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Details?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("detail", array("Show Detail View", "Show Simple View"), $this->current_report['detail'], array(1, 0), "blank=1")."</td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}


	function proposal_no($proposal_hash) {
		$result = $this->db->query("SELECT `proposal_no`
									FROM `proposals`
									WHERE `proposal_hash` = '$proposal_hash'");
		return $this->db->result($result);
	}

	function doit_sales_tax() {

		global $us_states, $ca_states;

        $this->db->query("DELETE FROM reports
                          WHERE reports.saved = 0 AND reports.timestamp <= UNIX_TIMESTAMP( DATE_SUB(NOW(), INTERVAL 1 HOUR) )");

        if ( $_POST['rm'] && $_POST['report_hash'] ) {

        	$fb = "Report has been deleted";
            if ( ! $this->db->query("DELETE t1.*, t2.*
		                             FROM reports t1
		                             LEFT JOIN reports_share t2 ON t2.report_hash = t1.report_hash
		                             WHERE t1.report_hash = '{$_POST['report_hash']}'")
            ) {

            	$this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__);
            	$fb = "Database error encountered during report delete. Unable to delete report.";
            }

            $this->content['action'] = 'close';
            $this->content['page_feedback'] = $fb;
            $this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";

            return;
        }

		$doit_print = $_POST['doit_print'];
		$report_hash = $_POST['report_hash'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ( $report_hash && ( $doit_print || $from_saved ) ) {

			$this->fetch_report_settings($report_hash);

			$timeframe = $this->current_report['timeframe'];
			$tax_state = $this->current_report['tax_state'];
			$sort_from_date = $this->current_report['sort_from_date'];
			$sort_to_date = $this->current_report['sort_to_date'];
			$basis = $this->current_report['basis'];
		} else {

			$timeframe = $_POST['timeframe'];
			$tax_state = $_POST['tax_state'];
			$sort_from_date = $_POST['sort_from_date'];
			$sort_to_date = $_POST['sort_to_date'];
			$basis = $_POST['basis'];
		}

		$save = $_POST['save'];
		$saved_cat = "sales_tax_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];

		if ( ! $save )
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);

		$e = false;
		if ( $save && ! $report_name ) {

			$e = true;
			$this->__trigger_error("In order to save this report you must give the report a name.", E_USER_ERROR, __FILE__, __LINE__);
		}

		if ( $save && ! $report_hash ) {

			$result = $this->db->query("SELECT COUNT( t1.obj_id ) AS Total
										FROM reports t1
										WHERE t1.owner_hash = '{$this->current_hash}' AND t1.saved = 1 AND t1.report_name = '$report_name'");
			if ( $this->db->result($result, 0, 'Total') ) {

				$e = true;
				$this->__trigger_error("You already have a report saved under the same name! Please make sure you are not creating a duplicate.", E_USER_ERROR, __FILE__, __LINE__);
			}
		}

		if ( $share && ! count($sales_rep_share) && ! count($group_share) ) {

			$e = true;
			$this->__trigger_error("In order to share this report please select a user or group to share to.", E_USER_ERROR, __FILE__, __LINE__);
		}

		if ( $e )
			return $this->__trigger_error(false, E_USER_ERROR, __FILE__, __LINE__, 1);

		if ( isset( $us_states[ $tax_state ] ) ) {

            $tax_country = 'US';
            $this->tax_state = $us_states[ $tax_state ];
		} elseif ( isset($ca_states[ $tax_state ]) ) {

            $tax_country = 'CA';
            $this->tax_state = $ca_states[ $tax_state ];
		}

		switch ( $timeframe ) {

			case 1: # This Month

			$this->report_date_start = date("Y-m-01");
			$this->report_date_end = date("Y-m-t");
			$sql_p[] = "t1.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";

			break;

			case 2: # Last Month

			$this->report_date_start = date("Y-m-01", strtotime( date("Y-m-d") . " -1 month" ) );
			$this->report_date_end = date("Y-m-t", strtotime( date("Y-m-d") . " -1 month" ) );
			$sql_p[] = "t1.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";

			break;

			case 3: # This Quarter

			list($this->report_date_start, $this->report_date_end) = get_quarter_dates( get_quarter( date("Y-m-d") ), date("Y"));
			$sql_p[] = "t1.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";

			break;

			case 4: # Last Quarter

			$current_qtr = get_quarter(date("Y-m-d"));
			if ( $current_qtr == 1 ) {

				$previous_qtr = get_quarter( date("Y-m-d", strtotime(date("Y-m-d") . " -4 months") ) );
				list($start, $date) = get_quarter_dates( $previous_qtr, date("Y", strtotime(date("Y-m-d") . " -4 months") ) );
			} else
				list($this->report_date_start, $this->report_date_end) = get_quarter_dates(--$current_qtr, date("Y"));

			$sql_p[] = "t1.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";

			break;

			case 5: # This Period

			$period_info = get_period_info( date("Y-m-d") );
			if ( $period_info['period_start'] ) {

				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = "t1.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			} else {

				return $this->__trigger_error("You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings", E_USER_ERROR, __FILE__, __LINE__, 1);
			}

			break;

			case 6: # Last Period

			$period_info = get_previous_period( date("Y-m-d") );
			if ( $period_info['period_start'] ) {

				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = "t1.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
			} else {

				return $this->__trigger_error("You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings", E_USER_ERROR, __FILE__, __LINE__, 1);
			}

			break;

			case 7: # This Year

            if ( defined('FISCAL_YEAR_START') ) {

				list($month, $day) = explode("/", FISCAL_YEAR_START);
				if ( ! $month || ! $day )
					$month = $day = 1;

				$this->report_date_start = date("Y-$month-$day");
				$this->report_date_end = date("Y-" . ($month + 11) . date("t", strtotime( date("Y-" . ( $month + 11 ) . "-01") ) ) );
				$sql_p[] = "t1.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
            } else {

                return $this->__trigger_error("Unable to apply date filters to your report because your fiscal year and period layout dates have not been properly set up. Please check the business cycle settings under your system's Accounting section and try again.", E_USER_ERROR, __FILE__, __LINE__, 1);
            }

			break;

			case 8: # Last Year

            if ( defined('FISCAL_YEAR_START') ) {

				list($month, $day) = explode("/", FISCAL_YEAR_START);
				if ( ! $month || ! $day )
					$month = $day = 1;

				$last_year = date("Y") - 1;
				$this->report_date_start = "$last_year-$month-$day";
				$this->report_date_end = "$last_year-" . ( $month + 11 ) . "-" . date("t", strtotime( date("$last_year-" . ( $month + 11 ) . "-01") ) );
				$sql_p[] = "t1.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";
            } else {

                return $this->__trigger_error("Unable to apply date filters to your report because your fiscal year and period layout dates have not been properly set up. Please check the business cycle settings under your system's Accounting section and try again.", E_USER_ERROR, __FILE__, __LINE__, 1);
            }

			break;

			case 9: # Specific Date

			$this->report_date_start = $sort_from_date;
			$this->report_date_end = $sort_to_date;
			$sql_p[] = "t1.invoice_date BETWEEN '{$this->report_date_start}' AND '{$this->report_date_end}'";

			break;
		}

		if ( $sql_p )
			$sql = implode(" AND ", $sql_p);

		$str = "timeframe=$timeframe|tax_state=$tax_state|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|basis=$basis";

		if ( ! $this->db->start_transaction() )
			return $this->__trigger_error("{$this->db->db_errno} - {$this->db->db_error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);

		if ( ! $report_hash ) {

			$report_hash = rand_hash('reports', 'report_hash');
			if ( ! $this->db->query("INSERT INTO reports
									  VALUES
									  (
										  NULL,
										  UNIX_TIMESTAMP(), " .
										  ( $save ? 1 : 0 ) . ",
										  '$saved_cat',
										  '$report_hash',
										  '{$this->current_hash}',
										  '$report_name',
										  '$report_descr',
										  '$str',
										  '',
										  '" . __METHOD__ . "',
										  ''
									  )")
			) {

				return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
			}

			if ( $share && ( count($group_share) || count($sales_rep_share) ) ) {

				for ( $i = 0; $i < count($group_share); $i++ ) {

					if ( ! $this->db->query("INSERT INTO reports_share
											 VALUES
											 (
												 NULL,
												 '$report_hash',
												 NULL,
												 '{$group_share[$i]}'
											 )")
					) {

						return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
					}
				}

				for ( $i = 0; $i < count($sales_rep_share); $i++ ) {

					if ( ! $this->db->query("INSERT INTO reports_share
											 VALUES
											 (
												 NULL,
												 '$report_hash',
												 '{$sales_rep_share[$i]}',
												 NULL
											 )")
					) {

						return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
					}
				}
			}

		} elseif ( ! $from_saved ) {

			if ( ! $this->db->query("UPDATE reports t1
									 SET
										 t1.timestamp = UNIX_TIMESTAMP(),
										 t1.saved = '$save',
										 t1.saved_catagory = '$saved_cat',
										 t1.owner_hash = '{$this->current_hash}',
										 t1.report_name = '$report_name',
										 t1.report_descr = '$report_descr',
										 t1.str = '$str'
									 WHERE t1.report_hash = '$report_hash'")
			) {

				return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
			}

			if ( ! $share ) {

				if ( ! $this->db->query("DELETE FROM reports_share
										 WHERE report_hash = '{$this->report_hash}'")
				) {

					return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
				}

			} else {

				if ( ! is_array($sales_rep_share) )
					$sales_rep_share = array();
				if ( ! is_array($group_share) )
					$group_share = array();

				# Share or revoke to users
				$current_share_users = array();
				$result = $this->db->query("SELECT t1.user_hash
											FROM reports_share t1
											WHERE t1.report_hash = '$report_hash'");
				while ( $row = $this->db->fetch_assoc($result) )
					array_push($current_share_users, $row['user_hash']);

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if ( $to_remove ) {

					while ( list($i) = each($to_remove) ) {

						if ( ! $this->db->query("DELETE FROM reports_share
												 WHERE user_hash = '{$current_share_users[$i]}'")
						) {

							return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
						}
					}
				}

				$to_add = array_diff($sales_rep_share, $current_share_users);
				if ( is_array($to_add) ) {

					while ( list($i) = each($to_add) ) {

						if ( ! $this->db->query("INSERT INTO reports_share
												 VALUES
												 (
													 NULL,
													 '$report_hash',
													 '{$sales_rep_share[$i]}',
													 NULL
												 )")
						) {

							return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
						}
					}
				}

				# Share or revoke to groups
				$current_share_groups = array();
				$result = $this->db->query("SELECT t1.group_hash
											FROM reports_share t1
											WHERE t1.report_hash = '$report_hash'");
				while ( $row = $this->db->fetch_assoc($result) )
					array_push($current_share_groups, $row['group_hash']);

				$to_remove = array_diff($current_share_groups, $group_share);
				if ( $to_remove ) {

					while ( list($i) = each($to_remove) ) {

						if ( ! $this->db->query("DELETE FROM reports_share
												 WHERE group_hash = '{$current_share_groups[$i]}'")
						) {

							return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
						}
					}
				}

				$to_add = array_diff($group_share, $current_share_groups);
				if ( $to_add ) {

					while ( list($i) = each($to_add) ) {

						if ( ! $this->db->query("INSERT INTO reports_share
												 VALUES
												 (
													 NULL,
													 '$report_hash',
													 NULL,
													 '{$group_share[$i]}'
												 )")
						) {

							return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
						}
					}
				}
			}
		}

		$this->db->end_transaction();

		$this->report_hash = $report_hash;

		$this->tax_rules = array();
		$r = $this->db->query("SELECT tax_hash, state, local
				               FROM tax_table
				               WHERE state = '$tax_state' AND active = 1 AND deleted = 0
				               ORDER BY local ASC");
		while ( $row = $this->db->fetch_assoc( $r ) ) {

		    $this->tax_rules[ $row['tax_hash'] ] = $row;
		    if ( ! $row['local'] )
		        $this->default_tax = $row['tax_hash'];
		}

		$this->state_tax = $this->local_tax = $this->customers = $this->credit = array();
		$result = $this->db->query("SELECT
					                    t1.invoice_hash,
					                    t1.customer_hash,
					                    t1.install_city,
					                    t1.install_state,
					                    t1.install_zip,
					                    t1.invoice_no,
					                    t1.amount AS invoice_gross,
					                    ( t1.amount - t1.tax ) AS invoice_net,
					                    t2.customer_name,
					                    t2.tax_exempt_id,
					                    t2.city,
					                    t2.state,
					                    t2.zip,
					                    IFNULL( t3.total_receipts, 0 ) AS total_receipts,
					                    IFNULL( t4.total, 0 ) AS credit_total,
					                    IFNULL( t4.tax, 0 ) AS credit_tax
					                FROM customer_invoice t1
					                LEFT JOIN customers t2 ON t2.customer_hash = t1.customer_hash
					                LEFT JOIN (
					                    SELECT
						                    t1.invoice_hash,
						                    SUM( t1.receipt_amount ) AS total_receipts,
						                    t1.receipt_date
					                    FROM customer_payment t1
					                    WHERE " .
                                        ( $sql ?
                                            preg_replace('/^t1.invoice_date/', 't1.receipt_date', $sql) . " AND " : NULL
                                        ) . "deleted = 0
					                    GROUP BY invoice_hash
					                ) t3 ON t3.invoice_hash = t1.invoice_hash
					                LEFT JOIN (
										SELECT
											t1.invoice_hash,
											SUM( t1.amount ) AS total,
											SUM( t1.tax ) AS tax
										FROM customer_credit t1
										WHERE " .
                                        ( $sql ?
                                        	preg_replace('/^t1.invoice_date/', 't1.credit_date', $sql) . " AND " : NULL
                                        ) . "deleted = 0
                                        GROUP BY t1.invoice_hash
					                ) t4 ON t4.invoice_hash = t1.invoice_hash
					                WHERE " .
                                    ( $sql ?
                                        ( $basis == 'C' ?
                                            "( ( $sql ) OR ( " . preg_replace('/^t1.invoice_date/', 't3.receipt_date', $sql) . " ) )" : $sql
                                        ) . " AND " : NULL
                                    ) . "t1.install_state = '$tax_state' AND t1.type = 'I' AND t1.invoice_to = 'C' AND t1.deleted = 0
					                GROUP BY t1.invoice_hash
					                ORDER BY t1.invoice_date, t1.invoice_no ASC");
		while ( $row = $this->db->fetch_assoc($result) ) {

			$this->state_tax[ $row['customer_hash'] ][ $row['invoice_hash'] ] = array(
                'invoice_hash'      =>  $row['invoice_hash'],
				'invoice_no'        =>  $row['invoice_no'],
				'install_city'      =>  $row['install_city'],
				'install_state'     =>  $row['install_state'],
				'install_zip'       =>  $row['install_zip'],
				'invoice_net'       =>  $row['invoice_net'],
				'total_receipts'    =>  $row['total_receipts'],
				'credit_total'		=>	$row['credit_total'],
				'credit_tax'		=>	$row['credit_tax']
			);
			$this->customers[ $row['customer_hash'] ] = array(
                'customer_name'     =>  stripslashes( $row['customer_name'] ),
                'city'              =>  stripslashes( $row['city'] ),
                'state'             =>  $row['state'],
			    'zip'               =>  $row['zip'],
                'tax_id'            =>  $row['tax_exempt_id']
			);

            if ( $basis == 'C' ) {
                $perc_rcvd = bcdiv($row['total_receipts'], $row['invoice_gross'], 6);
                if ( bccomp($prec_rcvd, 1, 6) == 1 )
                    $perc_rcvd = 1;

            }

		    # Tax collected at invoice time
		    $r_2 = $this->db->query("SELECT
										 t1.tax_hash,
										 t1.invoice_hash,
										 t1.rate,
										 ROUND( SUM( ( t2.sell * t2.qty ) * t1.rate ), 4) AS tax_collected
			                         FROM tax_collected t1
			                         LEFT JOIN line_items t2 ON t2.item_hash = t1.item_hash
			                         WHERE t1.invoice_hash = '{$row['invoice_hash']}' AND t1.deleted = 0
			                         GROUP BY t1.tax_hash");
		    while ( $row_2 = $this->db->fetch_assoc($r_2) ) {

		        $this->local_tax[ $row_2['tax_hash'] ][ $row['customer_hash'] ][ $row['invoice_hash'] ] = array(
		            'tax_collected' =>  $row_2['tax_collected'],
		            'liability'     =>  ( $basis == 'C' ? _round( bcmul($row_2['tax_collected'], $perc_rcvd, 4), 2) : $row_2['tax_collected'] ),
		            'rate'          =>  $row_2['rate']
		        );
		    }

		    # Taxable vs Non-Taxable
		    $r_2 = $this->db->query("SELECT
			    						 t4.tax_hash,
			    						 t4.rate,
			    						 ROUND( SUM( t1.sell * t1.qty ), 2) AS taxable_sell
			                         FROM line_items t1
			                         LEFT JOIN vendor_products t2 ON t2.product_hash = t1.product_hash
			                         LEFT JOIN product_tax t3 ON t3.product_hash = t1.product_hash
			                         LEFT JOIN tax_table t4 ON t4.tax_hash = t3.tax_hash
			                         WHERE t1.invoice_hash = '{$row['invoice_hash']}' AND t2.product_taxable = 1 AND t4.state = '$tax_state'
			                         GROUP BY t4.tax_hash");
		    while ( $row_2 = $this->db->fetch_assoc($r_2) ) {

		        if ( $this->local_tax[ $row_2['tax_hash'] ][ $row['customer_hash'] ][ $row['invoice_hash'] ] )
		            $this->local_tax[ $row_2['tax_hash'] ][ $row['customer_hash'] ][ $row['invoice_hash'] ]['taxable'] = $row_2['taxable_sell'];
		    }

		    if ( bccomp($row['credit_total'], 0, 2) ) {

		    	$this->credit[ $row['invoice_hash'] ] = array();
		    	$r_2 = $this->db->query("SELECT
			    							t1.credit_hash,
			    							t1.invoice_hash,
			    							t1.credit_no,
			    							t1.credit_date,
			    							( t1.amount - t1.tax ) AS credit_net,
			    							t1.tax,
			    							t1.notes,
			    							t3.tax_hash,
			    							t3.rate,
			    							SUM( t2.amount ) AS taxable_credit,
			    							ROUND( SUM( t2.amount * t3.rate ), 2) AS tax_collected,
			    							ROUND( SUM( t2.amount * t3.rate ), 2) AS liability
		    							FROM customer_credit t1
										LEFT JOIN customer_credit_expenses t2 ON t2.credit_hash = t1.credit_hash
										LEFT JOIN tax_collected t3 ON t3.item_hash = t2.item_hash
		    							WHERE t1.invoice_hash = '{$row['invoice_hash']}' AND " .
                                        ( $sql ?
                                        	preg_replace('/^t1.invoice_date/', 't1.credit_date', $sql) . " AND " : NULL
                                        ) . "t1.deleted = 0
                                        GROUP BY t3.tax_hash");
				while ( $row_2 = $this->db->fetch_assoc($r_2) ) {

					$this->credit[ $row['invoice_hash'] ][ $row_2['tax_hash'] ][ $row_2['credit_hash'] ] = $row_2;
				}
		    }
		}

		asort( $this->customers );
		$this->content['action'] = 'close';

		if ($local)
			return true;
		else
			$this->content['html']['place_holder'] = $this->sales_tax(1);

		return;
	}

	function sales_tax($step=NULL) {
		$this->unlock("_");

		if ($step) {

			$this->fetch_report_settings($this->report_hash);

            $tbl_header = "
                <tr style=\"font-weight:bold;font-size:8pt;background-color:#efefef;\">
                    <td style=\"width:15px;border-bottom:1px solid #8c8c8c;\">&nbsp;</td>
                    <td style=\"width:15px;border-bottom:1px solid #8c8c8c;\">&nbsp;</td>
                    <td style=\"width:115px;text-align:left;font-size:8pt;vertical-align:bottom;border-bottom:1px solid #8c8c8c;\">Invoice</td>
                    <td style=\"width:105px;font-size:8pt;vertical-align:bottom;text-align:right;border-bottom:1px solid #8c8c8c;\">Total Sale</td>
                    <td style=\"width:105px;text-align:right;font-size:8pt;vertical-align:bottom;border-bottom:1px solid #8c8c8c;\" >Non-Taxable</td>
                    <td style=\"width:105px;text-align:right;font-size:8pt;vertical-align:bottom;border-bottom:1px solid #8c8c8c;\" >Taxable</td>
                    <td style=\"width:65px;text-align:right;font-size:8pt;vertical-align:bottom;border-bottom:1px solid #8c8c8c;\" >Rate</td>
                    <td style=\"width:95px;text-align:right;font-size:8pt;vertical-align:bottom;border-bottom:1px solid #8c8c8c;\" >Collected</td>
                    <td style=\"width:95px;text-align:right;font-size:8pt;vertical-align:bottom;border-bottom:1px solid #8c8c8c;\" >Liability</td>
                    <td style=\"width:230px;font-size:8pt;vertical-align:bottom;padding-left:10px;border-bottom:1px solid #8c8c8c;\">Install Location</td>
                </tr>";

			$tbl = $this->form->form_tag() .
			$this->form->hidden( array(
    			'test'       =>  1,
    			'popup_id'   =>  ''
			) ) . "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;margin-top:0;width:945px;\">
				<tr>
					<td style=\"background-color:#ffffff;padding:10px;width:945px;\" colspan=\"10\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">" .
							( $this->current_report['saved'] ?
								$this->current_report['report_name'] : "Sales Tax Liability Report"
							) .
							( $this->p->ck('reports', 'V', 'sales_tax') ? "
								<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
									[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'sales_tax', 'popup_id=report_filter', 'report_hash={$this->report_hash}');\" class=\"link_standard\">Update Report Settings</a></small>]
								</span>" : NULL
							) . "
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=sales_tax', 'report_hash={$this->report_hash}');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it_xls', 'type=sales_tax', 'report_hash={$this->report_hash}', 'popup_id=xls_win')\"><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>
					</td>
				</tr>
                <tr>
                    <td style=\"background-color:#efefef;font-weight:bold;font-size:11pt;width:945px;border-top:1px solid #8c8c8c;\" colspan=\"10\">{$this->tax_state}</td>
                </tr>" .
                $tbl_header;

				reset( $this->customers );

				$total_sell = $total_non = $total_tax = $total_coll = $total_owed = 0;

				while ( list($customer_hash, $customer) = each($this->customers) ) {

					if ( $this->state_tax[ $customer_hash ] ) {

                        $tbl .= "
                        <tr>
                            <td style=\"background-color:#ffffff;width:15px;\">&nbsp;</td>
                            <td colspan=\"9\" style=\"width:930px;background-color:#ffffff;font-size:8pt;padding-bottom:10px;\">
                                {$customer['customer_name']}" .
                                ( $customer['city'] && $customer['state'] && $customer['zip'] ?
	                                "<br />
                                    {$customer['city']}, {$customer['state']} {$customer['zip']}" : NULL
    	            			) .
    	            			( $customer['tax_id'] ?
    	            			    "<br />
    	            			    Tax Exemption ID: {$customer['tax_id']}" : NULL
    	            			) . "
                            </td>
                        </tr>";

                        while ( list($invoice_hash, $invoice_detail) = each($this->state_tax[ $customer_hash ]) ) {

                        	$tbl .= "
                        	<tr>
                        	    <td style=\"background-color:#ffffff;width:30px;\" colspan=\"2\">&nbsp;</td>
                                <td style=\"background-color:#ffffff;font-size:8pt;\">
                                    <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=$invoice_hash', 'popup_id=invoice_win');\" title=\"View Invoice\" style=\"color:#000;\">{$invoice_detail['invoice_no']}</a>
                                </td>
                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">\$" . number_format($invoice_detail['invoice_net'], 2) . "</td>
                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">\$" . number_format(bcsub($invoice_detail['invoice_net'], $this->local_tax[ $this->default_tax ][ $customer_hash ][ $invoice_hash ]['taxable'], 2), 2) . "</td>
                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">\$" . number_format($this->local_tax[ $this->default_tax ][ $customer_hash ][ $invoice_hash ]['taxable'], 2) . "</td>
                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">" . trim_decimal( bcmul($this->local_tax[ $this->default_tax ][ $customer_hash ][ $invoice_hash ]['rate'], 100, 4) ) . "%</td>
                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">\$" . number_format($this->local_tax[ $this->default_tax ][ $customer_hash ][ $invoice_hash ]['tax_collected'], 2) . "</td>
                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">\$" . number_format($this->local_tax[ $this->default_tax ][ $customer_hash ][ $invoice_hash ]['liability'], 2) . "</td>
                                <td style=\"background-color:#ffffff;font-size:8pt;padding-left:10px;\">" .
                                    ( strlen($invoice_detail['install_city']) > 17 ?
                                        substr($invoice_detail['install_city'], 0, 17) : $invoice_detail['install_city']
                                    ) . ", {$invoice_detail['install_state']} {$invoice_detail['install_zip']}
                                </td>
                        	</tr>";

                        	$total_sell = bcadd($total_sell, $invoice_detail['invoice_net'], 2);
                        	$total_non = bcadd($total_non, bcsub($invoice_detail['invoice_net'], $this->local_tax[ $this->default_tax ][ $customer_hash ][ $invoice_hash ]['taxable'], 2), 2);
                        	$total_tax = bcadd($total_tax, $this->local_tax[ $this->default_tax ][ $customer_hash ][ $invoice_hash ]['taxable'], 2);
                        	$total_coll = bcadd($total_coll, $this->local_tax[ $this->default_tax ][ $customer_hash ][ $invoice_hash ]['tax_collected'], 2);
                        	$total_owed = bcadd($total_owed, $this->local_tax[ $this->default_tax ][ $customer_hash ][ $invoice_hash ]['liability'], 2);

                        	if ( $this->credit[ $invoice_hash ][ $this->default_tax ] ) {

                        		while ( list($credit_hash, $credit_detail) = each($this->credit[ $invoice_hash ][ $this->default_tax ]) ) {

		                        	$tbl .= "
		                        	<tr>
		                        	    <td style=\"background-color:#ffffff;width:30px;\" colspan=\"2\">&nbsp;</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;font-style:italic;\">
    		                                <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_credits', 'sf_loadcontent', 'show_popup_window', 'invoice_credits', 'invoice_hash=$invoice_hash', 'credit_hash=$credit_hash', 'popup_id=credits_win');\" title=\"View Credit\" style=\"color:#000;\">{$credit_detail['credit_no']}</a>
		                                </td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">(\$" . number_format($credit_detail['credit_net'], 2) . ")</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\"></td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">(\$" . number_format($credit_detail['taxable_credit'], 2) . ")</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">" . trim_decimal( bcmul($credit_detail['rate'], 100, 4) ) . "%</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">(\$" . number_format($credit_detail['tax_collected'], 2) . ")</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">(\$" . number_format($credit_detail['liability'], 2) . ")</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;padding-left:10px;\"></td>
		                        	</tr>";

		                        	$total_sell = bcsub($total_sell, $credit_detail['credit_net'], 2);
		                        	$total_tax = bcsub($total_tax, $credit_detail['taxable_credit'], 2);
		                        	$total_coll = bcsub($total_coll, $credit_detail['tax_collected'], 2);
		                        	$total_owed = bcsub($total_owed, $credit_detail['liability'], 2);
                        		}
                        	}
                        }
					}
				}

				$tbl .= "
				<tr>
                    <td style=\"background-color:#ffffff;\" colspan=\"3\"></td>
                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;\">
                            \$" . number_format($total_sell, 2) . "
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;\">
                            \$" . number_format($total_non, 2) . "
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;\">
                            \$" . number_format($total_tax, 2) . "
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;\">&nbsp;</div>
                    </td>
                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;\">
                            \$" . number_format($total_coll, 2) . "
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;\">
                            \$" . number_format($total_owed, 2) . "
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;\">&nbsp;</div>
                    </td>
				</tr>";

                $total_sell = $total_non = $total_tax = $total_coll = $total_owed = 0;

				reset( $this->tax_rules );
				while ( list($tax_hash, $tax_rule) = each($this->tax_rules) ) {

					if ( $this->local_tax[ $tax_hash ] && $tax_hash != $this->default_tax ) {

				        $tbl .= "
				        <tr>
				            <td colspan=\"10\" style=\"background-color:#fff;padding-top:10px;\">&nbsp;</td>
				        </tr>
				        <tr>
				            <td style=\"background-color:#efefef;font-weight:bold;font-size:11pt;width:945px;border-top:1px solid #8c8c8c;\" colspan=\"10\">{$tax_rule['local']}</td>
				        </tr>" .
				        $tbl_header;

				        reset( $this->customers );
						while ( list($customer_hash, $customer) = each($this->customers) ) {

							if ( $this->local_tax[ $tax_hash ][ $customer_hash ] ) {

		                        $tbl .= "
		                        <tr>
                                    <td style=\"background-color:#ffffff;width:15px;\">&nbsp;</td>
		                            <td colspan=\"9\" style=\"width:930px;background-color:#ffffff;font-size:8pt;padding-bottom:10px\">
		                                {$customer['customer_name']} " .
		                                ( $customer['city'] && $customer['state'] && $customer['zip'] ?
		                                    "<br />
		                                    {$customer['city']}, {$customer['state']} {$customer['zip']}" : NULL
		                                ) .
		                                ( $customer['tax_id'] ?
		                                    "<br />
		                                    Tax Exemption ID: {$customer['tax_id']}" : NULL
		                                ) . "
		                            </td>
		                        </tr>";

								reset( $this->local_tax );
								while ( list($invoice_hash, $invoice_detail) = each($this->local_tax[ $tax_hash ][ $customer_hash ]) ) {

		                            $tbl .= "
		                            <tr>
		                                <td style=\"background-color:#ffffff;width:30px;\" colspan=\"2\">&nbsp;</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\">
    		                                <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=$invoice_hash', 'popup_id=invoice_win');\" title=\"View Invoice\"  style=\"color:#000;\">{$this->state_tax[ $customer_hash ][ $invoice_hash ]['invoice_no']}</a>
    		                            </td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">\$" . number_format($this->state_tax[ $customer_hash ][ $invoice_hash ]['invoice_net'], 2) . "</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">\$" . number_format(bcsub($this->state_tax[ $customer_hash ][ $invoice_hash ]['invoice_net'], $this->local_tax[ $tax_hash ][ $customer_hash ][ $invoice_hash ]['taxable'], 2), 2) . "</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">\$" . number_format($this->local_tax[ $tax_hash ][ $customer_hash ][ $invoice_hash ]['taxable'], 2) . "</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">" . trim_decimal( bcmul($this->local_tax[ $tax_hash ][ $customer_hash ][ $invoice_hash ]['rate'], 100, 4) ) . "%</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">\$" . number_format($this->local_tax[ $tax_hash ][ $customer_hash ][ $invoice_hash ]['tax_collected'], 2) . "</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">\$" . number_format($this->local_tax[ $tax_hash ][ $customer_hash ][ $invoice_hash ]['liability'], 2) . "</td>
		                                <td style=\"background-color:#ffffff;font-size:8pt;padding-left:10px;\">" .
		                                    ( strlen($this->state_tax[ $customer_hash ][ $invoice_hash ]['install_city']) > 17 ?
		                                        substr($this->state_tax[ $customer_hash ][ $invoice_hash ]['install_city'], 0, 17) : $this->state_tax[ $customer_hash ][ $invoice_hash ]['install_city']
		                                    ) . ", {$this->state_tax[ $customer_hash ][ $invoice_hash ]['install_state']} {$this->state_tax[ $customer_hash ][ $invoice_hash ]['install_zip']}
		                                </td>
		                            </tr>";

		                            $total_sell = bcadd($total_sell, $this->state_tax[ $customer_hash ][ $invoice_hash ]['invoice_net'], 2);
		                            $total_non = bcadd($total_non, bcsub($this->state_tax[ $customer_hash ][ $invoice_hash ]['invoice_net'], $this->local_tax[ $tax_hash ][ $customer_hash ][ $invoice_hash ]['taxable'], 2), 2);
		                            $total_tax = bcadd($total_tax, $this->local_tax[ $tax_hash ][ $customer_hash ][ $invoice_hash ]['taxable'], 2);
		                            $total_coll = bcadd($total_coll, $this->local_tax[ $tax_hash ][ $customer_hash ][ $invoice_hash ]['tax_collected'], 2);
		                            $total_owed = bcadd($total_owed, $this->local_tax[ $tax_hash ][ $customer_hash ][ $invoice_hash ]['liability'], 2);

		                            if ( $this->credit[ $invoice_hash ][ $this->default_tax ] ) {

		                                while ( list($credit_hash, $credit_detail) = each($this->credit[ $invoice_hash ][ $tax_hash ]) ) {

		                                    $tbl .= "
		                                    <tr>
		                                        <td style=\"background-color:#ffffff;width:30px;\" colspan=\"2\">&nbsp;</td>
		                                        <td style=\"background-color:#ffffff;font-size:8pt;font-style:italic;\">
    		                                        <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_credits', 'sf_loadcontent', 'show_popup_window', 'invoice_credits', 'invoice_hash=$invoice_hash', 'credit_hash=$credit_hash', 'popup_id=credits_win');\" title=\"View Credit\" style=\"color:#000;\">{$credit_detail['credit_no']}</a>
    		                                    </td>
		                                        <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">(\$" . number_format($credit_detail['credit_net'], 2) . ")</td>
		                                        <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\"></td>
		                                        <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">(\$" . number_format($credit_detail['taxable_credit'], 2) . ")</td>
		                                        <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">" . trim_decimal( bcmul($credit_detail['rate'], 100, 4) ) . "%</td>
		                                        <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">(\$" . number_format($credit_detail['tax_collected'], 2) . ")</td>
		                                        <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">(\$" . number_format($credit_detail['liability'], 2) . ")</td>
		                                        <td style=\"background-color:#ffffff;font-size:8pt;padding-left:10px;\"></td>
		                                    </tr>";

		                                    $total_sell = bcsub($total_sell, $credit_detail['credit_net'], 2);
		                                    $total_tax = bcsub($total_tax, $credit_detail['taxable_credit'], 2);
		                                    $total_coll = bcsub($total_coll, $credit_detail['tax_collected'], 2);
		                                    $total_owed = bcsub($total_owed, $credit_detail['liability'], 2);
		                                }
		                            }
								}
							}
						}

		                $tbl .= "
		                <tr>
		                    <td style=\"background-color:#ffffff;\" colspan=\"3\"></td>
		                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
		                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;font-size:8pt;\">
		                            \$" . number_format($total_sell, 2) . "
		                        </div>
		                    </td>
		                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
		                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;font-size:8pt;\">
		                            \$" . number_format($total_non, 2) . "
		                        </div>
		                    </td>
		                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
		                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;font-size:8pt;\">
		                            \$" . number_format($total_tax, 2) . "
		                        </div>
		                    </td>
		                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
		                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;font-size:8pt;\">&nbsp;</div>
		                    </td>
		                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
		                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;font-size:8pt;\">
		                            \$" . number_format($total_coll, 2) . "
		                        </div>
		                    </td>
		                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
		                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;font-size:8pt;\">
		                            \$" . number_format($total_owed, 2) . "
		                        </div>
		                    </td>
		                    <td style=\"background-color:#ffffff;text-align:right;padding-top:20px;\">
		                        <div style=\"border-top:1px dashed #000000;width:95%;padding-top:5px;font-size:8pt;\">&nbsp;</div>
		                    </td>
		                </tr>";

		                $total_sell = $total_non = $total_tax = $total_coll = $total_owed = 0;
					}
				}

			$tbl .= "
			</table>" .
			$this->form->close_form();

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			array_shift($this->user_name);
			array_shift($this->user_hash);

			global $stateNames, $states;

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

            $tax_state = array();
			$result = $this->db->query("SELECT t1.state
										FROM tax_table t1
										WHERE ISNULL( t1.local ) OR t1.country = 'CA'
										ORDER BY t1.state ASC");
			while ($row = $this->db->fetch_assoc($result)) {
				if (!in_array($row['state'], $tax_abbrev)) {
					$tax_state[] = $stateNames[array_search($row['state'], $states)];
					$tax_abbrev[] = $row['state'];
				}
			}
			$tbl = $this->form->form_tag() .
			$this->form->hidden( array(
    			'test'           => 1,
    			'report_hash'    => $report_hash,
    			'popup_id'       => $this->popup_id
			) ) . "
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_sales_tax');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_sales_tax', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Sales Tax Liability Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9), "onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Generate report according to: </td>
											<td style=\"background-color:#ffffff;\">" .
												$this->form->select(
    												"basis",
    												array("Accrual Basis", "Cash Basis"),
    												$this->current_report['basis'],
    												array('A', 'C'),
    												"blank=1",
    												"style=width:175px;"
    											) . "
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Should the report be<br />filtered to a specific state? </td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->select("tax_state", $tax_state, $this->current_report['tax_state'], $tax_abbrev, "blank=1")."
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}

	}


	function customer_name($customer_hash) {
		$result = $this->db->query("SELECT `customer_name`
									FROM `customers`
									WHERE `customer_hash` = '$customer_hash'");
		$name = $this->db->result($result);
		if (!$name) {
			$result = $this->db->query("SELECT `vendor_name`
										FROM `vendors`
										WHERE `vendor_hash` = '$customer_hash'");
			$name = $this->db->result($result);
		}

		return $name;
	}


    function doit_ap() {
        $date = date("U") - 3600;
        $result = $this->db->query("DELETE FROM `reports`
                                    WHERE `saved` = 0 AND `timestamp` <= '$date'");

        if ($_POST['rm'] == 1 && $_POST['report_hash']) {
            $this->db->query("DELETE reports.* , reports_share.*
                              FROM `reports`
                              LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
                              WHERE reports.report_hash = '".$_POST['report_hash']."'");
            $this->content['action'] = 'close';
            $this->content['page_feedback'] = "Report has been deleted.";
            $this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
            return;
        }

        $doit_print = $_POST['doit_print'];
        $report_hash = $_POST['report_hash'];
        $from_saved = $this->ajax_vars['from_saved'];

        if (($doit_print && $report_hash) || $from_saved) {
            $this->fetch_report_settings($report_hash);

            $timeframe = $this->current_report['timeframe'];
            if ($timeframe == 5) {
                $sort_from_date = $this->current_report['sort_from_date'];
                $sort_to_date = $this->current_report['sort_to_date'];
            }
            $age1 = $this->current_report['age1'];
            $age2 = $this->current_report['age2'];
            $age3 = $this->current_report['age3'];
            $vendor_filter = $this->current_report['vendor_filter'];
            if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);

			// Add proposal filter for #1265
			$proposal_filter = $this->current_report['proposal_filter'];
			if ($proposal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);

            //Simple view is 1, detail view is 2
            $showdetail = $this->current_report['showdetail'];
            $invoices_paid = $this->current_report['invoices_paid'];
            $report_date = $this->current_report['report_date'];
        } else {
            $timeframe = $_POST['timeframe'];
            if ($timeframe == 5) {
                $sort_from_date = $_POST['sort_from_date'];
                $sort_to_date = $_POST['sort_to_date'];
            }
            $age1 = $_POST['age1'];
            $age2 = $_POST['age2'];
            $age3 = $_POST['age3'];
            $vendor_filter = $_POST['vendor_filter'];
            if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);

            $proposal_filter = $_POST['proposal_filter'];
            if ($proposal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter);

            $showdetail = $_POST['showdetail'];
            $invoices_paid = $_POST['invoices_paid'];
            $report_date = $_POST['report_date'];
        }
        if ($from_report = $_POST['from_report']) {
            $this->fetch_report_settings($report_hash);

            $vendor_filter = $this->current_report['vendor_filter'];
            if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);

            // Added proposal filter for #1265
			$proposal_filter = $this->current_report['proposal_filter'];
			if ($proposal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);

            $timeframe = $this->current_report['timeframe'];
            if ($timeframe == 5) {
                $sort_from_date = $this->current_report['sort_from_date'];
                $sort_to_date = $this->current_report['sort_to_date'];
            }
            $age1 = $this->current_report['age1'];
            $age2 = $this->current_report['age2'];
            $age3 = $this->current_report['age3'];
            $invoices_paid = $this->current_report['invoices_paid'];
            $report_date = $this->current_report['report_date'];
        }

        $save = $_POST['save'];
        $saved_cat = "ap_report";
        $report_name = $_POST['report_name'];
        $report_descr = $_POST['report_descr'];
        $share = $_POST['share'];
        $sales_rep_share = $_POST['sales_rep_share'];
        $group_share = $_POST['group_share'];
        if (!$save)
            unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
        if ($save && !$report_name) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
        }
        if ($save && !$report_hash) {
            $result = $this->db->query("SELECT COUNT(*) AS Total
                                        FROM `reports`
                                        WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
            if ($this->db->result($result)) {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
            }
        }
        if ($share && !count($sales_rep_share) && !count($group_share)) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
        }

        if (($timeframe == 5 && $sort_to_date && $sort_from_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you select a valid date range.";
        }
        if (!$age1 || !$age2 || !$age3 || $age3 < $age2 || $age3 < $age1 || $age2 < $age1 || strspn($age1, "0123456789") != strlen($age1) || strspn($age2, "0123456789") != strlen($age2) || strspn($age3, "0123456789") != strlen($age3) || $age1 <= 0 || $age2 <= 0 || $age3 <= 0) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "Please enter valid aging schedules. Each of the 3 schedules must be specified and Age 3 must be greater than Age 2, Age 2 greater than Age 1, etc.";
        }

        if ($this->content['error'])
            return;

        if (is_array($vendor_filter) && count($vendor_filter)) {
            $vendor_filter = array_unique($vendor_filter);
            $vendor_filter = array_values($vendor_filter);
            array_walk($vendor_filter, 'add_quotes', "'");
            $sql_p[] = "t1.vendor_hash IN (".implode(" , ", $vendor_filter).")";
            array_walk($vendor_filter, 'strip_quotes');
        }

        // Add proposal filter for #1265
		if (is_array($proposal_filter) && count($proposal_filter)) {
			$proposal_filter = array_unique($proposal_filter);
			$proposal_filter = array_values($proposal_filter);
			array_walk($proposal_filter, 'add_quotes', "'");
			$sql_p[] = "t3.proposal_hash IN (".implode(" , ", $proposal_filter).")";
			array_walk($proposal_filter, 'strip_quotes');
		}

        switch ($timeframe) {
            case 1:
            $sql_p[] = $report_date." BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
            $this->report_title = " dated this year";
            break;

            case 2:
            $sql_p[] = $report_date." BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
            $compare_date = date("Y-12-31", strtotime(date("Y-m-d")." -1 year"));
            $this->report_title = " dated last year";
            break;

            case 3:
            $period_info = get_period_info(date("Y-m-d"));
            if ($period_info['period_start']) {
                $sql_p[] = $report_date." BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
                $this->report_title = " dated within the current period";
            } else {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
                return;
            }
            break;

            case 4:
            $period_info = get_period_info(date("Y-m-d"));
            $previos_period_date = date("Y-m-d", strtotime($period_info['period_start']." -1 day"));

            $period_info = get_period_info($previos_period_date);
            if ($period_info['period_start']) {
                $sql_p[] = $report_date." BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
                $compare_date = date("Y-m-d", strtotime($period_info['period_end']));
                $this->report_title = " dated last period";
            } else {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
                return;
            }
            break;

            case 5:
            if ($sort_from_date && $sort_to_date) {
                $sql_p[] = $report_date." BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
                if (strtotime($sort_to_date) < strtotime(date("Y-m-d")))
                    $compare_date = date("Y-m-d", strtotime($sort_to_date));

                $this->report_title = " dated between ".date(DATE_FORMAT, strtotime($sort_from_date))." and ".date(DATE_FORMAT, strtotime($sort_to_date));
            } elseif (!$sort_to_date && $sort_from_date) {
                $sql_p[] = $report_date." >= '".$sort_from_date."'";
                $this->report_title = " dated on or after ".date(DATE_FORMAT, strtotime($sort_from_date));
            } elseif ($sort_to_date && !$sort_from_date) {
                $sql_p[] = $report_date." <= '".$sort_to_date."'";
                if (strtotime($sort_to_date) < strtotime(date("Y-m-d")))
                    $compare_date = date("Y-m-d", strtotime($sort_to_date));

                $this->report_title = " dated on or before ".date(DATE_FORMAT, strtotime($sort_to_date));
            } elseif (!$sort_from_date && !$sort_to_date)
                unset($timeframe);

            break;

            default:
                $this->report_title = " dated as of ".date(DATE_FORMAT);
        }
        if ($invoices_paid == 1) {
            $having_p[] = "ROUND(balance_total, 2) != 0";
            $this->report_title = "Invoices with an open balance".$this->report_title;
        }
        if ($invoices_paid == 2) {
            $having_p[] = "ROUND(balance_total, 2) = 0";
            $this->report_title = "Invoice with a zero balance".$this->report_title;
        }
        if ($sql_p)
            $sql = implode(" AND ", $sql_p);
        if ($having_p)
            $having = implode(" AND ", $having_p);

        $str = "timeframe=$timeframe|sort_from_date=$sort_from_date|showdetail=$showdetail|sort_to_date=$sort_to_date|age1=$age1|age2=$age2|age3=$age3|vendor_filter=".@implode("&", $vendor_filter)."|invoices_paid=$invoices_paid|report_date=$report_date|proposal_filter=".@implode("&", $proposal_filter);

        if (!$report_hash) {
            $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
            while (global_classes::key_exists('reports', 'report_hash', $report_hash))
                $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

            $this->db->query("INSERT INTO `reports`
                              (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
                              VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

            if ($share && (count($group_share) || count($sales_rep_share))) {
                for ($i = 0; $i < count($group_share); $i++)
                    $this->db->query("INSERT INTO `reports_share`
                                      (`report_hash` , `group_hash`)
                                      VALUES ('$report_hash' , '".$group_share[$i]."')");

                for ($i = 0; $i < count($sales_rep_share); $i++)
                    $this->db->query("INSERT INTO `reports_share`
                                      (`report_hash` , `user_hash`)
                                      VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
            }
        } elseif (!$from_saved) {
            $existing = true;
            $this->db->query("UPDATE `reports`
                              SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
                              WHERE `report_hash` = '$report_hash'");

            if (!$share)
                $this->db->query("DELETE FROM `reports_share`
                                  WHERE `report_hash` = '".$this->report_hash."'");
            else {
                if (!is_array($sales_rep_share))
                    $sales_rep_share = array();
                if (!is_array($group_share))
                    $group_share = array();

                //Share or revoke to users
                $result = $this->db->query("SELECT `user_hash`
                                            FROM `reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_users[] = $row['user_hash'];

                if (!is_array($current_share_users))
                    $current_share_users = array();

                $to_remove = array_diff($current_share_users, $sales_rep_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `reports_share`
                                          WHERE `user_hash` = '".$current_share_users[$i]."'");
                }
                $to_add = array_diff($sales_rep_share, $current_share_users);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `reports_share`
                                          (`report_hash` , `user_hash`)
                                          VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
                }

                //Share or revoke to groups
                $result = $this->db->query("SELECT `group_hash`
                                            FROM `reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_groups[] = $row['group_hash'];

                if (!is_array($current_share_groups))
                    $current_share_groups = array();

                $to_remove = array_diff($current_share_groups, $group_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `reports_share`
                                          WHERE `group_hash` = '".$current_share_groups[$i]."'");
                }
                $to_add = array_diff($group_share, $current_share_groups);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `reports_share`
                                          (`report_hash` , `group_hash`)
                                          VALUES ('$report_hash' , '".$group_share[$i]."'");
                }
            }
        }
        $this->report_hash = $report_hash;

        $result = $this->db->query("SELECT ".($showdetail == 2 ? "
                                    t1.invoice_hash , t1.invoice_no , t1.receipt_date , t1.invoice_date , t1.due_date ,
                                    t1.type , t3.po_hash , t3.po_no , t3.proposal_hash , t3.po_product , " : NULL)."
                                    ".($showdetail == 1 ? "
                                        SUM(CASE
                                            WHEN t1.type = 'C'
                                                THEN (t1.amount * -1)
                                                ELSE t1.amount
                                            END
                                        )" : "CASE
                                                WHEN t1.type = 'C'
                                                    THEN (t1.amount * -1)
                                                    ELSE t1.amount
                                                END")." AS total_payable ,
                                    ".($showdetail == 1 ?
                                        "SUM(t2.total_amount_paid)" : "t2.total_amount_paid")." AS total_amount_paid , t1.vendor_hash ,
                                    ".($showdetail == 1 ?
                                        "SUM(t6.total_applied_credit)" : "t6.total_applied_credit")." AS total_applied_credit ,
                                    CASE
                                    WHEN ISNULL(t4.vendor_name)
                                        THEN t5.customer_name
                                        ELSE t4.vendor_name
                                    END AS vendor_name ,
                                    SUM(CASE
                                        WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , t1.due_date ) <= 0 AND (ISNULL(t2.total_amount_paid) OR (!ISNULL(t2.total_amount_paid) AND t1.amount - t2.total_amount_paid != 0))
                                          THEN (CASE
                                                WHEN ISNULL(t2.total_amount_paid)
                                                  THEN (CASE
                                                        WHEN t1.type = 'C'
                                                           THEN (t1.amount * -1)
                                                           ELSE t1.amount
                                                        END)
                                                  ELSE (CASE
                                                        WHEN t1.type = 'C'
                                                           THEN ((t1.amount - t2.total_amount_paid) * -1)
                                                           ELSE t1.amount - t2.total_amount_paid
                                                        END)
                                                END) -
                                                (CASE
                                                 WHEN t1.type = 'C' AND !ISNULL(t6.total_applied_credit)
                                                     THEN t6.total_applied_credit
                                                     ELSE 0
                                                 END)
                                          ELSE 0
                                        END
                                    ) AS balance_current ,
                                    SUM(CASE
                                        WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , t1.due_date ) BETWEEN 1 AND $age1 AND (ISNULL(t2.total_amount_paid) OR (!ISNULL(t2.total_amount_paid) AND t1.amount - t2.total_amount_paid != 0))
                                          THEN (CASE
                                                WHEN ISNULL(t2.total_amount_paid)
                                                  THEN (CASE
                                                        WHEN t1.type = 'C'
                                                           THEN (t1.amount * -1)
                                                           ELSE t1.amount
                                                        END)
                                                  ELSE (CASE
                                                        WHEN t1.type = 'C'
                                                           THEN ((t1.amount - t2.total_amount_paid) * -1)
                                                           ELSE t1.amount - t2.total_amount_paid
                                                        END)
                                                END) -
                                                (CASE
                                                 WHEN t1.type = 'C' AND !ISNULL(t6.total_applied_credit)
                                                     THEN t6.total_applied_credit
                                                     ELSE 0
                                                 END)
                                          ELSE 0
                                        END
                                    ) AS balance_sched1 ,
                                    SUM(CASE
                                        WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , t1.due_date ) BETWEEN ".($age1 + 1)." AND $age2 AND (ISNULL(t2.total_amount_paid) OR (!ISNULL(t2.total_amount_paid) AND t1.amount - t2.total_amount_paid != 0))
                                          THEN (CASE
                                                WHEN ISNULL(t2.total_amount_paid)
                                                  THEN (CASE
                                                        WHEN t1.type = 'C'
                                                           THEN (t1.amount * -1)
                                                           ELSE t1.amount
                                                        END)
                                                  ELSE (CASE
                                                        WHEN t1.type = 'C'
                                                           THEN ((t1.amount - t2.total_amount_paid) * -1)
                                                           ELSE t1.amount - t2.total_amount_paid
                                                        END)
                                                END) -
                                                (CASE
                                                 WHEN t1.type = 'C' AND !ISNULL(t6.total_applied_credit)
                                                     THEN t6.total_applied_credit
                                                     ELSE 0
                                                 END)
                                          ELSE 0
                                        END
                                    ) AS balance_sched2 ,
                                    SUM(CASE
                                        WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , t1.due_date ) >= ".($age2 + 1)." AND (ISNULL(t2.total_amount_paid) OR (!ISNULL(t2.total_amount_paid) AND t1.amount - t2.total_amount_paid != 0))
                                          THEN (CASE
                                                WHEN ISNULL(t2.total_amount_paid)
                                                  THEN (CASE
                                                        WHEN t1.type = 'C'
                                                           THEN (t1.amount * -1)
                                                           ELSE t1.amount
                                                        END)
                                                  ELSE (CASE
                                                        WHEN t1.type = 'C'
                                                           THEN ((t1.amount - t2.total_amount_paid) * -1)
                                                           ELSE t1.amount - t2.total_amount_paid
                                                        END)
                                                END) -
                                                (CASE
                                                 WHEN t1.type = 'C' AND !ISNULL(t6.total_applied_credit)
                                                     THEN t6.total_applied_credit
                                                     ELSE 0
                                                 END)
                                          ELSE 0
                                        END
                                    ) AS balance_sched3 ,
                                    SUM(CASE
                                        WHEN (ISNULL(t2.total_amount_paid) OR (!ISNULL(t2.total_amount_paid) AND t1.amount - t2.total_amount_paid != 0))
                                          THEN (CASE
                                                WHEN ISNULL(t2.total_amount_paid)
                                                  THEN (CASE
                                                        WHEN t1.type = 'C'
                                                           THEN (t1.amount * -1)
                                                           ELSE t1.amount
                                                        END)
                                                  ELSE (CASE
                                                        WHEN t1.type = 'C'
                                                           THEN ((t1.amount - t2.total_amount_paid) * -1)
                                                           ELSE t1.amount - t2.total_amount_paid
                                                        END)
                                                END) -
                                                (CASE
                                                 WHEN t1.type = 'C' AND !ISNULL(t6.total_applied_credit)
                                                     THEN t6.total_applied_credit
                                                     ELSE 0
                                                 END)
                                          ELSE 0
                                        END
                                    ) AS balance_total
                                    FROM vendor_payables t1
                                    LEFT JOIN ( SELECT invoice_hash ,
                                                (
                                                  CASE
                                                  WHEN !ISNULL(payment_amount)
                                                    THEN SUM(payment_amount)
                                                    ELSE 0
                                                  END +
                                                  CASE
                                                  WHEN !ISNULL(deposit_used)
                                                    THEN SUM(deposit_used)
                                                    ELSE 0
                                                  END +
                                                  CASE
                                                  WHEN !ISNULL(discount_taken)
                                                    THEN SUM(discount_taken)
                                                    ELSE 0
                                                  END +
                                                  CASE
                                                  WHEN !ISNULL(credit_used)
                                                    THEN SUM(credit_used)
                                                    ELSE 0
                                                  END
                                                ) AS total_amount_paid
                                                FROM vendor_payment t2
                                                LEFT JOIN check_register t3 ON t3.check_no = t2.check_no AND t3.account_hash = t2.account_hash
                                                WHERE".($compare_date ? "
                                                    t2.posting_date <= '".$compare_date."' AND" : NULL)." t3.void = 0
                                                GROUP BY t2.invoice_hash ) AS t2 ON t2.invoice_hash = t1.invoice_hash
                                    LEFT JOIN ( SELECT t2.invoice_hash ,
                                                CASE
                                                WHEN !ISNULL(t2.amount)
                                                    THEN SUM(t2.amount * -1)
                                                    ELSE 0
                                                END AS total_applied_credit
                                                FROM vendor_credit_applied t2
                                                LEFT JOIN vendor_payment t3 ON t3.payment_hash = t2.payment_hash
                                                LEFT JOIN check_register t4 ON t4.check_no = t3.check_no AND t4.account_hash = t3.account_hash
                                                WHERE".($compare_date ? "
                                                    t3.posting_date <= '".$compare_date."' AND" : NULL)." t2.void = 0 AND t4.void = 0
                                                GROUP BY t2.invoice_hash ) AS t6 ON t6.invoice_hash = t1.invoice_hash AND t1.type = 'C'
                                    LEFT JOIN vendors t4 ON t4.vendor_hash = t1.vendor_hash
                                    LEFT JOIN customers t5 ON t5.customer_hash = t1.vendor_hash
                                    LEFT JOIN purchase_order t3 ON t3.po_hash = t1.po_hash
                                    WHERE ".($compare_date ? "
                                        t1.invoice_date <= '".$compare_date."' AND " : NULL).($sql ?
                                            $sql." AND " : NULL)." t1.deleted = 0
                                    GROUP BY ".($showdetail == 1 ?
                                        "t1.vendor_hash" : "t1.invoice_hash").($having ? "
                                            HAVING ".$having : NULL));
        while ($row = $this->db->fetch_assoc($result)) {
            $sort_list[$row['vendor_hash']] = stripslashes($row['vendor_name']);
            $result_list[$row['vendor_hash']] = $row;
            if ($showdetail == 2)
                $this->invoice_detail[$row['vendor_hash']][($row['po_hash'] ? $row['po_hash'] : 'unassigned')][] = $row;

        }
        //Asending order
        @asort($sort_list);
        if (is_array($sort_list)) {
            while (list($hash, $name) = each($sort_list))
                $this->results[$hash] =& $result_list[$hash];

        }
        if ($from_report)
            $this->content['action'] = 'continue';
        else
            $this->content['action'] = 'close';

        $this->total = count($this->results);
        if ($doit_print)
            return;

        $this->content['html']['place_holder'] = $this->ap_report(1);
        return;
    }


    function ap_report($step=NULL) {
        $this->unlock("_");

        if ($step) {
            $this->fetch_report_settings($this->report_hash);
            if ($this->current_report['showdetail'] == 2)
                $colspan = 9;
            else
                $colspan = 7;

            $tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
            <table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:970px;margin-top:0;\">
                <tr>
                    <td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"".$colspan."\">
                        <h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
                            ".($this->current_report['saved'] ?
                                $this->current_report['report_name'] : "Accounts Payable Report").($this->p->ck('reports', 'V', 'ap') ? "
                            <span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
                                [<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'ap_report', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
                            </span>" : NULL)."
                            <div style=\"margin-left:15px;margin-top:10px;margin-bottom:10px;font-size:10pt;\">".$this->report_title."</div>
                        </h3>
                        <small style=\"margin-left:20px;margin-bottom:5px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
                        &nbsp;&nbsp;
                        <a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=ap_report', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
                    </td>
                </tr>
                <tr class=\"thead\" style=\"font-weight:bold;\">
                    <td style=\"width:200px;text-align:left;padding:15px 5px 5px 25px;vertical-align:bottom;\">".($this->current_report['showdetail'] == 2 ? "Invoice No." : "&nbsp;")."</td>".($this->current_report['showdetail'] == 2 ? "
                    <td style=\"width:110px;padding:5px;vertical-align:bottom;\" nowrap>Invoice Date</td>
                    <td style=\"width:90px;padding:5px;vertical-align:bottom;\">Due Date</td>" : NULL)."
                    <td style=\"width:120px;padding:5px;vertical-align:bottom;text-align:right;\">Orig Amt</td>
                    <td style=\"width:120px;padding:5px;vertical-align:bottom;text-align:right;\">Balance</td>
                    <td style=\"width:115px;padding:5px;vertical-align:bottom;text-align:right;\">Current</td>
                    <td style=\"width:115px;padding:5px;vertical-align:bottom;text-align:right;\">".$this->current_report['age1']." Days</td>
                    <td style=\"width:115px;padding:5px;vertical-align:bottom;text-align:right;\">".$this->current_report['age2']." Days</td>
                    <td style=\"width:115px;padding:5px;vertical-align:bottom;text-align:right;\">".$this->current_report['age3']." Days</td>
                </tr>";

            if (is_array($this->results)) {
                $k = 0;
                while (list($vendor_hash, $invoice_array) = each($this->results)) {
                    $total_invoice = $total_balance = $total_current = $total_sched1 = $total_sched2 = $total_sched3 = 0;
                    $tbl .= "
                    <tr style=\"background-color:".($this->current_report['showdetail'] == 2 ? "#efefef;" : ($k % 2 == 0 ? "#ffffff" : "#efefef"))."\">
                        <td ".($this->current_report['showdetail'] == 2 ? "colspan=\"3\"" : NULL)." style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".(strlen($invoice_array['vendor_name']) > 30 ?
                            stripslashes(substr($invoice_array['vendor_name'], 0, 30)).'...' : stripslashes($invoice_array['vendor_name']))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0 ?
                                "Amount" : "&nbsp;") : ($invoice_array['total_payable'] < 0 ?
                                    "($".number_format($invoice_array['total_payable'] * -1, 2).")" : "$".number_format($invoice_array['total_payable'], 2)))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0  ?
                                "Balance" : "&nbsp;") : ($invoice_array['balance_total'] < 0 ?
                                    "($".number_format($invoice_array['balance_total'] * -1, 2).")" : "$".number_format($invoice_array['balance_total'], 2)))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0  ?
                                "Current" : "&nbsp;") : ($invoice_array['balance_current'] < 0 ?
                                    "($".number_format($invoice_array['balance_current'] * -1, 2).")" : "$".number_format($invoice_array['balance_current'], 2)))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0  ?
                                $this->current_report['age1']." Days" : "&nbsp;") : ($invoice_array['balance_sched1'] < 0 ?
                                    "($".number_format($invoice_array['balance_sched1'] * -1, 2).")" : "$".number_format($invoice_array['balance_sched1'], 2)))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0  ?
                                $this->current_report['age2']." Days" : "&nbsp;") : ($invoice_array['balance_sched2'] < 0 ?
                                    "($".number_format($invoice_array['balance_sched2'] * -1, 2).")" : "$".number_format($invoice_array['balance_sched2'], 2)))."
                        </td>
                        <td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($this->current_report['showdetail'] == 2 ?
                            ($k > 0  ?
                                $this->current_report['age3']." Days" : "&nbsp;") : ($invoice_array['balance_sched3'] < 0 ?
                                    "($".number_format($invoice_array['balance_sched3'] * -1, 2).")" : "$".number_format($invoice_array['balance_sched3'], 2)))."
                        </td>
                    </tr>";

                    $k++;

                    if ($this->current_report['showdetail'] == 2) {

                    	reset( $this->invoice_detail[ $vendor_hash ] );
                        while ( list($po_hash, $details) = each($this->invoice_detail[$vendor_hash]) ) {

                            if ($po_hash != 'unassigned')
                                $tbl .= "
                                <tr>
                                    <td colspan=\"".$colspan."\" style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;padding-left:5px;\">
                                        Purchase Order: <a href=\"javascript:void(0);\" onClick=\"agent.call('purchase_order', 'sf_loadcontent', 'show_popup_window', 'edit_po', 'po_hash=".$po_hash."', 'proposal_hash=".$details[0]['proposal_hash']."', 'popup_id=line_item');\" class=\"link_standard\">".$details[0]['po_no']."</a>".($details[0]['po_product'] ? " - ".$details[0]['po_product'] : NULL)."
                                      </td>
                                </tr>";

                            for ($i = 0; $i < count($details); $i++) {

                                $total_balance = bcadd($total_balance, $details[$i]['balance_total'], 2);
                                $total_invoice = bcadd($total_invoice, $details[$i]['total_payable'], 2);

                                $total_current = bcadd($total_current, $details[$i]['balance_current'], 2);
                                $total_sched1 = bcadd($total_sched1, $details[$i]['balance_sched1'], 2);
                                $total_sched2 = bcadd($total_sched2, $details[$i]['balance_sched2'], 2);
                                $total_sched3 = bcadd($total_sched3, $details[$i]['balance_sched3'], 2);

                                $tbl .= "
                                <tr>
                                    <td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\">
                                        ".($details[$i]['type'] != 'I' ?
                                            ($details[$i]['type'] == 'D' ?
                                                "Deposit: " : ($details[$i]['type'] == 'C' ?
                                                    "Credit: " : ($details[$i]['type'] == 'R' ?
                                                        "Refund: " : NULL))) : NULL)."
                                        <a href=\"javascript:void(0);\" onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$details[$i]['invoice_hash']."', 'popup_id=line_item');\" class=\"link_standard\">".$details[$i]['invoice_no']."</a>
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($details[$i]['invoice_date']))."</td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($details[$i]['due_date']))."</td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['total_payable'] < 0 ?
                                        "($".number_format($details[$i]['total_payable'] * -1, 2).")" : "$".number_format($details[$i]['total_payable'], 2))."
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_total'] < 0 ?
                                        "($".number_format($details[$i]['balance_total'] * -1, 2).")" : "$".number_format($details[$i]['balance_total'], 2))."
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_current'] != 0 ?
                                        ($details[$i]['balance_current'] < 0 ?
                                            "($".number_format($details[$i]['balance_current'] * -1, 2).")" : "$".number_format($details[$i]['balance_current'], 2)) : NULL)."
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_sched1'] != 0 ?
                                        ($details[$i]['balance_sched1'] < 0 ?
                                            "($".number_format($details[$i]['balance_sched1'] * -1, 2).")" : "$".number_format($details[$i]['balance_sched1'], 2)) : NULL)."
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_sched2'] != 0 ?
                                        ($details[$i]['balance_sched2'] < 0 ?
                                            "($".number_format($details[$i]['balance_sched2'] * -1, 2).")" : "$".number_format($details[$i]['balance_sched2'], 2)) : NULL)."
                                    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_sched3'] != 0 ?
                                        ($details[$i]['balance_sched3'] < 0 ?
                                            "($".number_format($details[$i]['balance_sched3'] * -1, 2).")" : "$".number_format($details[$i]['balance_sched3'], 2)) : NULL)."
                                    </td>
                                </tr>";
                            }
                        }

                        $grand_total['invoice'] = bcadd($grand_total['invoice'], $total_invoice, 2);
                        $grand_total['balance'] = bcadd($grand_total['balance'], $total_balance, 2);
                        $grand_total['current'] = bcadd($grand_total['current'], $total_current, 2);
                        $grand_total['sched1'] = bcadd($grand_total['sched1'], $total_sched1, 2);
                        $grand_total['sched2'] = bcadd($grand_total['sched2'], $total_sched2, 2);
                        $grand_total['sched3'] = bcadd($grand_total['sched3'], $total_sched3, 2);

                        $tbl .= "
                        <tr>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" ".($this->current_report['showdetail'] == 2 ? "colspan=\"3\"" : NULL)."></td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_invoice < 0 ?
                                    "($".number_format($total_invoice * -1, 2).")" : "$".number_format($total_invoice, 2))."
                                </div>
                            </td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_balance < 0 ?
                                    "($".number_format($total_balance * -1, 2).")" : "$".number_format($total_balance, 2))."
                                </div>
                            </td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">".(bccomp($total_current, 0, 2) != 0 ? "
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_current < 0 ?
                                    "($".number_format($total_current * -1, 2).")" : "$".number_format($total_current, 2))."
                                </div>" : NULL)."
                            </td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">".(bccomp($total_sched1, 0, 2) != 0 ? "
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_sched1 < 0 ?
                                    "($".number_format($total_sched1 * -1, 2).")" : "$".number_format($total_sched1, 2))."
                                </div>" : NULL)."
                            </td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">".(bccomp($total_sched2, 0, 2) != 0 ? "
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_sched2 < 0 ?
                                    "($".number_format($total_sched2 * -1, 2).")" : "$".number_format($total_sched2, 2))."
                                </div>" : NULL)."
                            </td>
                            <td style=\"font-size:8pt;background-color:#ffffff;padding-top:10px;padding-bottom:5px;\" class=\"num_field\">".(bccomp($total_sched3, 0, 2) != 0 ? "
                                <div style=\"position:relative;".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_sched3 < 0 ?
                                    "($".number_format($total_sched3 * -1, 2).")" : "$".number_format($total_sched3, 2))."
                                </div>" : NULL)."
                            </td>
                        </tr>";
                    } else {
                        $grand_total['invoice'] = bcadd($grand_total['invoice'], $invoice_array['total_payable'], 2);
                        $grand_total['balance'] = bcadd($grand_total['balance'], $invoice_array['balance_total'], 2);
                        $grand_total['current'] = bcadd($grand_total['current'], $invoice_array['balance_current'], 2);
                        $grand_total['sched1'] = bcadd($grand_total['sched1'], $invoice_array['balance_sched1'], 2);
                        $grand_total['sched2'] = bcadd($grand_total['sched2'], $invoice_array['balance_sched2'], 2);
                        $grand_total['sched3'] = bcadd($grand_total['sched3'], $invoice_array['balance_sched3'], 2);
                    }
                }
            }
            $grand_total_all = $grand_total['current'] + $grand_total['sched1'] + $grand_total['sched2'] + $grand_total['sched3'];

            $tbl .= "
                    <tr>
                        <td colspan=\"9\" style=\"background-color:#ffffff;padding-top:10px;\">&nbsp;</td>
                    </tr>
                    <tr style=\"background-color:#efefef\">
                        <td style=\"border-top:1px solid #cccccc;font-size:8pt;padding:10px 5px 10px 0\" ".($this->current_report['showdetail'] == 2 ? "colspan=\"3\"" : NULL).">&nbsp;</td>
                        <td style=\"border-top:1px solid #cccccc;font-size:8pt;padding:10px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">
                                $".number_format($grand_total['invoice'], 2)."
                            </div>
                        </td>
                        <td style=\"border-top:1px solid #cccccc;font-size:8pt;padding:10px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">".($grand_total['balance'] < 0 ?
                                "($".number_format($grand_total['balance']*-1).")" : "$".number_format($grand_total['balance'], 2))."
                            </div>
                        </td>
                        <td style=\"border-top:1px solid #cccccc;font-size:8pt;padding:10px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">".($grand_total['current'] < 0 ?
                                "($".number_format($grand_total['current'] * -1, 2).")" : "$".number_format($grand_total['current'], 2))."
                            </div>
                        </td>
                        <td style=\"border-top:1px solid #cccccc;font-size:8pt;padding:10px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">".($grand_total['sched1'] < 0 ?
                                "($".number_format($grand_total['sched1'] * -1, 2).")" : "$".number_format($grand_total['sched1'], 2))."
                            </div>
                        </td>
                        <td style=\"border-top:1px solid #cccccc;font-size:8pt;padding:10px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">".($grand_total['sched2'] < 0 ?
                                "($".number_format($grand_total['sched2'] * -1, 2).")" : "$".number_format($grand_total['sched2'], 2))."
                            </div>
                        </td>
                        <td style=\"border-top:1px solid #cccccc;font-size:8pt;padding:10px 5px 10px 0\" class=\"num_field\">
                            <div style=\"position:relative;border-top:1px dashed #000000;width:95%;padding-top:5px;\">".($grand_total['sched3'] < 0 ?
                                "($".number_format($grand_total['sched3'] * -1, 2).")" : "$".number_format($grand_total['sched3'], 2))."
                            </div>
                        </td>
                    </tr>
            </table>";

            return $tbl;
        } else {
            $report_hash = $this->ajax_vars['report_hash'];
            $this->fetch_report_settings($report_hash);

            array_shift($this->user_name);
            array_shift($this->user_hash);

            $this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
            if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
                unset($report_hash);

            if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
                $this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
			if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
				$this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);


            $tbl = $this->form->form_tag().
            $this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
            <div class=\"panel\">
                <div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
                    <h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
                        <p id=\"feedback_message".$this->popup_id."\"></p>
                </div>
                <table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
                    <tr>
                        <td style=\"padding:0;\">
                             <div style=\"background-color:#ffffff;height:100%;\">
                                <div style=\"margin:15px 35px;\">
                                    <div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
                                        ".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_ap');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
                                            "&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_ap', 'rm=1');") : NULL)."
                                    </div>
                                    <h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
                                        $this->current_report['report_name'] : "Accounts Payable Report")."</h3>
                                    <table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">".
                                                $this->form->select("timeframe", array("All invoice dates", "Invoices dated this year", "Invoices dated last year", "Invoices from the current period", "Invoices from the previous period", "A specific date range"), $this->current_report['timeframe'], array('*', 1, 2, 3, 4, 5), "onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
                                                <div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
                                                    <span id=\"sort_from_date_holder\"></span>
                                                    <span id=\"sort_to_date_holder\"></span>";
                                                $jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
                                                $jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
                                                $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">How should the aging<br />schedule be shown?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=age1", "value=".($this->current_report['age1'] ? $this->current_report['age1'] : ACCOUNT_AGING_SCHED1), "size=3", "style=text-align:right;padding-right:5px;")." days
                                                <br />
                                                ".$this->form->text_box("name=age2", "value=".($this->current_report['age2'] ? $this->current_report['age2'] : ACCOUNT_AGING_SCHED2), "size=3", "style=text-align:right;padding-right:5px;")." days
                                                <br />
                                                ".$this->form->text_box("name=age3", "value=".($this->current_report['age3'] ? $this->current_report['age3'] : ACCOUNT_AGING_SCHED3), "size=3", "style=text-align:right;padding-right:5px;")." days
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=vendor",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
                                                if (is_array($this->current_report['vendor_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
                                                        $tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=proposal",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
												if (is_array($this->current_report['proposal_filter'])) {
													for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++)
														$tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Should the report reflect<br />paid or unpaid invoices?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("invoices_paid",
                                                                       array("Show only invoices with an open balance", "Show only invoices with a zero balance"),
                                                                       $this->current_report['invoices_paid'],
                                                                       array(1, 2))."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Which date should the report<br />use to generate its results?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("report_date",
                                                                      array("Invoice Date", "Due Date", "Receipt Date"),
                                                                      ($this->current_report['report_date'] ? $this->current_report['report_date'] : "vendor_payables.due_date"),
                                                                      array("t1.invoice_date", "t1.due_date", "t1.receipt_date"),
                                                                      "blank=1")."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("showdetail",
                                                                      array("Show Detail View", "Show Simple View"),
                                                                      $this->current_report['showdetail'],
                                                                      array('2', '1'),
                                                                      "blank=1")."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
                                                <div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
                                                    What should the report be called?
                                                    <br />
                                                    ".$this->form->text_box("name=report_name",
                                                                            "value=".$this->current_report['report_name'],
                                                                            "autocomplete=off",
                                                                            "size=30",
                                                                            "style=margin-top:5px;margin-bottom:10px;"
                                                                            )."
                                                    <br />
                                                    Optional description for the report:
                                                    <br />
                                                    ".$this->form->text_area("name=report_descr",
                                                                            "value=".$this->current_report['report_descr'],
                                                                            "rows=3",
                                                                            "cols=50",
                                                                            "style=margin-top:5px;"
                                                                            )."
                                                    <div style=\"padding-top:5px\">
                                                        ".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
                                                        <div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
                                                            Share to the following users:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                            Share to the following groups:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>".
            $this->form->close_form();

            $this->content['popup_controls']["cmdTable"] = $tbl;
            $this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
            $this->content['jscript'] = $jscript;

            return;
        }
    }

	function doit_cash_requirements() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);

			$sched_start_date = $this->current_report['sched_start_date'];
			$vendor_filter = $this->current_report['vendor_filter'];
			$showdetail = $this->current_report['showdetail'];
			$day_schedule = preg_replace('/[^.0-9]/', "", $this->current_report['day_schedule']);
			$showdiscounts = $this->current_report['showdiscounts'];
			if ($vendor_filter && !is_array($vendor_filter))
				$vendor_filter = array($vendor_filter);
		} else {
			$sched_start_date = $_POST['sched_start_date'];
			$vendor_filter = $_POST['vendor_filter'];
			$showdetail = $_POST['showdetail'];
			$day_schedule = preg_replace('/[^.0-9]/', "", $_POST['day_schedule']);
			$showdiscounts = $_POST['showdiscounts'];
		}

		$save = $_POST['save'];
		$saved_cat = "cash_requirements";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($this->content['error'])
			return;

		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter, 'add_quotes', "'");
			$sql_p[] = "vendor_payables.vendor_hash IN (".implode(" , ", $vendor_filter).")";
			array_walk($vendor_filter, 'strip_quotes');
		}
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$str = "sched_start_date=$sched_start_date|showdetail=$showdetail|showdiscounts=$showdiscounts|day_schedule=".$day_schedule."|sort_to_date=$sort_to_date|vendor_filter=".@implode("&", $vendor_filter);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		$sched = $day_schedule;
		for ($i = 1; $i <= 3; $i++) {
			$this->schedule[$i] = strtotime($sched_start_date." +".$sched." days");
			$sched += $day_schedule;
		}
		$result = $this->db->query("SELECT vendor_payables.invoice_hash , vendor_payables.invoice_no , vendor_payables.amount ,
									vendor_payables.balance , vendor_payables.invoice_date , vendor_payables.due_date , vendor_payables.vendor_hash ,
									vendor_payables.type , vendors.vendor_name as vendor_name , vendors.discount_days , vendors.payment_discount ,
									proposals.proposal_no , proposals.proposal_hash ,
								    CASE
								    WHEN ISNULL(vendors.vendor_name)
									  	THEN customers.customer_name
									  	ELSE 0
								   	END AS customer_name
									FROM vendor_payables
									LEFT JOIN customers ON customers.customer_hash = vendor_payables.vendor_hash
									LEFT JOIN vendors ON vendors.vendor_hash = vendor_payables.vendor_hash
									LEFT JOIN purchase_order ON purchase_order.po_hash = vendor_payables.po_hash
									LEFT JOIN proposals ON purchase_order.proposal_hash = proposals.proposal_hash
									WHERE ".($sql ? $sql." AND " : NULL)."vendor_payables.balance > 0 AND vendor_payables.deleted = 0
									GROUP BY vendor_payables.invoice_hash");
		while ($row = $this->db->fetch_assoc($result)) {
			$result_list[$row['vendor_hash']][] = $row;
			$sort_list[$row['vendor_hash']] = ($row['vendor_name'] ? stripslashes($row['vendor_name']) : stripslashes($row['customer_name']));
		}
		//Asending order
		@asort($sort_list);
		if (is_array($sort_list)) {
			while (list($hash, $name) = each($sort_list))
				$results[$hash] =& $result_list[$hash];

		}

		while (list($vendor_hash, $invoice) = each($results)) {
			$pay_schedule = array();
			for ($i = 0; $i < count($invoice); $i++) {
				if ($showdiscounts && $invoice[$i]['discount_days'] && $invoice[$i]['payment_discount']) {
					$due_date = strtotime($invoice[$i]['due_date']." -".$invoice[$i]['discount_days']." days");
					$invoice[$i]['balance'] -= ($invoice[$i]['balance'] * $invoice[$i]['payment_discount']);
				} else
					$due_date = strtotime($invoice[$i]['due_date']);

				if ($due_date < ($this->schedule[1] - ($day_schedule * 86400)))
					$pay_schedule[] = array('invoice'	=> $invoice[$i],
											'sched'		=> 'past');
				elseif ($due_date > $this->schedule[3])
					$pay_schedule[] = array('invoice'	=> $invoice[$i],
											'sched'		=> 'future');
				else {
					for ($j = 1; $j <= 3; $j++) {
						if (date("Y-m-d", $due_date) >= date("Y-m-d", ($this->schedule[$j] - ($day_schedule * 86400))) && date("Y-m-d", $due_date) <= date("Y-m-d", $this->schedule[$j])) {
							$pay_schedule[] = array('invoice'	=> $invoice[$i],
													'sched'		=> $j);
							break 1;
						}
					}
				}
			}
			$this->results[$vendor_hash] = array("vendor_name"		=>		($invoice[0]['vendor_name'] ? stripslashes($invoice[0]['vendor_name']) : stripslashes($invoice[0]['customer_name'])),
												 "pay_schedule"		=>		$pay_schedule);
		}


		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->cash_requirements(1);
		return;
	}

	function cash_requirements($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:1050px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"9\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Cash Requirements Report").($this->p->ck('reports', 'V', 'cash_req') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'cash_requirements', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=cash_requirements', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:150px;text-align:left;padding:5px 5px 5px 25px;\">Proposal No.</td>
					<td style=\"width:150px;text-align:left;padding:5px 5px 5px 25px;\">Invoice No.</td>
					<td style=\"width:125px;padding:5px;\">Invoice Date</td>
					<td style=\"width:125px;padding:5px;\">Due Date</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Past</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y", $this->schedule[1])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y", $this->schedule[2])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y", $this->schedule[3])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Future</td>
				</tr>";

			if (is_array($this->results)) {
				$k = 0;
				while (list($vendor_hash, $invoice_array) = each($this->results)) {
					$tbl_past = $tbl_sched1 = $tbl_sched2 = $tbl_sched3 = $tbl_future = '';
					$total_past = $total_sched1 = $total_sched2 = $total_sched3 = $total_future = 0;
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"9\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">".$invoice_array['vendor_name']."</td>
					</tr>";

					for ($i = 0; $i < count($invoice_array['pay_schedule']); $i++) {
						$invoice_amt = array();
						$is_credit = ($invoice_array['pay_schedule'][$i]['invoice']['type'] == 'C');
						switch ($invoice_array['pay_schedule'][$i]['sched']) {
							case 'past':
							if ($is_credit)
								$total_past -= $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							else
								$total_past += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['past'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;

							case '1':
							if ($is_credit)
								$total_sched1 -= $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							else
								$total_sched1 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched1'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;

							case '2':
							if ($is_credit)
								$total_sched2 -= $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							else
								$total_sched2 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched2'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;

							case '3':
							if ($is_credit)
								$total_sched3 -= $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							else
								$total_sched3 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched3'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;

							case 'future':
							if ($is_credit)
								$total_future -= $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							else
								$total_future += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['future'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
						}
						if ($this->current_report['showdetail'] == 2)
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\">".($invoice_array['pay_schedule'][$i]['invoice']['proposal_hash'] ? "<a href=\"javascript:void(0);\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$invoice_array['pay_schedule'][$i]['invoice']['proposal_hash']."', 'popup_id=proposal_win', 'from_report=1');\" class=\"link_standard\">Proposal ".$invoice_array['pay_schedule'][$i]['invoice']['proposal_no']."</a>" : NULL)."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$invoice_array['pay_schedule'][$i]['invoice']['invoice_hash']."', 'popup_id=line_item');\" class=\"link_standard\">".($invoice_array['pay_schedule'][$i]['invoice']['type'] == 'I' ? "Invoice: " : ($invoice_array['pay_schedule'][$i]['invoice']['type'] == 'D' ? "Vendor Deposit: " : ($invoice_array['pay_schedule'][$i]['invoice']['type'] == 'C' ? "Vendor Credit: " : "Customer Refund: "))).$invoice_array['pay_schedule'][$i]['invoice']['invoice_no']."</a></td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($invoice_array['pay_schedule'][$i]['invoice']['invoice_date']))."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($invoice_array['pay_schedule'][$i]['invoice']['due_date']))."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;".($is_credit ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($invoice_amt['past'] != 0 ?
									($is_credit ?
										"($".number_format($invoice_amt['past'], 2).")" : "$".number_format($invoice_amt['past'], 2)) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;".($is_credit ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($invoice_amt['sched1'] != 0 ?
									($is_credit ?
										"($".number_format($invoice_amt['sched1'], 2).")" : "$".number_format($invoice_amt['sched1'], 2)) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;".($is_credit ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($invoice_amt['sched2'] != 0 ?
									($is_credit ?
										"($".number_format($invoice_amt['sched2'], 2).")" : "$".number_format($invoice_amt['sched2'], 2)) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;".($is_credit ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($invoice_amt['sched3'] != 0 ?
									($is_credit ?
										"($".number_format($invoice_amt['sched3'], 2).")" : "$".number_format($invoice_amt['sched3'], 2)) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;".($is_credit ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($invoice_amt['future'] != 0 ?
									($is_credit ?
										"($".number_format($invoice_amt['future'], 2).")" : "$".number_format($invoice_amt['future'], 2)) : NULL)."
								</td>
							</tr>";
					}
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;\" colspan=\"4\">
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_past != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;".($total_past < 0 ? "color:#ff0000;" : NULL)."\">".
								($total_past < 0 ?
										"($".number_format($total_past * -1, 2).")" : "$".number_format($total_past, 2))."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched1 != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;".($total_sched1 < 0 ? "color:#ff0000;" : NULL)."\">".
								($total_sched1 < 0 ?
										"($".number_format($total_sched1 * -1, 2).")" : "$".number_format($total_sched1, 2))."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched2 != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;".($total_sched2 < 0 ? "color:#ff0000;" : NULL)."\">".
								($total_sched2 < 0 ?
										"($".number_format($total_sched2 * -1, 2).")" : "$".number_format($total_sched2, 2))."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched3 != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;".($total_sched3 < 0 ? "color:#ff0000;" : NULL)."\">".
								($total_sched3 < 0 ?
										"($".number_format($total_sched3 * -1, 2).")" : "$".number_format($total_sched3, 2))."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_future != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;".($total_future < 0 ? "color:#ff0000;" : NULL)."\">".
								($total_future < 0 ?
										"($".number_format($total_future * -1, 2).")" : "$".number_format($total_future, 2))."
							</div>" : NULL)."
						</td>
					</tr>";

					$grand_total['past'] += $total_past;
					$grand_total['sched1'] += $total_sched1;
					$grand_total['sched2'] += $total_sched2;
					$grand_total['sched3'] += $total_sched3;
					$grand_total['future'] += $total_future;
				}
				$tbl .= "
				<tr style=\"background-color:#efefef;\">
					<td colspan=\"4\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">&nbsp;</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['past'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;".($grand_total['past'] < 0 ? "color:#ff0000;" : NULL)."\">".
							($grand_total['past'] < 0 ?
								"($".number_format($grand_total['past'] * -1, 2).")" : "$".number_format($grand_total['past'], 2))."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;".($grand_total['sched1'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($grand_total['sched1'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">".
							($grand_total['sched1'] < 0 ?
								"($".number_format($grand_total['sched1'] * -1, 2).")" : "$".number_format($grand_total['sched1'], 2))."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;".($grand_total['sched2'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($grand_total['sched2'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">".
							($grand_total['sched2'] < 0 ?
								"($".number_format($grand_total['sched2'] * -1, 2).")" : "$".number_format($grand_total['sched2'], 2))."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;".($grand_total['sched3'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($grand_total['sched3'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">".
							($grand_total['sched3'] < 0 ?
								"($".number_format($grand_total['sched3'] * -1, 2).")" : "$".number_format($grand_total['sched3'], 2))."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;".($grand_total['future'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($grand_total['future'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">".
							($grand_total['future'] < 0 ?
								"($".number_format($grand_total['future'] * -1, 2).")" : "$".number_format($grand_total['future'], 2))."
						</div>" : "&nbsp;")."
					</td>
				</tr>";

			} else
				$tbl .= "
				<tr>
					<td colspan=\"9\" style=\"\">Your report returned an empty result.</td>
				</tr>";

			$tbl .= "
			</table>";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);

			for ($i = 1; $i <= 30; $i++)
				$gen_array[] = $i." day".($i > 1 ? "s" : NULL);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_cash_requirements');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_cash_requirements', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Cash Requirements Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">When should the report<br />start tracking cash requirements?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\" id=\"sched_start_date_holder\">";
												$jscript[] = "setTimeout('DateInput(\'sched_start_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['sched_start_date'] ? $this->current_report['sched_start_date'] : date("Y-m-d"))."\', 1, \'sched_start_date_holder\')', 500);";
												$tbl .= "
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">How should the payment<br />schedule be broken down?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("day_schedule", $gen_array, ($this->current_report['day_schedule'] ? $this->current_report['day_schedule'] : '15 days'), $gen_array, "blank=1")."
												<div style=\"margin-top:10px;\">
													".$this->form->checkbox("name=showdiscounts", "value=1", ($this->current_report['showdiscounts'] ? "checked" : NULL))."
													&nbsp;
													Show opportunities to take discounts?
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail", array("Show Detail View", "Show Simple View"), $this->current_report['showdetail'], array('2', '1'), "blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_cash_flow_exp() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);
			$sched_start_date = $this->current_report['sched_start_date'];
			$showdetail = $this->current_report['showdetail'];
			$day_schedule = $this->current_report['day_schedule'];

			$customer_filter = $this->current_report['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);

			$showdetail = $this->current_report['showdetail'];

		} else {
			$sched_start_date = $_POST['sched_start_date'];
			$customer_filter = $_POST['customer_vendor_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);

			$showdetail = $_POST['showdetail'];
			$day_schedule = preg_replace('/[^.0-9]/', "", $_POST['day_schedule']);

			$report_hash = $_POST['report_hash'];
			$save = $_POST['save'];
			$saved_cat = "cash_flow_exp";
			$report_name = $_POST['report_name'];
			$report_descr = $_POST['report_descr'];
			$share = $_POST['share'];
			$sales_rep_share = $_POST['sales_rep_share'];
			$group_share = $_POST['group_share'];

		}
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($this->content['error'])
			return;

		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter, 'add_quotes', "'");
			$sql_p[] = "customer_invoice.customer_hash IN (".implode(" , ", $customer_filter).")";
			array_walk($customer_filter, 'strip_quotes');
		}
		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$str = "sched_start_date=$sched_start_date|showdetail=$showdetail|day_schedule=".$day_schedule."|customer_filter=".@implode("&", $customer_filter);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		$sched = $day_schedule;
		for ($i = 1; $i <= 3; $i++) {
			$this->schedule[$i] = strtotime($sched_start_date." +".$sched." days");
			$sched += $day_schedule;
		}

		$result = $this->db->query("SELECT customer_invoice.invoice_hash , customer_invoice.invoice_no , customer_invoice.amount ,
									customer_invoice.balance , customer_invoice.invoice_date , customer_invoice.customer_hash , customer_invoice.customer_hash AS parent_customer_hash ,
									(
										SELECT AVG(DATEDIFF(customer_payment.receipt_date , customer_invoice.invoice_date))
										FROM `customer_invoice`
										LEFT JOIN `customer_payment` ON customer_payment.invoice_hash = customer_invoice.invoice_hash AND customer_payment.deleted = 0
										WHERE customer_invoice.customer_hash = parent_customer_hash AND customer_invoice.type = 'I' AND customer_invoice.deleted = 0 AND !ISNULL(customer_payment.receipt_date)
									) AS avg_pay_days ,
									(
										SELECT COUNT(customer_payment.receipt_date)
										FROM `customer_invoice`
										LEFT JOIN customer_payment ON customer_payment.invoice_hash = customer_invoice.invoice_hash AND customer_payment.deleted = 0
										WHERE customer_invoice.customer_hash = parent_customer_hash AND customer_invoice.type = 'I' AND customer_invoice.deleted = 0 AND !ISNULL(customer_payment.receipt_date)
									) AS num_payments ,
									customers.payment_terms , customers.customer_name ,
								    CASE
								    WHEN ISNULL(customers.customer_name)
									  	THEN vendors.vendor_name
									  	ELSE 0
								   	END AS vendor_name
									FROM customer_invoice
									LEFT JOIN customers ON customers.customer_hash = customer_invoice.customer_hash
									LEFT JOIN vendors ON vendors.vendor_hash = customer_invoice.customer_hash
									WHERE ".($sql ?
										$sql." AND " : NULL).
									"customer_invoice.type = 'I' AND customer_invoice.balance > 0 AND customer_invoice.deleted = 0
									GROUP BY customer_invoice.invoice_hash");

		while ($row = $this->db->fetch_assoc($result)) {
			$result_list[$row['customer_hash']][] = $row;
			$sort_list[$row['customer_hash']] = ($row['customer_name'] ? stripslashes($row['customer_name']) : stripslashes($row['vendor_name']));
		}
		//Asending order
		@asort($sort_list);
		if (is_array($sort_list)) {
			while (list($hash, $name) = each($sort_list))
				$results[$hash] =& $result_list[$hash];

		}

		while (list($customer_hash, $invoice) = each($results)) {
			$pay_schedule = array();
			for ($i = 0; $i < count($invoice); $i++) {
				$due_date = ((is_numeric($invoice[$i]['payment_terms']) && $invoice[$i]['payment_terms'] == 0) || (!is_numeric($invoice[$i]['payment_terms']) && DEFAULT_CUST_PAY_TERMS == 0) ? " Upon Receipt" : date(DATE_FORMAT, strtotime($invoice[$i]['invoice_date']." +".(is_numeric($invoice[$i]['payment_terms']) ? $invoice[$i]['payment_terms'] : DEFAULT_CUST_PAY_TERMS)." days")));
				$exp_date = strtotime($invoice[$i]['invoice_date']." +".($invoice[$i]['num_payments'] >= 15 && $invoice[$i]['avg_pay_days'] > 0 ? ceil($invoice[$i]['avg_pay_days']) : (is_numeric($invoice[$i]['payment_terms']) ? $invoice[$i]['payment_terms'] : DEFAULT_CUST_PAY_TERMS))." days");
				$invoice[$i]['exp_date'] = $exp_date;
				$invoice[$i]['due_date'] = $due_date;
				if ($exp_date < ($this->schedule[1] - ($day_schedule * 86400)))
					$pay_schedule[] = array('invoice'	=> $invoice[$i],
											'sched'		=> 'past');
				elseif ($exp_date > $this->schedule[3])
					$pay_schedule[] = array('invoice'	=> $invoice[$i],
											'sched'		=> 'future');
				else {
					for ($j = 1; $j <= 3; $j++) {
						if (date("Y-m-d", $exp_date) >= date("Y-m-d", ($this->schedule[$j] - ($day_schedule * 86400))) && date("Y-m-d", $exp_date) <= date("Y-m-d", $this->schedule[$j])) {
							$pay_schedule[] = array('invoice'	=> $invoice[$i],
													'sched'		=> $j);
							break 1;
						}
					}
				}
			}
			$this->results[$customer_hash] = array("customer_name"	=>		($invoice[0]['customer_name'] ? stripslashes($invoice[0]['customer_name']) : stripslashes($invoice[0]['vendor_name'])),
												 "pay_schedule"		=>		$pay_schedule);
		}


		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';

		$this->total = count($this->results);
		if (!$doit_print)
			$this->content['html']['place_holder'] = $this->cash_flow_exp(1);
		return;
	}

	function cash_flow_exp($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"9\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Cash Flow Expectations Report").($this->p->ck('reports', 'V', 'cash_flow_exp') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'cash_flow_exp', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=cash_flow_exp', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:125px;text-align:left;padding:5px 5px 5px 25px;\">Invoice No.</td>
					<td style=\"width:91px;padding:5px;\">Invoice Date</td>
					<td style=\"width:91px;padding:5px;\">Due Date</td>
					<td style=\"width:91px;padding:5px;\">Expected</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Past</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y", $this->schedule[1])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y", $this->schedule[2])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y", $this->schedule[3])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Future</td>
				</tr>";

			if (is_array($this->results)) {
				$k = 0;
				while (list($customer_hash, $invoice_array) = each($this->results)) {
					$tbl_past = $tbl_sched1 = $tbl_sched2 = $tbl_sched3 = $tbl_future = '';
					$total_past = $total_sched1 = $total_sched2 = $total_sched3 = $total_future = 0;
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"9\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">".stripslashes($invoice_array['customer_name'])."</td>
					</tr>";

					for ($i = 0; $i < count($invoice_array['pay_schedule']); $i++) {
						$invoice_amt = array();
						switch ($invoice_array['pay_schedule'][$i]['sched']) {
							case 'past':
							$total_past += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['past'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;

							case '1':
							$total_sched1 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched1'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;

							case '2':
							$total_sched2 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched2'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;

							case '3':
							$total_sched3 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched3'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;

							case 'future':
							$total_future += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['future'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
						}
						if ($this->current_report['showdetail'] == 2)
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$invoice_array['pay_schedule'][$i]['invoice']['invoice_hash']."', 'popup_id=line_item');\" class=\"link_standard\">".$invoice_array['pay_schedule'][$i]['invoice']['invoice_no']."</a></td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($invoice_array['pay_schedule'][$i]['invoice']['invoice_date']))."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".$invoice_array['pay_schedule'][$i]['invoice']['due_date']."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, $invoice_array['pay_schedule'][$i]['invoice']['exp_date'])."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['past'] != 0 ?
									"$".number_format($invoice_amt['past'], 2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['sched1'] != 0 ?
									"$".number_format($invoice_amt['sched1'], 2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['sched2'] != 0 ?
									"$".number_format($invoice_amt['sched2'], 2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['sched3'] != 0 ?
									"$".number_format($invoice_amt['sched3'], 2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['future'] != 0 ?
									"$".number_format($invoice_amt['future'], 2) : NULL)."
								</td>
							</tr>";
					}
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;\" colspan=\"4\">
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_past != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_past, 2)."

							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched1 != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sched1, 2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched2 != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sched2, 2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched3 != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sched3, 2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_future != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_future, 2)."
							</div>" : NULL)."
						</td>
					</tr>";

					$grand_total['past'] += $total_past;
					$grand_total['sched1'] += $total_sched1;
					$grand_total['sched2'] += $total_sched2;
					$grand_total['sched3'] += $total_sched3;
					$grand_total['future'] += $total_future;
				}
				$tbl .= "
				<tr style=\"background-color:#efefef;\">
					<td colspan=\"4\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">&nbsp;</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['past'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['past'], 2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sched1'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sched1'], 2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sched2'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sched2'], 2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sched3'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sched3'], 2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['future'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['future'], 2)."
						</div>" : "&nbsp;")."
					</td>
				</tr>";

			} else
				$tbl .= "
				<tr>
					<td colspan=\"9\" style=\"background-color:#ffffff;\">Your report returned an empty result.</td>
				</tr>";

			$tbl .= "
			</table>";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
				$this->current_report['customer_filter'] = array($this->current_report['customer_filter']);

			for ($i = 1; $i <= 30; $i++)
				$gen_array[] = $i." day".($i > 1 ? "s" : NULL);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_cash_flow_exp');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_cash_flow_exp', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Cash Flow Expectations Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer_vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
														$tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">When should the report<br />start tracking cash expectations?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\" id=\"sched_start_date_holder\">";
												$jscript[] = "setTimeout('DateInput(\'sched_start_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['sched_start_date'] ? $this->current_report['sched_start_date'] : date("Y-m-d"))."\', 1, \'sched_start_date_holder\')', 500);";
												$tbl .= "
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">How should the expectation<br />schedule be broken down?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("day_schedule", $gen_array, ($this->current_report['day_schedule'] ? $this->current_report['day_schedule'] : '15 days'), $gen_array, "blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail", array("Show Detail View", "Show Simple View"), $this->current_report['showdetail'], array('2', '1'), "blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}

	function doit_product_sales_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");

		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE reports.* , reports_share.*
							  FROM `reports`
							  LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
							  WHERE reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && ($doit_print || $from_saved)) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$sort_from_date = $this->current_report['sort_from_date'];
			$sort_to_date = $this->current_report['sort_to_date'];
			$customer_filter = $this->current_report['customer_filter'];
			$customer_vendor_filter = $this->current_report['customer_vendor_filter'];
			$vendor_filter = $this->current_report['vendor_filter'];
			$showdetail = $this->current_report['showdetail'];
			$product_match = $this->current_report['product_match'];
			$sales_rep_match = $this->current_report['sales_rep_match'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
			if ($customer_vendor_filter && !is_array($customer_vendor_filter))
				$customer_vendor_filter = array($customer_vendor_filter);
			if ($vendor_filter && !is_array($vendor_filter))
				$vendor_filter = array($vendor_filter);
			if ($product_match && !is_array($product_match))
				$product_match = array($product_match);
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);

		} else {
			$timeframe = $_POST['timeframe'];
			$sort_from_date = $_POST['sort_from_date'];
			$sort_to_date = $_POST['sort_to_date'];
			$customer_filter = $_POST['customer_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);
			$customer_vendor_filter = $_POST['customer_vendor_filter'];
            if ($customer_vendor_filter && !is_array($customer_vendor_filter))
                $customer_vendor_filter = array($customer_vendor_filter);
			$vendor_filter = $_POST['vendor_filter'];
            if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);
			$showdetail = $_POST['showdetail'];
			$product_match = $_POST['product_match'];
            if ($product_match && !is_array($product_match))
                $product_match = array($product_match);
			$sales_rep_match = $_POST['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);
		}
		if (is_array($customer_vendor_filter)) {
			if (is_array($customer_filter))
				$customer_filter = array_combine($customer_filter, $customer_vendor_filter);
			else
				$customer_filter = $customer_vendor_filter;

			$customer_filter = array_values($customer_filter);
		}

		if ($sales_rep_match && $sales_rep_match[0] == '')
			unset($sales_rep_match);


		$save = $_POST['save'];
		$saved_cat = "cash_flow_exp";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($this->content['error'])
			return;

		switch ($timeframe) {
			//This year
			case 1:
			$this->report_title = "Year To Date ".date(DATE_FORMAT, strtotime(date("Y-m-d")));
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
			break;

			//last year
			case 2:
			$this->report_title = "Year Ending ".date("Y", strtotime(date("Y-m-d")." -1 year"));
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
			break;

			//current period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//previous period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT, strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT, strtotime($period_info['period_end']));
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			case 5:
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = "customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = date(DATE_FORMAT, strtotime($sort_from_date))." thru ".date(DATE_FORMAT, strtotime($sort_to_date));
			} else {
				$sql_p[] = "customer_invoice.invoice_date >= '".$sort_from_date."'";
				$sub_sql_p[] = "customer_invoice.invoice_date >= '".$sort_from_date."'";
				$this->report_title = "From ".date(DATE_FORMAT, strtotime($sort_from_date))." To Present";
			}
			break;

			//This Month
			case 6:
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT, strtotime(date("Y-m-t")));
			break;

			//Last Month
			case 7:
			$sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01", strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))."'";
			$sub_sql_p[] = "customer_invoice.invoice_date BETWEEN '".date("Y-m-01", strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT, strtotime(date("Y-m-t", strtotime(date("Y-m-d")." -1 month"))));
			break;

			default:
			$this->report_title = "To Date";
			break;
		}

		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter, 'add_quotes', "'");
			$sql_p[] = "customer_invoice.customer_hash IN (".implode(" , ", $customer_filter).")";
			array_walk($customer_filter, 'strip_quotes');
		}
		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter, 'add_quotes', "'");
			$sql_p[] = "line_items.vendor_hash IN (".implode(" , ", $vendor_filter).")";
			array_walk($vendor_filter, 'strip_quotes');
		}
		if (is_array($product_match) && count($product_match)) {
			$product_match = array_unique($product_match);
			$product_match = array_values($product_match);
			array_walk($product_match, 'add_quotes', "'");
			$sql_p[] = "line_items.product_hash IN (".implode(" , ", $product_match).")";
			array_walk($product_match, 'strip_quotes');
		}
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			$sales_rep_match = array_unique($sales_rep_match);
			$sales_rep_match = array_values($sales_rep_match);
			array_walk($sales_rep_match, 'add_quotes', "'");
			$sql_p[] = "proposals.sales_hash IN (".implode(" , ", $sales_rep_match).")";
			array_walk($sales_rep_match, 'strip_quotes');
		}

		if ($sql_p)
			$sql = implode(" AND ", $sql_p);

		$str = "timeframe=$timeframe|showdetail=$showdetail|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|customer_filter=".@implode("&", $customer_filter)."|vendor_filter=".@implode("&", $vendor_filter)."|product_match=".@implode("&", $product_match)."|sales_rep_match=".@implode("&", $sales_rep_match);

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
			while (global_classes::key_exists('reports', 'report_hash', $report_hash))
				$report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

			$this->db->query("INSERT INTO `reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");

				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}
		} elseif (!$from_saved) {
			$existing = true;
			$this->db->query("UPDATE `reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
							  WHERE `report_hash` = '$report_hash'");

			if (!$share)
				$this->db->query("DELETE FROM `reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();

				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];

				if (!is_array($current_share_users))
					$current_share_users = array();

				$to_remove = array_diff($current_share_users, $sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share, $current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];

				if (!is_array($current_share_groups))
					$current_share_groups = array();

				$to_remove = array_diff($current_share_groups, $group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share, $current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		$sched = $day_schedule;
		for ($i = 1; $i <= 3; $i++) {
			$this->schedule[$i] = strtotime($sched_start_date." +".$sched." days");
			$sched += $day_schedule;
		}
		$result = $this->db->query("SELECT vendor_products.product_hash , vendor_products.product_name , customer_invoice.invoice_hash , customer_invoice.invoice_no , customer_invoice.invoice_date , customer_invoice.customer_hash ,
									customers.customer_name , proposals.proposal_descr , line_items.ext_sell , line_items.ext_cost , line_items.qty ,
									FORMAT(((line_items.ext_sell - line_items.ext_cost) / line_items.ext_sell) * 100 , 2) AS gp_margin ,
									CASE
									WHEN ISNULL(customers.customer_name)
									THEN vendors.vendor_name
									ELSE 0
									END AS vendor_name
									FROM customer_invoice
									LEFT JOIN customers ON customers.customer_hash = customer_invoice.customer_hash
									LEFT JOIN vendors ON vendors.vendor_hash = customer_invoice.customer_hash
									LEFT JOIN proposals ON proposals.proposal_hash = customer_invoice.proposal_hash
									LEFT JOIN (SELECT invoice_hash , product_hash , qty , vendor_hash ,
									           SUM(sell * qty) AS ext_sell , SUM(cost * qty) AS ext_cost
									           FROM line_items
									           GROUP BY product_hash , invoice_hash) AS line_items ON line_items.invoice_hash = customer_invoice.invoice_hash
									LEFT JOIN vendor_products ON vendor_products.product_hash = line_items.product_hash
									WHERE ".($sql ?
										$sql." AND " : NULL).
									"customer_invoice.type = 'I' AND customer_invoice.amount > 0 AND customer_invoice.deleted = 0
									ORDER BY customer_invoice.invoice_date , customer_invoice.invoice_no ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			if ($row['product_hash']) {
				$result_list[$row['product_hash']][] = $row;
				$sort_list[$row['product_hash']] = stripslashes($row['product_name']);
			}
		}
		//Asending order
		@asort($sort_list);
		if (is_array($sort_list)) {
			while (list($hash, $name) = each($sort_list))
				$this->results[$hash] =& $result_list[$hash];

		}

		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->product_sales_report(1);
		return;
	}

	function product_sales_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"8\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ?
								$this->current_report['report_name'] : "Product Sales Report").($this->p->ck('reports', 'V', 'product_sales') ? "
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'product_sales_report', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>" : NULL)."
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:100px;text-align:left;padding:5px 5px 5px 25px;\">Invoice Date</td>
					<td style=\"width:100px;padding:5px;\">Invoice No.</td>
					<td style=\"width:240px;padding:5px;\">Customer</td>
					<td style=\"width:240px;padding:5px;\">Description</td>
					<td style=\"width:60px;padding:5px;\" class=\"num_field\">Qty</td>
					<td style=\"width:125px;padding:5px;\" class=\"num_field\">Ext Cost</td>
					<td style=\"width:125px;padding:5px;\" class=\"num_field\">Ext Sell</td>
					<td style=\"width:35px;padding:5px;\" class=\"num_field\">".($this->current_report['showdetail'] == 2 ? "GP" : "&nbsp;")."</td>
				</tr>";

			if (is_array($this->results)) {
				$k = 0;
				while (list($product_hash, $invoice_array) = each($this->results)) {
					$total_qty = $total_cost = $total_sell = 0;
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"8\" style=\"font-weight:bold;font-size:8pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">".$invoice_array[0]['product_name']."</td>
					</tr>";

					for ($i = 0; $i < count($invoice_array); $i++) {
						if ($this->current_report['showdetail'] == 2)
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\">".date(DATE_FORMAT, strtotime($invoice_array[$i]['invoice_date']))."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$invoice_array[$i]['invoice_hash']."', 'popup_id=line_item');\" class=\"link_standard\">".$invoice_array[$i]['invoice_no']."</a></td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".($invoice_array[$i]['customer_name'] ?
									(strlen($invoice_array[$i]['customer_name']) > 40 ?
										stripslashes(substr($invoice_array[$i]['customer_name'], 0, 37))."..." : stripslashes($invoice_array[$i]['customer_name'])) : (strlen($invoice_array[$i]['vendor_name']) > 40 ?
											stripslashes(substr($invoice_array[$i]['vendor_name'], 0, 37))."..." : stripslashes($invoice_array[$i]['vendor_name'])))."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".(strlen($invoice_array[$i]['proposal_descr']) > 40 ?
									stripslashes(substr($invoice_array[$i]['proposal_descr'], 0, 37))."..." : stripslashes($invoice_array[$i]['proposal_descr']))."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".$invoice_array[$i]['qty']."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['ext_cost'], 2)."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['ext_sell'], 2)."</td>
								<td nowrap style=\"background-color:#ffffff;font-size:8pt;".(defined('MARGIN_FLAG') && $invoice_array[$i]['gp_margin']*.01 < MARGIN_FLAG ? "color:red;" : NULL)."\" class=\"num_field\">".
									($invoice_array[$i] < 0 ? "(".(round($invoice_array[$i]['gp_margin'], 4) * -1).")" : round($invoice_array[$i]['gp_margin'], 4))."%
								</td>
							</tr>";

						$total_qty += $invoice_array[$i]['qty'];
						$total_cost += $invoice_array[$i]['ext_cost'];
						$total_sell += $invoice_array[$i]['ext_sell'];

					}

					$total_gp = math::gp_margin( array(
						'cost'	=>	$total_cost,
						'sell'	=>	$total_sell
					) );

					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"3\" style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\">Total for ".$invoice_array[0]['product_name']."</td>
						<td colspan=\"2\" style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;\" class=\"num_field\">".($total_qty != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:40%;padding-top:5px;\">
								".number_format($total_qty, 2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;\" class=\"num_field\">".($total_cost != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_cost, 2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;\" class=\"num_field\">".($total_sell != 0 ?
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sell, 2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;\" class=\"num_field\">
							<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;".($total_gp < MARGIN_FLAG ? "color:red;" : NULL)."\">
								".($total_gp < 0 ? "(".($total_gp * -100).")" : $total_gp * 100)."%
							</div>
						</td>
					</tr>";

					$grand_total['qty'] += $total_qty;
					$grand_total['cost'] += $total_cost;
					$grand_total['sell'] += $total_sell;
				}

				$grand_total['gp'] = math::gp_margin( array(
					'cost'	=>	$grand_total['cost'],
					'sell'	=>	$grand_total['sell']
				) );

				$tbl .= "
				<tr style=\"background-color:#efefef;\">
					<td colspan=\"3\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">&nbsp;</td>
					<td colspan=\"2\" style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['qty'] != 0 ?
						"<div style=\"width:40%;padding-top:10px;\">
							".number_format($grand_total['qty'], 2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['cost'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['cost'], 2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sell'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sell'], 2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['gp'] != 0 ?
						"<div style=\"width:90%;padding-top:10px;".($grand_total['gp'] < MARGIN_FLAG ? "color:red;" : NULL)."\">
							".($grand_total['gp'] < 0 ? "(".($grand_total['gp'] * -100).")" : $grand_total['gp'] * 100)."%
						</div>" : "&nbsp;")."
					</td>
				</tr>";

			} else
				$tbl .= "
				<tr>
					<td colspan=\"8\" style=\"background-color:#ffffff;\">Your report returned an empty result.</td>
				</tr>";

			$tbl .= "
			</table>";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
				unset($report_hash);

			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
				$this->current_report['customer_filter'] = array($this->current_report['customer_filter']);
			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
			if ($this->current_report['product_match'] && !is_array($this->current_report['product_match']))
				$this->current_report['product_match'] = array($this->current_report['product_match']);

			$result = $this->db->query("SELECT vendor_products.product_name , vendor_products.product_hash , vendors.vendor_hash , vendors.vendor_name
										FROM `vendor_products`
										LEFT JOIN `vendors` ON vendors.vendor_hash = vendor_products.vendor_hash
										ORDER BY vendors.vendor_name , vendor_products.product_name");
			while ($row = $this->db->fetch_assoc($result)) {
				$vendor[($row['vendor_hash'] ? $row['vendor_hash'] : "DEFAULT")] = ($row['vendor_name'] ? $row['vendor_name'] : MY_COMPANY_NAME);
				$products[($row['vendor_hash'] ? $row['vendor_hash'] : "DEFAULT")][] = array("name" =>	stripslashes($row['product_name']),
																						     "hash" =>	$row['product_hash']);
			}
			while (list($vendor_hash, $product_array) = each($products)) {
				$select .= "
				<optgroup label=\"".$vendor[$vendor_hash]."\">";
				for ($i = 0; $i < count($product_array); $i++)
					$select .= "
					<option value=\"".$product_array[$i]['hash']."\" ".(@in_array($product_array[$i]['hash'], $this->current_report['product_match']) ? "selected=\"selected\"" : NULL).">".$product_array[$i]['name']."</option>";
				$select .= "
				</optgroup>";
			}
			$product_select = "
			<select name=\"product_match[]\" class=\"txtSearch\" size=\"6\" style=\"width:400px;\" multiple>
				".$select."
			</select>";

			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
                $this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);

			for ($i = 1; $i <= 30; $i++)
				$gen_array[] = $i." day".($i > 1 ? "s" : NULL);

			$tbl = $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_product_sales_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_product_sales_report', 'rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
										$this->current_report['report_name'] : "Product Sales Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe", array("All dates", "Invoiced sales dated this year", "Invoiced sales dated last year", "Invoiced sales from the current period", "Invoiced sales from the previous period", "Invoiced sales dated this month", "Invoiced sales dated last month", "A specific date range"), $this->current_report['timeframe'], array('*', 1, 2, 3, 4, 6, 7, 5), "onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
												$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to show sales for specific customers?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer_vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
														$tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to show products/services for specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
																		"onBlur=key_clear();"
																		)."

												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to show only specific products and services?</td>
											<td style=\"background-color:#ffffff;\">".$product_select."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]", $this->sales_name, (is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')), $this->sales_hash, "multiple", "blank=1", "size=4", "style=width:200px;", ($this->p->ck('proposals', 'S') ? "disabled" : NULL))."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail", array("Show Detail View", "Show Simple View"), $this->current_report['showdetail'], array('2', '1'), "blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">
														".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;

			return;
		}
	}


	function navigator() {
		$this->unlock("_");

		$this->fetch_custom_reports();
		$this->fetch_shared_reports();

		if ($this->p->ck(get_class($this), 'V', 'ar') || $this->p->ck(get_class($this), 'V', 'ar_reconcile') || $this->p->ck(get_class($this), 'V', 'cash_receipts') || $this->p->ck(get_class($this), 'V', 'cash_flow_exp') || $this->p->ck(get_class($this), 'V', 'customer_balance'))
			$ar = true;
		if ($this->p->ck(get_class($this), 'V', 'ap') || $this->p->ck(get_class($this), 'V', 'cash_req') || $this->p->ck(get_class($this), 'V', 'cash_disp') || $this->p->ck(get_class($this), 'V', 'vendor_balance') || $this->p->ck(get_class($this), 'V', 'sales_tax') || $this->p->ck(get_class($this), 'V', 'po') || $this->p->ck(get_class($this), 'V', 'vendor_discounting') || $this->p->ck(get_class($this), 'V', 'wip_reconcile') || $this->p->ck(get_class($this), 'V', '1099'))
			$ap = true;
		if ($this->p->ck(get_class($this), 'V', 'commissions') || $this->p->ck(get_class($this), 'V', 'work_order') || $this->p->ck(get_class($this), 'V', 'job_costing') || $this->p->ck(get_class($this), 'V', 'product_sales') || $this->p->ck(get_class($this), 'V', 'bookings') || $this->p->ck(get_class($this), 'V', 'invoiced_sales') || $this->p->ck(get_class($this), 'V', 'backlog'))
			$proposals = true;
		if ($this->p->ck(get_class($this), 'V', 'check_reconcile') || $this->p->ck(get_class($this), 'V', 'check_reg') || $this->p->ck(get_class($this), 'V', 'cash_flow') || $this->p->ck(get_class($this), 'V', 'trial_balance') || $this->p->ck(get_class($this), 'V', 'income_stmtm') || $this->p->ck(get_class($this), 'V', 'balance_sheet'))
			$finance = true;

		$tbl .= $this->form->form_tag().
		$this->form->hidden(array('test' => 1))."
		<div id=\"feedback_holder\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
			<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
				<p id=\"feedback_message\"></p>
		</div>
		<table cellspacing=\"1\" cellpadding=\"5\" class=\"main_tab_table\">
			<tr>
				<td style=\"padding:0;\">
					 <div style=\"background-color:#ffffff;height:100%;\">
					 	<div style=\"margin:15px 35px;\">
							<h3 style=\"margin-bottom:15px;color:#00477f;\">Reports Navigator</h3>
							<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:700px;margin-top:0;\" class=\"smallfont\">".($ar ? "
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">Customers & Receivables Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">".($this->p->ck(get_class($this), 'V', 'ar') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'ar_report', 'popup_id=report_filter');\">Accounts Receivable Report</a>
											<div style=\"padding-top:5px;\">
												Report showing the current and aged accounts receivables owed by customers.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'ar_reconcile') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'ar_reconcile', 'popup_id=report_filter');\">Accounts Receivable Reconciliation Report</a>
											<div style=\"padding-top:5px;\">
												Reconcile outstanding receivables to a clearing account, a doubtful allowance account, or another account of your choosing.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'cash_receipts') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'cash_receipts', 'popup_id=report_filter');\">Cash Receipts</a>
											<div style=\"padding-top:5px;\">
												This report shows the receipts received from your customers and itemizes those receipts against their respective invoices.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'cash_flow_exp') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'cash_flow_exp', 'popup_id=report_filter');\">Cash Flow Expectations Report</a>
											<div style=\"padding-top:5px;\">
												This report calculates your expected cash flow based on factors such as your customers average days to pay. This report will identify your anticipated receipts down to the day.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'customer_balance') ? "
										<div >
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'customer_balance', 'popup_id=report_filter');\">Customer Balance Summary</a>
											<div style=\"padding-top:5px;\">
												This report shows the current balance of each of your customers. The report can be expanded to show balance
												trends for a given customer.
											</div>
										</div>" : NULL)."
									</td>
								</tr>" : NULL).($ap ? "
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">Vendors & Payables Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">".($this->p->ck(get_class($this), 'V', 'ap') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'ap_report', 'popup_id=report_filter');\">Accounts Payable Report</a>
											<div style=\"padding-top:5px;\">
												This report shows the current and aged accounts payables owed to vendors.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'cash_req') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'cash_requirements', 'popup_id=report_filter');\">Cash Requirements Report</a>
											<div style=\"padding-top:5px;\">
												This report shows the cash requirements needed to pay outstanding bills and refunds.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'cash_disp') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'cash_disp', 'popup_id=report_filter');\">Cash Disbursements Report</a>
											<div style=\"padding-top:5px;\">
												This report shows the cash disbursed on a specific date or period of time when invoices are paid or deposits are issued.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'vendor_balance') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'vendor_balance', 'popup_id=report_filter');\">Vendor Balance Summary</a>
											<div style=\"padding-top:5px;\">
												This report shows the current balance of each of your vendors. The report can be expanded to show balance
												trends for a given vendor.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'sales_tax') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'sales_tax', 'popup_id=report_filter');\">Sales Tax Liability Report</a>
											<div style=\"padding-top:5px;\">
												This report shows the sales tax liability owed for each of the areas you collect sales tax.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'po') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'po_report', 'popup_id=report_filter');\">Purchase Order Report</a>
											<div style=\"padding-top:5px;\">
												This report shows purchase orders that were issued on a specific date or date range.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'vendor_discounting') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'vendor_discounting', 'popup_id=report_filter');\">Vendor Discounting</a>
											<div style=\"padding-top:5px;\">
												This report shows all vendors and their respective discounts, along with discount IDs, effective and expiration dates, and product discounting tiers.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'wip_reconcile') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'wip_reconcile', 'popup_id=report_filter');\">WIP Reconciliation</a>
											<div style=\"padding-top:5px;\">
												This report reconciles outstanding Work In Progress against its payables, allowing you to balance any outstanding WIP that may exist against a specific payable.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'wip_reconcile') ? "
                                        <div style=\"padding-bottom:10px;\">
                                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'wip_report', 'popup_id=report_filter');\">WIP Detail Report</a>
                                            <div style=\"padding-top:5px;\">
                                                This report details wip transactions and balances by project, purchase order and line item.
                                            </div>
                                        </div>" : NULL).($this->p->ck(get_class($this), 'V', '1099') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'vendor_1099', 'popup_id=report_filter');\">Vendor 1099 Report</a>
											<div style=\"padding-top:5px;\">
												This report identifies payments you have made to your 1099 vendors.
											</div>
										</div>" : NULL)."
									</td>
								</tr>" : NULL).($proposals ? "
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">Proposals & Sales Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">".($this->p->ck(get_class($this), 'V', 'project_status') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'status_report', 'popup_id=report_filter');\">Project Status Report</a>
											<div style=\"padding-top:5px;\">
												This report tracks all proposals once they have been booked. It contains shipping &amp; delivery information and allows you to record acknowledgment information.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'backlog') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'backlog_report', 'popup_id=report_filter');\">Backlog Report</a>
											<div style=\"padding-top:5px;\">
												This report identifies all proposals and line items that are awaiting specific actions. These actions can include those lines remaining to be invoiced, booked, shipped, etc.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'invoiced_sales') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'invoiced_sales', 'popup_id=report_filter');\">Invoiced Sales Summary</a>
											<div style=\"padding-top:5px;\">
												This report identifies invoiced sales within a specific date or date range.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'bookings') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'bookings_report', 'popup_id=report_filter');\">Bookings Report Summary</a>
											<div style=\"padding-top:5px;\">
												This report shows all sales bookings and their profitability within a specific date or date range.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'product_sales') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'product_sales_report', 'popup_id=report_filter');\">Product Sales Report</a>
											<div style=\"padding-top:5px;\">
												This report shows all customer sales by product and service.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'job_costing') ? "
                                        <div style=\"padding-bottom:10px;\">
                                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'job_costing', 'popup_id=report_filter');\">Job Costing/Profitability Report</a>
                                            <div style=\"padding-top:5px;\">
                                                This report helps you to identify how profitable your orders are, identifying true costs and actual project margins.
                                            </div>
                                        </div>" : NULL).($asdf && $this->p->ck(get_class($this), 'V', 'work_order') ? "
                                        <div style=\"padding-bottom:10px;\">
                                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'work_order_bookings', 'popup_id=report_filter');\">Work Order Bookings Report</a>
                                            <div style=\"padding-top:5px;\">
                                                This report details the work order bookings and their profitability.
                                            </div>
                                        </div>" : NULL).($this->p->ck(get_class($this), 'V', 'commissions') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'commission_report', 'popup_id=report_filter');\">Commissions Report</a>
											<div style=\"padding-top:5px;\">
												This report identifies and manages commissions that are owed to your sales reps.
											</div>
										</div>
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'commissions_paid_report', 'popup_id=report_filter');\">Commissions Paid Report</a>
											<div style=\"padding-top:5px;\">
												This report shows all commissions that have been previously paid to your sales reps.
											</div>
										</div>" : NULL)."
									</td>
								</tr>" : NULL).($finance ? "
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">Financial Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">".($this->p->ck(get_class($this), 'V', 'balance_sheet') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'balance_sheet', 'popup_id=report_filter')\">Balance Sheet</a>
											<div style=\"padding-top:5px;\">
												The summary of the value of all assets, liabilities and owners' equity on a specific date. The balance sheet can be
												run to show multiple comparisons such as monthly or quarterly.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'income_stmtm') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'income_statement', 'popup_id=report_filter')\">Income Statement</a>
											<div style=\"padding-top:5px;\">
												Identifies profit and loss within a specific period of time.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'trial_balance') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'trial_balance', 'popup_id=report_filter')\">Trial Balance</a>
											<div style=\"padding-top:5px;\">
												Identifies the closing balances of your accounts at a specific point in time.
											</div>
										</div>" : NULL).($asdf && $this->p->ck(get_class($this), 'V', 'cash_flow') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'cash_flows', 'popup_id=report_filter')\">Statement of Cash Flows</a>
											<div style=\"padding-top:5px;\">
												This statement shows your company's incoming and outgoing money over a specific date or date range.
											</div>
										</div>" : NULL).($this->p->ck(get_class($this), 'V', 'check_reg') ? "
                                        <div style=\"padding-bottom:10px;\">
                                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('accounting', 'sf_loadcontent', 'cf_loadcontent', 'check_reg')\">Check Register</a>
                                            <div style=\"padding-top:5px;\">
                                                A list of the checks issued by your company.
                                            </div>
                                        </div>" : NULL).($this->p->ck(get_class($this), 'V', 'check_reconcile') ? "
                                        <div style=\"padding-bottom:10px;\">
                                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'check_reconcile')\">Check Reconciliation Report</a>
                                            <div style=\"padding-top:5px;\">
                                                Identifies outstanding checks and provides a tool to reconcile.
                                            </div>
                                        </div>" : NULL).($this->p->ck(get_class($this), 'V', 'check_run') ? "
                                        <div style=\"padding-bottom:10px;\">
                                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'check_run', 'popup_id=report_filter')\">Check Run Report</a>
                                            <div style=\"padding-top:5px;\">
                                                This report shows all checks and their respective invoices and vendor credits applied.
                                            </div>
                                        </div>" : NULL)."
									</td>
								</tr>" : NULL)."
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">My Saved Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">";
									if (count($this->custom_reports)) {
										while (list($report_hash, $report_info) = each($this->custom_reports)) {
											$saved_category = $report_info['saved_catagory'];
											unset ($doit_func);
											switch ($saved_category) {
												case 'ar_report':
													$doit_func = "doit_ar";
												break;

												case 'ap_report':
													$doit_func = "doit_ap";
												break;

												case 'invoiced_sales':
													$doit_func = "doit_invoiced_sales_report";
												break;

												default:
													$doit_func = "doit_$saved_category";
												break;
											}
											$tbl .= "
											<div style=\"padding-bottom:10px;\">
												<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', '$doit_func', 'report_hash=".$report_hash."', 'from_saved=1');\">".$report_info['report_name']."</a>
												&nbsp;-&nbsp;".date(DATE_FORMAT." ".TIMESTAMP_FORMAT, $report_info['timestamp'])."
												<div style=\"padding-top:5px;\">
													".$report_info['report_descr']."
												</div>
											</div>";
										}
									} else
										$tbl .= "
										<i>No custom reports</i>";

								$tbl .= "
									</td>
								</tr>
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">Shared Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">";
									if (count($this->shared_reports)) {
										while (list($report_hash, $report_info) = each($this->shared_reports)) {
											$saved_category = $report_info['saved_catagory'];
											unset ($doit_func);
											switch ($saved_category) {
												case 'ar_report':
													$doit_func = "doit_ar";
												break;

												case 'ap_report':
													$doit_func = "doit_ap";
												break;

												case 'invoiced_sales':
													$doit_func = "doit_invoiced_sales_report";
												break;

												default:
													$doit_func = "doit_$saved_category";
												break;
											}

											$tbl .= "
											<div style=\"padding-bottom:10px;\">
												<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"submit_form(\$('test').form, 'reports', 'exec_post', 'refresh_form', 'action=doit_delete_share', 'report_hash=$report_hash');\"><img src=\"images/rm_lineitem.gif\" border=\"0\" alt=\"Remove this shared report from your view.\" /></a>&nbsp;
												<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', '$doit_func', 'report_hash=".$report_hash."', 'from_saved=1');\">".$report_info['report_name']."</a>
												&nbsp;-&nbsp;".date(DATE_FORMAT." ".TIMESTAMP_FORMAT, $report_info['timestamp'])."
												<div style=\"padding-top:5px;\">
													".$report_info['report_descr']."
												</div>
											</div>";
										}
									} else
										$tbl .= "
										<i>No shared reports</i>";

								$tbl .= "
									</td>
								</tr>
							</table>
						</div>
					</div>
				</td>
			</tr>
		</table>".
		$this->form->close_form();


		$this->content['html']['place_holder'] = $tbl;
	}

	function doit_status_report() {
        $date = date("U") - 3600;
        $result = $this->db->query("DELETE FROM `reports`
                                    WHERE `saved` = 0 AND `timestamp` <= '$date'");

        if ($_POST['rm'] == 1 && $_POST['report_hash']) {
            $this->db->query("DELETE reports.* , reports_share.*
                              FROM `reports`
                              LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
                              WHERE reports.report_hash = '".$_POST['report_hash']."'");
            $this->content['action'] = 'close';
            $this->content['page_feedback'] = "Report has been deleted.";
            $this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
            return;
        }

        if ($method = $_POST['method']) {
        	$rand_id = $_POST['rand_id'];
        	$proposal_hash = $_POST['proposal_hash'];
            if ($method == 'save_note') {
		        $target_install_date = $_POST['target_install_date_'.$rand_id];
		        $actual_install_date = $_POST['actual_install_date_'.$rand_id];

			    $this->db->query("UPDATE proposal_install
			                      LEFT JOIN proposals ON proposals.proposal_hash = proposal_install.proposal_hash
			                      SET proposal_install.target_install_date = '$target_install_date' ,
			                      proposal_install.actual_install_date = '$actual_install_date' ,
			                      proposals.closed = '".($_POST['final'] == 1 ? 1 : 0)."'
			                      WHERE proposals.proposal_hash = '$proposal_hash'");
                if ($target_install_date)
    			    $this->content['html']['target_date_'.$proposal_hash] = date(DATE_FORMAT, strtotime($target_install_date));
                if ($target_install_date)
                    $this->content['html']['actual_date_'.$proposal_hash] = date(DATE_FORMAT, strtotime($actual_install_date));

                $this->content['jscript'] = "toggle_display('proposalList".$proposal_hash."', 'none');";
		        $this->content['page_feedback'] = "Your information has been updated.";
            } elseif ($method == 'clear_ack_info') {
                $po_hash = $_POST['po_hash'];

		        $this->db->query("UPDATE `line_items`
		                          SET `ship_date` = '' , `receive_date` = '' , `ack_no` = ''
		                          WHERE `proposal_hash` = '$proposal_hash' AND `po_hash` = '$po_hash'");

                $this->content['html']['receive_date_'.$po_hash] = $this->content['html']['ship_date_'.$po_hash] = $this->content['html']['ack_'.$po_hash] = '';
                $this->content['jscript'] = "toggle_display('poListHolder".$po_hash."', 'none');agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'show_po_details', 'proposal_hash=$proposal_hash');";
		        $this->content['page_feedback'] = "Acknowledgement information has been cleared for the selected PO.";
            }
            $this->content['action'] = 'continue';
            return;
        }
        $report_hash = ($_POST['report_hash'] ? $_POST['report_hash'] : $this->ajax_vars['report_hash']);
        $limit_start = $this->ajax_vars['limit_start'];
        $total_rows = $this->ajax_vars['total_rows'];
        $doit_print = $_POST['doit_print'];
        $from_saved = $this->ajax_vars['from_saved'];

        if ($report_hash && ($doit_print || $limit_start || $from_saved)) {
            $this->fetch_report_settings($report_hash);
            $detail = $this->current_report['detail'];

            $customer_filter = $this->current_report['customer_filter'];
	        if ($customer_filter && !is_array($customer_filter))
	            $customer_filter = array($customer_filter);

            $sales_rep_match = $this->current_report['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);

            $designer_match = $this->current_report['designer_match'];
            if ($designer_match && !is_array($designer_match))
                $designer_match = array($designer_match);

            $sales_coord_match = $this->current_report['sales_coord_match'];
            if ($sales_coord_match && !is_array($sales_coord_match))
                $sales_coord_match = array($sales_coord_match);

            $proj_mngr_match = $this->current_report['proj_mngr_match'];
            if ($proj_mngr_match && !is_array($proj_mngr_match))
                $proj_mngr_match = array($proj_mngr_match);

            $proposal_filter = $this->current_report['proposal_filter'];
            if ($proposal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter);

            $status = $this->current_report['status'];
            $work_orders_unack = $this->current_report['work_orders_unack'];

        } else {
            $detail = $_POST['detail'];

            $customer_filter = $_POST['customer_filter'];
	        if ($customer_filter && !is_array($customer_filter))
	            $customer_filter = array($customer_filter);

            $sales_rep_match = $_POST['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);

            $designer_match = $_POST['designer_match'];
            if ($designer_match && !is_array($designer_match))
                $designer_match = array($designer_match);

            $sales_coord_match = $_POST['sales_coord_match'];
            if ($sales_coord_match && !is_array($sales_coord_match))
                $sales_coord_match = array($sales_coord_match);

            $proj_mngr_match = $_POST['proj_mngr_match'];
            if ($proj_mngr_match && !is_array($proj_mngr_match))
                $proj_mngr_match = array($proj_mngr_match);

            $proposal_filter = $_POST['proposal_filter'];
            if ($proposal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter);

            $status = $_POST['status'];
            $work_orders_unack = $_POST['work_orders_unack'];
        }

        $save = $_POST['save'];
        $saved_cat = "status_report";
        $report_name = $_POST['report_name'];
        $report_descr = $_POST['report_descr'];
        $share = $_POST['share'];
        $sales_rep_share = $_POST['sales_rep_share'];
        $group_share = $_POST['group_share'];
        $from_report = $_POST['from_report'];

        if (!$save)
        	unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);

        if ($save && !$report_name) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
        }
        if ($save && !$report_hash) {
            $result = $this->db->query("SELECT COUNT(*) AS Total
                                        FROM `reports`
                                        WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
            if ($this->db->result($result)) {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
            }
        }
        if ($share && !count($sales_rep_share) && !count($group_share)) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
        }

        if (($timeframe == 13 && !$sort_from_date) || ($timeframe == 13 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
        }

        if ($this->content['error'])
            return;

        if (is_array($customer_filter) && count($customer_filter)) {
            $customer_filter = array_unique($customer_filter);
            $customer_filter = array_values($customer_filter);
            array_walk($customer_filter, 'add_quotes', "'");
            $sql_p[] = "proposals.customer_hash IN (".implode(" , ", $customer_filter).")";
            array_walk($customer_filter, 'strip_quotes');
        }

        if (is_array($proposal_filter) && count($proposal_filter)) {
            $proposal_filter = array_unique($proposal_filter);
            $proposal_filter = array_values($proposal_filter);
            array_walk($proposal_filter, 'add_quotes', "'");
            $sql_p[] = "proposals.proposal_hash IN (".implode(" , ", $proposal_filter).")";
            array_walk($proposal_filter, 'strip_quotes');
        }

        if (@in_array("", $sales_rep_match) && count($sales_rep_match) > 1)
            unset($sales_rep_match[array_search("", $sales_rep_match)]);
        elseif (@in_array("", $sales_rep_match) && count($sales_rep_match) == 1)
            unset($sales_rep_match);

        if (is_array($sales_rep_match) && count($sales_rep_match)) {
            array_walk($sales_rep_match, 'add_quotes', "'");
            $sql_p[] = "proposals.sales_hash IN (".implode(" , ", $sales_rep_match).")";
            array_walk($sales_rep_match, 'strip_quotes');
        }

        if (@in_array("", $designer_match) && count($designer_match) > 1)
            unset($designer_match[array_search("", $designer_match)]);
        elseif (@in_array("", $designer_match) && count($designer_match) == 1)
            unset($designer_match);

        if (is_array($designer_match) && count($designer_match)) {
            array_walk($designer_match, 'add_quotes', "'");
            $sql_p[] = "proposals.designer_hash IN (".implode(" , ", $designer_match).")";
            array_walk($designer_match, 'strip_quotes');
        }

        if (@in_array("", $sales_coord_match) && count($sales_coord_match) > 1)
            unset($sales_coord_match[array_search("", $sales_coord_match)]);
        elseif (@in_array("", $sales_coord_match) && count($sales_coord_match) == 1)
            unset($sales_coord_match);

        if (is_array($sales_coord_match) && count($sales_coord_match)) {
            array_walk($sales_coord_match, 'add_quotes', "'");
            $sql_p[] = "proposals.sales_coord_hash IN (".implode(" , ", $sales_coord_match).")";
            array_walk($sales_coord_match, 'strip_quotes');
        }

        if (@in_array("", $proj_mngr_match) && count($proj_mngr_match) > 1)
            unset($proj_mngr_match[array_search("", $proj_mngr_match)]);
        elseif (@in_array("", $proj_mngr_match) && count($proj_mngr_match) == 1)
            unset($proj_mngr_match);


        if (is_array($proj_mngr_match) && count($proj_mngr_match)) {
            array_walk($proj_mngr_match, 'add_quotes', "'");
            $sql_p[] = "proposals.proj_mngr_hash IN (".implode(" , ", $proj_mngr_match).")";
            array_walk($proj_mngr_match, 'strip_quotes');
        }

        //proposal_fully_invoiced => when zero means that it is fully invoiced

        switch ($status) {
            case 1:
            $sql_p[] = "proposals.closed = 0";
            $having_p[] = "proposal_booked > 0";
            $this->report_title = "Proposals that are booked but not yet complete";
            break;

            case 2:
            $sql_p[] = "proposals.closed = 0";
            $having_p[] = "proposal_booked > 0 AND proposal_fully_invoiced = 0";
            $this->report_title = "Proposals that are booked and invoiced but not yet complete";
            break;

            case 13:
            $sql_p[] = "proposals.closed = 1";
            $this->report_title = "Proposals that have been marked complete";
            break;

            case 3:
            $having_p[] = "proposal_booked > 0 AND proposal_fully_invoiced > 0";
            $this->report_title = "Proposals that are booked but not yet invoiced";
            break;

            // Added for Trac #1320
            case 17:
            $having_p[] = "proposal_booked > 0 AND total_ack_lines < proposal_booked";
            $this->report_title = "Proposals that are booked but not fully acknowledged";
            break;

            case 4:
            $having_p[] = "proposal_booked > 0 AND total_ack_lines = proposal_booked AND proposal_fully_invoiced > 0";
            $this->report_title = "Proposals that are booked and fully acknowledged, but not yet invoiced";
            break;

            case 5:
            $having_p[] = "proposal_booked > 0 AND total_ack_lines > 0 AND proposal_fully_invoiced >= 0";
            $this->report_title = "Proposals that are booked and partially acknowledged, but not yet invoiced";
            break;

            case 6:
            $having_p[] = "proposal_booked > 0 AND total_unshipped > 0";
            $this->report_title = "Proposals that are booked and only partially shipped";
            break;

            case 7:
            $having_p[] = "proposal_booked > 0 AND proposal_booked = total_shipped AND total_received = 0 AND total_unreceived > 0";
            $this->report_title = "Proposals that are booked, fully shipped, but not yet received";
            break;

            case 8:
            $having_p[] = "proposal_booked > 0 AND proposal_booked = total_shipped AND total_received > 0 AND total_unreceived > 0";
            $this->report_title = "Proposals that are booked, fully shipped, and partially received";
            break;

            case 9:
            $having_p[] = "proposal_booked > 0 AND proposal_booked = total_shipped AND total_received = total_shipped AND proposal_fully_invoiced > 0";
            $this->report_title = "Proposals that are booked, fully shipped, fully received, but not yet invoiced";
            break;

            case 10:
            $having_p[] = "proposal_booked > 0 AND proposal_booked = total_shipped AND total_received = total_shipped AND proposal_fully_invoiced = 0";
            $this->report_title = "Proposals that are booked, fully shipped, fully received, and invoiced in full";
            break;

            case 11:
            $having_p[] = "proposal_booked = 0 AND proposed_lines > 0";
            $this->report_title = "Proposals that are partially booked, containing lines remaining to be booked";
            break;

            case 15:
            $sql_p[] = "proposals.closed = 0";
            $having_p[] = "total_punchlist_lines > 0 AND total_punchlist_booked = total_punchlist_lines";
            $this->report_title = "Proposals that containg punchlist that are booked but not yet complete";
            break;

            case 14:
            $having_p[] = "total_punchlist_lines > 0 AND total_punchlist_booked < total_punchlist_lines";
            $this->report_title = "Proposals that containg punchlist that have not yet booked";
            break;

            case 16:
            $having_p[] = "total_punchlist_lines > 0 AND total_punchlist_invoiced < total_punchlist_booked";
            $this->report_title = "Proposals that containg punchlist that are booked but not yet invoiced";
            break;

            case 12:
            $having_p[] = "proposed_lines > proposal_booked";
            $this->report_title = "Proposals that are proposed, but not yet booked";
            break;


        }

        if ($sql_p)
            $sql = implode(" AND ", $sql_p);
        if ($having_p)
            $having = implode(" AND ", $having_p);

        $str = "detail=$detail|customer_filter=".@implode("&", $customer_filter)."|proposal_filter=".@implode("&", $proposal_filter)."|sales_rep_match=".@implode("&", $sales_rep_match)."|sales_coord_match=".@implode("&", $sales_coord_match)."|proj_mngr_match=".@implode("&", $proj_mngr_match)."|designer_match=".@implode("&", $designer_match)."|status=$status|work_orders_unack=$work_orders_unack";

        if (!$report_hash) {
            $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
            while (global_classes::key_exists('reports', 'report_hash', $report_hash))
                $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

            $this->db->query("INSERT INTO `reports`
                              (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
                              VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

            if ($share && (count($group_share) || count($sales_rep_share))) {
                for ($i = 0; $i < count($group_share); $i++)
                    $this->db->query("INSERT INTO `reports_share`
                                      (`report_hash` , `group_hash`)
                                      VALUES ('$report_hash' , '".$group_share[$i]."')");

                for ($i = 0; $i < count($sales_rep_share); $i++)
                    $this->db->query("INSERT INTO `reports_share`
                                      (`report_hash` , `user_hash`)
                                      VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
            }
        } elseif (!$limit_start && !$from_saved) {
            $existing = true;
            $this->db->query("UPDATE `reports`
                              SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
                              WHERE `report_hash` = '$report_hash'");

            if (!$share)
                $this->db->query("DELETE FROM `reports_share`
                                  WHERE `report_hash` = '".$this->report_hash."'");
            else {
                if (!is_array($sales_rep_share))
                    $sales_rep_share = array();
                if (!is_array($group_share))
                    $group_share = array();

                //Share or revoke to users
                $result = $this->db->query("SELECT `user_hash`
                                            FROM `reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_users[] = $row['user_hash'];

                if (!is_array($current_share_users))
                    $current_share_users = array();

                $to_remove = array_diff($current_share_users, $sales_rep_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `reports_share`
                                          WHERE `user_hash` = '".$current_share_users[$i]."'");
                }
                $to_add = array_diff($sales_rep_share, $current_share_users);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `reports_share`
                                          (`report_hash` , `user_hash`)
                                          VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
                }

                //Share or revoke to groups
                $result = $this->db->query("SELECT `group_hash`
                                            FROM `reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_groups[] = $row['group_hash'];

                if (!is_array($current_share_groups))
                    $current_share_groups = array();

                $to_remove = array_diff($current_share_groups, $group_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `reports_share`
                                          WHERE `group_hash` = '".$current_share_groups[$i]."'");
                }
                $to_add = array_diff($group_share, $current_share_groups);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `reports_share`
                                          (`report_hash` , `group_hash`)
                                          VALUES ('$report_hash' , '".$group_share[$i]."'");
                }
            }
        }
        $max_memory = server_info('memory_limit');
        $this->report_hash = $report_hash;

        $result = $this->db->query("SELECT ".(!$limit_start ? "SQL_CALC_FOUND_ROWS " : NULL) . "proposals.obj_id AS pobj_id , proposals.proposal_hash ,
                                    proposals.sales_hash , proposals.proposal_no ,
                                    proposals.proposal_descr  , customers.customer_name ,
                                    proposal_install.target_install_date , proposal_install.actual_install_date ,
                                    proposals.status , users.full_name AS sales_rep ,
                                    (
                                        SELECT `full_name`
                                        FROM `users`
                                        WHERE `id_hash` = proposals.proj_mngr_hash
                                    ) AS project_mngr ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.status > 0
                                    ) AS proposal_booked ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND (line_items.invoice_hash = '' AND line_items.sell != 0)
                                    ) AS proposal_fully_invoiced ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.status > 0 AND (line_items.ack_no != ''".(!$work_orders_unack ? " OR (!ISNULL(line_items.work_order_hash) AND line_items.work_order_hash != '')" : NULL).")
                                    ) AS total_ack_lines ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.status > 0 AND line_items.ship_date != '' AND line_items.ship_date <= '".date("Y-m-d")."'
                                    ) AS total_shipped ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.status > 0 AND (line_items.ship_date = '' OR line_items.ship_date > '".date("Y-m-d")."')
                                    ) AS total_unshipped ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.status > 0 AND line_items.receive_date != '' AND line_items.receive_date <= '".date("Y-m-d")."'
                                    ) AS total_received ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.status > 0 AND (line_items.receive_date = '' OR line_items.receive_date > '".date("Y-m-d")."')
                                    ) AS total_unreceived ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.status = 0
                                    ) AS proposed_lines ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.punch = 1
                                    ) AS total_punchlist_lines ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.punch = 1 AND line_items.status > 0
                                    ) AS total_punchlist_booked ,
                                    (
                                        SELECT COUNT(line_items.obj_id)
                                        FROM line_items
                                        WHERE line_items.proposal_hash = proposals.proposal_hash AND line_items.punch = 1 AND line_items.status > 0 AND line_items.invoice_hash != ''
                                    ) AS total_punchlist_invoiced ,
                                    (
                                        SELECT COUNT(purchase_order.obj_id)
                                        FROM purchase_order
                                        WHERE purchase_order.proposal_hash = proposals.proposal_hash AND purchase_order.deleted = 0
                                    ) AS total_po ,
                                    (
                                        SELECT COUNT(purchase_order.obj_id)
                                        FROM purchase_order
                                        WHERE purchase_order.proposal_hash = proposals.proposal_hash AND purchase_order.punch = 1 AND purchase_order.deleted = 0
                                    ) AS total_punch_po
                                    FROM `proposals`
                                    LEFT JOIN `proposal_install` ON proposal_install.proposal_hash = proposals.proposal_hash
                                    LEFT JOIN `customers` ON customers.customer_hash = proposals.customer_hash
                                    LEFT JOIN `users` ON users.id_hash = proposals.sales_hash".($sql ? "
                                    WHERE ".$sql : NULL).($having ? "
                                    HAVING ".$having : NULL)."
                                    ORDER BY proposals.sales_hash , proposals.proposal_no ASC".($limit_start ? "
                                    LIMIT $limit_start , $total_rows" : NULL));
        while ($row = $this->db->fetch_assoc($result)) {
            if ($row['sales_hash'])
                $this->results[$row['sales_hash']][] = $row;

            if (!$limit_start && $detail == 1 && $k < 10)
            	$this->sub_detail[$row['proposal_hash']] = $this->show_po_details($row['proposal_hash']);
            if ($k > 0 && $k % 10 == 0) {
                if ($k > 200 || bcdiv(memory_get_usage(), $max_memory, 4) >= .8) {
                    $this->limit_start = $k + 1 + ($limit_start ? $limit_start : 0);
				    if ($detail != 1 || !$this->total_rows || !is_numeric($this->total_rows)) {
                        $r = $this->db->query("SELECT FOUND_ROWS() AS t");
                        $this->total_rows = $this->db->result($r, 0, 't');
				    }
				    $this->db->free_result($result);
                    break;
                }
            }
            $k++;
        }

        if (!$limit_start)
            $this->content['action'] = 'close';
        else
            $this->content['action'] = 'continue';

        if ($limit_start) {
        	if ($this->ajax_vars['sales_map'])
                $this->sales_map = explode("|", $this->ajax_vars['sales_map']);

            $str = $this->status_report(1, $limit_start);
            //Write the contents to a temp file so that we can remove line breaks for the javascript function call
    	    $temp = tempnam(SITE_ROOT.'core/tmp', 'pre_');
    	    $fh = fopen($temp, 'w');
    	    fwrite($fh, trim($str));
    	    fclose($fh);

    	    unset($str);
    	    $file_str = file($temp);
    	    for ($i = 0; $i < count($file_str); $i++)
        		$str .= trim(str_replace("'", "\'", $file_str[$i]));

            unlink($temp, $this->sub_detail);

    	    $this->content['jscript'][] = "\$('table_content_control').insert({bottom:'".$str."'});";
        } else
            $this->content['html']['place_holder'] = $this->status_report(1);

        if ($this->limit_start) {
        	if ($this->sales_map)
                $sales_keys = array_values($this->sales_map);

            $this->content['jscript'][] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'doit_status_report', 'report_hash=".$this->report_hash."', 'limit_start=".$this->limit_start."', 'total_rows=".$this->total_rows."'".($sales_keys ? ", 'sales_map=".@implode("|", $sales_keys)."'" : NULL).");";
        } elseif ($detail == 1)
            $this->content['jscript'][] = "remote_fetch();";

        return;
	}

    function fetch_proposal_notes($proposal_hash=NULL) {
        if ($proposal_hash)
            $local = true;
        elseif ($this->ajax_vars['proposal_hash'])
            $proposal_hash = $this->ajax_vars['proposal_hash'];
        else
            return;

        $result = $this->db->query("SELECT proposal_notes.note , proposal_notes.type , proposal_notes.timestamp ,
                                    users.full_name , proposal_notes.note_hash , proposal_notes.user_hash
                                    FROM `proposal_notes`
                                    LEFT JOIN `users` ON users.id_hash = proposal_notes.user_hash
                                    WHERE `proposal_hash` = '$proposal_hash'
                                    ORDER BY proposal_notes.type , proposal_notes.timestamp ASC");
        while ($row = $this->db->fetch_assoc($result))
            $note[$row['type']][] = $row;

        if ($note['p'] || $note['d'] || $note['i']) {
            $note_tbl .= "
            <div style=\"margin-left:10px;background-color:#efefef;border:1px solid #cccccc;width:90%;padding:5px;font-size:8pt;\">";
            if ($note['p']) {
                $note_tbl .= "
                <div style=\"font-weight:bold;margin-bottom:5px;\">Proposal Notes:</div>";
                for ($j = 0; $j < count($note['p']); $j++)
                    $note_tbl .= "
                    <div style=\"margin-bottom:5px;\">
                    ".stripslashes($note['p'][$j]['full_name'])." (".date(DATE_FORMAT." ".TIMESTAMP_FORMAT, $note['p'][$j]['timestamp']).") - ".stripslashes($note['p'][$j]['note'])."
                    ".($note['p'][$j]['user_hash'] == $this->current_hash ?
                        "[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('status_reports', 'sf_loadcontent', 'show_popup_window', 'addnote', 'proposal_hash=$proposal_hash', 'note_hash=".$note['p'][$j]['note_hash']."', 'popup_id=note_win');\" class=\"link_standard\">edit</a></small>]" : NULL)."
                    </div>";
            }
            if ($note['d']) {
                $note_tbl .= "
                <div style=\"font-weight:bold;margin-bottom:5px;\">Design Notes:</div>";
                for ($j = 0; $j < count($note['d']); $j++)
                    $note_tbl .= "
                    <div style=\"margin-bottom:5px;\">
                    ".stripslashes($note['d'][$j]['full_name'])." (".date(DATE_FORMAT." ".TIMESTAMP_FORMAT, $note['d'][$j]['timestamp']).") - ".stripslashes($note['d'][$j]['note'])."
                    ".($note['d'][$j]['user_hash'] == $this->current_hash ?
                        "[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('status_reports', 'sf_loadcontent', 'show_popup_window', 'addnote', 'proposal_hash=$proposal_hash', 'note_hash=".$note['d'][$j]['note_hash']."', 'popup_id=note_win');\" class=\"link_standard\">edit</a></small>]" : NULL)."
                    </div>";
            }
            if ($note['i']) {
                $note_tbl .= "
                <div style=\"font-weight:bold;margin-bottom:5px;\">Install Notes:</div>";
                for ($j = 0; $j < count($note['i']); $j++)
                    $note_tbl .= "
                    <div style=\"margin-bottom:5px;\">
                    ".stripslashes($note['i'][$j]['full_name'])." (".date(DATE_FORMAT." ".TIMESTAMP_FORMAT, $note['i'][$j]['timestamp']).") - ".stripslashes($note['i'][$j]['note'])."
                    ".($note['i'][$j]['user_hash'] == $this->current_hash ?
                        "[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('status_reports', 'sf_loadcontent', 'show_popup_window', 'addnote', 'proposal_hash=$proposal_hash', 'note_hash=".$note['i'][$j]['note_hash']."', 'popup_id=note_win');\" class=\"link_standard\">edit</a></small>]" : NULL)."
                    </div>";
            }

            $note_tbl .= "
            </div>";
        }

        if ($local)
            return $note_tbl;
        else
            $this->content['html']['note_table_holder'.$proposal_hash] = $note_tbl;
    }

    function status_report($step=NULL, $active_limit_start=NULL) {
        $this->unlock("_");

        if ($step) {
            $this->fetch_report_settings($this->report_hash);

            $tbl = (!$active_limit_start ? "
	            <table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\" id=\"table_content_control\">
	                <tr>
	                    <td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"7\">
	                        <h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
	                            ".($this->current_report['saved'] ?
	                                $this->current_report['report_name'] : "Project Status Report").
	                            ($this->p->ck('reports', 'V', 'project_status') ? "
	                            <span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
	                                [<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'status_report', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
	                            </span>" : NULL)."
	                        </h3>
	                        <div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
	                            <small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
	                            <!--&nbsp;&nbsp;
	                            <a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=cash_disp', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
	                            &nbsp;&nbsp;
	                            <a href=\"javascript:void(0);\" class=\"link_standard\" ><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>-->
	                        </div>
	                    </td>
	                </tr>" : NULL);

                if ($this->results) {
	                while (list($sales_hash, $details) = each($this->results)) {
	                    $tbl .= (!$active_limit_start || ($active_limit_start && (!is_array($this->sales_map) || !in_array($sales_hash, $this->sales_map))) ? "
	                    <tr class=\"thead\" style=\"font-weight:bold;\">
    	                    <td style=\"font-size:8pt;width:125px;vertical-align:bottom;\">Proposal No.</td>
    	                    <td style=\"font-size:8pt;vertical-align:bottom;\">Customer</td>
    	                    <td style=\"font-size:8pt;vertical-align:bottom;\">Project Description</td>
    	                    <td style=\"font-size:8pt;\" nowrap>Target Install</td>
    	                    <td style=\"font-size:8pt;\" nowrap>Sched Install</td>
    	                    <td style=\"font-size:8pt;\" nowrap>Project Mngr</td>
    	                    <td style=\"font-size:8pt;text-align:right;padding-right:5px;vertical-align:bottom;\">Invoiced</td>
    	                </tr>
    	                <tr>
        	                <td colspan=\"7\" style=\"font-size:8pt;background-color:#efefef;font-weight:bold;vertical-align:middle;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc\">
            	                Sales Rep: ".stripslashes($details[0]['sales_rep'])." (".count($details).")<br />
            	            </td>
            	        </tr>" : NULL);
	                    if (!is_array($this->sales_map) || !in_array($sales_hash, $this->sales_map))
    	                    $this->sales_map[] = $sales_hash;

	                    $b = 0;

	                    $count_details = count($details);
	                    for ($i = 0; $i < $count_details; $i++) {
	                        $b++;
	                        $po_date_flag = false;

	                        unset($po_list_tbl);
	                        if ($details[$i]['total_po'] > 0) {
	                            $po_list_tbl = "
	                            <tr>
	                                <td colspan=\"7\" style=\"font-size:8pt;background-color:#ffffff;\">
	                                    <div style=\"margin-left:10px;\">
	                                        <div style=\"padding-bottom:4px;font-size:8pt\" >
	                                            <img src=\"images/".($this->current_report['detail'] == 1 ? "collapse" : "expand").".gif\" />
	                                            &nbsp;
	                                            <a href=\"javascript:void(0);\" onClick=\"if(\$('po_holder".$details[$i]['proposal_hash']."').getStyle('display')=='block'){toggle_display('po_holder".$details[$i]['proposal_hash']."', 'none');\$('po_holder".$details[$i]['proposal_hash']."').innerHTML='';} else{agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'show_po_details', 'proposal_hash=".$details[$i]['proposal_hash']."');}\" title=\"Show/Hide PO Details\" class=\"link_standard\">".$details[$i]['total_po']." Purchase Order".($details[$i]['total_po'] > 1 ? "s" : NULL)."</a>".($details[$i]['total_punch_po'] ? "
	                                            <span style=\"padding-left:5px;background-color:#ffff00;color:000000;\">(".$details[$i]['total_punch_po']." Punchlist PO".($details[$i]['total_punch_po'] > 1 ? "s" : NULL).")</span>" : NULL)."
	                                        </div>
	                                        <div id=\"po_holder".$details[$i]['proposal_hash']."\" style=\"display:".($this->current_report['detail'] == 1 ? "block" : "none").";\">".($this->current_report['detail'] == 1 ?
                                                ($this->sub_detail[$details[$i]['proposal_hash']] ?
                                                    $this->sub_detail[$details[$i]['proposal_hash']] : "<img src=\"images/content_loader.gif\" content_holder=\"1\" content_id=\"".$details[$i]['pobj_id']."\" style=\"margin-left:20px;margin-top:5px;\" />") : NULL)."
	                                        </div>
	                                    </div>
	                                </td>
	                            </tr>";
	                        }
	                        $tbl .= "
	                        <tr>
	                            <td style=\"font-weight:bold;background-color:#ffffff;font-size:8pt;vertical-align:bottom;\">".($this->p->ck('proposals', 'E') ? "
	                                <a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'get_notes', 'proposal_hash=".$details[$i]['proposal_hash']."', 'report_hash=".$this->report_hash."');\" class=\"link_standard\" title=\"Update information on this proposal\">
	                                    <strong>".$details[$i]['proposal_no']."</strong>
	                                </a>" : "<strong>".$details[$i]['proposal_no']."</strong>")."
	                                <div id=\"proposalListHolder".$details[$i]['proposal_hash']."\"></div>
	                            </td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;vertical-align:bottom;\">".stripslashes($details[$i]['customer_name'])."</td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;vertical-align:bottom;\">".(strlen($details[$i]['proposal_descr']) > 75 ?
	                                stripslashes(substr($details[$i]['proposal_descr'], 0, 75))."...." : stripslashes($details[$i]['proposal_descr']))."
	                            </td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;vertical-align:bottom;\" id=\"target_date_".$details[$i]['proposal_hash']."\">".($details[$i]['target_install_date'] && date("Y", strtotime($details[$i]['target_install_date'])) > 2000 ?
	                                date(DATE_FORMAT, strtotime($details[$i]['target_install_date'])) : NULL)."
	                            </td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;vertical-align:bottom;\" id=\"actual_date_".$details[$i]['proposal_hash']."\">".($details[$i]['actual_install_date'] && date("Y", strtotime($details[$i]['actual_install_date'])) > 2000 ?
	                                ($po_date_flag ? "
	                                    <img src=\"images/alert.gif\" alt=\"Storage notification may be required for one or more purchase orders under this proposal!\" />&nbsp;&nbsp;" : NULL).
	                                date(DATE_FORMAT, strtotime($details[$i]['actual_install_date'])) : NULL)."
	                            </td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;vertical-align:bottom;\">".$details[$i]['project_mngr']."</td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;text-align:right;padding-right:5px;vertical-align:bottom;\">".($details[$i]['proposal_fully_invoiced'] == 0 ?
	                                "<img src=\"images/check.gif\" alt=\"This proposal has been invoiced in full\" />" : "&nbsp;")."
	                            </td>
	                        </tr>
	                        <tr>
	                            <td colspan=\"7\" style=\"font-size:8pt;background-color:#ffffff;padding-bottom:10px;\">".($this->p->ck('proposals', 'E') ? "
	                                <div style=\"margin-left:10px;margin-bottom:3px;\">
	                                    [<small><a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'addnote', 'proposal_hash=".$details[$i]['proposal_hash']."', 'popup_id=note_win');\">new note</a></small>]
	                                </div>" : NULL)."
	                                <div id=\"note_table_holder".$details[$i]['proposal_hash']."\">".$this->fetch_proposal_notes($details[$i]['proposal_hash'])."</div>
	                            </td>
	                        </tr>" .
	                        ($po_list_tbl ?
	                            $po_list_tbl : NULL)."
	                        <tr>
	                            <td style=\"font-size:8pt;background-color:#cccccc;\" colspan=\"7\"></td>
	                        </tr>";
	                    }
	                }
                } else
	                $tbl .= "
	                <tr style=\"font-size:8pt;background-color:#ffffff;\">
	                    <td style=\"border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"7\">There are no results to show.</td>
	                </tr>";

    	    if (!$active_limit_start)
            	$tbl .= "
            	</table>";

            if (!$active_limit_start) {
	            $jscript = '
	            remote_fetch = function() {
					if (agent.in_progress == true) {
						setTimeout("remote_fetch();", 1000);
						return;
					}
					var pending = $$(\'img[content_holder=1]\');
	                var i=0, c, str=\'\', atr;
	                while (c = pending[i++]) {
	                    var yes = true;
	                    if (i > 30)
	                        break;

	                    if (atr = c.readAttribute(\'content_id\'))
	                        str += atr + \'|\';
	                }
	                if (yes)
	                    agent.call(\'reports\', \'sf_loadcontent\', \'cf_loadcontent\', \'show_po_details\', \'report_hash='.$this->report_hash.'\', \'pstr=\' + str);
	            }';
                $this->content['jscript'][] = $jscript;
            }

            return $tbl;
        } else {
            $report_hash = $this->ajax_vars['report_hash'];
            $this->fetch_report_settings($report_hash);

            array_shift($this->user_name);
            array_shift($this->user_hash);

            if ($this->current_report['sales_rep_match'] && !is_array($this->current_report['sales_rep_match']))
                $this->current_report['sales_rep_match'] = array($this->current_report['sales_rep_match']);
            if ($this->current_report['sales_coord_match'] && !is_array($this->current_report['sales_coord_match']))
                $this->current_report['sales_coord_match'] = array($this->current_report['sales_coord_match']);
            if ($this->current_report['designer_match'] && !is_array($this->current_report['designer_match']))
                $this->current_report['designer_match'] = array($this->current_report['designer_match']);
            if ($this->current_report['proj_mngr_match'] && !is_array($this->current_report['proj_mngr_match']))
                $this->current_report['proj_mngr_match'] = array($this->current_report['proj_mngr_match']);

            if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
                $this->current_report['customer_filter'] = array($this->current_report['customer_filter']);
            if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
                $this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);

            $this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
            if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
                unset($report_hash);

            $tbl = $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
            $this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
            <div class=\"panel\">
                <div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
                    <h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
                        <p id=\"feedback_message".$this->popup_id."\"></p>
                </div>
                <table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
                    <tr>
                        <td style=\"padding:0;\">
                             <div style=\"background-color:#ffffff;height:100%;\">
                                <div style=\"margin:15px 35px;\">
                                    <div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
                                        ".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_status_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
                                            "&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_status_report', 'rm=1');") : NULL)."
                                    </div>
                                    <h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
                                        $this->current_report['report_name'] : "Project Status Report")."</h3>
                                    <table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=proposal",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
                                                if (is_array($this->current_report['proposal_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++)
                                                        $tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer', 'customer_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
                                                if (is_array($this->current_report['customer_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
                                                        $tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by proposal status?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->select("status",
                                                                      array("Booked but not yet complete",
                                                                            "Booked and invoiced but not yet complete",
                                                                            "Marked complete",
                                                                            "Booked and not yet invoiced",
                                                                      		"Booked but not fully acknowledged",
                                                                            "Booked, fully acknowledged, not yet invoiced",
                                                                            "Booked, partially acknowledged, not yet invoiced",
                                                                            "Booked and only partially shipped",
                                                                            "Booked, fully shipped, but not yet received",
                                                                            "Booked, fully shipped, and partially received",
                                                                            "Booked, fully shipped, fully received, not yet invoiced",
                                                                            "Booked, fully shipped, fully received, invoiced in full",
                                                                            "Partially booked, with lines remaining to be booked",
                                                                            "Punchlist proposals booked but not yet complete",
                                                                            "Punchlist proposals not yet booked",
                                                                            "Punchlist proposals booked but not yet invoiced",
                                                                            "Proposed, but not yet booked"),
                                                                      $this->current_report['status'],
                                                                      array(1, 2, 13, 3, 17, 4, 5, 6, 7, 8, 9, 10, 11, 15, 14, 16, 12),
                                                                      "blank=1")."
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show work order lines as unacknowledged?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->checkbox("name=work_orders_unack", "value=1", ($this->current_report['work_orders_unack'] ? "checked" : NULL))."</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]", ($this->p->ck('proposals', 'S') ? $this->sales_name : array_merge(array("All Sales Reps"), $this->user_name)), (is_array($this->current_report['sales_rep_match']) ? $this->current_report['sales_rep_match'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')), ($this->p->ck('proposals', 'S') ? $this->sales_hash : array_merge(array(''), $this->user_hash)), "multiple", "blank=1", "size=4", "style=width:200px;", ($this->p->ck('proposals', 'S') ? "disabled" : NULL))."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales coordinator?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("sales_coord_match[]", array_merge(array("All Sales Reps"), $this->user_name), (is_array($this->current_report['sales_coord_match']) ? $this->current_report['sales_coord_match'] : array($this->current_report['sales_coord_match'])), array_merge(array(''), $this->user_hash), "multiple", "blank=1", "size=4", "style=width:200px;")."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by designer?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("designer_match[]", array_merge(array("All Sales Reps"), $this->user_name), (is_array($this->current_report['designer_match']) ? $this->current_report['designer_match'] : array($this->current_report['designer_match'])), array_merge(array(''), $this->user_hash), "multiple", "blank=1", "size=4", "style=width:200px;")."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by project manager?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("proj_mngr_match[]", array_merge(array("All Sales Reps"), $this->user_name), (is_array($this->current_report['proj_mngr_match']) ? $this->current_report['proj_mngr_match'] : array($this->current_report['proj_mngr_match'])), array_merge(array(''), $this->user_hash), "multiple", "blank=1", "size=4", "style=width:200px;")."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Purchase Order Detail?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("detail", array("Show Detail View", "Show Simple View"), $this->current_report['detail'], array(1, 0), "blank=1")."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
                                                <div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
                                                    What should the report be called?
                                                    <br />
                                                    ".$this->form->text_box("name=report_name",
                                                                            "value=".$this->current_report['report_name'],
                                                                            "autocomplete=off",
                                                                            "size=30",
                                                                            "style=margin-top:5px;margin-bottom:10px;"
                                                                            )."
                                                    <br />
                                                    Optional description for the report:
                                                    <br />
                                                    ".$this->form->text_area("name=report_descr",
                                                                            "value=".$this->current_report['report_descr'],
                                                                            "rows=3",
                                                                            "cols=50",
                                                                            "style=margin-top:5px;"
                                                                            )."
                                                    <div style=\"padding-top:5px\">
                                                        ".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
                                                        <div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
                                                            Share to the following users:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                            Share to the following groups:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>".
            $this->form->close_form();

            $this->content['popup_controls']["cmdTable"] = $tbl;
            $this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
            $this->content['jscript'] = $jscript;

            return;
        }
    }

    function get_notes() {
        $proposal_hash = $this->ajax_vars['proposal_hash'];
        $report_hash = $this->ajax_vars['report_hash'];
        $p = new proposals($this->current_hash);
        $p->fetch_master_record($proposal_hash);

        $rand = rand(500, 5000);

        $tbl =
        $this->form->form_tag().
        $this->form->hidden(array("proposal_hash" => $proposal_hash,
                                  "report_hash" => $report_hash,
        						  "rand_id"	=>	$rand,
        						  "r_".$rand => 1))."
        <div id=\"proposalList".$proposal_hash."\" class=\"function_menu\" style=\"width:465px;display:block;z-index:1\">
            <div style=\"float:right;padding:3px\">
                <a href=\"javascript:void(0);\" onClick=\"toggle_display('proposalList".$proposal_hash."', 'none');\"><img src=\"images/close.gif\" border=\"0\"></a>
            </div>
            <div class=\"function_menu_item\" style=\"font-weight:bold;background-color:#365082;color:#ffffff;\">
                <span style=\"font-size:8pt;\">Proposal ".$p->current_proposal['proposal_no']."&nbsp;</span>
                <span style=\"font-weight:normal;color:#ffffff;\">
                    [<small><a style=\"color:#ffffff;\" href=\"javascript:void(0);\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$proposal_hash."', 'popup_id=proposal_win', 'from_report=1');\">view proposal</a></small>]
                </span>
            </div>
            <table cellpadding=\"0\" cellspacing=\"1\" style=\"width:100%;\">
                <tr>
                    <td style=\"width:100%;background-color:#bbc7ce;\">
                        <table style=\"width:100%;\" cellpadding=\"5\" cellspacing=\"0\">
                            <tr>
                                <td style=\"text-align:left;width:50%;padding-left:5px;border-bottom:1px solid #ffffff;color:#000000;\">
                                    <div style=\"padding-bottom:5px;font-size:8pt;\">Target Install Date:</div>
                                    <div id=\"proposal_target_install_date".$proposal_hash."\">";
                                    $this->content['jscript'][] = "setTimeout('DateInput(\'target_install_date_$rand\', false, \'YYYY-MM-DD\', \'".($p->current_proposal['target_install_date'] && date("Y", strtotime($p->current_proposal['target_install_date'])) > 2000 ? $p->current_proposal['target_install_date'] : NULL)."\', 1, \'proposal_target_install_date".$proposal_hash."\')', 100);";
                                    $tbl .= "
                                    </div>
                                </td>
                                <td style=\"text-align:left;padding-left:5px;border-bottom:1px solid #ffffff;color:#000000;\">
                                    <div style=\"padding-bottom:5px;font-size:8pt;\">Actual Install Date:</div>
                                    <div id=\"proposal_actual_install_date".$proposal_hash."\">";
                                    $this->content['jscript'][] = "setTimeout('DateInput(\'actual_install_date_$rand\', false, \'YYYY-MM-DD\', \'".($p->current_proposal['actual_install_date'] && date("Y", strtotime($p->current_proposal['actual_install_date'])) > 2000 ? $p->current_proposal['actual_install_date'] : NULL)."\', 1, \'proposal_actual_install_date".$proposal_hash."\')', 200);";
                                    $tbl .= "
                                    </div>
                                </td>
                            </tr>".($p->current_proposal['status'] == 2 ? "
                            <tr>
                                <td style=\"text-align:left;padding-left:5px;border-bottom:1px solid #ffffff;color:#000000;\" colspan=\"2\">
                                    <div style=\"padding-bottom:5px;\">
                                        ".$this->form->checkbox("name=final",
                                                                ($p->current_proposal['closed'] ? "checked" : NULL),
                                                                "value=1")."&nbsp;Mark this proposal complete.
                                    </div>
                                </td>
                            </tr>" : NULL)."
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan=\"2\" style=\"text-align:right;padding:5px;background-color:#bbc7ce;\">
                        ".$this->form->button("value=Save",
                                              ($p->current_proposal['closed'] ? "checked" : NULL),
                                              "onclick=submit_form(\$('r_".$rand."').form, 'reports', 'exec_post', 'refresh_form', 'proposal_hash=".$proposal_hash."', 'action=doit_status_report', 'method=save_note');")."
                    </td>
                </tr>
            </table>
        </div>".$this->form->close_form();

        $this->content['html']['proposalListHolder'.$proposal_hash] = $tbl;
        return;
    }


    function ship_to($hash) {
        list($class, $id, $hash) = explode("|", $hash);
        if ($class) {
            $obj = new $class($this->current_hash);
            if ($hash) {
                $obj->fetch_location_record($hash);
                $name =
                stripslashes($obj->current_location['location_name']) . "<br />" .
                ( $obj->current_location['location_street'] ?
                    stripslashes($obj->current_location['location_street']) . "<br />" : NULL
                ) .
                stripslashes($obj->current_location['location_city']) . ", {$obj->current_location['location_state']} {$obj->current_location['location_zip']}";

            } else {

                $obj->fetch_master_record($id);
                $name =
                stripslashes($obj->{"current_" . strrev( substr(strrev($class), 1) ) }[strrev( substr( strrev($class), 1) ) . "_name"]) . "<br />" .
                ( $obj->{"current_" . strrev( substr( strrev($class), 1) ) }["street"] ?
                    $obj->{"current_" . strrev( substr( strrev($class), 1) ) }["street"] . "<br />" : NULL
                ) .
                stripslashes($obj->{"current_" . strrev( substr( strrev($class), 1) ) }["city"]) . ", " . $obj->{"current_" . strrev( substr( strrev($class), 1) ) }["state"] . " " . $obj->{"current_" . strrev( substr( strrev($class), 1) ) }["zip"];
            }

            unset($obj);
        }

        return $name;
    }

    function show_po_details($passed_hash=NULL, $report='status_report', $doit_print=NULL) {

        if ( $this->ajax_vars['pstr'] ) {

            $multi = true;
            $proposal_hash = explode("|", $this->ajax_vars['pstr']);
            $report_hash = $this->ajax_vars['report_hash'];
            $report = ($this->ajax_vars['report_type'] ? $this->ajax_vars['report_type'] : 'status_report');
            $simple_view = $this->ajax_vars['simple_view'];
        } elseif ( $this->ajax_vars['proposal_hash'] ) {

            $proposal_hash = array($this->ajax_vars['proposal_hash']);
            $report = ($this->ajax_vars['report_type'] ? $this->ajax_vars['report_type'] : 'status_report');
            $report_hash = $this->ajax_vars['report_hash'];
        } elseif ( $passed_hash ) {

            $proposal_hash = array($passed_hash);
            $report_hash = $this->report_hash;
            $local = 1;
        }

        if ( $local && ( ! $this->total_rows || ! is_numeric($this->total_rows) ) ) {

            $r = $this->db->query("SELECT FOUND_ROWS() AS t");
            $this->total_rows = $this->db->result($r, 0, 't');
        }

        for ( $i = 0; $i < count($proposal_hash); $i++ ) {

            if ( $proposal_hash[$i] ) {

                if ( $report == 'status_report' ) {

                    $po = new purchase_order($proposal_hash[$i], $multi);
                    $po->fetch_purchase_orders(0, $po->total);

                    $lines = new line_items($po->proposal_hash);

                    $tbl = "
                    <table class=\"tborder\" cellspacing=\"0\" cellpadding=\"7\" style=\"width:95%;\" >
                        <tr style=\"font-weight:bold;background-color:#efefef;\">
                            <td></td>
                            <td style=\"font-size:8pt;\" nowrap >
                                Vendor / Product or Service
                                <div style=\"padding-top:5px;\">PO No.</div>
                            </td>
                            <td style=\"font-size:8pt;vertical-align:bottom;\" nowrap>Order Date</td>
                            <td style=\"font-size:8pt;vertical-align:bottom;\" nowrap>Ack No.</td>
                            <td style=\"font-size:8pt;vertical-align:bottom;\" nowrap>Ship Date</td>
                            <td style=\"font-size:8pt;vertical-align:bottom;\" nowrap>Receive Date</td>
                            <td style=\"font-size:8pt;vertical-align:bottom;\" nowrap>Shipping To</td>
                        </tr>
                        <tr>
                            <td colspan=\"7\" style=\"background-color:#cccccc;\"></td>
                        </tr>";

                    for ( $j = 0; $j < $po->total; $j++ ) {

                        $po->fetch_po_record($po->proposal_hash, $po->po_info[$j]['po_hash']);
                        if ( $multi && $j == 0 )
                            $proposal_hash[$i] = $po->current_po['proposal_hash'];

                        $ship_date = $po->fetch_ship_dates($po->po_info[$j]['po_hash']);
                        $time += 30;
                        if ( defined('PO_DATE_ALERT') && $ship_date[0] && ( strtotime($details[$i]['actual_install_date'] ? $details[$i]['actual_install_date'] : date("Y-m-d") ) - strtotime($ship_date[0]) ) / 86400 >= PO_DATE_ALERT ) {

                            $po_date_flag = true;
                            $po_alert = "<img src=\"images/alert.gif\" alt=\"Storage notification may be required for this purchase order!\" />&nbsp;&nbsp;";
                        } else
                            unset($po_alert);

                        $ack_no = $po->fetch_ack_no($po->po_info[$j]['po_hash']);
                        $receive_date = $po->fetch_receive_dates($po->po_info[$j]['po_hash']);

                        $tbl .= "
                        <tr " . ( $po->po_info[$j]['punch'] == 1 ? "style=\"background-color:#ffff00;\" title=\"Punchlist\"" : NULL ) . ">
                            <td style=\"width:18px;padding:3px;vertical-align:top;\" rowspan=\"2\">" .
                            ( $this->p->ck('purchase_order', 'E') ?
                                "<a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'get_items', 'po_hash={$po->po_info[$j]['po_hash']}', 'proposal_hash={$proposal_hash[$i]}');\">
                                    <img src=\"images/edit_po_item.gif\" border=\"0\" alt=\"Update acknowledgement numbers, shipping &amp; receiving dates for this purchase order.\">
                                </a>" : NULL
                            ) . "
                                <div id=\"poListHolder{$po->po_info[$j]['po_hash']}\"></div>
                            </td>
                            <td colspan=\"5\" style=\"font-size:8pt;font-style:italic;padding-bottom:0;\">" .
                                stripslashes($po->po_info[$j]['vendor_name']) .
                                ( $po->current_po['po_product'] ?
                                    ": " . stripslashes($po->current_po['po_product']) : ": Various Products"
                                ) . "
                            </td>
                            <td style=\"font-size:8pt;vertical-align:bottom;width:150px;\" rowspan=\"2\">".strrev(substr(strrchr(strrev($this->ship_to($po->po_info[$j]['ship_to_hash'])), "<br />"), 1))."</td>
                        </tr>
                        <tr " . ( $po->po_info[$j]['punch'] == 1 ? "style=\"background-color:#ffff00;\" title=\"Punchlist\"" : NULL ) . ">
                            <td style=\"width:100px;font-size:8pt;\" >" .
                            ( $this->p->ck('purchase_order', 'V') ?
                                "<a href=\"javascript:void(0);\" onClick=\"agent.call('purchase_order', 'sf_loadcontent', 'show_popup_window', 'edit_po', 'proposal_hash={$po->proposal_hash}', 'po_hash={$po->po_info[$j]['po_hash']}', 'popup_id=line_item');\" title=\"View this purchase order\" class=\"link_standard\">" . $po->po_info[$j]['line_items'][0] . $po->po_info[$j]['po_no'] . "</a>" : $po->po_info[$j]['line_items'][0] . $po->po_info[$j]['po_no']
                            ) . "&nbsp;&nbsp;
                            </td>
                            <td style=\"font-size:8pt;\">" . date(DATE_FORMAT . " " . TIMESTAMP_FORMAT, $po->po_info[$j]['creation_date']) . "</td>
                            <td style=\"font-size:8pt;\" id=\"ack_{$po->po_info[$j]['po_hash']}\">" .
                            ( $po->current_po['fully_ack'] ?
                                "<img src=\"images/check.gif\" alt=\"This purchase order is fully acknowledged.\" />" : NULL
                            ) .
                            ( $ack_no ?
                                " <small>" . implode(", ", $ack_no) . "</small>" : NULL
                            ) . "
                            </td>
                            <td style=\"font-size:8pt;\" id=\"ship_date_{$po->po_info[$j]['po_hash']}\">" .
                            ( $ship_date ?
                                "<small>" . implode(", ", $ship_date) . "</small>" : NULL
                            ) . "
                            </td>
                            <td style=\"font-size:8pt;\" id=\"receive_date_".$po->po_info[$j]['po_hash']."\">" .
                            ( $receive_date ?
                                "<small>" . implode(", ", $receive_date) . "</small>" : NULL
                            ) . "
                            </td>
                        </tr>".($j < $po->total - 1 ? "
                        <tr>
                            <td colspan=\"7\" style=\"background-color:#cccccc;\" ></td>
                        </tr>" : NULL);
                    }

                    $tbl .= "
                    </table>";

                } elseif ($report == 'backlog') {

                    $this->fetch_report_settings($report_hash);
					$work_orders_unack = $this->current_report['work_orders_unack'];
                    if ($simple_view) {
                        $proposal_totals = $this->fetch_backlog_items($proposal_hash[$i], 1, 1);

                        // Find total applied credits and deduct from cost for Trac #1447
                        $r = $this->db->query("SELECT SUM(vp.amount) AS total_credits
												FROM vendor_payables vp
												LEFT JOIN purchase_order po
												ON vp.po_hash = po.po_hash
												WHERE po.proposal_hash =
													( SELECT proposals.proposal_hash
										              FROM proposals
										              WHERE proposals.obj_id = ".$proposal_hash[$i]."
													)
												AND vp.deleted = 0 and vp.type = 'C'");
						$total_credits = $this->db->result($r, 0, 'total_credits');

						if ($total_credits)
							$_SESSION['backlog_total'][$report_hash][$proposal_totals['sales_hash']]['cost'] -= $total_credits;

                        $_SESSION['backlog_total'][$report_hash][$proposal_totals['sales_hash']]['cost'] += $proposal_totals['ext_cost'];
                        $_SESSION['backlog_total'][$report_hash][$proposal_totals['sales_hash']]['sell'] += $proposal_totals['ext_sell'];
                    } else {
                    	if (!$doit_print)
	                        $tbl = "
	                        <table style=\"width:99%;border:1px solid #cccccc\" cellpadding=\"3\" cellspacing=\"0\">
	                            <tr>
	                                <td style=\"background-color:#efefef;font-size:8pt;width:40px;\">Qty</td>
	                                <td style=\"background-color:#efefef;font-size:8pt;width:100px\">Item No.</td>
	                                <td style=\"background-color:#efefef;font-size:8pt;width:200px\">Item Descr.</td>
	                                <td style=\"background-color:#efefef;font-size:8pt;width:95px;\">Ack No.</td>
	                                <td style=\"background-color:#efefef;font-size:8pt;width:95px;\">Ship Date</td>
	                                <td style=\"background-color:#efefef;font-size:8pt;width:95px;\">Rcv Date</td>
	                                <td style=\"text-align:right;background-color:#efefef;font-size:8pt;width:75px;\">Ext Cost</td>
	                                <td style=\"text-align:right;background-color:#efefef;font-size:8pt;width:75px;\">Ext Sell</td>
	                                <td style=\"text-align:right;background-color:#efefef;font-size:8pt;width:75px;\">Profit</td>
	                                <td style=\"text-align:right;background-color:#efefef;font-size:8pt;padding-right:10px;width:50px\">GP</td>
	                            </tr>";

                        $proposal_totals = array();
                        $backlog_items = $this->fetch_backlog_items($proposal_hash[$i], $multi);
                        if ($doit_print)
                        	$detail_array[$proposal_hash[$i]] = array();

                        while (list($po_hash, $item_array) = each($backlog_items)) {
                            unset($po_info);
                        	if ($po_hash != 'UNORDERED') {
                                $r = $this->db->query("SELECT purchase_order.po_no , purchase_order.ship_to_hash ,
                                                        vendors.vendor_name , purchase_order.po_product ,
                                                        purchase_order.proposal_hash AS proposal_hash ,
                                                        (
                                                            SELECT COUNT(*) AS Total
                                                            FROM `line_items`
                                                            WHERE line_items.po_hash = purchase_order.po_hash AND line_items.ack_no != ''
                                                        ) AS total_ack_lines ,
                                                        (
                                                            SELECT COUNT(*) AS Total
                                                            FROM `line_items`
                                                            WHERE line_items.po_hash = purchase_order.po_hash AND line_items.status > 0 AND (line_items.ack_no != ''".(!$work_orders_unack ? " OR (!ISNULL(line_items.work_order_hash) AND line_items.work_order_hash != '')" : NULL).")
                                                        ) AS total_unack_lines ,
                                                        (
                                                            SELECT proposals.proposal_no
                                                            FROM proposals
                                                            WHERE proposals.proposal_hash = purchase_order.proposal_hash
                                                        ) AS proposal_no
                                                       FROM purchase_order
                                                       LEFT JOIN vendors ON vendors.vendor_hash = purchase_order.vendor_hash
                                                       WHERE purchase_order.po_hash = '$po_hash'");
                                $po_info = $this->db->fetch_assoc($r);
                            }
                            if ($multi)
                                $proposal_hash[$i] = ($po_info['proposal_hash'] ? $po_info['proposal_hash'] : $item_array[0]['proposal_hash']);

                            if ($po_hash != 'UNORDERED' && !$doit_print)
                                $tbl .= "
                                <tr>
                                    <td style=\"background-color:#ffffff;font-style:italic;font-size:8pt;border-bottom:1px solid #cccccc;border-top:1px solid #cccccc\" colspan=\"10\">
                                        <a href=\"javascript:void(0);\" onClick=\"agent.call('purchase_order', 'sf_loadcontent', 'show_popup_window', 'edit_po', 'po_hash=".$po_hash."', 'proposal_hash=".$proposal_hash[$i]."', 'popup_id=po_win');\" class=\"link_standard\" title=\"View purchase order\">
                                            Purchase Order: ".$po_info['po_no']."</a> : ".$po_info['vendor_name']." : ".$po_info['po_product'].($po_info['total_ack_lines'] > 0 ?
                                                " ".($po_info['total_unack_lines'] == 0 ? "Fully" : "Partially")." Acknowledged" : NULL)."
                                        <div style=\"margin:5px;15px;\">
                                            ".$this->ship_to($po_info['ship_to_hash'])."
                                        </div>
                                    </td>
                                </tr>";

							$border = "border-bottom:1px solid #cccccc;";
                            for ($j = 0; $j < count($item_array); $j++) {

								if ( $j >= count($item_array) - 1 )
									unset($border);

                            	if ($item_array[$j]['item_hash'])
                            		$proposal_totals['cost'] += $item_array[$j]['ext_cost'];
                            	else
                            		$proposal_totals['cost'] -= $item_array[$j]['credit_amount'];

                                $proposal_totals['sell'] += $item_array[$j]['ext_sell'];


								if ( ! $doit_print ) {

									if ($item_array[$j]['item_hash']) {

										$_margin = math::gp_margin( array(
											'cost'	=>	$item_array[$j]['ext_cost'],
											'sell'	=>	$item_array[$j]['ext_sell']
										) );

                                		$tbl .= "
		                                <tr onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className=''\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_item', 'proposal_hash=".$proposal_hash[$i]."', 'item_hash=".$item_array[$j]['item_hash']."', 'popup_id=item_win');\" title=\"View line item\">
										<td style=\"font-size:8pt;$border\">{$item_array[$j]['qty']}</td>
										<td style=\"font-size:8pt;$border\">" .
										( $item_array[$j]['item_no'] ?
										stripslashes($item_array[$j]['item_no']) : "&nbsp;"
										) . "
										</td>
										<td style=\"font-size:8pt;$border\" " .
										( strlen($item_array[$j]['item_descr']) > 32 ?
			                                    "title=\"" . htmlspecialchars($item_array[$j]['item_descr']) . "\"" : NULL
										) .
		                                    ">" .
										( strlen($item_array[$j]['item_descr']) > 32 ?
										stripslashes( substr($item_array[$j]['item_descr'], 0, 29) ) . "..." : stripslashes($item_array[$j]['item_descr'])
										) . "&nbsp;
										</td>
										<td style=\"font-size:8pt;$border\">" .
										( $item_array[$j]['ack_no'] ?
										stripslashes($item_array[$j]['ack_no']) : "&nbsp;"
										) . "
										</td>
										<td style=\"font-size:8pt;$border\">" .
										( $item_array[$j]['ship_date'] ?
										date(DATE_FORMAT, strtotime($item_array[$j]['ship_date'])) : "&nbsp;"
										) . "
										</td>
										<td style=\"font-size:8pt;$border\">" .
										( $item_array[$j]['receive_date'] ?
										date(DATE_FORMAT, strtotime($item_array[$j]['receive_date'])) : "&nbsp;"
										) . "
										</td>
										<td style=\"text-align:right;font-size:8pt;$border\">" .
										( bccomp($item_array[$j]['ext_cost'], 0, 2) == -1 ?
		                                        "(\$" . number_format( bcmul($item_array[$j]['ext_cost'], -1, 2), 2) . ")" : "\$" . number_format($item_array[$j]['ext_cost'], 2)
										) . "
		                                    </td>
										<td style=\"text-align:right;font-size:8pt;$border\">" .
										( bccomp($item_array[$j]['ext_sell'], 0, 2) == -1 ?
		                                        "(\$" . number_format( bcmul($item_array[$j]['ext_sell'], -1, 2), 2) . ")" : "\$" . number_format($item_array[$j]['ext_sell'], 2)
										) . "
		                                    </td>
										<td style=\"text-align:right;font-size:8pt;$border\">" .
										( bccomp( bcsub($item_array[$j]['ext_sell'], $item_array[$j]['ext_cost'], 2), 0, 2) == -1 ?
		                                        "(\$" . number_format( bcmul( bcsub($item_array[$j]['ext_sell'], $item_array[$j]['ext_cost'], 2), -1, 2), 2) . ")" : "\$" . number_format( bcsub($item_array[$j]['ext_sell'], $item_array[$j]['ext_cost'], 2), 2)
										) . "
		                                    </td>
										<td style=\"text-align:right;font-size:8pt;$border" .
										( defined('MARGIN_FLAG') && bccomp($_margin, (float)MARGIN_FLAG, 4) == -1 ?
			                                    "color:#ff0000;" : NULL
										) .
		                                    "padding-right:5px;\">" .
										( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ?
		                                        "(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . ")" : (float)bcmul($_margin, 100, 4)
										) . "%
		                                    </td>
		                                </tr>";
                            		} else {

                            			if ($this->p->ck('payables', 'V'))
											$credit_no = "<a href=\"javascript:void(0);\" onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$item_array[$j]['credit_hash']."', 'popup_id=line_item');\" title=\"View this credit\" class=\"link_standard\">".$item_array[$j]['credit_no']."</a>";
										else
											$credit_no = $item_array[$j]['credit_no'];
                            			$tbl .= "
		                                <tr>
										<td style=\"font-size:8pt;$border\" colspan=\"2\">Applied Credit</td>
										<td style=\"font-size:8pt;$border\" colspan=\"4\">$credit_no</td>
										<td style=\"text-align:right;font-size:8pt;$border\">(\$" . number_format($item_array[$j]['credit_amount'], 2) . ")</td>
										<td style=\"font-size:8pt;$border\" colspan=\"3\">&nbsp;</td>
		                                </tr>";
                            		}
                                }
							}

                            $sales_hash = $item_array[0]['sales_hash'];

                            if ( $doit_print ) {

                            	$detail_array[$proposal_hash[$i]][$po_hash] = array(
                                	'po_info'		=>	$po_info,
                            		'item_array'	=>	$item_array,
                            		'sales_hash'	=>	$sales_hash,
                            		'totals'		=>	$proposal_totals
                                );
                            }
                        }

						if ( ! $doit_print ) {

							$_margin = math::gp_margin( array(
	                        	'cost'	=>	$proposal_totals['cost'],
	                        	'sell'	=>	$proposal_totals['sell']
							) );

	                        $tbl .= "
	                            <tr>
	                                <td style=\"background-color:#efefef;text-align:right;font-weight:bold;font-size:8pt;border-top:1px solid #cccccc;padding-right:5px;\" colspan=\"6\">
	                                    <div style=\"padding-top:5px;padding-right:10px;\">Totals for Proposal ".$po_info['proposal_no'].":</div>
	                                </td>
	                                <td style=\"background-color:#efefef;text-align:right;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;padding-right:5px;\">
	                                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".($proposal_totals['cost'] < 0 ?
	                                        "($".number_format($proposal_totals['cost'] * -1, 2).")" : "$".number_format($proposal_totals['cost'], 2))."

	                                    </div>
	                                </td>
	                                <td style=\"background-color:#efefef;text-align:right;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;padding-right:5px;\">
	                                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".($proposal_totals['sell'] < 0 ?
	                                        "($".number_format($proposal_totals['sell'] * -1, 2).")" : "$".number_format($proposal_totals['sell'], 2))."

	                                    </div>
	                                </td>
	                                <td style=\"background-color:#efefef;text-align:right;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;padding-right:5px;\">
	                                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".($proposal_totals['sell'] - $proposal_totals['cost'] < 0 ?
	                                        "($".number_format(($proposal_totals['sell'] - $proposal_totals['cost']) * -1, 2).")" : "$".number_format($proposal_totals['sell'] - $proposal_totals['cost'], 2))."

	                                    </div>
	                                </td>
	                                <td style=\"background-color:#efefef;text-align:right;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;padding-right:5px;\">
	                                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">" .
										( bccomp( bcmul($_margin, 100, 4), 0, 4) == -1 ?
				                                        "(" . (float)bcmul( bcmul($_margin, 100, 4), -1, 4) . ")" : (float)bcmul($_margin, 100, 4)
										) . "%
	                                    </div>
	                                </td>
	                            </tr>
	                        </table>";
						}

                        if ($report_hash) {
                            $_SESSION['backlog_total'][$report_hash][$sales_hash]['cost'] += $proposal_totals['cost'];
                            $_SESSION['backlog_total'][$report_hash][$sales_hash]['sell'] += $proposal_totals['sell'];
                        }
                    }

                }
                if ($doit_print)
					return $detail_array;

                if ($local)
                    return $tbl;

                if ($tbl) {
                    $this->content['html']['po_holder'.$proposal_hash[$i]] = $tbl;
                    $this->content['jscript'][] = "toggle_display('po_holder".$proposal_hash[$i]."', 'block');";
                }
            }
        }
        if ($tbl && $multi)
            $this->content['jscript'][] = "remote_fetch();";


        return;
    }


    function get_items($po_hash=NULL, $proposal_hash=NULL) {
        if (!$po_hash)
            $po_hash = $this->ajax_vars['po_hash'];
        if (!$proposal_hash)
            $proposal_hash = $this->ajax_vars['proposal_hash'];

        $po = new purchase_order($proposal_hash);
        $po->fetch_po_record($proposal_hash, $po_hash);
        $lines = new line_items($proposal_hash);

        $item_menu = array();

        for ($k = 0; $k < $po->current_po['total_items']; $k++) {
            $result = $this->db->query("SELECT `ack_no` , `item_descr` , `ship_date` , `receive_date`
                                        FROM `line_items`
                                        WHERE `item_hash` = '".$po->current_po['line_items'][$k]."'");
            $ship_date = ($this->db->result($result, 0, 'ship_date') != '0000-00-00' ? $this->db->result($result, 0, 'ship_date') : NULL);
            $receive_date = ($this->db->result($result, 0, 'receive_date') != '0000-00-00' ? $this->db->result($result, 0, 'receive_date') : NULL);
            $item_menu[] = "
            <div style=\"font-size:8pt;padding:0 0 5px 5px;\" ".($this->db->result($result, 0, 'ack_no') ? "title=\"This line item has already been acknowledged!\"" : NULL).">
                ".$this->form->checkbox("name=po_line[]", "value=".$po->current_po['line_items'][$k], "checked").
                "&nbsp;".(strlen($this->db->result($result, 0, 'item_descr')) > 45 ?
                    substr($this->db->result($result, 0, 'item_descr'), 0, 43)."..." : $this->db->result($result, 0, 'item_descr')).
                "<div style=\"margin-left:5px;margin-bottom:5px;font-style:italic;\">".($this->db->result($result, 0, 'ack_no') ?
                    "<br />Ack No: ".$this->db->result($result, 0, 'ack_no') : NULL).($ship_date ?
                    "<br />Shipping: ".$ship_date : NULL).($receive_date ?
                    "<br />Received: ".$receive_date : NULL)."
                </div>
            </div>";
        }

        $time += 30;

        $tbl = $this->form->form_tag()."
        <div id=\"poList".$po_hash."\" class=\"function_menu\" style=\"width:465px;display:block;\">
            <div style=\"float:right;padding:3px\">
                <a href=\"javascript:void(0);\" onClick=\"toggle_display('poList".$po_hash."', 'none');\"><img src=\"images/close.gif\" border=\"0\"></a>
            </div>
            <div class=\"function_menu_item\" style=\"font-weight:bold;background-color:#365082;color:#ffffff;\">
                Enter PO Information Below:".($po->current_po['fully_ack'] ? "
                    <span style=\"padding-left:5px;font-style:italic;font-weight:normal;\">(fully acknowledged)</span>" : NULL)."
            </div>
            <table cellpadding=\"0\" cellspacing=\"1\" style=\"width:100%;\">
                <tr>
                    <td style=\"width:40%;background-color:#bbc7ce;\">
                        <div style=\"color:#000000;height:86px;margin-right:1px;overflow:auto;\">
                            ".@implode("", $item_menu)."
                        </div>
                    </td>
                    <td style=\"width:60%;background-color:#bbc7ce;\">
                        <table style=\"width:100%;\" cellpadding=\"5\" cellspacing=\"0\">
                            <tr>
                                <td style=\"text-align:right;width:35%;padding-right:5px;border-bottom:1px solid #ffffff;color:#000000;\">Ack No:</td>
                                <td style=\"border-bottom:1px solid #ffffff;\">".$this->form->text_box("name=ack_no", "value=", "size=25")."</td>
                            </tr>
                        </table>
                        <table style=\"width:100%;\" cellpadding=\"5\" cellspacing=\"0\">
                            <tr>
                                <td style=\"text-align:right;width:35%;padding-right:5px;border-bottom:1px solid #ffffff;color:#000000;\">Ship Date: </td>
                                <td style=\"border-bottom:1px solid #ffffff;color:#000000;\" id=\"po_ship_date".$po_hash."\">";
                                $this->content['jscript'][] = "setTimeout('DateInput(\'ship_date\', false, \'YYYY-MM-DD\', \'\', 1, \'po_ship_date".$po_hash."\')', ".$time.");";
                                $tbl .= "
                                </td>
                            </tr>
                        </table>
                        <table style=\"width:100%;\" cellpadding=\"5\" cellspacing=\"0\">
                            <tr>
                                <td style=\"text-align:right;width:35%;padding-right:5px;color:#000000;\">Receive Date: </td>
                                <td id=\"po_receive_date".$po_hash."\" style=\"color:#000000;\">";
                                $this->content['jscript'][] = "setTimeout('DateInput(\'receive_date\', false, \'YYYY-MM-DD\', \'\', 1, \'po_receive_date".$po_hash."\')', ".($time + 15).");";
                                $tbl .= "
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan=\"2\" style=\"padding:5px;background-color:#bbc7ce;\">
                        <div style=\"float:right;\">".$this->form->button("value=Save", "onclick=submit_form(this.form, 'purchase_order', 'exec_post', 'refresh_form', 'method=tag', 'proposal_hash=".$proposal_hash."', 'po_hash=".$po_hash."', 'jscript_action=agent.call(\'reports\', \'sf_loadcontent\', \'cf_loadcontent\', \'show_po_details\', \'proposal_hash:".$proposal_hash."\');');window.setTimeout('toggle_display(\'poList".$po_hash."\', \'none\');', 1000);")."</div>
                        [<small><a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"if(confirm('Are you sure you want to erase all the acknowledgement information stored for this PO?')){submit_form(\$('receive_date').form, 'reports', 'exec_post', 'refresh_form', 'action=doit_status_report', 'method=clear_ack_info', 'proposal_hash=$proposal_hash', 'po_hash=".$po_hash."');}\">clear all acknowledgement info</a></small>]
                    </td>
                </tr>
            </table>
        </div>".$this->form->close_form();

        $this->content['html']['poListHolder'.$po_hash] = $tbl;
        return;
    }


	/**
	 * Return a correctly formatted dollar amount string given a decimal number. Returns null if 0.
	 * Ex:  format_dollars(47282.492) returns $47, 282.49
	 * Ex2: format_dollars(-52.22) returns ($52.22)
	 * Ex3: format_dollars(0) returns NULL
	 */
	function format_dollars($number) {
		return ($number != 0 ? ($number < 0 ? "($".number_format($number * -1, 2).")" : "$".number_format($number, 2)) : NULL);
	}
	/**
	 * Return a correctly formatted dollar amount string given a decimal number. Returns $0.00 if 0.
	 * Ex:  format_dollars(47282.492) returns $47, 282.49
	 * Ex2: format_dollars(-52.22) returns ($52.22)
	 * Ex3: format_dollars(0) returns $0.00
	 */
	function format_dollars_show_zero($number) {
		return ($number != 0 ? ($number < 0 ? "($".number_format($number * -1, 2).")" : "$".number_format($number, 2)) : "$0.00");
	}
	/**
	 * Remove shared reports from a user's view, without deleting the actual report.
	 *
	 * @param string $report_hash
	 * @param string $user_hash
	 */
	function doit_delete_share($report_hash=NULL, $user_hash=NULL) {

		$report_hash = ($report_hash ? $report_hash : $_POST['report_hash']);

		if (!$report_hash) {
			$this->content['page_feedback'] = "This report cannot be removed from your view.";
			$this->content['action'] = 'continue';
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}
		if(!$user_hash)
			$user_hash = $_SESSION['id_hash'];

		$r = $this->db->query("SELECT COUNT(*) as total FROM `reports_share`
							  WHERE report_hash = '$report_hash' AND user_hash = '$user_hash'");

		if ($this->db->result($r, 0, 'total') < 1) {
			$this->content['page_feedback'] = "This report has been shared to a group and not you personally, so it cannot be removed from your view.";
			$this->content['action'] = 'continue';
			$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
			return;
		}

		$this->db->query("DELETE FROM `reports_share`
						  WHERE report_hash = '$report_hash' AND user_hash = '$user_hash'");

		$this->content['page_feedback'] = "The shared report has been removed from your view.";
		$this->content['action'] = 'continue';
		$this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
		return;

	}

    function addnote() {
        $proposal_hash = $this->ajax_vars['proposal_hash'];
        if ($note_hash = $this->ajax_vars['note_hash']) {
            $result = $this->db->query("SELECT `note_hash` , `note` , `type`
                                        FROM `proposal_notes`
                                        WHERE `note_hash` = '$note_hash'");
            if ($row = $this->db->fetch_assoc($result)) {
                $current_note = $row;
                $valid = true;
            }
        }

        $this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
        $this->content['popup_controls']['popup_title'] = ($valid ? "Edit Proposal Note" : "Create A New Proposal Note");

        $tbl .= $this->form->form_tag().
        $this->form->hidden(array("proposal_hash" => $proposal_hash,
                                  "note_hash"     => $current_note['note_hash'],
                                  "popup_id"      => $this->popup_id))."
        <div class=\"panel\" id=\"main_table".$this->popup_id."\" style=\"margin-top:0\">
            <div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
                <h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
                    <p id=\"feedback_message".$this->popup_id."\"></p>
            </div>
            <table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
                <tr>
                    <td style=\"background-color:#ffffff;padding:15px 20px;\">
                        <table >
                            <tr>
                                <td style=\"vertical-align:top;padding-left:20px;\">
                                    <div style=\"padding-bottom:5px;font-weight:bold;\">Type: </div>
                                    ".$this->form->select("type", array("Proposal Note", "Design Note", "Install Note"), ($valid ? $current_note['type'] : 'p'), array('p', 'd', 'i'), "blank=1")."
                                </td>
                            </tr>
                            <tr>
                                <td style=\"vertical-align:top;padding-left:20px;\">
                                    <div style=\"padding-bottom:5px;font-weight:bold;\" id=\"err2".$this->popup_id."\">Note: </div>
                                    ".$this->form->text_area("name=note", "rows=7", "cols=75", "value=".($valid ? stripslashes($current_note['note']) : ''))."
                                </td>
                            </tr>
                            <tr>
                                <td style=\"vertical-align:bottom;\">
                                    <div style=\"text-align:left;padding:15px;\">
                                        ".$this->form->button("value=Save Note", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_addnote');")."
                                        ".($valid ? "
                                        &nbsp;&nbsp;
                                        ".$this->form->button("value=Delete Note", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_addnote', 'rm=1');") : NULL)."
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>".
        $this->form->close_form();

        $this->content['popup_controls']["cmdTable"] = $tbl;

        return;
    }

    function doit_addnote() {
        $proposal_hash = $_POST['proposal_hash'];
        $type = $_POST['type'];
        $note = trim($_POST['note']);
        $note_hash = $_POST['note_hash'];

        if ($note) {
            if ($note_hash) {
                if ($_POST['rm'] == 1) {
                    $this->db->query("DELETE FROM `proposal_notes`
                                      WHERE `note_hash` = '$note_hash'");
                    $this->content['page_feedback'] = "Note has been removed.";
                } else {
                    $this->db->query("UPDATE `proposal_notes`
                                      SET `timestamp` = ".time()." , `type` = '$type' , `note` = '".addslashes($note)."'
                                      WHERE `note_hash` = '$note_hash'");
                    $this->content['page_feedback'] = "Note has been saved.";
                }
            } else {
                $note_hash = md5(global_classes::get_rand_id(32, "global_classes"));
                while (global_classes::key_exists('proposal_notes', 'note_hash', $note_hash))
                    $note_hash = md5(global_classes::get_rand_id(32, "global_classes"));

                $this->db->query("INSERT INTO `proposal_notes`
                                  (`timestamp` , `note_hash` , `type` , `proposal_hash` , `user_hash` , `note`)
                                  VALUES(".time()." , '$note_hash' , '$type' , '$proposal_hash' , '".$this->current_hash."' , '".addslashes($note)."')");
                $this->content['page_feedback'] = "Note has been saved.";
            }
            $this->content['jscript_action'] = "agent.call('status_reports', 'sf_loadcontent', 'cf_loadcontent', 'fetch_proposal_notes', 'proposal_hash=$proposal_hash');";
        } else
            $this->content['page_feedback'] = "No changes have been made.";

        $this->content['action'] = "close";
        $this->content['html']['note_table_holder'.$proposal_hash] = $this->fetch_proposal_notes($proposal_hash);
        return;
    }

    function vendor_1099($step=NULL) {
        $this->unlock("_");

        if ($step) {
            $this->fetch_report_settings($this->report_hash);
            $tbl = $this->form->form_tag().
            $this->form->hidden(array('test'        =>  1,
                                      'popup_id'    =>  '',
                                      'timeframe'   =>  $this->current_report['report_year']))."
            <table class=\"tborder\" cellspacing=\"0\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
                <tr>
                    <td style=\"width:100%;background-color:#ffffff;padding:10px 10px 0 10px;\" colspan=\"3\">
                        <h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
                            ".($this->current_report['saved'] ?
                                $this->current_report['report_name'] : "Vendor 1099 Report")."
                            <span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
                                [<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'vendor_1099', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
                            </span>
                        </h3>
                        <div style=\"margin-left:20px;margin-bottom:5px;\">
                            <small style=\"margin-left:20px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
                            &nbsp;&nbsp;
                            <a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=vendor_1099_std', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print standard report\" /></a>
                            &nbsp;&nbsp;
                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it_xls', 'type=vendor_1099_std', 'report_hash=".$this->report_hash."', 'popup_id=xls_win');\" ><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>
                        </div>
                        <div style=\"font-weight:normal;\">
                            <div style=\"float:right;margin-right:10px;\">
                                Your Federal ID Number: ".$this->form->text_box("name=tax_id",
                                                                                "value=".(defined('TAX_ID_NUMBER') ? TAX_ID_NUMBER : NULL),
                                                                                "onChange=if(this.value){agent.call('system_config', 'sf_loadcontent', 'cf_loadcontent', 'silent_update', 'var_name=TAX_ID_NUMBER', 'var_val='+this.value);}")."
                            </div>
                            <div style=\"margin-left:15px;font-weight:bold;margin-top:15px;margin-bottom:5px;font-size:9pt;\">".$this->report_title."</div>
                        </div>
                    </td>
                </tr>
                <tr class=\"thead\" style=\"font-weight:bold;\">
                    <td style=\"width:250px;text-align:left;\">Vendor</td>
                    <td style=\"text-align:left;\">Tax ID</td>
                    <td style=\"text-align:right;\">Payment Amount</td>
                </tr>";

            $irs_1099 = array(0     =>  '1 - Rents',
                              1     =>  '2 - Royalties',
                              2     =>  '3 - Other income',
                              3     =>  '4 - Federal income tax withheld',
                              4     =>  '5 - Fishing boat proceeds',
                              5     =>  '6 - Medical and health care payments',
                              6     =>  '7 - Nonemployee compensation',
                              7     =>  '8 - Substitute payments in lieu of dividends or interest',
                              8     =>  '9 - Payer made direct sales of $5, 000 or more of consumer products to a buyer (recipient) for resale',
                              9     =>  '10 - Crop insurance proceeds',
                              10    =>  '11',
                              11    =>  '12',
                              12    =>  '13 - Excess golden parachute payments',
                              13    =>  '14 - Gross proceeds paid to an attorney',
                              14    =>  '15a - Section 409A deferrals',
                              15    =>  '15b - Section 409A income',
                              16    =>  '16 - State tax withheld',
                              17    =>  '17 - State/Payer\'s state no.',
                              18    =>  '18 - State income');


            if (is_array($this->results)) {
                for ($i = 0; $i < $this->total; $i++) {
                    $tbl .= "
                    <tr>
                        <td style=\"text-align:left;background-color:#ffffff;border-bottom:1px solid #cccccc;\">" .
                            stripslashes($this->results[$i]['vendor_name']) . " - " .
                            ( $this->results[$i]['street'] ?
                                stripslashes($this->results[$i]['street']) . "&nbsp;" : NULL
                            ) .
                            stripslashes($this->results[$i]['city']) . ", {$this->results[$i]['state']} {$this->results[$i]['zip']}
                        </td>
                        <td style=\"text-align:left;background-color:#ffffff;border-bottom:1px solid #cccccc;\">
                            {$this->results[$i]['tax_id']}&nbsp;
                        </td>
                        <td style=\"text-align:right;background-color:#ffffff;border-bottom:1px solid #cccccc;\">
                            \$" . number_format($this->results[$i]['total_payment'], 2) .
                            $this->form->hidden( array(
                                "total_payment[{$this->results[$i]['vendor_hash']}]" => $this->results[$i]['total_payment']
                            ) ) . "
                        </td>
                    </tr>
                    <tr>
                        <td colspan=\"3\" style=\"background-color:#efefef;\">
                            <div style=\"margin-left:25px;\">
                                <img src=\"images/expand.gif\" onClick=\"shoh('vendor_".$this->results[$i]['vendor_hash']."');\" name=\"imgvendor_".$this->results[$i]['vendor_hash']."\" border=\"0\" />&nbsp;
                                <a href=\"javascript:void(0);\" onClick=\"shoh('vendor_".$this->results[$i]['vendor_hash']."');\" title=\"Show/Hide Proposal Details\" class=\"link_standard\">Review &amp; Print IRS Form 1099-MISC for ".htmlentities(stripslashes($this->results[$i]['vendor_name']), ENT_QUOTES)."</a>
                                <div id=\"vendor_".$this->results[$i]['vendor_hash']."\" style=\"display:none;\">
                                    <div style=\"margin-top:5px;\">
                                        <div style=\"float:right;margin-right:55px;margin-bottom:15px;margin-top:-17px;\">
                                            <a href=\"javascript:void(0);\" onClick=\"print_1099('".$this->results[$i]['vendor_hash']."');\" title=\"Print IRS 1099MISC Form for this Vendor\" class=\"link_standard\"><img src=\"images/print.gif\" border=\"0\" /></a>
                                            <span style=\"font-size:10px;\"><a href=\"javascript:void(0);\" onClick=\"print_1099('".$this->results[$i]['vendor_hash']."');\" title=\"Print IRS 1099MISC Form for this Vendor\" class=\"link_standard\">1099-MISC</a></span>
                                        </div>
                                        <table cellpadding=\"5\" cellspacing=\"1\" style=\"background-color:#cccccc;\">
                                            <tr>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[0]) > 19 ? substr($irs_1099[0], 0, 16)."..." : $irs_1099[0])."</div>
                                                    ".$this->form->text_box("name=1099_1_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
                                                                            "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right;",
                                                                            (strlen($irs_1099[0]) > 19 ? "title=".$irs_1099[0] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[1]) > 19 ? substr($irs_1099[1], 0, 16)."..." : $irs_1099[1])."</div>
                                                    ".$this->form->text_box("name=1099_2_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
                                                                            "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[1]) > 19 ? "title=".$irs_1099[1] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[2]) > 19 ? substr($irs_1099[2], 0, 16)."..." : $irs_1099[2])."</div>
                                                    ".$this->form->text_box("name=1099_3_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[2]) > 19 ? "title=".$irs_1099[2] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[3]) > 19 ? substr($irs_1099[3], 0, 16)."..." : $irs_1099[3])."</div>
                                                    ".$this->form->text_box("name=1099_4_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[3]) > 19 ? "title=".$irs_1099[3] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[4]) > 19 ? substr($irs_1099[4], 0, 16)."..." : $irs_1099[4])."</div>
                                                    ".$this->form->text_box("name=1099_5_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[4]) > 19 ? "title=".$irs_1099[4] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[5]) > 19 ? substr($irs_1099[5], 0, 16)."..." : $irs_1099[5])."</div>
                                                    ".$this->form->text_box("name=1099_6_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[5]) > 19 ? "title=".$irs_1099[5] : NULL))."
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[6]) > 19 ? substr($irs_1099[6], 0, 16)."..." : $irs_1099[6])."</div>
                                                    ".$this->form->text_box("name=1099_7_".$this->results[$i]['vendor_hash'],
                                                                            "value=".number_format($this->results[$i]['total_payment'], 2),
                                                                            "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[6]) > 19 ? "title=".$irs_1099[6] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[7]) > 19 ? substr($irs_1099[7], 0, 16)."..." : $irs_1099[7])."</div>
                                                    ".$this->form->text_box("name=1099_8_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[7]) > 19 ? "title=".$irs_1099[7] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[8]) > 19 ? substr($irs_1099[8], 0, 16)."..." : $irs_1099[8])."</div>
                                                    ".$this->form->checkbox("name=1099_9_".$this->results[$i]['vendor_hash'],
                                                                            "value=1",
                                                                            "style=background-color:#ffffff;",
                                                                            (strlen($irs_1099[8]) > 19 ? "title=".$irs_1099[8] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[9]) > 19 ? substr($irs_1099[9], 0, 16)."..." : $irs_1099[9])."</div>
                                                    ".$this->form->text_box("name=1099_10_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[9]) > 19 ? "title=".$irs_1099[9] : NULL))."
                                                </td>
                                                <td style=\"background-color:#efefef;font-size:10px;vertical-align:top;\">
                                                    <div style=\"margin-bottom:3px;\">11 / 12</div>
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[12]) > 19 ? substr($irs_1099[12], 0, 16)."..." : $irs_1099[12])."</div>
                                                    ".$this->form->text_box("name=1099_13_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
                                                                            "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[12]) > 19 ? "title=".$irs_1099[12] : NULL))."
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[13]) > 19 ? substr($irs_1099[13], 0, 16)."..." : $irs_1099[13])."</div>
                                                    ".$this->form->text_box("name=1099_14_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[13]) > 19 ? "title=".$irs_1099[13] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[14]) > 19 ? substr($irs_1099[14], 0, 16)."..." : $irs_1099[14])."</div>
                                                    ".$this->form->text_box("name=1099_15a_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[14]) > 19 ? "title=".$irs_1099[14] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[15]) > 19 ? substr($irs_1099[15], 0, 16)."..." : $irs_1099[15])."</div>
                                                    ".$this->form->text_box("name=1099_15b_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[15]) > 19 ? "title=".$irs_1099[15] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[16]) > 19 ? substr($irs_1099[16], 0, 16)."..." : $irs_1099[16])."</div>
                                                    ".$this->form->text_box("name=1099_16_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[16]) > 19 ? "title=".$irs_1099[16] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[17]) > 19 ? substr($irs_1099[17], 0, 16)."..." : $irs_1099[17])."</div>
                                                    ".$this->form->text_box("name=1099_17_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
															                "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[17]) > 19 ? "title=".$irs_1099[17] : NULL))."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">".(strlen($irs_1099[18]) > 19 ? substr($irs_1099[18], 0, 16)."..." : $irs_1099[18])."</div>
                                                    ".$this->form->text_box("name=1099_18_".$this->results[$i]['vendor_hash'],
                                                                            "value=",
                                                                            "onBlur=if(this.value){this.value=formatCurrency(this.value);}",
                                                                            "style=width:75px;background-color:#ffffff;text-align:right",
                                                                            (strlen($irs_1099[18]) > 19 ? "title=".$irs_1099[18] : NULL))."
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\" colspan=\"2\">
                                                    <div style=\"margin-bottom:3px;\">Vendor Account No.</div>
                                                    ".$this->form->text_box("name=1099_f_acctno_".$this->results[$i]['vendor_hash'], "value=", "style=width:150px;background-color:#ffffff;")."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">2nd TIN not.</div>
                                                    ".$this->form->checkbox("name=1099_f_tin_".$this->results[$i]['vendor_hash'],
                                                                            "value=1",
                                                                            "style=background-color:#ffffff;")."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">VOID</div>
                                                    ".$this->form->checkbox("name=1099_f_void_".$this->results[$i]['vendor_hash'],
                                                                            "value=1",
                                                                            "style=background-color:#ffffff;")."
                                                </td>
                                                <td style=\"background-color:#ffffff;font-size:10px;vertical-align:bottom;\">
                                                    <div style=\"margin-bottom:3px;\">CORRECTED</div>
                                                    ".$this->form->checkbox("name=1099_f_corrected_".$this->results[$i]['vendor_hash'],
                                                                            "value=1",
                                                                            "style=background-color:#ffffff;")."
                                                </td>
                                                <td style=\"background-color:#efefef;font-size:10px;vertical-align:bottom;\">&nbsp;</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>";
                }

                $this->content['jscript'][] = "
                print_1099 = function() {
                    var vendor_hash = arguments[0];

                    var str = '';
                    str += 'f1='+URLEncode(\$F('1099_1_'+vendor_hash))+'&';
                    str += 'f2='+URLEncode(\$F('1099_2_'+vendor_hash))+'&';
                    str += 'f3='+URLEncode(\$F('1099_3_'+vendor_hash))+'&';
                    str += 'f4='+URLEncode(\$F('1099_4_'+vendor_hash))+'&';
                    str += 'f5='+URLEncode(\$F('1099_5_'+vendor_hash))+'&';
                    str += 'f6='+URLEncode(\$F('1099_6_'+vendor_hash))+'&';
                    str += 'f7='+URLEncode(\$F('1099_7_'+vendor_hash))+'&';
                    str += 'f8='+URLEncode(\$F('1099_8_'+vendor_hash))+'&';
                    str += 'f9='+(\$('1099_9_'+vendor_hash).checked ? '1' : '0')+'&';
                    str += 'f10='+URLEncode(\$F('1099_10_'+vendor_hash))+'&';
                    str += 'f13='+URLEncode(\$F('1099_13_'+vendor_hash))+'&';
                    str += 'f14='+URLEncode(\$F('1099_14_'+vendor_hash))+'&';
                    str += 'f15a='+URLEncode(\$F('1099_15a_'+vendor_hash))+'&';
                    str += 'f15b='+URLEncode(\$F('1099_15b_'+vendor_hash))+'&';
                    str += 'f16='+URLEncode(\$F('1099_16_'+vendor_hash))+'&';
                    str += 'f17='+URLEncode(\$F('1099_17_'+vendor_hash))+'&';
                    str += 'f18='+URLEncode(\$F('1099_18_'+vendor_hash))+'&';
                    str += 'vendor_hash='+vendor_hash+'&';
                    str += 'tax_id='+URLEncode(\$F('tax_id'))+'&';
                    str += 'vendor_acctno='+URLEncode(\$F('1099_f_acctno_'+vendor_hash))+'&';
                    str += 'vendor_tinNot='+(\$('1099_f_tin_'+vendor_hash).checked ? '1' : '0')+'&';
                    str += 'f_void='+(\$('1099_f_void_'+vendor_hash).checked ? '1' : '0')+'&';
                    str += 'f_corrected='+(\$('1099_f_corrected_'+vendor_hash).checked ? '1' : '0') + '&';
                    str += 'year=' + \$F('timeframe');

                    window.open('print.php?t=".base64_encode("vendor_1099")."&' + str);
                }
                ";
            } else
                $tbl .= "
                <tr style=\"background-color:#ffffff;\">
                    <td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"3\">There are no results to show.</td>
                </tr>";

            $tbl .= "
            </table>";

            return $tbl;
        } else {
            $report_hash = $this->ajax_vars['report_hash'];
            $this->fetch_report_settings($report_hash);

            $this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
            if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
                unset($report_hash);

            if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
                $this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);

            $tbl = $this->form->form_tag().
            $this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
            <div class=\"panel\">
                <div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
                    <h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
                        <p id=\"feedback_message".$this->popup_id."\"></p>
                </div>
                <table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
                    <tr>
                        <td style=\"padding:0;\">
                             <div style=\"background-color:#ffffff;height:100%;\">
                                <div style=\"margin:15px 35px;\">
                                    <div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
                                        ".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_vendor_1099');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
                                            "&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_vendor_1099', 'rm=1');") : NULL)."
                                    </div>
                                    <h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
                                        $this->current_report['report_name'] : "Vendor 1099 Report")."</h3>
                                    <table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">
                                                Filtered to specific vendors?
                                                <div style=\"font-size:90%;font-style:italic;margin-top:3px\">Vendor 1099 flag must be set</div>
                                            </td>
                                            <td style=\"background-color:#ffffff;vertical-align:middle;\">
                                                ".$this->form->text_box("name=vendor",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'vendor', 'vendor_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".($this->current_report['vendor_filter'] ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
                                                if (is_array($this->current_report['vendor_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++)
                                                        $tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">".
                                                $this->form->select("timeframe",
                                                                    array("Payments dated this year", "Payments dated last year", "Payments dated from " . date("Y", strtotime(date("Y-m-d") . "-2 years"))),
                                                                    $this->current_report['timeframe'],
                                                                    array(1, 2, 3),
                                                                    "blank=1") . "
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
                                                <div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
                                                    What should the report be called?
                                                    <br />
                                                    ".$this->form->text_box("name=report_name",
                                                                            "value=".$this->current_report['report_name'],
                                                                            "autocomplete=off",
                                                                            "size=30",
                                                                            "style=margin-top:5px;margin-bottom:10px;"
                                                                            )."
                                                    <br />
                                                    Optional description for the report:
                                                    <br />
                                                    ".$this->form->text_area("name=report_descr",
                                                                            "value=".$this->current_report['report_descr'],
                                                                            "rows=3",
                                                                            "cols=50",
                                                                            "style=margin-top:5px;"
                                                                            )."
                                                    <div style=\"padding-top:5px\">
                                                        ".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
                                                        <div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
                                                            Share to the following users:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                            Share to the following groups:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>".
            $this->form->close_form();

            $this->content['popup_controls']["cmdTable"] = $tbl;
            $this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
            $this->content['jscript'] = $jscript;

            return;
        }
    }

    function doit_vendor_1099() {
        $date = date("U") - 3600;
        $result = $this->db->query("DELETE FROM `reports`
                                    WHERE `saved` = 0 AND `timestamp` <= '$date'");

        if ($_POST['rm'] == 1 && $_POST['report_hash']) {
            $this->db->query("DELETE reports.* , reports_share.*
                              FROM `reports`
                              LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
                              WHERE reports.report_hash = '".$_POST['report_hash']."'");
            $this->content['action'] = 'close';
            $this->content['page_feedback'] = "Report has been deleted.";
            $this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
            return;
        }

        $doit_print = $_POST['doit_print'];
        $report_hash = $_POST['report_hash'];
        $from_saved = $this->ajax_vars['from_saved'];

        if ($doit_print && $report_hash || $from_saved) {
            $this->fetch_report_settings($report_hash);

            $showdetail = $this->current_report['showdetail'];
            $timeframe = $this->current_report['timeframe'];
            $vendor_filter = $this->current_report['vendor_filter'];
            if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);

        } else {
        	$showdetail = $_POST['showdetail'];
            $timeframe = $_POST['timeframe'];
            $vendor_filter = $_POST['vendor_filter'];
            if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);
        }

        $save = $_POST['save'];
        $saved_cat = "ar_report";
        $report_name = $_POST['report_name'];
        $report_descr = $_POST['report_descr'];
        $share = $_POST['share'];
        $sales_rep_share = $_POST['sales_rep_share'];
        $group_share = $_POST['group_share'];
        if (!$save)
            unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
        if ($save && !$report_name) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
        }
        if ($save && !$report_hash) {
            $result = $this->db->query("SELECT COUNT(*) AS Total
                                        FROM `reports`
                                        WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
            if ($this->db->result($result)) {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
            }
        }
        if ($share && !count($sales_rep_share) && !count($group_share)) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
        }

        if (($timeframe == 5 && $sort_to_date && $sort_from_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you select a valid date range.";
        }

        if ($this->content['error'])
            return;

        switch ($timeframe) {
            case 1:
            $sql_p[] = "t3.posting_date BETWEEN '".date("Y")."-01-01' AND '".date("Y")."-12-31'";
            $this->report_title = " dated this year, ".date("Y");
            $report_year = date("y");
            break;

            case 2:
            $sql_p[] = "t3.posting_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31'";
            $this->report_title = " dated last year, ".date("Y", strtotime(date("Y-m-d")." -1 year"));
            $report_year = date("y", strtotime(date("Y-m-d")." -1 year"));
            break;

            case 3:
            $sql_p[] = "t3.posting_date BETWEEN '".date("Y", strtotime(date("Y-m-d")." -2 years"))."-01-01' AND '".date("Y", strtotime(date("Y-m-d")." -2 years"))."-12-31'";
            $this->report_title = " dated last year, ".date("Y", strtotime(date("Y-m-d")." -2 years"));
            $report_year = date("y", strtotime(date("Y-m-d")." -2 years"));
            break;

        }

        if (is_array($vendor_filter) && count($vendor_filter)) {
            $vendor_filter = array_unique($vendor_filter);
            $vendor_filter = array_values($vendor_filter);
            array_walk($vendor_filter, 'add_quotes', "'");
            $sql_p[] = "t1.vendor_hash IN (".implode(" , ", $vendor_filter).")";
            array_walk($vendor_filter, 'strip_quotes');
        }

        if ($sql_p)
            $sql = implode(" AND ", $sql_p);

        $str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|vendor_filter=".@implode("&", $vendor_filter)."|showdetail=$showdetail|report_year=$report_year";

        if (!$report_hash) {
            $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
            while (global_classes::key_exists('reports', 'report_hash', $report_hash))
                $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

            $this->db->query("INSERT INTO `reports`
                              (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
                              VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

            if ($share && (count($group_share) || count($sales_rep_share))) {
                for ($i = 0; $i < count($group_share); $i++)
                    $this->db->query("INSERT INTO `reports_share`
                                      (`report_hash` , `group_hash`)
                                      VALUES ('$report_hash' , '".$group_share[$i]."')");

                for ($i = 0; $i < count($sales_rep_share); $i++)
                    $this->db->query("INSERT INTO `reports_share`
                                      (`report_hash` , `user_hash`)
                                      VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
            }
        } elseif (!$from_saved) {
            $existing = true;
            $this->db->query("UPDATE `reports`
                              SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str'
                              WHERE `report_hash` = '$report_hash'");

            if (!$share)
                $this->db->query("DELETE FROM `reports_share`
                                  WHERE `report_hash` = '".$this->report_hash."'");
            else {
                if (!is_array($sales_rep_share))
                    $sales_rep_share = array();
                if (!is_array($group_share))
                    $group_share = array();

                //Share or revoke to users
                $result = $this->db->query("SELECT `user_hash`
                                            FROM `reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_users[] = $row['user_hash'];

                if (!is_array($current_share_users))
                    $current_share_users = array();

                $to_remove = array_diff($current_share_users, $sales_rep_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `reports_share`
                                          WHERE `user_hash` = '".$current_share_users[$i]."'");
                }
                $to_add = array_diff($sales_rep_share, $current_share_users);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `reports_share`
                                          (`report_hash` , `user_hash`)
                                          VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
                }

                //Share or revoke to groups
                $result = $this->db->query("SELECT `group_hash`
                                            FROM `reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_groups[] = $row['group_hash'];

                if (!is_array($current_share_groups))
                    $current_share_groups = array();

                $to_remove = array_diff($current_share_groups, $group_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `reports_share`
                                          WHERE `group_hash` = '".$current_share_groups[$i]."'");
                }
                $to_add = array_diff($group_share, $current_share_groups);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `reports_share`
                                          (`report_hash` , `group_hash`)
                                          VALUES ('$report_hash' , '".$group_share[$i]."'");
                }
            }
        }
        $this->report_hash = $report_hash;

        $result = $this->db->query("SELECT
                                        t2.vendor_name, t2.street, t2.city, t2.state, t2.zip, t2.country, t2.phone, t2.tax_id, t1.vendor_hash,
                                        SUM(t3.payment_amount) AS total_payment
                                    FROM vendor_payables t1
                                    LEFT JOIN vendor_payment t3 ON t3.invoice_hash = t1.invoice_hash
                                    LEFT JOIN check_register t4 ON t4.check_no = t3.check_no AND t4.account_hash = t3.account_hash
                                    LEFT JOIN vendors t2 ON t2.vendor_hash = t1.vendor_hash
                                    WHERE $sql AND t1.type = 'I' AND t2.1099 = 1 AND t4.void = 0 AND ! ISNULL(t2.vendor_name)
                                    GROUP BY t1.vendor_hash
                                    HAVING total_payment > 600
                                    ORDER BY t2.vendor_name ASC");
        while ($row = $this->db->fetch_assoc($result))
            $this->results[] = $row;



        if ($from_report)
            $this->content['action'] = 'continue';
        else
            $this->content['action'] = 'close';

        $this->report_title = "Payments ".$this->report_title;
        $this->total = count($this->results);
        $this->content['html']['place_holder'] = $this->vendor_1099(1);
        return;
    }

    function wip_report($step=NULL, $active_limit_start=NULL) {
        $this->unlock("_");

        bcscale(2);
        if ($step) {
            $showdetail = $this->current_report['showdetail'];
            if ($this->current_report['proposal_filter']) {
            	$proposal_filter = $this->current_report['proposal_filter'];
            	if (!is_array($proposal_filter))
                    $proposal_filter = array($proposal_filter);

	            $proposal_filter = array_unique($proposal_filter);
	            $proposal_filter = array_values($proposal_filter);
	            array_walk($proposal_filter, 'add_quotes', "'");
            }

            echo "
            <table class=\"tborder\" cellspacing=\"0\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:1090px;margin-top:0;\"  id=\"reports_data_table\">
                <tr>
                    <td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"9\">
                        <h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
                            ".($this->current_report['saved'] ?
                                $this->current_report['report_name'] : "Work In Progress Report").($this->p->ck('reports', 'V', 'ap') ? "
                            <span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
                                [<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'wip_report', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
                            </span>" : NULL)."
                            <div style=\"margin-left:15px;margin-top:10px;margin-bottom:10px;font-size:10pt;\">".$this->report_title."</div>
                        </h3>
                        <small style=\"margin-left:20px;margin-bottom:5px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
                        &nbsp;&nbsp;
                        <a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=wip_report', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
                        &nbsp;&nbsp;
                        <a href=\"xls_print.php?t=".base64_encode(__METHOD__)."&h={$this->report_hash}\" ><img src=\"images/excel.gif\" alt=\"Export\" border=\"0\" /></a>
                    </td>
                </tr>
                <tr class=\"thead\" style=\"font-weight:bold;\">
                    <td style=\"width:130px;padding:5px 5px 5px 30px;vertical-align:bottom;\">PO No.</td>
                    <td style=\"width:85px;padding:5px;vertical-align:bottom;text-align:right;\">Last Entry</td>
                    <td style=\"width:125px;padding:5px;vertical-align:bottom;text-align:right;\">Total Cost</td>
                    <td style=\"width:125px;padding:5px;vertical-align:bottom;text-align:right;\">Total Sell</td>
                    <td style=\"width:125px;padding:5px;vertical-align:bottom;text-align:right;\">Profit</td>
                    <td style=\"width:125px;padding:5px;vertical-align:bottom;text-align:right;\">WIP Debits</td>
                    <td style=\"width:125px;padding:5px;vertical-align:bottom;text-align:right;\">WIP Credits</td>
                    <td style=\"width:125px;padding:5px;vertical-align:bottom;text-align:right;\">Reconciled</td>
                    <td style=\"width:125px;padding:5px;vertical-align:bottom;text-align:right;\">WIP Balance</td>
                </tr>";

            $l = $cost = $sell = $dr = $cr = $reconciled = 0;
            $current_loop = array();
            $r = $this->db_obj->query("SELECT t1.po_hash , t1.proposal_hash , t1.proposal_no , t1.ap_invoice_hash , t1.ar_invoice_hash ,
	                                   SUM(t1.ap_total) AS ap_wip_total , SUM(t1.ar_total) AS ar_wip_total , SUM(t1.reconciled_total) AS reconciled
	                                   FROM _tmp_reports_data_wip t1".(count($proposal_filter) ? "
	                                   WHERE t1.proposal_hash IN (".implode(" , ", $proposal_filter).")" : NULL)."
	                                   GROUP BY t1.po_hash , t1.proposal_hash ".($this->current_report['wip_balance'] == 1 || $this->current_report['wip_balance'] == 2 ? "
	                                       HAVING (IFNULL(ap_wip_total, 0) - IFNULL(ar_wip_total, 0) - IFNULL(reconciled, 0))".($this->current_report['wip_balance'] == 1 ? " != 0 " : " = 0") : NULL)."
	                                   ORDER BY t1.proposal_no , t1.po_hash ASC", 1);
            while ($row = $this->db_obj->fetch_assoc($r)) {
            	# Print the totals for each proposal
                if (count($current_loop) > 0 && $row['proposal_hash'] != $current_loop['proposal_hash']) {
                    echo "
                    <tr style=\"background-color:#ffffff\">
                        <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;\">&nbsp;</td>
                        <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;\">&nbsp;</td>
                        <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                            <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($cost, 0) == -1 ?
                                "($".number_format(bcmul($cost, -1), 2).")" : "$".number_format($cost, 2))."
                            </div>
                        </td>
                        <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                            <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($sell, 0) == -1 ?
                                "($".number_format(bcmul($sell, -1), 2).")" : "$".number_format($sell, 2))."
                            </div>
                        </td>
                        <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                            <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp(bcsub($sell, $cost), 0) == -1 ?
                                "($".number_format(bcmul(bcsub($sell, $cost), -1), 2).")" : "$".number_format(bcsub($sell, $cost), 2))."
                            </div>
                        </td>
                        <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                            <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($dr, 0) == -1 ?
                                "($".number_format(bcmul($dr, -1), 2).")" : "$".number_format($dr, 2))."
                            </div>
                        </td>
                        <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                            <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($cr, 0) == -1 ?
                                "($".number_format(bcmul($cr, -1), 2).")" : "$".number_format($cr, 2))."
                            </div>
                        </td>
                        <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                            <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($reconciled, 0) == -1 ?
                                "($".number_format(bcmul($reconciled, -1), 2).")" : "$".number_format($reconciled, 2))."
                            </div>
                        </td>
                        <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                            <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($net, 0) == -1 ?
                                "($".number_format(bcmul($net, -1), 2).")" : "$".number_format($net, 2))."
                            </div>
                        </td>
                    </tr>";

                    $total_cost = bcadd($total_cost, $cost);
                    $total_sell = bcadd($total_sell, $sell);
                    $total_dr = bcadd($total_dr, $dr);
                    $total_cr = bcadd($total_cr, $cr);
                    $total_reconciled = bcadd($total_reconciled, $reconciled);

                    $l = $cost = $sell = $dr = $cr = $reconciled = $net = 0;
                }

                if (count($current_loop) == 0 || (count($current_loop) > 0 && $row['proposal_hash'] != $current_loop['proposal_hash'])) {
                	$r_2 = $this->db->query("SELECT t1.proposal_descr , t3.customer_name
                                             FROM proposals t1
                                             LEFT JOIN customers t3 ON t3.customer_hash = t1.customer_hash
                                             WHERE t1.proposal_hash = '{$row['proposal_hash']}'");
                    $proposal_detail = $this->db->fetch_assoc($r_2);

	                $m++;
	                echo "
	                <tr style=\"background-color:#efefef;\">
	                    <td style=\"padding-left:15px;border-bottom:1px solid #cccccc;\" colspan=\"9\">
	                        Proposal: <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$row['proposal_hash']."', 'popup_id=proposal_win', 'from_report=1')\">".$row['proposal_no']."</a> -
	                        ".$proposal_detail['customer_name']." -
	                        ".$proposal_detail['proposal_descr']."
	                    </td>
	                </tr>";
                }
                if ($showdetail == 1 || ($showdetail == 2 && $row['po_hash'] != $current_loop['po_hash'])) {
                    $dr = bcadd($dr, $row['ap_wip_total']);
                    $cr = bcadd($cr, $row['ar_wip_total']);
                    $reconciled = bcadd($reconciled, $row['reconciled']);
                    $net = bcadd($net, bcsub($row['ap_wip_total'], bcsub($row['ar_wip_total'], $row['reconciled'])));
                    $item_array = array();
                    $cost = $sell = 0;
                    if ($row['po_hash']) {
	                    $r_2 = $this->db->query("SELECT SUM(t2.cost * t2.qty) AS total_cost , SUM(t2.sell * t2.qty) AS total_sell ,
	                                             t1.po_no , t1.order_amount
	                                             FROM purchase_order t1
	                                             LEFT JOIN line_items t2 ON t2.po_hash = t1.po_hash
	                                             WHERE t1.po_hash = '{$row['po_hash']}'
	                                             GROUP BY t1.po_hash");
	                    $item_array = $this->db->fetch_assoc($r_2);
                        $cost = bcadd($cost, $item_array['total_cost']);
                        $sell = bcadd($sell, $item_array['total_sell']);
                    }

                    unset($last_entry);
                    if ($row['po_hash']) {
	                    $r_2 = $this->db->query("SELECT DISTINCT t1.invoice_date
											     FROM vendor_payables AS t1
											     LEFT JOIN vendor_payable_expenses t2 ON t2.invoice_hash = t1.invoice_hash
											     WHERE t1.po_hash = '{$row['po_hash']}' AND t2.account_hash = '{$this->current_report['default_wip_account']}' AND t1.deleted = 0
											     UNION ALL
											     SELECT DISTINCT t1.invoice_date
											     FROM customer_invoice AS t1
											     LEFT JOIN line_items t2 ON t2.invoice_hash = t1.invoice_hash
											     WHERE t2.po_hash = '{$row['po_hash']}' AND t2.wip_account_hash = '{$this->current_report['default_wip_account']}' AND t2.direct_bill_amt != 'C' AND t1.deleted = 0
											     ORDER BY invoice_date DESC");
	                    while ($row_2 = $this->db->fetch_assoc($r_2)) {
	                        if (!$last_entry || strtotime($row_2['invoice_date']) > strtotime($last_entry))
	                            $last_entry = $row_2['invoice_date'];
	                    }
                    }
                    echo "
                    <tr style=\"background-color:#ffffff\">
                        <td style=\"padding-left:30px;".($l == 0 ? "padding-top:10px;" : NULL)."\">".($row['po_hash'] ? "
                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('purchase_order', 'sf_loadcontent', 'show_popup_window', 'edit_po', 'po_hash={$row['po_hash']}', 'proposal_hash={$row['proposal_hash']}', 'popup_id=line_item')\">{$item_array['po_no']}</a>" : "Work Orders")."
                        </td>
                        <td style=\"text-align:right;".($l == 0 ? "padding-top:10px;" : NULL)."\">".($last_entry['last_date'] ?
                            date(DATE_FORMAT, strtotime($last_entry)) : "&nbsp;")."
                        </td>
                        <td style=\"text-align:right;".($l == 0 ? "padding-top:10px;" : NULL)."\">".($row['po_hash'] ?
                            (bccomp($item_array['total_cost'], 0) == -1 ?
                                "($".number_format(bcmul($item_array['total_cost'], -1), 2).")" : "$".number_format($item_array['total_cost'], 2)) : "N/A")."
                        </td>
                        <td style=\"text-align:right;".($l == 0 ? "padding-top:10px;" : NULL)."\">".($row['po_hash'] ?
                            (bccomp($item_array['total_sell'], 0) == -1 ?
                                "($".number_format(bcmul($item_array['total_sell'], -1), 2).")" : "$".number_format($item_array['total_sell'], 2)) : "N/A")."
                        </td>
                        <td style=\"text-align:right;".($l == 0 ? "padding-top:10px;" : NULL)."\">".($row['po_hash'] ?
                            (bccomp(bcsub($item_array['total_sell'], $item_array['total_cost']), 0) == -1 ?
                                "($".number_format(bcmul(bcsub($item_array['total_sell'], $item_array['total_cost']), -1), 2).")" : "$".number_format(bcsub($item_array['total_sell'], $item_array['total_cost']), 2)) : "N/A")."
                        </td>
                        <td style=\"text-align:right;".($l == 0 ? "padding-top:10px;" : NULL)."\">".(bccomp($row['ap_wip_total'], 0) == -1 ?
                            "($".number_format(bcmul($row['ap_wip_total'], -1), 2).")" : "$".number_format($row['ap_wip_total'], 2))."
                        </td>
                        <td style=\"text-align:right;".($l == 0 ? "padding-top:10px;" : NULL)."\">".(bccomp($row['ar_wip_total'], 0) == -1 ?
                            "($".number_format(bcmul($row['ar_wip_total'], -1), 2).")" : "$".number_format($row['ar_wip_total'], 2))."
                        </td>
                        <td style=\"text-align:right;".($l == 0 ? "padding-top:10px;" : NULL)."\">".($row['po_hash'] ?
                            (bccomp($row['reconciled'], 0) == -1 ?
                                "($".number_format(bcmul($row['reconciled'], -1), 2).")" : "$".number_format($row['reconciled'], 2)) : "N/A")."
                        </td>
                        <td style=\"text-align:right;".($l == 0 ? "padding-top:10px;" : NULL)."\">".(bccomp(bcsub($row['ap_wip_total'], bcsub($row['ar_wip_total'], $row['reconciled'])), 0) == -1 ?
                            "($".number_format(bcmul(bcsub($row['ap_wip_total'], bcsub($row['ar_wip_total'], $row['reconciled'])), -1), 2).")" : "$".number_format(bcsub($row['ap_wip_total'], bcsub($row['ar_wip_total'], $row['reconciled'])), 2))."
                        </td>
                    </tr>";

                    $l++;
                }

                $current_loop = $row;
            }

            echo "
            <tr style=\"background-color:#ffffff\">
                <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;\">&nbsp;</td>
                <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;\">&nbsp;</td>
                <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($cost, 0) == -1 ?
                        "($".number_format(bcmul($cost, -1), 2).")" : "$".number_format($cost, 2))."
                    </div>
                </td>
                <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($sell, 0) == -1 ?
                        "($".number_format(bcmul($sell, -1), 2).")" : "$".number_format($sell, 2))."
                    </div>
                </td>
                <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp(bcsub($sell, $cost), 0) == -1 ?
                        "($".number_format(bcmul(bcsub($sell, $cost), -1), 2).")" : "$".number_format(bcsub($sell, $cost), 2))."
                    </div>
                </td>
                <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($dr, 0) == -1 ?
                        "($".number_format(bcmul($dr, -1), 2).")" : "$".number_format($dr, 2))."
                    </div>
                </td>
                <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($cr, 0) == -1 ?
                        "($".number_format(bcmul($cr, -1), 2).")" : "$".number_format($cr, 2))."
                    </div>
                </td>
                <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($reconciled, 0) == -1 ?
                        "($".number_format(bcmul($reconciled, -1), 2).")" : "$".number_format($reconciled, 2))."
                    </div>
                </td>
                <td style=\"".($m < $total ? "border-bottom:1px solid #cccccc;" : NULL)."padding-bottom:10px;padding-top:10px;text-align:right;\">
                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(bccomp($net, 0) == -1 ?
                        "($".number_format(bcmul($net, -1), 2).")" : "$".number_format($net, 2))."
                    </div>
                </td>
            </tr>";

            $total_cost = bcadd($total_cost, $cost);
            $total_sell = bcadd($total_sell, $sell);
            $total_dr = bcadd($total_dr, $dr);
            $total_cr = bcadd($total_cr, $cr);
            $total_reconciled = bcadd($total_reconciled, $reconciled);

            $l = $cost = $sell = $dr = $cr = $reconciled = 0;

            $r = $this->db_obj->query("SELECT SUM(t1.ap_total) AS wip_ap_total , SUM(t1.ar_total) AS wip_ar_total ,
	                                   SUM(t1.reconciled_total) AS reconciled_total ,
	                                   (SUM(t1.ap_total) - SUM(t1.ar_total) - SUM(t1.reconciled_total)) AS wip_net_total
	                                   FROM _tmp_reports_data_wip t1".($proposal_filter ? "
	                                   WHERE t1.proposal_hash IN (".implode(" , ", $proposal_filter).")" : NULL).($this->current_report['wip_balance'] == 1 || $this->current_report['wip_balance'] == 2 ? "
                                       HAVING IFNULL(wip_net_total, 0) ".($this->current_report['wip_balance'] == 1 ? "!= 0" : "= 0") : NULL));

            $wip_totals = $this->db_obj->fetch_assoc($r);

            echo "
                <tr id=\"table_content_control\">
                    <td style=\"background-color:#ffffff;padding-top:10px;\" colspan=\"9\"></td>
                </tr>
                <tr >
                    <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" colspan=\"2\">&nbsp;</td>
                    <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" class=\"num_field\">
                        <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\" id=\"report_cost\">".(bccomp($total_cost, 0) == -1 ?
                            "($".number_format(bcmul($total_cost, -1), 2).")" : "$".number_format($total_cost, 2))."
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" class=\"num_field\">
                        <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\" id=\"report_sell\">".(bccomp($total_sell, 0) == -1 ?
                            "($".number_format(bcmul($total_sell, -1), 2).")" : "$".number_format($total_sell, 2))."
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" class=\"num_field\">
                        <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\" id=\"report_profit\">".(bccomp(bcsub($total_sell, $total_cost), 0) == -1 ?
                            "($".number_format(bcmul(bcsub($total_sell, $total_cost), -1), 2).")" : "$".number_format(bcsub($total_sell, $total_cost), 2))."
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" class=\"num_field\">
                        <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\" id=\"report_dr\">".(bccomp($wip_totals['wip_ap_total'], 0) == -1 ?
                            "($".number_format(bcmul($wip_totals['wip_ap_total'], -1), 2).")" : "$".number_format($wip_totals['wip_ap_total'], 2))."
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" class=\"num_field\">
                        <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\" id=\"report_cr\">".(bccomp($wip_totals['wip_ar_total'], 0) == -1 ?
                            "($".number_format(bcmul($wip_totals['wip_ar_total'], -1), 2).")" : "$".number_format($wip_totals['wip_ar_total'], 2))."
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" class=\"num_field\">
                        <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\" id=\"report_reconciled\">".(bccomp($wip_totals['reconciled_total'], 0) == -1 ?
                            "($".number_format(bcmul($wip_totals['reconciled_total'], -1), 2).")" : "$".number_format($wip_totals['reconciled_total'], 2))."
                        </div>
                    </td>
                    <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" class=\"num_field\">
                        <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\" id=\"report_net\">".(bccomp($wip_totals['wip_net_total'], 0) == -1 ?
                            "($".number_format(bcmul($wip_totals['wip_net_total'], -1), 2).")" : "$".number_format($wip_totals['wip_net_total'], 2))."
                        </div>
                    </td>
                </tr>
            </table>
            </div>";

        } else {
            $report_hash = $this->ajax_vars['report_hash'];
            $this->fetch_report_settings($report_hash);

            array_shift($this->user_name);
            array_shift($this->user_hash);

            if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
                $this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);

            $this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
            if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
                unset($report_hash);

            $tbl = $this->form->form_tag().
            $this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
            <div class=\"panel\">
                <div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
                    <h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
                        <p id=\"feedback_message".$this->popup_id."\"></p>
                </div>
                <table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
                    <tr>
                        <td style=\"padding:0;\">
                             <div style=\"background-color:#ffffff;height:100%;\">
                                <div style=\"margin:15px 35px;\">
                                    <div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
                                        ".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_wip_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
                                            "&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_wip_report', 'rm=1');") : NULL)."
                                    </div>
                                    <h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
                                        $this->current_report['report_name'] : "Work In Progress Report")."</h3>
                                    <table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">".
                                                $this->form->select("timeframe",
                                                                     array("All dates",
                                                                           "WIP transactions dated this year",
                                                                           "WIP transactions dated last year",
                                                                           "WIP transactions from the current period",
                                                                           "WIP transactions from the previous period",
                                                                           "A specific date range"),
                                                                     $this->current_report['timeframe'],
                                                                     array('*', 1, 2, 3, 4, 5),
                                                                     "onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}",
                                                                     "blank=1")."
                                                <div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
                                                    <span id=\"sort_from_date_holder\"></span>
                                                    <span id=\"sort_to_date_holder\"></span>";
                                                $jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
                                                $jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
                                                $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=proposal",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'proposal', 'proposal_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
                                                if (is_array($this->current_report['proposal_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++)
                                                        $tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Should the report reflect<br />paid or unpaid invoices?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("wip_balance",
                                                                       array("Show only WIP transactions with an open balance", "Show only WIP transactions with a zero balance"),
                                                                       $this->current_report['wip_balance'],
                                                                       array(1, 2))."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("showdetail",
                                                                      array("Show Simple View", "Show Detail View"),
                                                                      $this->current_report['showdetail'],
                                                                      array('1', '2'),
                                                                      "blank=1")."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Output Method: </td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("output",
                                                                      array("Print to Screen", "Print to PDF", "Print to Excel"),
                                                                      $this->current_report['output'],
                                                                      array('htm', 'pdf', 'xls'),
                                                                      "blank=1")."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
                                                <div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
                                                    What should the report be called?
                                                    <br />
                                                    ".$this->form->text_box("name=report_name",
                                                                            "value=".$this->current_report['report_name'],
                                                                            "autocomplete=off",
                                                                            "size=30",
                                                                            "style=margin-top:5px;margin-bottom:10px;"
                                                                            )."
                                                    <br />
                                                    Optional description for the report:
                                                    <br />
                                                    ".$this->form->text_area("name=report_descr",
                                                                            "value=".$this->current_report['report_descr'],
                                                                            "rows=3",
                                                                            "cols=50",
                                                                            "style=margin-top:5px;"
                                                                            )."
                                                    <div style=\"padding-top:5px\">
                                                        ".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
                                                        <div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
                                                            Share to the following users:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                            Share to the following groups:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>".
            $this->form->close_form();

            $this->content['popup_controls']["cmdTable"] = $tbl;
            $this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
            $this->content['jscript'] = $jscript;

            return;
        }
    }

    function doit_wip_report($stream=false, $format=NULL) {

        $this->db->query("DELETE FROM reports
                          WHERE reports.saved = 0 AND reports.timestamp <= UNIX_TIMESTAMP( DATE_SUB(NOW(), INTERVAL 1 HOUR) )");
        if ( $_POST['rm'] && $_POST['report_hash'] ) {

        	$fb = "Report has been deleted.";
            if ( ! $this->db->query("DELETE t1.*, t2.*
		                             FROM reports t1
		                             LEFT JOIN reports_share t2 ON t2.report_hash = t1.report_hash
		                             WHERE t1.report_hash = '{$_POST['report_hash']}'")
            ) {

            	$this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__);
            	$fb = "Database error encountered during report delete. Unable to delete report.";
            }

            $this->content['action'] = 'close';
            $this->content['page_feedback'] = $fb;
            $this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";

            return;
        }

        $doit_print = $_POST['doit_print'];
        $limit_start = $this->ajax_vars['limit_start'];
        $total_rows = $this->ajax_vars['total_rows'];
        $from_saved = $this->ajax_vars['from_saved'];
        if ( $this->report_hash )
            $report_hash = $this->report_hash;
        else
            $report_hash = $_POST['report_hash'];

        if ( ( $doit_print && $report_hash ) || ( $stream && $report_hash ) || $limit_start || $from_saved ) {

            if ( ! $this->fetch_report_settings($report_hash) )
                return $this->__trigger_error("System error encountered when attempting to lookup report settings. Please reload window and try again.", E_USER_ERROR, __FILE__, __LINE__, 1);

            $timeframe = $this->current_report['timeframe'];
            if ( $timeframe == 5 ) {

                $sort_from_date = $this->current_report['sort_from_date'];
                $sort_to_date = $this->current_report['sort_to_date'];
            }

            $proposal_filter = $this->current_report['proposal_filter'];
            if ( $proposal_filter && ! is_array($proposal_filter) )
                $proposal_filter = array($proposal_filter);

            $showdetail = $this->current_report['showdetail'];
            $wip_balance = $this->current_report['wip_balance'];
        } else {

            $timeframe = $_POST['timeframe'];
            if ( $timeframe == 5 ) {

                $sort_from_date = $_POST['sort_from_date'];
                $sort_to_date = $_POST['sort_to_date'];
            }

            $proposal_filter = $_POST['proposal_filter'];
            if ( $proposal_filter && ! is_array($proposal_filter) )
                $proposal_filter = array($proposal_filter);

            $showdetail = $_POST['showdetail'];
            $wip_balance = $_POST['wip_balance'];
            $output = $_POST['output'];

        }

        if ( ! $stream ) {

	        $save = $_POST['save'];
	        $saved_cat = "ap_report";
	        $report_name = $_POST['report_name'];
	        $report_descr = $_POST['report_descr'];
	        $share = $_POST['share'];
	        $sales_rep_share = $_POST['sales_rep_share'];
	        $group_share = $_POST['group_share'];
	        if ( ! $save )
	            unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);

	        $e = false;
	        if ( $save && ! $report_name ) {

	        	$e = true;
	            $this->__trigger_error("In order to save this report you must give the report a name.", E_USER_ERROR, __FILE__, __LINE__);
	        }
	        if ( $save && ! $report_hash ) {

	            $result = $this->db->query("SELECT COUNT( t1.obj_id ) AS Total
	                                        FROM reports t1
	                                        WHERE t1.owner_hash = '{$this->current_hash}' AND t1.saved = 1 AND t1.report_name = '$report_name'");
	            if ( $this->db->result($result, 0, 'Total') ) {

	                $e = true;
	                $this->__trigger_error("You already have a report saved under the same name! Please make sure you are not creating a duplicate.", E_USER_ERROR, __FILE__, __LINE__);
	            }
	        }

	        if ( $share && ! count($sales_rep_share) && ! count($group_share) ) {

	            $e = true;
	            $this->__trigger_error("In order to share this report please select a user or group to share to.", E_USER_ERROR, __FILE__, __LINE__);
	        }

	        if ( ( $timeframe == 5 && $sort_to_date && $sort_from_date && strtotime($sort_from_date) > strtotime($sort_to_date) ) ) {

	            $e = true;
	            $this->__trigger_error("The sort dates you specified are invalid! Please make sure you select a valid date range.", E_USER_ERROR, __FILE__, __LINE__);
	        }

	        if ( $e )
	            return $this->__trigger_error(false, E_USER_ERROR, __FILE__, __LINE__, 1);
        }

        switch ( $timeframe ) {

            case 1:

            $date_start = date("Y-01-01");
            $date_end = date("Y-12-31");
            $this->report_title = " dated this year";
            break;

            case 2:

            $date_start = date("Y", strtotime( date("Y-m-d") . " -1 year") );
            $date_end = date("Y", strtotime( date("Y-m-d") . " -1 year") ) . "-12-31";
            $compare_date = date("Y-12-31", strtotime( date("Y-m-d") . " -1 year") );
            $this->report_title = " dated last year";
            break;

            case 3:

            $period_info = get_period_info( date("Y-m-d") );
            if ( $period_info['period_start'] ) {

                $date_start = $period_info['period_start'];
                $date_end = $period_info['period_end'];
                $this->report_title = " dated within the current period";

            } else
            	return $this->__trigger_error("You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings", E_USER_ERROR, __FILE__, __LINE__, 1);

            break;

            case 4:

            $period_info = get_period_info( date("Y-m-d") );
            $previos_period_date = date("Y-m-d", strtotime( "{$period_info['period_start']} -1 day") );
            $period_info = get_period_info($previos_period_date);

            if ( $period_info['period_start'] ) {

                $date_start = $period_info['period_start'];
                $date_end = $period_info['period_end'];
                $compare_date = date("Y-m-d", strtotime($period_info['period_end']) );
                $this->report_title = " dated last period";

            } else
                return $this->__trigger_error("You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings", E_USER_ERROR, __FILE__, __LINE__, 1);

            break;

            case 5:

            if ( $sort_from_date && $sort_to_date ) {

                $date_start = $sort_from_date;
                $date_end = $sort_to_date;
                if ( strtotime($sort_to_date) < strtotime( date("Y-m-d") ) )
                    $compare_date = date("Y-m-d", strtotime($sort_to_date) );

                $this->report_title = " dated between " . date(DATE_FORMAT, strtotime($sort_from_date) ) . " and " . date(DATE_FORMAT, strtotime($sort_to_date) );
            } elseif ( ! $sort_to_date && $sort_from_date ) {

                $date_start = $sort_from_date;
                $this->report_title = " dated on or after " . date(DATE_FORMAT, strtotime($sort_from_date) );
            } elseif ( $sort_to_date && ! $sort_from_date ) {

                $date_end = $sort_to_date;
                if ( strtotime($sort_to_date) < strtotime( date("Y-m-d") ) )
                    $compare_date = date("Y-m-d", strtotime($sort_to_date) );

                $this->report_title = " dated on or before " . date(DATE_FORMAT, strtotime($sort_to_date) );

            } elseif ( ! $sort_from_date && ! $sort_to_date )
                unset($timeframe);

            break;

            default:
                $this->report_title = " dated as of " . date(DATE_FORMAT);
        }

        if ( $sql_p )
            $sql = implode(" AND ", $sql_p);

        $default_wip_account = fetch_sys_var('DEFAULT_WIP_ACCT');
        $str = "timeframe=$timeframe|sort_from_date=$sort_from_date|start_date=$start_date|end_date=$end_date|showdetail=$showdetail|sort_to_date=$sort_to_date|proposal_filter=" . implode("&", $proposal_filter) . "|wip_balance=$wip_balance|default_wip_account=$default_wip_account";

        if ( ! $stream ) {

	        if ( ! $report_hash ) {

	            $report_hash = rand_hash('reports', 'report_hash');
	            if ( ! $this->db->query("INSERT INTO reports
			                              VALUES
			                              (
		                                      NULL,
				                              UNIX_TIMESTAMP(), " .
				                              ( $save ? 1 : 0 ) . ",
				                              '$saved_cat',
				                              '$report_hash',
				                              '{$this->current_hash}',
				                              '$report_name',
				                              '$report_descr',
				                              '$str',
				                              '',
				                              '" . __METHOD__ . "',
				                              ''
			                              )")
                ) {

                	return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
                }

	            if ( $share && ( count($group_share) || count($sales_rep_share) ) ) {

	                for ( $i = 0; $i < count($group_share); $i++ ) {

	                    if ( ! $this->db->query("INSERT INTO reports_share
        	                                     VALUES
        	                                     (
				                                     NULL,
				                                     '$report_hash',
				                                     NULL,
				                                     '{$group_share[$i]}'
			                                     )")
                        ) {

                        	return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
                        }
	                }

	                for ( $i = 0; $i < count($sales_rep_share); $i++ ) {

	                    if ( ! $this->db->query("INSERT INTO reports_share
			                                     VALUES
			                                     (
				                                     NULL,
				                                     '$report_hash',
				                                     '{$sales_rep_share[$i]}',
				                                     NULL
			                                     )")
                        ) {

                        	return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
                        }
	                }
	            }

	        } elseif ( ! $from_saved ) {

	            if ( ! $this->db->query("UPDATE reports t1
        	                             SET
        	                             t1.timestamp = UNIX_TIMESTAMP(),
        	                             t1.saved = '$save',
        	                             t1.saved_catagory = '$saved_cat',
        	                             t1.owner_hash = '{$this->current_hash}',
        	                             t1.report_name = '$report_name',
        	                             t1.report_descr = '$report_descr',
        	                             t1.str = '$str'
        	                             WHERE t1.report_hash = '$report_hash'")
                ) {

                	return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
                }

	            if ( ! $share ) {

	                if ( ! $this->db->query("DELETE FROM reports_share
        	                                 WHERE report_hash = '{$this->report_hash}'")
                    ) {

                    	return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
                    }

	            } else {

	                if ( ! is_array($sales_rep_share) )
	                    $sales_rep_share = array();
	                if ( ! is_array($group_share) )
	                    $group_share = array();

	                # Share or revoke to users
	                $current_share_users = array();
	                $result = $this->db->query("SELECT t1.user_hash
	                                            FROM reports_share t1
	                                            WHERE t1.report_hash = '$report_hash'");
	                while ( $row = $this->db->fetch_assoc($result) )
	                    array_push($current_share_users, $row['user_hash']);

	                $to_remove = array_diff($current_share_users, $sales_rep_share);
	                if ( $to_remove ) {

	                    while ( list($i) = each($to_remove) ) {

	                        if ( ! $this->db->query("DELETE FROM reports_share
	                                          WHERE user_hash = '{$current_share_users[$i]}'")
                            ) {

                            	return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
                            }
	                    }
	                }

	                $to_add = array_diff($sales_rep_share, $current_share_users);
	                if ( is_array($to_add) ) {

	                    while ( list($i) = each($to_add) ) {

	                        if ( ! $this->db->query("INSERT INTO reports_share
        	                                         VALUES
        	                                         (
	        	                                         NULL,
	        	                                         '$report_hash',
	        	                                         '{$sales_rep_share[$i]}',
	        	                                         NULL
        	                                         )")
                            ) {

                            	return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
                            }
	                    }
	                }

	                # Share or revoke to groups
	                $current_share_groups = array();
	                $result = $this->db->query("SELECT t1.group_hash
	                                            FROM reports_share t1
	                                            WHERE t1.report_hash = '$report_hash'");
	                while ( $row = $this->db->fetch_assoc($result) )
	                    array_push($current_share_groups, $row['group_hash']);

	                $to_remove = array_diff($current_share_groups, $group_share);
	                if ( $to_remove ) {

	                    while ( list($i) = each($to_remove) ) {

	                        if ( ! $this->db->query("DELETE FROM reports_share
        	                                         WHERE group_hash = '{$current_share_groups[$i]}'")
	                        ) {

	                        	return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
	                        }
	                    }
	                }

	                $to_add = array_diff($group_share, $current_share_groups);
	                if ( $to_add ) {

	                    while ( list($i) = each($to_add) ) {

	                        if ( ! $this->db->query("INSERT INTO reports_share
        	                                         VALUES
        	                                         (
	        	                                         NULL,
	        	                                         '$report_hash',
	        	                                         NULL,
	        	                                         '{$group_share[$i]}'
        	                                         )")
                            ) {

                            	return $this->__trigger_error("{$this->db->errno} - {$this->db->error}", E_DATABASE_ERROR, __FILE__, __LINE__, 1);
                            }
	                    }
	                }
	            }
	        }
        }

        $this->report_hash = $report_hash;

        if ( $stream && ( ! isset($format) || $format == 'htm' ) ) {

            $this->db_obj->query("CALL wip_report(
                '$default_wip_account', " .
                ( $date_start ?
                    "'$date_start'" : "NULL"
                ) . ", " .
                ( $date_end ?
                    "'$date_end'" : "NULL"
                ) . ", " .
                ( $wip_balance ?
                    "$wip_balance" : "0"
                ) . "
            )");

            $this->content['html']['place_holder'] = $this->wip_report(1);
            $this->content['action'] = 'close';

            return;

        } elseif ( $stream && $format == 'PDF' ) {

            $this->db_obj->query("CALL wip_report
	            ('$default_wip_account', " .
	            ( $date_start ?
	                "'$date_start'" : "NULL"
	            ) . ", " .
	            ( $date_end ?
	                "'$date_end'"  : "NULL"
                ) . ", " .
                ( $wip_balance ?
                    "$wip_balance" : "0"
                ) . "
            )");


            return;

        } elseif ( ! $stream && $output == 'pdf' ) {

        	$this->content['action'] = 'close';
            $this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=wip_report', 'report_hash={$this->report_hash}');";

            return;

        } else {

            $this->content['action'] = 'close';
            return $this->stream_report($output, base64_encode(__METHOD__)); # Stream output to XLS
        }
    }

    function show_wip_details($proposal_hash, $po_hash) {

    }

    function wip_report_totals() {
        $report_hash = $this->ajax_vars['report_hash'];

        if ($_SESSION['wip_report_total'][$report_hash]) {
        	$report_totals =& $_SESSION['wip_report_total'][$report_hash];
            $this->content['html']['report_cost'] = (bccomp($report_totals['total_cost'], 0) == -1 ? "($".number_format(bcmul($report_totals['total_cost'], -1), 2).")" : "$".number_format($report_totals['total_cost'], 2));
            $this->content['html']['report_sell'] = (bccomp($_SESSION['wip_report_total'][$report_hash]['total_sell'], 0) == -1 ? "($".number_format(bcmul($report_totals['total_sell'], -1), 2).")" : "$".number_format($report_totals['total_sell'], 2));
            $this->content['html']['report_profit'] = (bccomp($_SESSION['wip_report_total'][$report_hash]['total_profit'], 0) == -1 ? "($".number_format(bcmul($report_totals['total_profit'], -1), 2).")" : "$".number_format($report_totals['total_profit'], 2));
            $this->content['html']['report_dr'] = (bccomp($_SESSION['wip_report_total'][$report_hash]['total_dr'], 0) == -1 ? "($".number_format(bcmul($report_totals['total_dr'], -1), 2).")" : "$".number_format($report_totals['total_dr'], 2));
            $this->content['html']['report_cr'] = (bccomp($_SESSION['wip_report_total'][$report_hash]['total_cr'], 0) == -1 ? "($".number_format(bcmul($report_totals['total_cr'], -1), 2).")" : "$".number_format($report_totals['total_cr'], 2));
            $this->content['html']['report_net'] = (bccomp($_SESSION['wip_report_total'][$report_hash]['total_net'], 0) == -1 ? "($".number_format(bcmul($report_totals['total_net'], -1), 2).")" : "$".number_format($report_totals['total_net'], 2));
            $this->content['html']['report_reconciled'] = (bccomp($_SESSION['wip_report_total'][$report_hash]['total_reconciled'], 0) == -1 ? "($".number_format(bcmul($report_totals['total_reconciled'], -1), 2).")" : "$".number_format($report_totals['total_reconciled'], 2));

            unset($_SESSION['wip_report_total'][$report_hash]);
        }
    }

    function stream_report($output=NULL, $t=NULL) {

    	$this->content['html']['place_holder'] = "
        <div style=\"width:100%;height:100%;margin:0;text-align:center;\">
            <div id=\"loadingreport\" style=\"width:100%;padding-top:50px;padding-bottom:45px;\">

                <h3 style=\"color:#00477f;margin-bottom:5px;display:block;\" >Loading Report...</h3>
                <div style=\"display:block;\"><img src=\"images/file_loading.gif\" /></div>
            </div>
            <iframe src=\"reports_buffer.php?h={$this->report_hash}&output=$output&t=$t&stream=-1\" id=\"reports_window\" allowtransparency=\"true\" frameborder=\"0\" marginwidth=\"0\" marginheight=\"0\" style=\"display:none;width:100%;position:relative;top:0;left:0;\" onReadyStateChange=\"if( this.readyState == 4 || this.readyState == 'complete' ){ \$('loadingreport').hide();\$(this).show(); }\"></iframe>
        </div>";

        return;
    }

    function set_report_hash($h) {
    	if ($h)
            $this->report_hash = $h;

    }
    /**
     * Check run report added for Trac #1433
     *
     * Report options include
	 *  by date/date range
	 *	by check #
	 *	by Payee Name
	 *	by Acct #
	 *	by cleared / not cleared
	 *	by voided / not voided
     *
     * @param boolean $step
     */
    function check_run($step=NULL) {

        $this->unlock("_");

        if ( $step ) {

            $this->fetch_report_settings($this->report_hash);

            echo "
            <table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:1090px;height:100%;margin-top:0;\" id=\"reports_data_table\">
                <tr>
                    <td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"10\">
                        <h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">" .
                            ( $this->current_report['saved'] ?
                                stripslashes($this->current_report['report_name']) : "Check Run Report"
                            ) .
                            ( $this->p->ck('reports', 'V', 'check_run') ?
	                            "<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
	                                [<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'check_run', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
	                            </span>" : NULL
                            ) . "
                            <div style=\"margin-left:15px;margin-top:10px;margin-bottom:10px;font-size:10pt;\">" . stripslashes($this->current_report['report_title']) . "</div>
                        </h3>
                        <div style=\"margin-left:20px;margin-bottom:5px;margin-top:20px;\">
                            <small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
                            <span style=\"padding-left:30px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=check_run', 'report_hash={$this->report_hash}');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a></span>
                        </div>
                    </td>
                </tr>
                <tr class=\"thead\" style=\"font-weight:bold;\">
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\">Check No.</td>
                	<td style=\"width:100px;padding:5px;vertical-align:bottom;\">Date</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\">Type</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\">Reference</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Amount</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Discounts</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Deposits</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Credits</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Credit No.</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Payment</td>
                </tr>";

			$sql = stripslashes($this->current_report['sql']);
			$r = $this->db->query("SELECT * FROM _tmp_reports_data_check_run".($sql ? "
								   WHERE $sql" : NULL)."
								   GROUP BY check_no");

			if ($this->db->num_rows($r) > 0) {
				while($row = $this->db->fetch_assoc($r)) {
					echo "
					<tr>
						<td style=\"background-color:#ffffff;font-size:10pt;\">".$row['check_no']."</td>
						<td colspan=\"2\" style=\"background-color:#ffffff;font-size:10pt;\">".date(DATE_FORMAT, strtotime($row['check_date']))."</td>
						<td colspan=\"6\" style=\"background-color:#ffffff;font-size:10pt;\">".stripslashes($row['payee_name'])."</td>
						<td style=\"background-color:#ffffff;font-size:10pt;\" class=\"num_field\">".$row['check_symbol'].number_format($row['check_amount'], 2)."</td>
					</tr>";
					$r2 = $this->db->query("SELECT * FROM _tmp_reports_data_check_run
											WHERE check_no = '".$row['check_no']."' AND invoice_no IS NOT NULL");
					unset($invoice_no);
					while($invoice = $this->db->fetch_assoc($r2)) {
						if ($this->p->ck('payables', 'V'))
							$invoice_no = "<a href=\"javascript:void(0);\" onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$invoice['invoice_hash']."', 'popup_id=line_item');\" title=\"View this invoice\" class=\"link_standard\">".$invoice['invoice_no']."</a>";
						else
							$invoice_no = $invoice['invoice_no'];

						if ($this->p->ck('payables', 'V'))
							$credit_no = "<a href=\"javascript:void(0);\" onClick=\"agent.call('payables', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$invoice['credit_hash']."', 'popup_id=line_item');\" title=\"View this invoice\" class=\"link_standard\">".$invoice['credit_no']."</a>";
						else
							$credit_no = $invoice['credit_no'];
						echo "
						<tr>
							<td style=\"background-color:#ffffff;font-size:8pt;vertical-align:top;\">&nbsp;</td>
			                    <td style=\"background-color:#ffffff;font-size:8pt;vertical-align:top;\">".($invoice['invoice_date'] ? date(DATE_FORMAT, strtotime($invoice['invoice_date'])) : NULL)."</td>
			                    <td style=\"background-color:#ffffff;font-size:8pt;vertical-align:top;\">".$invoice['invoice_type']."</td>
		                    <td style=\"background-color:#ffffff;font-size:8pt;vertical-align:top;\">".$invoice_no."</td>
			                    <td style=\"background-color:#ffffff;font-size:8pt;vertical-align:top;\" class=\"num_field\">".($invoice['invoice_amount'] > 0 ? $invoice['invoice_symbol'].number_format($invoice['invoice_amount'], 2) : NULL)."</td>
			                    <td style=\"background-color:#ffffff;font-size:8pt;vertical-align:top;\" class=\"num_field\">".($invoice['discount_amount'] > 0 ? $invoice['payment_symbol'].number_format($invoice['discount_amount'], 2) : NULL)."</td>
			                    <td style=\"background-color:#ffffff;font-size:8pt;vertical-align:top;\" class=\"num_field\">".($invoice['deposit_amount'] > 0 ? $invoice['payment_symbol'].number_format($invoice['deposit_amount'], 2) : NULL)."</td>
			                    <td style=\"background-color:#ffffff;font-size:8pt;vertical-align:top;\" class=\"num_field\">".($invoice['credit_applied'] > 0 ? $invoice['credit_symbol'].number_format($invoice['credit_applied'], 2) : NULL)."</td>
			                    <td style=\"background-color:#ffffff;font-size:8pt;vertical-align:top;\" class=\"num_field\">".$credit_no."</td>
			                    <td style=\"background-color:#ffffff;font-size:8pt;vertical-align:top;\" class=\"num_field\">&nbsp;</td>
		                </tr>";
	                }
	                echo "
	                <tr>
	                	<td colspan=\"10\" style=\"background-color:#ffffff;\">&nbsp;</td>
		                </tr>";
                }
			} else
				echo "
					<tr style=\"background-color:#ffffff;\">
						<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"10\">There are no results to show.</td>
					</tr>";

			echo "
			</table>";

            return;

        } else {

			$report_hash = $this->ajax_vars['report_hash'];
            $this->fetch_report_settings($report_hash);

            array_shift($this->user_name);
            array_shift($this->user_hash);

            $accounting = new accounting;

            $checking = $accounting->fetch_checking_accounts();

            $checking_accts = array(
                0   =>  array(),
                1   =>  array()
            );

            for ( $i = 0; $i < count($checking); $i++ ) {

            	array_push($checking_accts[0], $checking[$i]['account_hash']);
            	array_push($checking_accts[1], $checking[$i]['account_name']);
            }

            $this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
            if ( $report_hash && $this->current_report['owner_hash'] != $this->current_hash )
                unset($report_hash);

            if ( $this->current_report['payee_filter'] && ! is_array($this->current_report['payee_filter']) )
                $this->current_report['payee_filter'] = array($this->current_report['payee_filter']);

            $tbl =
            $this->form->form_tag() .
            $this->form->hidden( array(
                'test'          => 1,
                'report_hash'   => $report_hash,
                'popup_id'      => $this->popup_id
            ) ) . "
            <div class=\"panel\" id=\"report_filter_table\">
                <div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
                    <h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
                        <p id=\"feedback_message".$this->popup_id."\"></p>
                </div>
                <table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
                    <tr>
                        <td style=\"padding:0;\">
                             <div style=\"background-color:#ffffff;height:100%;\">
                                <div style=\"margin:15px 35px;\">
                                    <div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">" .
                                        $this->form->button(
                                            "value=Run Report",
                                            "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_check_run');"
                                        ) .
                                        ( $this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
                                            "&nbsp;&nbsp;" .
                                            $this->form->button(
                                                "value=Delete Report",
                                                "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_check_run', 'rm=1');"
                                            ) : NULL
                                        ) . "
                                    </div>
                                    <h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
                                        $this->current_report['report_name'] : "Check Run Report")."</h3>
                                    <table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What checking account should<br />the report reflect?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">".
                                                $this->form->select("account_hash", $checking_accts[1], ($this->current_report['account_hash'] ? $this->current_report['account_hash'] : DEFAULT_CASH_ACCT), $checking_accts[0], "blank=1")."
                                            </td>
                                        </tr>
                                    	<tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">".
                                                $this->form->select("timeframe", array("All dates", "Checks dated this year", "Checks dated last year", "Checks from the current period", "Checks from the previous period", "A specific date range"), $this->current_report['timeframe'], array('*', 1, 2, 3, 4, 5), "onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
                                                <div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
                                                    <span id=\"sort_from_date_holder\"></span>
                                                    <span id=\"sort_to_date_holder\"></span>";
                                                $jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
                                                $jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
                                                $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
										<tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific checks?
                                            	<div style=\"font-style:italic;\">
													<small>Separate multiple checks by comma</small>
												</div>
                                            </td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=check_no_filter",
                                                                        "value=".(is_array($this->current_report['check_no_filter']) ? implode(', ', $this->current_report['check_no_filter']) : $this->current_report['check_no_filter']),
                                                                        "size=30"
                                                                        );

                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer_vendor",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['payee_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
                                                if (is_array($this->current_report['payee_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['payee_filter']); $i++)
                                                        $tbl .= "<div id=\"customer_vendor_".$this->current_report['payee_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['payee_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['payee_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['payee_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['payee_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Cleared Checks?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("showcleared", array("Show Cleared Only", "Show Uncleared Only"), $this->current_report['showcleared'], array('2', '1'), "style=width:200px;")."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Voided Checks?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("showvoided", array("Show Voided Only", "Show Unvoided Only"), $this->current_report['showvoided'], array('2', '1'), "style=width:200px;")."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
                                                <div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
                                                    What should the report be called?
                                                    <br />
                                                    ".$this->form->text_box("name=report_name",
                                                                            "value=".$this->current_report['report_name'],
                                                                            "autocomplete=off",
                                                                            "size=30",
                                                                            "style=margin-top:5px;margin-bottom:10px;"
                                                                            )."
                                                    <br />
                                                    Optional description for the report:
                                                    <br />
                                                    ".$this->form->text_area("name=report_descr",
                                                                            "value=".$this->current_report['report_descr'],
                                                                            "rows=3",
                                                                            "cols=50",
                                                                            "style=margin-top:5px;"
                                                                            )."
                                                    <div style=\"padding-top:5px\">
                                                        ".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
                                                        <div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
                                                            Share to the following users:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                            Share to the following groups:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>".
            $this->form->close_form();

            $this->content['popup_controls']["cmdTable"] = $tbl;
            $this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
            $this->content['jscript'] = $jscript;

            return;
        }
    }
    /**
     * Doit function for the check run report. Added for Trac #1433.
     *
     * @param boolean $stream
     * @param string $format
     */
    function doit_check_run($stream=false, $format='') {
        $date = date("U") - 3600;
        $result = $this->db->query("DELETE FROM `reports`
                                    WHERE `saved` = 0 AND `timestamp` <= '$date'");

        if ($_POST['rm'] == 1 && $_POST['report_hash']) {
            $this->db->query("DELETE reports.* , reports_share.*
                              FROM `reports`
                              LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
                              WHERE reports.report_hash = '".$_POST['report_hash']."'");
            $this->content['action'] = 'close';
            $this->content['page_feedback'] = "Report has been deleted.";
            $this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
            return;
        }

        $doit_print = $_POST['doit_print'];
        $report_hash = ($this->report_hash ? $this->report_hash : $_POST['report_hash']);
        $from_saved = $this->ajax_vars['from_saved'];

		if (($doit_print && $report_hash) || $from_saved) {
            $this->fetch_report_settings($report_hash);

            $account_hash = $this->current_report['account_hash'];
            $timeframe = $this->current_report['timeframe'];
            if ($timeframe == 5) {
                $sort_from_date = $this->current_report['sort_from_date'];
                $sort_to_date = $this->current_report['sort_to_date'];
            }
            $check_no_filter = $this->current_report['check_no_filter'];
            if ($check_no_filter && !is_array($check_no_filter))
                $check_no_filter = array($check_no_filter);

            $payee_filter = $this->current_report['payee_filter'];
            if ($payee_filter && !is_array($payee_filter))
                $payee_filter = array($payee_filter);

            $showcleared = $this->current_report['showcleared'];
            $showvoided = $this->current_report['showvoided'];
        } else {
        	$account_hash = $_POST['account_hash'];
            $timeframe = $_POST['timeframe'];
            if ($timeframe == 5) {
                $sort_from_date = $_POST['sort_from_date'];
                $sort_to_date = $_POST['sort_to_date'];
            }
            if ($_POST['check_no_filter'])
            	$check_no_filter = explode(", ", $_POST['check_no_filter']);

            $payee_filter = $_POST['customer_vendor_filter'];
            if ($payee_filter && !is_array($payee_filter))
                $payee_filter = array($payee_filter);

            $showcleared = $_POST['showcleared'];
            $showvoided = $_POST['showvoided'];
        }

        if ($stream == false) {
        $save = $_POST['save'];
        $saved_cat = "check_run";
        $report_name = $_POST['report_name'];
        $report_descr = $_POST['report_descr'];
        $share = $_POST['share'];
        $sales_rep_share = $_POST['sales_rep_share'];
        $group_share = $_POST['group_share'];
        if (!$save)
            unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
        if ($save && !$report_name) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
        }
        if ($save && !$report_hash) {
            $result = $this->db->query("SELECT COUNT(*) AS Total
                                        FROM `reports`
                                        WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
            if ($this->db->result($result)) {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
            }
        }
        if ($share && !count($sales_rep_share) && !count($group_share)) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
        }

        if (($timeframe == 5 && $sort_to_date && $sort_from_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you select a valid date range.";
        }

        if ($this->content['error'])
            return;

        switch ($timeframe) {
            case 1:
	            $date_start = date("Y").'-01-01';
	            $date_end = date("Y").'-12-31';
	            $this->report_title = "dated this year, ".date("Y");
            break;

            case 2:
	            $date_start = date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01";
	            $date_end = date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31";
	            $this->report_title = "dated last year, ".date("Y", strtotime(date("Y-m-d")." -1 year"));
            break;

            case 3:
            $period_info = get_period_info(date("Y-m-d"));
            if ($period_info['period_start']) {
					$date_start = $period_info['period_start'];
					$date_end = $period_info['period_end'];
	                $this->report_title = "dated within the current period, between ".date(DATE_FORMAT, strtotime($period_info['period_start']))." and ".date(DATE_FORMAT, strtotime($period_info['period_end']));
            } else {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
                return;
            }
            break;

            case 4:
            $period_info = get_previous_period(date("Y-m-d"));
            if ($period_info['period_start']) {
					$date_start = $period_info['period_start'];
					$date_end = $period_info['period_end'];
	                $this->report_title = "dated last period, between ".date(DATE_FORMAT, strtotime($period_info['period_start']))." and ".date(DATE_FORMAT, strtotime($period_info['period_end']));
            } else {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
                return;
            }
            break;

            case 5:
            if ($sort_from_date && $sort_to_date) {
	                $date_start = $sort_from_date;
					$date_end = $sort_to_date;
	                $this->report_title = "dated between ".date(DATE_FORMAT, strtotime($sort_from_date))." and ".date(DATE_FORMAT, strtotime($sort_to_date));
	            }
            break;

            default:
	            	$date_start = "1999-01-01";
	            	$date_end = "2999-12-31";
	                $this->report_title = "dated as of ".date(DATE_FORMAT);
        }
        $account_name = accounting::fetch_account_name($account_hash);
        $this->report_title .= " for Account $account_name";

	        // Modify title to show cleared or voided in title
	        if ($showcleared || $showvoided) {
	        	if ($showvoided == 1)
	        		$void_txt = "Unvoided";
	        	elseif ($showvoided == 2)
	        		$void_txt = "Voided";
	        	if ($showcleared == 1)
	        		$cleared_txt = "Uncleared";
	        	elseif($showcleared == 2)
	        		$cleared_txt = "Cleared";
	        	$this->report_title = $void_txt.($void_txt && $cleared_txt ? " and ".strtolower($cleared_txt) : $cleared_txt)." checks ".$this->report_title;
	        } else
	        	$this->report_title = "Checks ".$this->report_title;

			if ($check_no_filter && !is_array($check_no_filter))
				$check_no_filter = array($check_no_filter);
        if (is_array($check_no_filter) && count($check_no_filter)) {
            array_walk($check_no_filter, 'add_quotes', "'");
            $sql_p[] = "check_no IN (".implode(" , ", $check_no_filter).")";
            array_walk($check_no_filter, 'strip_quotes');
        }
	        if ($payee_filter && !is_array($payee_filter))
				$payee_filter = array($payee_filter);
        if (is_array($payee_filter) && count($payee_filter)) {
            $payee_filter = array_unique($payee_filter);
            $payee_filter = array_values($payee_filter);
            array_walk($payee_filter, 'add_quotes', "'");
            $sql_p[] = "payee IN (".implode(" , ", $payee_filter).")";
            array_walk($payee_filter, 'strip_quotes');
        }
			if ($this->current_report['showcleared'])
				$sql_p[] = "cleared = ".($this->current_report['showcleared'] == 2 ? 1 : 0);
			if ($this->current_report['showvoided'])
				$sql_p[] = "void = ".($this->current_report['showvoided'] == 2 ? 1 : 0);
		if ($sql_p)
            $sql = implode(" AND ", $sql_p);

	        $str = "timeframe=$timeframe|sort_from_date=$sort_from_date|showdetail=$showdetail|sort_to_date=$sort_to_date|check_no_filter=".@implode("&", $check_no_filter)."|payee_filter=".@implode("&", $payee_filter)."|showcleared=$showcleared|showvoided=$showvoided|account_hash=$account_hash|date_start=$date_start|date_end=$date_end|report_title=".$this->report_title;
        }
        if ($stream == false) {
        if (!$report_hash) {
            $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
            while (global_classes::key_exists('reports', 'report_hash', $report_hash))
                $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

            $this->db->query("INSERT INTO `reports`
                              (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method`)
                              VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."')");

            if ($share && (count($group_share) || count($sales_rep_share))) {
                for ($i = 0; $i < count($group_share); $i++)
                    $this->db->query("INSERT INTO `reports_share`
                                      (`report_hash` , `group_hash`)
                                      VALUES ('$report_hash' , '".$group_share[$i]."')");

                for ($i = 0; $i < count($sales_rep_share); $i++)
                    $this->db->query("INSERT INTO `reports_share`
                                      (`report_hash` , `user_hash`)
                                      VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
            }
        } elseif (!$from_saved) {
            $existing = true;
            $this->db->query("UPDATE `reports`
	                              SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' , `sql` = '".addslashes($sql)."'
                              WHERE `report_hash` = '$report_hash'");

            if (!$share)
                $this->db->query("DELETE FROM `reports_share`
                                  WHERE `report_hash` = '".$this->report_hash."'");
            else {
                if (!is_array($sales_rep_share))
                    $sales_rep_share = array();
                if (!is_array($group_share))
                    $group_share = array();

                //Share or revoke to users
                $result = $this->db->query("SELECT `user_hash`
                                            FROM `reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_users[] = $row['user_hash'];

                if (!is_array($current_share_users))
                    $current_share_users = array();

                $to_remove = array_diff($current_share_users, $sales_rep_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `reports_share`
                                          WHERE `user_hash` = '".$current_share_users[$i]."'");
                }
                $to_add = array_diff($sales_rep_share, $current_share_users);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `reports_share`
                                          (`report_hash` , `user_hash`)
                                          VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
                }

                //Share or revoke to groups
                $result = $this->db->query("SELECT `group_hash`
                                            FROM `reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_groups[] = $row['group_hash'];

                if (!is_array($current_share_groups))
                    $current_share_groups = array();

                $to_remove = array_diff($current_share_groups, $group_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `reports_share`
                                          WHERE `group_hash` = '".$current_share_groups[$i]."'");
                }
                $to_add = array_diff($group_share, $current_share_groups);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `reports_share`
                                          (`report_hash` , `group_hash`)
                                          VALUES ('$report_hash' , '".$group_share[$i]."'");
                }
            }
        }
        }

        $this->report_hash = $report_hash;

		if ( $stream && ( ! $format || $format == 'htm' ) ) {

			$this->db->query("CALL check_run('{$this->current_report['account_hash']}', '{$this->current_report['date_start']}', '{$this->current_report['date_end']}');");

            $this->content['html']['place_holder'] = $this->check_run(1);
            $this->content['action'] = 'close';
        } else {

            $this->content['action'] = 'close';
            return $this->stream_report();
        }

        return;
    }
    /**
     * Customer statement report added for Trac #1156
     *
     * Report options include
	 *  by date/date range
	 *	by check #
	 *	by Payee Name
	 *	by Acct #
	 *	by cleared / not cleared
	 *	by voided / not voided
     *
     * @param boolean $step
     */
    function customer_statement($step=NULL) {
        $this->unlock("_");

        if ($step) {
			$this->fetch_report_settings($this->report_hash);
			echo $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
            <table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:1000px;margin-top:0;\" id=\"reports_data_table\">
                <tr>
                    <td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"10\">
                        <h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
                            ".($this->current_report['saved'] ?
                                $this->current_report['report_name'] : "Customer Statement Report").($this->p->ck('reports', 'V', 'customer_statement') ? "
                            <span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
                                [<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'customer_statement', 'popup_id=report_filter', 'report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
                            </span>" : NULL)."
                            <div style=\"margin-left:15px;margin-top:10px;margin-bottom:10px;font-size:10pt;\">{$this->report_title}</div>
                        </h3>
                        <div style=\"margin-left:20px;margin-bottom:5px;\">
                            <small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
                            &nbsp;&nbsp;
                            <a href=\"javascript:void(0);\" onClick=\"agent.call('reports', 'sf_loadcontent', 'show_popup_window', 'print_it', 'type=customer_statement', 'report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
                        </div>
                    </td>
                </tr>
                <tr class=\"thead\" style=\"font-weight:bold;\">
                    <td style=\"width:200px;text-align:left;padding:15px 5px 5px 50px;vertical-align:bottom;\">Invoice No.</td>
                    <td style=\"width:110px;padding:5px;vertical-align:bottom;\">Invoice Date</td>
                    <td style=\"width:90px;padding:5px;vertical-align:bottom;\">Due Date</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Orig Amt</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Payments</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Balance</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">Current</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">".$this->current_report['age1']." Days</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">".$this->current_report['age2']." Days</td>
                    <td style=\"width:100px;padding:5px;vertical-align:bottom;\" class=\"num_field\">".$this->current_report['age3']." Days</td>
                </tr>";

			$sql = stripslashes($this->current_report['sql']);
			$result = $this->db->query("SELECT *
										FROM _tmp_reports_data_customer_statement".($sql ? "
										WHERE ".$sql : NULL)."
										GROUP BY customer_hash
										ORDER BY customer_name");
			$show_header = false;
			while ($proposal_array = $this->db->fetch_assoc($result)) {
				$total_invoice = $total_receipts = $total_balance = $total_current = $total_sched1 = $total_sched2 = $total_sched3 = 0;
				$customer_hash = $proposal_array['customer_hash'];

				echo "
				<tr style=\"background-color:#efefef;\">
					<td colspan=\"".($show_header ? 3 : 10)."\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".stripslashes($proposal_array['customer_name'])."</td>".($show_header ? "
					<td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">Amount</td>
					<td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">Payments</td>
					<td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">Balance</td>
					<td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">Current</td>
					<td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".$this->current_report['age1']." Days</td>
					<td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".$this->current_report['age2']." Days</td>
					<td class=\"num_field\" style=\"padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".$this->current_report['age3']." Days</td>" : NULL)."
				</tr>";

				$show_header = $show_proposal_no = true;
				$result2 = $this->db->query("SELECT * FROM _tmp_reports_data_customer_statement
											 WHERE customer_hash = '$customer_hash'".($sql ? " AND $sql" : NULL)."
											 GROUP BY proposal_hash");

				while ($proposals = $this->db->fetch_assoc($result2)) {
					$proposal_hash = $proposals['proposal_hash'];
					if ($proposals['proposal_no']) {
						echo "
						<tr>
							<td colspan=\"10\" style=\"font-size:8pt;background-color:#ffffff;padding-left:25px;padding-top:5px;border-top:1px solid #efefef;\">".($proposals['proposal_hash'] ? "
								Proposal: <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('proposals', 'sf_loadcontent', 'show_popup_window', 'edit_proposal', 'proposal_hash=".$proposals['proposal_hash']."', 'popup_id=proposal_win', 'from_report=1');\">".$proposals['proposal_no']."</a> - ".$proposals['proposal_descr'] : "&nbsp;")."
							</td>
						</tr>";
					}
					$result3 = $this->db->query("SELECT t1.* , t2.obj_id as payment_details
												 FROM _tmp_reports_data_customer_statement t1
												 LEFT JOIN customer_payment t2 ON t2.invoice_hash = t1.invoice_hash
												 WHERE proposal_hash = '$proposal_hash'".($sql ? " AND $sql" : NULL)."
												 GROUP BY invoice_hash");

					while ($details = $this->db->fetch_assoc($result3)) {
						$total_balance = bcadd($total_balance, $details['balance_total'], 2);
						$total_invoice = bcadd($total_invoice, $details['total_receivable'], 2);
						$total_receipts = bcadd($total_receipts, $details['total_receipts'], 2);
						$total_current = bcadd($total_current, $details['balance_current']);
						$total_sched1 = bcadd($total_sched1, $details['balance_sched1']);
						$total_sched2 = bcadd($total_sched2, $details['balance_sched2']);
						$total_sched3 = bcadd($total_sched3, $details['balance_sched3']);
						$invoice_hash = $details['invoice_hash'];

						echo "
						<tr>
							<td style=\"background-color:#ffffff;font-size:8pt;padding-left:50px;\">".($details['type'] == 'I' ? "
								<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'edit_invoice', 'invoice_hash=".$details['invoice_hash']."', 'proposal_hash=$proposal_hash', 'popup_id=line_item');\" class=\"link_standard\">".$details['invoice_no']."</a>" : "
								<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice', 'sf_loadcontent', 'show_popup_window', 'new_deposit', 'invoice_hash=".$details['invoice_hash']."', 'proposal_hash=$proposal_hash', 'popup_id=line_item');\" class=\"link_standard\">".(!$proposal_hash ? "Unapplied " : NULL)."Deposit</a>")."
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($details['invoice_date']))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT, strtotime($details['due_date']))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;".($details['total_receivable'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details['total_receivable'] < 0 ?
								"($".number_format($details['total_receivable'] * -1, 2).")" : "$".number_format($details['total_receivable'], 2))."
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;".($details['total_receipts'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details['total_receipts'] < 0 ?
									"($".number_format($details['total_receipts'] * -1, 2).")" : "$".number_format($details['total_receipts'], 2))."
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;".($details['balance_total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details['balance_total'] < 0 ?
								"($".number_format(($details['balance_total'] * -1), 2).")" : "$".number_format($details['balance_total'], 2))."
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;".($details['balance_current'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details['balance_current'] != 0 ?
								($details['balance_current'] < 0 ?
									"($".number_format($details['balance_current'] * -1, 2).")" : "$".number_format($details['balance_current'], 2)) : NULL)."
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;".($details['balance_sched1'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details['balance_sched1'] != 0 ?
								($details['balance_sched1'] < 0 ?
									"($".number_format($details['balance_sched1'] * -1, 2).")" : "$".number_format($details['balance_sched1'], 2)) : NULL)."
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;".($details['balance_sched2'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details['balance_sched2'] != 0 ?
								($details['balance_sched2'] < 0 ?
									"($".number_format($details['balance_sched2'] * -1, 2).")" : "$".number_format($details['balance_sched2'], 2)) : NULL)."
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;".($details['balance_sched3'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details['balance_sched3'] != 0 ?
								($details['balance_sched3'] < 0 ?
									"($".number_format($details['balance_sched3'] * -1, 2).")" : "$".number_format($details['balance_sched3'], 2)) : NULL)."
							</td>
						</tr>";

						if ($details['payment_details'] && $this->current_report['showdetail'] == 2) {
							$result4 = $this->db->query("SELECT t1.receipt_amount , t1.check_no , t1.receipt_date , t1.reconciled , t1.applied_type , t1.applied_from ,
														 t1.currency_adjustment , t2.account_name , t2.account_no , t3.account_name as reconciled_account
														 FROM customer_payment t1
														 LEFT JOIN accounts t2 ON t2.account_hash = t1.account_hash
														 LEFT JOIN accounts t3 ON t3.account_hash = t1.applied_from
														 WHERE invoice_hash = '$invoice_hash' AND t1.deleted = 0");
							echo "
								<tr>
									<td style=\"background-color:#ffffff;font-size:8pt;\" colspan =\"5\">
										<div style=\"float:right;\">
											<table>
												<tr>
													<td>Check/Credit No.</td>
													<td>Receipt Date</td>
													<td>Account</td>
													<td class=\"num_field\">Currency Adj</td>
													<td class=\"num_field\">Amount</td>
												</tr>";
							while ($payments = $this->db->fetch_assoc($result4)) {
								echo "
												<tr>
													<td class=\"smallfont\">".$payments['check_no']."</td>
													<td class=\"smallfont\">".date(DATE_FORMAT, strtotime($payments['receipt_date']))."</td>
													<td class=\"smallfont\">".($payments['applied_from'] ?
														($payments['reconciled'] ?
														    $payments['reconciled_account'] : "<i>Applied from Customer ".($payments['applied_type'] == 'C' ?
																"Credit" : "Deposit")."</i>") : $payments['account_name'])."
													</td>
													<td class=\"smallfont\" style=\"text-align:right;\">".($payments['currency_adjustment'] != 0 ?
														($payments['currency_adjustment'] < 0 ?
															"($".number_format($payments['currency_adjustment'] * -1, 2).")" : "$".number_format($payments['currency_adjustment'], 2)) : NULL)."
													</td>
													<td class=\"smallfont\" style=\"text-align:right;\">$".number_format($payments['receipt_amount'], 2)."</td>
												</tr>";
							}
							echo "			</table>
										</div>
									</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\" colspan =\"5\">&nbsp;</td>
								</tr>";
						}
					}
				}

				$grand_total['invoice'] = bcadd($grand_total['invoice'], $total_invoice, 2);
				$grand_total['receipts'] = bcadd($grand_total['receipts'], $total_receipts, 2);
				$grand_total['balance'] = bcadd($grand_total['balance'], $total_balance, 2);
				$grand_total['current'] = bcadd($grand_total['current'], $total_current, 2);
				$grand_total['sched1'] = bcadd($grand_total['sched1'], $total_sched1, 2);
				$grand_total['sched2'] = bcadd($grand_total['sched2'], $total_sched2, 2);
				$grand_total['sched3'] = bcadd($grand_total['sched3'], $total_sched3, 2);

				echo "
				<tr>
					<td style=\"font-size:8pt;background-color:#ffffff;\" colspan=\"3\"></td>
					<td style=\"font-size:8pt;background-color:#ffffff;".($total_invoice < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
						<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_invoice < 0 ?
							"($".number_format($total_invoice * -1, 2).")" : "$".number_format($total_invoice, 2))."
						</div>
					</td>
					<td style=\"font-size:8pt;background-color:#ffffff;".($total_payments < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
						<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_receipts < 0 ?
							"($".number_format($total_receipts * -1, 2).")" : "$".number_format($total_receipts, 2))."
						</div>
					</td>
					<td style=\"font-size:8pt;background-color:#ffffff;".($total_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
						<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_balance < 0 ?
							"($".number_format($total_balance * -1, 2).")" : "$".number_format($total_balance, 2))."
						</div>
					</td>
					<td style=\"font-size:8pt;background-color:#ffffff;".($total_current < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(bccomp($total_current, 0, 2) != 0 ? "
						<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_current < 0 ?
							"($".number_format($total_current * -1, 2).")" : "$".number_format($total_current, 2))."
						</div>" : NULL)."
					</td>
					<td style=\"font-size:8pt;background-color:#ffffff;".($total_sched1 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(bccomp($total_sched1, 0, 2) != 0 ? "
						<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_sched1 < 0 ?
							"($".number_format($total_sched1 * -1, 2).")" : "$".number_format($total_sched1, 2))."
						</div>" : NULL)."
					</td>
					<td style=\"font-size:8pt;background-color:#ffffff;".($total_sched2 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(bccomp($total_sched2, 0, 2) != 0 ? "
						<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_sched2 < 0 ?
							"($".number_format($total_sched2 * -1, 2).")" : "$".number_format($total_sched2, 2))."
						</div>" : NULL)."
					</td>
					<td style=\"font-size:8pt;background-color:#ffffff;".($total_sched3 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(bccomp($total_sched3, 0, 2) != 0 ? "
						<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;\">".($total_sched3 < 0 ?
							"($".number_format($total_sched3 * -1, 2).")" : "$".number_format($total_sched3, 2))."
						</div>" : NULL)."
					</td>
				</tr>";

			}


            $grand_total_all = $grand_total['current'] + $grand_total['sched1'] + $grand_total['sched2'] + $grand_total['sched3'];

            echo "
                    <tr>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" colspan=\"3\">&nbsp;</td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">
                                $".number_format($grand_total['invoice'], 2)."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['receipts'] < 0 ?
                                "($".number_format($grand_total['receipts']*-1).")" : "$".number_format($grand_total['receipts'], 2))."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['balance'] < 0 ?
                                "($".number_format($grand_total['balance']*-1).")" : "$".number_format($grand_total['balance'], 2))."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;".($total_current < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['current'] < 0 ?
                                "($".number_format($grand_total['current'] * -1, 2).")" : "$".number_format($grand_total['current'], 2))."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;".($total_sched1 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['sched1'] < 0 ?
                                "($".number_format($grand_total['sched1'] * -1, 2).")" : "$".number_format($grand_total['sched1'], 2))."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;".($total_sched2 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['sched2'] < 0 ?
                                "($".number_format($grand_total['sched2'] * -1, 2).")" : "$".number_format($grand_total['sched2'], 2))."
                            </div>
                        </td>
                        <td style=\"background-color:#ffffff;font-size:8pt;padding-top:20px;".($total_sched3 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['sched3'] < 0 ?
                                "($".number_format($grand_total['sched3'] * -1, 2).")" : "$".number_format($grand_total['sched3'], 2))."
                            </div>
                        </td>
                    </tr>
            </table>";

            return;
        } else {
        	$report_hash = $this->ajax_vars['report_hash'];
            $this->fetch_report_settings($report_hash);

            array_shift($this->user_name);
            array_shift($this->user_hash);

            $this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
            if ($report_hash && $this->current_report['owner_hash'] != $this->current_hash)
                unset($report_hash);

            if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
                $this->current_report['customer_filter'] = array($this->current_report['customer_filter']);

            $tbl .= $this->form->form_tag().($this->p->ck('proposals', 'S') ? $this->form->hidden(array('sales_rep_match[]' => $_SESSION['id_hash'])) : NULL).
            $this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
            <div class=\"panel\" id=\"report_filter_table\">
                <div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
                    <h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
                        <p id=\"feedback_message".$this->popup_id."\"></p>
                </div>
                <table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
                    <tr>
                        <td style=\"padding:0;\">
                             <div style=\"background-color:#ffffff;height:100%;\">
                                <div style=\"margin:15px 35px;\">
                                    <div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
                                        ".$this->form->button("value=Run Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_customer_statement');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ?
                                            "&nbsp;&nbsp;".$this->form->button("value=Delete Report", "onClick=submit_form(this.form, 'reports', 'exec_post', 'refresh_form', 'action=doit_customer_statement', 'rm=1');") : NULL)."
                                    </div>
                                    <h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ?
                                        $this->current_report['report_name'] : "Customer Statement Report")."</h3>
                                    <table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">".
                                                $this->form->select("timeframe", array("All invoice dates", "Invoices dated this year", "Invoices dated last year", "Invoices from the current period", "Invoices from the previous period", "A specific date range"), $this->current_report['timeframe'], array('*', 1, 2, 3, 4, 5), "onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range', 'block');}else{toggle_display('date_range', 'none');}", "blank=1")."
                                                <div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
                                                    <span id=\"sort_from_date_holder\"></span>
                                                    <span id=\"sort_to_date_holder\"></span>";
                                                $jscript[] = "setTimeout('DateInput(\'sort_from_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\', 1, \'sort_from_date_holder\', \'From: \')', 500);";
                                                $jscript[] = "setTimeout('DateInput(\'sort_to_date\', false, \'YYYY-MM-DD\', \'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\', 1, \'sort_to_date_holder\', \'&nbsp;&nbsp;&nbsp;&nbsp;To:\')', 800);";
                                                $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">How should the aging<br />schedule be shown?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=age1", "value=".($this->current_report['age1'] ? $this->current_report['age1'] : ACCOUNT_AGING_SCHED1), "size=3", "style=text-align:right;padding-right:5px;")." days
                                                <br />
                                                ".$this->form->text_box("name=age2", "value=".($this->current_report['age2'] ? $this->current_report['age2'] : ACCOUNT_AGING_SCHED2), "size=3", "style=text-align:right;padding-right:5px;")." days
                                                <br />
                                                ".$this->form->text_box("name=age3", "value=".($this->current_report['age3'] ? $this->current_report['age3'] : ACCOUNT_AGING_SCHED3), "size=3", "style=text-align:right;padding-right:5px;")." days
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]", $this->sales_name, (is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ($this->p->ck('proposals', 'S') ? $_SESSION['id_hash'] : '')), $this->sales_hash, "multiple", "blank=1", "size=4", "style=width:200px;", ($this->p->ck('proposals', 'S') ? "disabled" : NULL))."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer_vendor",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element(\$('keyResults'), findPos(this, 'top')+20, findPos(this, 'left'));if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onKeyUp=if(ka==false && this.value){key_call('reports', 'customer_vendor', 'customer_hash', 1);}",
                                                                        "onBlur=key_clear();"
                                                                        )."

                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
                                                if (is_array($this->current_report['customer_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['customer_filter']); $i++)
                                                        $tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]), 0, 22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Should the report reflect<br />paid or unpaid invoices?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("invoices_paid",
                                                                       array("Show only invoices with an open balance", "Show only invoices with a zero balance"),
                                                                       $this->current_report['invoices_paid'],
                                                                       array(1, 2))."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("showdetail", array("Show Detail View", "Show Simple View"), $this->current_report['showdetail'], array('2', '1'), "blank=1")."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=save", "value=1", NULL, "onClick=toggle_display('saved_report_name', this.checked?'block':'none')")."
                                                <div style=\"padding-top:5px;display:none;\" id=\"saved_report_name\">
                                                    What should the report be called?
                                                    <br />
                                                    ".$this->form->text_box("name=report_name",
                                                                            "value=".$this->current_report['report_name'],
                                                                            "autocomplete=off",
                                                                            "size=30",
                                                                            "style=margin-top:5px;margin-bottom:10px;"
                                                                            )."
                                                    <br />
                                                    Optional description for the report:
                                                    <br />
                                                    ".$this->form->text_area("name=report_descr",
                                                                            "value=".$this->current_report['report_descr'],
                                                                            "rows=3",
                                                                            "cols=50",
                                                                            "style=margin-top:5px;"
                                                                            )."
                                                    <div style=\"padding-top:5px\">
                                                        ".$this->form->checkbox("name=share", "value=1", ($this->current_report['share'] ? "checked" : NULL), "onClick=toggle_display('share_report_select', this.checked?'block':'none')")."&nbsp;Share this report?
                                                        <div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
                                                            Share to the following users:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("sales_rep_share[]", $this->user_name, $this->current_report['sales_rep_share'], $this->user_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                            Share to the following groups:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("group_share[]", $this->group_name, $this->current_report['group_share'], $this->group_hash, "multiple", "size=4", "blank=1", "style=width:200px;")."
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>".
            $this->form->close_form();

            $this->content['popup_controls']["cmdTable"] = $tbl;
            $this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
            $this->content['jscript'] = $jscript;
            return;
        }
    }
    /**
     * Doit function for the customer statement report. Added for Trac #1156.
     *
     * @param boolean $stream
     * @param string $format
     */
    function doit_customer_statement($stream=false, $format='') {
        $date = date("U") - 3600;
        $result = $this->db->query("DELETE FROM `reports`
                                    WHERE `saved` = 0 AND `timestamp` <= '$date'");

        if ($_POST['rm'] == 1 && $_POST['report_hash']) {
            $this->db->query("DELETE reports.* , reports_share.*
                              FROM `reports`
                              LEFT JOIN `reports_share` ON reports_share.report_hash = reports.report_hash
                              WHERE reports.report_hash = '".$_POST['report_hash']."'");
            $this->content['action'] = 'close';
            $this->content['page_feedback'] = "Report has been deleted.";
            $this->content['jscript_action'] = "agent.call('reports', 'sf_loadcontent', 'cf_loadcontent', 'navigator');";
            return;
        }

        $report_hash = $_POST['report_hash'];
        $from_saved = $this->ajax_vars['from_saved'];

		if ($report_hash && $from_saved) {
            $this->fetch_report_settings($report_hash);

            $timeframe = $this->current_report['timeframe'];
            if ($timeframe == 5) {
                $sort_from_date = $this->current_report['sort_from_date'];
                $sort_to_date = $this->current_report['sort_to_date'];
            }
            $age1 = $this->current_report['age1'];
            $age2 = $this->current_report['age2'];
            $age3 = $this->current_report['age3'];
            $sales_rep_match = $this->current_report['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);

            $customer_filter = $this->current_report['customer_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);

            $showdetail = $this->current_report['showdetail'];
            $invoices_paid = $this->current_report['invoices_paid'];
        } elseif (!$stream) {
            $timeframe = $_POST['timeframe'];
            if ($timeframe == 5) {
                $sort_from_date = $_POST['sort_from_date'];
                $sort_to_date = $_POST['sort_to_date'];
            }
            $age1 = $_POST['age1'];
            $age2 = $_POST['age2'];
            $age3 = $_POST['age3'];
            $sales_rep_match = $_POST['sales_rep_match'];
            $customer_filter = $_POST['customer_vendor_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);

            $sales_rep_match = $_POST['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);

            $showdetail = $_POST['showdetail'];
            $invoices_paid = $_POST['invoices_paid'];
        }

        if (!$stream) {
	        $save = $_POST['save'];
	        $saved_cat = "customer_statement";
	        $report_name = $_POST['report_name'];
	        $report_descr = $_POST['report_descr'];
	        $share = $_POST['share'];
	        $sales_rep_share = $_POST['sales_rep_share'];
	        $group_share = $_POST['group_share'];
	        if (!$save)
	            unset($report_name, $report_descr, $share, $sales_rep_share, $group_share);
	        if ($save && !$report_name) {
	            $this->content['error'] = 1;
	            $this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
	        }
	        if ($save && !$report_hash) {
	            $result = $this->db->query("SELECT COUNT(*) AS Total
	                                        FROM `reports`
	                                        WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
	            if ($this->db->result($result)) {
	                $this->content['error'] = 1;
	                $this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
	            }
	        }
	        if ($share && !count($sales_rep_share) && !count($group_share)) {
	            $this->content['error'] = 1;
	            $this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
	        }
	        if ($timeframe == 5 && (($sort_to_date && $sort_from_date && strtotime($sort_from_date) > strtotime($sort_to_date)) || (!$sort_from_date || !$sort_to_date))) {
	            $this->content['error'] = 1;
	            $this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you select a valid date range.";
	        }
	        if (!$age1 || !$age2 || !$age3 || $age3 < $age2 || $age3 < $age1 || $age2 < $age1 || strspn($age1, "0123456789") != strlen($age1) || strspn($age2, "0123456789") != strlen($age2) || strspn($age3, "0123456789") != strlen($age3) || $age1 <= 0 || $age2 <= 0 || $age3 <= 0 || $age1 > 99 || $age2 > 99 || $age3 > 99) {
	            $this->content['error'] = 1;
	            $this->content['form_return']['feedback'][] = "Please enter valid aging schedules. Each of the 3 schedules must be specified and Age 3 must be greater than Age 2, Age 2 greater than Age 1, etc.";
	        }

	        if ($this->content['error'])
	            return;

	        switch ($timeframe) {
	        	case 1:
					$date_start = date("Y").'-01-01';
					$date_end = date("Y").'-12-31';
					$this->report_title = "dated this year, ".date("Y");
				break;

				case 2:
					$date_start = date("Y", strtotime(date("Y-m-d")." -1 year"))."-01-01";
					$date_end = date("Y", strtotime(date("Y-m-d")." -1 year"))."-12-31";
					$this->report_title = "dated last year, ".date("Y", strtotime(date("Y-m-d")." -1 year"));
					$compare_date = date("Y-12-31", strtotime(date("Y-m-d")." -1 year"));
				break;

				case 3:
					$period_info = get_period_info(date("Y-m-d"));
					if ($period_info['period_start']) {
						$date_start = $period_info['period_start'];
						$date_end = $period_info['period_end'];
						$this->report_title = "dated within the current period, between ".date(DATE_FORMAT, strtotime($period_info['period_start']))." and ".date(DATE_FORMAT, strtotime($period_info['period_end']));
					} else {
						$this->content['error'] = 1;
						$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
						return;
					}
				break;

				case 4:
					$period_info = get_previous_period(date("Y-m-d"));
					if ($period_info['period_start']) {
						$date_start = $period_info['period_start'];
						$date_end = $period_info['period_end'];
						$this->report_title = "dated last period, between ".date(DATE_FORMAT, strtotime($period_info['period_start']))." and ".date(DATE_FORMAT, strtotime($period_info['period_end']));
						$compare_date = date("Y-m-d", strtotime($period_info['period_end']));
					} else {
						$this->content['error'] = 1;
						$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
					return;
					}
				break;

				case 5:
					if ($sort_from_date && $sort_to_date) {
						$date_start = $sort_from_date;
						$date_end = $sort_to_date;
						$this->report_title = "dated between ".date(DATE_FORMAT, strtotime($sort_from_date))." and ".date(DATE_FORMAT, strtotime($sort_to_date));
						if (strtotime($sort_to_date) < strtotime(date("Y-m-d")))
	                    	$compare_date = date("Y-m-d", strtotime($sort_to_date));
					}
				break;

				default:
					$date_start = "1999-01-01";
					$date_end = date('Y-m-d');
					$this->report_title = "dated as of " . date(DATE_FORMAT);
				break;
			}

			$sql_p[] = "invoice_date BETWEEN '$date_start' AND '$date_end'";

			if (!$compare_date)
				$compare_date = date('Y-m-d');

			if (is_array($sales_rep_match) && count($sales_rep_match)) {
				array_walk($sales_rep_match, 'add_quotes', "'");
				$sql_p[] = "sales_hash IN (".implode(" , ", $sales_rep_match).")";
				array_walk($sales_rep_match, 'strip_quotes');
				$left_join[] = "proposals";
			}
			if (is_array($customer_filter) && count($customer_filter)) {
				$customer_filter = array_unique($customer_filter);
				$customer_filter = array_values($customer_filter);
				array_walk($customer_filter, 'add_quotes', "'");
				$sql_p[] = "customer_hash IN (".implode(" , ", $customer_filter).")";
				array_walk($customer_filter, 'strip_quotes');
			}

			if ($invoices_paid == 1) {
				$sql_p[] = "balance_total != 0";
				$this->report_title = "Invoices with an open balance ".$this->report_title;
			} elseif ($invoices_paid == 2) {
				$sql_p[] = "balance_total = 0";
				$this->report_title = "Invoice with a zero balance ".$this->report_title;
			}

			if ($sql_p)
    	        $sql = implode(" AND ", $sql_p);

	        $str = "timeframe=$timeframe|sort_from_date=$sort_from_date|showdetail=$showdetail|sort_to_date=$sort_to_date|age1=$age1|age2=$age2|age3=$age3|sales_rep_match=".@implode("&", $sales_rep_match)."|customer_filter=".@implode("&", $customer_filter)."|invoices_paid=$invoices_paid|compare_date=$compare_date|date_start=$date_start|date_end=$date_end|report_title=".$this->report_title;

			if (!$report_hash) {
	            $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));
	            while (global_classes::key_exists('reports', 'report_hash', $report_hash))
	                $report_hash = md5(global_classes::get_rand_id(32, "global_classes"));

	            $this->db->query("INSERT INTO `reports`
	                              (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `method` , `sql`)
	                              VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".__METHOD__."' , '".addslashes($sql)."')");

	            if ($share && (count($group_share) || count($sales_rep_share))) {
	                for ($i = 0; $i < count($group_share); $i++)
	                    $this->db->query("INSERT INTO `reports_share`
	                                      (`report_hash` , `group_hash`)
	                                      VALUES ('$report_hash' , '".$group_share[$i]."')");

	                for ($i = 0; $i < count($sales_rep_share); $i++)
	                    $this->db->query("INSERT INTO `reports_share`
	                                      (`report_hash` , `user_hash`)
	                                      VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
	            }
	        } elseif (!$from_saved) {
	            $existing = true;
	            $this->db->query("UPDATE `reports`
	                              SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' , `sql` = '".addslashes($sql)."'
	                              WHERE `report_hash` = '$report_hash'");

	            if (!$share)
	                $this->db->query("DELETE FROM `reports_share`
	                                  WHERE `report_hash` = '".$this->report_hash."'");
	            else {
	                if (!is_array($sales_rep_share))
	                    $sales_rep_share = array();
	                if (!is_array($group_share))
	                    $group_share = array();

	                //Share or revoke to users
	                $result = $this->db->query("SELECT `user_hash`
	                                            FROM `reports_share`
	                                            WHERE `report_hash` = '$report_hash'");
	                while ($row = $this->db->fetch_assoc($result))
	                    $current_share_users[] = $row['user_hash'];

	                if (!is_array($current_share_users))
	                    $current_share_users = array();

	                $to_remove = array_diff($current_share_users, $sales_rep_share);
	                if (is_array($to_remove)) {
	                    while (list($i) = each($to_remove))
	                        $this->db->query("DELETE FROM `reports_share`
	                                          WHERE `user_hash` = '".$current_share_users[$i]."'");
	                }
	                $to_add = array_diff($sales_rep_share, $current_share_users);
	                if (is_array($to_add)) {
	                    while (list($i) = each($to_add))
	                        $this->db->query("INSERT INTO `reports_share`
	                                          (`report_hash` , `user_hash`)
	                                          VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
	                }

	                //Share or revoke to groups
	                $result = $this->db->query("SELECT `group_hash`
	                                            FROM `reports_share`
	                                            WHERE `report_hash` = '$report_hash'");
	                while ($row = $this->db->fetch_assoc($result))
	                    $current_share_groups[] = $row['group_hash'];

	                if (!is_array($current_share_groups))
	                    $current_share_groups = array();

	                $to_remove = array_diff($current_share_groups, $group_share);
	                if (is_array($to_remove)) {
	                    while (list($i) = each($to_remove))
	                        $this->db->query("DELETE FROM `reports_share`
	                                          WHERE `group_hash` = '".$current_share_groups[$i]."'");
	                }
	                $to_add = array_diff($group_share, $current_share_groups);
	                if (is_array($to_add)) {
	                    while (list($i) = each($to_add))
	                        $this->db->query("INSERT INTO `reports_share`
	                                          (`report_hash` , `group_hash`)
	                                          VALUES ('$report_hash' , '".$group_share[$i]."'");
	                }
	            }
	        }
        }

        $this->report_hash = ($report_hash ? $report_hash : $this->report_hash);
		if ($stream && (!$format || $format == 'htm')) {

			$this->db->query("SET @DEFAULT_CUST_PAY_TERMS = ".DEFAULT_CUST_PAY_TERMS);
			$this->db->query("CALL customer_statement('{$this->current_report['compare_date']}', '{$this->current_report['age1']}', '{$this->current_report['age2']}', '{$this->current_report['age3']}');");

            $this->content['html']['place_holder'] = $this->customer_statement(1);
            $this->content['action'] = 'close';

        } else {
            $this->content['action'] = 'close';
            return $this->stream_report();
        }

        return;
    }
}