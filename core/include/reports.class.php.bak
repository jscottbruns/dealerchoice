<?php
class reports extends AJAX_library {


	function reports($passedHash=NULL) {
		global $db;
		
		if ($passedHash)
			$this->current_hash = $passedHash;
		else
			$this->current_hash = $_SESSION['id_hash'];
			
		$this->form = new form;
		$this->db =& $db;
		$this->content['class_name'] = get_class($this);
		
		$this->p = new permissions($this->current_hash);

		$this->sys = new system_config($this->current_hash);
		$this->sys->fetch_users();
		$this->user_name[] = "All Sales Reps";
		$this->user_hash[] = "";
		for ($i = 0; $i < count($this->sys->user_info); $i++) {
			$this->user_name[] = stripslashes($this->sys->user_info[$i]['full_name']);
			$this->user_hash[] = $this->sys->user_info[$i]['user_hash'];			
		}

		$this->sys->fetch_groups();
		for ($i = 0; $i < count($this->sys->group_info); $i++) {
			$this->group_name[] = $this->sys->group_info[$i]['group_name'];
			$this->group_hash[] = $this->sys->group_info[$i]['group_hash'];
		}
		return;
	}

	function doit() {
		global $err,$errStr;
		
		$this->check = new Validator;
		
		$action = $_POST['action'];
		$btn = $_POST['actionBtn'];

		$this->popup_id = $_POST['popup_id'];	
		$this->content['popup_controls']['popup_id'] = $this->popup_id;

		$active_search = $_POST['active_search'];
		if ($active_search)
			$this->active_search = $active_search;
		
		if ($action)
			return $this->$action();
			
		return;
	}
	
	function key_search() {
		$display_area = $_POST['display_area'];
		$q = trim($_POST['q']);
		$parent_name = $_POST['parent_name'];
		$parent_id = $_POST['parent_id'];
		if (!$q) {
			$this->content["jscript"] = "$('".$display_area."').style.display='none'";
			$this->content['html']['keyResults'] = '';
			return;
		}
		switch ($parent_name) {
			case 'customer':
			$result = $this->db->query("SELECT ".DB_PREFIX."customers.customer_hash as ID, ".DB_PREFIX."customers.customer_name as NAME , 
										".DB_PREFIX."customers.street1 as STREET1 , ".DB_PREFIX."customers.street2 as STREET2 , ".DB_PREFIX."customers.city as CITY , 
										".DB_PREFIX."customers.state as STATE , ".DB_PREFIX."customers.zip as ZIP 
										FROM `".DB_PREFIX."customers`
										WHERE `customer_name` LIKE '".$q."%'
										ORDER BY `customer_name`");
			$title = "Customer List:";
			$style = "style=\"height:125px;overflow:auto;\"";
			break;

			case 'proposal':
			$result = $this->db->query("SELECT ".DB_PREFIX."proposals.proposal_hash as ID, ".DB_PREFIX."proposals.proposal_no as NAME , 
									   ".DB_PREFIX."proposals.proposal_descr as DESCR 
										FROM `".DB_PREFIX."proposals`
										WHERE ".DB_PREFIX."proposals.proposal_no LIKE '%".$q."%'
										ORDER BY ".DB_PREFIX."proposals.proposal_no");
			$title = "Proposal List:";
			$style = "style=\"height:125px;overflow:auto;\"";
			break;

			case 'vendor':
			$result = $this->db->query("SELECT ".DB_PREFIX."vendors.vendor_hash as ID, ".DB_PREFIX."vendors.vendor_name as NAME , 
										".DB_PREFIX."vendors.street1 as STREET1 , ".DB_PREFIX."vendors.street2 as STREET2 , ".DB_PREFIX."vendors.city as CITY , 
										".DB_PREFIX."vendors.state as STATE , ".DB_PREFIX."vendors.zip as ZIP 
										FROM `".DB_PREFIX."vendors`
										WHERE `vendor_name` LIKE '".$q."%'
										ORDER BY `vendor_name`");
			$title = "Vendor List:";
			$style = "style=\"height:125px;overflow:auto;\"";
			break;

			case 'customer_vendor':
			$result = $this->db->query("SELECT ".DB_PREFIX."customers.customer_hash as ID, ".DB_PREFIX."customers.customer_name as NAME , 
										".DB_PREFIX."customers.street1 as STREET1 , ".DB_PREFIX."customers.street2 as STREET2 , ".DB_PREFIX."customers.city as CITY , 
										".DB_PREFIX."customers.state as STATE , ".DB_PREFIX."customers.zip as ZIP 
										FROM `".DB_PREFIX."customers`
										WHERE `customer_name` LIKE '".$q."%'
										UNION
										SELECT ".DB_PREFIX."vendors.vendor_hash as ID, ".DB_PREFIX."vendors.vendor_name as NAME , 
										".DB_PREFIX."vendors.street1 as STREET1 , ".DB_PREFIX."vendors.street2 as STREET2 , ".DB_PREFIX."vendors.city as CITY , 
										".DB_PREFIX."vendors.state as STATE , ".DB_PREFIX."vendors.zip as ZIP 
										FROM `".DB_PREFIX."vendors`
										WHERE `vendor_name` LIKE '".$q."%'
										ORDER BY `NAME`");
			$title = "Customer/Vendor List:";
			$style = "style=\"height:125px;overflow:auto;\"";
			break;

		}
		while ($row = $this->db->fetch_assoc($result)) {
			$i++;
			if ($parent_name == 'customer') 
				$innerHTML .= "
				<div style=\"padding:5px;\" id=\"customer_".$row['ID']."\">
					&nbsp;".addslashes($row['NAME']).
					"
				</div>";
			elseif ($parent_name == 'vendor') 
				$innerHTML .= "
				<div style=\"padding:5px;\" id=\"vendor_".$row['ID']."\">
					&nbsp;".addslashes($row['NAME']).
					"
				</div>";
				
			$q_results .= "
			<div id=\"key_result_".$i."\" ".(strlen($row['NAME']) > 35 || $row['STREET1'] ? "title=\"".$row['NAME']."".($row['STREET1'] ? "\n".$row['STREET1'].($row['STREET2'] ? "\n".$row['STREET2'] : NULL).($row['CITY'] ? "\n".$row['CITY'] : NULL).($row['STATE'] ? ", ".$row['STATE'] : NULL).($row['ZIP'] ? "\n".$row['ZIP'] : NULL) : NULL)."\"" : NULL)."
				 onmouseover=\"this.className='search_suggest_over';reset_key_holder('".$i."');\" 
				 onmouseout=\"this.className=''\" 
				 onClick=\"key_clear();".($parent_name == 'customer' || $parent_name == 'vendor' || $parent_name == 'proposal' || $parent_name == 'customer_vendor' ? 
				 	"clear_values('".$parent_name."');\$('".$parent_name."_filter_holder').innerHTML += '<div id=\'".$parent_name."_".$row['ID']."\' style=\'padding:5px 2px 0 5px;\'>[<small><a href=\'javascript:void(0);\' onClick=\'remove_el(this.parentElement.parentElement)\' class=\'link_standard\' title=\'Remove from filter\'>x</a></small>]&nbsp;".addslashes((strlen($row['NAME']) > 25 ? substr($row['NAME'],0,22)."..." : $row['NAME']))."<input type=\'hidden\' id=\'".$parent_name."_filter\' name=\'".$parent_name."_filter[]\' value=\'".$row['ID']."\' /></div>'" : NULL)."\"
				 style=\"padding:2px 5px\">".($row['DESCR'] ? "
				 	<div style=\"float:right;\">".addslashes($row['DESCR'])."</div>" : NULL).(strlen($row['NAME']) > 35 ? 
						substr($row['NAME'],0,32)."..." : $row['NAME'])."
			</div>";
		}
		if (!$this->db->num_rows($result)) 
			$q_results = "<div style=\"padding:2px 5px;font-style:italic\">No results...</div>";
		else
			$q_results = ($title ? "
			<div class=\"function_menu_item\" style=\"font-weight:bold;border-bottom:1px solid #8c8c8c\">
				<div style=\"float:right;padding-right:1px;\">
					<a href=\"javascript:void(0);\" onClick=\"toggle_display('keyResults','none');\"><img src=\"images/close.gif\" border=\"0\"></a>
				</div>
				$title
			</div>" : NULL)."
			<div ".$style.">".$q_results."</div>";
		
		$this->content["jscript"] = "toggle_display('".$display_area."','block');".($parent_name == 'customer' || $parent_name == 'vendor' || $parent_name == 'proposal' || $parent_name == 'customer_vendor' ? "toggle_display('".$parent_name."_filter_holder','block');" : NULL)."reset_key_holder(0);";
		$this->content['html'][$display_area] = $q_results;		
	}
	
	function fetch_report_settings($report_hash) {
		if (!$report_hash)
			return;
			
		$result = $this->db->query("SELECT * 
									FROM `".DB_PREFIX."reports`
									WHERE `report_hash` = '$report_hash'");
		if ($row = $this->db->fetch_assoc($result)) {
			$this->current_report = $row;
			$str = explode("|",$this->current_report['str']);
			for ($i = 0; $i < count($str); $i++) {
				list($var,$val) = explode('=',$str[$i]);
				if (ereg("&",$val)) 
					$val = explode("&",$val);
				
				$this->current_report[$var] = $val;
			}
			if ($this->current_report['method_vars'])
				$this->current_report['method_vars'] = unserialize(stripslashes($this->current_report['method_vars']));
			
			$this->report_hash = $report_hash;
			
			$result = $this->db->query("SELECT `user_hash` , `group_hash`
										FROM `".DB_PREFIX."reports_share`
										WHERE `report_hash` = '".$this->report_hash."'");
			while ($row = $this->db->fetch_assoc($result)) {
				if ($row['user_hash'])
					$this->current_report['sales_rep_share'][] = $row['user_hash'];
				elseif ($row['group_hash'])
					$this->current_report['group_share'][] = $row['group_hash'];
			}
			if (count($this->current_report['sales_rep_share']) || count($this->current_report['group_share']))
				$this->current_report['share'] = 1;
				
			return true;
		}
		return false;
	}
	
	function doit_cash_disp() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		
		if ($report_hash && $doit_print) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$detail = $this->current_report['detail'];
			if ($timeframe == 13) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$vendor_filter = $this->current_report['customer_vendor_filter'];
			if ($vendor_filter && !is_array($vendor_filter)) 
                $vendor_filter = array($vendor_filter);
                			
		} else {
			$timeframe = $_POST['timeframe'];
			$detail = $_POST['detail'];
			if ($timeframe == 13) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$vendor_filter = $_POST['customer_vendor_filter'];	
			if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);			
		}
		
		if ($from_report = $_POST['from_report']) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$detail = $this->current_report['detail'];
			if ($timeframe == 13) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
		}
		$save = $_POST['save'];
		$saved_cat = "cash_disp_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		$from_report = $_POST['from_report'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 13 && !$sort_from_date) || ($timeframe == 13 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		
		if ($this->content['error'])
			return;
			
		switch ($timeframe) {
			//Today
			case 1:
			$sql_p[] = DB_PREFIX."check_register.check_date = '".date("Y-m-d")."'";
			break;
			
			//Yesterday
			case 2:
			$sql_p[] = DB_PREFIX."check_register.check_date = '".date("Y-m-d",strtotime(date("Y-m-d")." -1 day"))."'";
			break;
			
			//This week
			case 3:
			$week_start = date("Y-m-d",strtotime(date("Y-m-d")." -".date("w")." days"));
			$week_end = date("Y-m-d",strtotime(date("Y-m-d")." +".(6 - date("w"))." days"));
			$sql_p[] = DB_PREFIX."check_register.check_date BETWEEN '$week_start' AND '$week_end'";
			break;
			
			//Last week
			case 4:
			$last_week = date("Y-m-d",strtotime(date("Y-m-d")." -1 week"));			
			$week_start = date("Y-m-d",strtotime($last_week." -".date("w")." days"));
			$week_end = date("Y-m-d",strtotime($last_week." +".(6 - date("w",strtotime($last_week)))." days"));
			$sql_p[] = DB_PREFIX."check_register.check_date BETWEEN '$week_start' AND '$week_end'";
			break;
			
			//This month
			case 5:
			$sql_p[] = DB_PREFIX."check_register.check_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-".date("t"))."'";
			break;
			
			//Last Month
			case 6:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}
			$sql_p[] = DB_PREFIX."check_register.check_date BETWEEN '".$year."-".$month."-01' AND '".$year."-".$month."-".date("t",strtotime($year."-".$month."-01"))."'";
			break;

			//This qtr
			case 7:
			$current_qtr = get_quarter();
			list($start,$end) = get_quarter_dates($current_qtr);
			$sql_p[] = DB_PREFIX."check_register.check_date BETWEEN '".$start."' AND '".$end."'";
			break;
			
			//Last qtr
			case 8:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."check_register.check_date BETWEEN '".$start."' AND '".$end."'";
			break;
			
			//This period
			case 9:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."check_register.check_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//Last period
			case 10:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."check_register.check_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//This year
			case 11:
			$sql_p[] = "YEAR(".DB_PREFIX."check_register.check_date) = '".date("Y")."'";
			break;

			//Last year
			case 12:
			$sql_p[] = "YEAR(".DB_PREFIX."check_register.check_date) = ".date("Y",strtotime(date("Y-m-d")." -1 year"));
			break;
			
			//Date range
			case 13:
			if ($sort_from_date && $sort_to_date) 
				$sql_p[] = DB_PREFIX."check_register.check_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
			else
				$sql_p[] = DB_PREFIX."check_register.check_date >= '".$sort_from_date."'";
			break;
			
		}
		
		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."vendor_payables.vendor_hash IN (".implode(" , ",$vendor_filter).")";
			array_walk($vendor_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		
		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|detail=$detail|vendor_filter=".@implode("&",$vendor_filter);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."vendor_payment.payment_hash , ".DB_PREFIX."vendor_payment.check_no , SUM(".DB_PREFIX."vendor_payment.payment_amount) AS total_payment , ".DB_PREFIX."check_register.check_date ,
									".DB_PREFIX."check_register.void , ".DB_PREFIX."vendor_payables.vendor_hash , ".DB_PREFIX."vendor_payables.type , ".DB_PREFIX."vendors.vendor_name , 
								    CASE 
								    WHEN ".DB_PREFIX."vendor_payables.type = 'R'
									  	THEN ".DB_PREFIX."customers.customer_name
									  	ELSE 0
								   	END AS customer_name 
									FROM `".DB_PREFIX."vendor_payment`
									LEFT JOIN `".DB_PREFIX."vendor_payables` ON ".DB_PREFIX."vendor_payables.invoice_hash = ".DB_PREFIX."vendor_payment.invoice_hash
									LEFT JOIN `".DB_PREFIX."check_register` ON ".DB_PREFIX."check_register.check_no = ".DB_PREFIX."vendor_payment.check_no
									LEFT JOIN `".DB_PREFIX."customers` ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."vendor_payables.vendor_hash
									LEFT JOIN `".DB_PREFIX."vendors` ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."vendor_payables.vendor_hash
									WHERE ".DB_PREFIX."check_register.void = 0 ".($sql ? "AND ".$sql : NULL)."
									GROUP BY ".DB_PREFIX."vendor_payables.vendor_hash , ".DB_PREFIX."vendor_payment.check_no");
		while ($row = $this->db->fetch_assoc($result)) {
			$payment[$row['vendor_hash']][$row['check_no']][] = $row;				
			$vendor_name[$row['vendor_hash']] = ($row['type'] == 'R' ? $row['customer_name'] : $row['vendor_name']);
			
			if ($detail) {
				$amount = $date = $invoice_no = '';
				$amount_arr = $date_arr = $invoice_no_arr = array();
				$result2 = $this->db->query("SELECT ".DB_PREFIX."vendor_payables.invoice_no , ".DB_PREFIX."vendor_payables.invoice_date , 
											".DB_PREFIX."vendor_payment.payment_amount as amount , ".DB_PREFIX."vendor_payables.invoice_hash , ".DB_PREFIX."vendor_payables.type
											FROM `".DB_PREFIX."vendor_payables`
											LEFT JOIN `".DB_PREFIX."vendor_payment` ON ".DB_PREFIX."vendor_payment.invoice_hash = ".DB_PREFIX."vendor_payables.invoice_hash
											WHERE ".DB_PREFIX."vendor_payables.vendor_hash = '".$row['vendor_hash']."' AND ".DB_PREFIX."vendor_payment.check_no = '".$row['check_no']."'
											ORDER BY ".DB_PREFIX."vendor_payables.invoice_date");
				while ($row2 = $this->db->fetch_assoc($result2)) {
					if ($doit_print) {
						 $invoice_no_arr[] = ($row2['type'] == 'R' ? "Customer Refund " : ($row2['type'] == 'D' ? "Deposit " : "Invoice ")) . ($row2['invoice_no'] ? $row2['invoice_no'] : "Unassigned");						
					} else {
						$invoice_no .= "<div style=\"font-size:8pt;\">".($row2['type'] == 'R' ? 
						"Customer Refund" : ($row2['type'] == 'D' ? "Deposit" : "Invoice")) ." <a href=\"javascript:void(0);\" onClick=\"agent.call('payables','sf_loadcontent','show_popup_window','edit_invoice','popup_id=invoice_detail','invoice_hash=".$row2['invoice_hash']."');\" class=\"link_standard\" title=\"View this invoice\">".($row2['invoice_no'] ? $row2['invoice_no'] : "Unassigned")."</a></div>";	
					}
					if ($doit_print) {
						$date_arr[] = $row2['invoice_date'];	
					} else {
						$date .= "<div style=\"font-size:8pt;\">".date(DATE_FORMAT,strtotime($row2['invoice_date']))."</div>";	
					}
					if ($doit_print) {
						$amount_arr[] = $row2['amount'];
					} else {
						$amount .= "<div style=\"font-size:8pt;\">$".number_format($row2['amount'],2)."</div>";
					}
				}
				
				$this->detail[$row['vendor_hash']][$row['check_no']]['invoice_no'] = ($doit_print ? $invoice_no_arr : $invoice_no);
				$this->detail[$row['vendor_hash']][$row['check_no']]['date'] = ($doit_print ? $date_arr : $date);
				$this->detail[$row['vendor_hash']][$row['check_no']]['amount'] = ($doit_print ? $amount_arr : $amount);
			}
			
		}

		//Asending order
		if (is_array($vendor_name)) {					
			asort($vendor_name);	
			while (list($vendor_hash,$name) = each($vendor_name)) {
				$this->payment[$vendor_hash] = $payment[$vendor_hash];
				$this->vendor_name[$vendor_hash] = $name;
			}
		}
		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->cash_disp(1);
		return;


	}
	
	function fetch_invoice_payments() {
		$payment_hash = $this->ajax_vars['payment_hash'];
		$check_no = $this->ajax_vars['check_no'];
		$vendor_hash = $this->ajax_vars['vendor_hash'];
		$report_hash = $this->ajax_vars['report_hash'];
		
		$this->fetch_report_settings($report_hash);

		$result = $this->db->query("SELECT ".DB_PREFIX."vendor_payables.invoice_no , ".DB_PREFIX."vendor_payables.invoice_date , 
									".DB_PREFIX."vendor_payment.payment_amount as amount , ".DB_PREFIX."vendor_payables.invoice_hash , ".DB_PREFIX."vendor_payables.type
									FROM `".DB_PREFIX."vendor_payables`
									LEFT JOIN `".DB_PREFIX."vendor_payment` ON ".DB_PREFIX."vendor_payment.invoice_hash = ".DB_PREFIX."vendor_payables.invoice_hash
									WHERE ".DB_PREFIX."vendor_payables.vendor_hash = '$vendor_hash' AND ".DB_PREFIX."vendor_payment.check_no = '$check_no'
									ORDER BY ".DB_PREFIX."vendor_payables.invoice_date");
		while ($row = $this->db->fetch_assoc($result)) {
			$invoice_no .= "
			<div style=\"font-size:8pt;\">".($row['type'] == 'D' ? 
				"Deposit" : ($row['type'] == 'R' ? "Customer Refund" : "Invoice")) . " <a href=\"javascript:void(0);\" onClick=\"agent.call('payables','sf_loadcontent','show_popup_window','edit_invoice','popup_id=invoice_detail','invoice_hash=".$row['invoice_hash']."');\" class=\"link_standard\" title=\"View this invoice\">".$row['invoice_no']."</a>
			</div>";
			$date .= "
			<div style=\"font-size:8pt;\">".date(DATE_FORMAT,strtotime($row['invoice_date']))."</div>";
			$amount .= "
			<div style=\"font-size:8pt;\">$".number_format($row['amount'],2)."</div>";
		}
		
		$this->content['html']['payment_details_invoice_'.$payment_hash] = $invoice_no;
		$this->content['html']['payment_details_date_'.$payment_hash] = $date;
		$this->content['html']['payment_details_amount_'.$payment_hash] = $amount;
		$this->content['jscript'] = "toggle_display('payment_details_".$payment_hash."','block');";
		return;
	}
	
	
	function cash_disp($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"4\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Cash Disbursements Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','cash_disp','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=cash_disp','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" class=\"link_standard\" ><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:40%;text-align:left;\">Payee</td>
					<td style=\"width:20%;\">Check No.</td>
					<td style=\"width:20%;\" class=\"num_field\">Check Date</td>
					<td class=\"num_field\">Check Amount</td>
				</tr>";

			if (is_array($this->payment)) {
				while (list($vendor_hash,$check_array) = each($this->payment)) {
					$k = 0;
					$total_payments = 0;
					$check_table = '';
					while (list($check_no,$check_data) = each($check_array)) {
						$total_check_payment = 0;
						for ($i = 0; $i < count($check_data); $i++) {
							$total_payments += $check_data[$i]['total_payment'];
							$check_table .= "
							<tr>
								<td style=\"background-color:#ffffff;font-weight:bold;\">".($k == 0 ? $this->vendor_name[$vendor_hash] : NULL)."</td>
								<td style=\"background-color:#ffffff;\">
									<a href=\"javascript:void(0);\" onClick=\"if(\$('payment_details_".$check_data[$i]['payment_hash']."').getStyle('display')=='block'){toggle_display('payment_details_".$check_data[$i]['payment_hash']."','none');\$('payment_details_invoice_".$check_data[$i]['payment_hash']."').innerHTML='';\$('payment_details_amount_".$check_data[$i]['payment_hash']."').innerHTML='';\$('payment_details_date_".$check_data[$i]['payment_hash']."').innerHTML='';} else{agent.call('reports','sf_loadcontent','cf_loadcontent','fetch_invoice_payments','check_no=".$check_data[$i]['check_no']."','vendor_hash=".$vendor_hash."','payment_hash=".$check_data[$i]['payment_hash']."','report_hash=".$this->report_hash."');}\" class=\"link_standard\" title=\"View invoices paid by this receipt\">".($check_data[$i]['check_no'] !== NULL ? 
										$check_data[$i]['check_no'] : "Unassigned")."
									</a>
								</td>
								<td style=\"background-color:#ffffff;\" class=\"num_field\">".($check_data[$i]['check_date'] ? date(DATE_FORMAT,strtotime($check_data[$i]['check_date'])) : NULL)."</td>
								<td style=\"background-color:#ffffff;\" class=\"num_field\">$".number_format($check_data[$i]['total_payment'],2)."</td>
							</tr>
							<tr id=\"payment_details_".$check_data[$i]['payment_hash']."\" style=\"display:".($this->current_report['detail'] ? "block" : "none").";\">
								<td style=\"background-color:#ffffff;\"></td>
								<td style=\"background-color:#ffffff;\" id=\"payment_details_invoice_".$check_data[$i]['payment_hash']."\" class=\"num_field\">".($this->current_report['detail'] ? $this->detail[$vendor_hash][$check_data[$i]['check_no']]['invoice_no'] : NULL)."</td>
								<td style=\"background-color:#ffffff;\" id=\"payment_details_date_".$check_data[$i]['payment_hash']."\" class=\"num_field\">".($this->current_report['detail'] ? $this->detail[$vendor_hash][$check_data[$i]['check_no']]['date'] : NULL)."</td>
								<td style=\"background-color:#ffffff;\" id=\"payment_details_amount_".$check_data[$i]['payment_hash']."\"class=\"num_field\">".($this->current_report['detail'] ? $this->detail[$vendor_hash][$check_data[$i]['check_no']]['amount'] : NULL)."</td>
							</tr>";	
							$k++;
						}
					}
					if ($vendor_hash) {
						$tbl .= 
						$check_table ."
						<tr>
							<td colspan=\"4\" style=\"background-color:#cccccc;\"></td>
						</tr>";
						$grand_total += $total_payments;
					}
				}
			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"4\">There are no results to show.</td>
				</tr>";

			$tbl .= "
				<tr style=\"background-color:#ffffff;\" >
					<td style=\"padding-top:25px;background-color:#efefef;\" colspan=\"3\"></td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:12pt;background-color:#efefef;\" class=\"num_field\">$".number_format($grand_total,2)."</td>
				</tr>
			</table>".
			$this->form->close_form();						
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
				
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_cash_disp');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_cash_disp','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Cash Disbursements Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("Today",
																		  "Yesterday",
																		  "This Week",
																		  "Last Week",
																    	  "This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																		  "To Date",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9,
																		  10,
																		  11,
																		  12,
																		  '*',
																		  13),"onChange=if(this.options[this.selectedIndex].value==13){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 13 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Invoice Detail?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("detail",array("Show Detail View","Show Simple View"),$this->current_report['detail'],array(1,0),"blank=1")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer_vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer_vendor','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++) 
														$tbl .= "<div id=\"customer_vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	

	function doit_po_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$paginate = $_POST['paginate'];
		//TODO ask Jeff- Verify this is correct for handling paginate
		
		if(($report_hash && $doit_print) || ($paginate)){
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 13) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$vendor_filter = $this->current_report['vendor_filter'];
			$sales_rep_match = $this->current_report['sales_rep_match'];
	        if ($sales_rep_match && !is_array($sales_rep_match))
	            $sales_rep_match = array($sales_rep_match);	
	            		
		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 13) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$vendor_filter = $_POST['customer_vendor_filter'];
			$sales_rep_match = $_POST['sales_rep_match'];
		}

		if ($vendor_filter && !is_array($vendor_filter))
			$vendor_filter = array($vendor_filter);
		if ($sales_rep_match && !is_array($sales_rep_match))
			$sales_rep_match = array($sales_rep_match);
		if ($paginate = $_POST['paginate']) {
			$this->fetch_report_settings($report_hash);
			$p = $_POST['p'];
		}

		
		if ($from_report = $_POST['from_report']) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 13) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
		}
		
		$save = $_POST['save'];
		$saved_cat = "po_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		$from_report = $_POST['from_report'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 13 && !$sort_from_date) || ($timeframe == 13 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		
		if ($this->content['error'])
			return;
			
		switch ($timeframe) {
			//Today
			case 1:
			$sql_p[] = DB_PREFIX."purchase_order.po_date = '".date("Y-m-d")."'";
			$this->report_title = "Purchase orders dated ".date(DATE_FORMAT);
			break;
			
			//Yesterday
			case 2:
			$sql_p[] = DB_PREFIX."purchase_order.po_date = '".date("Y-m-d",strtotime(date("Y-m-d")." -1 day"))."'";
			$this->report_title = "Purchase orders dated ".date("Y-m-d",strtotime(date("Y-m-d")." -1 day"));
			break;
			
			//This week
			case 3:
			$week_start = date("Y-m-d",strtotime(date("Y-m-d")." -".date("w")." days"));
			$week_end = date("Y-m-d",strtotime(date("Y-m-d")." +".(6 - date("w"))." days"));
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '$week_start' AND '$week_end'";
			$this->report_title = "Purchase orders dated between".date(DATE_FORMAT,strtotime($week_start))." and ".date(DATE_FORMAT,strtotime($week_end));
			break;
			
			//Last week
			case 4:
			$last_week = date("Y-m-d",strtotime(date("Y-m-d")." -1 week"));			
			$week_start = date("Y-m-d",strtotime($last_week." -".date("w")." days"));
			$week_end = date("Y-m-d",strtotime($last_week." +".(6 - date("w",strtotime($last_week)))." days"));
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '$week_start' AND '$week_end'";
			$this->report_title = "Purchase orders dated between".date(DATE_FORMAT,strtotime($week_start))." and ".date(DATE_FORMAT,strtotime($week_end));
			break;
			
			//This month
			case 5:
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-".date("t"))."'";
			$this->report_title = "Purchase orders dated between".date(DATE_FORMAT, strtotime("Y-m-01"))." and ".date(DATE_FORMAT,strtotime("Y-m-".date("t")));
			break;
			
			//Last Month
			case 6:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$year."-".$month."-01' AND '".$year."-".$month."-".date("t",strtotime($year."-".$month."-01"))."'";
			$this->report_title = "Purchase orders dated between".date(DATE_FORMAT,strtotime($year."-".$month."-01"))." and ".date(DATE_FORMAT,strtotime($year."-".$month."-".date("t",strtotime($year."-".$month."-01"))));
			break;

			//This qtr
			case 7:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$start."' AND '".$end."'";
			$this->report_title = "Purchase orders dated between".date(DATE_FORMAT,strtotime($start))." and ".date(DATE_FORMAT,strtotime($end));
			break;
			
			//Last qtr
			case 8:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$start."' AND '".$end."'";
			$this->report_title = "Purchase orders dated between".date(DATE_FORMAT,strtotime($start))." and ".date(DATE_FORMAT,strtotime($end));
			break;
			
			//This period
			case 9:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$this->report_title = "Purchase orders dated between".date(DATE_FORMAT,strtotime($period_info['period_start']))." and ".date(DATE_FORMAT,strtotime($period_info['period_end']));
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//Last period
			case 10:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$this->report_title = "Purchase orders dated between".date(DATE_FORMAT,strtotime($period_info['period_start']))." and ".date(DATE_FORMAT,strtotime($period_info['period_end']));
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//This year
			case 11:
			$sql_p[] = "YEAR(".DB_PREFIX."purchase_order.po_date) = '".date("Y")."'";
			$this->report_title = "Purchase orders dated ".date("Y");
			break;

			//Last year
			case 12:
			$sql_p[] = "YEAR(".DB_PREFIX."purchase_order.po_date) = ".date("Y",strtotime(date("Y-m-d")." -1 year"));
			$this->report_title = "Purchase orders dated ".date("Y")-1;
			break;
			
			//Date range
			case 13:
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = "Purchase orders dated between".date(DATE_FORMAT,strtotime($sort_from_date))." and ".date(DATE_FORMAT,strtotime($sort_to_date));
			} else {
				$sql_p[] = DB_PREFIX."purchase_order.po_date >= '".$sort_from_date."'";
				$this->report_title = "Purchase orders dated after".date(DATE_FORMAT,strtotime($sort_from_date));
			}
			break;
			
			//To Date
			case '*':
				$this->report_title  = "Purchase orders as of ".date(DATE_FORMAT);
				break;
			
		}
		
		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."purchase_order.vendor_hash IN (".implode(" , ",$vendor_filter).")";
			array_walk($vendor_filter,'strip_quotes');
		}
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			$sales_rep_match = array_unique($sales_rep_match);
			$sales_rep_match = array_values($sales_rep_match);
			array_walk($sales_rep_match,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($sales_rep_match,'strip_quotes');
		}
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		
		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|vendor_filter=".@implode("&",$vendor_filter)."|sales_rep_match=".@implode("&",$sales_rep_match);	

		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		//Count first
		$result = $this->db->query("SELECT COUNT(*) AS Total
									FROM `".DB_PREFIX."purchase_order`
									LEFT JOIN `".DB_PREFIX."line_items` ON ".DB_PREFIX."line_items.po_hash = ".DB_PREFIX."purchase_order.po_hash
									LEFT JOIN `".DB_PREFIX."proposals` ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."purchase_order.proposal_hash".($sql ? "
									WHERE ".$sql : NULL)."
									GROUP BY ".DB_PREFIX."line_items.po_hash");
		$this->po_total = $this->db->num_rows($result);
		if ($paginate) {
			$num_pages = ceil($this->po_total / 30);
			$p = (!isset($p) || $p <= 1 || $p > $num_pages) ? 1 : $p;
			$start_from = 30 * ($p - 1);
			$end = $start_from + 30;
			if ($end > $this->po_total);
				$end = $this->po_total;
			
			$this->ajax_vars['p'] = $p;
		} else {
			$start_from = 0;
			$end = 30;
			if ($end > $this->po_total);
				$end = $this->po_total;
		}
		if ($this->po_total > 0) {
			$result = $this->db->query("SELECT ".DB_PREFIX."purchase_order.po_hash , ".DB_PREFIX."purchase_order.po_no , ".DB_PREFIX."purchase_order.proposal_hash , 
										".DB_PREFIX."purchase_order.po_date , ".DB_PREFIX."purchase_order.order_amount , ".DB_PREFIX."purchase_order.vendor_hash , ".DB_PREFIX."proposals.proposal_no , 
										".DB_PREFIX."proposals.proposal_descr , ".DB_PREFIX."proposals.sales_hash , ".DB_PREFIX."customers.customer_name , ".DB_PREFIX."vendors.vendor_name,
										".DB_PREFIX."users.full_name , SUM(".DB_PREFIX."line_items.qty * ".DB_PREFIX."line_items.sell) AS ext_sell
										FROM `".DB_PREFIX."purchase_order`
										LEFT JOIN `".DB_PREFIX."proposals` ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."purchase_order.proposal_hash
										LEFT JOIN `".DB_PREFIX."vendors` ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."purchase_order.vendor_hash
										LEFT JOIN `".DB_PREFIX."line_items` ON ".DB_PREFIX."line_items.po_hash = ".DB_PREFIX."purchase_order.po_hash
										LEFT JOIN `".DB_PREFIX."customers` ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."proposals.customer_hash
										LEFT JOIN `".DB_PREFIX."users` ON ".DB_PREFIX."users.id_hash = ".DB_PREFIX."proposals.sales_hash".($sql ? "
										WHERE ".$sql : NULL)."
										GROUP BY ".DB_PREFIX."line_items.po_hash
										LIMIT $start_from , $end");
			while ($row = $this->db->fetch_assoc($result)) {
				$po[$row['vendor_hash']][$row['proposal_hash']][] = $row;				
				$this->vendor[$row['vendor_hash']] = $row['vendor_name'];
			}
			
			//Asending order					
			@asort($this->vendor);	
			if (is_array($this->vendor)) {
				while (list($hash,$name) = each($this->vendor)) 
					$this->po[$hash] =& $po[$hash];
			}
		}
		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';

		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->po_report(1);
		return;


	}
	
	function po_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);

			$p = $this->ajax_vars['p'];
			$order = $this->ajax_vars['order'];
			$order_dir = $this->ajax_vars['order_dir'];
			
			$num_pages = ceil($this->po_total / 30);
			$p = (!isset($p) || $p <= 1 || $p > $num_pages) ? 1 : $p;
			$start_from = 30 * ($p - 1);
			
			$end = $start_from + 30;
			if ($end > $this->po_total)
				$end = $this->po_total;

			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"4\">".($this->po_total ? "
						<div style=\"float:right;padding-right:15px;\">
						".paginate_jscript($num_pages,$p,'sf_loadcontent','cf_loadcontent','reports','doit_po_report',$order,$order_dir,"'report_hash=".$this->report_hash."','paginate=1'")."
						</div>" : NULL)."
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Purchase Order Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','po_report','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp; &nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=po_report','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>";
			if (is_array($this->po)) {
				while (list($vendor_hash,$proposal_array) = each($this->po)) {
					$vendor_total = 0;
					$inside_tbl = '';
					while (list($proposal_hash,$proposal_list) = each($proposal_array)) {
						$inside_tbl .= "
						<div style=\"font-weight:bold;font-size:12px;margin-bottom:3px;\">
							<div style=\"font-weight:normal;float:right;\">Sales Rep: ".stripslashes($proposal_list[0]['full_name'])."</div>
							Proposal: <a href=\"javascript:void(0);\" onClick=\"agent.call('proposals','sf_loadcontent','show_popup_window','edit_proposal','proposal_hash=".$proposal_hash."','popup_id=proposal_win','from_report=1');\" title=\"View proposal\" class=\"link_standard\">".$proposal_list[0]['proposal_no']."</a>
							 : ".$proposal_list[0]['customer_name']."
						</div>
						<table style=\"width:100%;border:1px solid #cccccc\" cellpadding=\"3\" cellspacing=\"0\">
							<tr>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;\">PO No.</td>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;padding-left:15px;\">Date</td>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">Order Cost</td>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">Sell Amount</td>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
								<td style=\"background-color:#efefef;font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>
							</tr>";
						$total_cost = $total_sell = $total_profit = 0;
						for ($i = 0; $i < count($proposal_list); $i++) {
							$total_cost += $proposal_list[$i]['order_amount'];
							$total_sell += $proposal_list[$i]['ext_sell'];
							$total_profit += ($proposal_list[$i]['ext_sell'] - $proposal_list[$i]['order_amount']);
							$inside_tbl .= "
							<tr >
								<td style=\"font-size:10px;border-bottom:1px solid #cccccc;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('purchase_order','sf_loadcontent','show_popup_window','edit_po','proposal_hash=".$proposal_hash."','po_hash=".$proposal_list[$i]['po_hash']."','popup_id=po_win');\" class=\"link_standard\" title=\"View purchase order\">".$proposal_list[$i]['po_no']."</a></td>
								<td style=\"font-size:10px;border-bottom:1px solid #cccccc;\">".date(DATE_FORMAT,strtotime($proposal_list[$i]['po_date']))."</td>
								<td style=\"font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">$".number_format($proposal_list[$i]['order_amount'],2)."</td>
								<td style=\"font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">$".number_format($proposal_list[$i]['ext_sell'],2)."</td>
								<td style=\"font-size:10px;border-bottom:1px solid #cccccc;\" class=\"num_field\">".($proposal_list[$i]['ext_sell'] - $proposal_list[$i]['order_amount'] < 0 ? 
									"($".number_format(($proposal_list[$i]['ext_sell'] - $proposal_list[$i]['order_amount']) * -1,2).")" : "$".number_format($proposal_list[$i]['ext_sell'] - $proposal_list[$i]['order_amount'],2))."
								</td>
								<td class=\"num_field\" style=\"font-size:10px;border-bottom:1px solid #cccccc;".(defined('MARGIN_FLAG') && math::gp_margin($proposal_list[$i]['order_amount'],$proposal_list[$i]['ext_sell']) < MARGIN_FLAG ? "color:#ff0000;" : NULL)."\">".(math::gp_margin($proposal_list[$i]['order_amount'],$proposal_list[$i]['ext_sell']) * 100)."%</td>
							</tr>";												
						}	
								
						$inside_tbl .= "
							<tr >
								<td style=\"font-size:10px;\">&nbsp;</td>
								<td style=\"font-size:10px;\">&nbsp;</td>
								<td style=\"font-size:10px;\" class=\"num_field\">$".number_format($total_cost,2)."</td>
								<td style=\"font-size:10px;\" class=\"num_field\">$".number_format($total_sell,2)."</td>
								<td style=\"font-size:10px;\" class=\"num_field\">".($total_sell - $total_cost < 0 ? 
									"($".number_format(($total_sell - $total_cost) * -1,2).")" : "$".number_format($total_sell - $total_cost,2))."
								</td>
								<td style=\"font-size:10px;".(defined('MARGIN_FLAG') && math::gp_margin($total_cost,$total_sell) < MARGIN_FLAG ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(math::gp_margin($total_cost,$total_sell) * 100)."%</td>
							</tr>
						</table>";
						$vendor_total += $total_cost;
					}
					$tbl .= "
					<tr style=\"background-color:#ffffff;\">
						<td colspan=\"4\">
							<div style=\"float:right;font-size:13px;margin-top:15px;font-weight:bold;\">
								$".number_format($vendor_total,2)."
							</div>
							<div style=\"font-weight:bold;margin-left:15px;margin-top:15px;font-size:13px;\">
								<a href=\"javascript:void(0);\" onClick=\"submit_form(\$('popup_id').form,'reports','exec_post','refresh_form','action=doit_backlog_report','vendor_filter[]=".$vendor_hash."','from_report=1');\" title=\"Filter to this vendor\" class=\"link_standard\">".$this->vendor[$vendor_hash]."</a>
							</div>
							<div style=\"margin:10px 0 10px 25px;\">".$inside_tbl."</div>
						</td>
					</tr>";
					$grand_total += $vendor_total;
				}
				$tbl .= "
					<tr style=\"background-color:#ffffff;\">
						<td style=\"font-weight:bold;font-size:13px;vertical-align:bottom;padding-top:15px;text-align:right;\" colspan=\"4\">
							<table cellpadding=\"3\">
								<tr>
									<td style=\"text-align:right;\">Purchase Order Total: </td>
									<td style=\"text-align:left;\"> $".number_format($grand_total,2)."</td>
								</tr>
							</table>
						</td>
					</tr>";

			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"4\">There are no results to show.</td>
				</tr>";

			$tbl .= "
			</table>".
			$this->form->close_form();						
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
				
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_po_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_po_report','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Purchase Order Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("Today",
																		  "Yesterday",
																		  "This Week",
																		  "Last Week",
																    	  "This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																		  "To Date",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9,
																		  10,
																		  11,
																		  12,
																		  '*',
																		  13),"onChange=if(this.options[this.selectedIndex].value==13){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 13 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer_vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer_vendor','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++) 
														$tbl .= "<div id=\"customer_vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]",$this->user_name,(is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ''),$this->user_hash,"multiple","blank=1","size=4","style=width:200px;")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	
	function doit_cash_receipts() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		$from_report = $_POST['from_report'];
		
		if ($report_hash && ($doit_print || $from_report)) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$detail = $this->current_report['detail'];
				if ($timeframe == 13) {
					$sort_from_date = $this->current_report['sort_from_date'];
					$sort_to_date = $this->current_report['sort_to_date'];
				}	
			$customer_filter = $this->current_report['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);					
		} else {

			$detail = $_POST['detail'];
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 13) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$customer_filter = $_POST['customer_filter'];			
		}
				
		$save = $_POST['save'];
		$saved_cat = "cash_receipts";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 13 && !$sort_from_date) || ($timeframe == 13 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		
		if ($this->content['error'])
			return;
			
		switch ($timeframe) {
			//Today
			case 1:
			$sql_p[] = DB_PREFIX."customer_payment.receipt_date = '".date("Y-m-d")."'";
			break;
			
			//Yesterday
			case 2:
			$sql_p[] = DB_PREFIX."customer_payment.receipt_date = '".date("Y-m-d",strtotime(date("Y-m-d")." -1 day"))."'";
			break;
			
			//This week
			case 3:
			$week_start = date("Y-m-d",strtotime(date("Y-m-d")." -".date("w")." days"));
			$week_end = date("Y-m-d",strtotime(date("Y-m-d")." +".(6 - date("w"))." days"));
			$sql_p[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '$week_start' AND '$week_end'";
			break;
			
			//Last week
			case 4:
			$last_week = date("Y-m-d",strtotime(date("Y-m-d")." -1 week"));			
			$week_start = date("Y-m-d",strtotime($last_week." -".date("w")." days"));
			$week_end = date("Y-m-d",strtotime($last_week." +".(6 - date("w",strtotime($last_week)))." days"));
			$sql_p[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '$week_start' AND '$week_end'";
			break;
			
			//This month
			case 5:
			$sql_p[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-".date("t"))."'";
			break;
			
			//Last Month
			case 6:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}
			$sql_p[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$year."-".$month."-01' AND '".$year."-".$month."-".date("t",strtotime($year."-".$month."-01"))."'";
			break;

			//This qtr
			case 7:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$start."' AND '".$end."'";
			break;
			
			//Last qtr
			case 8:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$start."' AND '".$end."'";
			break;
			
			//This period
			case 9:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//Last period
			case 10:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//This year
			case 11:
			$sql_p[] = "YEAR(".DB_PREFIX."customer_payment.receipt_date) = '".date("Y")."'";
			break;

			//Last year
			case 12:
			$sql_p[] = "YEAR(".DB_PREFIX."customer_payment.receipt_date) = ".date("Y",strtotime(date("Y-m-d")." -1 year"));
			break;
			
			//Date range
			case 13:
			if ($sort_from_date && $sort_to_date) 
				$sql_p[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
			else
				$sql_p[] = DB_PREFIX."customer_payment.receipt_date >= '".$sort_from_date."'";
			break;
			
		}
		
		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."customer_invoice.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		
		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|detail=$detail|customer_filter=".@implode("&",$customer_filter);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."customer_payment.payment_hash , ".DB_PREFIX."customer_payment.check_no , SUM(".DB_PREFIX."customer_payment.receipt_amount) AS total_reciept , ".DB_PREFIX."customer_payment.receipt_date ,
									".DB_PREFIX."customer_invoice.customer_hash , ".DB_PREFIX."customer_invoice.invoice_to , ".DB_PREFIX."customers.customer_name , 
								    CASE 
								    WHEN ".DB_PREFIX."customer_invoice.invoice_to = 'V'
									  	THEN ".DB_PREFIX."vendors.vendor_name
									  	ELSE 0
								   	END AS vendor_name 
									FROM `".DB_PREFIX."customer_payment`
									LEFT JOIN `".DB_PREFIX."customer_invoice` ON ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."customer_payment.invoice_hash
                                    LEFT JOIN `".DB_PREFIX."proposals` ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."customer_invoice.proposal_hash
									LEFT JOIN `".DB_PREFIX."customers` ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."customer_invoice.customer_hash
									LEFT JOIN `".DB_PREFIX."vendors` ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."customer_invoice.customer_hash
									WHERE ".($sql ? $sql : NULL).($sql ? " AND " : NULL).DB_PREFIX."customer_payment.reconciled = 0 AND ".DB_PREFIX."customer_payment.applied_from = ''
									GROUP BY ".DB_PREFIX."customer_invoice.customer_hash , ".DB_PREFIX."customer_payment.check_no
									ORDER BY ".DB_PREFIX."customers.customer_name , ".DB_PREFIX."customer_payment.check_no ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			$this->payment[$row['customer_hash']][$row['check_no']][] = $row;				
			$this->customer_name[$row['customer_hash']] = ($row['invoice_to'] == 'V' ? $row['vendor_name'] : $row['customer_name']);
			if ($detail) {
				$amount = $date = $invoice_no = '';
				$amount_arr = $date_arr = $invoice_no_arr = array();
				$result2 = $this->db->query("SELECT ".DB_PREFIX."customer_invoice.invoice_no , ".DB_PREFIX."customer_invoice.invoice_date , ".DB_PREFIX."customer_invoice.proposal_hash ,
											".DB_PREFIX."customer_payment.receipt_amount AS amount , ".DB_PREFIX."customer_invoice.invoice_hash , ".DB_PREFIX."customer_invoice.type
											FROM `".DB_PREFIX."customer_invoice`
											LEFT JOIN `".DB_PREFIX."customer_payment` ON ".DB_PREFIX."customer_payment.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash
											WHERE ".DB_PREFIX."customer_invoice.customer_hash = '".$row['customer_hash']."' AND ".DB_PREFIX."customer_payment.check_no = '".$row['check_no']."' AND ".DB_PREFIX."customer_payment.reconciled = 0
											ORDER BY ".DB_PREFIX."customer_invoice.invoice_date");
				while ($row2 = $this->db->fetch_assoc($result2)) {
					if ($doit_print) {
						$invoice_no_arr[] = $row2['invoice_no'];
						$date_arr[] = date(DATE_FORMAT,strtotime($row2['invoice_date']));
						$amount_arr[] = $row2['amount'];
					} else {
						$invoice_no .= "
						<div style=\"font-size:8pt;\">".($row2['type'] == 'D' ? 
							"<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','new_deposit','popup_id=invoice_detail','invoice_hash=".$row2['invoice_hash']."','proposal_hash=".$row2['proposal_hash']."');\" class=\"link_standard\" title=\"View this deposit\">Deposit</a>" : "Invoice <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','edit_invoice','popup_id=invoice_detail','invoice_hash=".$row2['invoice_hash']."');\" class=\"link_standard\" title=\"View this invoice\">".$row2['invoice_no']."</a>")."
						</div>";
						$date .= "
						<div style=\"font-size:8pt;\">".date(DATE_FORMAT,strtotime($row2['invoice_date']))."</div>";
						$amount .= "
						<div style=\"font-size:8pt;\">$".number_format($row2['amount'],2)."</div>";
					}
				}
				if ($doit_print) {
					$this->detail[$row['customer_hash']][$row['check_no']]['invoice_no'] = $invoice_no_arr;
					$this->detail[$row['customer_hash']][$row['check_no']]['date'] = $date_arr;
					$this->detail[$row['customer_hash']][$row['check_no']]['amount'] = $amount_arr;	
				} else {
					$this->detail[$row['customer_hash']][$row['check_no']]['invoice_no'] = $invoice_no;
					$this->detail[$row['customer_hash']][$row['check_no']]['date'] = $date;
					$this->detail[$row['customer_hash']][$row['check_no']]['amount'] = $amount;	
				}
				
			}
		}
		/*Asending order
		if (is_array($customer_name)) {					
			@ksort($customer_name);	
			while (list($customer_hash,$name) = each($customer_name)) {
				$this->payment[$customer_hash] = $payment[$customer_hash];
				$this->customer_name[$customer_hash] = $customer_name[$customer_hash];
			}			
		}

*/
		//$this->customer_name =& $customer_name;
		
		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';
			
		if (!$doit_print)
			$this->content['html']['place_holder'] = $this->cash_receipts(1);
		return;


	}
	
	function fetch_invoice_receipts() {
		$payment_hash = $this->ajax_vars['payment_hash'];
		$check_no = $this->ajax_vars['check_no'];
		$customer_hash = $this->ajax_vars['customer_hash'];
		$report_hash = $this->ajax_vars['report_hash'];
		
		$this->fetch_report_settings($report_hash);

		$result = $this->db->query("SELECT ".DB_PREFIX."customer_invoice.invoice_no , ".DB_PREFIX."customer_invoice.invoice_date , ".DB_PREFIX."customer_invoice.proposal_hash ,
									".DB_PREFIX."customer_payment.receipt_amount AS amount , ".DB_PREFIX."customer_invoice.invoice_hash , ".DB_PREFIX."customer_invoice.type
									FROM `".DB_PREFIX."customer_invoice`
									LEFT JOIN `".DB_PREFIX."customer_payment` ON ".DB_PREFIX."customer_payment.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash
									WHERE ".DB_PREFIX."customer_invoice.customer_hash = '$customer_hash' AND ".DB_PREFIX."customer_payment.check_no = '$check_no' AND ".DB_PREFIX."customer_payment.reconciled = 0
									ORDER BY ".DB_PREFIX."customer_invoice.invoice_date");
		while ($row = $this->db->fetch_assoc($result)) {
			$invoice_no .= "
			<div style=\"font-size:8pt;\">".($row['type'] == 'D' ? 
				"<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','new_deposit','popup_id=invoice_detail','invoice_hash=".$row['invoice_hash']."','proposal_hash=".$row['proposal_hash']."');\" class=\"link_standard\" title=\"View this deposit\">Deposit</a>" : "Invoice <a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','edit_invoice','popup_id=invoice_detail','invoice_hash=".$row['invoice_hash']."');\" class=\"link_standard\" title=\"View this invoice\">".$row['invoice_no']."</a>")."
			</div>";
			$date .= "
			<div style=\"font-size:8pt;\">".date(DATE_FORMAT,strtotime($row['invoice_date']))."</div>";
			$amount .= "
			<div style=\"font-size:8pt;\">$".number_format($row['amount'],2)."</div>";
		}
		
		$this->content['html']['receipt_details_invoice_'.$payment_hash] = $invoice_no;
		$this->content['html']['receipt_details_date_'.$payment_hash] = $date;
		$this->content['html']['receipt_details_amount_'.$payment_hash] = $amount;
		$this->content['jscript'] = "toggle_display('receipt_details_".$payment_hash."','block');";
		return;
	}

	function cash_receipts($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"4\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Cash Receipts Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','cash_receipts','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=cash_receipts','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" class=\"link_standard\" ><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:40%;text-align:left;\">Customer</td>
					<td style=\"width:20%;\">Check No.</td>
					<td style=\"width:20%;\" class=\"num_field\">Receipt Date</td>
					<td class=\"num_field\">Receipt Amount</td>
				</tr>";
			if (is_array($this->payment)) {
				while (list($customer_hash,$check_array) = each($this->payment)) {
					$total_receipts = 0;
					$check_table = '';
					while (list($check_no,$check_data) = each($check_array)) {
						$total_check_receipt = 0;
						for ($i = 0; $i < count($check_data); $i++) {
							$total_check_receipt += $check_data[$i]['total_reciept'];
							$total_receipts += $check_data[$i]['total_reciept'];
							$check_table .= "
							<tr>
								<td style=\"background-color:#ffffff;\"></td>
								<td style=\"background-color:#ffffff;\">
									<a href=\"javascript:void(0);\" onClick=\"if(\$('receipt_details_".$check_data[$i]['payment_hash']."').getStyle('display')=='block'){toggle_display('receipt_details_".$check_data[$i]['payment_hash']."','none');\$('receipt_details_invoice_".$check_data[$i]['payment_hash']."').innerHTML='';\$('receipt_details_amount_".$check_data[$i]['payment_hash']."').innerHTML='';\$('receipt_details_date_".$check_data[$i]['payment_hash']."').innerHTML='';} else{agent.call('reports','sf_loadcontent','cf_loadcontent','fetch_invoice_receipts','check_no=".$check_data[$i]['check_no']."','customer_hash=".$customer_hash."','payment_hash=".$check_data[$i]['payment_hash']."','report_hash=".$this->report_hash."');}\" class=\"link_standard\" title=\"View invoices paid by this receipt\">".($check_data[$i]['check_no'] ? 
										$check_data[$i]['check_no'] : "Unassigned")."
									</a>
								</td>
								<td style=\"background-color:#ffffff;\" class=\"num_field\">".date(DATE_FORMAT,strtotime($check_data[$i]['receipt_date']))."</td>
								<td style=\"background-color:#ffffff;\" class=\"num_field\">$".number_format($total_check_receipt,2)."</td>
							</tr>
							<tr id=\"receipt_details_".$check_data[$i]['payment_hash']."\" style=\"display:".($this->current_report['detail'] ? "block" : "none").";\">
								<td style=\"background-color:#ffffff;\"></td>
								<td style=\"background-color:#ffffff;\" id=\"receipt_details_invoice_".$check_data[$i]['payment_hash']."\" class=\"num_field\">".($this->current_report['detail'] ? $this->detail[$customer_hash][$check_data[$i]['check_no']]['invoice_no'] : NULL)."</td>
								<td style=\"background-color:#ffffff;\" id=\"receipt_details_date_".$check_data[$i]['payment_hash']."\" class=\"num_field\">".($this->current_report['detail'] ? $this->detail[$customer_hash][$check_data[$i]['check_no']]['date'] : NULL)."</td>
								<td style=\"background-color:#ffffff;\" id=\"receipt_details_amount_".$check_data[$i]['payment_hash']."\"class=\"num_field\">".($this->current_report['detail'] ? $this->detail[$customer_hash][$check_data[$i]['check_no']]['amount'] : NULL)."</td>
							</tr>";	
						}
					}
					if ($customer_hash) {
						$tbl .= "
						<tr>
							<td style=\"background-color:#ffffff;font-weight:bold;\">".$this->customer_name[$customer_hash]."</td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\"></td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\"></td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\"></td>
						</tr>
						" . $check_table ."
						<tr>
							<td colspan=\"3\" style=\"background-color:#ffffff;\"></td>
							<td style=\"background-color:#cccccc;\"></td>
						</tr>						
						<tr>
							<td colspan=\"3\" style=\"background-color:#ffffff;\"></td>
							<td style=\"background-color:#ffffff;font-weight:bold;\" class=\"num_field\">$".number_format($total_receipts,2)."</td>
						</tr>
						<tr>
							<td colspan=\"4\" style=\"background-color:#cccccc;\"></td>
						</tr>";
						$grand_total += $total_receipts;
					}
				}
			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"4\">There are no results to show.</td>
				</tr>";


			$tbl .= "
				<tr style=\"background-color:#ffffff;\" >
					<td style=\"padding-top:25px;background-color:#efefef;\" colspan=\"3\"></td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:12pt;background-color:#efefef;\" class=\"num_field\">$".number_format($grand_total,2)."</td>
				</tr>
			</table>".
			$this->form->close_form();						
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_cash_receipts');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_cash_receipts','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Cash Receipts Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("Today",
																		  "Yesterday",
																		  "This Week",
																		  "Last Week",
																    	  "This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																		  "To Date",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9,
																		  10,
																		  11,
																		  12,
																		  '*',
																		  13),"onChange=if(this.options[this.selectedIndex].value==13){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 13 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Invoice Detail?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("detail",array("Show Detail View","Show Simple View"),$this->current_report['detail'],array(1,0),"blank=1")."</td>
                                        </tr>										
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}

	function doit_ar() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}

		$doit_print = $_POST['doit_print'];
		$report_hash = $_POST['report_hash'];
		if ($doit_print && $report_hash) {
			$this->fetch_report_settings($report_hash);
			
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$age1 = $this->current_report['age1'];
			$age2 = $this->current_report['age2'];
			$age3 = $this->current_report['age3'];
			$sales_rep_match = $this->current_report['sales_rep_match'];
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);
				
			$customer_filter = $this->current_report['customer_vendor_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
				
			$showdetail = $this->current_report['showdetail'];
			$deposits = $this->current_report['deposits'];
			$report_date = $this->current_report['report_date'];
            $invoices_paid = $this->current_report['invoices_paid'];
		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$age1 = $_POST['age1'];
			$age2 = $_POST['age2'];
			$age3 = $_POST['age3'];
			$sales_rep_match = $_POST['sales_rep_match'];
			$customer_filter = $_POST['customer_vendor_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
			
            $sales_rep_match = $_POST['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);
                				
			$showdetail = $_POST['showdetail'];
			$deposits = $_POST['deposits'];
            $report_date = $_POST['report_date'];
			$invoices_paid = $_POST['invoices_paid'];
		}

		if ($from_report = $_POST['from_report']) {
			$this->fetch_report_settings($report_hash);
			$customer_filter = $this->current_report['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);

            $sales_rep_match = $this->current_report['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);				
				
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$age1 = $this->current_report['age1'];
			$age2 = $this->current_report['age2'];
			$age3 = $this->current_report['age3'];
			$sales_rep_match = $this->current_report['sales_rep_match'];
            $report_date = $this->current_report['report_date'];			
            $invoices_paid = $this->current_report['invoices_paid'];
            $deposits = $this->current_report['deposits'];
		}		
        $report_date_t = $report_date;
        if ($report_date == 1)
            $report_date = DB_PREFIX."customer_invoice.invoice_date";
        else
            $report_date = "ADDDATE(".DB_PREFIX."customer_invoice.invoice_date,t2.payterms)";
            
		$save = $_POST['save'];
		$saved_cat = "ar_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
        if (($timeframe == 5 && $sort_to_date && $sort_from_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you select a valid date range.";
        }
		if (!$age1 || !$age2 || !$age3 || $age3 < $age2 || $age3 < $age1 || $age2 < $age1 || strspn($age1,"0123456789") != strlen($age1) || strspn($age2,"0123456789") != strlen($age2) || strspn($age3,"0123456789") != strlen($age3) || $age1 <= 0 || $age2 <= 0 || $age3 <= 0) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "Please enter valid aging schedules. Each of the 3 schedules must be specified and Age 3 must be greater than Age 2, Age 2 greater than Age 1, etc.";
		}		
		
		if ($this->content['error'])
			return;
			
		switch ($timeframe) {
			case 1:
			$sql_p[] = "YEAR($report_date) = '".date("Y")."'";
			$sql_p_sub[] = "YEAR(".DB_PREFIX."customer_payment.receipt_date) <= '".date("Y")."'";
			$this->report_title = " dated this year, ".date("Y");
			break;

			case 2:
			$sql_p[] = "YEAR($report_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			$sql_p_sub[] = "YEAR(".DB_PREFIX."customer_payment.receipt_date) <= '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			$this->report_title = " dated last year, ".date("Y",strtotime(date("Y-m-d")." -1 year"));
			$compare_date = date("Y-12-31",strtotime(date("Y-m-d")." -1 year"));
			break;
			
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = $report_date." BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sql_p_sub[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$this->report_title = " dated within the current period, between ".date(DATE_FORMAT,strtotime($period_info['period_start']))." and ".date(DATE_FORMAT,strtotime($period_info['period_end']));
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {		
				$sql_p[] = $report_date." BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
                $sql_p_sub[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$this->report_title = " dated last period, between ".date(DATE_FORMAT,strtotime($period_info['period_start']))." and ".date(DATE_FORMAT,strtotime($period_info['period_end']));
			    $compare_date = date("Y-m-d",strtotime($period_info['period_end']));
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
            case 5:
            if ($sort_from_date && $sort_to_date) {
                $sql_p[] = $report_date." BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
                $sql_p_sub[] = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
                if (strtotime($sort_to_date) < strtotime(date("Y-m-d")))                
                    $compare_date = date("Y-m-d",strtotime($sort_to_date));
             
                $this->report_title = " dated between ".date(DATE_FORMAT,strtotime($sort_from_date))." and ".date(DATE_FORMAT,strtotime($sort_to_date));
            } elseif (!$sort_to_date && $sort_from_date) {
                $sql_p[] = $report_date." >= '".$sort_from_date."'";
                $sql_p_sub[] = DB_PREFIX."customer_payment.receipt_date >= '".$sort_from_date."'";
                $this->report_title = " dated on or after ".date(DATE_FORMAT,strtotime($sort_from_date));
            } elseif ($sort_to_date && !$sort_from_date) {
                $sql_p[] = $report_date." <= '".$sort_to_date."'";
                $sql_p_sub[] = DB_PREFIX."customer_payment.receipt_date <= '".$sort_to_date."'";
                if (strtotime($sort_to_date) < strtotime(date("Y-m-d")))                
                    $compare_date = date("Y-m-d",strtotime($sort_to_date));
                    
                $this->report_title = " dated on or before ".date(DATE_FORMAT,strtotime($sort_to_date));
            } elseif (!$sort_from_date && !$sort_to_date)
                unset($timeframe);
			
            break;
			
			default:
				$this->report_title = " dated as of ".date(DATE_FORMAT);
		}
		
		
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($sales_rep_match,'strip_quotes');
		}
		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."customer_invoice.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}
			
        if ($invoices_paid == 1) {
            $sql_p[] = "((".DB_PREFIX."customer_invoice.type = 'I' AND (ISNULL(".DB_PREFIX."customer_payment.total_amount_paid) AND ".DB_PREFIX."customer_invoice.amount > 0 AND ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied > 0) OR (!ISNULL(".DB_PREFIX."customer_payment.total_amount_paid) AND ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid != 0))".($deposits ? 
                          " OR (".DB_PREFIX."customer_invoice.type = 'D' AND (ISNULL(t2.total_applied_deposits) OR (!ISNULL(t2.total_applied_deposits) AND ".DB_PREFIX."customer_invoice.amount - t2.total_applied_deposits > 0)))" : NULL).")";
            $sql_p_sub_alt = "(".DB_PREFIX."customer_invoice.type = 'I' AND (ISNULL(".DB_PREFIX."customer_payment.total_amount_paid) AND ".DB_PREFIX."customer_invoice.amount > 0 AND ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied > 0) OR ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid != 0)";//.($deposits ? 
                         // " OR (".DB_PREFIX."customer_invoice.type = 'D' AND (ISNULL(t2.total_applied_deposits) OR (!ISNULL(t2.total_applied_deposits) AND ".DB_PREFIX."customer_invoice.amount - t2.total_applied_deposits > 0)))" : NULL).")";
            $this->report_title = "Unpaid invoices".$this->report_title;
        }
        if ($invoices_paid == 2) {
            $sql_p[] = DB_PREFIX."customer_invoice.amount <= 0 OR ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid <= 0";
            $sql_p_sub_alt = DB_PREFIX."customer_invoice.amount <= 0 OR ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid <= 0";
            $this->report_title = "Invoices paid in full".$this->report_title;
        }
        
        if ($sql_p) 
            $sql = implode(" AND ",$sql_p);
           
        if ($sql_p_sub)
            $sql_sub = implode(" AND ",$sql_p_sub);
		
		$str = "timeframe=$timeframe|deposits=$deposits|sort_from_date=$sort_from_date|showdetail=$showdetail|sort_to_date=$sort_to_date|age1=$age1|age2=$age2|age3=$age3|sales_rep_match=".@implode("&",$sales_rep_match)."|customer_filter=".@implode("&",$customer_filter)."|invoices_paid=$invoices_paid|report_date=$report_date";
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."customer_invoice.type , ".DB_PREFIX."customer_invoice.invoice_hash , ".DB_PREFIX."customer_invoice.invoice_no , 
									".DB_PREFIX."customer_invoice.amount , ".DB_PREFIX."customer_invoice.balance , ".DB_PREFIX."customer_invoice.invoice_date , ".DB_PREFIX."customer_invoice.customer_hash , 
									".DB_PREFIX."customer_invoice.deposit_applied , ".DB_PREFIX."customer_invoice.proposal_hash , ".DB_PREFIX."proposals.proposal_no , ".DB_PREFIX."proposals.proposal_descr , 
									".DB_PREFIX."customer_invoice.invoice_to , t2.total_applied_deposits ,
									CASE 
									WHEN ISNULL(".DB_PREFIX."customers.customer_name)
									    THEN ".DB_PREFIX."vendors.vendor_name
									    ELSE ".DB_PREFIX."customers.customer_name
									END AS customer_name , t2.payterms AS payment_terms ,
									(SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ADDDATE(".DB_PREFIX."customer_invoice.invoice_date,t2.payterms) ) <= 0 AND ".DB_PREFIX."customer_invoice.type = 'I' ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."customer_payment.total_amount_paid)
									                THEN ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied
									                ELSE ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid
									             END)
									        ELSE 0
									    END) - 
									SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ADDDATE(".DB_PREFIX."customer_invoice.invoice_date,t2.payterms) ) <= 0 AND ".DB_PREFIX."customer_invoice.type = 'D' ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."customer_payment.total_amount_paid)
									                THEN ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied
									                ELSE ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid
									             END)
									        ELSE 0
									    END)
									) AS balance_current ,
									(SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ADDDATE(".DB_PREFIX."customer_invoice.invoice_date,t2.payterms) ) BETWEEN 1 AND ".($age1 - 1)." AND ".DB_PREFIX."customer_invoice.type = 'I' ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."customer_payment.total_amount_paid)
									                THEN ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied
									                ELSE ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid
									             END)
									        ELSE 0
									    END) - 
									SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ADDDATE(".DB_PREFIX."customer_invoice.invoice_date,t2.payterms) ) BETWEEN 1 AND ".($age1 - 1)." AND ".DB_PREFIX."customer_invoice.type = 'D' ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."customer_payment.total_amount_paid)
									                THEN ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied
									                ELSE ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid
									             END)
									        ELSE 0
									    END)
									) AS balance_sched1 ,
									(SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ADDDATE(".DB_PREFIX."customer_invoice.invoice_date,t2.payterms) ) BETWEEN 30 AND ".($age2 - 1)." AND ".DB_PREFIX."customer_invoice.type = 'I' ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."customer_payment.total_amount_paid)
									                THEN ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied
									                ELSE ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid
									             END)
									        ELSE 0
									    END) - 
									SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ADDDATE(".DB_PREFIX."customer_invoice.invoice_date,t2.payterms) ) BETWEEN 30 AND ".($age2 - 1)." AND ".DB_PREFIX."customer_invoice.type = 'D' ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."customer_payment.total_amount_paid)
									                THEN ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied
									                ELSE ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid
									             END)
									        ELSE 0
									    END)
									) AS balance_sched2 ,
									(SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ADDDATE(".DB_PREFIX."customer_invoice.invoice_date,t2.payterms) ) >= $age2 AND ".DB_PREFIX."customer_invoice.type = 'I' ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."customer_payment.total_amount_paid)
									                THEN ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied
									                ELSE ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid
									             END)
									        ELSE 0
									    END) - 
									SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ADDDATE(".DB_PREFIX."customer_invoice.invoice_date,t2.payterms) ) >= $age2 AND ".DB_PREFIX."customer_invoice.type = 'D' ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."customer_payment.total_amount_paid)
									                THEN ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied
									                ELSE ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid
									             END)
									        ELSE 0
									    END)
									) AS balance_sched3 ,
									(SUM(CASE
									    WHEN ".DB_PREFIX."customer_invoice.type = 'I' ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."customer_payment.total_amount_paid)
									                THEN ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied
									                ELSE ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid
									             END)
									        ELSE 0
									    END) - 
									SUM(CASE
									    WHEN ".DB_PREFIX."customer_invoice.type = 'D' ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."customer_payment.total_amount_paid)
									                THEN ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied
									                ELSE ".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.deposit_applied - ".DB_PREFIX."customer_payment.total_amount_paid
									             END)
									        ELSE 0
									    END)
									) AS balance_total 
									FROM ".DB_PREFIX."customer_invoice
									LEFT JOIN ".DB_PREFIX."proposals ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."customer_invoice.proposal_hash
									LEFT JOIN ( SELECT invoice_hash ,
									            CASE
									            WHEN t2.invoice_to = 'C' 
									                THEN
									                (
									                    SELECT 
									                    CASE
									                    WHEN ".DB_PREFIX."customers.payment_terms > 0
									                        THEN ".DB_PREFIX."customers.payment_terms
									                        ELSE 30
									                    END
									                    FROM ".DB_PREFIX."customers 
									                    WHERE ".DB_PREFIX."customers.customer_hash = t2.customer_hash
									                ) 
									                ELSE 30
									            END AS payterms ,
									            CASE 
									            WHEN t2.type = 'D'
									               THEN ( SELECT SUM(".DB_PREFIX."customer_payment.receipt_amount)
									                      FROM ".DB_PREFIX."customer_invoice tsub2
									                      LEFT JOIN ".DB_PREFIX."customer_payment ON ".DB_PREFIX."customer_payment.invoice_hash = tsub2.invoice_hash
									                      WHERE ".DB_PREFIX."customer_payment.applied_from = t2.invoice_hash ".($sql_sub ? "AND ".$sql_sub : NULL)."
									                    )
									               ELSE 0
									            END total_applied_deposits									               
									            FROM ".DB_PREFIX."customer_invoice t2
									          ) AS t2 ON t2.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash									
									LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."customer_invoice.customer_hash
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."customer_invoice.customer_hash         
									LEFT JOIN ( SELECT invoice_hash , SUM(receipt_amount) AS total_amount_paid
									             FROM ".DB_PREFIX."customer_payment".($sql_sub ? "
									             WHERE $sql_sub" : NULL)."
									             GROUP BY invoice_hash 
									           ) AS ".DB_PREFIX."customer_payment ON ".DB_PREFIX."customer_payment.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash".($sql ? "
									WHERE ".$sql : NULL)."
									GROUP BY ".DB_PREFIX."customer_invoice.invoice_hash
									ORDER BY ".DB_PREFIX."customers.customer_name ASC , ".DB_PREFIX."customer_invoice.invoice_date DESC");
		while ($row = $this->db->fetch_assoc($result)) {
			$result_list[$row['customer_hash']][$row['proposal_hash']][] = $row;
			$sort_list[$row['customer_hash']] = ($row['customer_name'] ? $row['customer_name'] : $row['vendor_name']);
		}				
		
		//Asending order					
		asort($sort_list);	
		if (is_array($sort_list)) {
			while (list($hash,$name) = each($sort_list)) 
				$this->results[$hash] =& $result_list[$hash];
		}				
		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->ar_report(1);
		return;
	}
	
	function fetch_shared_reports() {
		$result = $this->db->query("SELECT `group_hash`
									FROM `".DB_PREFIX."user_subscribe`
									WHERE `id_hash` = '".$this->current_hash."'");
		while ($row = $this->db->fetch_assoc($result))
			$group[] = "'".$row['group_hash']."'";
		
		$result = $this->db->query("SELECT ".DB_PREFIX."reports.timestamp , ".DB_PREFIX."reports.saved_catagory , ".DB_PREFIX."reports.report_hash , ".DB_PREFIX."reports.report_name , ".DB_PREFIX."reports.report_descr
									FROM `".DB_PREFIX."reports`
									LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
									WHERE ".DB_PREFIX."reports_share.user_hash = '".$this->current_hash."'".(is_array($group) ? " OR ".DB_PREFIX."reports_share.group_hash IN (".implode(" , ",$group).")" : NULL)."
									ORDER BY ".DB_PREFIX."reports.timestamp ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			if (!$this->shared_reports[$row['report_hash']] && !$this->custom_reports[$row['report_hash']])
				$this->shared_reports[$row['report_hash']] = $row;
		}
	}
	
	function fetch_custom_reports() {
		$result = $this->db->query("SELECT  ".DB_PREFIX."reports.timestamp , ".DB_PREFIX."reports.saved_catagory , ".DB_PREFIX."reports.report_hash , ".DB_PREFIX."reports.report_name , ".DB_PREFIX."reports.report_descr
									FROM `".DB_PREFIX."reports`
									WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1
									ORDER BY ".DB_PREFIX."reports.timestamp ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			if (!$this->shared_reports[$row['report_hash']] && !$this->custom_reports[$row['report_hash']])
				$this->custom_reports[$row['report_hash']] = $row;
		}
	}
	
	function doit_bookings_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		$report_hash = ($_POST['report_hash'] ? $_POST['report_hash'] : $this->ajax_vars['report_hash']);
		if ($report_hash)
			$this->fetch_report_settings($report_hash);
		
		$timeframe = $_POST['timeframe'];
		if ($timeframe == 5) {
			$sort_from_date = $_POST['sort_from_date'];
			$sort_to_date = $_POST['sort_to_date'];
		}
		$sales_rep_match = $_POST['sales_rep_match'];
		$proposal_filter = $_POST['proposal_filter'];
		if ($proposal_filter && !is_array($proposal_filter))
			$proposal_filter = array($proposal_filter);
		
		$customer_filter = $_POST['customer_filter'];
		$detail = $_POST['detail'];		

		$save = $_POST['save'];
		$saved_cat = "bookings_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		$custom_contract = $_POST['custom_contract'];

		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 5 && !$sort_from_date) || ($timeframe == 5 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		
		if ($this->content['error'])
			return;
			
		switch ($timeframe) {
			//This year
			case 1:
			$this->report_title = "Year To Date ".date(DATE_FORMAT,strtotime(date("Y-m-d")));
			$sql_p[] = "YEAR(".DB_PREFIX."purchase_order.po_date) = '".date("Y")."'";
			break;

			//last year
			case 2:
			$this->report_title = "Year Ending ".date("Y",strtotime(date("Y-m-d")." -1 year"));
			$sql_p[] = "YEAR(".DB_PREFIX."purchase_order.po_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			break;
			
			//current period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
				$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//previous period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
				$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			case 5:
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = date(DATE_FORMAT,strtotime($sort_from_date))." thru ".date(DATE_FORMAT,strtotime($sort_to_date));
			} else {
				$sql_p[] = DB_PREFIX."purchase_order.po_date >= '".$sort_from_date."'";
				$this->report_title = "From ".date(DATE_FORMAT,strtotime($sort_from_date))." To Present";
			} 
			break;

			//This Month
			case 6:
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT,strtotime(date("Y-m-t")));
			break;
			
			//Last Month
			case 7:
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".date("Y-m-01",strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT,strtotime(date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))));
			break;

			default:
			$this->report_title = "To Date";
			break;
		}

        if (@in_array("",$sales_rep_match) && count($sales_rep_match) > 1)
            unset($sales_rep_match[array_search("",$sales_rep_match)]);
        elseif (@in_array("",$sales_rep_match) && count($sales_rep_match) == 1)
            unset($sales_rep_match);                    		    
		    
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match,'add_quotes',"'");
			$sql_p_sub[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($sales_rep_match,'strip_quotes');
		}
		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p_sub[] = DB_PREFIX."proposals.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}
		
        if (is_array($proposal_filter) && count($proposal_filter)) {
            array_walk($proposal_filter,'add_quotes',"'");
            $sql_p_sub[] = DB_PREFIX."proposals.proposal_hash IN (".implode(" , ",$proposal_filter).")";
            array_walk($proposal_filter,'strip_quotes');
        }   		
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
        if ($sql_p_sub)
            $sql_sub = implode(" AND ",$sql_p_sub);        			
			
			
		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|detail=$detail|sales_rep=".@implode("&",$sales_rep_match)."|customer_filter=".@implode("&",$customer_filter)."|proposal_filter=".@implode("&",$proposal_filter);
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

        $result = $this->db->query("SELECT SUM(".DB_PREFIX."purchase_order.order_amount) AS total_true_po_amount , ".DB_PREFIX."proposals.proposal_no , 
                                    ".DB_PREFIX."proposals.proposal_descr , ".DB_PREFIX."proposals.customer_hash , ".DB_PREFIX."proposals.sales_hash , 
                                    ".DB_PREFIX."proposals.proposal_hash as parent_proposal_hash , ".DB_PREFIX."users.full_name , 
                                    ".DB_PREFIX."purchase_order.po_hash AS parent_po_hash ,
                                    (
                                         SELECT ".DB_PREFIX."customers.customer_name
                                         FROM ".DB_PREFIX."customers
                                         WHERE ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."proposals.customer_hash
                                    ) AS customer_name ,                                            
                                    (
                                        SELECT SUM(".DB_PREFIX."line_items.cost * ".DB_PREFIX."line_items.qty) 
                                        FROM `".DB_PREFIX."line_items`
                                        LEFT JOIN `".DB_PREFIX."purchase_order` ON ".DB_PREFIX."purchase_order.po_hash = ".DB_PREFIX."line_items.po_hash
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = parent_proposal_hash".($sql ? " AND " . $sql : NULL)."
                                    ) AS total_po_cost ,    
                                    (
                                        SELECT SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty) 
                                        FROM `".DB_PREFIX."line_items`
                                        LEFT JOIN `".DB_PREFIX."purchase_order` ON ".DB_PREFIX."purchase_order.po_hash = ".DB_PREFIX."line_items.po_hash
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = parent_proposal_hash".($sql ? " AND " . $sql : NULL)."
                                    ) AS total_po_sell , 
                                    (
                                        SELECT COUNT(".DB_PREFIX."work_orders.obj_id)
                                        FROM ".DB_PREFIX."work_order_items
                                        LEFT JOIN ".DB_PREFIX."work_orders ON ".DB_PREFIX."work_orders.order_hash = ".DB_PREFIX."work_order_items.order_hash
                                        WHERE ".DB_PREFIX."work_order_items.po_hash = parent_po_hash
                                    ) AS total_wo
                                    FROM `".DB_PREFIX."purchase_order`
                                    LEFT JOIN `".DB_PREFIX."proposals` ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."purchase_order.proposal_hash
                                    LEFT JOIN `".DB_PREFIX."users` ON ".DB_PREFIX."users.id_hash = ".DB_PREFIX."proposals.sales_hash".($sql || $sql_p_sub ? "
                                    WHERE ".($sql ? 
                                        $sql.($sql_sub ? "
                                            AND " : NULL) : NULL).($sql_sub ? 
                                                $sql_sub : NULL) : NULL)."
                                    GROUP BY ".DB_PREFIX."proposals.proposal_hash
                                    ORDER BY ".DB_PREFIX."proposals.proposal_no");
        $proposal_no = $cost = $sell = $gp = '';
        while ($row = $this->db->fetch_assoc($result)) {
            //Get the work order cost
            $work_order_cost = $work_order_sell = 0;
            if ($row['total_wo']) {
	            $r = $this->db->query("SELECT (SUM(".DB_PREFIX."line_items.cost * ".DB_PREFIX."line_items.qty) / COUNT(".DB_PREFIX."work_order_items.obj_id)) AS c , 
	                                   (SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty) / COUNT(".DB_PREFIX."work_order_items.obj_id)) AS s
	                                   FROM ".DB_PREFIX."purchase_order
	                                   LEFT JOIN ".DB_PREFIX."work_order_items ON ".DB_PREFIX."work_order_items.po_hash = ".DB_PREFIX."purchase_order.po_hash
	                                   LEFT JOIN ".DB_PREFIX."work_orders ON ".DB_PREFIX."work_orders.order_hash = ".DB_PREFIX."work_order_items.order_hash
	                                   LEFT JOIN ".DB_PREFIX."line_items ON ".DB_PREFIX."line_items.work_order_hash = ".DB_PREFIX."work_orders.order_hash                                   
	                                   WHERE ".DB_PREFIX."purchase_order.proposal_hash = '".$row['parent_proposal_hash']."'".($sql ? " 
	                                       AND " . $sql : NULL)." AND !ISNULL(".DB_PREFIX."line_items.work_order_hash)
	                                   GROUP BY ".DB_PREFIX."work_order_items.order_hash");
	            while ($row2 = $this->db->fetch_assoc($r)) {
	                $work_order_cost += $row2['c']; 
	                $work_order_sell += $row2['s'];     
	            }
            }
            if (!is_array($this->results[$row['sales_hash']]))
                $this->results[$row['sales_hash']] = array();                   
            
            $this->results[$row['sales_hash']]['sales_hash'] = $row['sales_hash'];
            $this->results[$row['sales_hash']]['full_name'] = $row['full_name'];
            $this->results[$row['sales_hash']]['total_sell'] += ($row['total_po_sell'] + $work_order_sell);
            $this->results[$row['sales_hash']]['total_cost'] += ($row['total_po_cost'] + $work_order_cost);
                
            if ($detail == 1) {
                $row['total_po_cost'] = ($row['total_po_cost'] + $work_order_sell);
                $row['total_po_sell'] = ($row['total_po_sell'] + $work_order_cost);
            
                $this->results[$row['sales_hash']]['detail'] .= "
                <tr cid=\"c_".$row['sales_hash']."\" class=\"white_bg\" onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className='white_bg'\" onClick=\"agent.call('proposals','sf_loadcontent','show_popup_window','edit_proposal','proposal_hash=".$row['parent_proposal_hash']."','popup_id=proposal_win','from_report=1');\" title=\"View this proposal\">
                    <td style=\"font-size:8pt;width:525px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
                        <i>".(strlen($row['customer_name']) > 25 ? 
                            stripslashes(substr($row['customer_name'],0,23))."..." : stripslashes($row['customer_name']))."
                        </i>
                        &nbsp;[".$row['proposal_no']."]&nbsp;".
                        (strlen($row['proposal_descr']) > 55 ? 
                            stripslashes(substr($row['proposal_descr'],0,53))."..." : stripslashes($row['proposal_descr']))."
                    </td>
                    <td style=\"font-size:8pt;width:150px;border-bottom:1px solid #cccccc;padding:2px 5px;\" class=\"num_field\">
                        $".number_format($row['total_po_cost'],2)."
                    </td>
                    <td style=\"font-size:8pt;width:150px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
                        $".number_format($row['total_po_sell'],2)."                    
                    </td>
                    <td style=\"font-size:8pt;padding:2px 5px;width:75px;border-bottom:1px solid #cccccc;".(defined('MARGIN_FLAG') && math::gp_margin(round($row['total_po_cost'],2),round($row['total_po_sell'],2)) < defined('MARGIN_FLAG') || math::gp_margin(round($row['total_po_cost'],2),round($row['total_po_sell'],2)) * 100 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                        ".(math::gp_margin(round($row['total_po_cost'],2),round($row['total_po_sell'],2)) * 100 < 0 ?
                             "(".((math::gp_margin(round($row['total_po_cost'],2),round($row['total_po_sell'],2)) * 100) * -1)."%)" : (math::gp_margin(round($row['total_po_cost'],2),round($row['total_po_sell'],2)) * 100)."%")."
                    </td>
                </tr>";
            }
        }				

		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->bookings_report(1);
		return;
	}
	
	function fetch_indiv_bookings() {
		$sales_hash = $this->ajax_vars['sales_hash'];
		$report_hash = $this->ajax_vars['report_hash'];
		
		$this->fetch_report_settings($report_hash);

		switch ($this->current_report['timeframe']) {
			//This year
			case 1:
			$this->report_title = "Year To Date ".date(DATE_FORMAT,strtotime(date("Y-m-d")));
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".date("Y-01-01")."' AND '".date("Y-12-31")."'";
			break;

			//last year
			case 2:
			$this->report_title = "Year Ending ".date("Y",strtotime(date("Y-m-d")." -1 year"));
			$sql_p[] = "YEAR(".DB_PREFIX."purchase_order.po_date) BETWEEN '".date("Y-01-01",strtotime(date("Y-m-d")." -1 year"))."' AND '".date("Y-12-31",strtotime(date("Y-m-d")." -1 year"))."'";
			break;
			
			//current period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			break;
			
			//previous period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			break;
			
			case 5:
			if ($this->current_report['sort_from_date'] && $this->current_report['sort_to_date']) {
				$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$this->current_report['sort_from_date']."' AND '".$this->current_report['sort_to_date']."'";
				$this->report_title = date(DATE_FORMAT,strtotime($this->current_report['sort_from_date']))." thru ".date(DATE_FORMAT,strtotime($this->current_report['sort_to_date']));
			} else {
				$sql_p[] = DB_PREFIX."purchase_order.po_date >= '".$this->current_report['sort_from_date']."'";
				$this->report_title = "From ".date(DATE_FORMAT,strtotime($this->current_report['sort_from_date']))." To Present";
			} 
			break;

			//This Month
			case 6:
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT,strtotime(date("Y-m-t")));
			break;
			
			//Last Month
			case 7:
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".date("Y-m-01",strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT,strtotime(date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))));
			break;
		}
		
		if (is_array($this->current_report['sales_rep_match']) && count($this->current_report['sales_rep_match'])) {
			array_walk($this->current_report['sales_rep_match'],'add_quotes',"'");
			$sql_p_sub[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$this->current_report['sales_rep_match']).")";
			array_walk($this->current_report['sales_rep_match'],'strip_quotes');
		}
        if ((is_array($this->current_report['proposal_filter']) && count($this->current_report['proposal_filter'])) || ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))) {
        	if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
                $this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);
                                        	
            array_walk($this->current_report['proposal_filter'],'add_quotes',"'");
            $sql_p_sub[] = DB_PREFIX."proposals.proposal_hash IN (".implode(" , ",$this->current_report['proposal_filter']).")";
            array_walk($this->current_report['proposal_filter'],'strip_quotes');
        }           
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		if ($sql_p_sub)
            $sql_sub = implode(" AND ",$sql_p_sub);		

		$result = $this->db->query("SELECT SUM(".DB_PREFIX."purchase_order.order_amount) AS total_true_po_amount , ".DB_PREFIX."proposals.customer_hash ,
		                           ".DB_PREFIX."proposals.proposal_no , ".DB_PREFIX."proposals.proposal_hash as parent_proposal_hash ,
		                           ".DB_PREFIX."proposals.proposal_descr , ".DB_PREFIX."purchase_order.po_hash AS parent_po_hash ,
		                           (
                                        SELECT ".DB_PREFIX."customers.customer_name
                                        FROM ".DB_PREFIX."customers
                                        WHERE ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."proposals.customer_hash
		                           ) AS customer_name ,
									(
										SELECT SUM(".DB_PREFIX."line_items.cost * ".DB_PREFIX."line_items.qty) 
										FROM `".DB_PREFIX."line_items`
										LEFT JOIN `".DB_PREFIX."purchase_order` ON ".DB_PREFIX."purchase_order.po_hash = ".DB_PREFIX."line_items.po_hash
										WHERE ".DB_PREFIX."line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
									) AS total_po_cost , 
									(
										SELECT SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty) 
										FROM `".DB_PREFIX."line_items`
										LEFT JOIN `".DB_PREFIX."purchase_order` ON ".DB_PREFIX."purchase_order.po_hash = ".DB_PREFIX."line_items.po_hash
										WHERE ".DB_PREFIX."line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
									) AS total_po_sell ,
                                    (
                                        SELECT COUNT(".DB_PREFIX."work_orders.obj_id)
                                        FROM ".DB_PREFIX."work_order_items
                                        LEFT JOIN ".DB_PREFIX."work_orders ON ".DB_PREFIX."work_orders.order_hash = ".DB_PREFIX."work_order_items.order_hash
                                        WHERE ".DB_PREFIX."work_order_items.po_hash = parent_po_hash
                                    ) AS total_wo									
									FROM `".DB_PREFIX."purchase_order`
                                    LEFT JOIN `".DB_PREFIX."proposals` ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."purchase_order.proposal_hash
									WHERE ".DB_PREFIX."proposals.sales_hash = '$sales_hash' ".($sql ? "
                                        AND " . $sql : NULL).($sql_sub ? "
                                            AND " . $sql_sub : NULL)."                                    
									GROUP BY ".DB_PREFIX."proposals.proposal_hash
									ORDER BY ".DB_PREFIX."proposals.proposal_no");
		while ($row = $this->db->fetch_assoc($result)) {
			//Get the work order cost
			$work_order_cost = $work_order_sell = 0;
			if ($row['total_wo']) {
	            $r = $this->db->query("SELECT (SUM(".DB_PREFIX."line_items.cost * ".DB_PREFIX."line_items.qty) / COUNT(".DB_PREFIX."work_order_items.obj_id)) AS c , 
	                                   (SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty) / COUNT(".DB_PREFIX."work_order_items.obj_id)) AS s
	                                   FROM ".DB_PREFIX."purchase_order
	                                   LEFT JOIN ".DB_PREFIX."work_order_items ON ".DB_PREFIX."work_order_items.po_hash = ".DB_PREFIX."purchase_order.po_hash
	                                   LEFT JOIN ".DB_PREFIX."work_orders ON ".DB_PREFIX."work_orders.order_hash = ".DB_PREFIX."work_order_items.order_hash
	                                   LEFT JOIN ".DB_PREFIX."line_items ON ".DB_PREFIX."line_items.work_order_hash = ".DB_PREFIX."work_orders.order_hash                                   
	                                   WHERE ".DB_PREFIX."purchase_order.proposal_hash = '".$row['parent_proposal_hash']."'".($sql ? " 
	                                       AND " . $sql : NULL)." AND !ISNULL(".DB_PREFIX."line_items.work_order_hash)
	                                   GROUP BY ".DB_PREFIX."work_order_items.order_hash");
	            while ($row2 = $this->db->fetch_assoc($r)) {
	                $work_order_cost += $row2['c']; 
	                $work_order_sell += $row2['s'];     
	            }
	            $row['total_po_sell'] = ($row['total_po_sell'] + $work_order_sell);
	            $row['total_po_cost'] = ($row['total_po_cost'] + $work_order_cost);             
			}
			$tbl .= "<tr cid=\"c_".$sales_hash."\" class=\"white_bg\" onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className='white_bg'\" onClick=\"agent.call('proposals','sf_loadcontent','show_popup_window','edit_proposal','proposal_hash=".$row['parent_proposal_hash']."','popup_id=proposal_win','from_report=1');\" title=\"View this proposal\"><td style=\"font-size:8pt;width:525px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\"><i>".(strlen($row['customer_name']) > 25 ? stripslashes(substr($row['customer_name'],0,23))."..." : stripslashes($row['customer_name']))."</i>&nbsp;[".$row['proposal_no']."]&nbsp;".(strlen($row['proposal_descr']) > 45 ? stripslashes(substr($row['proposal_descr'],0,43))."..." : stripslashes($row['proposal_descr']))."</td><td style=\"font-size:8pt;width:150px;border-bottom:1px solid #cccccc;padding:2px 5px;\" class=\"num_field\">$".number_format($row['total_po_cost'],2)."</td><td style=\"font-size:8pt;width:150px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">$".number_format($row['total_po_sell'],2)."</td><td style=\"font-size:8pt;padding:2px 5px;width:75px;border-bottom:1px solid #cccccc;".(defined('MARGIN_FLAG') && math::gp_margin(round($row['total_po_cost'],2),round($row['total_po_sell'],2)) < defined('MARGIN_FLAG') || math::gp_margin(round($row['total_po_cost'],2),round($row['total_po_sell'],2)) * 100 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(math::gp_margin(round($row['total_po_cost'],2),round($row['total_po_sell'],2)) * 100 < 0 ? "(".((math::gp_margin(round($row['total_po_cost'],2),round($row['total_po_sell'],2)) * 100) * -1)."%)" : (math::gp_margin(round($row['total_po_cost'],2),round($row['total_po_sell'],2)) * 100)."%")."</td></tr>";
		}
        $tbl = str_replace("'","\'",$tbl);
        
        $this->content['jscript'] = "\$('po_details_".$sales_hash."').insert({after:'".$tbl."'});";               
		return;
	}
	
	function bookings_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\" >
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"4\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Bookings Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','bookings_report','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<div style=\"margin-left:20px;margin-bottom:5px;margin-top:10px;\">
							<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
						</div>
						<div style=\"text-align:center;margin-top:15px;font-weight:bold;\">
							Sales Bookings ".$this->report_title."
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:525px;text-align:left;\">Sales Rep</td>
					<td style=\"width:150px;\" class=\"num_field\">Total Net</td>
					<td style=\"width:150px;\" class=\"num_field\">Total Sell</td>
					<td style=\"width:75px;text-align:right;\">Margin</td>
				</tr>";
								
				while (list($sales_hash,$data) = each($this->results)) {
					if ($sales_hash) {
						$tbl .= "
						<tr id=\"po_details_".$sales_hash."\">
							<td style=\"background-color:#ffffff;font-weight:bold;\">
								<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"if(hide_row('".$sales_hash."')){return;}else{agent.call('reports','sf_loadcontent','cf_loadcontent','fetch_indiv_bookings','sales_hash=".$sales_hash."','report_hash=".$this->report_hash."');}\" title=\"View individual bookings for this sales rep\">".stripslashes($data['full_name'])."</a>
								
							</td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\">$".number_format($data['total_cost'],2)."</td>
							<td style=\"background-color:#ffffff;\" class=\"num_field\">$".number_format($data['total_sell'],2)."</td>
							<td style=\"".(defined('MARGIN_FLAG') && math::gp_margin(round($data['total_cost'],2),round($data['total_sell'],2)) < defined('MARGIN_FLAG') || math::gp_margin(round($data['total_cost'],2),round($data['total_sell'],2)) * 100 < 0 ? "color:#ff0000;" : NULL)."background-color:#ffffff;\" class=\"num_field\">
								".(math::gp_margin(round($data['total_cost'],2),round($data['total_sell'],2)) * 100 < 0 ? 
									"(".((math::gp_margin(round($data['total_cost'],2),round($data['total_sell'],2)) * 100) * -1)."%)" : (math::gp_margin(round($data['total_cost'],2),round($data['total_sell'],2)) * 100)."%")."
							</td>
						</tr>".($data['detail'] ? 
						$data['detail'] : NULL)."
						<tr>
							<td colspan=\"4\" style=\"background-color:#cccccc;\"></td>
						</tr>";
						
						$total_sell += $data['total_sell'];
						$total_cost += $data['total_cost'];
					}
				} 
				if (!$this->results)
                    $tbl .= "
                    <tr>
                        <td style=\"padding-top:25px;background-color:#ffffff;\" colspan=\"4\">There are no results to display.</td>
                    </tr>";
				
				$tbl .= "
				<tr>
					<td style=\"padding-top:25px;background-color:#efefef;\"></td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:10pt;background-color:#efefef;\" class=\"num_field\">$".number_format($total_cost,2)."</td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:10pt;background-color:#efefef;\" class=\"num_field\">$".number_format($total_sell,2)."</td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:10pt;background-color:#efefef;".(defined('MARGIN_FLAG') && math::gp_margin(round($total_cost,2),round($total_sell,2)) < defined('MARGIN_FLAG') || math::gp_margin(round($total_cost,2),round($total_sell,2)) * 100 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
						".(math::gp_margin(round($total_cost,2),round($total_sell,2)) * 100 < 0 ? 
							"(".((math::gp_margin(round($total_cost,2),round($total_sell,2)) * 100) * -1)."%)" : (math::gp_margin(round($total_cost,2),round($total_sell,2)) * 100)."%")."
					</td>
				</tr>
			</table>";						

			$this->content['jscript'][] = "
			hide_row = function() {
                var sales_hash = arguments[0];
                var tbl_el = $$('tr[cid=c_'+sales_hash+']');
                if (tbl_el.length) {
	                var i=0, c;
	                while (c = tbl_el[i++]) {
	                   c.remove();
	                }
	                return true;
                }
                
                return false;			
    		}";
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
                $this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);
                
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_bookings_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_bookings_report','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Bookings Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",array("All dates","Bookings dated this year","Bookings dated last year","Bookings from the current period","Bookings from the previous period","Bookings dated this month","Bookings dated last month","A specific date range"),$this->current_report['timeframe'],array('*',1,2,3,4,6,7,5),"onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Bookings Details?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("detail",array("Show Detailed View","Show Simple View"),$this->current_report['detail'],array(1,0),"blank=1")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]",array_merge(array("All Sales Reps"),$this->user_name),$this->current_report['sales_rep'],array_merge(array(""),$this->user_hash),"multiple","blank=1","size=4","style=width:200px;")."</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer','customer_hash',1);",
                                                                        "onBlur=vtobj.reset_keyResults();key_clear();"
                                                                        )."
                                                
                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
                                                if (is_array($this->current_report['customer_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
                                                        $tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=proposal",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'),'account_suggest');key_call('reports','proposal','proposal_hash',1);",
                                                                        "onBlur=vtobj.reset_keyResults();key_clear();"
                                                                        )."
                                                
                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
                                                if (is_array($this->current_report['proposal_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++) 
                                                        $tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>                                        
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}

	function doit_invoiced_sales_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		$report_hash = ($_POST['report_hash'] ? $_POST['report_hash'] : $this->ajax_vars['report_hash']);
		if ($report_hash)
			$this->fetch_report_settings($report_hash);
		
		$timeframe = $_POST['timeframe'];
		if ($timeframe == 5) {
			$sort_from_date = $_POST['sort_from_date'];
			$sort_to_date = $_POST['sort_to_date'];
		}
		$sales_rep_match = $_POST['sales_rep_match'];
		$customer_filter = $_POST['customer_filter'];
		$detail = $_POST['detail'];
		
		$save = $_POST['save'];
		$saved_cat = "invoiced_sales";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];

		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 5 && !$sort_from_date) || ($timeframe == 5 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		
		if ($this->content['error'])
			return;
			
		switch ($timeframe) {
			//This year
			case 1:
			$this->report_title = "Year To Date ".date(DATE_FORMAT,strtotime(date("Y-m-d")));
			$sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y")."'";
			$sub_sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y")."'";
			break;

			//last year
			case 2:
			$this->report_title = "Year Ending ".date("Y",strtotime(date("Y-m-d")." -1 year"));
			$sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			$sub_sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			break;
			
			//current period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//previous period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			case 5:
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = date(DATE_FORMAT,strtotime($sort_from_date))." thru ".date(DATE_FORMAT,strtotime($sort_to_date));
			} else {
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date >= '".$sort_from_date."'";
				$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date >= '".$sort_from_date."'";
				$this->report_title = "From ".date(DATE_FORMAT,strtotime($sort_from_date))." To Present";
			} 
			break;

			//This Month
			case 6:
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT,strtotime(date("Y-m-t")));
			break;
			
			//Last Month
			case 7:
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01",strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))."'";
			$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01",strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT,strtotime(date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))));
			break;
			
			default:
			$this->report_title = "To Date";
			break;
		}
		
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($sales_rep_match,'strip_quotes');
		}
		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."customer_invoice.customer_hash IN (".implode(" , ",$customer_filter).")";
			$sub_sql_p[] = DB_PREFIX."customer_invoice.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		if ($sub_sql_p) 
			$sub_sql = implode(" AND ",$sub_sql_p);
		
		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|detail=$detail|sales_rep=".@implode("&",$sales_rep_match)."|customer_filter=".@implode("&",$customer_filter);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

        $result = $this->db->query("SELECT ".DB_PREFIX."proposals.proposal_no , ".DB_PREFIX."proposals.proposal_descr , 
                                   ".DB_PREFIX."proposals.sales_hash , ".DB_PREFIX."proposals.proposal_hash as parent_proposal_hash , 
                                   ".DB_PREFIX."proposals.customer_hash , ".DB_PREFIX."users.full_name , 
                                   (
                                        SELECT ".DB_PREFIX."customers.customer_name
                                        FROM ".DB_PREFIX."customers
                                        WHERE ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."proposals.customer_hash
                                   ) AS customer_name ,                                
                                    (
                                        SELECT SUM(".DB_PREFIX."line_items.cost * ".DB_PREFIX."line_items.qty) 
                                        FROM `".DB_PREFIX."line_items`
                                        LEFT JOIN `".DB_PREFIX."customer_invoice` ON ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."line_items.invoice_hash
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
                                    ) AS total_invoice_cost ,
                                    (
                                        SELECT SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty) 
                                        FROM `".DB_PREFIX."line_items`
                                        LEFT JOIN `".DB_PREFIX."customer_invoice` ON ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."line_items.invoice_hash
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
                                    ) AS total_invoice_sell                                 
                                    FROM `".DB_PREFIX."customer_invoice`
                                    LEFT JOIN `".DB_PREFIX."proposals` ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."customer_invoice.proposal_hash
                                    LEFT JOIN `".DB_PREFIX."users` ON ".DB_PREFIX."users.id_hash = ".DB_PREFIX."proposals.sales_hash                                    
                                    WHERE ".($sql ? $sql." AND " : NULL).DB_PREFIX."customer_invoice.type = 'I'
                                    GROUP BY ".DB_PREFIX."proposals.proposal_hash
                                    ORDER BY ".DB_PREFIX."proposals.proposal_no");				
        $proposal_no = $cost = $sell = $gp = '';
        while ($row = $this->db->fetch_assoc($result)) {
            if (!is_array($this->results[$row['sales_hash']]))
                $this->results[$row['sales_hash']] = array(); 

            $this->results[$row['sales_hash']]['sales_hash'] = $row['sales_hash'];
            $this->results[$row['sales_hash']]['full_name'] = $row['full_name'];
            $this->results[$row['sales_hash']]['total_sell'] += $row['total_invoice_sell'];
            $this->results[$row['sales_hash']]['total_cost'] += $row['total_invoice_cost'];
                
            if ($detail == 1) {            
                $this->results[$row['sales_hash']]['detail'] .= "
                <tr cid=\"c_".$row['sales_hash']."\" class=\"white_bg\" onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className='white_bg'\" onClick=\"agent.call('proposals','sf_loadcontent','show_popup_window','edit_proposal','proposal_hash=".$row['parent_proposal_hash']."','popup_id=proposal_win','from_report=1');\" title=\"View this proposal\">
                    <td style=\"font-size:8pt;width:525px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
                        <i>".(strlen($row['customer_name']) > 25 ? 
                            stripslashes(substr($row['customer_name'],0,23))."..." : stripslashes($row['customer_name']))."
                        </i>
                        &nbsp;[".$row['proposal_no']."]&nbsp;".
                        (strlen($row['proposal_descr']) > 55 ? 
                            stripslashes(substr($row['proposal_descr'],0,53))."..." : stripslashes($row['proposal_descr']))."
                    </td>
                    <td style=\"font-size:8pt;width:150px;border-bottom:1px solid #cccccc;padding:2px 5px;\" class=\"num_field\">
                        $".number_format($row['total_invoice_cost'],2)."
                    </td>
                    <td style=\"font-size:8pt;width:150px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
                        $".number_format($row['total_invoice_sell'],2)."                    
                    </td>
                    <td style=\"font-size:8pt;padding:2px 5px;width:75px;border-bottom:1px solid #cccccc;".(defined('MARGIN_FLAG') && math::gp_margin(round($row['total_invoice_cost'],2),round($row['total_invoice_sell'],2)) < defined('MARGIN_FLAG') || math::gp_margin(round($row['total_invoice_cost'],2),round($row['total_invoice_sell'],2)) * 100 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                        ".(math::gp_margin(round($row['total_invoice_cost'],2),round($row['total_invoice_sell'],2)) * 100 < 0 ?
                             "(".((math::gp_margin(round($row['total_invoice_cost'],2),round($row['total_invoice_sell'],2)) * 100) * -1)."%)" : (math::gp_margin(round($row['total_invoice_cost'],2),round($row['total_invoice_sell'],2)) * 100)."%")."
                    </td>
                </tr>";
            }                
        }
		
		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->invoiced_sales(1);
		return;
	}
	
	function fetch_indiv_invoices() {
		$sales_hash = $this->ajax_vars['sales_hash'];
		$report_hash = $this->ajax_vars['report_hash'];
		
		$this->fetch_report_settings($report_hash);

		switch ($this->current_report['timeframe']) {
			//This year
			case 1:
			$sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y")."'";
			break;

			//last year
			case 2:
			$sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			break;
			
			//current period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			break;
			
			//previous period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			break;
			
			case 5:
			if ($this->current_report['sort_from_date'] && $this->current_report['sort_to_date']) {
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->current_report['sort_from_date']."' AND '".$this->current_report['sort_to_date']."'";
			} else {
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date >= '".$this->current_report['sort_from_date']."'";
			} 
			break;

			//This Month
			case 6:
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			break;
			
			//Last Month
			case 7:
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01",strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))."'";
			break;
		}
		
		if (is_array($this->current_report['sales_rep_match']) && count($this->current_report['sales_rep_match'])) {
			array_walk($this->current_report['sales_rep_match'],'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$this->current_report['sales_rep_match']).")";
			array_walk($this->current_report['sales_rep_match'],'strip_quotes');
		}
		if (is_array($this->current_report['customer_filter']) && count($this->current_report['customer_filter'])) {
			$customer_filter = array_unique($this->current_report['customer_filter']);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."customer_invoice.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
			
		$result = $this->db->query("SELECT ".DB_PREFIX."proposals.proposal_no , ".DB_PREFIX."proposals.proposal_descr , 
		                           ".DB_PREFIX."proposals.proposal_hash as parent_proposal_hash , ".DB_PREFIX."proposals.customer_hash , 
                                   (
                                        SELECT ".DB_PREFIX."customers.customer_name
                                        FROM ".DB_PREFIX."customers
                                        WHERE ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."proposals.customer_hash
                                   ) AS customer_name ,		                           
									(
										SELECT SUM(".DB_PREFIX."line_items.cost * ".DB_PREFIX."line_items.qty) 
										FROM `".DB_PREFIX."line_items`
										LEFT JOIN `".DB_PREFIX."customer_invoice` ON ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."line_items.invoice_hash
										WHERE ".DB_PREFIX."line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
									) AS total_invoice_cost ,
                                    (
                                        SELECT SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty) 
                                        FROM `".DB_PREFIX."line_items`
                                        LEFT JOIN `".DB_PREFIX."customer_invoice` ON ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."line_items.invoice_hash
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = parent_proposal_hash".($sql ? " AND ".$sql : NULL)."
                                    ) AS total_invoice_sell									
									FROM `".DB_PREFIX."customer_invoice`
									LEFT JOIN `".DB_PREFIX."proposals` ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."customer_invoice.proposal_hash
									WHERE ".DB_PREFIX."proposals.sales_hash = '$sales_hash' AND ".DB_PREFIX."customer_invoice.type = 'I'".($sql ? " AND " . $sql : NULL)."
									GROUP BY ".DB_PREFIX."proposals.proposal_hash
									ORDER BY ".DB_PREFIX."proposals.proposal_no");
		while ($row = $this->db->fetch_assoc($result)) {
            $row['total_invoice_sell'] = ($row['total_invoice_sell'] + $row['total_wo_sell']);
            $row['total_invoice_cost'] = ($row['total_invoice_cost'] + $row['total_wo_cost']);                			
			
            $tbl .= "<tr cid=\"c_".$sales_hash."\" class=\"white_bg\" onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className='white_bg'\" onClick=\"agent.call('proposals','sf_loadcontent','show_popup_window','edit_proposal','proposal_hash=".$row['parent_proposal_hash']."','popup_id=proposal_win','from_report=1');\" title=\"View this proposal\"><td style=\"font-size:8pt;width:525px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\"><i>".(strlen($row['customer_name']) > 25 ? stripslashes(substr($row['customer_name'],0,23))."..." : stripslashes($row['customer_name']))."</i>&nbsp;[".$row['proposal_no']."]&nbsp;".(strlen($row['proposal_descr']) > 45 ? stripslashes(substr($row['proposal_descr'],0,43))."..." : stripslashes($row['proposal_descr']))."</td><td style=\"font-size:8pt;width:150px;padding:2px 5px;border-bottom:1px solid #cccccc;\" class=\"num_field\">$".number_format($row['total_invoice_sell'],2)."</td><td style=\"font-size:8pt;width:150px;border-bottom:1px solid #cccccc;padding:2px 5px;\" class=\"num_field\">$".number_format($row['total_invoice_cost'],2)."</td><td style=\"font-size:8pt;padding:2px 5px;width:75px;border-bottom:1px solid #cccccc;".(defined('MARGIN_FLAG') && math::gp_margin(round($row['total_invoice_cost'],2),round($row['total_invoice_sell'],2)) < defined('MARGIN_FLAG') || math::gp_margin(round($row['total_invoice_cost'],2),round($row['total_invoice_sell'],2)) * 100 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(math::gp_margin(round($row['total_invoice_cost'],2),round($row['total_invoice_sell'],2)) * 100 < 0 ? "(".((math::gp_margin(round($row['total_invoice_cost'],2),round($row['total_invoice_sell'],2)) * 100) * -1)."%)" : (math::gp_margin(round($row['total_invoice_cost'],2),round($row['total_invoice_sell'],2)) * 100)."%")."</td></tr>";
        }
        $tbl = str_replace("'","\'",$tbl);
        
        $this->content['jscript'] = "\$('invoice_details_".$sales_hash."').insert({after:'".$tbl."'});";               			
		return;
	}
	
	function invoiced_sales($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\" >
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"4\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Invoiced Sales Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','invoiced_sales','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<div style=\"margin-left:20px;margin-bottom:5px;margin-top:10px;\">
							<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							&nbsp;&nbsp;
						</div>
						<div style=\"text-align:center;margin-top:15px;font-weight:bold;\">
							Invoiced Sales ".$this->report_title."
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:525px;text-align:left;\">Sales Rep</td>
					<td style=\"width:150px;\" class=\"num_field\">Total Invoiced Sales</td>
					<td style=\"width:150px;\" class=\"num_field\">Total Invoiced Cost</td>
					<td style=\"width:75px;\" class=\"num_field\">GP Margin</td>
				</tr>";
				$total_cost = $total_sell = 0;
				while (list($sales_hash,$data) = each($this->results)) {
					if ($sales_hash) {
						$tbl .= "
						<tr id=\"invoice_details_".$sales_hash."\">
							<td style=\"width:525px;background-color:#ffffff;font-weight:bold;\">
								<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"if(hide_row('".$sales_hash."')){return;}else{agent.call('reports','sf_loadcontent','cf_loadcontent','fetch_indiv_invoices','sales_hash=".$sales_hash."','report_hash=".$this->report_hash."');}\" title=\"View invoice details\">".stripslashes($data['full_name'])."</a>
							</td>
							<td style=\"width:150px;background-color:#ffffff;\" class=\"num_field\">$".number_format($data['total_sell'],2)."</td>
							<td style=\"width:150px;background-color:#ffffff;\" class=\"num_field\">$".number_format($data['total_cost'],2)."</td>
							<td style=\"width:75px;".(defined('MARGIN_FLAG') && math::gp_margin(round($data['total_cost'],2),round($data['total_sell'],2)) < defined('MARGIN_FLAG') || math::gp_margin(round($data['total_cost'],2),round($data['total_sell'],2)) * 100 < 0 ? "color:#ff0000;" : NULL)."background-color:#ffffff;\" class=\"num_field\">
								".(math::gp_margin(round($data['total_cost'],2),round($data['total_sell'],2)) * 100 < 0 ? 
									"(".((math::gp_margin(round($data['total_cost'],2),round($data['total_sell'],2)) * 100) * -1)."%)" : (math::gp_margin(round($data['total_cost'],2),round($data['total_sell'],2)) * 100)."%")."
							</td>
						</tr>".($data['detail'] ? 
						$data['detail'] : NULL) . "
						<tr>
							<td colspan=\"4\" style=\"background-color:#cccccc;\"></td>
						</tr>";
						
						$total_cost += $data['total_cost'];
						$total_sell += $data['total_sell'];
					}
				}
				$tbl .= "
				<tr>
					<td style=\"padding-top:25px;background-color:#efefef;\"></td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:12pt;background-color:#efefef;\" class=\"num_field\">$".number_format($total_sell,2)."</td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:12pt;background-color:#efefef;\" class=\"num_field\">$".number_format($total_cost,2)."</td>
					<td style=\"padding-top:25px;font-weight:bold;font-size:12pt;background-color:#efefef;".(defined('MARGIN_FLAG') && math::gp_margin(round($total_cost,2),round($total_sell,2)) < defined('MARGIN_FLAG') || math::gp_margin(round($total_cost,2),round($total_sell,2)) * 100 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
						".(math::gp_margin(round($total_cost,2),round($total_sell,2)) * 100 < 0 ? 
							"(".((math::gp_margin(round($total_cost,2),round($total_sell,2)) * 100) * -1)."%)" : (math::gp_margin(round($total_cost,2),round($total_sell,2)) * 100)."%")."
					</td>
				</tr>
			</table>";						

            $this->content['jscript'][] = "
            hide_row = function() {
                var sales_hash = arguments[0];
                var tbl_el = $$('tr[cid=c_'+sales_hash+']');
                if (tbl_el.length) {
                    var i=0, c;
                    while (c = tbl_el[i++]) {
                       c.remove();
                    }
                    return true;
                }
                
                return false;           
            }";				
				
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_invoiced_sales_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_invoiced_sales_report','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Invoiced Sales Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",array("All dates","Invoiced sales dated this year","Invoiced sales dated last year","Invoiced sales from the current period","Invoiced sales from the previous period","Invoiced sales dated this month","Invoiced sales dated last month","A specific date range"),$this->current_report['timeframe'],array('*',1,2,3,4,6,7,5),"onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Invoiced Sales Details?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("detail",array("Show Detailed View","Show Simple View"),$this->current_report['detail'],array(1,0),"blank=1")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]",$this->user_name,(is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ''),$this->user_hash,"multiple","blank=1","size=4","style=width:200px;")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	
	function doit_vendor_discounting() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		
		
		if ($report_hash && $doit_print) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$expire_date = $this->current_report['expire_date'];
			$vendor_filter = $this->current_report['vendor_filter'];
			$customer_filter = $this->current_report['customer_filter'];
			$discount_id = trim($this->current_report['discount_id']);
			$showdetail = $this->current_report['showdetail'];
			$showexpired = $this->current_report['showexpired'];
		} else {		
			$timeframe = $_POST['timeframe'];
			$expire_date = $_POST['expire_date'];
			$vendor_filter = $_POST['vendor_filter'];
			$customer_filter = $_POST['customer_filter'];
			$discount_id = trim($_POST['discount_id']);
			$showdetail = $_POST['showdetail'];
			$showexpired = $_POST['showexpired'];
		}
			
		if ($discount_id) {
			$discount_in = explode("\n",$discount_id);
			$c = count($discount_in);
			for ($i = 0; $i < $c; $i++) {
				if (!$discount_in[$i])
					unset($discount_in[$i]);
			}
		}		
		
		$save = $_POST['save'];
		$saved_cat = "vendor_discounting";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 11 && !$sort_from_date) || ($timeframe == 11 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		
		if ($this->content['error'])
			return;
			
		switch ($timeframe) {
			//This year
			case 5:
			$sql_p[] = "YEAR(".DB_PREFIX."discounting.discount_expiration_date) = '".date("Y")."'";
			break;
			
			//Last year
			case 6:
			$sql_p[] = "YEAR(".DB_PREFIX."discounting.discount_expiration_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			break;			

			//this period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				//$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
				$sql_p[] = DB_PREFIX."discounting.discount_expiration_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//next period
			case 11:
			$period_info = get_period_info(date("Y-m-d"));
			$period_info = get_period_info(date("Y-m-d",strtotime($period_info['period_end']." +5 days")));
			if ($period_info['period_start']) {
				//$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
				$sql_p[] = DB_PREFIX."discounting.discount_expiration_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//last period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				//$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
				$sql_p[] = DB_PREFIX."discounting.discount_expiration_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//This Quarter
			case 1:
			list($start,$end) = get_quarter_dates(get_quarter(date("Y-m-d")),date("Y"));
			$sql_p[] = DB_PREFIX."discounting.discount_expiration_date BETWEEN '".$start."' AND '".$end."'";
			break;

			//Next Quarter
			case 10:
			list($start,$end) = get_quarter_dates(get_quarter(date("Y-m-d")),date("Y"));
			$d = date("Y-m-d",strtotime($end." +5 days"));
			list($start,$end) = get_quarter_dates(get_quarter($d),date("Y",strtotime($d)));
			$sql_p[] = DB_PREFIX."discounting.discount_expiration_date BETWEEN '".$start."' AND '".$end."'";
			break;

			//Last Quarter
			case 2:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$date) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."discounting.discount_expiration_date BETWEEN '".$start."' AND '".$end."'";
			break;
			
			case 7:
			if ($expire_date) 
				$sql_p[] = DB_PREFIX."discounting.discount_expiration_date = '".$expire_date."'";
			
			break;
		}
		if ($showexpired)
			$sql_p[] = DB_PREFIX."discounting.discount_expiration_date >= '".date("Y-m-d")."'";
		
		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."discounting.vendor_hash IN (".implode(" , ",$vendor_filter).")";
			array_walk($vendor_filter,'strip_quotes');
		}

		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."discounting.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		} 
		
		if (is_array($discount_in) && count($discount_in)) {
			$discount_in = array_unique($discount_in);
			$discount_in = array_values($discount_in);
			array_walk($discount_in,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."discounting.discount_id IN (".implode(" , ",$discount_in).")";
			array_walk($discount_in,'strip_quotes');
		} 

		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		
		$str = "timeframe=$timeframe|expire_date=$expire_date|showexpired=$showexpired|showdetail=$showdetail|vendor_filter=".@implode("&",$vendor_filter)."|customer_filter=".@implode("&",$customer_filter)."|discount_id=$discount_id";	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."vendors.vendor_name , ".DB_PREFIX."customers.customer_name , ".DB_PREFIX."discounting.* 
									FROM `".DB_PREFIX."discounting`
									LEFT JOIN `".DB_PREFIX."vendors` ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."discounting.vendor_hash
									LEFT JOIN `".DB_PREFIX."customers` ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."discounting.customer_hash".($sql ? "
									WHERE ".$sql : NULL)."
									GROUP BY ".DB_PREFIX."discounting.discount_hash
									ORDER BY ".DB_PREFIX."customers.customer_name");
									
		while ($row = $this->db->fetch_assoc($result)) {
			$sort_list[$row['vendor_hash']] = $row['vendor_name'];
			$results[$row['vendor_hash']][$row['discount_hash']][] = $row;
			if ($showdetail == 2) {
				$result2 = $this->db->query("SELECT ".DB_PREFIX."discount_details.* , ".DB_PREFIX."vendor_products.product_name
											 FROM `".DB_PREFIX."discount_details`
											 LEFT JOIN ".DB_PREFIX."vendor_products ON ".DB_PREFIX."vendor_products.product_hash = ".DB_PREFIX."discount_details.product_hash
											 WHERE ".DB_PREFIX."discount_details.discount_hash = '".$row['discount_hash']."'");
				while ($row2 = $this->db->fetch_assoc($result2)) 
					$this->discount_details[$row['discount_hash']][] = $row2;
			}
		}				
		//Asending order
		if (is_array($sort_list)) {					
			asort($sort_list);	
			if (is_array($sort_list)) {
				while (list($hash,$name) = each($sort_list)) 
					$this->results[$hash] = $results[$hash];
			}
		}	

		if ($doit_print) 
			return;
			
		$this->content['action'] = 'close';	
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->vendor_discounting(1);
		return;
	}
	
	function show_discount_details() {
		$report_hash = $this->ajax_vars['report_hash'];
		$discount_hash = $this->ajax_vars['discount_hash'];
		
		$result = $this->db->query("SELECT ".DB_PREFIX."discount_details.* , ".DB_PREFIX."vendor_products.product_name
									FROM `".DB_PREFIX."discount_details`
									LEFT JOIN ".DB_PREFIX."vendor_products ON ".DB_PREFIX."vendor_products.product_hash = ".DB_PREFIX."discount_details.product_hash
									WHERE ".DB_PREFIX."discount_details.discount_hash = '".$discount_hash."'");
		while ($row = $this->db->fetch_assoc($result)) {
			unset($frf_item);
			if ($row['discount_frf']) {
				$discount_frf = explode("|",$row['discount_frf']);
				$frf_item = array();
				for ($k = 0; $k < count($discount_frf); $k++) {
					list($a,$b) = explode("=",$discount_frf[$k]);
					$a = str_replace("discount","product",$a);
					$frf_item[$a] = $b;
				}
			}
			$sell = '';
			$tbl .= "
			<tr>
				<td style=\"vertical-align:top;border-bottom:1px solid #cccccc;font-size:8pt;\">".($row['product_hash'] == '*' ? 
					"All Products" : $row['product_name']).($frf_item || $row['discount_frf_quoted'] ? 
					"<div style=\"margin:5px 0 0 5px;font-style:italic;\">".($frf_item ? 
						"<div>
							If under ".math::format_num($frf_item['product_frf_amount'])." ".($frf_item['product_frf_amount_type'] == 'L' ? "
								List" : "Net")."
							<div style=\"padding:5px;\">
								Then add ".($frf_item['product_frf_amount_add_type'] == 'P' ? 
									($frf_item['product_frf_amount_add']*100)."% of ".($frf_item['product_frf_amount_add_type_of'] == 'L' ? "
										List" : "Net") : math::format_num($frf_item['product_frf_amount_add']))."  
							</div>" : NULL).($charges['product_frf_quoted'] ? "
						</div>" : NULL).($row['discount_frf_quoted'] ? 
							"This freight needs to be quoted!" : NULL)."													
					</div>" : NULL)."
				</td>";
				if ($row['discount_type'] == 'F') {
					$tbl .= "
					<td class=\"num_field\" style=\"border-bottom:1px solid #cccccc;font-size:8pt;vertical-align:top;\">";
					$tbl .= ($row['buy_discount1'] != 0 ? 
					($row['buy_discount1'] * 100)."%" : "&nbsp;").($row['buy_discount2'] != 0 ? 
						"&nbsp;".($row['buy_discount2'] * 100)."%" : NULL).($row['buy_discount3'] != 0 ? 
							"&nbsp;".($row['buy_discount3'] * 100)."%" : NULL).($row['buy_discount4'] != 0 ? 
								"&nbsp;".($row['buy_discount4'] * 100)."%" : NULL).($row['buy_discount5'] != 0 ? 
									"&nbsp;".($row['buy_discount5'] * 100)."%" : NULL)."
					</td>";
				} else {
					$tbl .= "
					<td style=\"border-bottom:1px solid #cccccc;font-size:8pt;vertical-align:top;\">";
					for ($i = 1; $i < 7; $i++) {
						if ($row['tier'.$i.'_from'] != 0) {
							$tbl .= "
							<div style=\"margin-bottom:5px;\">
								<div style=\"float:right;\">".($row['tier'.$i.'_buy_discount'] * 100)."%</div>".($row['tier'.$i.'_to'] != 0 ? "
								From $".number_format($row['tier'.$i.'_from'],2)." To $".number_format($row['tier'.$i.'_to'],2) : "Over $".number_format($row['tier'.$i.'_from'],2))."
							</div>";
							$sell .= ($row['tier'.$i.'_sell_discount'] != 0 ? "
							<div style=\"margin-bottom:5px;\">".($row['tier'.$i.'_sell_discount'] * 100)."%</div>" : "&nbsp;");	
						}
					}
					$tbl .= "
					</td>";
				}
				$tbl .= "
				<td class=\"num_field\" style=\"vertical-align:top;border-bottom:1px solid #cccccc;font-size:8pt;\">";
				if ($row['discount_type'] == 'F')
					$tbl .= ($row['sell_discount'] != 0 ? 
						($row['sell_discount'] * 100)."%" : "&nbsp;")."
					</td>";
				else
					$tbl .= $sell."
					</td>";
				
				if ($row['discount_type'] == 'F')
					$tbl .= "
					<td class=\"num_field\" style=\"border-bottom:1px solid #cccccc;font-size:8pt;vertical-align:top;\">".($row['gp_margin'] != 0 ?
						($row['gp_margin'] * 100)."%" : "&nbsp;")."
					</td>";
				else
					$tbl .= "
					<td style=\"border-bottom:1px solid #cccccc;font-size:8pt;vertical-align:top;\" class=\"num_field\">&nbsp;</td>";
				
				$tbl .= "
			</tr>";
		}
		if (!$tbl)
			$tbl .= "
			<tr>
				<td colspan=\"4\" style=\"font-size:8pt;\">There are no product discounts defined for this vendor discount</td>
			</tr>";
		
		$this->content['html']['discount_details_'.$discount_hash] = "
		<table style=\"width:100%;border:1px solid #cccccc;\">
			<tr>
				<td style=\"font-weight:bold;background-color:#efefef;font-size:8pt;\">Product</td>
				<td style=\"font-weight:bold;background-color:#efefef;font-size:8pt;\" class=\"num_field\">Buy Discount</td>
				<td style=\"font-weight:bold;background-color:#efefef;font-size:8pt;\" class=\"num_field\">Sell Discount</td>
				<td style=\"font-weight:bold;background-color:#efefef;font-size:8pt;\" class=\"num_field\">GP Margin</td>
			</tr>" . $tbl ."
		</table>";
		$this->content['jscript'] = "toggle_display('discount_details_".$discount_hash."','block');";
		return;
	}
	
	function vendor_discounting($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Vendor Discounting Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','vendor_discounting','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp; &nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=vendor_discounting','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:400px;text-align:left;padding-left:25px;\">Type</td>
					<td style=\"width:200px;\">Discount ID</td>
					<td style=\"width:150;\" class=\"num_field\">Effective Date</td>
					<td style=\"width:150px;\" class=\"num_field\">Expiration Date</td>
				</tr>";
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				while (list($vendor_hash,$discount_array) = each($this->results)) {
					reset($discount_array);
					$current = current($discount_array);
					$tbl .= "
					<tr>
						<td colspan=\"4\" style=\"font-weight:bold;background-color:#ffffff;font-size:10pt;\">".stripslashes($current[0]['vendor_name'])."</td>
					</tr>";
				
					while (list($discount_hash,$details) = each($discount_array)) {
						$tbl .= "
						<tr>
							<td style=\"padding-left:25px;background-color:#ffffff;font-size:10pt;\">
								<a href=\"javascript:void(0);\" onClick=\"if(\$('discount_details_".$discount_hash."').getStyle('display')=='block'){toggle_display('discount_details_".$discount_hash."','none');} else{agent.call('reports','sf_loadcontent','cf_loadcontent','show_discount_details','report_hash=".$this->report_hash."','discount_hash=".$discount_hash."');}\" title=\"Show/Hide discount details\" class=\"link_standard\">".($details[0]['discount_type'] == 'C' ? "Customer Discount : ".stripslashes($details[0]['customer_name']) : "Standard Discount".($details[0]['discount_descr'] ? 
									" (".$details[0]['discount_descr'].")" : NULL))."
								</a>
							</td>
							<td style=\"background-color:#ffffff;font-size:10pt;\">".$details[0]['discount_id']."</td>
							<td style=\"background-color:#ffffff;font-size:10pt;\" class=\"num_field\">".date(DATE_FORMAT,strtotime($details[0]['discount_effective_date']))."</td>
							<td style=\"background-color:#ffffff;font-size:10pt;".((strtotime($details[0]['discount_expiration_date']) - strtotime(date("Y-m-d"))) / 86400 <= 0 ? "color:#ff0000;" : ((strtotime($details[0]['discount_expiration_date']) - strtotime(date("Y-m-d"))) / 86400 <= 30 ? "color:#ffcc33;" : NULL))."\" class=\"num_field\">".date(DATE_FORMAT,strtotime($details[0]['discount_expiration_date']))."</td>
						</tr>
						<tr>
							<td colspan=\"4\" style=\"padding-left:25px;background-color:#ffffff;width:100%;\" >
								<div style=\"display:".($this->current_report['showdetail'] == 2 ? "block" : "none").";\" id=\"discount_details_".$discount_hash."\">";
								if ($this->current_report['showdetail'] == 2) {
									$tbl .= "
									<table style=\"width:100%;border:1px solid #cccccc;\">
										<tr>
											<td style=\"font-weight:bold;background-color:#efefef;font-size:8pt;\">Product</td>
											<td style=\"font-weight:bold;background-color:#efefef;font-size:8pt;\" class=\"num_field\">Buy Discount</td>
											<td style=\"font-weight:bold;background-color:#efefef;font-size:8pt;\" class=\"num_field\">Sell Discount</td>
											<td style=\"font-weight:bold;background-color:#efefef;font-size:8pt;\" class=\"num_field\">GP Margin</td>
										</tr>";
									for ($i = 0; $i < count($this->discount_details[$discount_hash]); $i++) {
										unset($frf_item);
										if ($this->discount_details[$discount_hash][$i]['discount_frf']) {
											$discount_frf = explode("|",$this->discount_details[$discount_hash][$i]['discount_frf']);
											$frf_item = array();
											for ($k = 0; $k < count($discount_frf); $k++) {
												list($a,$b) = explode("=",$discount_frf[$k]);
												$a = str_replace("discount","product",$a);
												$frf_item[$a] = $b;
											}
										}
										$sell = '';
										$tbl .= "
										<tr>
											<td style=\"vertical-align:top;border-bottom:1px solid #cccccc;font-size:8pt;\">".($this->discount_details[$discount_hash][$i]['product_hash'] == '*' ? 
												"All Products" : $this->discount_details[$discount_hash][$i]['product_name']).($frf_item || $this->discount_details[$discount_hash][$i]['discount_frf_quoted'] ? 
													"<div style=\"margin:5px 0 0 5px;\">".($frf_item? 
														"<div>
															If under ".math::format_num($frf_item['product_frf_amount'])." ".($frf_item['product_frf_amount_type'] == 'L' ? "
																List" : "Net")."
															<div style=\"padding:5px;\">
																Then add ".($frf_item['product_frf_amount_add_type'] == 'P' ? 
																	($frf_item['product_frf_amount_add']*100)."% of ".($frf_item['product_frf_amount_add_type_of'] == 'L' ? "
																		List" : "Net") : math::format_num($frf_item['product_frf_amount_add']))."  
															</div>" : NULL).($charges['product_frf_quoted'] ? "
														</div>" : NULL).($this->discount_details[$discount_hash][$i]['discount_frf_quoted'] ? 
															"This freight needs to be quoted!" : NULL)."													
													</div>" : NULL)."
											</td>";
											if ($this->discount_details[$discount_hash][$i]['discount_type'] == 'F') {
												$tbl .= "
												<td class=\"num_field\" style=\"border-bottom:1px solid #cccccc;font-size:8pt;vertical-align:top;\">";
												$tbl .= ($this->discount_details[$discount_hash][$i]['buy_discount1'] != 0 ? 
												($this->discount_details[$discount_hash][$i]['buy_discount1'] * 100)."%" : "&nbsp;").($this->discount_details[$discount_hash][$i]['buy_discount2'] != 0 ? 
													"&nbsp;".($this->discount_details[$discount_hash][$i]['buy_discount2'] * 100)."%" : NULL).($this->discount_details[$discount_hash][$i]['buy_discount3'] != 0 ? 
														"&nbsp;".($this->discount_details[$discount_hash][$i]['buy_discount3'] * 100)."%" : NULL).($this->discount_details[$discount_hash][$i]['buy_discount4'] != 0 ? 
															"&nbsp;".($this->discount_details[$discount_hash][$i]['buy_discount4'] * 100)."%" : NULL).($this->discount_details[$discount_hash][$i]['buy_discount5'] != 0 ? 
																"&nbsp;".($this->discount_details[$discount_hash][$i]['buy_discount5'] * 100)."%" : NULL)."
												</td>";
											} else {
												$tbl .= "
												<td style=\"border-bottom:1px solid #cccccc;font-size:8pt;vertical-align:top;\">";
												for ($j = 1; $j < 7; $j++) {
													if ($this->discount_details[$discount_hash][$i]['tier'.$j.'_from'] != 0) {
														$tbl .= "
														<div style=\"margin-bottom:5px;\">
															<div style=\"float:right;\">".($this->discount_details[$discount_hash][$i]['tier'.$j.'_buy_discount'] * 100)."%</div>".($this->discount_details[$discount_hash][$i]['tier'.$j.'_to'] != 0 ? "
															From $".number_format($this->discount_details[$discount_hash][$i]['tier'.$j.'_from'],2)." To $".number_format($this->discount_details[$discount_hash][$i]['tier'.$j.'_to'],2) : "Over $".number_format($this->discount_details[$discount_hash][$i]['tier'.$j.'_from'],2))."
														</div>";
														$sell .= ($this->discount_details[$discount_hash][$i]['tier'.$j.'_sell_discount'] != 0 ? "
														<div style=\"margin-bottom:5px;\">".($this->discount_details[$discount_hash][$i]['tier'.$j.'_sell_discount'] * 100)."%</div>" : "N/A</div>");	
													}
												}
												$tbl .= "
												</td>";
											}
											$tbl .= "
											<td class=\"num_field\" style=\"vertical-align:top;border-bottom:1px solid #cccccc;font-size:8pt;\">";
											if ($this->discount_details[$discount_hash][$i]['discount_type'] == 'F')
												$tbl .= ($this->discount_details[$discount_hash][$i]['sell_discount'] != 0 ? 
													($this->discount_details[$discount_hash][$i]['sell_discount'] * 100)."%" : "&nbsp;")."
												</td>";
											else
												$tbl .= $sell."
												</td>";
											
											if ($this->discount_details[$discount_hash][$i]['discount_type'] == 'F')
												$tbl .= "
												<td class=\"num_field\" style=\"border-bottom:1px solid #cccccc;font-size:8pt;vertical-align:top;\">".($this->discount_details[$discount_hash][$i]['gp_margin'] != 0 ?
													($this->discount_details[$discount_hash][$i]['gp_margin'] * 100)."%" : "&nbsp;")."
												</td>";
											else
												$tbl .= "
												<td style=\"border-bottom:1px solid #cccccc;font-size:8pt;vertical-align:top;\" class=\"num_field\">&nbsp;</td>";
											
											$tbl .= "
										</tr>";
									}
									if (!$this->discount_details[$discount_hash])
										$tbl .= "
										<tr>
											<td colspan=\"4\" style=\"font-size:8pt;\">There are no product discounts defined for this vendor discount</td>
										</tr>";
									
									$tbl .= "
									</table>";
								}
							$tbl .= "
								</div>
							</td>
						</tr>";
						
					}				
				}
			} else
				$tbl .= "
				<tr>
					<td colspan=\"4\" style=\"background-color:#ffffff;font-size:10pt;\">Your report returned an empty result.</td>
				</tr>";
				
			$tbl .= "
			</table>";
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);

			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
				$this->current_report['customer_filter'] = array($this->current_report['customer_filter']);

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_vendor_discounting');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_vendor_discounting','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Vendor Discounting Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','vendor','vendor_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++) 
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customer discounts?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Search discounts by<br />expiration date?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",array("Discounts Expiring This Quarter","Discounts Expiring Next Quarter","Discounts That Expired Last Quarter","Discounts Expiring This Period","Discounts Expiring Next Period","Discounts That Expired Last Period","Discounts Expiring This Year","Discounts That Expired Last Year","Discounts Expiring on a Specific Date"),$this->current_report['timeframe'],array(1,10,2,3,11,4,5,6,7),"onChange=if(this.options[this.selectedIndex].value==7){toggle_display('date_range','block');}else{toggle_display('date_range','none');}")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 7 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"expire_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'expire_date\',true,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 7 && $this->current_report['expire_date'] ? $this->current_report['expire_date'] : ''.date("Y-m-d").'')."\',1,\'expire_date_holder\')',500);";
												$tbl .= "													
												</div>
												<div style=\"margin-top:10px;\">
													".$this->form->checkbox("name=showexpired","value=1",($this->current_report['showexpired'] == 1 ? "checked" : NULL))."
													&nbsp;
													Hide expired discounts?
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">
												Search by discount ID:
												<div style=\"margin-top:5px;font-style:italic;\">
													<small>Separate multiple discounts by line break</small>
												</div>
											</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->text_area("name=discount_id","value=".$this->current_report['discount_id'],"rows=3","cols=35")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Discount Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail",array("Show Simple View","Show Detail View"),$this->current_report['showdetail'],array('1','2'),"blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}					
	}
	
	function doit_vendor_balance() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		
		if ($doit_print && $report_hash) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 11) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$vendor_filter = $this->current_report['vendor_filter'];
			$showdetail = $this->current_report['showdetail'];
		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 11) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$vendor_filter = $_POST['vendor_filter'];				
			$showdetail = $_POST['showdetail'];	
		}

		if ($vendor_filter && !is_array($vendor_filter))
			$vendor_filter = array($vendor_filter);
		
		$save = $_POST['save'];
		$saved_cat = "vendor_balance";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 11 && !$sort_from_date) || ($timeframe == 11 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		
		if ($this->content['error'])
			return;
			
		switch ($timeframe) {
			// Today
			case 1:
			$sql_p[] = DB_PREFIX."vendor_payables.invoice_date = '".date("Y-m-d")."'";
			break;

			// Yesterday
			case 2:
			$sql_p[] = DB_PREFIX."vendor_payables.invoice_date = '".date("Y-m-d",strtotime(date("Y-m-d")." -1 day"));
			break;
			
			case 3:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$date) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$date) = get_quarter_dates($current_qtr - 1,date("Y"));
			$sql_p[] = DB_PREFIX."vendor_payables.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			break;
			
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."vendor_payables.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			case 5:
			if ($sort_from_date && $sort_to_date) 
				$sql_p[] = DB_PREFIX."vendor_payables.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
			else
				$sql_p[] = DB_PREFIX."vendor_payables.invoice_date >= '".$sort_from_date."'";
			break;
		}
		
		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."vendor_payables.vendor_hash IN (".implode(" , ",$vendor_filter).")";
			array_walk($vendor_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = " AND ".implode(" AND ",$sql_p);
		
		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|showdetail=$showdetail|sort_to_date=$sort_to_date|vendor_filter=".@implode("&",$vendor_filter);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."vendor_payables.invoice_hash , ".DB_PREFIX."vendor_payables.invoice_no , ".DB_PREFIX."vendor_payables.amount , 
									".DB_PREFIX."vendor_payables.balance , ".DB_PREFIX."vendor_payables.invoice_date , ".DB_PREFIX."vendor_payables.due_date , ".DB_PREFIX."vendor_payables.vendor_hash , ".DB_PREFIX."vendor_payables.type ,
									".DB_PREFIX."vendor_payables.po_hash, ".DB_PREFIX."purchase_order.po_no , ".DB_PREFIX."proposals.proposal_no , ".DB_PREFIX."proposals.proposal_descr , 
									".DB_PREFIX."vendors.vendor_name as vendor_name 
									FROM ".DB_PREFIX."vendor_payables
									LEFT JOIN ".DB_PREFIX."purchase_order ON ".DB_PREFIX."purchase_order.po_hash = ".DB_PREFIX."vendor_payables.po_hash
									LEFT JOIN ".DB_PREFIX."proposals ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."purchase_order.proposal_hash
									LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."vendor_payables.vendor_hash
									WHERE ((".DB_PREFIX."vendor_payables.type = 'I' AND ".DB_PREFIX."vendor_payables.balance != 0) OR (".DB_PREFIX."vendor_payables.type = 'D' AND ".DB_PREFIX."vendor_payables.balance != 0) OR (".DB_PREFIX."vendor_payables.type = 'C' AND ".DB_PREFIX."vendor_payables.balance != 0)) ".($sql ? $sql : NULL)."
									GROUP BY ".DB_PREFIX."vendor_payables.invoice_hash");
									
		while ($row = $this->db->fetch_assoc($result)) {
			$sort_list[$row['vendor_hash']] = $row['vendor_name'];
			
			$results[$row['vendor_hash']][$row['po_hash']][] = $row;
			//$this->results_totals[$row['customer_hash']] = array("balance_total"	=>	$row['balance_total'] + $this->results_totals[$row['customer_hash']]['balance_total'],
																 //"balance_current"	=>	$row['balance_current'] + $this->results_totals[$row['customer_hash']]['balance_current'],
																 //"balance_sched1"	=>	$row['balance_sched1'] + $this->results_totals[$row['customer_hash']]['balance_sched1'],
																 //"balance_sched2"	=>	$row['balance_sched2'] + $this->results_totals[$row['customer_hash']]['balance_sched2'],
																 //"balance_sched3"	=>	$row['balance_sched3'] + $this->results_totals[$row['customer_hash']]['balance_sched3']);
		}				
		
		
		//Asending order
		if (is_array($sort_list)) {					
			asort($sort_list);	
			if (is_array($sort_list)) {
				while (list($hash,$name) = each($sort_list)) 
					$this->results[$hash] = $results[$hash];
			}
		}			
		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->vendor_balance(1);
		return;
	}
	
	function vendor_balance($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Vendor Balance Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','vendor_balance','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp; &nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=vendor_balance','report_hash=".$this->report_hash."')\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:100px;text-align:left;padding-left:50px;\">Date</td>
					<td style=\"width:400;\">Type</td>
					<td style=\"width:75px;\">Due Date</td>
					<td style=\"width:112px;text-align:right;\">Amount</td>
					<td style=\"width:112px;text-align:right;\">Balance</td>
				</tr>";
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				while (list($vendor_hash,$po_array) = each($this->results)) {
					$vendor_total  = $vendor_balance = 0;
					reset($po_array);
					$current = current($po_array);
					$tbl .= "
					<tr>
						<td colspan=\"5\" style=\"font-weight:bold;background-color:#ffffff;font-size:10pt;\">".$current[0]['vendor_name']."</td>
					</tr>";
					while (list($po_hash,$details) = each($po_array)) {
						if ($this->current_report['showdetail'] == 2)
							$tbl .= ($po_hash ? "
							<tr>
								<td colspan=\"5\" style=\"font-weight:bold;background-color:#ffffff;padding-left:25px;padding-top:5px;\">
									Purchase Order: ".$details[0]['po_no']."
								</td>
							</tr>" : "
							<tr>
								<td colspan=\"5\" style=\"background-color:#ffffff;padding-top:5px;\">&nbsp;</td>
							</tr>");
						$amt = $bal = 0;
						for ($i = 0; $i < count($details); $i++) {
							unset($style1,$style2,$amount1,$amount2);
							
							if ($details[$i]['type'] == 'D' || $details[$i]['type'] == 'C') {
								$amt -= $details[$i]['amount'];
								$bal -= $details[$i]['balance'];
								$vendor_total -= $details[$i]['amount'];
								$vendor_balance -= $details[$i]['balance'];
								$total -= $details[$i]['amount'];
								$total_balance -= $details[$i]['balance'];
								if ($details[$i]['amount'] > 0)
									$style1 = "color:#ff0000;";
								if ($details[$i]['balance'] > 0)
									$style2 = "color:#ff0000;";

								if ($details[$i]['amount'] > 0)
									$amount1 = "($".number_format($details[$i]['amount'],2).")";
								else
									$amount1 = "$".number_format($details[$i]['amount'] * -1,2);
								
								if ($details[$i]['balance'] > 0)
									$amount2 = "($".number_format($details[$i]['balance'],2).")";
								else
									$amount2 = "$".number_format($details[$i]['balance'] * -1,2);

							} else {
								$amt += $details[$i]['amount'];
								$bal += $details[$i]['balance'];
								$vendor_total += $details[$i]['amount'];
								$vendor_balance += $details[$i]['balance'];
								$total += $details[$i]['amount'];
								$total_balance += $details[$i]['balance'];
								if ($details[$i]['amount'] < 0)
									$style1 = "color:#ff0000;";
								if ($details[$i]['balance'] < 0)
									$style2 = "color:#ff0000;";
								
								if ($details[$i]['amount'] < 0)
									$amount1 = "($".number_format($details[$i]['amount'] * -1,2).")";
								else
									$amount1 = "$".number_format($details[$i]['amount'],2);
								
								if ($details[$i]['balance'] < 0)
									$amount2 = "($".number_format($details[$i]['balance'] * -1,2).")";
								else
									$amount2 = "$".number_format($details[$i]['balance'],2);
							}
							
							if ($this->current_report['showdetail'] == 2)
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;padding-left:".($po_hash ? "50" : "50")."px;\">".$details[$i]['invoice_date']."</td>
									<td style=\"background-color:#ffffff;\">
										<a href=\"javascript:void(0);\" onClick=\"agent.call('payables','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$details[$i]['invoice_hash']."','popup_id=line_item');\" class=\"link_standard\">".($details[$i]['type'] == 'D' ? "Deposit" : ($details[$i]['type'] == 'I' ? "Bill" : "Vendor Credit")." ".$details[$i]['invoice_no'])."</a>
									</td>
									<td style=\"background-color:#ffffff;\">".($details[$i]['type'] != 'D' ?
										date(DATE_FORMAT,strtotime($details[$i]['due_date'])) : "&nbsp;")."</td>
									<td style=\"background-color:#ffffff;".$style1."\" class=\"num_field\">".$amount1."</td>
									<td style=\"background-color:#ffffff;".$style2."\" class=\"num_field\">".$amount2."</td>
								</tr>";
						}
						if ($this->current_report['showdetail'] == 2 && count($details) > 1)
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;\" colspan=\"3\"></td>
								<td style=\"background-color:#ffffff;border-top:1px solid #cccccc;".($amt < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($amt < 0 ? 
									"($".number_format($amt * -1,2).")" : "$".number_format($amt,2))."
								</td>
								<td style=\"background-color:#ffffff;border-top:1px solid #cccccc;".($bal < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($bal < 0 ?
									"($".number_format($bal * -1,2).")" : "$".number_format($bal,2))."
								</td>
							</tr>";
					}
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;padding-bottom:10px;padding-top:10px;font-size:10pt;font-weight:bold;border-bottom:1px solid #cccccc;\" colspan=\"3\">".($this->current_report['showdetail'] == 2 ? "Total for ".$current[0]['vendor_name'] : "&nbsp;")."</td>
						<td style=\"background-color:#ffffff;padding-bottom:10px;padding-top:10px;".($this->current_report['showdetail'] == 2 ? "border-top:1px solid #cccccc;" : NULL)."font-weight:bold;border-bottom:1px solid #cccccc;".($vendor_total < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($vendor_total < 0 ? 
							"($".number_format($vendor_total * -1,2).")" : "$".number_format($vendor_total,2))."
						</td>
						<td style=\"background-color:#ffffff;padding-bottom:10px;".($this->current_report['showdetail'] == 2 ? "border-top:1px solid #cccccc;" : NULL)."font-weight:bold;border-bottom:1px solid #cccccc;".($vendor_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($vendor_balance < 0 ? 
							"($".number_format($vendor_balance * -1,2).")" : "$".number_format($vendor_balance,2))."
						</td>
					</tr>";
				}
			}
			$tbl .= "
			<tr>
				<td style=\"background-color:#ffffff;padding-bottom:10px;font-size:12pt;font-weight:bold;padding-top:15px;\" colspan=\"3\">Total Vendor Balance</td>
				<td style=\"background-color:#ffffff;padding-bottom:10px;font-weight:bold;font-size:10pt;padding-top:15px;".($total < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total < 0 ? 
					"($".number_format($total * -1,2).")" : "$".number_format($total,2))."
				</td>
				<td style=\"background-color:#ffffff;padding-bottom:10px;font-weight:bold;font-size:10pt;padding-top:15px;".($total_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_balance < 0 ? 
					"($".number_format($total_balance * -1,2).")" : "$".number_format($total_balance,2))."
				</td>
			</tr>";
			$tbl .= "
			</table>";
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
				
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_vendor_balance');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_vendor_balance','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Vendor Balance Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",array("All dates","Today","Yesterday","This Quarter","Last Quarter","This Period","Last Period","This year","Last year","Current period","Previous period","A specific date range"),$this->current_report['timeframe'],array('*',1,2,3,4,5,6,7,8,9,10,11),"onChange=if(this.options[this.selectedIndex].value==11){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 11 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 13 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','vendor','vendor_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++) 
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail",array("Show Detail View","Show Simple View"),$this->current_report['showdetail'],array('2','1'),"blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}					
	}
	
	function doit_customer_balance() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		
		if ($report_hash && $doit_print) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 9) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$showdetail = $this->current_report['showdetail'];		
			$customer_filter = $this->current_report['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);				

		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 9) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$customer_filter = $_POST['customer_filter'];
			$showdetail = $_POST['showdetail'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);							
		}
		
		$save = $_POST['save'];
		$saved_cat = "customer_balance";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 9 && !$sort_from_date) || ($timeframe == 9 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		
		if ($this->content['error'])
			return;
	
		switch ($timeframe) {
			// To Date
			case '*':
				$this->report_date = date("Y-m-d");
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date <= '".$this->report_date."'";
			break;			
			
			// Today
			case 1:
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date = '".date("Y-m-d");
			break;

			// Yesterday
			case 2:
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date = '".date("Y-m-d",strtotime(date("Y-m-d")." -1 day"));
			break;

			// This Quarter
			case 3:
				list($this->report_date_start,$this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")),date("Y"));
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			// Last Quarter
			case 4:
				$current_qtr = get_quarter();
				if ($current_qtr == 1) {
					$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
					list($this->report_date_start,$this->report_date_end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
				} else
					list($this->report_date_start,$this->report_date_end) = get_quarter_dates($current_qtr - 1,date("Y"));
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;	
			
			// This Period
			case 5:
				$period_info = get_period_info(date("Y-m-d"));
				if ($period_info['period_start']) {				
					$this->report_date_start = $period_info['period_start'];
					$this->report_date_end = $period_info['period_end'];
					$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
				} else {
					$this->content['error'] = 1;
					$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
					return;
				}
			break;
			
			// Last Period
			case 6:
				$period_info = get_previous_period(date("Y-m-d"));		
				if ($period_info['period_start']) {
					$this->report_date_start = $period_info['period_start'];
					$this->report_date_end = $period_info['period_end'];
					$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
				} else {
					$this->content['error'] = 1;
					$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
					return;
				}
			break;
			
			// This Year
			case 7:
				list($month,$day) = explode("/",FISCAL_YEAR_START);
				if (!$month || !$day)
					$month = $day = 1;
				$this->report_date_start = date("Y")."-".$month."-".$day;
				$this->report_date_end = date("Y")."-".($month + 11)."-".date("t",strtotime(date("Y-".($month + 11)."-01")));
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
			
			// Last Year
			case 8:
				list($month,$day) = explode("/",FISCAL_YEAR_START);
				if (!$month || !$day)
					$month = $day = 1;
				$last_year = date("Y") - 1;
				$this->report_date_start = $last_year."-".$month."-".$day;
				$this->report_date_end = $last_year."-".($month + 11)."-".date("t",strtotime(date($last_year."-".($month + 11)."-01")));
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
			
			// Specific Date Range
			case 9:
				if ($sort_from_date && $sort_to_date) { 
					$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
					$this->report_date_start = $sort_from_date;
					$this->report_date_end = $sort_to_date;				
				} else {
					$sql_p[] = DB_PREFIX."customer_invoice.invoice_date >= '".$sort_from_date."'";
					$this->report_date_start = $sort_from_date;
				}
			break;					
		}
		
		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."customer_invoice.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = " AND ".implode(" AND ",$sql_p);
		
		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|showdetail=$showdetail|sort_to_date=$sort_to_date|customer_filter=".@implode("&",$customer_filter);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."customer_invoice.invoice_hash , ".DB_PREFIX."customer_invoice.invoice_no , ".DB_PREFIX."customer_invoice.amount , 
									".DB_PREFIX."customer_invoice.balance , ".DB_PREFIX."customer_invoice.invoice_date , ".DB_PREFIX."customer_invoice.customer_hash , ".DB_PREFIX."customer_invoice.type ,
									".DB_PREFIX."customer_invoice.proposal_hash, ".DB_PREFIX."proposals.proposal_no , ".DB_PREFIX."proposals.proposal_descr , 
									".DB_PREFIX."customer_invoice.invoice_to , ".DB_PREFIX."customers.customer_name as customer_name , ".DB_PREFIX."customers.payment_terms ,
								    CASE 
								    WHEN ISNULL(".DB_PREFIX."customers.customer_name)
									  	THEN ".DB_PREFIX."vendors.vendor_name
									  	ELSE 0
								   	END AS vendor_name
									FROM ".DB_PREFIX."customer_invoice
									LEFT JOIN ".DB_PREFIX."proposals ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."customer_invoice.proposal_hash
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."customer_invoice.customer_hash
									LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."customer_invoice.customer_hash
									WHERE ((".DB_PREFIX."customer_invoice.type = 'I' AND ".DB_PREFIX."customer_invoice.balance != 0) OR (".DB_PREFIX."customer_invoice.type = 'D' AND ".DB_PREFIX."customer_invoice.balance != 0)) ".($sql ? $sql : NULL)."
									GROUP BY ".DB_PREFIX."customer_invoice.invoice_hash");
									
		while ($row = $this->db->fetch_assoc($result)) {
			$sort_list[$row['customer_hash']] = ($row['customer_name'] ? $row['customer_name'] : $row['vendor_name']);
			
			$results[$row['customer_hash']][$row['proposal_hash']][] = $row;
			//$this->results_totals[$row['customer_hash']] = array("balance_total"	=>	$row['balance_total'] + $this->results_totals[$row['customer_hash']]['balance_total'],
																 //"balance_current"	=>	$row['balance_current'] + $this->results_totals[$row['customer_hash']]['balance_current'],
																 //"balance_sched1"	=>	$row['balance_sched1'] + $this->results_totals[$row['customer_hash']]['balance_sched1'],
																 //"balance_sched2"	=>	$row['balance_sched2'] + $this->results_totals[$row['customer_hash']]['balance_sched2'],
																 //"balance_sched3"	=>	$row['balance_sched3'] + $this->results_totals[$row['customer_hash']]['balance_sched3']);
		}				
		
		
		//Asending order
		if (is_array($sort_list)) {					
			asort($sort_list);	
			if (is_array($sort_list)) {
				while (list($hash,$name) = each($sort_list)) 
					$this->results[$hash] = $results[$hash];
			}
		}			
		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->customer_balance(1);
		return;
	}
	
	function customer_balance($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Customer Balance Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','customer_balance','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=customer_balance','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:100px;text-align:left;padding-left:50px;\">Date</td>
					<td style=\"width:400;\">Type</td>
					<td style=\"width:75px;\">Due Date</td>
					<td style=\"width:112px;text-align:right;\">Amount</td>
					<td style=\"width:112px;text-align:right;\">Balance</td>
				</tr>";
			$customers = new customers($this->current_hash);
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				while (list($customer_hash,$proposal_array) = each($this->results)) {
					$customer_total  = $customer_balance = 0;
					reset($proposal_array);
					$current = current($proposal_array);
					$tbl .= "
					<tr>
						<td colspan=\"5\" style=\"font-weight:bold;background-color:#ffffff;font-size:10pt;\">".($current[0]['invoice_to'] == 'C' ? $current[0]['customer_name'] : $current[0]['vendor_name'])."</td>
					</tr>";
					while (list($proposal_hash,$details) = each($proposal_array)) {
						if ($this->current_report['showdetail'] == 2)
							$tbl .= "
							<tr>
								<td colspan=\"5\" style=\"font-weight:bold;background-color:#ffffff;padding-left:25px;padding-top:5px;\">".($proposal_hash ? "
									Proposal: ".$details[0]['proposal_no']." - ".$details[0]['proposal_descr'] : "Unapplied Deposits")."
								</td>
							</tr>";
						$amt = $bal = 0;
						for ($i = 0; $i < count($details); $i++) {
							unset($style1,$style2,$amount1,$amount2);
							
							if ($details[$i]['type'] == 'D') {
								$amt -= $details[$i]['amount'];
								$bal -= $details[$i]['balance'];
								$customer_total -= $details[$i]['amount'];
								$customer_balance -= $details[$i]['balance'];
								$total -= $details[$i]['amount'];
								$total_balance -= $details[$i]['balance'];
								if ($details[$i]['amount'] > 0)
									$style1 = "color:#ff0000;";
								if ($details[$i]['balance'] > 0)
									$style2 = "color:#ff0000;";

								if ($details[$i]['amount'] > 0)
									$amount1 = "($".number_format($details[$i]['amount'],2).")";
								else
									$amount1 = "$".number_format($details[$i]['amount'] * -1,2);
								
								if ($details[$i]['balance'] > 0)
									$amount2 = "($".number_format($details[$i]['balance'],2).")";
								else
									$amount2 = "$".number_format($details[$i]['balance'] * -1,2);

							} else {
								$amt += $details[$i]['amount'];
								$bal += $details[$i]['balance'];
								$customer_total += $details[$i]['amount'];
								$customer_balance += $details[$i]['balance'];
								$total += $details[$i]['amount'];
								$total_balance += $details[$i]['balance'];
								if ($details[$i]['amount'] < 0)
									$style1 = "color:#ff0000;";
								if ($details[$i]['balance'] < 0)
									$style2 = "color:#ff0000;";
								
								if ($details[$i]['amount'] < 0)
									$amount1 = "($".number_format($details[$i]['amount'] * -1,2).")";
								else
									$amount1 = "$".number_format($details[$i]['amount'],2);
								
								if ($details[$i]['balance'] < 0)
									$amount2 = "($".number_format($details[$i]['balance'] * -1,2).")";
								else
									$amount2 = "$".number_format($details[$i]['balance'],2);
							}
							
							if ($this->current_report['showdetail'] == 2)
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;padding-left:50px;\">".$details[$i]['invoice_date']."</td>
									<td style=\"background-color:#ffffff;\">
										<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','".($details[$i]['type'] == 'D' ? "new_deposit" : "edit_invoice")."','invoice_hash=".$details[$i]['invoice_hash']."','proposal_hash=".$proposal_hash."','popup_id=line_item');\" class=\"link_standard\">".($details[$i]['type'] == 'D' ? "Deposit" : "Invoice ".$details[$i]['invoice_no'])."</a>
									</td>
									<td style=\"background-color:#ffffff;\">".($details[$i]['type'] != 'D' ?
										date(DATE_FORMAT,strtotime($details[$i]['invoice_date']." +".($details[$i]['payment_terms'] ? $details[$i]['payment_terms'] : DEFAULT_CUST_PAY_TERMS)." days")) : "&nbsp;")."</td>
									<td style=\"background-color:#ffffff;".$style1."\" class=\"num_field\">".$amount1."</td>
									<td style=\"background-color:#ffffff;".$style2."\" class=\"num_field\">".$amount2."</td>
								</tr>";
						}
						if ($this->current_report['showdetail'] == 2 && count($details) > 1)
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;\" colspan=\"3\"></td>
								<td style=\"background-color:#ffffff;border-top:1px solid #cccccc;".($amt < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($amt < 0 ? 
									"($".number_format($amt * -1,2).")" : "$".number_format($amt,2))."
								</td>
								<td style=\"background-color:#ffffff;border-top:1px solid #cccccc;".($bal < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($bal < 0 ?
									"($".number_format($bal * -1,2).")" : "$".number_format($bal,2))."
								</td>
							</tr>";
					}
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;padding-bottom:10px;font-size:10pt;font-weight:bold;border-bottom:1px solid #cccccc;\" colspan=\"3\">".($this->current_report['showdetail'] == 2 ? "Total for ".($current[0]['invoice_to'] == 'C' ? $current[0]['customer_name'] : $current[0]['vendor_name']) : "&nbsp;")."</td>
						<td style=\"background-color:#ffffff;padding-bottom:10px;".($this->current_report['showdetail'] == 2 ? "border-top:1px solid #cccccc;" : NULL)."font-weight:bold;border-bottom:1px solid #cccccc;".($customer_total < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($customer_total < 0 ? 
							"($".number_format($customer_total * -1,2).")" : "$".number_format($customer_total,2))."
						</td>
						<td style=\"background-color:#ffffff;padding-bottom:10px;".($this->current_report['showdetail'] == 2 ? "border-top:1px solid #cccccc;" : NULL)."font-weight:bold;border-bottom:1px solid #cccccc;".($customer_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($customer_balance < 0 ? 
							"($".number_format($customer_balance * -1,2).")" : "$".number_format($customer_balance,2))."
						</td>
					</tr>";
				}
			}
			$tbl .= "
			<tr>
				<td style=\"background-color:#ffffff;padding-bottom:10px;font-size:12pt;font-weight:bold;padding-top:15px;\" colspan=\"3\">Total Customer Balance</td>
				<td style=\"background-color:#ffffff;padding-bottom:10px;border-top:1px solid #cccccc;font-weight:bold;font-size:10pt;padding-top:15px;".($total < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total < 0 ? 
					"($".number_format($total * -1,2).")" : "$".number_format($total,2))."
				</td>
				<td style=\"background-color:#ffffff;padding-bottom:10px;border-top:1px solid #cccccc;font-weight:bold;font-size:10pt;padding-top:15px;".($total_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_balance < 0 ? 
					"($".number_format($total_balance * -1,2).")" : "$".number_format($total_balance,2))."
				</td>
			</tr>";
			$tbl .= "
			</table>";
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_customer_balance');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_customer_balance','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Customer Balance Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",array("All dates","Today","Yesterday","Current Quarter","Previous Quarter","Current Period","Previous Period","Current year","Previous year","A specific date range"),$this->current_report['timeframe'],array('*',1,2,3,4,5,6,7,8,9),"onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail",array("Show Detail View","Show Simple View"),$this->current_report['showdetail'],array('2','1'),"blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}					
	}

	function ar_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"2\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"9\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Accounts Receivable Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','ar_report','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
                            <div style=\"margin-left:15px;margin-top:10px;margin-bottom:10px;font-size:10pt;\">".$this->report_title."</div>
						</h3>
						<div style=\"margin-left:20px;margin-bottom:5px;\">
							<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=ar_report','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
						</div>
					</td>
				</tr>
				<tr>
					<td style=\"text-align:left;width:500px;padding:5px;background-color:#ffffff\" colspan=\"3\">
						<h4 style=\"margin-bottom:5px;color:#00477f;\">".$this->report_title."</div>
						</h4>
					</td>
					<td style=\"background-color:#ffffff\" colspan=\"4\"></td>
				</tr>				
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:150px;text-align:left;padding:5px 5px 5px 50px;\">Invoice No.</td>
					<td style=\"width:75px;padding:5px;\">Invoice Date</td>
					<td style=\"width:75px;padding:5px;\">Due Date</td>
                    <td style=\"width:100px;padding:5px;\" class=\"num_field\">Orig Amt</td>
                    <td style=\"width:100px;padding:5px;\" class=\"num_field\">Balance</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Current</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".$this->current_report['age1']." Days</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".$this->current_report['age2']." Days</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".$this->current_report['age3']." Days</td>
				</tr>";
			$customers = new customers($this->current_hash);
			$vendors = new vendors($this->current_hash);

			if (is_array($this->results)) {
				$k = 0;
				while (list($customer_hash,$proposal_array) = each($this->results)) {
					$total_invoice = $total_balance = $total_current = $total_sched1 = $total_sched2 = $total_sched3 = 0;
					reset($proposal_array);
					$current = current($proposal_array);
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"3\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">
							".($current[0]['customer_name'] ? $current[0]['customer_name'] : $current[0]['vendor_name'])."
						</td>
                        <td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? "Orig Amt" : "&nbsp;")."</td>
                        <td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? "Balance" : "&nbsp;")."</td>                        
						<td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? "Current" : "&nbsp;")."</td>
						<td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? $this->current_report['age1']." Days" : "&nbsp;")."</td>
						<td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? $this->current_report['age2']." Days" : "&nbsp;")."</td>
						<td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? $this->current_report['age3']." Days" : "&nbsp;")."</td>
					</tr>";
					$k++;
					while (list($proposal_hash,$details) = each($proposal_array)) {
						if ($this->current_report['showdetail'] == 2)
							$tbl .= "
							<tr>
								<td colspan=\"9\" style=\"font-size:8pt;background-color:#ffffff;padding-left:25px;padding-top:5px;\">".($proposal_hash ? "
							         Proposal: <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('proposals','sf_loadcontent','show_popup_window','edit_proposal','proposal_hash=$proposal_hash','popup_id=proposal_win','from_report=1');\">".$details[0]['proposal_no']."</a> - ".$details[0]['proposal_descr'] : "&nbsp;")."
							    </td>
							</tr>";
						
						for ($i = 0; $i < count($details); $i++) {							
							if ($details[$i]['type'] == 'I') {
							    $balance = $details[$i]['balance_current'] + $details[$i]['balance_sched1'] + $details[$i]['balance_sched2'] + $details[$i]['balance_sched3'];
							    $total_balance += $balance;
							    $total_invoice += $details[$i]['amount'] - $details[$i]['deposit_applied'];
							} elseif ($details[$i]['type'] == 'D') {
							    $balance = $details[$i]['amount'] - $details[$i]['total_applied_deposits'];
							    $total_balance += ($balance * -1);
							    $total_invoice += ($details[$i]['amount'] * -1);
							}
							
							$total_current += $details[$i]['balance_current'];
							$total_sched1 += $details[$i]['balance_sched1'];
							$total_sched2 += $details[$i]['balance_sched2'];
							$total_sched3 += $details[$i]['balance_sched3'];						
							    
							if ($this->current_report['showdetail'] == 2)
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;font-size:8pt;padding-left:50px;\">".($details[$i]['type'] == 'I' ? "
										<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$details[$i]['invoice_hash']."','proposal_hash=$proposal_hash','popup_id=line_item');\" class=\"link_standard\">Invoice: ".$details[$i]['invoice_no']."</a>" : "
										<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','new_deposit','invoice_hash=".$details[$i]['invoice_hash']."','proposal_hash=$proposal_hash','popup_id=line_item');\" class=\"link_standard\">".(!$proposal_hash ? "Unapplied " : NULL)."Deposit</a>")."
									</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($details[$i]['invoice_date']))."</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\">".($details[$i]['type'] == 'I' ? 
								        date(DATE_FORMAT,strtotime($details[$i]['invoice_date']." +".($details[$i]['payment_terms'] ? $details[$i]['payment_terms'] : DEFAULT_CUST_PAY_TERMS)." days")) : "&nbsp;")."
								    </td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;".(($details[$i]['type'] == 'I' && $details[$i]['amount'] - $details[$i]['deposit_applied'] < 0) || ($details[$i]['type'] == 'D' && $details[$i]['amount'] > 0) ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(($details[$i]['type'] == 'I' && $details[$i]['amount'] - $details[$i]['deposit_applied'] < 0) || ($details[$i]['type'] == 'D' && $details[$i]['amount'] > 0) ? 
                                        "($".number_format(($details[$i]['type'] == 'I' ? $details[$i]['amount'] - $details[$i]['deposit_applied'] : $details[$i]['amount']),2).")" : "$".number_format(($details[$i]['type'] == 'I' ? $details[$i]['amount'] - $details[$i]['deposit_applied'] : ($details[$i]['amount'] * -1)),2))."
                                    </td>
									<td style=\"background-color:#ffffff;font-size:8pt;".(($details[$i]['type'] == 'I' && $balance < 0) || ($details[$i]['type'] == 'D' && $balance > 0) ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(($details[$i]['type'] == 'I' && $balance < 0) || ($details[$i]['type'] == 'D' && $balance > 0) ?
								        "($".number_format(($details[$i]['type'] == 'I' ? ($balance * -1) : $balance),2).")" : "$".number_format(($details[$i]['type'] == 'D' ? ($balance * -1) : $balance),2))."
                                    </td>
									<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_current'] != 0 ? 
										($details[$i]['balance_current'] < 0 ? 
											"($".number_format($details[$i]['balance_current'] * -1,2).")" : "$".number_format($details[$i]['balance_current'],2)) : NULL)."
									</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_sched1'] != 0 ? 
										($details[$i]['balance_sched1'] < 0 ? 
											"($".number_format($details[$i]['balance_sched1'] * -1,2).")" : "$".number_format($details[$i]['balance_sched1'],2)) : NULL)."
									</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_sched2'] != 0 ? 
										($details[$i]['balance_sched2'] < 0 ? 
											"($".number_format($details[$i]['balance_sched2'] * -1,2).")" : "$".number_format($details[$i]['balance_sched2'],2)) : NULL)."
									</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($details[$i]['balance_sched3'] != 0 ?
										($details[$i]['balance_sched3'] < 0 ? 
											"($".number_format($details[$i]['balance_sched3'] * -1,2).")" : "$".number_format($details[$i]['balance_sched3'],2)) : NULL)."
									</td>
								</tr>";
						}
					}
					
					$grand_total['invoice'] += $total_invoice;
					$grand_total['balance'] += $total_balance;
					
					$grand_total['current'] += $total_current;
					$grand_total['sched1'] += $total_sched1;
					$grand_total['sched2'] += $total_sched2;
					$grand_total['sched3'] += $total_sched3;
					
					$tbl .= "
					<tr>
						<td style=\"font-size:8pt;background-color:#ffffff;padding-top:8px;\" colspan=\"3\"></td>
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_invoice < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_invoice != 0 ? "
                            <div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_invoice < 0 ? 
					            "($".number_format($total_invoice * -1,2).")" : "$".number_format($total_invoice,2))."
                            </div>" : NULL)."
                        </td>
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_balance != 0 ? "
                            <div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_balance < 0 ? " 
                                ($".number_format($total_balance*-1,2).")" : "$".number_format($total_balance,2))."
                            </div>" : NULL)."
                        </td>                        
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_current < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_current != 0 ? "
							<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_current < 0 ? 
								"($".number_format($total_current * -1,2).")" : "$".number_format($total_current,2))."
							</div>" : NULL)."
						</td>
						<td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched1 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_sched1 != 0 ? "
							<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_sched1 < 0 ? 
								"($".number_format($total_sched1 * -1,2).")" : "$".number_format($total_sched1,2))."
							</div>" : NULL)."
						</td>
						<td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched2 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_sched2 != 0 ? "
							<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_sched2 < 0 ? 
								"($".number_format($total_sched2 * -1,2).")" : "$".number_format($total_sched2,2))."
							</div>" : NULL)."
						</td>
						<td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched3 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_sched3 != 0 ? "
							<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_sched3 < 0 ? 
								"($".number_format($total_sched3 * -1,2).")" : "$".number_format($total_sched3,2))."
							</div>" : NULL)."
						</td>
					</tr>";
						
				}
			} else
			    $tbl .= "
			    <tr>
			        <td colspan=\"9\" style=\"background-color:#ffffff;\">Your report generated no results</td>			        
			    </tr>";
			
			$grand_total_all = $grand_total['current'] + $grand_total['sched1'] + $grand_total['sched2'] + $grand_total['sched3'];
			
                $tbl .= "
                <tr>
                    <td style=\"font-size:8pt;background-color:#ffffff;padding-top:8px;\" colspan=\"3\"></td>
                    <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($grand_total['invoice'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($grand_total['invoice'] != 0 ? "
                        <div style=\"border-top:1px dashed #000000;margin-top:15px;font-weight:bold;width:90%;padding-top:5px;\"> 
                            $".number_format($grand_total['invoice'],2)."
                        </div>" : NULL)."
                    </td>
                    <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;\" class=\"num_field\">".($grand_total['balance'] != 0 ? "
                        <div style=\"border-top:1px dashed #000000;margin-top:15px;font-weight:bold;width:90%;padding-top:5px;".($grand_total['balance'] < 0 ? "color:#ff0000;" : NULL)."\">".($grand_total['balance'] < 0 ? " 
                            ($".number_format($grand_total['balance'] * -1,2).")" : "$".number_format($grand_total['balance'],2))."
                        </div>" : NULL)."
                    </td>                        
                    <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_current < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($grand_total['current'] != 0 ? "
                        <div style=\"border-top:1px dashed #000000;margin-top:15px;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['current'] < 0 ? 
                            "($".number_format($grand_total['current'] * -1,2).")" : "$".number_format($grand_total['current'],2))."
                        </div>" : NULL)."
                    </td>
                    <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched1 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($grand_total['sched1'] != 0 ? "
                        <div style=\"border-top:1px dashed #000000;margin-top:15px;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['sched1'] < 0 ? 
                            "($".number_format($grand_total['sched1'] * -1,2).")" : "$".number_format($grand_total['sched1'],2))."
                        </div>" : NULL)."
                    </td>
                    <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched2 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($grand_total['sched2'] != 0 ? "
                        <div style=\"border-top:1px dashed #000000;margin-top:15px;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['sched2'] < 0 ? 
                            "($".number_format($grand_total['sched2'] * -1,2).")" : "$".number_format($grand_total['sched2'],2))."
                        </div>" : NULL)."
                    </td>
                    <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched3 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($grand_total['sched3'] != 0 ? "
                        <div style=\"border-top:1px dashed #000000;margin-top:15px;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['sched3'] < 0 ? 
                            "($".number_format($grand_total['sched3'] * -1,2).")" : "$".number_format($grand_total['sched3'],2))."
                        </div>" : NULL)."
                    </td>
                </tr>
			</table>";

			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
				$this->current_report['customer_filter'] = array($this->current_report['customer_filter']);
			//$tbl = "<pre>".print_r($this->current_report,1)."</pre>";
			$tbl .= $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_ar');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_ar','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Accounts Receivable Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",array("All invoice dates","Invoices dated this year","Invoices dated last year","Invoices from the current period","Invoices from the previous period","A specific date range"),$this->current_report['timeframe'],array('*',1,2,3,4,5),"onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">How should the aging<br />schedule be shown?</td>
											<td style=\"background-color:#ffffff;\">	
												".$this->form->text_box("name=age1","value=".($this->current_report['age1'] ? $this->current_report['age1'] : ACCOUNT_AGING_SCHED1),"size=3","style=text-align:right;padding-right:5px;")." days
												<br />
												".$this->form->text_box("name=age2","value=".($this->current_report['age2'] ? $this->current_report['age2'] : ACCOUNT_AGING_SCHED2),"size=3","style=text-align:right;padding-right:5px;")." days
												<br />
												".$this->form->text_box("name=age3","value=".($this->current_report['age3'] ? $this->current_report['age3'] : ACCOUNT_AGING_SCHED3),"size=3","style=text-align:right;padding-right:5px;")." days
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]",$this->user_name,($this->current_report['sales_rep_match'] ? $this->current_report['sales_rep_match'] : ''),$this->user_hash,"multiple","blank=1","size=4","style=width:200px;")."</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer_vendor",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer_vendor','customer_hash',1);",
                                                                        "onBlur=vtobj.reset_keyResults();key_clear();"
                                                                        )."
                                                
                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
                                                if (is_array($this->current_report['customer_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
                                                        $tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>										
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Include Deposits?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->checkbox("name=deposits","value=1",($this->current_report['deposits'] ? "checked" : NULL))."
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Should the report reflect<br />paid or open invoices?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("invoices_paid",array("Show invoices that hold an open balance","Show invoices that are paid in full"),$this->current_report['invoices_paid'],array('1','2'),"blank=1")."
                                            </td>
                                        </tr>                                       										
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Which date should the report<br />use to generate its results?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("report_date",
                                                                      array("Invoice Date","Due Date"),
                                                                      ($this->current_report['report_date'] ? $this->current_report['report_date'] : DB_PREFIX."vendor_payables.due_date"),
                                                                      array(1,2),
                                                                      "blank=1")."
                                            </td>
                                        </tr>										
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail",array("Show Detail View","Show Simple View"),$this->current_report['showdetail'],array('2','1'),"blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	
	function doit_ar_reconcile() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}

		$report_hash = $_POST['report_hash'];

		$ar_amt = $_POST['ar_amt'];
		$customer_filter = $_POST['customer_vendor_filter'];
		if ($customer_filter && !is_array($customer_filter))
            $customer_filter = array($customer_filter);		
		
		$save = $_POST['save'];
		$saved_cat = "ar_reconcile";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if (!$ar_amt || $ar_amt <= 0 || strspn($ar_amt,"0123456789.") != strlen($ar_amt)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "Please enter a minimum reconciliation amount in order to continue. This amount must be greater than zero.";
		}
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
				
		if ($this->content['error'])
			return;
			
		if (is_array($customer_filter) && count($customer_filter)) {
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."customer_invoice.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		
		$str = "ar_amt=$ar_amt|customer_filter=".@implode("&",$customer_filter);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		


		$result = $this->db->query("SELECT ".DB_PREFIX."customer_invoice.invoice_no , ".DB_PREFIX."customer_invoice.invoice_no , ".DB_PREFIX."customer_invoice.invoice_hash ,
									".DB_PREFIX."customer_invoice.amount , ".DB_PREFIX."customer_invoice.balance , COUNT(".DB_PREFIX."customer_payment.payment_hash) AS total_payment ,
									".DB_PREFIX."customer_invoice.invoice_date ,
								    CASE 
								    WHEN ISNULL(".DB_PREFIX."customers.customer_name)
									  	THEN ".DB_PREFIX."vendors.vendor_name
									  	ELSE 0
								   	END AS vendor_name , ".DB_PREFIX."customers.payment_terms , ".DB_PREFIX."customer_invoice.customer_hash , ".DB_PREFIX."vendors.vendor_name , ".DB_PREFIX."customers.customer_name
									FROM ".DB_PREFIX."customer_invoice
									LEFT JOIN ".DB_PREFIX."customer_payment ON ".DB_PREFIX."customer_payment.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."customer_invoice.customer_hash
									LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."customer_invoice.customer_hash
									WHERE ".DB_PREFIX."customer_invoice.type = 'I' AND ".DB_PREFIX."customer_invoice.balance != 0 AND ".DB_PREFIX."customer_invoice.balance != ".DB_PREFIX."customer_invoice.amount AND ".DB_PREFIX."customer_invoice.balance <= '$ar_amt'
									GROUP BY ".DB_PREFIX."customer_invoice.invoice_hash
									HAVING total_payment > 0");		
		while ($row = $this->db->fetch_assoc($result)) {
			$results[$row['customer_hash']][] = $row;
			$sort_list[$row['customer_hash']] = ($row['customer_name'] ? $row['customer_name'] : $row['vendor_name']);
		}
		if (is_array($sort_list)) {
			asort($sort_list);
			while (list($customer_hash,$detail) = each($sort_list))
				$this->results[$customer_hash] = $results[$customer_hash];
		}
		
		
		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->ar_reconcile(1);
		$this->content['jscript'][] = "setTimeout('DateInput(\'reconcile_date\',\'true\',\'YYYY-MM-DD\',\'".date("Y-m-d")."\',1,\'reconcile_date_holder\',\'&nbsp;&nbsp;Date:\')',1000);";						
		return;

	}
	
	function doit_ar_exec_reconcile() {
		$invoice_reconcile = $_POST['invoice_reconcile'];
		$reconcile_acct = $_POST['reconcile_acct'];
		$reconcile_acct_hash = $_POST['reconcile_acct_hash'];
		$reconcile_date = $_POST['reconcile_date'];
		list($year,$month,$day) = explode("-",$reconcile_date);
		if (!checkdate($month,$day,$year)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'] = "The date you entered is invalid. Please make sure you enter a valid date.";
			$this->content['submit_btn'] = "reconcile_btn";
			return;
		}		
		
		for ($i = 0; $i < count($invoice_reconcile); $i++) {
			if ($invoice_reconcile[$i])
				$invoice[] = $invoice_reconcile[$i];
		}
		if (!$reconcile_acct || ($reconcile_acct && !$reconcile_acct_hash)) {
			$this->content['error'] = 1;
			$this->content['form_return']['err']['error_acct'] = 1;
			$this->content['form_return']['feedback'] = (!$reconcile_acct ? "Please enter the account that you wish to reconcile your outstanding invoices into." : "We can't seem to find the account you selected below. Please make sure you are selecting a valid account from the list displayed.");
			$this->content['submit_btn'] = "reconcile_btn";
			return;
		}
		if (count($invoice)) {
			$customer_invoice = new customer_invoice($this->current_hash);
			$accounting = new accounting($this->current_hash);
			for ($i = 0; $i < count($invoice); $i++) {
				$audit_id = fetch_sys_var('NEXT_AUDIT_ID');
				update_sys_data('NEXT_AUDIT_ID',($audit_id + 1));
				$customer_invoice->fetch_invoice_record($invoice[$i]);
				
				$payment_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				while (global_classes::key_exists(DB_PREFIX.'customer_payment','payment_hash',$payment_hash))
					$payment_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			
				$this->db->query("INSERT INTO `".DB_PREFIX."customer_payment`
								  (`timestamp` , `last_change` , `payment_hash` , `invoice_hash` , `receipt_amount` , `applied_from` , `reconciled` , `audit_id` , `receipt_date` , `receipt_type` , `comments`)
								  VALUES(".time()." , '".$this->current_hash."' , '$payment_hash' , '".$customer_invoice->invoice_hash."' , '".$customer_invoice->current_invoice['balance']."' , '$reconcile_acct_hash' , 1 , '$audit_id' , '$reconcile_date' , 'RC' , 'Reconciled and closed [".date(DATE_FORMAT)."]')");
				$this->db->query("UPDATE `".DB_PREFIX."customer_invoice`
								  SET `timestamp` = ".time()." , `last_change` = '".$this->current_hash."' , `reconciled` = 1 , `paid_in_full` = 1 , `balance` = 0
								  WHERE `invoice_hash` = '".$customer_invoice->invoice_hash."'");
				
				$accounting->acct_ops['ar_payment_hash'] = $payment_hash;
				$accounting->acct_ops['ar_invoice_hash'] = $customer_invoice->invoice_hash;
				$accounting->acct_ops['customer_hash'] = $customer_invoice->current_invoice['customer_hash'];
				$accounting->acct_ops['proposal_hash'] = $customer_invoice->current_invoice['proposal_hash'];				
				
				$accounting->exec_trans($audit_id,$reconcile_date,DEFAULT_AR_ACCT,($customer_invoice->current_invoice['balance'] * -1),'AD',$accounting->acct_ops,'Auto Reconciliation - Invoice '.$customer_invoice->current_invoice['invoice_no'].'.');
				$accounting->exec_trans($audit_id,$reconcile_date,$reconcile_acct_hash,$customer_invoice->current_invoice['balance'],'AD',$accounting->acct_ops,'Auto Reconciliation - Invoice '.$customer_invoice->current_invoice['invoice_no'].'.');
			}		
		
			$this->content['page_feedback'] = "Outstanding invoices have been reconciled and closed.";
			$this->content['action'] = 'continue';
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
		} else {
			$this->content['page_feedback'] = "No invoices were selected, therefore no changes have been made.";
			$this->content['action'] = 'continue';
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
		}
		return;
	}
	
	function ar_reconcile($step=NULL) {
		$this->unlock("_");
		
		if ($step) {
			$acct = new accounting($this->current_hash);
			if (defined('AUTO_WIP_CLEARING_ACCT'))
				$acct->fetch_account_record(AUTO_WIP_CLEARING_ACCT);

			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<div id=\"feedback_holder\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
				<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
					<p id=\"feedback_message\"></p>
			</div>
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px 10px 0 10px;\" colspan=\"6\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Accounts Receivable Reconciliation Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','ar_reconcile','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						</div>
						<div style=\"float:right;margin-bottom:0;margin-top:0;font-weight:normal;\">
							<table>
								<tr>
									<td>
										<span id=\"error_acct\">Reconciliation Account: </span>
										".$this->form->text_box("name=reconcile_acct",
																"value=".($acct->account_hash ? ($acct->current_account['account_no'] ? $acct->current_account['account_no']." - " : NULL).$acct->current_account['account_name'] : NULL),
																"autocomplete=off",
																"onBlur=vtobj.reset_keyResults();key_clear();",
																"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'),'account_suggest');key_call('payables','reconcile_acct','reconcile_acct_hash',1);",
																"onKeyDown=clear_values('reconcile_acct_hash');").
										$this->form->hidden(array("reconcile_acct_hash" => ($acct->account_hash ? $acct->account_hash : '')))."
										<a href=\"javascript:void(0);\" onMouseOver=\"position_element($('keyResults'),findPos($('reconcile_acct'),'top')+20,findPos($('reconcile_acct'),'left')+1,'account_suggest');\" onClick=\"agent.call('payables','exec_post','cf_loadcontent','action=key_search','parent_name=reconcile_acct','parent_id=reconcile_acct_hash','display_area=keyResults','q=*');\"><img src=\"images/arrow_down.gif\" border=\"0\" alt=\"Show all accounts\" /></a>
									</td>
									<td style=\"padding-right:15px;\" id=\"reconcile_date_holder\"></td>
								</tr>
							</table>
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:200px;text-align:left;padding-left:25px;\">Invoice No.</td>
					<td style=\"width:150px;padding:5px;\">Invoice Date</td>
					<td style=\"width:150px;padding:5px;\">Due Date</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Net Invoiced</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Received</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Balance</td>
				</tr>";
			if (is_array($this->results)) {
				$k = 0;
				while (list($customer_hash,$invoice_array) = each($this->results)) {
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" colspan=\"6\">".($invoice_array[0]['customer_name'] ? $invoice_array[0]['customer_name'] : $invoice_array[0]['vendor_name'])."</td>
					</tr>";
					for ($i = 0; $i < count($invoice_array); $i++) {
						$tbl .= "
						<tr>
							<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\">
								".$this->form->checkbox("name=invoice_reconcile[]","value=".$invoice_array[$i]['invoice_hash'],"checked")."&nbsp;
								<a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$invoice_array[$i]['invoice_hash']."','proposal_hash=$proposal_hash','popup_id=line_item');\" class=\"link_standard\">Invoice ".$invoice_array[$i]['invoice_no']."</a>
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($invoice_array[$i]['invoice_date']))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($invoice_array[$i]['invoice_date']." +".($invoice_array[$i]['payment_terms'] ? $invoice_array[$i]['payment_terms'] : DEFAULT_CUST_PAY_TERMS)." days"))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['amount'],2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['amount'] - $invoice_array[$i]['balance'],2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_array[$i]['balance'] < 0 ? 
								"($".number_format($invoice_array[$i]['balance'] * -1,2).")" : "$".number_format($invoice_array[$i]['balance'],2))."</td>
						</tr>";
					}
				}
				$tbl .= "
				<tr>
					<td colspan=\"6\" style=\"background-color:#ffffff;padding:25px 10px 10px 10px;text-align:right;\">
						".$this->form->button("value=Perform Reconciliation","id=reconcile_btn","onClick=if(confirm('Are you sure you want to reconcile the outstanding invoices selected above? This action will close those outstanding balances mark the invoices as paid in full.')){submit_form(this.form,'reports','exec_post','refresh_form','action=doit_ar_exec_reconcile');this.disabled=1}")."
					</td>
				</tr>";
			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"6\">There are no results to show.</td>
				</tr>";

			$tbl .= "
			</table>";
			
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
            if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
                $this->current_report['customer_filter'] = array($this->current_report['customer_filter']);				
				
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_ar_reconcile');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_ar_reconcile','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Accounts Receivable Reconciliation")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">What is the maximum outstanding<br />A/R amount to reconcile?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->text_box("name=ar_amt","value=".(defined('AUTO_WIP_MIN_AMT') ? AUTO_WIP_MIN_AMT : $this->current_report['ar_amt']),"size=10","style=text-align:right;","onBlur=if(this.value){formatCurrency(this.value)}")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer_vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer_vendor','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
														$tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}

	function doit_ap_reconcile() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}

		$report_hash = $_POST['report_hash'];

		$ap_amt = $_POST['ap_amt'];
		$vendor_filter = $_POST['vendor_filter'];
		
		$save = $_POST['save'];
		$saved_cat = "ap_reconcile";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if (!$ap_amt || $ap_amt <= 0 || strspn($ap_amt,"0123456789.") != strlen($ap_amt)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "Please enter a minimum reconciliation amount in order to continue. This amount must be greater than zero.";
		}
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
				
		if ($this->content['error'])
			return;
			
		if (is_array($vendor_filter) && count($vendor_filter)) {
			array_walk($vendor_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($vendor_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		
		$str = "ap_amt=$ap_amt|vendor_filter=".@implode("&",$vendor_filter);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		


		$result = $this->db->query("SELECT ".DB_PREFIX."vendor_payables.invoice_no , ".DB_PREFIX."vendor_payables.invoice_no , ".DB_PREFIX."vendor_payables.invoice_hash ,
									".DB_PREFIX."vendor_payables.amount , ".DB_PREFIX."vendor_payables.balance , COUNT(".DB_PREFIX."vendor_payment.payment_hash) AS total_payment ,
									".DB_PREFIX."vendor_payables.invoice_date , ".DB_PREFIX."vendor_payables.due_date , ".DB_PREFIX."vendor_payables.vendor_hash , ".DB_PREFIX."vendors.vendor_name 
									FROM ".DB_PREFIX."vendor_payables
									LEFT JOIN ".DB_PREFIX."vendor_payment ON ".DB_PREFIX."vendor_payment.invoice_hash = ".DB_PREFIX."vendor_payables.invoice_hash
									LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."vendor_payables.vendor_hash
									WHERE ".DB_PREFIX."vendor_payables.type = 'I' AND ".DB_PREFIX."vendor_payables.balance != 0 AND ".DB_PREFIX."vendor_payables.amount != ".DB_PREFIX."vendor_payables.balance AND ".DB_PREFIX."vendor_payables.balance <= '$ap_amt'
									GROUP BY ".DB_PREFIX."vendor_payables.invoice_hash
									HAVING total_payment > 0");		
		while ($row = $this->db->fetch_assoc($result)) {
			$results[$row['vendor_hash']][] = $row;
			$sort_list[$row['vendor_hash']] = $row['vendor_name'];
		}
		if (is_array($sort_list)) {
			asort($sort_list);
			while (list($vendor_hash,$detail) = each($sort_list))
				$this->results[$vendor_hash] = $results[$vendor_hash];
		}
		
		
		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->ap_reconcile(1);
		return;

	}
	
	function ap_reconcile($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"6\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Accounts Payable Reconciliation")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','ap_reconcile','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:200px;text-align:left;padding-left:25px;\">Invoice No.</td>
					<td style=\"width:150px;padding:5px;\">Invoice Date</td>
					<td style=\"width:150px;padding:5px;\">Due Date</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Net Invoiced</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Amount Paid</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Balance</td>
				</tr>";
			if (is_array($this->results)) {
				$k = 0;
				while (list($customer_hash,$invoice_array) = each($this->results)) {
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" colspan=\"6\">".($invoice_array[0]['customer_name'] ? $invoice_array[0]['customer_name'] : $invoice_array[0]['vendor_name'])."</td>
					</tr>";
					for ($i = 0; $i < count($invoice_array); $i++) {
						$tbl .= "
						<tr>
							<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('payables','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$invoice_array[$i]['invoice_hash']."','popup_id=line_item');\" class=\"link_standard\">Invoice ".$invoice_array[$i]['invoice_no']."</a></td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($invoice_array[$i]['invoice_date']))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($invoice_array[$i]['due_date']))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['amount'],2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['amount'] - $invoice_array[$i]['balance'],2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;".($invoice_array[$i]['amount'] - $invoice_array[$i]['balance'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($invoice_array[$i]['balance'] < 0 ? 
								"($".number_format($invoice_array[$i]['balance'] * -1,2).")" : "$".number_format($invoice_array[$i]['balance'],2))."</td>
						</tr>";
					}
				}

			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"6\">There are no results to show.</td>
				</tr>";

			$tbl .= "
			</table>";
			
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_ap_reconcile');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_ap_reconcile','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Accounts Payable Reconciliation")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">What is the minimum outstanding<br />A/P amount to reconcile?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->text_box("name=ap_amt","value=".(defined('AUTO_WIP_MIN_AMT') ? AUTO_WIP_MIN_AMT : $this->current_report['ap_amt']),"size=10","style=text-align:right;","onBlur=if(this.value){formatCurrency(this.value)}")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','vendor','vendor_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".($this->current_report['vendor_filter'] ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++) 
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	
	function doit_wip_reconcile() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}

		$report_hash = $_POST['report_hash'];

		$wip_amt = $_POST['wip_amt'];
		$vendor_filter = $_POST['vendor_filter'];
		
		$save = $_POST['save'];
		$saved_cat = "wip_reconcile";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if (!$wip_amt || $wip_amt <= 0 || strspn($wip_amt,"0123456789.") != strlen($wip_amt)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "Please enter a minimum reconciliation amount in order to continue. This amount must be greater than zero.";
		}
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
				
		if ($this->content['error'])
			return;
			
		if (is_array($vendor_filter) && count($vendor_filter)) {
			array_walk($vendor_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($vendor_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		
		$str = "wip_amt=$wip_amt|vendor_filter=".@implode("&",$vendor_filter);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;

		$result = $this->db->query("SELECT ".DB_PREFIX."purchase_order.po_no, ".DB_PREFIX."purchase_order.po_date , ".DB_PREFIX."purchase_order.po_product , ".DB_PREFIX."purchase_order.order_amount, 
									".DB_PREFIX."purchase_order.po_hash AS parent_po_hash , ".DB_PREFIX."purchase_order.reconciled , 
									(".DB_PREFIX."purchase_order.order_amount - ".DB_PREFIX."purchase_order.reconciled - 
									( 
										SELECT SUM( ".DB_PREFIX."vendor_payables.amount ) 
										FROM ".DB_PREFIX."vendor_payables
										WHERE po_hash = parent_po_hash
										AND TYPE = 'I' 
									)) AS wip_diff , 
									(
										SELECT SUM( ".DB_PREFIX."vendor_payables.amount ) 
										FROM ".DB_PREFIX."vendor_payables
										WHERE po_hash = parent_po_hash
										AND TYPE = 'I'
									) AS total_invoice_amount , ".DB_PREFIX."vendors.vendor_name , ".DB_PREFIX."proposals.proposal_no , 
									".DB_PREFIX."proposals.proposal_descr , ".DB_PREFIX."proposals.proposal_hash
									FROM `".DB_PREFIX."purchase_order`
									LEFT JOIN `".DB_PREFIX."vendors` ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."purchase_order.vendor_hash
									LEFT JOIN `".DB_PREFIX."proposals` ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."purchase_order.proposal_hash
									HAVING wip_diff != 0 AND wip_diff <= $wip_amt AND wip_diff >= ".($wip_amt * -1));		
		while ($row = $this->db->fetch_assoc($result)) 
			$this->results[$row['parent_po_hash']][] = $row;
		
		
		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->wip_reconcile(1);
		$this->content['jscript'][] = "setTimeout('DateInput(\'reconcile_date\',\'true\',\'YYYY-MM-DD\',\'".date("Y-m-d")."\',1,\'reconcile_date_holder\',\'&nbsp;&nbsp;Date:\')',1000);";						
		return;

	}
	
	function doit_wip_exec_reconcile() {
		$wip_po = $_POST['wip_po'];
		$reconcile_acct = $_POST['reconcile_acct'];
		$reconcile_acct_hash = $_POST['reconcile_acct_hash'];
		$reconcile_date = $_POST['reconcile_date'];
		list($year,$month,$day) = explode("-",$reconcile_date);
		if (!checkdate($month,$day,$year)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'] = "The date you entered is invalid. Please make sure you enter a valid date.";
			$this->content['submit_btn'] = "reconcile_btn";
			return;
		}		
		
		if (!$reconcile_acct || ($reconcile_acct && !$reconcile_acct_hash)) {
			$this->content['error'] = 1;
			$this->content['form_return']['err']['error_acct'] = 1;
			$this->content['form_return']['feedback'] = (!$reconcile_acct ? "Please enter the account that you wish to reconcile your outstanding invoices into." : "We can't seem to find the account you selected below. Please make sure you are selecting a valid account from the list displayed.");
			$this->content['submit_btn'] = "reconcile_btn";
			return;
		}
		$accounting = new accounting($this->current_hash);
		while (list($po_hash,$wip_amt) = each($wip_po)) {
			$audit_id = fetch_sys_var('NEXT_AUDIT_ID');
			update_sys_data('NEXT_AUDIT_ID',($audit_id + 1));
			
			$result = $this->db->query("SELECT `po_no` , `vendor_hash` , `proposal_hash`
										FROM `".DB_PREFIX."purchase_order`
										WHERE `po_hash` = '$po_hash'");
			$po_no = $this->db->result($result,0,'po_no');
			$proposal_hash = $this->db->result($result,0,'proposal_hash');
			$vendor_hash = $this->db->result($result,0,'vendor_hash');
			
			$this->db->query("UPDATE `".DB_PREFIX."purchase_order`
							  SET `timestamp` = ".time()." , `last_change` = '".$this->current_hash."' , `reconciled` = (".DB_PREFIX."purchase_order.reconciled + ".$wip_amt.")
							  WHERE `po_hash` = '$po_hash'");

			$accounting->acct_ops['vendor_hash'] = $vendor_hash;
			$accounting->acct_ops['proposal_hash'] = $proposal_hash;
							  
			$accounting->exec_trans($audit_id,$reconcile_date,DEFAULT_WIP_ACCT,($wip_amt * -1),'AD',$accounting->acct_ops,'WIP Auto Reconciliation - PO '.$po_no.'.');
			$accounting->exec_trans($audit_id,$reconcile_date,$reconcile_acct_hash,$wip_amt,'AD',$accounting->acct_ops,'WIP Auto Reconciliation - PO '.$po_no.'.');
			$a = true;
		} 
		if ($a) {
			$this->content['page_feedback'] = "Outstanding WIP balances have been reconciled and closed.";
			$this->content['action'] = 'continue';
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
		} else {
			$this->content['page_feedback'] = "No PO balances were selected, therefore no changes have been made.";
			$this->content['action'] = 'continue';
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
		}
	}
	
	function wip_reconcile($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$acct = new accounting($this->current_hash);
			if (defined('AUTO_WIP_CLEARING_ACCT'))
				$acct->fetch_account_record(AUTO_WIP_CLEARING_ACCT);

			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"6\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "WIP Reconciliation Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','wip_reconcile','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						<div style=\"float:right;margin-bottom:0;margin-top:0;font-weight:normal;\">
							<table>
								<tr>
									<td>
										<span id=\"error_acct\">Reconciliation Account: </span>
										".$this->form->text_box("name=reconcile_acct",
																"value=".($acct->account_hash ? ($acct->current_account['account_no'] ? $acct->current_account['account_no']." - " : NULL).$acct->current_account['account_name'] : NULL),
																"autocomplete=off",
																"onBlur=vtobj.reset_keyResults();key_clear();",
																"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'),'account_suggest');key_call('payables','reconcile_acct','reconcile_acct_hash',1);",
																"onKeyDown=clear_values('reconcile_acct_hash');").
										$this->form->hidden(array("reconcile_acct_hash" => ($acct->account_hash ? $acct->account_hash : '')))."
										<a href=\"javascript:void(0);\" onMouseOver=\"position_element($('keyResults'),findPos($('reconcile_acct'),'top')+20,findPos($('reconcile_acct'),'left')+1,'account_suggest');\" onClick=\"agent.call('payables','exec_post','cf_loadcontent','action=key_search','parent_name=reconcile_acct','parent_id=reconcile_acct_hash','display_area=keyResults','q=*');\"><img src=\"images/arrow_down.gif\" border=\"0\" alt=\"Show all accounts\" /></a>
									</td>
									<td style=\"padding-right:15px;\" id=\"reconcile_date_holder\"></td>
								</tr>
							</table>
						</div>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:100px;text-align:left;\">PO Date</td>
					<td style=\"width:200px;text-align:left;\">PO No.</td>
					<td style=\"width:300px;\">Vendor</td>
					<td style=\"width:100px;padding-right:15px;\" class=\"num_field\">PO Amount</td>
					<td style=\"width:100px;\" class=\"num_field\">Invoice Amount</td>
					<td style=\"width:100px;\" class=\"num_field\">WIP Balance</td>
				</tr>";
			
			if (is_array($this->results)) {
				while (list($po_hash,$wip_array) = each($this->results)) {
					for ($i = 0; $i < count($wip_array); $i++) {
						$tbl .= "
						<tr>
							<td style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;font-size:8pt;\">
								".$this->form->checkbox("name=wip_po[".$po_hash."]","value=".$wip_array[$i]['wip_diff'],"checked")."&nbsp;".
								date(DATE_FORMAT,strtotime($wip_array[$i]['po_date']))."
							</td>
							<td style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;font-size:8pt;\">
								<a href=\"javascript:void(0);\" onClick=\"agent.call('purchase_order','sf_loadcontent','show_popup_window','edit_po','po_hash=".$wip_array[$i]['po_hash']."','proposal_hash=".$wip_array[$i]['proposal_hash']."','popup_id=line_item');\" class=\"link_standard\">".$wip_array[$i]['po_no']."</a>".($wip_array[$i]['po_product'] ? 
									" (".(strlen($wip_array[$i]['po_product']) > 35 ? 
										substr($wip_array[$i]['po_product'],0,32)."..." : $wip_array[$i]['po_product']).")" : NULL)."
							</td>
							<td style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;font-size:8pt;\">".$wip_array[$i]['vendor_name']."</td>
							<td style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">
								$".number_format($wip_array[$i]['order_amount'],2).($wip_array[$i]['reconciled'] ? "
								<span style=\"padding-left:5px;font-style:italic;\" title=\"Previously reconciled WIP amount\">($".number_format($wip_array[$i]['reconciled'],2).")</span>" : NULL)."
							</td>
							<td style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">$".number_format($wip_array[$i]['total_invoice_amount'],2)."</td>
							<td style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">$".number_format($wip_array[$i]['wip_diff'],2)."</td>
						</tr>";
					}
				}
				$tbl .= "
				<tr>
					<td colspan=\"6\" style=\"background-color:#ffffff;padding:25px 10px 10px 10px;text-align:right;\">
						".$this->form->button("value=Perform Reconciliation","id=reconcile_btn","onClick=if(confirm('Are you sure you want to reconcile the selected outstanding WIP balances? This action will close those outstanding balances..')){submit_form(this.form,'reports','exec_post','refresh_form','action=doit_wip_exec_reconcile');this.disabled=1}")."
					</td>
				</tr>";
			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"6\">There are no results to show.</td>
				</tr>";

			$tbl .= "
			</table>";
			
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_wip_reconcile');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_commission_report','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "WIP Reconciliation Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">What is the minimum outstanding<br />WIP amount to reconcile?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->text_box("name=wip_amt","value=".(defined('AUTO_WIP_MIN_AMT') ? AUTO_WIP_MIN_AMT : $this->current_report['wip_amt']),"size=10","style=text-align:right;","onBlur=if(this.value){formatCurrency(this.value)}")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','vendor','vendor_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".($this->current_report['vendor_filter'] ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++) 
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}

	function doit_commission_report($local=NULL) {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['report_hash'];
		
		if ($report_hash && $doit_print) {
			$this->fetch_report_settings($report_hash);
			
			$late_tier = $this->current_report['late_tier'];
			if ($late_tier == 3) {
				$day = $this->current_report['day'];
				$com_action = $this->current_report['com_action'];
				$com_rate = $this->current_report['com_rate'];
			}
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$req = $this->current_report['req'];
			$sales_rep_match = $this->current_report['sales_rep_match'];
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);
		} else {
			$late_tier = $_POST['late_tier'];
			if ($late_tier == 3) {
				$day = $_POST['day'];
				$com_action = $_POST['com_action'];
				$com_rate = $_POST['com_rate'];
			}
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}

			$req = $_POST['req'];
			$sales_rep_match = $_POST['sales_rep_match'];			
		}

		
		if ($local)
			$proposal_hash = $local;
		
		$save = $_POST['save'];
		$saved_cat = "commission_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 5 && !$sort_from_date) || ($timeframe == 5 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		
		if ($this->content['error'])
			return;

		//  Add timeframe filter for ticket #360	
		switch ($timeframe) {
			case 1:
			$sql_date_iif = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y")."'";
			$sql_date_pif = "YEAR(".DB_PREFIX."customer_payment.receipt_date) = '".date("Y")."'";
			$sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y")."'";
			$this->report_title = "Dated ".date("Y");
			break;

			case 2:
			$sql_date_iif = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			$sql_date_pif = "YEAR(".DB_PREFIX."customer_payment.receipt_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			$sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			$this->report_title = "Dated ".(date("Y") -  1);
			break;
			
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_date_iif = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sql_date_pif = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$this->report_title = "Dated Between ".date(DATE_FORMAT,strtotime($period_info['period_start']))." and ".date(DATE_FORMAT,strtotime($period_info['period_end']));
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {		
				$sql_date_iif = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sql_date_pif = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";			
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$this->report_title = "Dated Between ".date(DATE_FORMAT,strtotime($period_info['period_start']))." and ".date(DATE_FORMAT,strtotime($period_info['period_end']));
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			case 5:
			if ($sort_from_date && $sort_to_date) {
				$sql_date_iif = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$sql_date_pif = DB_PREFIX."customer_payment.receipt_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = "Dated Between ".date(DATE_FORMAT,strtotime($sort_from_date))." and ".date(DATE_FORMAT,strtotime($sort_to_date));
			} else {
				$sql_date_pif = DB_PREFIX."customer_payment.receipt_date >= '".$sort_from_date."'";
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date >= '".$sort_from_date."'";
				$this->report_title = "Dated Between ".date(DATE_FORMAT,strtotime($sort_from_date))." and ".date(DATE_FORMAT);
			}
			break;
			
			default:
				$this->report_title = "As of ".date(DATE_FORMAT);
		}
		// SQL statment for specific dates of commission report
		if ($sql_d) 
			$sql_d = implode($sql_d);
		if (@in_array("IIP",$req))
			$req_invoiced = 1;
		// Invoiced in Full
		if (@in_array("IIF",$req)) {
			$sql_h[] = "total_uninvoiced_lines = 0";
			/*$sql_p[] = "(SELECT COUNT(".DB_PREFIX."proposals.obj_id)
               					FROM ".DB_PREFIX."proposals
               					LEFT JOIN ".DB_PREFIX."line_items ON ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash
			   					WHERE ".DB_PREFIX."line_items.proposal_hash = parent_proposal_hash AND ".DB_PREFIX."line_items.active != 1 AND ".DB_PREFIX."line_items.invoice_hash = '') = 0";*/
		}	
		// Paid in Full			
		if (@in_array("PIF",$req)) {
			$sql_h[] = "total_amount_received >= total_amount_invoiced";
/*			$sql_p[] = "(SELECT SUM(".DB_PREFIX."customer_payment.receipt_amount)
				   FROM ".DB_PREFIX."customer_invoice
				   LEFT JOIN ".DB_PREFIX."customer_payment ON ".DB_PREFIX."customer_payment.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash
				   WHERE $sql_date_pif
				  ) >= ".DB_PREFIX."customer_invoice.amount ";*/
		}
		if (@in_array("PRF",$req)) {
			$prf_percent = $_POST['prf_percent'];
		}
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($sales_rep_match,'strip_quotes');
		}
		
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		if ($sql_h)
			$having = implode(" AND ",$sql_h);
		
		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|late_tier=$late_tier|day=$day|com_action=$com_action|com_rate=$com_rate|req=".@implode("&",$req)."|prf_percent=$prf_percent|sales_rep_match=".@implode("&",$sales_rep_match);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."proposals.proposal_no, ".DB_PREFIX."proposals.proposal_hash AS parent_proposal_hash , 
									".DB_PREFIX."proposals.proposal_descr, ".DB_PREFIX."users.full_name, ".DB_PREFIX."users.commission_hash AS user_commission, 
									".DB_PREFIX."proposals.sales_hash , ".DB_PREFIX."proposals.customer_hash , ".DB_PREFIX."customers.gsa , ".DB_PREFIX."customers.customer_name ,
									".DB_PREFIX."customer_invoice.invoice_hash as parent_invoice_hash ,
									(
										SELECT SUM(".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.balance)
										FROM `".DB_PREFIX."customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I'
									) AS total_amount_received ,
									(
										SELECT SUM(".DB_PREFIX."customer_invoice.amount)
										FROM `".DB_PREFIX."customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'D'
									) AS total_deposit_received ,
									(
										SELECT SUM(".DB_PREFIX."customer_invoice.amount)
										FROM `".DB_PREFIX."customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I'
									) AS total_amount_invoiced ,
									COUNT(".DB_PREFIX."line_items.invoice_hash) AS total_line_items ,
									(
									SELECT COUNT(*)
									FROM `".DB_PREFIX."line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND `invoice_hash` = ''
									) AS total_uninvoiced_lines ,
									".DB_PREFIX."vendor_products.product_name , ".DB_PREFIX."vendor_products.product_hash as parent_product_hash ,
									(
									SELECT SUM(".DB_PREFIX."line_items.cost * ".DB_PREFIX."line_items.qty)
									FROM `".DB_PREFIX."line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND 
									CASE
									WHEN ISNULL(parent_product_hash)
										THEN ISNULL(`product_hash`)
									ELSE `product_hash` = parent_product_hash
									END
									) AS total_product_cost , 
									(
									SELECT SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty)
									FROM `".DB_PREFIX."line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND 
									CASE
									WHEN ISNULL(parent_product_hash)
										THEN ISNULL(`product_hash`)
									ELSE `product_hash` = parent_product_hash
									END
									) AS total_product_sell , 
									(
									SELECT SUM(".DB_PREFIX."vendor_payables.amount)
									FROM `".DB_PREFIX."vendor_payables`
									LEFT JOIN `".DB_PREFIX."purchase_order` ON ".DB_PREFIX."purchase_order.po_hash = ".DB_PREFIX."vendor_payables.po_hash
									WHERE ".DB_PREFIX."purchase_order.proposal_hash = parent_proposal_hash
									) AS total_payables_received , ".DB_PREFIX."commissions_paid.cost , ".DB_PREFIX."commissions_paid.amount AS previous_commission_paid
									FROM ".DB_PREFIX."line_items
									LEFT JOIN ".DB_PREFIX."proposals ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."line_items.proposal_hash
									LEFT JOIN ".DB_PREFIX."customer_invoice ON ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."line_items.invoice_hash
									LEFT JOIN ".DB_PREFIX."vendor_products ON ".DB_PREFIX."vendor_products.product_hash = ".DB_PREFIX."line_items.product_hash
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."proposals.customer_hash
									LEFT JOIN ".DB_PREFIX."users ON ".DB_PREFIX."users.id_hash = ".DB_PREFIX."proposals.sales_hash
									LEFT JOIN ".DB_PREFIX."commissions_paid ON ".DB_PREFIX."commissions_paid.proposal_hash = ".DB_PREFIX."line_items.proposal_hash
									WHERE (".DB_PREFIX."commissions_paid.paid_in_full = 0 OR ISNULL(".DB_PREFIX."commissions_paid.paid_in_full)) AND ".($proposal_hash ? DB_PREFIX."line_items.proposal_hash = '$proposal_hash' AND " : NULL).DB_PREFIX."line_items.po_hash != '' ".($req_invoiced ?"AND ".DB_PREFIX."line_items.invoice_hash != ''" : NULL).($sql ? " AND ".$sql : NULL)."
									GROUP BY ".DB_PREFIX."line_items.proposal_hash , ".DB_PREFIX."line_items.product_hash".($having ? " HAVING ".$having : NULL));
		while ($row = $this->db->fetch_assoc($result)) {
			if ($row['total_line_items'] > 0) 
				$this->results[$row['sales_hash']][$row['parent_proposal_hash']][] = $row;
		}
		$this->overhead_record = array();
		$this->commission_rule = array();
		
		$sys_config = new system_config($this->current_hash);
		if (is_array($this->results)) {
			reset($this->results);
			while (list($sales_hash,$proposal_array) = each($this->results)) {
				while (list($proposal_hash,$detail) = each($proposal_array)) {
					unset($overhead);
					$result = $this->db->query("SELECT `overhead_hash` , `type` 
												FROM `".DB_PREFIX."overhead_rules`
												WHERE `active` = 1 
												  AND (('".date("Y-m-d")."' BETWEEN `effective_date` AND `expiration_date`) OR (`effective_date` = '' AND `expiration_date` = '') OR (`effective_date` != '' AND ".date("Y-m-d")." >= `effective_date`) OR (`expiration_date` != '' AND ".date("Y-m-d")." <= `expiration_date`))
												  AND ((`type` = 'C' AND `customer_hash` = '".$detail[0]['customer_hash']."') ".($detail[0]['gsa'] ? "
													  OR `type` = 'G'" : NULL)."
														   OR `type` = 'D')");
					while ($row = $this->db->fetch_assoc($result))
						$overhead[$row['type']] = $row;
						
					if ($overhead['C']) 
						$overhead_hash = $overhead['C']['overhead_hash'];
					elseif ($overhead['G']) 
						$overhead_hash = $overhead['G']['overhead_hash'];
					elseif ($overhead['D']) 
						$overhead_hash = $overhead['D']['overhead_hash'];
	
					if ($overhead_hash) {
						if (!$this->overhead_record[$overhead_hash]) {
							$sys_config->fetch_overhead_record($overhead_record);
							$this->overhead_record[$overhead_record] = $sys_config->current_overhead;
						}
						
						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$this->overhead_record[$overhead_record]['rate'],
																				'apply_to'	=>	$this->overhead_record[$overhead_record]['apply_to']);
					} elseif (defined('OVERHEAD_TYPE')) {
						$overhead_rate = (float)OVERHEAD_RATE;
						
						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$overhead_rate,
																				'apply_to'	=>	OVERHEAD_TYPE);
					}
					//Get any memo costs
					unset($memo);
					$result = $this->db->query("SELECT *
												FROM `".DB_PREFIX."memo_costs`
												WHERE `proposal_hash` = '$proposal_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$memo[] = $row;
						
					if ($memo)
						$this->results_misc[$proposal_hash]['MEMO'] = $memo;
					
					//Get any job costs
					unset($job_cost);
					$result = $this->db->query("SELECT *
												FROM `".DB_PREFIX."vendor_payable_expenses`
												WHERE `proposal_hash` = '$proposal_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$job_cost[] = $row;
					
					if ($job_cost)
						$this->results_misc[$proposal_hash]['JOB_COST'] = $job_cost;
						
					unset($com);
					//Get the commission
					$result = $this->db->query("SELECT `commission_hash` , `type`
												FROM `".DB_PREFIX."commission_tables`
												WHERE `active` = 1 
												  AND (('".date("Y-m-d")."' BETWEEN `effective_date` AND `expiration_date`) OR (`effective_date` = '' AND `expiration_date` = '') OR (`effective_date` != '' AND ".date("Y-m-d")." >= `effective_date`) OR (`expiration_date` != '' AND ".date("Y-m-d")." <= `expiration_date`))
												  AND ((`type` = 'C' AND `customer_hash` = '".$detail[0]['customer_hash']."') ".($detail[0]['gsa'] ? "
													  OR `type` = 'G'" : NULL).($detail[0]['user_commission'] ? "
														   OR (`type` = 'D' AND `commission_hash` = '".$detail[0]['user_commission']."')" : NULL).")");
					while ($row = $this->db->fetch_assoc($result))
						$com[$row['type']] = $row;
						
					if ($com['C']) {
						if (!$this->commission_rule[$com['C']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['C']['commission_hash']);
							$this->commission_rule[$com['C']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['C']['commission_hash']];
					} elseif ($com['G']) {
						if (!$this->commission_rule[$com['G']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['G']['commission_hash']);
							$this->commission_rule[$com['G']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['G']['commission_hash']];
					} elseif ($com['D']) {
						if (!$this->commission_rule[$com['D']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['D']['commission_hash']);
							$this->commission_rule[$com['D']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['D']['commission_hash']];
					}
				}
			}
		}
		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		if ($local)
			return true;
		else
			$this->content['html']['place_holder'] = $this->commission_report(1);
		return;
	}

	function commission_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => '', 'report_hash' => $this->report_hash))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Commission Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','commission_report','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
					</td>
				</tr>
				<tr>
					<td style=\"text-align:left;width:500px;padding:5px;background-color:#ffffff\" colspan=\"3\">
						<h5 style=\"margin-bottom:5px;color:#00477f;\">".$this->report_title."</div>
						</h5>
					</td>
					<td style=\"background-color:#ffffff\" colspan=\"4\"></td>
				</tr>				
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:350px;text-align:left;padding-left:50px;\">Product</td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
				</tr>";
			$customers = new customers($this->current_hash);
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				reset($this->results);
				while (list($sales_hash,$proposal_array) = each($this->results)) {
					unset($inner_tbl);
					$sales_commission = $total_invoiced = $total_received = $total_sales_cost = $total_deposits = $k = 0;
					while (list($proposal_hash,$product_array) = each($proposal_array)) {
						if ($this->results_misc[$proposal_hash]['COMM']) {
							$comm_paid = 1;
							$inner_tbl .= ($k > 0 ?"
							<tr>
								<td colspan=\"5\" style=\"background-color:#cccccc;\"></td>
							</tr>" : NULL)."
							<tr>
								<td colspan=\"5\" style=\"font-size:8pt;background-color:#ffffff;padding-left:25px;padding-top:5px;\">
									".$this->form->hidden(array('proposal_owner['.$proposal_hash.']' => $sales_hash))."
									".$this->form->checkbox("name=proposal[".$proposal_hash."]","value=1","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=adjust_memo_cost');","checked")."
									&nbsp;
									Proposal: <a href=\"javascript:void(0);\" onClick=\"agent.call('proposals','sf_loadcontent','show_popup_window','edit_proposal','proposal_hash=$proposal_hash','popup_id=proposal_win','from_report=1');\" class=\"link_standard\">".$product_array[0]['proposal_no']."</a> - ".$product_array[0]['proposal_descr']."
									<div style=\"padding-top:5px;\">".$product_array[0]['customer_name']."</div>
								</td>
							</tr>";
							$k++;
							$total_sell = $total_cost = $total_profit = 0;
							for ($i = 0; $i < count($product_array); $i++) {
								$inner_tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".($product_array[$i]['product_name'] ? $product_array[$i]['product_name'] : "Miscellaneous")."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($product_array[$i]['total_product_sell'],2)."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($product_array[$i]['total_product_cost'],2).$this->form->hidden(array('cost['.$proposal_hash.'][]' => $product_array[$i]['total_product_cost']))."</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;".($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost'] < 0 ? "color:#ff0000;" : NULL)."\">".($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost']  < 0 ? "
										($".number_format(($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost']) * -1,2).")" : "$".number_format($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost'],2))."
									</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;".(defined('MARGIN_FLAG') && math::gp_margin($product_array[$i]['total_product_cost'],$product_array[$i]['total_product_sell']) < MARGIN_FLAG ? "color:red;" : NULL)."\">".
										(math::gp_margin($product_array[$i]['total_product_cost'],$product_array[$i]['total_product_sell']) * 100)."%
									</td>
								</tr>";
								$total_sell += $product_array[$i]['total_product_sell'];
								$total_cost += $product_array[$i]['total_product_cost'];
							}
							if ($this->results_misc[$proposal_hash]['OVERHEAD'] && $this->results_misc[$proposal_hash]['OVERHEAD']['rate']) {
								if ($this->results_misc[$proposal_hash]['OVERHEAD']['apply_to'] == 'C') 
									$overhead_factor = _round($total_cost * $this->results_misc[$proposal_hash]['OVERHEAD']['rate'],2);
								elseif ($this->results_misc[$proposal_hash]['OVERHEAD']['apply_to'] == 'S') 
									$overhead_factor = _round($total_sell * $this->results_misc[$proposal_hash]['OVERHEAD']['rate'],2);
	
								$inner_tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">Company Overhead Factor</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($overhead_factor,2).$this->form->hidden(array('cost['.$proposal_hash.'][]' => $overhead_factor))."</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								</tr>";
								$total_cost += $overhead_factor;
							}
							if ($this->results_misc[$proposal_hash]['MEMO']) {
								for ($i = 0; $i < count($this->results_misc[$proposal_hash]['MEMO']); $i++) {
									$inner_tbl .= "
									<tr>
										<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".(strlen($this->results_misc[$proposal_hash]['MEMO'][$i]['descr']) > 45 ? 
											substr($this->results_misc[$proposal_hash]['MEMO'][$i]['descr'],0,42)."..." : $this->results_misc[$proposal_hash]['MEMO'][$i]['descr'])."
										</td>
										<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
										<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($this->results_misc[$proposal_hash]['MEMO'][$i]['amount'],2).$this->form->hidden(array('cost['.$proposal_hash.'][]' => $this->results_misc[$proposal_hash]['MEMO'][$i]['amount']))."</td>
										<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
										<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									</tr>";
									$total_cost += $this->results_misc[$proposal_hash]['MEMO'][$i]['amount'];
								}
							}
							if ($this->results_misc[$proposal_hash]['JOB_COST']) {
								for ($i = 0; $i < count($this->results_misc[$proposal_hash]['JOB_COST']); $i++) {
									$inner_tbl .= "
									<tr>
										<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".(strlen($this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo']) > 45 ? 
											substr($this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo'],0,42)."..." : $this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo'])."
										</td>
										<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
										<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($this->results_misc[$proposal_hash]['JOB_COST'][$i]['amount'],2).$this->form->hidden(array('cost['.$proposal_hash.'][]' => $this->results_misc[$proposal_hash]['JOB_COST'][$i]['amount']))."</td>
										<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
										<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									</tr>";
									$total_cost += $this->results_misc[$proposal_hash]['JOB_COST'][$i]['amount'];
								}
							}
							$inner_tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\"id=\"memo_descr_".$proposal_hash."\"></td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"memo_cost_".$proposal_hash."\"></td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
							</tr>";
							unset($neg_gp);
							$blended_gp = math::gp_margin($total_cost,$total_sell);
							if ($blended_gp < 0) {
								$blended_gp *= -1;
								$neg_gp = true;
							}
							unset($com_rate,$com_due);
							while (list($tier,$rule_array) = each($this->results_misc[$proposal_hash]['COMM']['rules'])) {
								if ($blended_gp >= $rule_array['tier_start'] && (floor($blended_gp * 100) * .01) <= $rule_array['tier_end']) {
									if ($rule_array['tier_action'] == 'P') {
										$com_rate = _round($blended_gp,4);
										$com_due = _round(($total_sell - $total_cost) * $com_rate,2);
									} elseif ($rule_array['tier_action'] == 1) {
										$com_rate = $rule_array['tier_rate'];
										$com_due = _round(($total_sell - $total_cost) * $com_rate,2);
									}
								}
							}
							if ($neg_gp) {
								$blended_gp *= -1;
								$com_rate *= -1;
							}
							$inner_tbl .= "							
							<tr >
								<td style=\"background-color:#ffffff;padding-left:50px;\">
									[<span style=\"font-size:8pt;\"><a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('payables','sf_loadcontent','show_popup_window','edit_memo_cost','proposal_hash=$proposal_hash','popup_id=memo_win','commission_hash=".$this->results_misc[$proposal_hash]['COMM']['commission_hash']."','from=commission');\">new memo cost</a></span>]
								</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_sell_".$proposal_hash."\">
										".$this->form->hidden(array('total_sell['.$proposal_hash.']' => $total_sell, 'commission_used['.$proposal_hash.']' => $this->results_misc[$proposal_hash]['COMM']['commission_hash']))."
										$".number_format($total_sell,2)."
									</div>
								</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_cost_".$proposal_hash."\">".($total_cost < 0 ? 
										"($".number_format($total_cost * -1,2).")" : "$".number_format($total_cost,2))."
									</div>
								</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_profit_".$proposal_hash."\">".($total_sell - $total_cost < 0 ?
										"<span style=\"color:#ff0000;\">($".number_format(($total_sell - $total_cost) * -1,2).")</span>" : "$".number_format($total_sell - $total_cost,2))."
									</div>
								</td>
								<td class=\"num_field\" class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_gp_".$proposal_hash."\">". 
										(defined('MARGIN_FLAG') && math::gp_margin($total_cost,$total_sell) < MARGIN_FLAG ?
											"<span style=\"color:#ff0000;\">(".($blended_gp * 100 * -1)."%)</span>" : ($blended_gp * 100)."%")."
									</div>
								</td>
							</tr>
							<tr>
								<td style=\"padding-bottom:15px;padding-top:8px;background-color:#ffffff;font-size:8pt;padding-left:25px;\" colspan=\"5\">
									<div style=\"margin-bottom:5px;\" >
										Net Invoiced: <span id=\"net_invoiced_".$proposal_hash."\">$".number_format($product_array[0]['total_amount_invoiced'],2)."</span>
										&nbsp;&nbsp;
										".$this->form->hidden(array("received[".$proposal_hash."]" => $product_array[0]['total_amount_received'], "deposits[".$proposal_hash."]" => $product_array[0]['total_deposit_received']))."
										Received: $".number_format($product_array[0]['total_amount_received'],2)."
										&nbsp;&nbsp;
										Deposits: $".number_format($product_array[0]['total_deposit_received'],2)."
										&nbsp;&nbsp;
										Total Payables: $".number_format($product_array[0]['total_payables_received'],2)."
									</div>
									<div style=\"margin-bottom:5px;\" >
										Commission Rate: <span id=\"commission_rate_".$proposal_hash."\">".($com_rate * 100)."%</span> (".$this->form->hidden(array("commission_rate[".$proposal_hash."]" => $com_rate)).$this->results_misc[$proposal_hash]['COMM']['name'].")".($product_array[0]['previous_commission_paid'] ? "
										&nbsp;										
										Previous Commissions Paid: $".number_format($product_array[0]['previous_commission_paid'],2).$this->form->hidden(array('previous_commission_paid['.$proposal_hash.']' => $product_array[0]['previous_commission_paid'])) : NULL)."
									</div>									
									<div style=\"margin-bottom:5px;\">
										Commission Owed: ".$this->form->text_box("name=commission_owed[".$proposal_hash."]","id=commission_owed_".$proposal_hash,"value=".number_format($com_due - $product_array[0]['previous_commission_paid'],2),"size=8","style=text-align:right;font-size:8pt;","onBlur=if(this.value){this.value=formatCurrency(this.value);}submit_form(this.form,'reports','exec_post','refresh_form','action=adjust_memo_cost');")."
										&nbsp;
										[<a href=\"javascript:void(0);\" onClick=\"submit_form(\$('test').form,'reports','exec_post','refresh_form','action=adjust_memo_cost','recalc=".$proposal_hash."');\" class=\"link_standard\">recalculate</a>]
										&nbsp;&nbsp;
										Paid In Full:
										&nbsp;
										".$this->form->checkbox("name=paid_in_full[".$proposal_hash."]","value=1","checked")."
									</div>
								</td>
							</tr>";
							
							$total_invoiced += $total_sell;
							$total_received += $product_array[0]['total_amount_received'];
							$sales_commission += ($com_due - $product_array[0]['previous_commission_paid']);
							$total_deposits += $product_array[0]['total_deposit_received'];
							$total_sales_cost += $total_cost;
						}
					}
					if ($inner_tbl) {
						$tbl .= "
						<tr style=\"background-color:#efefef;\">
							<td style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".$this->user_name($sales_hash)."</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Sell</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Cost</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>
						</tr>"
						. $inner_tbl;
						$all_commission += $sales_commission;
						$sales_commission_array[$sales_hash] = array('full_name'			=>	$this->user_name($sales_hash),
																     'total_invoiced' 	    =>	$total_invoiced,
																     'total_received'		=>  $total_received,
																     'total_cost'			=>	$total_sales_cost,
																     'total_deposits'		=>	$total_deposits,
																     'total_profit'			=>  ($total_invoiced - $total_cost),
																     'total_commission'		=>  $sales_commission);
					}	
				}
				if ($all_commission) {
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;\" colspan=\"5\">
							<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"width:100%;margin-top:0;\">
								<tr style=\"background-color:#efefef;\">
									<td style=\"padding:5px;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\">Sales Rep</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Net Invoiced</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Received</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Deposits</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Actual Cost</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Commission Owed</td>
								</tr>";
							while (list($sales_hash,$sales_array) = each($sales_commission_array)) {
								$tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;\">".$this->form->hidden(array('sales_array['.$sales_hash.']' => 1)).$sales_array['full_name']."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_invoiced_".$sales_hash."\">$".number_format($sales_array['total_invoiced'],2)."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_received_".$sales_hash."\">$".number_format($sales_array['total_received'],2)."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_deposits_".$sales_hash."\">$".number_format($sales_array['total_deposits'],2)."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_cost_".$sales_hash."\">".$this->form->hidden(array('current_cost_'.$sales_hash => $sales_array['total_cost']))."$".number_format($sales_array['total_cost'],2)."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_profit_".$sales_hash."\">".($sales_array['total_invoiced'] - $sales_array['total_cost'] < 0 ?
										"<span style=\"color:#ff0000;\">($".number_format(($sales_array['total_invoiced'] - $sales_array['total_cost']),2).")" : "$".number_format(($sales_array['total_invoiced'] - $sales_array['total_cost']),2))."
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_gp_".$sales_hash."\">".(defined('MARGIN_FLAG') && math::gp_margin($sales_array['total_cost'],$sales_array['total_invoiced']) < MARGIN_FLAG ? 
										"<span style=\"color:#ff0000;\">".(math::gp_margin($sales_array['total_cost'],$sales_array['total_invoiced']) * 100)."%</span>" : (math::gp_margin($sales_array['total_cost'],$sales_array['total_invoiced']) * 100)."%")."
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_commission_".$sales_hash."\">
										".$this->form->hidden(array('current_commission_'.$sales_hash => $sales_array['total_commission']))."$".number_format($sales_array['total_commission'],2)."
									</td> 
								</tr>";
								$total_net_invoiced += $sales_array['total_invoiced'];
								$total_net_received += $sales_array['total_received'];
								$total_net_cost += $sales_array['total_cost'];
								$total_net_deposits += $sales_array['total_deposits'];
							}
							$tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">&nbsp;</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_invoiced\">
											$".number_format($total_net_invoiced,2)."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_received\">
											$".number_format($total_net_received,2)."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_deposits\">
											$".number_format($total_net_deposits,2)."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_cost\">
											$".number_format($total_net_cost,2)."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_profit\">".($total_net_invoiced - $total_net_cost < 0 ? 
											"<span style=\"color:#ff0000;\">($".number_format($total_net_invoiced - $total_net_cost,2).")</span>" : "$".number_format($total_net_invoiced - $total_net_cost,2))."										
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_margin\">".(defined('MARGIN_FLAG') && math::gp_margin($total_net_cost,$total_net_invoiced) < MARGIN_FLAG ? 
											"<span style=\"color:#ff0000;\">".(math::gp_margin($total_net_cost,$total_net_invoiced) * 100)."%</span>" : (math::gp_margin($total_net_cost,$total_net_invoiced) * 100)."%")."										
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_commission\">
											$".number_format($all_commission,2)."
										</div>
									</td>
								</tr>
							</table>
							<div style=\"margin-top:45px;margin-bottom:15px;margin-right:45px;text-align:right;\">
								<div style=\"padding-bottom:5px;\" id=\"pay_date_holder\">";
									$this->content['jscript'][] = "setTimeout('DateInput(\'pay_date\',\'true\',\'YYYY-MM-DD\',\'".date("Y-m-d")."\',1,\'pay_date_holder\',\'Commission Date: \')',45);";						
								$tbl .= "
								</div>
								".$this->form->button("value=Post Commissions","onClick=if(confirm('Are you sure you want to post commissions? All proposals will be updated with the commission settings you have input above.')){submit_form(this.form,'reports','exec_post','refresh_form','action=post_commission');}")."
							</div>
						</td>
					</tr>";
				}
			} 
			if (!$this->results || !$comm_paid)
				$tbl .= "
				<tr>
					<td colspan=\"5\" style=\"padding:25px 0px 5px 5px;background-color:#ffffff;\">Your commission report is empty.</td>
				</tr>";
			
			$tbl .= "
			</table>".$this->form->close_form();
									
			return $tbl;
		} else {
			$action_out = array("commission at","no commission");
			$action_in = array(1,0);
			
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_commission_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_commission_report','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Commissions Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"";
/*										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",array("All dates","This year","Last year","Current period","Previous period","A specific date range"),$this->current_report['timeframe'],array('*',1,2,3,4,5),"onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr> */										
									$tbl .= "	<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">How should commissions<br />be tiered for late payments?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("late_tier",array("No Late Payment Tier","Pay Full Commission Through 90 Days, Then No Commission","Pay Full Commission Through 120 Days, Then No Commission","Create A Custom Late Payment Commission Tier"),$this->current_report['late_tier'],array(0,1,2,3),"blank=1","style=width:400px","onChange=if(this.options[this.selectedIndex].value == 3){toggle_display('late_tier_holder".$this->popup_id."','block')}else{toggle_display('late_tier_holder".$this->popup_id."','none')}")."
												<div style=\"padding-top:5px;display:".($this->current_report['late_tier'] == 3 ? "block" : "none").";\" id=\"late_tier_holder".$this->popup_id."\">
													<table style=\"width:100%;\" cellpadding=\"5\">
														<tr>
															<td style=\"background-color:#cccccc;border:1px solid #00477f;\" nowrap>
																<div style=\"padding-bottom:10px;\" id=\"tier_content_holder".$this->popup_id."\">";
																if ($this->report_hash && $this->current_report['late_tier'] == 3) {
																	$i = 0;
																	$tbl .= $this->form->hidden(array('tier_complete' => 1));
																	while (list($day,$com_array) = each($this->current_report['late_tier_rules'])) {
																		$tbl .= $this->form->hidden(array('day[]'			=>	$day,
																										  'com_action[]'	=>	$com_array['com_action'],
																										  'com_rate[]'		=>	($com_array['com_action'] == 1 ? $com_array['tier_rate'] * 100 : $com_array['tier_rate'])))."
																		<div style=\"padding-bottom:10px;\">
																			<span><a href=\"javascript:void(0);\" onClick=\"submit_form(\$('popup_id').form,'reports','exec_post','refresh_form','action=new_commission_tier','undo=".$i."','report_hash=".$this->commission_hash."')\"><img src=\"images/b_drop_small.gif\" alt=\"Undo to this tier\" border=\"0\" /></a></span>
																			If Over $day Days
																			then ".$action_out[array_search($com_action['tier_action'],$action_in)].($com_action['tier_action'] == '1' ? 
																				" ".($com_action['tier_rate'] * 100)." % of commission rate" : NULL)."
																		</div>";
																		$i++;
																	}
																} else
																	$tbl .= "
																	If Over ".$this->form->text_box("name=day[]","value=","size=5","style=text-align:right;")." Days 
																	then ".$this->form->select("com_action[]",$action_out,(!$this->report_hash ? 1 : $this->current_report['a']),$action_in,"blank=1","onChange=if(this.options[this.selectedIndex].value==1){\$('rate_holder_0').style.visibility='visible';}else{\$('rate_holder_0').style.visibility='hidden'}")."&nbsp;
																	<span id=\"rate_holder_0\" style=\"visibility:visible;\">".$this->form->text_box("name=com_rate[]","value=","size=5")."&nbsp;% of commission rate</span>";
																
																$tbl .= "
																</div>
																<div style=\"text-align:right;padding:15px 75px 10px 0;display:".($this->report_hash ? "none" : "block")."\" id=\"commission_plus_btn".$this->popup_id."\">
																	<a href=\"javascript:void(0);\" onClick=\"submit_form(\$('popup_id').form,'reports','exec_post','refresh_form','action=new_commission_tier')\"><img src=\"images/plus.gif\" border=\"0\" /></a>
																</div>
															</td>
														</tr>
													</table>
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">In order to pay commissions,<br />proposals must be:</td>
											<td style=\"background-color:#ffffff;\">
												<div>".$this->form->checkbox("name=req[]","value=IIP",(@in_array('IIP',$this->current_report['req']) || $this->current_report['req'] ? "checked" : NULL))."&nbsp;Commissionable line items must be invoiced</div>
												<div style=\"padding-top:5px;\">".$this->form->checkbox("name=req[]","value=IIF",(@in_array('IIF',$this->current_report['req']) || $this->current_report['req'] == 'IIF' ? "checked" : NULL))."&nbsp;Proposal must be invoiced in full</div>
												<div style=\"padding-top:5px;\">".$this->form->checkbox("name=req[]","value=PIF",(@in_array('PIF',$this->current_report['req']) || $this->current_report['req'] == 'PIF' ? "checked" : NULL))."&nbsp;Invoices must be paid in full</div>
												<div style=\"padding-top:5px;\">".$this->form->checkbox("name=req[]","value=PRF",(@in_array('PRF',$this->current_report['req']) || $this->current_report['req'] == 'PRF' ? "checked" : NULL),"onClick=if(this.checked){toggle_display('prf','block')}else{toggle_display('prf','none')}")."&nbsp;Proposal payables must be received in full</div>
												<div style=\"margin:5px 25px;display:".(@in_array('PRF',$this->current_report['req']) || $this->current_report['req'] == 'PRF' ? "block" : "none")."\" id=\"prf\">
													Or received within ".$this->form->text_box("name=prf_percent","value=","size=3")." %
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]",$this->user_name,($this->current_report['sales_rep'] ? $this->current_report['sales_rep'] : ''),$this->user_hash,"multiple","blank=1","size=4","style=width:200px;")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}

	function new_commission_tier() {
		$day = $_POST['day'];
		$com_action = $_POST['com_action'];
		$com_rate = $_POST['com_rate'];
		$undo = $_POST['undo'];
		$report_hash = $_POST['report_hash'];
		$tier_complete = $_POST['tier_complete'];
		
		$action_out = array("commission at","no commission");
		$action_in = array(1,0);
			
		if (!is_array($day)) {
			$day = array($day);
			$com_action = array($com_action);
			$com_rate = array($com_rate);
		}

		for ($i = 0; $i < count($day); $i++) {
			if (is_numeric($undo) && $undo == $i) 
				break;
			
			if ($tier_action[$i] == '1')
				$com_rate[$i] *= 1;
				
			if ($i == count($day) - 1 && $day[$i] <= $day[$i-1]) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "The commission date value you entered (".$day[$i].") is invalid. The value for this tier must be greater than ".($day[$i-1]).".";
				return;
			}
			if ($com_action[$i] == '1' && ($com_rate[$i] <= 0 || $com_rate[$i] > 100)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "The commission rate you entered for this day (".$day[$i].") is invalid. Please enter a valid commission rate (i.e. 10 for 10%).";
				return;
			}
			if (!is_numeric($undo) && !$tier_complete && strspn($day[$i],"0123456789") != strlen($day[$i])) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "When entering commission tiers, please enter only whole numbers.";
				return;
			}
			$tbl .= $this->form->hidden(array('day[]'			=>	$day[$i],
											  'com_action[]'	=>	$com_action[$i],
											  'com_rate[]'		=>	$com_rate[$i]))."
			<div style=\"padding-bottom:10px;\">
				<span><a href=\"javascript:void(0);\" onClick=\"submit_form(\$('popup_id').form,'reports','exec_post','refresh_form','action=new_commission_tier','undo=".$i."','report_hash=$report_hash')\"><img src=\"images/b_drop_small.gif\" alt=\"Undo to this tier\" border=\"0\" /></a></span>
				If Over ".$day[$i]." Days
				then ".$action_out[array_search($com_action[$i],$action_in)].($com_action[$i] == '1' ? 
					" ".$com_rate[$i]." % of commission rate" : NULL)."
			</div>";
			
			$tier_val = $day[$i];
		}
		$this->content['action'] = 'continue';
		$this->content['html']['tier_content_holder'.$this->popup_id] = $tbl . "
		<div style=\"padding-bottom:10px;\">
			If Over ".$this->form->text_box("name=day[]","value=","size=5","style=text-align:right;")." Days 
			then ".$this->form->select("com_action[]",$action_out,1,$action_in,"blank=1","onChange=if(this.options[this.selectedIndex].value==1){\$('rate_holder').style.visibility='visible';}else{\$('rate_holder').style.visibility='hidden'}")."&nbsp;
			<span id=\"rate_holder\" style=\"visibility:visible;\">".$this->form->text_box("name=com_rate[]","value=","size=5")."&nbsp;% of commission rate</span>
		</div>";
		$this->content['jscript'] = "toggle_display('commission_plus_btn".$this->popup_id."','block');";	
		return;
	}
	
	function adjust_memo_cost() {
		$proposal_hash = $_POST['proposal_hash'];
		$memo_hash = $_POST['memo_hash'];
		$commission_hash = $_POST['commission_hash'];
		$recalc = $_POST['recalc'];
		
		//Array of all proposals to be paid commission on
		$proposal = $_POST['proposal'];
		while (list($tmp_proposal_hash,$on) = each($proposal)) {
			if ($on)
				$include_proposal[$tmp_proposal_hash] = 1;
		}
		$sales_array = $_POST['sales_array'];
		$commission_owed = $_POST['commission_owed'];
		$proposal_owner = $_POST['proposal_owner'];
		$sell = $_POST['total_sell'];
		$cost = $_POST['cost'];
		$received = $_POST['received'];
		$deposits = $_POST['deposits'];
		$commission_used = $_POST['commission_used'];
		$previous_commission_paid = $_POST['previous_commission_paid'];
		
		$sales_hash = $proposal_owner[$proposal_hash];
		while (list($tmp_proposal_hash,$dollars) = each($commission_owed)) {
			if ($include_proposal[$tmp_proposal_hash]) {
				if ((!$memo_hash || ($memo_hash && $proposal_hash != $tmp_proposal_hash)) && (!$recalc || ($recalc && $recalc != $tmp_proposal_hash)))
					$comm_array[$proposal_owner[$tmp_proposal_hash]] += ereg_replace("[^-.0-9]", "",$dollars);
				
				$sell_array[$proposal_owner[$tmp_proposal_hash]] += $sell[$tmp_proposal_hash];
				$received_array[$proposal_owner[$tmp_proposal_hash]] += $received[$tmp_proposal_hash];
				$deposits_array[$proposal_owner[$tmp_proposal_hash]] += $deposits[$tmp_proposal_hash];
				for ($i = 0; $i < count($cost[$tmp_proposal_hash]); $i++) 
					$cost_array[$proposal_owner[$tmp_proposal_hash]] += $cost[$tmp_proposal_hash][$i];
			}
		}
		if ($memo_hash || $recalc) {
			if ($recalc) {
				$proposal_hash = $recalc;
				$commission_hash = $commission_used[$proposal_hash];	
			} else {
				$p = new payables($this->current_hash);
				$p->fetch_memo_cost_record($memo_hash);
				$memo_amount = $p->current_memo['amount'];
	
				$this->content['jscript'][] = "\$('memo_descr_$proposal_hash').insert( {bottom: '<div style=\"padding-bottom:3px;\">".$p->current_memo['descr']."</div>' });";
				$this->content['jscript'][] = "\$('memo_cost_$proposal_hash').insert( {bottom: '<div style=\"padding-bottom:3px;\">$".number_format($p->current_memo['amount'],2).$this->form->hidden(array('cost['.$proposal_hash.'][]' => $p->current_memo['amount']))."</div>' });";
			}
			$proposal_cost_array = $cost[$proposal_hash];
			$proposal_sell = $sell[$proposal_hash];
			for ($i = 0; $i < count($proposal_cost_array); $i++)
				$proposal_cost += $proposal_cost_array[$i];
			
			if ($memo_hash) {
				$proposal_cost += $memo_amount;
				$cost_array[$proposal_owner[$proposal_hash]] += $memo_amount;
			}
			$profit = $proposal_sell - $proposal_cost;
			$previous = $previous_commission_paid[$proposal_hash];
			
			$s = new system_config($this->current_hash);
			$s->fetch_commission_record($commission_hash);
			$proposal_gp = math::gp_margin($proposal_cost,$proposal_sell);
			if ($proposal_gp < 0) {
				$proposal_gp *= -1;
				$neg_gp = true;
			}
			while (list($tier,$rule_array) = each($s->current_commission['rules'])) {
				if ($proposal_gp >= $rule_array['tier_start'] && (floor($proposal_gp * 100) * .01) <= $rule_array['tier_end']) {
					if ($rule_array['tier_action'] == 'P') {
						$com_rate = _round($proposal_gp,4);
						$com_due = _round(($proposal_sell - $proposal_cost) * $com_rate,2);
						if ($previous)
							$com_due -= $previous;
					} elseif ($rule_array['tier_action'] == 1) {
						$com_rate = $rule_array['tier_rate'];
						$com_due = _round(($proposal_sell - $proposal_cost) * $com_rate,2);
						if ($previous)
							$com_due -= $previous;
					}
				}
			}
			if ($neg_gp) {
				$proposal_gp *= -1;
				$com_rate *= -1;
			}
			$comm_array[$proposal_owner[$proposal_hash]] += $com_due;
			$this->content['html']['total_cost_'.$proposal_hash] = ($proposal_cost < 0 ? "<span style=\"color:#ff0000;\">($".number_format($proposal_cost * -1,2).")</span>" : "$".number_format($proposal_cost,2));
			$this->content['html']['total_gp_'.$proposal_hash] = (defined('MARGIN_FLAG') && $proposal_gp < MARGIN_FLAG ? "<span style=\"color:#ff0000;\">".($proposal_gp * 100)."%</span>" : ($proposal_gp * 100)."%");
			$this->content['html']['total_profit_'.$proposal_hash] = ($profit < 0 ? "<span style=\"color:#ff0000;\">($".number_format($profit * -1,2).")</span>" : "$".number_format($profit,2));
			$this->content['html']['commission_rate_'.$proposal_hash] = ($com_rate * 100)."%";
			$this->content['value']['commission_owed_'.$proposal_hash] = number_format($com_due,2);
		}
		
		//Sales Rep Totals
		while (list($sales_hash,$on) = each($sales_array)) {
			$current_commission = $_POST['current_commission_'.$sales_hash];
			$current_cost = $_POST['current_cost_'.$sales_hash];
			if (bccomp($current_commission,$comm_array[$sales_hash]) != 0 || bccomp($current_cost,$cost_array[$sales_hash]) != 0) {
				$update = true;
				$this->content['html']['total_commission_'.$sales_hash] = $this->form->hidden(array('current_commission_'.$sales_hash => $comm_array[$sales_hash])).($comm_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format($comm_array[$sales_hash],2).")</span>" : "$".number_format($comm_array[$sales_hash],2));
				$this->content['html']['total_invoiced_'.$sales_hash] = ($sell_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format($sell_array[$sales_hash] * -1,2).")</span>" : "$".number_format($sell_array[$sales_hash],2));
				$this->content['html']['total_received_'.$sales_hash] = ($received_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format($received_array[$sales_hash] * -1,2).")</span>" : "$".number_format($received_array[$sales_hash],2));
				$this->content['html']['total_deposits_'.$sales_hash] = ($deposits_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format($deposits_array[$sales_hash] * -1,2).")</span>" : "$".number_format($deposits_array[$sales_hash],2));
				$this->content['html']['total_cost_'.$sales_hash] = $this->form->hidden(array('current_cost_'.$sales_hash => $cost_array[$sales_hash])).($cost_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format($cost_array[$sales_hash] * -1,2).")</span>" : "$".number_format($cost_array[$sales_hash],2));
				$this->content['html']['total_profit_'.$sales_hash] = ($sell_array[$sales_hash] - $cost_array[$sales_hash] < 0 ? "<span style=\"color:#ff0000;\">($".number_format(($sell_array[$sales_hash] - $cost_array[$sales_hash]) * -1,2).")</span>" : "$".number_format($sell_array[$sales_hash] - $cost_array[$sales_hash],2));
				$this->content['html']['total_gp_'.$sales_hash] = ($cost_array[$sales_hash] != 0 && $sell_array[$sales_hash] != 0 ? (defined('MARGIN_FLAG') && math::gp_margin($cost_array[$sales_hash],$sell_array[$sales_hash]) < MARGIN_FLAG ? "<span style=\"color:#ff0000;\">".(math::gp_margin($cost_array[$sales_hash],$sell_array[$sales_hash]) * 100)."%</span>" : (math::gp_margin($cost_array[$sales_hash],$sell_array[$sales_hash]) * 100)."%") : "&nbsp;");
			}
		}
		
		//Grand Totals
		if ($update) {
			$this->content['html']['total_invoiced'] = "$".number_format(array_sum($sell_array),2);
			$this->content['html']['total_received'] = "$".number_format(array_sum($received_array),2);
			$this->content['html']['total_deposits'] = "$".number_format(array_sum($deposits_array),2);
			$this->content['html']['total_commission'] = "$".number_format(array_sum($comm_array),2);
			$this->content['html']['total_cost'] = "$".number_format(array_sum($cost_array),2);
			$this->content['html']['total_profit'] = (array_sum($sell_array) - array_sum($cost_array) < 0 ? "<span style=\"color:#ff0000;\">($".number_format(array_sum($sell_array) - array_sum($cost_array),2).")</span>" : "$".number_format(array_sum($sell_array) - array_sum($cost_array),2));
			$this->content['html']['total_margin'] = (defined('MARGIN_FLAG') && math::gp_margin(array_sum($cost_array),array_sum($sell_array)) < MARGIN_FLAG ? "<span style=\"color:#ff0000;\">".(math::gp_margin(array_sum($cost_array),array_sum($sell_array)) * 100)."%</span>" : (math::gp_margin(array_sum($cost_array),array_sum($sell_array)) * 100)."%");
		}	
			
		$this->content['action'] = 'continue';
		return;
	}
	
	function post_commission() {
		$report_hash = $_POST['report_hash'];
		$this->fetch_report_settings($report_hash);
		
		$req = $this->current_report['req'];
		if (@in_array("IIP",$req))
			$req_invoiced = 1;
		
		if (@in_array("IIF",$req))
			$sql_h[] = "total_uninvoiced_lines = 0";
					
		if (@in_array("PIF",$req))
			$sql_h[] = "total_amount_received >= total_amount_invoiced";

		if ($sql_h)
			$having = implode(" AND ",$sql_h);
			
		$sales_array = $_POST['sales_array'];
		
		//Array of all proposals to be paid commission on
		$proposal = $_POST['proposal'];
		$sales_array = $_POST['sales_array'];
		$commission_owed = $_POST['commission_owed'];
		$paid_in_full = $_POST['paid_in_full'];
		$commission_rate = $_POST['commission_rate'];
		$proposal_owner = $_POST['proposal_owner'];
		$sell = $_POST['total_sell'];
		$cost = $_POST['cost'];
		$received = $_POST['received'];
		$commission_used = $_POST['commission_used'];
		$pay_date = $_POST['pay_date'];
		$previous_commission_paid = $_POST['previous_commission_paid'];
		
		while (list($tmp_proposal_hash,$on) = each($proposal)) {
			if ($on) {
				$proposal_commission = ereg_replace("[^-.0-9]", "",$commission_owed[$tmp_proposal_hash]);
				$previous_commission = ereg_replace("[^-.0-9]", "",$previous_commission_paid[$tmp_proposal_hash]);
				$comm_array[$proposal_owner[$tmp_proposal_hash]] += $proposal_commission;
				$sell_array[$proposal_owner[$tmp_proposal_hash]] += $sell[$tmp_proposal_hash];
				$received_array[$proposal_owner[$tmp_proposal_hash]] += $received[$tmp_proposal_hash];
				for ($i = 0; $i < count($cost[$tmp_proposal_hash]); $i++) 
					$cost_array[$proposal_owner[$tmp_proposal_hash]] += $cost[$tmp_proposal_hash][$i];

				$commission_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				while (global_classes::key_exists(DB_PREFIX.'commissions_paid','commission_hash',$commission_hash))
					$commission_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
				$result = $this->db->query("SELECT ".DB_PREFIX."line_items.item_hash , ".DB_PREFIX."commissions_paid.cost , ".DB_PREFIX."commissions_paid.commission_hash , 
											(
												SELECT SUM(".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.balance)
												FROM `".DB_PREFIX."customer_invoice`
												WHERE `proposal_hash` = '$tmp_proposal_hash' AND `type` = 'I'
											) AS total_amount_received , 
											(
												SELECT SUM(".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.tax)
												FROM `".DB_PREFIX."customer_invoice`
												WHERE `proposal_hash` = '$tmp_proposal_hash' AND `type` = 'I'
											) AS total_amount_invoiced ,
											(
												SELECT SUM(".DB_PREFIX."customer_invoice.amount)
												FROM `".DB_PREFIX."customer_invoice`
												WHERE `proposal_hash` = '$tmp_proposal_hash' AND `type` = 'D'
											) AS total_deposits_received , 
											(
												SELECT COUNT(".DB_PREFIX."line_items.obj_id)
												FROM `".DB_PREFIX."line_items`
												WHERE `proposal_hash` = '$tmp_proposal_hash' 
											) AS total_line_items , 
											(
												SELECT COUNT(".DB_PREFIX."line_items.obj_id)
												FROM `".DB_PREFIX."line_items`
												WHERE `proposal_hash` = '$tmp_proposal_hash' AND `invoice_hash` = ''
											) AS total_uninvoiced_lines  
											FROM ".DB_PREFIX."line_items
											LEFT JOIN ".DB_PREFIX."commissions_paid ON ".DB_PREFIX."commissions_paid.commission_hash = ".DB_PREFIX."line_items.commission_hash
											WHERE ".DB_PREFIX."line_items.proposal_hash = '$tmp_proposal_hash' AND (".DB_PREFIX."commissions_paid.paid_in_full = 0 OR ISNULL(".DB_PREFIX."commissions_paid.commission_hash)) AND ".DB_PREFIX."line_items.po_hash != '' ".($req_invoiced ? "AND ".DB_PREFIX."line_items.invoice_hash != ''" : NULL).($having ? " 
											HAVING ".$having : NULL));
				while ($row = $this->db->fetch_assoc($result)) {
					if ($row['commission_hash']) 
						$commission_exists = $commission_hash = $row['commission_hash'];						
						
					if (!$row['commission_hash'])
						$this->db->query("UPDATE `".DB_PREFIX."line_items`
										  SET `commission_hash` = '$commission_hash'
										  WHERE `item_hash` = '".$row['item_hash']."'");
				}
				if ($commission_exists) {
					if ($previous_commission != 0)
						$proposal_commission += $previous_commission;
					
					$this->db->query("UPDATE `".DB_PREFIX."commissions_paid`
									  SET `timestamp` = ".time()." , `last_change` = '".$this->current_hash."' , `paid_date` = '$pay_date' , 
									  `paid_in_full` = '".$paid_in_full[$tmp_proposal_hash]."' , `rate` = '".$commission_rate[$tmp_proposal_hash]."' , 
									  `amount` = '$proposal_commission' , ".($previous_commission ? "`previous_amount` = '$previous_commission' ," : NULL)." `cost` = '".@array_sum($cost[$tmp_proposal_hash])."'
									  WHERE `commission_hash` = '$commission_exists'");
				} else
					$this->db->query("INSERT INTO `".DB_PREFIX."commissions_paid`
									  (`timestamp` , `last_change` , `paid_date` , `proposal_hash` , `commission_hash` , `paid_in_full` , `rate` , `user_hash` , `amount` , `cost`)
									  VALUES (".time()." , '".$this->current_hash."' , '$pay_date' , '$tmp_proposal_hash' , '$commission_hash' , '".$paid_in_full[$tmp_proposal_hash]."' , '".$commission_rate[$tmp_proposal_hash]."' , '".$proposal_owner[$tmp_proposal_hash]."' , '$proposal_commission' , '".@array_sum($cost[$tmp_proposal_hash])."')");
			
			}
		}
		reset($comm_array);
		
		$sum_tbl = "
		<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"width:100%;margin-top:0;\">
			<tr style=\"background-color:#efefef;\">
				<td style=\"padding:5px;font-weight:bold;border-bottom:1px solid #cccccc;width:80%;\">Sales Rep</td>
				<td style=\"vertical-align:bottom;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Commission Paid</td>
			</tr>";
		while (list($sales_hash,$on) = each($sales_array)) {
			$sum_tbl .= "
			<tr>
				<td style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;\">".$this->user_name($sales_hash)."</td>
				<td style=\"background-color:#ffffff;border-bottom:1px solid #cccccc;\" class=\"num_field\">$".number_format($comm_array[$sales_hash],2)."</td> 
			</tr>";
			$total_commission += $comm_array[$sales_hash];
		}
		$sum_tbl .= "
			<tr>
				<td style=\"background-color:#efefef;padding-left:50px;\">&nbsp;</td>
				<td style=\"font-weight:bold;background-color:#efefef;\" class=\"num_field\">
					<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
						$".number_format($total_commission,2)."
					</div>
				</td>
			</tr>
		</table>";
		
		$sum_tbl = "
		<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
			<tr>
				<td style=\"width:100%;background-color:#ffffff;padding:10px;\">
					<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
						".($this->current_report['saved'] ? 
							$this->current_report['report_name'] : "Commission Report Summary")."
					</h3>
					<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
				</td>
			</tr>
			<tr>
				<td style=\"width:100%;background-color:#ffffff;padding:10px;\">".$sum_tbl."</td>
			</tr>
		</table>";
		$this->content['html']['place_holder'] = $sum_tbl;
		$this->content['action'] = 'continue';
		return;
	}
	
	function doit_job_costing($local=NULL) {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		$report_hash = $_POST['report_hash'];
		$from_print = 1;
		if ($report_hash && $from_print) {
			$timeframe = $this->current_report['timeframe'];
			$sales_rep_match = $this->current_report['sales_rep_match'];
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);
			
			$customer_filter = $this->current_report['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
				
			$proposal_filter = $this->current_report['proposal_filter'];
			if ($proposal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);
		} else {
			$timeframe = $_POST['timeframe'];		
			$sales_rep_match = $_POST['sales_rep_match'];
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);
			
			$customer_filter = $_POST['customer_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
			
			$proposal_filter = $_POST['proposal_filter'];
			if ($proposal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);
		}
		$save = $_POST['save'];
		$saved_cat = "job_costing";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
				
		switch ($timeframe) {
			//booked this month
			case 1:
			
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-".date("t"))."'";
			break;
			//invoiced this month
			case 2:
			
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-".date("t"))."'";
			break;
			//created this month
			case 3:
			$sql_p[] = DB_PREFIX."proposals.creation_date BETWEEN '".strtotime(date("Y-m-01"))."' AND '".strtotime(date("Y-m-".date("t")))."'";
			break;
			//booked last month
			case 4:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}				
			
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$year."-".$month."-01' AND '".$year."-".$month."-".date("t",strtotime($year."-".$month."-01"))."'";
			break;
			//invoiced last month		
			case 5:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}				
			
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$year."-".$month."-01' AND '".$year."-".$month."-".date("t",strtotime($year."-".$month."-01"))."'";
			break;
			//created last month		
			case 6:
			if (date("m") == 1) {
				$month = 12;
				$year = date("Y") - 1;
			} else {
				$month = date("m") - 1;
				$year = date("Y");
			}
			$sql_p[] = DB_PREFIX."proposals.creation_date BETWEEN '".strtotime($year."-".$month."-01")."' AND '".strtotime($year."-".$month."-".date("t",strtotime($year."-".$month."-01")))."'";
			break;
			//booked this quarter
			case 7:
			
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$start."' AND '".$end."'";
			break;
			//invoiced this quarter
			case 8:
			
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$start."' AND '".$end."'";
			break;
			//created this quarter
			case 9:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
				
			$sql_p[] = DB_PREFIX."proposals.creation_date BETWEEN '".strtotime($start)."' AND '".strtotime($end)."'";
			break;	
			//Booked last quarter	
			case 10:
			
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$start."' AND '".$end."'";				
			break;		
			//invoiced last quarter			
			case 11:
			
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$start."' AND '".$end."'";				
			break;
			//created last quarter
			case 12:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."customer_invoice.creation_date BETWEEN '".strtotime($start)."' AND '".strtotime($end)."'";				
			break;
			//booked this period
			case 13:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}				
			break;		
			//invoiced this period
			case 14:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}			
			break;		
			//created this period
			case 15:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."proposals.creation_date BETWEEN '".strtotime($period_info['period_start'])."' AND '".strtotime($period_info['period_end'])."'";			
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			//booked last period
			case 16:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."purchase_order.po_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";				
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			//invoiced last period
			case 17:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";				
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			//created last period
			case 18:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = DB_PREFIX."proposals.creation_date BETWEEN '".strtotime($period_info['period_start'])."' AND '".strtotime($period_info['period_end'])."'";				
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			//booked this year		
			case 19:
			
			$sql_p[] = "YEAR(".DB_PREFIX."purchase_order.po_date) = '".date("Y")."'";				
			break;		
			//invoiced this year
			case 20:
						
			$sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y")."'";				
			break;
			//created this year
			case 21:
			$sql_p[] = DB_PREFIX."proposals.creation_date BETWEEN '".strtotime(date("Y-01-01"))."' AND '".strtotime(date("Y-12-31"))."'";				
			break;
			//booked last year
			case 22:
			
			$sql_p[] = "YEAR(".DB_PREFIX."purchase_order.po_date) = ".date("Y",strtotime(date("Y-m-d")." -1 year"));
			break;	
			//invoiced last year	
			case 23:
				
			$sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			break;	
			//created last year	
			case 24:
			$sql_p[] = DB_PREFIX."proposals.creation_date BETWEEN '".date("Y-01-01",strtotime(date("Y-m-d")." -1 year"))."' AND '".date("Y-12-31",strtotime(date("Y-m-d")." -1 year"))."'";
			break;				
		}
		
		if ($this->content['error'])
			return;

		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($sales_rep_match,'strip_quotes');
		}
        if (is_array($customer_filter) && count($customer_filter)) {
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}
		if (is_array($proposal_filter) && count($proposal_filter)) {
			array_walk($proposal_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.proposal_hash IN (".implode(" , ",$proposal_filter).")";
			array_walk($proposal_filter,'strip_quotes');
		}		
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		if ($sql_h)
			$having = implode(" AND ",$sql_h);
		
		$str = "timeframe=$timeframe|proposal_filter=".implode("&",$proposal_filter)."|customer_filter=".implode("&",$customer_filter)."|sales_rep_match=".@implode("&",$sales_rep_match);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."proposals.proposal_no, ".DB_PREFIX."proposals.proposal_hash AS parent_proposal_hash , 
									".DB_PREFIX."proposals.proposal_descr, ".DB_PREFIX."users.full_name,  
									".DB_PREFIX."proposals.sales_hash , ".DB_PREFIX."proposals.customer_hash , ".DB_PREFIX."customers.gsa , ".DB_PREFIX."customers.customer_name ,
									".DB_PREFIX."customer_invoice.invoice_hash as parent_invoice_hash ,
									(
										SELECT SUM(".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.balance)
										FROM `".DB_PREFIX."customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I'
									) AS total_amount_received ,
									(
										SELECT SUM(".DB_PREFIX."customer_invoice.amount)
										FROM `".DB_PREFIX."customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'D'
									) AS total_deposit_received ,
									(
										SELECT SUM(".DB_PREFIX."customer_invoice.amount)
										FROM `".DB_PREFIX."customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I'
									) AS total_amount_invoiced ,
									COUNT(".DB_PREFIX."line_items.invoice_hash) AS total_line_items ,
									(
									SELECT COUNT(*)
									FROM `".DB_PREFIX."line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND `invoice_hash` = ''
									) AS total_uninvoiced_lines ,
									".DB_PREFIX."vendor_products.product_name , ".DB_PREFIX."vendor_products.product_hash as parent_product_hash ,
									(
									SELECT SUM(".DB_PREFIX."line_items.cost * ".DB_PREFIX."line_items.qty)
									FROM `".DB_PREFIX."line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND 
									CASE
									WHEN ISNULL(parent_product_hash)
										THEN ISNULL(`product_hash`)
									ELSE `product_hash` = parent_product_hash
									END
									) AS total_product_cost , 
									(
									SELECT SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty)
									FROM `".DB_PREFIX."line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND 
									CASE
									WHEN ISNULL(parent_product_hash)
										THEN ISNULL(`product_hash`)
									ELSE `product_hash` = parent_product_hash
									END
									) AS total_product_sell , 
									(
									SELECT SUM(".DB_PREFIX."vendor_payables.amount)
									FROM `".DB_PREFIX."vendor_payables`
									LEFT JOIN `".DB_PREFIX."purchase_order` ON ".DB_PREFIX."purchase_order.po_hash = ".DB_PREFIX."vendor_payables.po_hash
									WHERE ".DB_PREFIX."purchase_order.proposal_hash = parent_proposal_hash
									) AS total_payables_received
									FROM ".DB_PREFIX."line_items
									LEFT JOIN ".DB_PREFIX."proposals ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."line_items.proposal_hash
									LEFT JOIN ".DB_PREFIX."customer_invoice ON ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."line_items.invoice_hash
									LEFT JOIN ".DB_PREFIX."purchase_order ON ".DB_PREFIX."purchase_order.po_hash = ".DB_PREFIX."line_items.po_hash									
									LEFT JOIN ".DB_PREFIX."vendor_products ON ".DB_PREFIX."vendor_products.product_hash = ".DB_PREFIX."line_items.product_hash
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."proposals.customer_hash
									LEFT JOIN ".DB_PREFIX."users ON ".DB_PREFIX."users.id_hash = ".DB_PREFIX."proposals.sales_hash".($sql ? " 
									WHERE ".$sql : NULL)."
									GROUP BY ".DB_PREFIX."line_items.proposal_hash , ".DB_PREFIX."line_items.product_hash".($having ? " HAVING ".$having : NULL));
		while ($row = $this->db->fetch_assoc($result)) {
			if ($row['total_line_items'] > 0) 
				$this->results[$row['sales_hash']][$row['parent_proposal_hash']][] = $row;
		}
		$this->overhead_record = array();
		$this->commission_rule = array();
		
		$sys_config = new system_config($this->current_hash);
		if (is_array($this->results)) {
			reset($this->results);
			while (list($sales_hash,$proposal_array) = each($this->results)) {
				while (list($proposal_hash,$detail) = each($proposal_array)) {
					unset($overhead);
					$result = $this->db->query("SELECT `overhead_hash` , `type` 
												FROM `".DB_PREFIX."overhead_rules`
												WHERE `active` = 1 
												  AND (('".date("Y-m-d")."' BETWEEN `effective_date` AND `expiration_date`) OR (`effective_date` = '' AND `expiration_date` = '') OR (`effective_date` != '' AND ".date("Y-m-d")." >= `effective_date`) OR (`expiration_date` != '' AND ".date("Y-m-d")." <= `expiration_date`))
												  AND ((`type` = 'C' AND `customer_hash` = '".$detail[0]['customer_hash']."') ".($detail[0]['gsa'] ? "
													  OR `type` = 'G'" : NULL)."
														   OR `type` = 'D')");
					while ($row = $this->db->fetch_assoc($result))
						$overhead[$row['type']] = $row;
						
					if ($overhead['C']) 
						$overhead_hash = $overhead['C']['overhead_hash'];
					elseif ($overhead['G']) 
						$overhead_hash = $overhead['G']['overhead_hash'];
					elseif ($overhead['D']) 
						$overhead_hash = $overhead['D']['overhead_hash'];
	
					if ($overhead_hash) {
						if (!$this->overhead_record[$overhead_hash]) {
							$sys_config->fetch_overhead_record($overhead_record);
							$this->overhead_record[$overhead_record] = $sys_config->current_overhead;
						}
						
						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$this->overhead_record[$overhead_record]['rate'],
																				'apply_to'	=>	$this->overhead_record[$overhead_record]['apply_to']);
					} elseif (defined('OVERHEAD_TYPE')) {
						$overhead_rate = (float)OVERHEAD_RATE;
						
						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$overhead_rate,
																				'apply_to'	=>	OVERHEAD_TYPE);
					}
					//Get any memo costs
					unset($memo);
					$result = $this->db->query("SELECT *
												FROM `".DB_PREFIX."memo_costs`
												WHERE `proposal_hash` = '$proposal_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$memo[] = $row;
						
					if ($memo)
						$this->results_misc[$proposal_hash]['MEMO'] = $memo;
					
					//Get any job costs
					unset($job_cost);
					$result = $this->db->query("SELECT *
												FROM `".DB_PREFIX."vendor_payable_expenses`
												WHERE `proposal_hash` = '$proposal_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$job_cost[] = $row;
					
					if ($job_cost)
						$this->results_misc[$proposal_hash]['JOB_COST'] = $job_cost;
						
				}
			}
		}
		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		if ($local)
			return true;
		else
			$this->content['html']['place_holder'] = $this->job_costing(1);
		return;
	}
	

	function job_costing($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => '', 'report_hash' => $this->report_hash))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Job Costing Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','job_costing','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:350px;text-align:left;padding-left:50px;\">Product</td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
				</tr>";
			$customers = new customers($this->current_hash);
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				reset($this->results);
				while (list($sales_hash,$proposal_array) = each($this->results)) {
					unset($inner_tbl);
					$sales_commission = $total_invoiced = $total_received = $total_sales_cost = $total_deposits = $k = 0;
					while (list($proposal_hash,$product_array) = each($proposal_array)) {
						$inner_tbl .= ($k > 0 ?"
						<tr>
							<td colspan=\"5\" style=\"background-color:#cccccc;\"></td>
						</tr>" : NULL)."
						<tr>
							<td colspan=\"5\" style=\"font-size:8pt;background-color:#ffffff;padding-left:25px;padding-top:5px;\">
								Proposal: <a href=\"?asdf\" target=\"_blank\" class=\"link_standard\">".$product_array[0]['proposal_no']."</a> - ".$product_array[0]['proposal_descr']."
								<div style=\"padding-top:5px;\">".$product_array[0]['customer_name']."</div>
							</td>
						</tr>";
						$k++;
						$total_sell = $total_cost = $total_profit = 0;
						for ($i = 0; $i < count($product_array); $i++) {
							$inner_tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".($product_array[$i]['product_name'] ? $product_array[$i]['product_name'] : "Miscellaneous")."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($product_array[$i]['total_product_sell'],2)."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($product_array[$i]['total_product_cost'],2)."</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;".($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost'] < 0 ? "color:#ff0000;" : NULL)."\">".($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost']  < 0 ? "
									($".number_format(($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost']) * -1,2).")" : "$".number_format($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost'],2))."
								</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;".(defined('MARGIN_FLAG') && math::gp_margin($product_array[$i]['total_product_cost'],$product_array[$i]['total_product_sell']) < MARGIN_FLAG ? "color:red;" : NULL)."\">".
									(math::gp_margin($product_array[$i]['total_product_cost'],$product_array[$i]['total_product_sell']) * 100)."%
								</td>
							</tr>";
							$total_sell += $product_array[$i]['total_product_sell'];
							$total_cost += $product_array[$i]['total_product_cost'];
						}
						if ($this->results_misc[$proposal_hash]['OVERHEAD'] && $this->results_misc[$proposal_hash]['OVERHEAD']['rate']) {
							if ($this->results_misc[$proposal_hash]['OVERHEAD']['apply_to'] == 'C') 
								$overhead_factor = _round($total_cost * $this->results_misc[$proposal_hash]['OVERHEAD']['rate'],2);
							elseif ($this->results_misc[$proposal_hash]['OVERHEAD']['apply_to'] == 'S') 
								$overhead_factor = _round($total_sell * $this->results_misc[$proposal_hash]['OVERHEAD']['rate'],2);

							$inner_tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">Company Overhead Factor</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($overhead_factor,2)."</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
							</tr>";
							$total_cost += $overhead_factor;
						}
						if ($this->results_misc[$proposal_hash]['MEMO']) {
							for ($i = 0; $i < count($this->results_misc[$proposal_hash]['MEMO']); $i++) {
								$inner_tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".(strlen($this->results_misc[$proposal_hash]['MEMO'][$i]['descr']) > 45 ? 
										substr($this->results_misc[$proposal_hash]['MEMO'][$i]['descr'],0,42)."..." : $this->results_misc[$proposal_hash]['MEMO'][$i]['descr'])."
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($this->results_misc[$proposal_hash]['MEMO'][$i]['amount'],2)."</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								</tr>";
								$total_cost += $this->results_misc[$proposal_hash]['MEMO'][$i]['amount'];
							}
						}
						if ($this->results_misc[$proposal_hash]['JOB_COST']) {
							for ($i = 0; $i < count($this->results_misc[$proposal_hash]['JOB_COST']); $i++) {
								$inner_tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".(strlen($this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo']) > 45 ? 
										substr($this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo'],0,42)."..." : $this->results_misc[$proposal_hash]['JOB_COST'][$i]['memo'])."
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($this->results_misc[$proposal_hash]['JOB_COST'][$i]['amount'],2)."</td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
									<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\"></td>
								</tr>";
								$total_cost += $this->results_misc[$proposal_hash]['JOB_COST'][$i]['amount'];
							}
						}

						$blended_gp = math::gp_margin($total_cost,$total_sell);
						$inner_tbl .= "							
						<tr >
							<td style=\"background-color:#ffffff;padding-left:50px;\"></td>
							<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_sell_".$proposal_hash."\">									
									$".number_format($total_sell,2)."
								</div>
							</td>
							<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_cost_".$proposal_hash."\">
									$".number_format($total_cost,2)."
								</div>
							</td>
							<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_profit_".$proposal_hash."\">".($total_sell - $total_cost < 0 ?
									"<span style=\"color:#ff0000;\">($".number_format(($total_sell - $total_cost) * -1,2).")</span>" : "$".number_format($total_sell - $total_cost,2))."
								</div>
							</td>
							<td class=\"num_field\" class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_gp_".$proposal_hash."\">". 
									(defined('MARGIN_FLAG') && math::gp_margin($total_cost,$total_sell) < MARGIN_FLAG ?
										"<span style=\"color:#ff0000;\">".($blended_gp * 100)."%</span>" : ($blended_gp * 100)."%")."
								</div>
							</td>
						</tr>
						<tr>
							<td style=\"padding-bottom:15px;padding-top:8px;background-color:#ffffff;font-size:8pt;padding-left:25px;\" colspan=\"5\">
								<div style=\"margin-bottom:5px;\" >
									Net Invoiced: <span id=\"net_invoiced_".$proposal_hash."\">$".number_format($product_array[0]['total_amount_invoiced'],2)."</span>
									&nbsp;&nbsp;
									Received: $".number_format($product_array[0]['total_amount_received'],2)."
								</div>
							</td>
						</tr>";
						
						$total_invoiced += $total_sell;
						$total_received += $product_array[0]['total_amount_received'];
						$sales_commission += ($com_due - $product_array[0]['previous_commission_paid']);
						$total_sales_cost += $total_cost;
					}
					if ($inner_tbl) {
						$tbl .= "
						<tr style=\"background-color:#efefef;\">
							<td style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".$this->user_name($sales_hash)."</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Sell</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Cost</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>
						</tr>"
						. $inner_tbl;
						$sales_commission_array[$sales_hash] = array('full_name'			=>	$this->user_name($sales_hash),
																     'total_invoiced' 	    =>	$total_invoiced,
																     'total_received'		=>  $total_received,
																     'total_cost'			=>	$total_sales_cost,
																     'total_profit'			=>  ($total_invoiced - $total_cost),
																     'total_commission'		=>  $sales_commission);
					}	
				}

				$tbl .= "
				<tr>
					<td style=\"background-color:#ffffff;\" colspan=\"5\">
						<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"width:100%;margin-top:0;\">
							<tr style=\"background-color:#efefef;\">
								<td style=\"padding:5px;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\">Sales Rep</td>
								<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Net Invoiced</td>
								<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Received</td>
								<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Actual Cost</td>
								<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
								<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>

							</tr>";
						while (list($sales_hash,$sales_array) = each($sales_commission_array)) {
							$tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;\">".$sales_array['full_name']."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_invoiced_".$sales_hash."\">$".number_format($sales_array['total_invoiced'],2)."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_received_".$sales_hash."\">$".number_format($sales_array['total_received'],2)."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_cost_".$sales_hash."\">"."$".number_format($sales_array['total_cost'],2)."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_profit_".$sales_hash."\">".($sales_array['total_invoiced'] - $sales_array['total_cost'] < 0 ?
									"<span style=\"color:#ff0000;\">($".number_format(($sales_array['total_invoiced'] - $sales_array['total_cost']),2).")" : "$".number_format(($sales_array['total_invoiced'] - $sales_array['total_cost']),2))."
								</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_gp_".$sales_hash."\">".(defined('MARGIN_FLAG') && math::gp_margin($sales_array['total_cost'],$sales_array['total_invoiced']) < MARGIN_FLAG ? 
									"<span style=\"color:#ff0000;\">".(math::gp_margin($sales_array['total_cost'],$sales_array['total_invoiced']) * 100)."%</span>" : (math::gp_margin($sales_array['total_cost'],$sales_array['total_invoiced']) * 100)."%")."
								</td>
							</tr>";
							$total_net_invoiced += $sales_array['total_invoiced'];
							$total_net_received += $sales_array['total_received'];
							$total_net_cost += $sales_array['total_cost'];
							$total_net_deposits += $sales_array['total_deposits'];
						}
						$tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">&nbsp;</td>
								<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_invoiced\">
										$".number_format($total_net_invoiced,2)."
									</div>
								</td>
								<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_received\">
										$".number_format($total_net_received,2)."
									</div>
								</td>
								<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_cost\">
										$".number_format($total_net_cost,2)."
									</div>
								</td>
								<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_profit\">".($total_net_invoiced - $total_net_cost < 0 ? 
										"<span style=\"color:#ff0000;\">($".number_format($total_net_invoiced - $total_net_cost,2).")</span>" : "$".number_format($total_net_invoiced - $total_net_cost,2))."										
									</div>
								</td>
								<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
									<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_margin\">".(defined('MARGIN_FLAG') && math::gp_margin($total_net_cost,$total_net_invoiced) < MARGIN_FLAG ? 
										"<span style=\"color:#ff0000;\">".(math::gp_margin($total_net_cost,$total_net_invoiced) * 100)."%</span>" : (math::gp_margin($total_net_cost,$total_net_invoiced) * 100)."%")."										
									</div>
								</td>
							</tr>
						</table>
					</td>
				</tr>";
			} 
			if (!$this->results)
				$tbl .= "
				<tr>
					<td colspan=\"5\" style=\"padding:25px 0px 5px 5px;background-color:#ffffff;\">Your commission report is empty.</td>
				</tr>";
			
			$tbl .= "
			</table>".$this->form->close_form();
									
			return $tbl;
		} else {

			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_job_costing');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_job_costing','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Job Costing Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("Proposals Booked This Month",
																    	  "Proposals Invoiced This Month",
																    	  "Proposals Created This Month",
																    	  "Proposals Booked Last Month",
																          "Proposals Invoiced Last Month",
																    	  "Proposals Created Last Month",																    	  
																    	  "Proposals Booked This Quarter",
																    	  "Proposals Invoiced Quarter",
																    	  "Proposals Created Quarter",									    
																    	  "Proposals Booked Last Quarter",
																          "Proposals Invoiced Last Quarter",
																    	  "Proposals Created Last Quarter",
																    	  "Proposals Booked This Period",
																    	  "Proposals Invoiced This Period",
																    	  "Proposals Created Last Period",
																    	  "Proposals Booked This Year",
																    	  "Proposals Invoiced This Year",
																      	  "Proposals Created This Year",
																    	  "Proposals Booked Last Year",
																      	  "Proposals Invoiced Last Year",
																    	  "Proposals Created Last Year",
																    	  "Proposals Booked Within a specific date range",
																          "Proposals Invoiced Within a specific date range",
																    	  "Proposals Created Within a specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9,
																		  10,
																		  11,
																		  12,
																		  13,
																		  14,
																		  15,
																		  16,
																		  17,
																		  18,
																		  19,
																		  20,
																		  21,
																		  22,
																		  23,
																		  24),"onChange=if(this.options[this.selectedIndex].value==22||this.options[this.selectedIndex].value==23||this.options[this.selectedIndex].value==24){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 22 || $this->current_report['timeframe'] == 23 || $this->current_report['timeframe'] == 24 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 22 || $this->current_report['timeframe'] == 23 || $this->current_report['timeframe'] == 24 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]",$this->user_name,($this->current_report['sales_rep'] ? $this->current_report['sales_rep'] : ''),$this->user_hash,"multiple","blank=1","size=4","style=width:200px;")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=proposal",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'),'account_suggest');key_call('reports','proposal','proposal_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
												if (is_array($this->current_report['proposal_filter'])) {
													for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++) 
														$tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}

	function commissions_paid_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => '', 'report_hash' => $this->report_hash))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"5\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Commissions Paid Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','commissions_paid_report','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp; &nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=commissions_paid','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:350px;text-align:left;padding-left:50px;\">Product</td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;\" class=\"num_field\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
					<td style=\"width:125px;text-align:right;\"></td>
				</tr>";
			$customers = new customers($this->current_hash);
			$vendors = new vendors($this->current_hash);
			if (is_array($this->results)) {
				reset($this->results);
				while (list($sales_hash,$proposal_array) = each($this->results)) {
					unset($inner_tbl);
					$total_commission_paid = $grand_total_sell = $grand_total_cost = $k = 0;
					while (list($commission_hash,$product_array) = each($proposal_array)) {
						$comm_paid = 1;
						$inner_tbl .= ($k > 0 ?"
						<tr>
							<td colspan=\"5\" style=\"background-color:#cccccc;\"></td>
						</tr>" : NULL)."
						<tr>
							<td colspan=\"5\" style=\"font-size:8pt;background-color:#ffffff;padding-left:20px;padding-top:5px;\">
								&nbsp;
								Proposal: <a href=\"?asdf\" target=\"_blank\" class=\"link_standard\">".$product_array[0]['proposal_no']."</a> - ".$product_array[0]['proposal_descr']."
								<div style=\"padding-top:5px;padding-left:10px;\">".$product_array[0]['customer_name']."</div>
							</td>
						</tr>";
						$k++;
						$commission_paid = $total_sell = $total_cost = $total_profit = 0;
						for ($i = 0; $i < count($product_array); $i++) {
							$inner_tbl .= "
							<tr>
								<td style=\"font-size:8pt;background-color:#ffffff;padding-left:50px;\">".($product_array[$i]['product_name'] ? $product_array[$i]['product_name'] : "Miscellaneous")."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($product_array[$i]['total_product_sell'],2)."</td>
								<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">$".number_format($product_array[$i]['total_product_cost'],2)."</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;".($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost'] < 0 ? "color:#ff0000;" : NULL)."\">".($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost']  < 0 ? "
									($".number_format(($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost']) * -1,2).")" : "$".number_format($product_array[$i]['total_product_sell'] - $product_array[$i]['total_product_cost'],2))."
								</td>
								<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;".(defined('MARGIN_FLAG') && math::gp_margin($product_array[$i]['total_product_cost'],$product_array[$i]['total_product_sell']) < MARGIN_FLAG ? "color:red;" : NULL)."\">".
									(math::gp_margin($product_array[$i]['total_product_cost'],$product_array[$i]['total_product_sell']) * 100)."%
								</td>
							</tr>";
							$total_sell += $product_array[$i]['total_product_sell'];
							$total_cost += $product_array[$i]['total_product_cost'];
						}
						$commission_paid = $product_array[0]['amount'] + $product_array[0]['previous_amount'];
						$total_commission_paid += $commission_paid;
						$grand_total_sell += $total_sell;
						$grand_total_cost += $total_cost;
						$inner_tbl .= "							
						<tr >
							<td style=\"background-color:#ffffff;padding-left:50px;\"></td>
							<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
									$".number_format($total_sell,2)."
								</div>
							</td>
							<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
									$".number_format($total_cost,2)."
								</div>
							</td>
							<td class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".($total_sell - $total_cost < 0 ?
									"<span style=\"color:#ff0000;\">($".number_format(($total_sell - $total_cost) * -1,2).")</span>" : "$".number_format($total_sell - $total_cost,2))."
								</div>
							</td>
							<td class=\"num_field\" class=\"num_field\" style=\"font-size:8pt;background-color:#ffffff;\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">". 
									((defined('MARGIN_FLAG') && math::gp_margin($total_cost,$total_sell) < MARGIN_FLAG ?
										"<span style=\"color:#ff0000;\">".(math::gp_margin($total_cost,$total_sell) * 100)."%</span>" : (math::gp_margin($total_cost,$total_sell) * 100)."%"))."
								</div>
							</td>
						</tr>
						<tr>
							<td style=\"padding-bottom:15px;padding-top:8px;background-color:#ffffff;font-size:8pt;padding-left:25px;\" colspan=\"5\">
								<div style=\"margin-bottom:5px;\" >
									Total Commissions Paid: $".number_format($commission_paid,2)."
									<div style=\"padding-top:5px;\">
									Paid On: ".date(DATE_FORMAT,strtotime($product_array[0]['paid_date'])).($product_array[0]['paid_in_full'] ? "
										<span style=\"padding-left:5px;font-style:italic\">
											This commission is paid in full
										</span>" : NULL)."
									</div>
								</div>									
							</td>
						</tr>";
					}
					if ($inner_tbl) {
						$tbl .= "
						<tr style=\"background-color:#efefef;\">
							<td style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".$this->user_name($sales_hash)."</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Sell</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Cost</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">Profit</td>
							<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\" class=\"num_field\">GP Margin</td>
						</tr>"
						. $inner_tbl;
						$all_commission += $total_commission_paid;
						$sales_commission_array[$sales_hash] = array('full_name'			=>	$this->user_name($sales_hash),
																     'total_sell'			=>  $grand_total_sell,
																     'total_cost'			=>	$grand_total_cost,
																     'total_profit'			=>  ($total_sell - $total_cost),
																     'total_commission'		=>  $total_commission_paid);
					}
				}
				// Add totals for ticket #257
				if ($all_commission) {
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;\" colspan=\"5\">
							<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"width:100%;margin-top:0;\">
								<tr style=\"background-color:#efefef;\">
									<td style=\"padding:5px;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\">Sales Rep</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Total Sell</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Total Cost</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Total Profit</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Total GP Margin</td>
									<td style=\"vertical-align:bottom;font-size:8pt;font-weight:bold;border-bottom:1px solid #cccccc;\" class=\"num_field\">Total Commissions Paid</td>
								</tr>";
							while (list($sales_hash,$sales_array) = each($sales_commission_array)) {
								$tbl .= "
								<tr>
									<td style=\"font-size:8pt;background-color:#ffffff;\">".$this->form->hidden(array('sales_array['.$sales_hash.']' => 1)).$sales_array['full_name']."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_sell_".$sales_hash."\">$".number_format($sales_array['total_sell'],2)."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_cost_".$sales_hash."\">".$this->form->hidden(array('current_cost_'.$sales_hash => $sales_array['total_cost']))."$".number_format($sales_array['total_cost'],2)."</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_profit_".$sales_hash."\">".($sales_array['total_sell'] - $sales_array['total_cost'] < 0 ?
										"<span style=\"color:#ff0000;\">($".number_format(($sales_array['total_sell'] - $sales_array['total_cost']),2).")" : "$".number_format(($sales_array['total_sell'] - $sales_array['total_cost']),2))."
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_gp_".$sales_hash."\">".(defined('MARGIN_FLAG') && math::gp_margin($sales_array['total_cost'],$sales_array['total_sell']) < MARGIN_FLAG ? 
										"<span style=\"color:#ff0000;\">".(math::gp_margin($sales_array['total_cost'],$sales_array['total_sell']) * 100)."%</span>" : (math::gp_margin($sales_array['total_cost'],$sales_array['total_sell']) * 100)."%")."
									</td>
									<td style=\"font-size:8pt;background-color:#ffffff;\" class=\"num_field\" id=\"total_commission_".$sales_hash."\">
										".$this->form->hidden(array('current_commission_'.$sales_hash => $sales_array['total_commission']))."$".number_format($sales_array['total_commission'],2)."
									</td> 
								</tr>";
								$total_net_sell += $sales_array['total_sell'];
								$total_net_cost += $sales_array['total_cost'];
								$total_commission_paid += $sales_array['total_commission'];
							}
							$tbl .= "

								<tr>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\"></td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_sell\">
											$".number_format($total_net_sell,2)."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_cost\">
											$".number_format($total_net_cost,2)."
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_profit\">".($total_net_sell - $total_net_cost < 0 ? 
											"<span style=\"color:#ff0000;\">($".number_format($total_net_sell - $total_net_cost,2).")</span>" : "$".number_format($total_net_sell - $total_net_cost,2))."										
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_margin\">".(defined('MARGIN_FLAG') && math::gp_margin($total_net_cost,$total_net_sell) < MARGIN_FLAG ? 
											"<span style=\"color:#ff0000;\">".(math::gp_margin($total_net_cost,$total_net_sell) * 100)."%</span>" : (math::gp_margin($total_net_cost,$total_net_sell) * 100)."%")."										
										</div>
									</td>
									<td style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\" class=\"num_field\">
										<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"total_commission\">
											$".number_format($all_commission,2)."
										</div>
									</td>
								</tr>
							</table>
						</td>
					</tr>";				
				}
			} 
			if (!$this->results || !$comm_paid)
				$tbl .= "
				<tr>
					<td colspan=\"5\" style=\"padding:25px 0px 5px 5px;background-color:#ffffff;\">Your commission report is empty.</td>
				</tr>";
			
			$tbl .= "
			</table>".$this->form->close_form();
									
			return $tbl;
		} else {
			$action_out = array("commission at","no commission");
			$action_in = array(1,0);
			
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_commissions_paid_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_commission_report','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Commissions Paid Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9),"onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=proposal",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'),'account_suggest');key_call('reports','proposal','proposal_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
												if (is_array($this->current_report['proposal_filter'])) {
													for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++) 
														$tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]",$this->user_name,($this->current_report['sales_rep'] ? $this->current_report['sales_rep'] : ''),$this->user_hash,"multiple","blank=1","size=4","style=width:200px;")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	
	function doit_commissions_paid_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];

		if ($report_hash && $doit_print) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$sales_rep_match = $this->current_report['sales_rep'];
			$proposal_filter = $this->current_report['proposal_filter'];			
		} else {
			$timeframe = $_POST['timeframe'];
			$sales_rep_match = $_POST['sales_rep_match'];
			$proposal_filter = $_POST['proposal_filter'];			
		}
		
		if ($proposal_filter && !is_array($proposal_filter)) 
				$proposal_filter = array($proposal_filter);
		if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);		
		
		$save = $_POST['save'];
		$saved_cat = "commissions_paid_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
				
		if ($this->content['error'])
			return;
		
		if (is_array($proposal_filter) && count($proposal_filter)) {
			$proposal_filter = array_unique($proposal_filter);
			$proposal_filter = array_values($proposal_filter);
			array_walk($proposal_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."commissions_paid.proposal_hash IN (".implode(" , ",$proposal_filter).")";
			array_walk($proposal_filter,'strip_quotes');
		}
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."commissions_paid.user_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($sales_rep_match,'strip_quotes');
		}
		
		switch ($timeframe) {
			//This Month
			case 1:
			$this->report_date_start = date("Y-m-01");
			$this->report_date_end = date("Y-m-t");
			$sql_p[] = DB_PREFIX."commissions_paid.paid_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
			
			//Last Month
			case 2:
			$this->report_date_start = date("Y-m-01",strtotime(date("Y-m-d")." -1 month"));
			$this->report_date_end = date("Y-m-t",strtotime(date("Y-m-d")." -1 month"));
			$sql_p[] = DB_PREFIX."commissions_paid.paid_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//This Quarter
			case 3:
			list($this->report_date_start,$this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")),date("Y"));
			$sql_p[] = DB_PREFIX."commissions_paid.paid_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//Last Quarter
			case 4:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($this->report_date_start,$this->report_date_end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start,$this->report_date_end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."commissions_paid.paid_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//This Period
			case 5:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = DB_PREFIX."commissions_paid.paid_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//Last Period
			case 6:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = DB_PREFIX."commissions_paid.paid_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//This Year
			case 7:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t",strtotime(date("Y-".($month + 11)."-01")));
			$sql_p[] = DB_PREFIX."commissions_paid.paid_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
			
			//Last Year
			case 8:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t",strtotime(date($last_year."-".($month + 11)."-01")));
			$sql_p[] = DB_PREFIX."commissions_paid.paid_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//Specific Date
			case 9:
			$this->report_date_start = $sort_from_date;
			$this->report_date_end = $sort_to_date;
			$sql_p[] = DB_PREFIX."commissions_paid.paid_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
		}
		
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		
		$str = "timeframe=$timeframe|proposal_filter=".@implode("&",$proposal_filter)."|sales_rep=".@implode("&",$sales_rep_match);	

		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."commissions_paid.* , ".DB_PREFIX."proposals.proposal_hash as parent_proposal_hash , 
									".DB_PREFIX."proposals.proposal_no , ".DB_PREFIX."proposals.proposal_descr , ".DB_PREFIX."customers.customer_name , 
									".DB_PREFIX."vendor_products.product_name , ".DB_PREFIX."users.full_name ,
									(
										SELECT SUM(".DB_PREFIX."customer_invoice.amount - ".DB_PREFIX."customer_invoice.balance)
										FROM `".DB_PREFIX."customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I'
									) AS total_amount_received ,
									(
										SELECT SUM(".DB_PREFIX."customer_invoice.amount)
										FROM `".DB_PREFIX."customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'D'
									) AS total_deposit_received ,
									(
										SELECT SUM(".DB_PREFIX."customer_invoice.amount) - SUM(".DB_PREFIX."customer_invoice.tax)
										FROM `".DB_PREFIX."customer_invoice`
										WHERE `proposal_hash` = parent_proposal_hash AND `type` = 'I'
									) AS total_amount_invoiced ,
									COUNT(".DB_PREFIX."line_items.invoice_hash) AS total_line_items ,
									(
									SELECT COUNT(*)
									FROM `".DB_PREFIX."line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND `invoice_hash` = ''
									) AS total_uninvoiced_lines ,
									".DB_PREFIX."vendor_products.product_name , ".DB_PREFIX."vendor_products.product_hash as parent_product_hash ,
									(
									SELECT SUM(".DB_PREFIX."line_items.cost * ".DB_PREFIX."line_items.qty)
									FROM `".DB_PREFIX."line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND 
									CASE
									WHEN ISNULL(parent_product_hash)
										THEN ISNULL(`product_hash`)
									ELSE `product_hash` = parent_product_hash
									END
									) AS total_product_cost , 
									(
									SELECT SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty)
									FROM `".DB_PREFIX."line_items`
									WHERE `proposal_hash` = parent_proposal_hash AND 
									CASE
									WHEN ISNULL(parent_product_hash)
										THEN ISNULL(`product_hash`)
									ELSE `product_hash` = parent_product_hash
									END
									) AS total_product_sell
									FROM `".DB_PREFIX."commissions_paid` 
									LEFT JOIN ".DB_PREFIX."proposals ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."commissions_paid.proposal_hash
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."proposals.customer_hash
									LEFT JOIN ".DB_PREFIX."line_items ON ".DB_PREFIX."line_items.commission_hash = ".DB_PREFIX."commissions_paid.commission_hash
									LEFT JOIN ".DB_PREFIX."vendor_products ON ".DB_PREFIX."vendor_products.product_hash = ".DB_PREFIX."line_items.product_hash
									LEFT JOIN ".DB_PREFIX."users ON ".DB_PREFIX."users.id_hash = ".DB_PREFIX."commissions_paid.user_hash".($sql ? "
									WHERE ".$sql : NULL)."
									GROUP BY ".DB_PREFIX."commissions_paid.commission_hash , ".DB_PREFIX."commissions_paid.proposal_hash , ".DB_PREFIX."line_items.product_hash");
		while ($row = $this->db->fetch_assoc($result)) {
			if ($row['total_line_items'] > 0) 
				$this->results[$row['user_hash']][$row['commission_hash']][] = $row;
		}
		
		/*
		$sys_config = new system_config($this->current_hash);
		if (is_array($this->results)) {
			reset($this->results);
			while (list($sales_hash,$proposal_array) = each($this->results)) {
				while (list($proposal_hash,$detail) = each($proposal_array)) {
					unset($overhead);
					$result = $this->db->query("SELECT `overhead_hash` , `type` 
												FROM `".DB_PREFIX."overhead_rules`
												WHERE `active` = 1 
												  AND (('".date("Y-m-d")."' BETWEEN `effective_date` AND `expiration_date`) OR (`effective_date` = '' AND `expiration_date` = '') OR (`effective_date` != '' AND ".date("Y-m-d")." >= `effective_date`) OR (`expiration_date` != '' AND ".date("Y-m-d")." <= `expiration_date`))
												  AND ((`type` = 'C' AND `customer_hash` = '".$detail[0]['customer_hash']."') ".($detail[0]['gsa'] ? "
													  OR `type` = 'G'" : NULL)."
														   OR `type` = 'D')");
					while ($row = $this->db->fetch_assoc($result))
						$overhead[$row['type']] = $row;
						
					if ($overhead['C']) 
						$overhead_hash = $overhead['C']['overhead_hash'];
					elseif ($overhead['G']) 
						$overhead_hash = $overhead['G']['overhead_hash'];
					elseif ($overhead['D']) 
						$overhead_hash = $overhead['D']['overhead_hash'];
	
					if ($overhead_hash) {
						if (!$this->overhead_record[$overhead_hash]) {
							$sys_config->fetch_overhead_record($overhead_record);
							$this->overhead_record[$overhead_record] = $sys_config->current_overhead;
						}
						
						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$this->overhead_record[$overhead_record]['rate'],
																				'apply_to'	=>	$this->overhead_record[$overhead_record]['apply_to']);
					} elseif (defined('OVERHEAD_TYPE')) {
						$overhead_rate = (float)OVERHEAD_RATE;
						
						$this->results_misc[$proposal_hash]['OVERHEAD'] = array('rate'		=>	$overhead_rate,
																				'apply_to'	=>	OVERHEAD_TYPE);
					}
					//Get any memo costs
					unset($memo);
					$result = $this->db->query("SELECT *
												FROM `".DB_PREFIX."memo_costs`
												WHERE `proposal_hash` = '$proposal_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$memo[] = $row;
						
					if ($memo)
						$this->results_misc[$proposal_hash]['MEMO'] = $memo;
					
					//Get any job costs
					unset($job_cost);
					$result = $this->db->query("SELECT *
												FROM `".DB_PREFIX."vendor_payable_expenses`
												WHERE `proposal_hash` = '$proposal_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$job_cost[] = $row;
					
					if ($job_cost)
						$this->results_misc[$proposal_hash]['JOB_COST'] = $job_cost;
						
					unset($com);
					//Get the commission
					$result = $this->db->query("SELECT `commission_hash` , `type`
												FROM `".DB_PREFIX."commission_tables`
												WHERE `active` = 1 
												  AND (('".date("Y-m-d")."' BETWEEN `effective_date` AND `expiration_date`) OR (`effective_date` = '' AND `expiration_date` = '') OR (`effective_date` != '' AND ".date("Y-m-d")." >= `effective_date`) OR (`expiration_date` != '' AND ".date("Y-m-d")." <= `expiration_date`))
												  AND ((`type` = 'C' AND `customer_hash` = '".$detail[0]['customer_hash']."') ".($detail[0]['gsa'] ? "
													  OR `type` = 'G'" : NULL).($detail[0]['user_commission'] ? "
														   OR (`type` = 'D' AND `commission_hash` = '".$detail[0]['user_commission']."')" : NULL).")");
					while ($row = $this->db->fetch_assoc($result))
						$com[$row['type']] = $row;
						
					if ($com['C']) {
						if (!$this->commission_rule[$com['C']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['C']['commission_hash']);
							$this->commission_rule[$com['C']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['C']['commission_hash']];
					} elseif ($com['G']) {
						if (!$this->commission_rule[$com['G']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['G']['commission_hash']);
							$this->commission_rule[$com['G']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['G']['commission_hash']];
					} elseif ($com['D']) {
						if (!$this->commission_rule[$com['D']['commission_hash']]) {
							$sys_config->fetch_commission_record($com['D']['commission_hash']);
							$this->commission_rule[$com['D']['commission_hash']] = $sys_config->current_commission;
						}
						$this->results_misc[$proposal_hash]['COMM'] = $this->commission_rule[$com['D']['commission_hash']];
					}
				}
			}
		}
		*/
		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		if ($local)
			return true;
		else
			$this->content['html']['place_holder'] = $this->commissions_paid_report(1);
		return;
	}

	function balance_sheet($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);	
			
			$tbl = "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" >
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Balance Sheet")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','balance_sheet','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<div style=\"margin-left:20px;margin-bottom:5px;margin-top:10px;\">
							<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=balance_sheet','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
						</div>
					</td>
				</tr>";
			$accounts = array('CA' => array(),
							  'FA' => array(),
							  'CL' => array(),
							  'LL' => array(),
							  'EQ' => array());
			$acct = new accounting($this->current_hash);
			$result = $this->db->query("SELECT ".DB_PREFIX."accounts.account_name , ".DB_PREFIX."accounts.account_no , ".DB_PREFIX."journal.account_hash , ".DB_PREFIX."account_types.type_code ,
										SUM(".DB_PREFIX."journal.debit) AS debit_total , SUM(".DB_PREFIX."journal.credit) AS credit_total
										FROM `".DB_PREFIX."journal`
										LEFT JOIN `".DB_PREFIX."accounts` ON ".DB_PREFIX."accounts.account_hash = ".DB_PREFIX."journal.account_hash
										LEFT JOIN `".DB_PREFIX."account_types` ON ".DB_PREFIX."account_types.type_code = ".DB_PREFIX."accounts.account_type
										WHERE ".DB_PREFIX."account_types.account_side = 'B' ".($this->current_report['sql'] ? 
											stripslashes($this->current_report['sql']) : NULL)."
										GROUP BY ".DB_PREFIX."journal.account_hash");
			while ($row = $this->db->fetch_assoc($result)) {
				$acct->fetch_account_record($row['account_hash']);
				if ($acct->current_account['account_action'] == 'DR') 
					$total = round($row['debit_total'] - $row['credit_total'],2);
				elseif ($acct->current_account['account_action'] == 'CR')  
					$total = round($row['credit_total'] - $row['debit_total'],2);
				
				$accounts[$row['type_code']][$row['account_hash']] = $row['account_name'];
				$account_detail[$acct->account_hash][0]['total'] = $total;
			}
			if ($this->compare) {
				$date = $this->report_date;
				for ($i = 1; $i <= $this->compare; $i++) {
					switch ($this->timeframe) {
						//To Date
						case '*':
						list($year,$month,$day) = explode("-",$date);
						$date = (--$year)."-".$month."-".$day;
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						
						break;
						
						//This Month
						case 1:
						list($year,$month,$day) = explode("-",$date);
						if ($month == 1) {
							$date = (--$year)."-12-".date("t",strtotime($year."-12-01"));
						} else
							$date = $year."-".(--$month)."-".date("t",strtotime($year."-".$month."-01"));
						
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
						
						//Last Month
						case 2:
						list($year,$month,$day) = explode("-",$date);
						if ($month == 1) {
							$date = (--$year)."-12-".date("t",strtotime($year."-12-01"));
						} else
							$date = $year."-".(--$month)."-".date("t",strtotime($year."-".$month."-01"));
						
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
			
						//This Quarter
						case 3:
						$current_qtr = get_quarter($date);
						if ($current_qtr == 1) {
							$previous_qtr = get_quarter(strtotime($date." -4 months"));
							list($start,$date) = get_quarter_dates($previous_qtr,date("Y",strtotime($date." -4 months")));
						} else
							list($start,$date) = get_quarter_dates($current_qtr - 1,date("Y",strtotime($date)));
						
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
			
						//Last Quarter
						case 4:
						$current_qtr = get_quarter($date);
						if ($current_qtr == 1) {
							$previous_qtr = get_quarter(strtotime($date." -4 months"));
							list($start,$date) = get_quarter_dates($previous_qtr,date("Y",strtotime($date." -4 months")));
						} else
							list($start,$date) = get_quarter_dates($current_qtr - 1,date("Y",strtotime($date)));
						
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
			
						//This Period
						case 5:
						$period_info = get_previous_period($date);
						if ($period_info['period_end']) {
							$date = $period_info['period_end'];
							$compare_date[] = $date;
							$sql = DB_PREFIX."journal.date < '".$date."'";
						}
						break;
						
						//Last Period
						case 6:
						$period_info = get_previous_period($date);
						if ($period_info['period_end']) {
							$date = $period_info['period_end'];
							$compare_date[] = $date;
							$sql = DB_PREFIX."journal.date < '".$date."'";
						}
						break;
						
						//This Year
						case 7:
						list($year,$month,$day) = explode("-",$date);
						$date = (--$year)."-".$month."-".date("t",strtotime($year."-".$month."-01"));
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
						
						//Last Year
						case 8:
						list($year,$month,$day) = explode("-",$date);
						$date = (--$year)."-".$month."-".date("t",strtotime($year."-".$month."-01"));
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
			
						//Specific Date
						case 9:
						list($year,$month,$day) = explode("-",$date);
						$year--;
						if ($day > date("t",strtotime($year."-".$month."-01")))
							$day = date("t",strtotime($year."-".$month."-01"));
						
						$date = $year."-".$month."-".$day;
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
					}
					$result = $this->db->query("SELECT ".DB_PREFIX."accounts.account_name , ".DB_PREFIX."accounts.account_no , ".DB_PREFIX."journal.account_hash , ".DB_PREFIX."account_types.type_code ,
												SUM(".DB_PREFIX."journal.debit) AS debit_total , SUM(".DB_PREFIX."journal.credit) AS credit_total
												FROM `".DB_PREFIX."journal`
												LEFT JOIN `".DB_PREFIX."accounts` ON ".DB_PREFIX."accounts.account_hash = ".DB_PREFIX."journal.account_hash
												LEFT JOIN `".DB_PREFIX."account_types` ON ".DB_PREFIX."account_types.type_code = ".DB_PREFIX."accounts.account_type
												WHERE ".DB_PREFIX."account_types.account_side = 'B' AND ".$sql."
												GROUP BY ".DB_PREFIX."journal.account_hash");
					while ($row = $this->db->fetch_assoc($result)) {
						$acct->fetch_account_record($row['account_hash']);
						if ($acct->current_account['account_action'] == 'DR') 
							$total = round($row['debit_total'] - $row['credit_total'],2);
						elseif ($acct->current_account['account_action'] == 'CR')  
							$total = round($row['credit_total'] - $row['debit_total'],2);
						
						$accounts[$row['type_code']][$row['account_hash']] = $row['account_name'];
						$account_detail[$acct->account_hash][$i]['total'] = $total;
					}
				}
			}
			if (is_array($accounts)) {
				if ($this->compare)
					$colspan = $this->compare + 2;
				else {
					$this->compare = 0;
					$colspan = 2;
				}
					
				$tbl .= "
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\">
						<div style=\"margin-bottom:8px;\">
						</div>
						<table style=\"background-color:#cccccc;\" cellpadding=\"5\" cellspacing=\"1\">
							<tr>
								<td style=\"text-align:center;width:500px;background-color:#efefef;\" colspan=\"".$colspan."\">
									<h4 style=\"margin-bottom:5px;color:#00477f;\">".(defined('MY_COMPANY_NAME') ? 
										MY_COMPANY_NAME : NULL).(!$this->compare ? "
										<div style=\"margin-top:8px;font-size:10px;\">As of ".date("F d, Y",strtotime($this->report_date))."</div>" : NULL)."
									</h4>
								</td>
							</tr>
							<tr>
								<td ".(!$this->compare ? "colspan=\"2\"" : NULL)." style=\"background-color:#ffffff;font-weight:bold;".(!$this->compare ? "width:250px;" : NULL)."\">Assets</td>";
							if ($this->compare) {
								for ($i = 0; $i <= $this->compare; $i++)
									$tbl .= "
									<td style=\"background-color:#ffffff;font-weight:bold;text-align:center;\">".($i == 0 ? 
										date("F d, Y",strtotime($this->report_date)) : date("F d, Y",strtotime($compare_date[$i-1])))."
									</td>";
							}
							$tbl .= "
							</tr>	
							<tr>
								<td style=\"background-color:#ffffff;\" colspan=\"".$colspan."\">Current Assets</td>
							</tr>";
						$ca =& $accounts['CA'];
						while (list($account_hash,$info) = each($ca)) {
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;\">".$info."</td>";
								for ($i = 0; $i <= $this->compare; $i++) {
									$total_ca[$i] += $account_detail[$account_hash][$i]['total'];
									$tbl .= "
									<td style=\"background-color:#ffffff;".($account_detail[$account_hash][$i]['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($account_detail[$account_hash][$i]['total'] < 0 ? 
										"($".number_format(($account_detail[$account_hash][$i]['total'] * -1),2).")" : "$".number_format($account_detail[$account_hash][$i]['total'],2))."
									</td>";
								}
								$tbl .= "
							</tr>";
						}
						$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;font-weight:bold;\">Total Current Assets</td>";
								for ($i = 0; $i <= $this->compare; $i++) 
									$tbl .= "
									<td style=\"background-color:#ffffff;font-weight:bold;".($total_ca[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_ca[$i] < 0 ? 
										"($".number_format(($total_ca[$i] * -1),2).")" : "$".number_format($total_ca[$i],2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#ffffff;padding-top:15px;\" colspan=\"".$colspan."\">Long Term Assets</td>
							</tr>";
						$fa =& $accounts['FA'];
						while (list($account_hash,$info) = each($fa)) {
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;\">".$info."</td>";
								for ($i = 0; $i <= $this->compare; $i++) {
									$total_fa[$i] += $account_detail[$account_hash][$i]['total'];
									$tbl .= "
									<td style=\"background-color:#ffffff;".($account_detail[$account_hash][$i]['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($account_detail[$account_hash][$i]['total'] < 0 ? 
										"($".number_format(($account_detail[$account_hash][$i]['total'] * -1),2).")" : "$".number_format($account_detail[$account_hash][$i]['total'],2))."
									</td>";
								}
								$tbl .= "
							</tr>";
						}
						$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;font-weight:bold;\">Total Long Term Assets</td>";
								for ($i = 0; $i <= $this->compare; $i++) 
									$tbl .= "
									<td style=\"background-color:#ffffff;font-weight:bold;".($total_fa[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_fa[$i] < 0 ? 
										"($".number_format(($total_fa[$i] * -1),2).")" : "$".number_format($total_fa[$i],2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#efefef;padding-top:25px;font-size:14px;font-weight:bold;\">Total Assets</td>";
								for ($i = 0; $i <= $this->compare; $i++) 
									$tbl .= "
									<td style=\"background-color:#efefef;font-weight:bold;padding-top:25px;font-size:14px;".($total_fa[$i] + $total_ca[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_fa[$i] + $total_ca[$i] < 0 ? 
										"($".number_format((($total_fa[$i] + $total_ca[$i]) * -1),2).")" : "$".number_format($total_fa[$i] + $total_ca[$i],2))."
									</td>";
								$tbl .= "
							</tr>					
							<tr>
								<td colspan=\"".$colspan."\" style=\"background-color:#ffffff;font-weight:bold;width:250px;padding-top:15px;\">Liabilities</td>
							</tr>	
							<tr>
								<td style=\"background-color:#ffffff;\" colspan=\"".$colspan."\">Current Liabilities</td>
							</tr>";
						$cl =& $accounts['CL'];
						while (list($account_hash,$info) = each($cl)) {
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;\">".$info."</td>";
								for ($i = 0; $i <= $this->compare; $i++) {
									$total_cl[$i] += $account_detail[$account_hash][$i]['total'];
									$tbl .= "
									<td style=\"background-color:#ffffff;".($account_detail[$account_hash][$i]['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($account_detail[$account_hash][$i]['total'] < 0 ? 
										"($".number_format(($account_detail[$account_hash][$i]['total'] * -1),2).")" : "$".number_format($account_detail[$account_hash][$i]['total'],2))."
									</td>";
								}
								$tbl .= "
							</tr>";
						}
						$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;font-weight:bold;\">Total Current Liabilities</td>";
								for ($i = 0; $i <= $this->compare; $i++) 
									$tbl .= "
									<td style=\"background-color:#ffffff;font-weight:bold;".($total_cl[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_cl[$i] < 0 ? 
										"($".number_format(($total_cl[$i] * -1),2).")" : "$".number_format($total_cl[$i],2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#ffffff;padding-top:15px;\" colspan=\"".$colspan."\">Long Term Liabilities</td>
							</tr>";
						$ll =& $accounts['LL'];
						while (list($account_hash,$info) = each($ll)) {
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;\">".$info."</td>";
								for ($i = 0; $i <= $this->compare; $i++) {
									$total_ll[$i] += $account_detail[$account_hash][$i]['total'];
									$tbl .= "
									<td style=\"background-color:#ffffff;".($account_detail[$account_hash][$i]['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($account_detail[$account_hash][$i]['total'] < 0 ? 
										"($".number_format(($account_detail[$account_hash][$i]['total'] * -1),2).")" : "$".number_format($account_detail[$account_hash][$i]['total'],2))."
									</td>";
								}
								$tbl .= "
							</tr>";
						}
						$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;font-weight:bold;\">Total Long Term Liabilities</td>";
								for ($i = 0; $i <= $this->compare; $i++) 
									$tbl .= "
									<td style=\"background-color:#ffffff;font-weight:bold;".($total_ll[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_ll[$i] < 0 ? 
										"($".number_format(($total_ll[$i] * -1),2).")" : "$".number_format($total_ll[$i],2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#efefef;padding-top:25px;font-size:14px;font-weight:bold;\">Total Liabilities</td>";
								for ($i = 0; $i <= $this->compare; $i++) 
									$tbl .= "
									<td style=\"background-color:#efefef;font-weight:bold;padding-top:25px;font-size:14px;".($total_cl[$i] + $total_ll[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_cl[$i] + $total_ll[$i] < 0 ? 
										"($".number_format((($total_cl[$i] + $total_ll[$i]) * -1),2).")" : "$".number_format($total_cl[$i] + $total_ll[$i],2))."
									</td>";
								$tbl .= "
							</tr>						
							<tr>
								<td style=\"background-color:#ffffff;font-weight:bold;width:250px;padding-top:15px;\" colspan=\"".$colspan."\">Shareholder's Equity</td>
							</tr>";
						$eq =& $accounts['EQ'];
						while (list($account_hash,$info) = each($eq)) {
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;padding-left:15px;\">".$info."</td>";
								for ($i = 0; $i <= $this->compare; $i++) {
									$total_eq[$i] += $account_detail[$account_hash][$i]['total'];
									$tbl .= "
									<td style=\"background-color:#ffffff;".($account_detail[$account_hash][$i]['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($account_detail[$account_hash][$i]['total'] < 0 ? 
										"($".number_format(($account_detail[$account_hash][$i]['total'] * -1),2).")" : "$".number_format($account_detail[$account_hash][$i]['total'],2))."
									</td>";
								}
								$tbl .= "
							</tr>";
						}
						$tbl .= "
							<tr>
								<td style=\"background-color:#efefef;padding-top:25px;font-size:14px;font-weight:bold;\">Total Shareholder's Equity</td>";
								for ($i = 0; $i <= $this->compare; $i++) 
									$tbl .= "
									<td style=\"background-color:#efefef;font-weight:bold;".($total_eq[$i] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_eq[$i] < 0 ? 
										"($".number_format(($total_eq[$i] * -1),2).")" : "$".number_format($total_eq[$i],2))."
									</td>";
								$tbl .= "
							</tr>
							<tr>
								<td style=\"background-color:#efefef;padding-top:25px;font-size:15px;font-weight:bold;\">Total Liabilities and Equity</td>";
								for ($i = 0; $i <= $this->compare; $i++) {
									$total_liab = $total_cl[$i] + $total_ll[$i] + $total_eq[$i];
									$tbl .= "
									<td style=\"background-color:#efefef;font-weight:bold;padding-top:25px;font-size:14px;".($total_liab < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_liab < 0 ? 
										"($".number_format(($total_liab * -1),2).")" : "$".number_format($total_liab,2))."
									</td>";
								}
								$tbl .= "
							</tr>
						</table>
					</td>
				</tr>";
			} else
				$tbl .= "
				<tr>
					<td colspan=\"6\" style=\"background-color:#ffffff;\">Your report returned no results.</td>
				</tr>";
			
			$tbl .= "
			</table>";						
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_balance_sheet');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_ar','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Balance Sheet")."
									</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("To Date",
																    	  "Through This Month",
																    	  "Through Last Month",
																    	  "Through This Quarter",
																    	  "Through Last Quarter",
																    	  "Through This Period",
																    	  "Through Last Period",
																    	  "Through This Year",
																    	  "Through Last Year",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array('*',
																		  1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9),"onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;Through:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Comparison: </td>
											<td style=\"background-color:#ffffff;vertical-align:top;padding-top:10px;\">".$this->form->select("compare",array("No Comparison","Compare Against Previous Cycle","Compare Against Previous 2 Cycles","Compare Against Previous 3 Cycles"),$this->current_report['compare'],array(0,1,2,3),"blank=1")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	
	function doit_balance_sheet() {
		$date = date("U") - 43200;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		
		if ($report_hash && $doit_print) {
			$this->fetch_report_settings($report_hash);
			
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 9) 
				$sort_to_date = $this->current_report['sort_to_date'];
		
			if ($compare = $this->current_report['compare'])
				$this->compare = $compare;				
		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 9) 
				$sort_to_date = $_POST['sort_to_date'];
		
			if ($compare = $_POST['compare'])
				$this->compare = $compare;			
		}

			
		$save = $_POST['save'];
		$saved_cat = "balance_sheet";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if ($timeframe == 9 && !$sort_to_date) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The date you specified is invalid! Please make sure you specify a date to report through.";
		}
		if ($this->content['error'])
			return;

		switch ($timeframe) {
			//To Date
			case '*':
			$this->report_date = date("Y-m-d");
			$sql_p[] = DB_PREFIX."journal.date < '".$this->report_date."'";
			break;
			
			//This Month
			case 1:
			$this->report_date = date("Y-m-t");
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date."'";
			break;
			
			//Last Month
			case 2:
			$this->report_date = date("Y-m-t",strtotime(date("Y-m-d")." -1 month"));
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date."'";
			break;

			//This Quarter
			case 3:
			list($start,$end) = get_quarter_dates(get_quarter(date("Y-m-d")),date("Y"));
			$this->report_date = $end;
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date."'";
			break;

			//Last Quarter
			case 4:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($start,$end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$this->report_date = $end;
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date."'";
			break;

			//This Period
			case 5:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_end']) {
				$this->report_date = $period_info['period_end'];
				$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//Last Period
			case 6:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_end']) {
				$this->report_date = $period_info['period_end'];
				$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//This Year
			case 7:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date = date("Y")."-".($month + 11)."-".date("t",strtotime(date("Y-".($month + 11)."-01")));
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date."'";
			break;
			
			//Last Year
			case 8:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date = $last_year."-".($month + 11)."-".date("t",strtotime(date($last_year."-".($month + 11)."-01")));
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date."'";
			break;

			//Specific Date
			case 9:
			$this->report_date = $sort_to_date;
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date."'";
			break;
		}
		$this->timeframe = $timeframe;
		
		if ($this->report_date)
			$method_vars['report_date'] = $this->report_date;
		
		if ($sql_p) 
			$sql = " AND ".implode(" AND ",$sql_p);
		
		$str = "timeframe=$timeframe|sort_to_date=$sort_to_date|compare=$compare";	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `sql` , `method_vars`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".addslashes($sql)."' , '".addslashes(serialize($method_vars))."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' , `sql` = '".addslashes($sql)."' , `method_vars` = '".addslashes(serialize($method_vars))."'
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		
		$this->report_hash = $report_hash;
		
		$this->content['action'] = 'close';
		$this->content['html']['place_holder'] = $this->balance_sheet(1);
		return;
	}
	
	function print_it() {
		$popup_id = ($this->ajax_vars['popup_id'] ? $this->ajax_vars['popup_id'] : $_POST['popup_id']);
		$this->popup_id = $this->content['popup_controls']['popup_id'] = ($popup_id ? $popup_id : 'popup_win'.rand(500,50000));
		$this->content['popup_controls']['popup_title'] = "Print Reports";
		$report_hash = $this->ajax_vars['report_hash'];
		$type = $this->ajax_vars['type'];
		
		$tbl .= "
			<div style=\"background-color:#ffffff;width:100%;height:100%;margin:0;text-align:left;\">
				<div id=\"loading".$this->popup_id."\" style=\"width:100%;padding-top:50px;padding-bottom:45px;text-align:center;\">
					<h3 style=\"color:#00477f;margin-bottom:5px;display:block;\" id=\"link_fetch".$this->popup_id."\">Loading Document...</h3>
					<div id=\"link_img_holder".$this->popup_id."\" style=\"display:block;\"><img src=\"images/file_loading.gif\" /></div>
				</div>
				<iframe src=\"print.php?t=".base64_encode($type)."&h=".$report_hash."\" width=\"98%\" height=\"100%\" style=\"z-index:100;display:none;\" onReadyStateChange=\"if(this.readyState == 4 || this.readyState == 'complete'){toggle_display('loading".$this->popup_id."','none');this.style.display='block'}\"></iframe> 
				<div style=\"padding-top:10px;text-align:left;\">
					<small>[<a href=\"print.php?t=".base64_encode($type)."&h=".$report_hash."\" target=\"_blank\" class=\"link_standard\">Open in a separate window</a>]</small>
				</div>
			</div>";
		
		$this->content['popup_controls']["cmdTable"] = $tbl;		
	}
	/**
	 * Creates the iframe for exporting reports and lists to excel.  Updated for #265 to allow a search hash.
	 *
	 */
	function print_it_xls() {
		$report_hash = $this->ajax_vars['report_hash'];
		$type = $this->ajax_vars['type'];
		$title = $this->ajax_vars['title'];
		$active_search = $this->ajax_vars['active_search'];
		$this->popup_id = $this->content['popup_controls']['popup_id'] = ($this->ajax_vars['popup_id'] ? $this->ajax_vars['popup_id'] : $_POST['popup_id']);
		$this->content['popup_controls']['popup_title'] = "Export ".($title ? $title : "Reports")." to Spreadsheet";
		
		$tbl .= "
		<div style=\"background-color:#ffffff;width:100%;height:100%;margin:0;text-align:left;\">

			<iframe src=\"xls_print.php?t=".base64_encode($type)."&h=".$report_hash."&s=$active_search\" width=\"98%\" height=\"100%\" style=\"z-index:100;display:none;\" ></iframe> 
			<div style=\"margin-bottom:5px;margin-left:10px;\">
			<br> Right click on the link below, click 'Save Target As' and select a location on your computer.<br><br> &nbsp;
				<a href=\"xls_print.php?t=".base64_encode($type)."&h=".$report_hash."&s=$active_search\" target=\"_blank\" class=\"link_standard\">Save ".($title ? $title : "Report")."</a>
			</div>
			<div style=\"padding-top:10px;text-align:left;\">
				<small>[<a href=\"xls_print.php?t=".base64_encode($type)."&h=".$report_hash."&s=$active_search\" target=\"_blank\" class=\"link_standard\">Open in a separate window</a>]</small>
			</div>
		</div>";
		$this->content['popup_controls']["cmdTable"] = $tbl;
	}	
	
	function check_reconcile($step=NULL) {
		$this->unlock("_");
		
		$result = $this->db->query("SELECT ".DB_PREFIX."check_register.check_no , ".DB_PREFIX."check_register.check_date , ".DB_PREFIX."check_register.amount ,
									".DB_PREFIX."check_register.memo , ".DB_PREFIX."customers.customer_name , ".DB_PREFIX."vendors.vendor_name 
							  		FROM `".DB_PREFIX."check_register`
									LEFT JOIN `".DB_PREFIX."customers` ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."check_register.payee
									LEFT JOIN `".DB_PREFIX."vendors` ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."check_register.payee
									WHERE ".DB_PREFIX."check_register.cleared = 0 AND ".DB_PREFIX."check_register.void = 0
							  		ORDER BY ".DB_PREFIX."check_register.check_no ASC");
		while ($row = $this->db->fetch_assoc($result))
			$check[] = $row;
			
		$this->content['jscript'][] = "
		var auto_save_timer = 0;
		var current_saved = true;
		auto_save = function() {
			if (auto_save_timer == 0) {
				auto_save_timer = window.setTimeout('doit_auto_save()',2000);
				current_saved = false;
			}
		}
		doit_auto_save = function() {
			auto_save_timer = 0;
			current_saved = true;
			submit_form($('test').form,'accounting','exec_post','refresh_form','action=doit_check_reg');
		}";

		$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1))."
		<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
			<tr>
				<td style=\"width:100%;background-color:#ffffff;padding:10px;\" >
					<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
						".($this->current_report['saved'] ? 
							$this->current_report['report_name'] : "Check Reconciliation Report")."
					</h3>
					<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
						<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
					</div>
				</td>
			</tr>
			<tr>
				<td style=\"width:100%;background-color:#ffffff;padding:10px;\">
					<table style=\"width:100%;\">
						<tr>
							<td style=\"font-weight:bold;width:20%;padding-bottom:5px;\">Check No.</td>
							<td style=\"font-weight:bold;width:20%;padding-bottom:5px;\">Check Date</td>
							<td style=\"font-weight:bold;width:40%;padding-bottom:5px;\">Payee</td>
							<td style=\"font-weight:bold;width:20%;padding-bottom:5px;\" class=\"num_field\">Amount</td>
							<td></td>
						</tr>";
					for ($i = 0; $i < count($check); $i++) {
						$tbl .= "
						<tr>
							<td>".$check[$i]['check_no']."</td>
							<td>".date(DATE_FORMAT,strtotime($check[$i]['check_date']))."</td>
							<td>".($check[$i]['customer_name'] ? 
								$check[$i]['customer_name'] : $check[$i]['vendor_name'])."
							</td>
							<td class=\"num_field\">$".number_format($check[$i]['amount'],2)."</td>
							<td id=\"cleared_".$check[$i]['check_no']."\">".$this->form->checkbox("name=cleared[".$check[$i]['check_no']."]","value=1","onClick=auto_save();")."</td>
						</tr>".($i < count($check) - 1 ? "
						<tr>
							<td colspan=\"5\" style=\"background-color:#cccccc;\"></td>
						</tr>" : NULL);
					}	
					$tbl .= "
					</table>
                </td>
            </tr>
		</table>".$this->form->close_form();						
								
		$this->content['html']['place_holder'] = $tbl;
	}
	
	function doit_customize() {
	
	}
	
	function customize() {
		$tbl = $this->form->form_tag().
		$this->form->hidden(array('test' => 1, 'popup_id' => $this->popup_id))."
		<div class=\"panel\">
			<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
				<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
					<p id=\"feedback_message".$this->popup_id."\"></p>
			</div>
			<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
				<tr>
					<td style=\"padding:0;\">
						 <div style=\"background-color:#ffffff;height:100%;\">
							<div style=\"margin:15px 35px;\">
								<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
									".$this->form->button("value=Save","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_customize');")."
								</div>
								<h3 style=\"margin-bottom:5px;color:#00477f;\"> 
									Customize Your Income Statement
								</h3>
								<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
									<tr>
										<td style=\"background-color:#ffffff;vertical-align:top;padding-top:10px;\">
											<div style=\"margin-top:15px;margin-left:5px;font-weight:bold;\">
										</td>
									</tr>
								</table>
							</div>
						</div>
					</td>
				</tr>
			</table>
		</div>".
		$this->form->close_form();

		$this->content['popup_controls']["cmdTable"] = $tbl;
		$this->content['popup_controls']['popup_title'] = "Customize Your Report";
		
		return;
	}

	function income_statement($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" >
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Income Statement")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','income_statement','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
								&nbsp;
								<!--
								[<small><a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','customize','report=income_statement','popup_id=customize_it');\">Customize Report</a></small>]
								-->
							</span>
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=income','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
						</div>
					</td>
				</tr>";
			/*
			if ($this->compare) {
				$date = $this->report_date;
				for ($i = 1; $i <= $this->compare; $i++) {
					switch ($this->timeframe) {
						//To Date
						case '*':
						list($year,$month,$day) = explode("-",$date);
						$date = (--$year)."-".$month."-".$day;
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						
						break;
						
						//This Month
						case 1:
						list($year,$month,$day) = explode("-",$date);
						if ($month == 1) {
							$date = (--$year)."-12-".date("t",strtotime($year."-12-01"));
						} else
							$date = $year."-".(--$month)."-".date("t",strtotime($year."-".$month."-01"));
						
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
						
						//Last Month
						case 2:
						list($year,$month,$day) = explode("-",$date);
						if ($month == 1) {
							$date = (--$year)."-12-".date("t",strtotime($year."-12-01"));
						} else
							$date = $year."-".(--$month)."-".date("t",strtotime($year."-".$month."-01"));
						
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
			
						//This Quarter
						case 3:
						$current_qtr = get_quarter($date);
						if ($current_qtr == 1) {
							$previous_qtr = get_quarter(date("Y-m-d",strtotime($date." -4 months")));
							list($start,$date) = get_quarter_dates($previous_qtr,date("Y",strtotime($date." -4 months")));
						} else
							list($start,$date) = get_quarter_dates($current_qtr - 1,date("Y"));
						
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
			
						//Last Quarter
						case 4:
						$current_qtr = get_quarter($date);
						if ($current_qtr == 1) {
							$previous_qtr = get_quarter(date("Y-m-d",strtotime($date." -4 months")));
							list($start,$date) = get_quarter_dates($previous_qtr,date("Y",strtotime($date." -4 months")));
						} else
							list($start,$date) = get_quarter_dates($current_qtr - 1,date("Y"));
						
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
			
						//This Period
						case 5:
						$period_info = get_previous_period($date);
						if ($period_info['period_end']) {
							$date = $period_info['period_end'];
							$compare_date[] = $date;
							$sql = DB_PREFIX."journal.date < '".$date."'";
						}
						break;
						
						//Last Period
						case 6:
						$period_info = get_previous_period($date);
						if ($period_info['period_end']) {
							$date = $period_info['period_end'];
							$compare_date[] = $date;
							$sql = DB_PREFIX."journal.date < '".$date."'";
						}
						break;
						
						//This Year
						case 7:
						list($year,$month,$day) = explode("-",$date);
						$date = (--$year)."-".$month."-".date("t",strtotime($year."-".$month."-01"));
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
						
						//Last Year
						case 8:
						list($year,$month,$day) = explode("-",$date);
						$date = (--$year)."-".$month."-".date("t",strtotime($year."-".$month."-01"));
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
			
						//Specific Date
						case 9:
						list($year,$month,$day) = explode("-",$date);
						$year--;
						if ($day > date("t",strtotime($year."-".$month."-01")))
							$day = date("t",strtotime($year."-".$month."-01"));
						
						$date = $year."-".$month."-".$day;
						$compare_date[] = $date;
						$sql = DB_PREFIX."journal.date < '".$date."'";
						break;
					}
					$result = $this->db->query("SELECT ".DB_PREFIX."accounts.account_name , ".DB_PREFIX."accounts.account_no , ".DB_PREFIX."journal.account_hash , ".DB_PREFIX."account_types.type_code ,
												SUM(".DB_PREFIX."journal.debit) AS debit_total , SUM(".DB_PREFIX."journal.credit) AS credit_total
												FROM `".DB_PREFIX."journal`
												LEFT JOIN `".DB_PREFIX."accounts` ON ".DB_PREFIX."accounts.account_hash = ".DB_PREFIX."journal.account_hash
												LEFT JOIN `".DB_PREFIX."account_types` ON ".DB_PREFIX."account_types.type_code = ".DB_PREFIX."accounts.account_type
												WHERE ".DB_PREFIX."account_types.account_side = 'B' AND ".$sql."
												GROUP BY ".DB_PREFIX."journal.account_hash");
					while ($row = $this->db->fetch_assoc($result)) {
						$acct->fetch_account_record($row['account_hash']);
						if ($acct->current_account['account_action'] == 'DR') 
							$total = round($row['debit_total'] - $row['credit_total'],2);
						elseif ($acct->current_account['account_action'] == 'CR')  
							$total = round($row['credit_total'] - $row['debit_total'],2);
						
						$accounts[$row['type_code']][$row['account_hash']] = $row['account_name'];
						$account_detail[$acct->account_hash][$i]['total'] = $total;
					}
				}
			}
			*/

			$accounts =& $this->accounts;
			if (is_array($accounts)) {
				$tbl .= "
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\">
						<table style=\"border:1px solid #cccccc;\" cellpadding=\"5\" cellspacing=\"0\">
							<tr>
								<td style=\"text-align:center;width:500px;background-color:#efefef;border-bottom:1px solid #cccccc;\" colspan=\"2\">
									<h4 style=\"margin-bottom:5px;color:#00477f;\">".(defined('MY_COMPANY_NAME') ? 
										MY_COMPANY_NAME : NULL)."
										<div style=\"margin-top:8px;font-size:10px;\">
											Income Statement
											<br />
											".($this->report_date_start ? date("F j, Y",strtotime($this->report_date_start))." - " : "Through ").date("F j, Y",strtotime($this->report_date_end))."
										</div>
									</h4>
								</td>
							</tr>
							<tr>
								<td style=\"background-color:#ffffff;font-weight:bold;\" colspan=\"2\">Income</td>
							</tr>";
						$in =& $accounts['IN'];
						$total_in = 0;
						while (list($account_hash,$info) = each($in)) {
							if ($info['total'] != 0 || $info['placeholder'] == 1) {
								$total_in += $info['total'];
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;padding-left:15px;\">".($info['account_no'] ? $info['account_no']." - " : NULL).$info['account_name']."</td>
									<td style=\"background-color:#ffffff;".($info['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($info['total'] < 0 ? 
										"($".number_format(($info['total'] * -1),2).")" : "$".number_format($info['total'],2))."
									</td>
								</tr>";
								// Display child accounts if any
								if ($this->child[$account_hash]) {
									$child_total = $info['total'];
									reset($this->child[$account_hash]);
									while (list($child_hash,$child_info) = each($this->child[$account_hash])) {
										if ($child_info['total'] != 0) {
											$total_in += $child_info['total'];
											$child_total += $child_info['total'];
											$tbl .= "
											<tr>
												<td style=\"background-color:#ffffff;padding-left:30px;\">".($child_info['account_no'] ? $child_info['account_no']." - " : NULL).$child_info['account_name']."</td>
												<td style=\"background-color:#ffffff;".($child_info['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($child_info['total'] < 0 ? 
													"($".number_format(($child_info['total'] * -1),2).")" : "$".number_format($child_info['total'],2))."
												</td>
											</tr>";
										}
									}
									$tbl .= "
									<tr>
										<td style=\"background-color:#ffffff;padding-left:15px;padding-bottom:10px;\">Total ".$info['account_name']."</td>
										<td style=\"background-color:#ffffff;padding-bottom:10px;".($info['total'] < 0 ? "color:#ff0000;" : NULL).($child_total != $info['total'] ? "border-top:1px dashed #000000;width:20%;" : NULL)."\" class=\"num_field\">".($child_total < 0 ? 
											"($".number_format(($child_total * -1),2).")" : "$".number_format($child_total,2))."										
										</td>
									</tr>";
								}
							}
						}
							$tbl .= "
							<tr>
								<td style=\"border-top:1px solid #cccccc;background-color:#efefef;padding-left:15px;font-weight:bold;\">Total Income</td>
								<td style=\"border-top:1px solid #cccccc;background-color:#efefef;font-weight:bold;".($total_in < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_in < 0 ? 
									"($".number_format(($total_in * -1),2).")" : "$".number_format($total_in,2))."
								</td>
							</tr>					
							<tr>
								<td colspan=\"2\" style=\"border-top:1px solid #cccccc;background-color:#ffffff;font-weight:bold;width:250px;padding-top:15px;\">Expenses</td>
							</tr>";
						$ex =& $accounts['EX'];
						$total_ex = 0;
						while (list($account_hash,$info) = each($ex)) {
							if ($info['total'] != 0 || $info['placeholder'] == 1) {
								$total_ex += $info['total'];
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;padding-left:15px;\">".($info['account_no'] ? $info['account_no']." - " : NULL).$info['account_name']."</td>
									<td style=\"background-color:#ffffff;".($info['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($info['total'] < 0 ? 
										"($".number_format(($info['total'] * -1),2).")" : "$".number_format($info['total'],2))."
									</td>
								</tr>";
								if ($this->child[$account_hash]) {
									$child_total = $info['total'];
									reset($this->child[$account_hash]);
									while (list($child_hash,$child_info) = each($this->child[$account_hash])) {
										if ($child_info['total'] != 0) {
											$child_total += $child_info['total'];
											$total_ex += $child_info['total'];
											$tbl .= "
											<tr>
												<td style=\"background-color:#ffffff;padding-left:30px;\">".($child_info['account_no'] ? $child_info['account_no']." - " : NULL).$child_info['account_name']."</td>
												<td style=\"background-color:#ffffff;".($child_info['total'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($child_info['total'] < 0 ? 
													"($".number_format(($child_info['total'] * -1),2).")" : "$".number_format($child_info['total'],2))."
												</td>
											</tr>";
										}
									}
									$tbl .= "
									<tr>
										<td style=\"background-color:#ffffff;padding-left:15px;padding-bottom:10px;\">Total ".$info['account_name']."</td>
										<td style=\"background-color:#ffffff;padding-bottom:10px;".($info['total'] < 0 ? "color:#ff0000;" : NULL).($child_total != $info['total'] ? "border-top:1px dashed #000000;width:20%;" : NULL)."\" class=\"num_field\">".($child_total < 0 ? 
											"($".number_format(($child_total * -1),2).")" : "$".number_format($child_total,2))."										
										</td>
									</tr>";
								}
							}
						}
						$grand_total = $total_in - $total_ex;
							
							$tbl .= "
							<tr>
								<td style=\"border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;padding-left:15px;font-weight:bold;\">Total Expenses</td>
								<td style=\"border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;font-weight:bold;".($total_ex < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_ex < 0 ? 
									"($".number_format(($total_ex * -1),2).")" : "$".number_format($total_ex,2))."
								</td>
							</tr>						
							<tr>
								<td style=\"padding-top:25px;font-size:15px;font-weight:bold;\">Net Income</td>
								<td style=\"font-weight:bold;padding-top:25px;font-size:15px;".($grand_total < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($grand_total < 0 ? 
									"($".number_format(($grand_total * -1),2).")" : "$".number_format($grand_total,2))."
								</td>
							</tr>
						</table>
					</td>
				</tr>";
			} 
			
			$tbl .= "
			</table>";						
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Run Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_income_statement');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_income_statement','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Income Statement")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("To Date",
																    	  "This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array('*',
																		  1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9),"onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<!--<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Comparison: </td>
											<td style=\"background-color:#ffffff;vertical-align:top;padding-top:10px;\">".$this->form->select("compare",array("No Comparison","Compare Against Previous Cycle","Compare Against Previous 2 Cycles","Compare Against Previous 3 Cycles"),$this->current_report['compare'],array(0,1,2,3),"blank=1")."</td>
										</tr>-->
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	
	function doit_income_statement($report_hash=NULL) {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		$from = $_POST['from'];
		$doit_print = $_POST['doit_print'];
		
		if ($from == 'download' || $doit_print) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
			$compare = $this->current_report['compare'];
			if ($timeframe == 9) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
		} else {
			$report_hash = $_POST['report_hash'];
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 9) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			
			if ($compare = $_POST['compare'])
				$this->compare = $compare;
		}
		$save = $_POST['save'];
		$saved_cat = "income_statement";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 9 && !$sort_from_date) || ($timeframe == 9 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
		}
		if ($this->content['error'])
			return;
			
		switch ($timeframe) {
			//To Date
			case '*':
			$this->report_date_end = date("Y-m-d");
			$sql_p[] = DB_PREFIX."journal.date < '".$this->report_date_end."'";
			break;
			
			//This Month
			case 1:
			$this->report_date_start = date("Y-m-01");
			$this->report_date_end = date("Y-m-t");
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
			
			//Last Month
			case 2:
			$this->report_date_start = date("Y-m-01",strtotime(date("Y-m-d")." -1 month"));
			$this->report_date_end = date("Y-m-t",strtotime(date("Y-m-d")." -1 month"));
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//This Quarter
			case 3:
			list($this->report_date_start,$this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")),date("Y"));
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//Last Quarter
			case 4:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$date) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start,$this->report_date_end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//This Period
			case 5:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//Last Period
			case 6:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//This Year
			case 7:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t",strtotime(date("Y-".($month + 11)."-01")));
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
			
			//Last Year
			case 8:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t",strtotime(date($last_year."-".($month + 11)."-01")));
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//Specific Date
			case 9:
			$this->report_date_start = $sort_from_date;
			$this->report_date_end = $sort_to_date;
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
		}
		
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		
		if ($from != 'download' && !$doit_print) {
			$str = "timeframe=$timeframe|compare=$compare|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date";	
			if (!$report_hash) {
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
					$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
					
				$this->db->query("INSERT INTO `".DB_PREFIX."reports`
								  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `sql`)
								  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".addslashes($sql)."')");
	
				if ($share && (count($group_share) || count($sales_rep_share))) {
					for ($i = 0; $i < count($group_share); $i++)
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."')");
					
					for ($i = 0; $i < count($sales_rep_share); $i++)
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
				}		
			} else {
				$existing = true;
				$this->db->query("UPDATE `".DB_PREFIX."reports`
								  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' , `sql` =  '".addslashes($sql)."'
								  WHERE `report_hash` = '$report_hash'");
			
				if (!$share)
					$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
									  WHERE `report_hash` = '".$this->report_hash."'");
				else {
					if (!is_array($sales_rep_share))
						$sales_rep_share = array();
					if (!is_array($group_share))
						$group_share = array();
						
					//Share or revoke to users
					$result = $this->db->query("SELECT `user_hash`
												FROM `".DB_PREFIX."reports_share`
												WHERE `report_hash` = '$report_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$current_share_users[] = $row['user_hash'];
						
					if (!is_array($current_share_users))
						$current_share_users = array();
						
					$to_remove = array_diff($current_share_users,$sales_rep_share);
					if (is_array($to_remove)) {
						while (list($i) = each($to_remove))
							$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
											  WHERE `user_hash` = '".$current_share_users[$i]."'");
					}
					$to_add = array_diff($sales_rep_share,$current_share_users);
					if (is_array($to_add)) {
						while (list($i) = each($to_add))
							$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
											  (`report_hash` , `user_hash`)
											  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
					}
	
					//Share or revoke to groups
					$result = $this->db->query("SELECT `group_hash`
												FROM `".DB_PREFIX."reports_share`
												WHERE `report_hash` = '$report_hash'");
					while ($row = $this->db->fetch_assoc($result))
						$current_share_groups[] = $row['group_hash'];
						
					if (!is_array($current_share_groups))
						$current_share_groups = array();
						
					$to_remove = array_diff($current_share_groups,$group_share);
					if (is_array($to_remove)) {
						while (list($i) = each($to_remove))
							$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
											  WHERE `group_hash` = '".$current_share_groups[$i]."'");
					}
					$to_add = array_diff($group_share,$current_share_groups);
					if (is_array($to_add)) {
						while (list($i) = each($to_add))
							$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
											  (`report_hash` , `group_hash`)
											  VALUES ('$report_hash' , '".$group_share[$i]."'");
					}
				}
			}
		}
		$accounts = array('EX' => array(),
						  'IN' => array(),
						  'CL' => array());
		$acct = new accounting($this->current_hash);
		$result = $this->db->query("SELECT ".DB_PREFIX."accounts.account_no , ".DB_PREFIX."accounts.account_name , ".DB_PREFIX."accounts.parent_hash , 
								   ".DB_PREFIX."accounts.account_no , ".DB_PREFIX."journal.account_hash , ".DB_PREFIX."account_types.type_code ,
									SUM(".DB_PREFIX."journal.debit) AS debit_total , SUM(".DB_PREFIX."journal.credit) AS credit_total
									FROM `".DB_PREFIX."journal`
									LEFT JOIN `".DB_PREFIX."accounts` ON ".DB_PREFIX."accounts.account_hash = ".DB_PREFIX."journal.account_hash
									LEFT JOIN `".DB_PREFIX."account_types` ON ".DB_PREFIX."account_types.type_code = ".DB_PREFIX."accounts.account_type
									WHERE ".DB_PREFIX."account_types.account_side = 'P'".($sql ? " AND ".$sql : NULL)."
									GROUP BY ".DB_PREFIX."journal.account_hash
									ORDER BY ".DB_PREFIX."accounts.account_no ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			$acct->fetch_account_record($row['account_hash']);
			if ($acct->current_account['account_action'] == 'DR') 
				$total = round($row['debit_total'] - $row['credit_total'],2);
			elseif ($acct->current_account['account_action'] == 'CR')  
				$total = round($row['credit_total'] - $row['debit_total'],2);
			
			if ($row['parent_hash']) 
				$child[$row['parent_hash']][$acct->account_hash] = array("account_name" => $row['account_name'],
																	     "account_no"	 => $row['account_no'],
																	     "total"		 => $total);
			else
				$accounts[$row['type_code']][$acct->account_hash] = array("account_name" => $row['account_name'],
																		  "account_no"	 => $row['account_no'],
																		  "total"		 => $total);
		}
		while (list($parent_hash,$child_hash) = each($child)) {
		    if (!$accounts['IN'][$parent_hash] && !$accounts['EX'][$parent_hash]) {
                $acct->fetch_account_record($parent_hash);
                $accounts[$acct->current_account['account_type']][$parent_hash] = array('account_name'  =>  $acct->current_account['account_name'],
                                                                                        'account_no'    =>  $acct->current_account['account_no'],
                                                                                        'placeholder'   =>  1,
                                                                                        'total'         =>  0);
		    }
		}		

		$this->accounts =& $accounts;
		$this->child =& $child;

		$this->report_hash = $report_hash;
		
		if ($from == 'download') 
			return;
		else {
			$this->content['action'] = 'close';
			$this->content['html']['place_holder'] = $this->income_statement(1);
		}
		return;
	}
	
	function trail_bal_details($local=NULL,$account_hash=NULL,$timeframe=NULL) {
		$account_hash = ($account_hash ? $account_hash : $this->ajax_vars['account_hash']);
		if (!$local) {
			$report_hash = $this->ajax_vars['report_hash'];
			$detail_date = $this->ajax_vars['detail_date'];
			$this->report_date_start = $this->ajax_vars['report_date_start'];
	        $this->report_date_end = $this->ajax_vars['report_date_end'];
	    		
			$detail_date_end = $this->ajax_vars['detail_date_end'];
		} else
            $report_hash = $this->report_hash;		  
		
		$accounting = new accounting($this->current_hash);
		$accounting->fetch_account_record($account_hash);
		$type = $accounting->current_account['account_action'];
		$account_name = ($accounting->current_account['account_no'] ? $accounting->current_account['account_no']." - " : NULL).$accounting->current_account['account_name'];
		unset($accounting);

		if (!$timeframe) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];
		}
		switch ($timeframe) {
			//To Date
			case '*':
			$this->report_date_end = date("Y-m-d");
			if (!$detail_date)
				$detail_date = date("Y-m-d",strtotime($this->report_date_end." -30 days"));
			else
				$detail_date = date("Y-m-d",strtotime($detail_date." -30 days"));
			
			$loop_date = $detail_date;
			$loop_total = 0;
			while (strtotime($loop_date) >= strtotime(defined('SYSTEM_START_DATE') ? SYSTEM_START_DATE : date("2007-m-d"))) {
				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM `".DB_PREFIX."journal`
											WHERE `account_hash` = '$account_hash' AND ".DB_PREFIX."journal.date BETWEEN '".$loop_date."' AND '".date("Y-m-d",strtotime($loop_date." +30 days"))."'
											GROUP BY ".DB_PREFIX."journal.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d",strtotime($loop_date." -30 days"));
				if ($loop_total >= 50)
					break;
			}
			if ($loop_total < 50) {
				unset($detail_date);
				$sql = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			} else
				$sql = DB_PREFIX."journal.date BETWEEN '".$detail_date."' AND '".$this->report_date_end."'";
			break;
			
			//Through This Month 
			case 1:
			$this->report_date_end = date("Y-m-t");
			if (!$detail_date)
				$detail_date = date("Y-m-01");
			else
				$detail_date = date("Y-m-d",strtotime($detail_date." -30 days"));

			$sql = DB_PREFIX."journal.date BETWEEN '".$detail_date."' AND '".$this->report_date_end."'";
			break;
			
			//Through Last Month
			case 3:
			$this->report_date_end = date("Y-m-t",strtotime(date("Y-m-d")." -1 month"));
			if (!$detail_date)
				$detail_date = date("Y-m-01",strtotime(date("Y-m-d")." -1 month"));
			else
				$detail_date = date("Y-m-d",strtotime($detail_date." -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while (strtotime($loop_date) >= strtotime(defined('SYSTEM_START_DATE') ? SYSTEM_START_DATE : date("2007-m-d"))) {
				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM `".DB_PREFIX."journal`
											WHERE `account_hash` = '$account_hash' AND ".DB_PREFIX."journal.date BETWEEN '".$loop_date."' AND '".date("Y-m-d",strtotime($loop_date." +30 days"))."'
											GROUP BY ".DB_PREFIX."journal.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d",strtotime($loop_date." -30 days"));
				if ($loop_total >= 50)
					break;
			}
			if ($loop_total < 50) {
				unset($detail_date);
				$sql = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			} else
				$sql = DB_PREFIX."journal.date BETWEEN '".$detail_date."' AND '".$this->report_date_end."'";
			break;

			//Through This Quarter
			case 5:
			list($this->report_date_start,$this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")),date("Y"));
			if (!$detail_date)
				$detail_date = $this->report_date_start;
			else
				$detail_date = date("Y-m-d",strtotime($detail_date." -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while (strtotime($loop_date) >= strtotime(defined('SYSTEM_START_DATE') ? SYSTEM_START_DATE : date("2007-m-d"))) {
				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM `".DB_PREFIX."journal`
											WHERE `account_hash` = '$account_hash' AND ".DB_PREFIX."journal.date BETWEEN '".$loop_date."' AND '".date("Y-m-d",strtotime($loop_date." +30 days"))."'
											GROUP BY ".DB_PREFIX."journal.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d",strtotime($loop_date." -30 days"));
				if ($loop_total >= 50)
					break;
			}
			if ($loop_total < 50) {
				unset($detail_date);
				$sql = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			} else
				$sql = DB_PREFIX."journal.date BETWEEN '".$detail_date."' AND '".$this->report_date_end."'";
			break;

			//Through Last Quarter
			case 7:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($report_date_start,$date) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($report_date_start,$this->report_date_end) = get_quarter_dates($current_qtr - 1,date("Y"));

			if (!$detail_date)
				$detail_date = $report_date_start;
			else
				$detail_date = date("Y-m-d",strtotime($detail_date." -30 days"));
			

			$loop_date = $detail_date;
			$loop_total = 0;
			while (strtotime($loop_date) >= strtotime(defined('SYSTEM_START_DATE') ? SYSTEM_START_DATE : date("2007-m-d"))) {
				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM `".DB_PREFIX."journal`
											WHERE `account_hash` = '$account_hash' AND ".DB_PREFIX."journal.date BETWEEN '".$loop_date."' AND '".date("Y-m-d",strtotime($loop_date." +30 days"))."'
											GROUP BY ".DB_PREFIX."journal.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d",strtotime($loop_date." -30 days"));
				if ($loop_total >= 50)
					break;
			}
			if ($loop_total < 50) {
				unset($detail_date);
				$sql = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			} else
				$sql = DB_PREFIX."journal.date BETWEEN '".$detail_date."' AND '".$this->report_date_end."'";
			break;

			//Through This Period
			case 9:
			$period_info = get_period_info(date("Y-m-d"));
			$report_date_start = $period_info['period_start'];
			$this->report_date_end = $period_info['period_end'];

			if (!$detail_date)
				$detail_date = $report_date_start;
			else
				$detail_date = date("Y-m-d",strtotime($detail_date." -30 days"));


			$loop_date = $detail_date;
			$loop_total = 0;
			while (strtotime($loop_date) >= strtotime(SYSTEM_START_DATE)) {
				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM `".DB_PREFIX."journal`
											WHERE `account_hash` = '$account_hash' AND ".DB_PREFIX."journal.date BETWEEN '".$loop_date."' AND '".date("Y-m-d",strtotime($loop_date." +30 days"))."'
											GROUP BY ".DB_PREFIX."journal.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d",strtotime($loop_date." -30 days"));
				if ($loop_total >= 50)
					break;
			}
			if ($loop_total < 50) {
				unset($detail_date);
				$sql = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			} else
				$sql = DB_PREFIX."journal.date BETWEEN '".$detail_date."' AND '".$this->report_date_end."'";
			break;
			
			//Through Last Period
			case 11:
			$period_info = get_previous_period(date("Y-m-d"));
			
			$report_date_start = $period_info['period_start'];
			$this->report_date_end = $period_info['period_end'];

			if (!$detail_date)
				$detail_date = $report_date_start;
			else
				$detail_date = date("Y-m-d",strtotime($detail_date." -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while (strtotime($loop_date) >= strtotime(SYSTEM_START_DATE)) {
				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM `".DB_PREFIX."journal`
											WHERE `account_hash` = '$account_hash' AND ".DB_PREFIX."journal.date BETWEEN '".$loop_date."' AND '".date("Y-m-d",strtotime($loop_date." +30 days"))."'
											GROUP BY ".DB_PREFIX."journal.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d",strtotime($loop_date." -30 days"));
				if ($loop_total >= 50)
					break;
			}
			if ($loop_total < 50) {
				unset($detail_date);
				$sql = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			} else
				$sql = DB_PREFIX."journal.date BETWEEN '".$detail_date."' AND '".$this->report_date_end."'";
			break;
			
			//Through This Year
			case 13:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t",strtotime(date("Y-".($month + 11)."-01")));

			if (!$detail_date)
				$detail_date = $report_date_start;
			else
				$detail_date = date("Y-m-d",strtotime($detail_date." -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while (strtotime($loop_date) >= strtotime(SYSTEM_START_DATE)) {
				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM `".DB_PREFIX."journal`
											WHERE `account_hash` = '$account_hash' AND ".DB_PREFIX."journal.date BETWEEN '".$loop_date."' AND '".date("Y-m-d",strtotime($loop_date." +30 days"))."'
											GROUP BY ".DB_PREFIX."journal.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d",strtotime($loop_date." -30 days"));
				if ($loop_total >= 50)
					break;
			}
			if ($loop_total < 50) {
				unset($detail_date);
				$sql = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			} else
				$sql = DB_PREFIX."journal.date BETWEEN '".$detail_date."' AND '".$this->report_date_end."'";
			break;
			
			//Through Last Year
			case 15:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t",strtotime(date($last_year."-".($month + 11)."-01")));

			if (!$detail_date)
				$detail_date = $report_date_start;
			else
				$detail_date = date("Y-m-d",strtotime($detail_date." -30 days"));

			$loop_date = $detail_date;
			$loop_total = 0;
			while (strtotime($loop_date) >= strtotime(SYSTEM_START_DATE)) {
				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM `".DB_PREFIX."journal`
											WHERE `account_hash` = '$account_hash' AND ".DB_PREFIX."journal.date BETWEEN '".$loop_date."' AND '".date("Y-m-d",strtotime($loop_date." +30 days"))."'
											GROUP BY ".DB_PREFIX."journal.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d",strtotime($loop_date." -30 days"));
				if ($loop_total >= 50)
					break;
			}
			if ($loop_total < 50) {
				unset($detail_date);
				$sql = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			} else
				$sql = DB_PREFIX."journal.date BETWEEN '".$detail_date."' AND '".$this->report_date_end."'";
			break;

			//Through Specific Date
			case 17:
			if (!$detail_date)
				$detail_date = date("Y-m-d",strtotime($this->report_date_end." -30 days"));
			else
				$detail_date = date("Y-m-d",strtotime($detail_date." -30 days"));
				
			$loop_date = $detail_date;
			$loop_total = 0;
			while (strtotime($loop_date) >= strtotime(SYSTEM_START_DATE)) {
				$result = $this->db->query("SELECT COUNT(*) AS Total
											FROM `".DB_PREFIX."journal`
											WHERE `account_hash` = '$account_hash' AND ".DB_PREFIX."journal.date BETWEEN '".$loop_date."' AND '".date("Y-m-d",strtotime($loop_date." +30 days"))."'
											GROUP BY ".DB_PREFIX."journal.audit_id");
				$loop_total += $this->db->num_rows($result);
				$loop_date = date("Y-m-d",strtotime($loop_date." -30 days"));
				if ($loop_total >= 50)
					break;
			}
			if ($loop_total < 50) {
				unset($detail_date);
				$sql = DB_PREFIX."journal.date <= '".($detail_date_end ? $detail_date_end : $this->report_date_end)."'";
			} else
				$sql = DB_PREFIX."journal.date BETWEEN '".$detail_date."' AND '".$this->report_date_end."'";
			break;
		
			//Selected Time Period Only, Not Through Date 
			case 2:
			case 4:
			case 6:
			case 8:
			case 10:
			case 12:
			case 14:
			case 16;
			case 18:
            unset($detail_date);
            $sql = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
		}
        if (is_array($this->current_report['customer_filter']) && count($this->current_report['customer_filter'])) {
            $customer_filter = array_unique($this->current_report['customer_filter']);
            $customer_filter = array_values($customer_filter);
            array_walk($customer_filter,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."journal.customer_hash IN (".implode(" , ",$customer_filter).")";
            array_walk($customer_filter,'strip_quotes');
        }                   
        if (is_array($this->current_report['proposal_filter']) && count($this->current_report['proposal_filter'])) {
            $proposal_filter = array_unique($this->current_report['proposal_filter']);
            $proposal_filter = array_values($proposal_filter);
            array_walk($proposal_filter,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."journal.proposal_hash IN (".implode(" , ",$proposal_filter).")";
            array_walk($proposal_filter,'strip_quotes');
        }  		
		
        if ($sql_p) {
            if ($sql)
                $sql .= " AND ".implode(" AND ",$sql_p);        	
        }
        
		//Get the opening balance, if one exists
		if ($detail_date)
			$sub_query = "(SELECT ".($type == 'DR' ? "SUM( ".DB_PREFIX."journal.debit ) - SUM( ".DB_PREFIX."journal.credit )" : "SUM( ".DB_PREFIX."journal.credit ) - SUM( ".DB_PREFIX."journal.debit )")." 
						   FROM `".DB_PREFIX."journal`
						   WHERE ".DB_PREFIX."journal.account_hash = '$account_hash' AND ".DB_PREFIX."journal.date <= '$detail_date') AS previous_balance";
					
        $result = $this->db->query("SELECT ".DB_PREFIX."journal.* , ".DB_PREFIX."accounts.account_name , ".DB_PREFIX."accounts.account_no ,
                                    CASE 
                                    WHEN !ISNULL(".DB_PREFIX."journal.proposal_hash)
                                        THEN (
                                                SELECT ".DB_PREFIX."proposals.proposal_no
                                                FROM `".DB_PREFIX."proposals`
                                                WHERE ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."journal.proposal_hash
                                            )
                                        ELSE NULL
                                    END AS `proposal_no` ,
                                    CASE 
                                    WHEN !ISNULL(".DB_PREFIX."journal.proposal_hash)
                                        THEN (
                                                SELECT ".DB_PREFIX."proposals.proposal_descr
                                                FROM `".DB_PREFIX."proposals`
                                                WHERE ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."journal.proposal_hash
                                            )
                                        ELSE NULL
                                    END AS `proposal_descr` ,   
                                    CASE 
                                    WHEN !ISNULL(".DB_PREFIX."journal.ar_invoice_hash)
                                        THEN (
                                                SELECT ".DB_PREFIX."customer_invoice.invoice_no
                                                FROM `".DB_PREFIX."customer_invoice`
                                                WHERE ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."journal.ar_invoice_hash
                                            )
                                        ELSE NULL
                                    END AS `ar_invoice_no` ,    
                                    CASE 
                                    WHEN !ISNULL(".DB_PREFIX."journal.ar_invoice_hash)
                                        THEN (
                                                SELECT COUNT(".DB_PREFIX."customer_invoice.obj_id)
                                                FROM `".DB_PREFIX."customer_invoice`
                                                WHERE ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."journal.ar_invoice_hash
                                            )
                                        ELSE NULL
                                    END AS `valid_ar` ,                                                                                                        
                                    CASE 
                                    WHEN !ISNULL(".DB_PREFIX."journal.ap_invoice_hash)
                                        THEN (
                                                SELECT ".DB_PREFIX."vendor_payables.invoice_no
                                                FROM `".DB_PREFIX."vendor_payables`
                                                WHERE ".DB_PREFIX."vendor_payables.invoice_hash = ".DB_PREFIX."journal.ap_invoice_hash
                                            )
                                        ELSE NULL
                                    END AS `ap_invoice_no` ,    
                                    CASE 
                                    WHEN !ISNULL(".DB_PREFIX."journal.ap_invoice_hash)
                                        THEN (
                                                SELECT COUNT(".DB_PREFIX."vendor_payables.obj_id)
                                                FROM `".DB_PREFIX."vendor_payables`
                                                WHERE ".DB_PREFIX."vendor_payables.invoice_hash = ".DB_PREFIX."journal.ap_invoice_hash
                                            )
                                        ELSE NULL
                                    END AS `valid_ap` ,                                        
                                    CASE 
                                    WHEN !ISNULL(".DB_PREFIX."journal.customer_hash) AND ".DB_PREFIX."journal.customer_hash != ''
                                        THEN (
                                                SELECT ".DB_PREFIX."customers.customer_name
                                                FROM `".DB_PREFIX."customers`
                                                WHERE ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."journal.customer_hash
                                            )
                                        ELSE 
                                            CASE
                                            WHEN !ISNULL(".DB_PREFIX."journal.ar_invoice_hash)
                                                THEN (
                                                        SELECT ".DB_PREFIX."customers.customer_name
                                                        FROM `".DB_PREFIX."customer_invoice`
                                                        LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."customer_invoice.customer_hash
                                                        WHERE ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."journal.ar_invoice_hash
                                                    )
                                                ELSE NULL
                                            END
                                    END AS `customer_name` ,
                                    CASE 
                                    WHEN !ISNULL(".DB_PREFIX."journal.vendor_hash) AND ".DB_PREFIX."journal.vendor_hash != ''
                                        THEN (
                                                SELECT ".DB_PREFIX."vendors.vendor_name
                                                FROM `".DB_PREFIX."vendors`
                                                WHERE ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."journal.vendor_hash
                                            )
                                        ELSE 
                                            CASE
                                            WHEN !ISNULL(".DB_PREFIX."journal.ap_invoice_hash)
                                                THEN (
                                                        SELECT ".DB_PREFIX."vendors.vendor_name
                                                        FROM `".DB_PREFIX."vendor_payables`
                                                        LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."vendor_payables.vendor_hash
                                                        WHERE ".DB_PREFIX."vendor_payables.invoice_hash = ".DB_PREFIX."journal.ap_invoice_hash
                                                    )
                                                ELSE NULL
                                            END                                                                                                                                                                                             
                                    END AS `vendor_name` ,  
                                    CASE 
                                    WHEN !ISNULL(".DB_PREFIX."journal.check_no)
                                        THEN (
                                                SELECT ".DB_PREFIX."check_register.check_no
                                                FROM `".DB_PREFIX."check_register`
                                                WHERE ".DB_PREFIX."check_register.check_no = ".DB_PREFIX."journal.check_no AND ".DB_PREFIX."check_register.audit_id = mod_journal.audit_id
                                            )
                                        ELSE NULL
                                    END AS `payment_check_no` ,
                                    CASE
                                    WHEN !ISNULL(".DB_PREFIX."journal.id_hash)
                                        THEN (
                                                SELECT ".DB_PREFIX."users.full_name
                                                FROM `".DB_PREFIX."users`
                                                WHERE ".DB_PREFIX."users.id_hash = ".DB_PREFIX."journal.id_hash
                                            )
                                        ELSE NULL
                                    END AS `full_name` ".($sub_query ? ", ".$sub_query : NULL)."                        
                                    FROM `".DB_PREFIX."journal`
                                    LEFT JOIN ".DB_PREFIX."accounts ON ".DB_PREFIX."accounts.account_hash = ".DB_PREFIX."journal.account_hash
                                    WHERE ".DB_PREFIX."journal.account_hash = '$account_hash'".($sql ? " AND ".$sql : NULL)."
                                    GROUP BY ".DB_PREFIX."journal.audit_id
                                    ORDER BY ".DB_PREFIX."journal.date ASC , ".DB_PREFIX."journal.obj_id ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			$i++;
			$debit = $credit = 0;
			$amount = $row['debit'] - $row['credit'];
			switch($type) {
				case 'DR':
				if ($amount > 0) 
					$debit = $amount;
				else 
					$credit = $amount * -1;
				break;
				
				case 'CR':
				if ($amount < 0) 
					$credit = $amount * -1;
				else 
					$debit = $amount;
				break;
			}
			switch ($row['trans_type']) {
				case 'AR':
				case 'CR':
				if ($row['ar_invoice_hash'] && $row['valid_ar'])
					$onClick = "onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','".($row['trans_type'] == 'AR' ? "edit_invoice" : "new_deposit")."','invoice_hash=".$row['ar_invoice_hash']."','popup_id=line_item');\"";
				
                if ($row['trans_type'] == 'AR')
                    $row['memo'] = str_replace("Customer Invoice: ","",$row['memo']);
                    
                if ($row['ar_invoice_no'] && !ereg($row['ar_invoice_no'],$row['memo']))
                    $row['memo'] .= "&nbsp;".$row['ar_invoice_no'];                
                
                $title = ($row['trans_type'] == 'CR' ? "Customer Receipt" : "Customer Invoice");
				break;
				
				case 'AP':
				case 'CD':
				if ($row['ap_invoice_hash'] && $row['valid_ap'])
					$onClick = "onClick=\"agent.call('payables','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$row['ap_invoice_hash']."','popup_id=line_item');\"";
					
                if ($row['ap_invoice_no'] && !ereg($row['ap_invoice_no'],$row['memo']))
                    $row['memo'] .= "&nbsp;".$row['ap_invoice_no'];                					
					
				$title = ($row['trans_type'] == 'CD' ? "Payment" : "Vendor Invoice");
				break;
				
				case 'ME':
				//if ($journal_info[$j]['record_hash'])
					//$onClick = "onClick=\"agent.call('proposals','sf_loadcontent','cf_loadcontent','edit_invoice','invoice_hash=".$journal_info[$j]['record_hash']."','popup_id=line_item');\"";
				$title = "Credit Memo";
				break;

				case 'GJ':
				//if ($journal_info[$j]['record_hash'])
					//$onClick = "onClick=\"agent.call('proposals','sf_loadcontent','cf_loadcontent','edit_invoice','invoice_hash=".$journal_info[$j]['record_hash']."','popup_id=line_item');\"";
				$title = "General Journal";
				break;
				
				case 'AD':
				$title = "Adjustment";
				break;
			}
				
			if ($i == 1 && $row['previous_balance']) {
				if(!$this->doit_print) { 
					$a = "
					<tr>
					    <td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;padding-left:20px;border-top:1px solid #cccccc;border-right:1px solid #cccccc;\">
                            <div style=\"width:369px;\">					    
	    					    <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','trail_bal_details','account_hash=".$account_hash."','report_hash=".$this->report_hash."','detail_date=".$detail_date."')\" title=\"Show more detail\">
	        					    Previous Balance
	        					</a> As Of ".date(DATE_FORMAT,strtotime($detail_date))."
	        				</div>
            			</td>
					    <td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;padding:1px;border-top:1px solid #cccccc;border-right:1px solid #cccccc;\" class=\"num_field\">
                            <div style=\"width:197px;\">					       
	    					    ".(($type == 'DR' && $row['previous_balance'] > 0) || ($type == 'CR' && $row['previous_balance'] < 0) ? 
	        					    "$".number_format(($row['previous_balance'] < 0 ? 
	                					($row['previous_balance'] * -1) : $row['previous_balance']),2) : "&nbsp;")."
                            </div>	                					
    					</td>
					    <td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;padding:1px;border-top:1px solid #cccccc;padding-right:5px;\" class=\"num_field\">
                            <div style=\"width:175px;\">					    
	    					    ".(($type == 'CR' && $row['previous_balance'] > 0) || ($type == 'DR' && $row['previous_balance'] < 0) ? 
	        					    "$".number_format(($row['previous_balance'] < 0 ? 
	                					($row['previous_balance'] * -1) : $row['previous_balance']),2) : "&nbsp;")."
                            </div>	                					
    					</td>   
					</tr>";
				} else {
					$a[] = "Previous Balance As Of ".date(DATE_FORMAT,strtotime($detail_date));
					$b[] = (($type == 'DR' && $row['previous_balance'] > 0) || ($type == 'CR' && $row['previous_balance'] < 0) ? "$".number_format(($row['previous_balance'] < 0 ? ($row['previous_balance'] * -1) : $row['previous_balance']),2) : "");
					$c[] = (($type == 'CR' && $row['previous_balance'] > 0) || ($type == 'DR' && $row['previous_balance'] < 0) ? "$".number_format(($row['previous_balance'] < 0 ? ($row['previous_balance'] * -1) : $row['previous_balance']),2) : "");
				}
			}
			
			if (!$this->doit_print) {
                $a .= "
                <tr>
                    <td style=\"font-size:8pt;padding-left:20px;border-top:1px solid #cccccc;border-right:1px solid #cccccc;\" class=\"white_bg\" ".($onClick ? "onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className='white_bg'\" $onClick " : NULL).">
						<div style=\"width:369px;\">
                            <div>						
	    						<span ".($row['full_name'] ? 
		                            "title=\"Created by ".stripslashes($row['full_name'])."\"" : NULL).">
	    	                            ".date(DATE_FORMAT,strtotime($row['date'])).($row['timestamp'] ? 
		                                "&nbsp;".date(TIMESTAMP_FORMAT,$row['timestamp']) : NULL)."&nbsp;
		                        </span>".
		                        ($title ? 
		                            $title : NULL)."
                            </div>".		                            
	                        ($row['customer_name'] || $row['vendor_name'] ? "
	                            <i>".($row['customer_name'] ? 
	                                stripslashes($row['customer_name']) : stripslashes($row['vendor_name']))."</i>".($row['memo'] ? 
                                        " - " : NULL) : NULL).
	                        ($row['memo'] ? 
	                            stripslashes($row['memo']) : NULL)."
                        </div>	                            
                    </td>
                    <td class=\"num_field\" style=\"background-color:#ffffff;font-size:8pt;padding-left:5px;border-top:1px solid #cccccc;border-right:1px solid #cccccc;vertical-align:bottom;\">
                        <div style=\"width:197px;\">
                            ".($debit > 0 ? "$".number_format($debit,2) : "&nbsp;")."
                        </div>
                    </td>
                    <td class=\"num_field\" style=\"vertical-align:bottom;background-color:#ffffff;font-size:8pt;padding-right:5px;border-top:1px solid #cccccc;\">
                        <div style=\"width:175px;\">                    
                            ".($credit > 0 ? "$".number_format($credit,2) : "&nbsp;")."
                        </div>
                    </td>
                </tr>";
			} else {
				$a[] = $title . " ". date(DATE_FORMAT,strtotime($row['date'])).($row['memo'] ? " - ".stripslashes($row['memo']) : NULL);
				$b[] = $debit;
				$c[] = $credit;
			}	 
			
		}

		if (!$this->doit_print) {
            $a = "
            <div style=\"width:830px;overflow-x:hidden;overflow-y:scroll;".($i > 10 ? "height:275px;" : NULL)."\">
            <table style=\"background-color:#cccccc;\" cellpadding=\"5\" cellspacing=\"0\">
                <tr>
                    <td style=\"background-color:#efefef;font-weight:bold;font-size:8pt;padding-left:20px;border-right:1px solid #cccccc;\">
                        <div style=\"width:385px;\">                    
	                        Reference
	                        <span style=\"margin-left:5px;font-style:italic;\">$account_name</span>
                        </div>
                    </td>
                    <td style=\"background-color:#efefef;font-weight:bold;font-size:8pt;padding-left:5px;border-right:1px solid #cccccc\" class=\"num_field\">
                        <div style=\"width:202px;\">
                            Debit
                        </div>                           
                    </td>
                    <td style=\"background-color:#efefef;font-weight:bold;font-size:8pt;border-right:1px solid #cccccc;padding-right:5px;\" class=\"num_field\">
                        <div style=\"width:185px;\">
                            Credits
                        </div>
                    </td>
                </tr>".($a ? 
                $a : "
                <tr>
                    <td style=\"background-color:#ffffff;font-size:8pt;padding-left:20px;border-top:1px solid #cccccc;border-right:1px solid #cccccc;\" colspan=\"3\">".($detail_date ? "<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','trail_bal_details','account_hash=".$account_hash."','report_hash=".$this->report_hash."','detail_date=".$detail_date."')\" title=\"Show more detail\">No Activity</a> As Of ".date(DATE_FORMAT,strtotime($detail_date)) : "No Activity")."</td>
                </tr>")."
                <tr>
                    <td style=\"background-color:#efefef;border-top:1px solid #cccccc;height:10px;\" colspan=\"3\"></td>
                </tr>
            </table>
            </div>";      
		} else {
			$par = $a;
			$deb = $b;
			$cre = $c;
		}
		
		if ($local) {
		    if ($this->doit_print)
			    return array($par,$deb,$cre);
			else
			    return array($a);
	    } else {
			$this->content['html']['detail_'.$account_hash] = $a;
			$this->content['jscript'] = array("toggle_display('detailtr_".$account_hash."','block');");
		}
		
		return;
	}

	function trial_balance($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" >
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Trial Balance")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','trial_balance','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
							<small ><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','trial_balance','popup_id=report_filter','show_print_options=1','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
							&nbsp;&nbsp;
							<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','trial_balance','popup_id=report_filter','show_xls_options=1','report_hash=".$this->report_hash."');\"><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>
						</div>
					</td>
				</tr>";
			$detail =& $this->detail;
			if (is_array($detail)) {
				$tbl .= "
				<tr>
					<td style=\"width:900px;background-color:#ffffff;padding:10px;\">
						<table style=\"background-color:#cccccc;width:800px;\" cellpadding=\"5\" cellspacing=\"1\">
							<tr>
								<td style=\"text-align:center;width:800px;background-color:#efefef;\" colspan=\"".($this->current_report['detail'] == 2 ? "5" : "3")."\">
									<h4 style=\"margin-bottom:5px;color:#00477f;\">".(defined('MY_COMPANY_NAME') ? 
										MY_COMPANY_NAME : NULL)."
										<div style=\"margin-top:8px;font-size:10px;\">
											Trial Balance
											<br />".($this->report_date_start ? 
    											"Between Dates ".date(DATE_FORMAT,strtotime($this->report_date_start)). " and ".date(DATE_FORMAT,strtotime($this->report_date_end)) : "Through ".date(DATE_FORMAT,strtotime($this->report_date_end)))."
										</div>
									</h4>
								</td>
							</tr>
							<tr>
								<td style=\"background-color:#ffffff;\"><div style=\"width:400px\">&nbsp;</div></td>
								<td style=\"background-color:#ffffff;text-align:center;font-weight:bold;text-align:right;\"><div style=\"width:200px;\">Debit</div></td>
								<td style=\"background-color:#ffffff;text-align:center;font-weight:bold;text-align:right;\"><div style=\"width:200px;\">Credit</div></td>
							</tr>";
	
						for ($i = 0; $i < count($detail); $i++) {
							$debit = $credit = 0;
							if ($detail[$i]['account_hash'] && $detail[$i]['account_name'] && $detail[$i]['account_hash'] != DEFAULT_PROFIT_ACCT) {
								if (($detail[$i]['account_action'] == 'DR' && $detail[$i]['total'] > 0) || ($detail[$i]['account_action'] == 'CR' && $detail[$i]['total'] < 0)) {
									if ($detail[$i]['total'] < 0)
										$detail[$i]['total'] *= -1;
									
									$debit = $detail[$i]['total'];
									$debit_total += $debit;
								} elseif (($detail[$i]['account_action'] == 'CR' && $detail[$i]['total'] > 0) || ($detail[$i]['account_action'] == 'DR' && $detail[$i]['total'] < 0)) {
									if ($detail[$i]['total'] < 0)
										$detail[$i]['total'] *= -1;
									
									$credit = $detail[$i]['total'];
									$credit_total += $credit;
								}
								
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;font-weight:bold;\">
                                        <div style=\"width:400px;\">									   
										<a href=\"javascript:void(0);\" onClick=\"if(\$('detailtr_".$detail[$i]['account_hash']."').getStyle('display')=='block'){toggle_display('detailtr_".$detail[$i]['account_hash']."','none');\$('detail_".$detail[$i]['account_hash']."').innerHTML='';} else{agent.call('reports','sf_loadcontent','cf_loadcontent','trail_bal_details','account_hash=".$detail[$i]['account_hash']."','report_hash=".$this->report_hash."','report_date_start=".$this->report_date_start."','report_date_end=".$this->report_date_end."')}\" class=\"link_standard\" title=\"Show trial balance details for this account\">
										    ".($detail[$i]['account_no'] ? $detail[$i]['account_no']." - " : NULL).$detail[$i]['account_name']."
										</a>
									</td>
									<td style=\"background-color:#ffffff;\" class=\"num_field\">
                                        <div style=\"width:200px;\">".($debit > 0 ?
    										"$".number_format($debit,2) : "&nbsp;")."
                                        </div>    								
									</td>
									<td style=\"background-color:#ffffff;\" class=\"num_field\">
                                        <div style=\"width:200px;\">".($credit > 0 ?
    										"$".number_format($credit,2) : "&nbsp;")."
    									</div>
									</td>
								</tr>
								<tr style=\"display:".($this->current_report['detail'] == 2 ? "block" : "none")."\" id=\"detailtr_".$detail[$i]['account_hash']."\">
								    <td colspan=\"3\" style=\"padding:0;width:800px;\" id=\"detail_".$detail[$i]['account_hash']."\">".($this->current_report['detail'] == 2 ? 
        								$this->sub_detail[$detail[$i]['account_hash']] : NULL)."
        							</td>
								</tr>";
							}
						}
							$tbl .= "
							<tr>
								<td  style=\"background-color:#efefef;\"><div style=\"width:400px;\">&nbsp;</div></td>
								<td style=\"background-color:#efefef;font-weight:bold;padding-top:25px;font-size:14px;\" class=\"num_field\">
                                    <div style=\"width:200px;\">".($debit_total > 0 ? "
                                        $".number_format($debit_total,2) : "&nbsp;")."
                                    </div>
                                </td>
								<td style=\"background-color:#efefef;font-weight:bold;padding-top:25px;font-size:14px;\" class=\"num_field\">
								    <div style=\"width:200px;\">".($credit_total > 0 ? "
    								    $".number_format($credit_total,2) : NULL)."
    								</div>
        						</td>
							</tr>
						</table>
					</td>
				</tr>";
			} 
			
			$tbl .= "
			</table>";						
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$show_print_options = $this->ajax_vars['show_print_options'];
			$show_xls_options = $this->ajax_vars['show_xls_options'];
			
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
                $this->current_report['customer_filter'] = array($this->current_report['customer_filter']);			

            if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
                $this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);                
                
			$account_array[''] = "All Accounts";
            $r = $this->db->query("SELECT `account_no` , `account_name` , `account_hash`
                                   FROM `".DB_PREFIX."accounts`
                                   WHERE `account_hash` != '".DEFAULT_PROFIT_ACCT."'
                                   ORDER BY ".DB_PREFIX."accounts.account_no ASC");
            while ($row = $this->db->fetch_assoc($r))
                $account_array[$row['account_hash']] = ($row['account_no'] ? $row['account_no']." - " : NULL).$row['account_name'];			

			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".($show_print_options ? $this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_trial_balance','from_print_options=1');")
											 : ($show_xls_options ? $this->form->button("value=Export Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_trial_balance','from_xls_options=1');") 
											 		: $this->form->button("value=Run Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_trial_balance');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
													"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_trial_balance','rm=1');") : NULL)))."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Trial Balance")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("To Date",
																    	  "Through This Month",
																    	  "This Month Only",
																    	  "Through Last Month",
																    	  "Last Month Only",
																    	  "Through This Quarter",
																    	  "This Quarter Only",
																    	  "Through Last Quarter",
																    	  "Last Quarter Only",
																    	  "Through This Period",
																    	  "This Period Only",
																    	  "Through Last Period",
																    	  "Last Period Only",
																    	  "Through This Year",
																    	  "This Year Only",
																    	  "Through Last Year",
																    	  "Last Year Only",
																    	  "A Specific Date Range"),
																	$this->current_report['timeframe'],
																	array('*',1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18),
																	"onChange=if(this.options[this.selectedIndex].value==18){toggle_display('timeframe_holder','block');}else{toggle_display('timeframe_holder','none');}",
                                                                    "blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 18 ? "block" : "none").";\" id=\"timeframe_holder\">
												    <span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>												
												</div>
											</td>
										</tr>
										<tr>
										    <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be filtered to specific account(s)?</td>
										    <td style=\"background-color:#ffffff;\">
										        ".$this->form->select("account_filter[]",
																	   array_values($account_array),
																	   $this->current_report['account_filter'],
																	   array_keys($account_array),
																	   "multiple",
																	   "blank=1",
																	   "size=4",
																	   "style=width:300px;")."
										    </td>
										</tr>
										<tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Hide accounts with no activity?</td>
                                            <td style=\"background-color:#ffffff;\">	
                                                ".$this->form->checkbox("name=hide_empty",
																	    "value=1",
																	    ($this->current_report['hide_empty'] || !$this->current_report ? "checked" : NULL))."
                                            </td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=proposal",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'),'account_suggest');key_call('reports','proposal','proposal_hash',1);",
                                                                        "onBlur=vtobj.reset_keyResults();key_clear();"
                                                                        )."
                                                
                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
                                                if (is_array($this->current_report['proposal_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++) 
                                                        $tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer_vendor",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer_vendor','customer_hash',1);",
                                                                        "onBlur=vtobj.reset_keyResults();key_clear();"
                                                                        )."
                                                
                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
                                                if (is_array($this->current_report['customer_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
                                                        $tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;\">Show Detail? </td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("detail",array("Simple View","Detail View"),$this->current_report['detail'],array(1,2),"blank=1")."</td>
										</tr>".(!$show_print_options && !$show_xls_options ? "
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>" : NULL). "
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

            $jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 18 && $this->current_report['sort_from_date'] && $this->current_report['sort_from_date'] != '0000-00-00' ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
            $jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 18 && $this->current_report['sort_to_date'] && $this->current_report['sort_to_date'] != '0000-00-00' ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";			
			
			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	
	function doit_trial_balance() {
		
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		// Determine where this function call came from and set appropriate variables
		$report_hash = $_POST['report_hash'];
		$doit_print = $this->doit_print = $_POST['doit_print'];
		$from_print_options = $_POST['from_print_options'];
		$from_xls_options = $_POST['from_xls_options'];
		if ($from_xls_options || $from_print_options)
			$this->doit_print = 1;
			
		if ($report_hash && $doit_print) {
			$this->fetch_report_settings($report_hash);
			$account_filter = $this->current_report['account_filter']; 
			if ($account_filter && !is_array($account_filter))
			    $account_filter = array($account_filter);
			     
			$timeframe = $this->current_report['timeframe'];
			$detail = $this->current_report['detail'];
			$sort_to_date = $this->current_report['sort_to_date'];
			$sort_from_date = $this->current_report['sort_from_date'];
			$hide_empty = $this->current_report['hide_empty'];		

			$customer_filter = $this->current_report['customer_vendor_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);					
                			
			$proposal_filter = $this->current_report['proposal_filter'];
            if ($proposal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter);
                			
		} else {
			$timeframe = $_POST['timeframe'];
            $account_filter = $_POST['account_filter'];
            if ($account_filter && !is_array($account_filter))
                $account_filter = array($account_filter);

			$sort_to_date = $_POST['sort_to_date'];
			$sort_from_date = $_POST['sort_from_date'];
			$detail = $_POST['detail'];	
			$hide_empty = $_POST['hide_empty'];
			
            $customer_filter = $_POST['customer_vendor_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);
                            
            $proposal_filter = $_POST['proposal_filter'];
            if ($proposal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter);            			
		}
        
		if (count($account_filter) > 1 && $account_filter[0] == '')
            array_shift($account_filter);		
		elseif (count($account_filter) == 1 && $account_filter[0] == '')
            unset($account_filter);		  
			
		$save = $_POST['save'];
		$saved_cat = "trial_balance";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}

		if ($timeframe == 18 && ((!$sort_to_date && !$sort_from_date) || ($sort_to_date && $sort_from_date && strtotime($sort_from_date) >= strtotime($sort_to_date)))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The date range you specified is invalid! Please make sure you include a valid date range.";
		}
		if ($this->content['error'])
			return;
			
		switch ($timeframe) {
			//To Date
			case '*':
			$this->report_date_end = date("Y-m-d");
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			break;
			
			//Through This Month
			case 1:
			unset($this->report_date_start);
			$this->report_date_end = date("Y-m-t");
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			break;

			//This Month Only
			case 2:
			$this->report_date_start = date("Y-m-01");
			$this->report_date_end = date("Y-m-t");

			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			$sql_p2[] = DB_PREFIX."journal.date < '".$this->report_date_start."'";
			break;
			
			//Through Last Month
			case 3:
			unset($this->report_date_start);
			$this->report_date_end = date("Y-m-t",strtotime(date("Y-m-d")." -1 month"));
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			break;

			//Last Month Only
			case 4:
			$this->report_date_start = date("Y-m-01",strtotime(date("Y-m-d")." -1 month"));
			$this->report_date_end = date("Y-m-t",strtotime(date("Y-m-d")." -1 month"));
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			$sql_p2[] = DB_PREFIX."journal.date < '".$this->report_date_start."'";			
			break;
			
			
			//Through This Quarter
			case 5:
			list($this->report_date_start,$this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")),date("Y"));
			unset($this->report_date_start);
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			break;

			//This Quarter Only
			case 6:
			list($this->report_date_start,$this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")),date("Y"));
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			$sql_p2[] = DB_PREFIX."journal.date < '".$this->report_date_start."'";			
			break;			
			
			//Through Last Quarter
			case 7:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($this->report_date_start,$this->report_date_end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start,$this->report_date_end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			unset($this->report_date_start);
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			break;			

			//Last Quarter Only
			case 8:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($this->report_date_start,$this->report_date_end) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start,$this->report_date_end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			$sql_p2[] = DB_PREFIX."journal.date < '".$this->report_date_start."'";			
			break;			
			
			//Through This Period
			case 9:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				unset($this->report_date_start);
				$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//This Period Only
			case 10:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
				$sql_p2[] = DB_PREFIX."journal.date < '".$this->report_date_start."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}			
			break;			
			
			//Through Last Period
			case 11:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				unset($this->report_date_start);
				$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;

			//Last Period Only
			case 12:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {	
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
				$sql_p2[] = DB_PREFIX."journal.date < '".$this->report_date_start."'";			
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;			
			
			//Through This Year
			case 13:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t",strtotime(date("Y-".($month + 11)."-01")));
			unset($this->report_date_start);
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			break;

			//This Year Only
			case 14:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t",strtotime(date("Y-".($month + 11)."-01")));
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			$sql_p2[] = DB_PREFIX."journal.date < '".$this->report_date_start."'";			
			break;
			
			//Through Last Year
			case 15:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t",strtotime(date($last_year."-".($month + 11)."-01")));
			unset($this->report_date_start);
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
			break;

			//Last Year Only
			case 16:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t",strtotime(date($last_year."-".($month + 11)."-01")));
			$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			$sql_p2[] = DB_PREFIX."journal.date < '".$this->report_date_start."'";			
			break;
						
			//Through a Specific Date
			case 17:	
			$this->report_date_end = $sort_to_date;
			$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";		
			break;

			//A Specific Date Range
			case 18:
			$this->report_date_start = $sort_from_date;	
			$this->report_date_end = $sort_to_date;
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = DB_PREFIX."journal.date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$sql_p2[] = DB_PREFIX."journal.date <= '".$this->report_date_start."'";	
			} elseif ($sort_from_date && !$sort_to_date) {
				$sql_p[] = DB_PREFIX."journal.date >= '".$this->report_date_start."'";
				$sql_p2[] = DB_PREFIX."journal.date < '".$this->report_date_start."'";	
			} else {
				$sql_p[] = DB_PREFIX."journal.date <= '".$this->report_date_end."'";
				unset($this->report_date_start);
			}	
			break;
			
		}
		if ($account_filter && is_array($account_filter)) {
			array_walk($account_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."journal.account_hash IN (".implode(",",$account_filter).")";
			$sql_p2[] = DB_PREFIX."journal.account_hash IN (".implode(",",$account_filter).")";
			array_walk($account_filter,'strip_quotes'); 
		}		
        if (is_array($customer_filter) && count($customer_filter)) {
            $customer_filter = array_unique($customer_filter);
            $customer_filter = array_values($customer_filter);
            array_walk($customer_filter,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."journal.customer_hash IN (".implode(" , ",$customer_filter).")";
            array_walk($customer_filter,'strip_quotes');
        }              		

        if (is_array($proposal_filter) && count($proposal_filter)) {
            $proposal_filter = array_unique($proposal_filter);
            $proposal_filter = array_values($proposal_filter);
            array_walk($proposal_filter,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."journal.proposal_hash IN (".implode(" , ",$proposal_filter).")";
            array_walk($proposal_filter,'strip_quotes');
        }  

		
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		if ($sql_p2) 
			$sql2 = implode(" AND ",$sql_p2);	
		
		$str = "timeframe=$timeframe|detail=$detail|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|account_filter=".@implode("&",$account_filter)."|hide_empty=$hide_empty|customer_filter=".@implode("&",$customer_filter)."|vendor_filter=".@implode("&",$vendor_filter)."|proposal_filter=".@implode("&",$proposal_filter);
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str` , `sql`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str' , '".addslashes($sql)."')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' , `sql` = '".addslashes($sql)."'
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$acct = new accounting($this->current_hash);
		$result = $this->db->query("SELECT ".DB_PREFIX."accounts.account_name , ".DB_PREFIX."accounts.account_no , ".DB_PREFIX."journal.account_hash , 
									".DB_PREFIX."journal.audit_id , ".DB_PREFIX."journal.date , ".DB_PREFIX."journal.memo ,
									SUM(".DB_PREFIX."journal.debit) AS debit_total , SUM(".DB_PREFIX."journal.credit) AS credit_total
									FROM `".DB_PREFIX."journal`
									LEFT JOIN `".DB_PREFIX."accounts` ON ".DB_PREFIX."accounts.account_hash = ".DB_PREFIX."journal.account_hash".($sql ? "
									WHERE ".$sql : NULL)."										
									GROUP BY ".DB_PREFIX."journal.account_hash
									ORDER BY ".DB_PREFIX."accounts.account_no ASC");
		
		if ($sql2) {
				$result2 = $this->db->query("SELECT ".DB_PREFIX."accounts.account_name , ".DB_PREFIX."accounts.account_no , ".DB_PREFIX."journal.account_hash , 
											".DB_PREFIX."journal.audit_id , ".DB_PREFIX."journal.date , ".DB_PREFIX."journal.memo ,
											SUM(".DB_PREFIX."journal.debit) AS debit_total , SUM(".DB_PREFIX."journal.credit) AS credit_total
											FROM `".DB_PREFIX."journal`
											LEFT JOIN `".DB_PREFIX."accounts` ON ".DB_PREFIX."accounts.account_hash = ".DB_PREFIX."journal.account_hash".($sql ? "
											WHERE ".$sql2 : NULL)."										
											GROUP BY ".DB_PREFIX."journal.account_hash 
											ORDER BY ".DB_PREFIX."accounts.account_no ASC");		
				$open_bal = array();
				while ($row2 = $this->db->fetch_assoc($result2)) {
					$acct->fetch_account_record($row2['account_hash']);
					if ($acct->current_account['account_action'] == 'DR') 
						$open_bal[] = round($row2['debit_total'] - $row2['credit_total'],2);
					elseif ($acct->current_account['account_action'] == 'CR') 
						$open_bal[] = round($row2['credit_total'] - $row2['debit_total'],2);
				}
					
		}
		$i = 0;		
		$detail_sort = array();
		while ($row = $this->db->fetch_assoc($result)) {
			$acct->fetch_account_record($row['account_hash']);
			$total = 0;
			if ($acct->current_account['account_action'] == 'DR') 
				$total = round($row['debit_total'] - $row['credit_total'],2);
			elseif ($acct->current_account['account_action'] == 'CR') 
				$total = round($row['credit_total'] - $row['debit_total'],2);
			
			if (!$hide_empty)
    			$detail_sort[] = $row['account_no'];
    			
			$detail_array[$row['account_no']] = array("account_no"		    =>		$row['account_no'],
												      "account_name"		=>		$row['account_name'],
												      "account_hash"		=>		$row['account_hash'],
												      "audit_id"			=>		$row['audit_id'],
												      "date"				=>		$row['date'],
												      "memo"				=>		$row['memo'],
												      "total"				=>		$total,
													  "open_bal"			=>		($open_bal[$i] ? $open_bal[$i] : NULL),
												      "account_action"	    =>		$acct->current_account['account_action']);
			if ($detail == 2) {
				list($par) = $this->trail_bal_details(1,$row['account_hash'],$timeframe);
				$this->sub_detail[$row['account_hash']] = $par;
			}
			$i++;
		}		
		
		if (!$hide_empty) {
			$r = $this->db->query("SELECT ".DB_PREFIX."accounts.account_no , ".DB_PREFIX."accounts.account_name , ".DB_PREFIX."accounts.account_hash ,
			                       ".DB_PREFIX."account_types.account_type AS account_action
			                       FROM `".DB_PREFIX."accounts`
			                       LEFT JOIN `".DB_PREFIX."account_types` ON ".DB_PREFIX."account_types.type_code = ".DB_PREFIX."accounts.account_type
			                       ORDER BY ".DB_PREFIX."accounts.account_no ASC");
			while ($row = $this->db->fetch_assoc($r)) {
                if (((is_array($account_filter) && in_array($row['account_hash'],$account_filter)) || !is_array($account_filter)) && !in_array($row['account_no'],$detail_sort)) {
                    $detail_sort[] = $row['account_no'];
                    $detail_array[$row['account_no']] = array("account_no"      =>      $row['account_no'],
                                                              "account_name"    =>      $row['account_name'],
                                                              "account_hash"    =>      $row['account_hash'],
                                                              "account_action"  =>      $row['account_action']);                    
                }
			}
						
			$detail_sort = array_unique($detail_sort);
			sort($detail_sort);
			for ($i = 0; $i < count($detail_sort); $i++) 
                $this->detail[] = $detail_array[$detail_sort[$i]];				
			
		} else {
			while (list($acct_no,$acct_ar) = each($detail_array))
                $this->detail[] = $acct_ar;			
	
		}
        unset($detail_array); 
            
		if ($doit_print)
			return;
		if ($from_print_options) { 
			$this->content['action'] = 'close';
			$this->content['jscript'][] = "agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=trial_balance','report_hash=".$report_hash."','popup_id=print_win')";
			return;
		}
		if ($from_xls_options) {
			$this->content['action'] = 'close';
			$this->content['jscript'][] = "agent.call('reports','sf_loadcontent','show_popup_window','print_it_xls','type=trial_balance','report_hash=".$report_hash."','popup_id=xls_win')";			
			return;
		}
		
		$this->content['action'] = 'close';
		$this->content['html']['place_holder'] = $this->trial_balance(1);
		return;
	}

	function doit_backlog_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
				
		$report_hash = ($_POST['report_hash'] ? $_POST['report_hash'] : $this->ajax_vars['report_hash']);
        $limit_start = $this->ajax_vars['limit_start'];
        $total_rows = $this->ajax_vars['total_rows'];
		$doit_print = $_POST['doit_print'];
		
		if ($report_hash && ($doit_print || $limit_start)) {
			$this->fetch_report_settings($report_hash);
			
			$proposal_filter = $this->current_report['proposal_filter'];
			if ($prosal_filter && !is_array($proposal_filter))
				$proposal_filter = array($proposal_filter);
				
			$customer_filter = $this->current_report['customer_filter'];	
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
				
			$sales_rep_match = $this->current_report['sales_rep_match'];				
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);
				
            $designer_match = $this->current_report['designer_match'];
            if ($designer_match && !is_array($designer_match))
                $designer_match = array($designer_match);

            $sales_coord_match = $this->current_report['sales_coord_match'];
            if ($sales_coord_match && !is_array($sales_coord_match))
                $sales_coord_match = array($sales_coord_match);

            $proj_mngr_match = $this->current_report['proj_mngr_match'];
            if ($proj_mngr_match && !is_array($proj_mngr_match))
                $proj_mngr_match = array($proj_mngr_match);                
                				
			$report_detail = $this->current_report['report_detail'];
			$detail = $this->current_report['detail'];
		} else {
			$sales_rep_match = $_POST['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);
                
            $designer_match = $_POST['designer_match'];
            if ($designer_match && !is_array($designer_match))
                $designer_match = array($designer_match);

            $sales_coord_match = $_POST['sales_coord_match'];
            if ($sales_coord_match && !is_array($sales_coord_match))
                $sales_coord_match = array($sales_coord_match);

            $proj_mngr_match = $_POST['proj_mngr_match'];
            if ($proj_mngr_match && !is_array($proj_mngr_match))
                $proj_mngr_match = array($proj_mngr_match);
                
			$customer_filter = $_POST['customer_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);			
			
			$proposal_filter = $_POST['proposal_filter'];
            if ($proposal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter);
                			
			$report_detail = $_POST['report_detail'];
			$detail = $_POST['detail'];
			
			$save = $_POST['save'];
			$saved_cat = "backlog";
			$report_name = $_POST['report_name'];
			$report_descr = $_POST['report_descr'];
			$share = $_POST['share'];
			$sales_rep_share = $_POST['sales_rep_share'];
			$group_share = $_POST['group_share'];			
		}		
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if ($this->content['error'])
			return;
			
        if (@in_array("",$sales_rep_match) && count($sales_rep_match) > 1)
            unset($sales_rep_match[array_search("",$sales_rep_match)]);
        elseif (@in_array("",$sales_rep_match) && count($sales_rep_match) == 1)
            unset($sales_rep_match);        			
			
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			array_walk($sales_rep_match,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($sales_rep_match,'strip_quotes');
		}
		
        if (@in_array("",$sales_coord_match) && count($sales_coord_match) > 1)
            unset($sales_coord_match[array_search("",$sales_coord_match)]);
        elseif (@in_array("",$sales_coord_match) && count($sales_coord_match) == 1)
            unset($sales_coord_match);        		
		
	    if (is_array($sales_coord_match) && count($sales_coord_match)) {
            array_walk($sales_coord_match,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."proposals.sales_coord_hash IN (".implode(" , ",$sales_coord_match).")";
            array_walk($sales_coord_match,'strip_quotes');
        }

        if (@in_array("",$designer_match) && count($designer_match) > 1)
            unset($designer_match[array_search("",$designer_match)]);
        elseif (@in_array("",$designer_match) && count($designer_match) == 1)
            unset($designer_match);                
        
        if (is_array($designer_match) && count($designer_match)) {
            array_walk($designer_match,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."proposals.designer_hash IN (".implode(" , ",$designer_match).")";
            array_walk($designer_match,'strip_quotes');
        }        
        
        if (@in_array("",$proj_mngr_match) && count($proj_mngr_match) > 1)
            unset($proj_mngr_match[array_search("",$proj_mngr_match)]);
        elseif (@in_array("",$proj_mngr_match) && count($proj_mngr_match) == 1)
            unset($proj_mngr_match);                
        
        if (is_array($proj_mngr_match) && count($proj_mngr_match)) {
            array_walk($proj_mngr_match,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."proposals.proj_mngr_hash IN (".implode(" , ",$proj_mngr_match).")";
            array_walk($proj_mngr_match,'strip_quotes');
        }        

		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}

		if (is_array($proposal_filter) && count($proposal_filter)) {
			$proposal_filter = array_unique($proposal_filter);
			$proposal_filter = array_values($proposal_filter);
			array_walk($proposal_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.proposal_hash IN (".implode(" , ",$proposal_filter).")";
			array_walk($proposal_filter,'strip_quotes');
		}
		//Lines remaining to be invoiced
		if ($report_detail == 1) {
			$sql_p[] = DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.invoice_hash = '' AND ".DB_PREFIX."line_items.sell != 0";
		    $having_p[] = "proposal_fully_invoiced > 0 AND proposal_booked > 0";
		    $this->report_title = "Line items remaining to be invoiced";
		//Partially booked proposals, lines remaining to be booked
		} elseif ($report_detail == 2) {
			$sql_p[] = DB_PREFIX."line_items.po_hash = ''";
		    $having_p[] = "proposal_fully_invoiced > 0 AND proposal_booked > 0";
		    $this->report_title = "Proposals partially booked showing line items remaining to be booked";
		//Booked by not yet received
		} elseif ($report_detail == 3) {
			$sql_p[] = DB_PREFIX."line_items.po_hash != '' AND (ISNULL(".DB_PREFIX."line_items.receive_date) OR ".DB_PREFIX."line_items.receive_date = '')";
		    $having_p[] = "proposal_booked > 0";
		    $this->report_title = "Line items booked but not yet received";
		//Booked but not yet shipped
		} elseif ($report_detail == 4) {
			$sql_p[] = DB_PREFIX."line_items.po_hash != '' AND (ISNULL(".DB_PREFIX."line_items.ship_date) OR ".DB_PREFIX."line_items.ship_date = '')";
		    $having_p[] = "proposal_booked > 0";
		    $this->report_title = "Line items booked but not yet shipped";
		//Booked but not yet delivered
		} elseif ($report_detail == 5) {
			$sql_p[] = DB_PREFIX."line_items.po_hash != '' AND (ISNULL(".DB_PREFIX."line_items.deliver_date) OR ".DB_PREFIX."line_items.deliver_date = '')";
			$this->report_title = "Line items booked but not yet delivered";
        //Booked and received, but not yet invoiced	   
		} elseif ($report_detail == 6) {
			$sql_p[] = DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.invoice_hash = '' AND ".DB_PREFIX."line_items.sell != 0 AND !ISNULL(".DB_PREFIX."line_items.receive_date) AND ".DB_PREFIX."line_items.receive_date != ''";
		    $having_p[] = "proposal_booked > 0";
		    $this->report_title = "Line items booked and received but not yet invoiced";
		//Booked, shipped, not yet invoiced
		} elseif ($report_detail == 7) {
			$sql_p[] = DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.invoice_hash = '' AND ".DB_PREFIX."line_items.sell != 0 AND !ISNULL(".DB_PREFIX."line_items.ship_date) AND ".DB_PREFIX."line_items.ship_date != ''";
		    $having_p[] = "proposal_booked > 0";
		    $this->report_title = "Line items booked and shipped but not yet invoiced";
		//Booked, shipped, received, not yet invoiced
		} elseif ($report_detail == 8) {
			$sql_p[] = DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.invoice_hash = '' AND ".DB_PREFIX."line_items.sell != 0 AND !ISNULL(".DB_PREFIX."line_items.ship_date) AND ".DB_PREFIX."line_items.ship_date != '' AND !ISNULL(".DB_PREFIX."line_items.receive_date) AND ".DB_PREFIX."line_items.receive_date != ''";
		    $having_p[] = "proposal_booked > 0";
		    $this->report_title = "Line items booked, shipped and received but not yet invoiced";
		//Proposals not yet booked
		} elseif ($report_detail == 9) {
			$sql_p[] = DB_PREFIX."line_items.po_hash = ''";
			$this->report_title = "Proposals not yet booked";
	    //Booked, invoiced and paid in full
		} elseif ($report_detail == 10) {
		    $having_p[] = "total_customer_receipts >= total_invoiced_dollars";
		    $this->report_title = "Booked, invoiced and paid in full";
		}
			
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
        if ($having_p) 
            $having = implode(" AND ",$having_p);        
			
		$str = "sales_rep_match=".@implode("&",$sales_rep_match)."|customer_filter=".@implode("&",$customer_filter)."|report_detail=$report_detail|proposal_filter=".@implode("&",$proposal_filter)."|custom_contract=$custom_contract|detail=$detail";	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$max_memory = server_info('memory_limit');
		$this->report_hash = $report_hash;	

		$result = $this->db->query("SELECT ".(!$limit_start ? "SQL_CALC_FOUND_ROWS" : NULL)." ".DB_PREFIX."proposals.obj_id AS pobj_id , 
		                            ".DB_PREFIX."proposals.proposal_hash , ".DB_PREFIX."proposals.proposal_no  ,
									".DB_PREFIX."proposals.creation_date , ".DB_PREFIX."proposals.sales_hash , 
									".DB_PREFIX."proposals.proposal_descr , ".DB_PREFIX."proposals.customer_hash , 
									SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty) AS to_invoice ,
									(
                                        SELECT ".DB_PREFIX."customers.customer_name
                                        FROM ".DB_PREFIX."customers
                                        WHERE ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."proposals.customer_hash
                                    ) AS customer_name , 									
									(
										SELECT ".DB_PREFIX."purchase_order.po_date
										FROM `".DB_PREFIX."purchase_order`
										WHERE `proposal_hash` = ".DB_PREFIX."proposals.proposal_hash
										ORDER BY ".DB_PREFIX."purchase_order.po_date ASC
										LIMIT 1
									) AS po_date , 
									(
										SELECT SUM(".DB_PREFIX."customer_invoice.amount)
										FROM `".DB_PREFIX."customer_invoice`
										WHERE ".DB_PREFIX."customer_invoice.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."customer_invoice.type = 'I'
									) AS total_invoiced, 
									(
										SELECT SUM(".DB_PREFIX."customer_payment.receipt_amount)
										FROM `".DB_PREFIX."customer_invoice`
										LEFT JOIN `".DB_PREFIX."customer_payment` ON ".DB_PREFIX."customer_payment.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash
										WHERE ".DB_PREFIX."customer_invoice.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."customer_invoice.type = 'I'
									) AS total_received ,
									(
										SELECT SUM(".DB_PREFIX."customer_payment.receipt_amount)
										FROM `".DB_PREFIX."customer_invoice`
										LEFT JOIN `".DB_PREFIX."customer_payment` ON ".DB_PREFIX."customer_payment.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash
										WHERE ".DB_PREFIX."customer_invoice.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."customer_invoice.type = 'D'
									) AS total_deposits ,
									( 
									    SELECT COUNT(".DB_PREFIX."line_items.obj_id)
									    FROM ".DB_PREFIX."line_items
									    WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.status > 0
									) AS proposal_booked ,
									( 
									    SELECT COUNT(".DB_PREFIX."line_items.obj_id)
									    FROM ".DB_PREFIX."line_items
									    WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.invoice_hash = ''
									) AS proposal_fully_invoiced , 
									(
									    SELECT SUM(".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty)
									    FROM ".DB_PREFIX."line_items
									    WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.invoice_hash != ''
									) AS total_invoiced_dollars , 
                                    (
                                        SELECT SUM(".DB_PREFIX."customer_payment.receipt_amount)
                                        FROM ".DB_PREFIX."customer_payment
                                        LEFT JOIN ".DB_PREFIX."customer_invoice ON ".DB_PREFIX."customer_invoice.invoice_hash = ".DB_PREFIX."customer_payment.invoice_hash
                                        WHERE ".DB_PREFIX."customer_invoice.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."customer_invoice.type = 'I'
                                    ) AS total_customer_receipts , ".DB_PREFIX."users.full_name AS sales_rep
									FROM `".DB_PREFIX."proposals`
									LEFT JOIN `".DB_PREFIX."line_items` ON ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash
                                    LEFT JOIN `".DB_PREFIX."users` ON ".DB_PREFIX."users.id_hash = ".DB_PREFIX."proposals.sales_hash".($sql ? "
									WHERE ".$sql : NULL)."
									GROUP BY ".DB_PREFIX."proposals.proposal_hash".($having ? "
									HAVING ".$having : NULL)."
									ORDER BY ".DB_PREFIX."users.full_name , ".DB_PREFIX."proposals.creation_date ASC".($limit_start ? "
									LIMIT $limit_start , $total_rows" : NULL));
		while ($row = $this->db->fetch_assoc($result)) {
			if ($row['sales_hash'])
    			$this->backlog[$row['sales_hash']][$row['proposal_hash']][] = $row;    		
    		 
            if (!$limit_start && $detail == 1 && $k < 10) 
                $this->sub_detail[$row['proposal_hash']] = $this->show_po_details($row['proposal_hash'],'backlog');
    		if ($k > 0 && $k % 10 == 0) {
                if ($k > 200 || bcdiv(memory_get_usage(),$max_memory,4) >= .8) {
                    $this->limit_start = $k + 1 + ($limit_start ? $limit_start : 0);
                    
				    if ($detail != 1 || !$this->total_rows || !is_numeric($this->total_rows)) {
						$r = $this->db->query("SELECT FOUND_ROWS() AS t");
						$this->total_rows = $this->db->result($r,0,'t');
				    }
                    $this->db->free_result($result);
                    break;
                }
    		}
    		$k++;    			
		}
		if (!$limit_start)
			$this->content['action'] = 'close';
		else
			$this->content['action'] = 'continue';			
			
        unset($str);
        
        if ($limit_start) {
            if ($this->ajax_vars['sales_map'])
                $this->sales_map = explode("|",$this->ajax_vars['sales_map']);
                
            $str = $this->backlog_report(1,$limit_start);            
            
            $temp = tempnam(SITE_ROOT.'core/tmp','pre_');
            $fh = fopen($temp,'w');
            fwrite($fh,trim($str));
            fclose($fh);

            unset($str);
            $file_str = file($temp);
            for ($i = 0; $i < count($file_str); $i++)
                $str .= trim(str_replace("'","\'",$file_str[$i]));

            unlink($temp);
            $this->content['jscript'][] = "\$('table_content_control').insert({before:'".$str."'});";
        } else 
            $this->content['html']['place_holder'] = $this->backlog_report(1);
            
        if ($this->limit_start) {
            if ($this->sales_map)
                $sales_keys = array_values($this->sales_map);                
                
            $this->content['jscript'][] = "agent.call('reports','sf_loadcontent','cf_loadcontent','doit_backlog_report','report_hash=".$this->report_hash."','limit_start=".$this->limit_start."','total_rows=".$this->total_rows."'".($sales_keys ? ",'sales_map=".@implode("|",$sales_keys)."'" : NULL).");";
        } else 
            $this->content['jscript'][] = "remote_fetch();";              

		return;
	}
	
	function backlog_totals() {
		$report_hash = $this->ajax_vars['report_hash'];
		
        if ($_SESSION['backlog_total'][$report_hash]) {
        	$total_cost = $total_sell = $i = $k = 0;  
        	$jump_to[] = "<tr>";      
        	$sales_array = array();
            while (list($sales_hash,$total_array) = each($_SESSION['backlog_total'][$report_hash])) {
            	$sales_array[$k] = array('sales_hash'  =>  $sales_hash,
            	                         'cost'        =>  $total_array['cost'],
            	                         'sell'        =>  $total_array['sell']);

                $total_cost += $total_array['cost'];
                $total_sell += $total_array['sell'];
                
                $jump_to[] = "<td style=\"padding-bottom:5px;font-size:8pt;\"><a href=\"#".$sales_hash."\" class=\"link_standard\">".stripslashes($this->user_name($sales_hash))."</td>";
                if ($i > 0 && $i % 2 == 0) {
                    $jump_to[] = "</tr>";
                    $jump_to[] = "<tr>";
                    $i = 0;
                } else
                    $i++;
                    
                $k++;
            }
            unset($margin_flag);
            
            if ($jump_to && count($jump_to) > 1) {
            	if ($jump_to[count($jump_to)-1] == "<tr>")
                    array_pop($jump_to);
                                	
                $this->content['html']['jump_to_table'] = "<table style=\"width:95%;text-align:right;\"><tr><td style=\"padding-bottom:5px;padding-left:15px;font-size:8pt;text-align:left;\" colspan=\"3\">Jump to Sales Rep:</td></tr>".implode("\n",$jump_to)."</table>";
            } else
                $this->content['html']['jump_to_table'] = "";         
            
            //Sales Totals
            if (count($sales_array) > 0) {
            	for ($i = 0; $i < count($sales_array); $i++) {
                    $str = "<tr style=\"background-color:#ffffff;\"><td style=\"text-align:right;background-color:#efefef;font-size:10pt;font-weight:bold;vertical-align:middle;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc\"><table style=\"text-align:right;\"><tr><td style=\"text-align:right;padding-right:15px;padding-left:10px;vertical-align:bottom;\" nowrap>Total for ".$this->user_name($sales_array[$i]['sales_hash']).":</td><td style=\"width:105px;font-size:8pt;\"><div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".($sales_array[$i]['cost'] < 0 ? "($".number_format($sales_array[$i]['cost'] * -1,2).")" : "$".number_format($sales_array[$i]['cost'],2))."</div></td><td style=\"width:105px;font-size:8pt;\"><div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".($sales_array[$i]['sell'] < 0 ? "($".number_format($sales_array[$i]['sell'] * -1,2).")" : "$".number_format($sales_array[$i]['sell'],2))."</div></td><td style=\"padding-right:20px;width:60px;font-size:8pt;\"><div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(math::gp_margin($sales_array[$i]['cost'],$sales_array[$i]['sell']) * 100 < 0 ? "(".((math::gp_margin($sales_array[$i]['cost'],$sales_array[$i]['sell']) * 100) * -1).")" : (math::gp_margin($sales_array[$i]['cost'],$sales_array[$i]['sell']) * 100))."%</div></td></tr></table></td></tr><tr><td style=\"background-color:#ffffff;\">&nbsp;</td></tr>";             		
            		if ($i == count($sales_array) - 1) 
                        $placeholder = 'table_content_control';            			            		
            		else 
                        $placeholder = 'sales_content_'.$sales_array[$i+1]['sales_hash'];
                        
                    $this->content['jscript'][] = "\$('".$placeholder."').insert({before:'".$str."'});";           		            		
            	}
            }    
            
            $this->content['html']['report_cost'] = ($total_cost < 0 ? "($".number_format($total_cost * -1,2).")" : "$".number_format($total_cost,2));
            $this->content['html']['report_sell'] = ($total_sell < 0 ? "($".number_format($total_sell * -1,2).")" : "$".number_format($total_sell,2));
            if (defined('MARGIN_FLAG') && math::gp_margin($total_cost,$total_sell) < MARGIN_FLAG)
                $margin_flag = true;
                                        
            $this->content['html']['report_margin'] = ($margin_flag ? "<span style=\"color:#ff0000;\">" : NULL).(math::gp_margin($total_cost,$total_sell) * 100 < 0 ? "(".((math::gp_margin($total_cost,$total_sell) * 100) * -1).")" : (math::gp_margin($total_cost,$total_sell) * 100))."%".($margin_flag ? "</span>" : NULL);            
            unset($_SESSION['backlog_total'][$report_hash]);
        }   
	}
	
	function user_name($user_hash) {
		$result = $this->db->query("SELECT `full_name`
									FROM `".DB_PREFIX."users`
									WHERE `id_hash` = '$user_hash'");
		
		return $this->db->result($result);
	}
	
	function fetch_backlog_items($proposal_hash,$obj_id=NULL,$totals=NULL) {
		$backlog_items = array();
		$num_items = 0;

		//Remaining to be invoiced
        if ($this->current_report['report_detail'] == 1) 
            $sql = DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.invoice_hash = '' AND ".DB_PREFIX."line_items.sell != 0";
        //Partially booked proposals, lines remaining to be booked
        elseif ($this->current_report['report_detail'] == 2) 
            $sql = DB_PREFIX."line_items.po_hash = ''";
        //Booked by not yet received
        elseif ($this->current_report['report_detail'] == 3) 
            $sql = DB_PREFIX."line_items.po_hash != '' AND (ISNULL(".DB_PREFIX."line_items.receive_date) OR ".DB_PREFIX."line_items.receive_date = '')";
        //Booked but not yet shipped
        elseif ($this->current_report['report_detail'] == 4) 
            $sql = DB_PREFIX."line_items.po_hash != '' AND (ISNULL(".DB_PREFIX."line_items.ship_date) OR ".DB_PREFIX."line_items.ship_date = '')";
        //Booked but not yet delivered
        elseif ($this->current_report['report_detail'] == 5) 
            $sql = DB_PREFIX."line_items.po_hash != '' AND (ISNULL(".DB_PREFIX."line_items.deliver_date) OR ".DB_PREFIX."line_items.deliver_date = '')";
        //Booked and received, but not yet invoiced
        elseif ($this->current_report['report_detail'] == 6) 
            $sql = DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.invoice_hash = '' AND ".DB_PREFIX."line_items.sell != 0 AND !ISNULL(".DB_PREFIX."line_items.receive_date) AND ".DB_PREFIX."line_items.receive_date != ''";
        //Booked, shipped, not yet invoiced
        elseif ($this->current_report['report_detail'] == 7) 
            $sql = DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.invoice_hash = '' AND ".DB_PREFIX."line_items.sell != 0 AND !ISNULL(".DB_PREFIX."line_items.ship_date) AND ".DB_PREFIX."line_items.ship_date != ''";
        //Booked, shipped, received, not yet invoiced
        elseif ($this->current_report['report_detail'] == 8) 
            $sql = DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.invoice_hash = '' AND ".DB_PREFIX."line_items.sell != 0 AND !ISNULL(".DB_PREFIX."line_items.ship_date) AND ".DB_PREFIX."line_items.ship_date != '' AND !ISNULL(".DB_PREFIX."line_items.receive_date) AND ".DB_PREFIX."line_items.receive_date != ''";
        //Proposals not yet booked            
        elseif ($this->current_report['report_detail'] == 9)
            $sql = DB_PREFIX."line_items.po_hash = ''";
            
        if ($totals) {
            $result = $this->db->query("SELECT ".DB_PREFIX."line_items.proposal_hash ,
                                        SUM(".DB_PREFIX."line_items.qty * ".DB_PREFIX."line_items.cost) AS ext_cost , 
										SUM(".DB_PREFIX."line_items.qty * ".DB_PREFIX."line_items.sell) AS ext_sell , 
										(
										    SELECT ".DB_PREFIX."proposals.sales_hash
										    FROM ".DB_PREFIX."proposals
										    WHERE ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."line_items.proposal_hash
										) AS sales_hash 
										FROM ".DB_PREFIX."line_items
										WHERE ".DB_PREFIX."line_items.proposal_hash = ".($obj_id ? "
										                                              ( SELECT ".DB_PREFIX."proposals.proposal_hash 
										                                                FROM ".DB_PREFIX."proposals 
										                                                WHERE ".DB_PREFIX."proposals.obj_id = $proposal_hash
										                                              )" : "'$proposal_hash'").($sql ? "
										AND ".$sql : NULL)."
										GROUP BY ".DB_PREFIX."line_items.proposal_hash");
            $backlog_items = $this->db->fetch_assoc($result); 
        } else {
			$result = $this->db->query("SELECT ".($obj_id ? DB_PREFIX."line_items.proposal_hash , " : NULL).DB_PREFIX."line_items.item_hash , ".DB_PREFIX."line_items.item_no , ".DB_PREFIX."line_items.qty , 
			                            ".DB_PREFIX."line_items.item_descr , (".DB_PREFIX."line_items.qty * ".DB_PREFIX."line_items.cost) AS ext_cost , 
			                            (".DB_PREFIX."line_items.qty * ".DB_PREFIX."line_items.sell) AS ext_sell , ".DB_PREFIX."line_items.po_hash , 
			                            ".DB_PREFIX."line_items.ship_date , ".DB_PREFIX."line_items.receive_date , ".DB_PREFIX."line_items.ack_no ,
			                            (
	                                        SELECT ".DB_PREFIX."proposals.sales_hash
	                                        FROM ".DB_PREFIX."proposals
	                                        WHERE ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."line_items.proposal_hash 		                            
			                            ) AS sales_hash
										FROM `".DB_PREFIX."line_items`
										WHERE ".DB_PREFIX."line_items.proposal_hash = ".($obj_id ? 
	    									"(
	        									SELECT ".DB_PREFIX."proposals.proposal_hash
	        									FROM ".DB_PREFIX."proposals
	        									WHERE ".DB_PREFIX."proposals.obj_id = $proposal_hash
	    									)" : "'$proposal_hash'").($sql ? 
	        									" AND ".$sql : NULL));
			while ($row = $this->db->fetch_assoc($result)) 
				$backlog_items[($row['po_hash'] ? $row['po_hash'] : "UNORDERED")][] = $row;
        }
        
		return $backlog_items;
	}	

	function backlog_report($step=NULL,$active_limit_start=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
            
			$tbl = (!$active_limit_start ? "
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;vertical-align:top;\">
					    <a name=\"top\"></a>
                        <div style=\"float:right;margin-right:10px;width:50%;\" id=\"jump_to_table\"><div style=\"float:right;padding-right:15px;\">Loading Report...</div></div>
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Backlog Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','backlog_report','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=backlog_report','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>" : NULL);
            
            if (!$_SESSION['backlog_total'][$this->report_hash])
                $_SESSION['backlog_total'][$this->report_hash] = array();
								
			if (is_array($this->backlog)) {
				while (list($sales_hash,$proposal_array) = each($this->backlog)) {
					reset($proposal_array);
                    $sales_totals = array();
					$sales_rep = current($proposal_array);
					
					if (!$_SESSION['backlog_total'][$this->report_hash][$sales_hash])
                        $_SESSION['backlog_total'][$this->report_hash][$sales_hash] = array('cost'  =>  0,
                                                                                            'sell'  =>  0);
					
                    $tbl .= (!$active_limit_start || ($active_limit_start && (!is_array($this->sales_map) || !in_array($sales_hash,$this->sales_map))) ? 
                        ($z > 0 || $active_limit_start ? 
                            "<tr>
                                <td style=\"background-color:#ffffff;padding-top:10px;\">&nbsp;</td>
                            </tr>" : NULL)."
	                    <tr id=\"sales_content_".$sales_hash."\" style=\"background-color:#ffffff;\">
	                        <td style=\"background-color:#efefef;font-size:10pt;font-weight:bold;vertical-align:middle;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc\">
	                            <a name=\"".$sales_hash."\" style=\"text-decoration:none;\">".stripslashes($sales_rep[0]['sales_rep'])."</a>".($z > 0 ? "
	                            <span style=\"padding-left:10px;\"><a href=\"#top\" class=\"link_standard\" style=\"font-size:8pt;\">top</a></span>" : NULL)."
	                        </td>	                        
	                    </tr>" : NULL)."
                    <tr>
                        <td style=\"background-color:#ffffff;\">";					
                    
                    $z++;
                    
                    unset($sales_rep);
                    if (!is_array($this->sales_map) || !in_array($sales_hash,$this->sales_map))
                        $this->sales_map[] = $sales_hash;                    
                    
					while (list($proposal_hash,$proposal_list) = each($proposal_array)) {
						$sales_rep = $proposal_list[0]['sales_rep'];
						
						$tbl .= "
						<div style=\"margin:10px 5px;\">
							<table style=\"width:100%;border:1px solid #cccccc;margin-bottom:10px;\">
								<tr>
									<td style=\"vertical-align:top;font-weight:bold;\" colspan=\"3\">
									    <div style=\"margin-bottom:5px;\">
									        ".$proposal_list[0]['customer_name']."
									    </div>
										Proposal : <a href=\"javascript:void(0);\" onClick=\"agent.call('proposals','sf_loadcontent','show_popup_window','edit_proposal','proposal_hash=".$proposal_hash."','popup_id=proposal_win','from_report=1');\" class=\"link_standard\" title=\"Jump to this proposal\">".$proposal_list[0]['proposal_no']."</a> - ".(strlen($proposal_list[0]['proposal_descr']) > 72 ? 
											substr($proposal_list[0]['proposal_descr'],0,69)."..." : $proposal_list[0]['proposal_descr'])."
									</td>
								</tr>
								<tr>
									<td style=\"vertical-align:top;width:33%;padding-top:10px;\">
										Created: ".date(DATE_FORMAT,$proposal_list[0]['creation_date'])."
									</td>
									<td style=\"vertical-align:top;width:33%;padding-top:10px;\">
										Amount Invoiced: $".number_format($proposal_list[0]['total_invoiced'],2)."
									</td>
									<td style=\"vertical-align:top;width:33%;padding-top:10px;\">
										Amount Received: $".number_format($proposal_list[0]['total_received'],2)."
									</td>
								</tr>
								<tr>
									<td style=\"vertical-align:top;width:33%;\">".($this->current_report['report_detail'] == 9 ? 
										"&nbsp;" : "Booked: ".date(DATE_FORMAT,strtotime($proposal_list[0]['po_date'])))."
									</td>
									<td style=\"vertical-align:top;width:33%;\">
										Remaining To Invoice: $".number_format($proposal_list[0]['to_invoice'],2)."
									</td>
									<td style=\"vertical-align:top;width:33%;\">
										Deposits Received: $".number_format($proposal_list[0]['total_deposits'],2)."
									</td>
								</tr>
								<tr>
									<td colspan=\"3\">
                                        <div style=\"margin:10px;\">
                                            <div style=\"font-size:8pt;margin-bottom:5px;\" >
                                                <img src=\"images/expand.gif\" />
                                                &nbsp;
                                                <a href=\"javascript:void(0);\" onClick=\"if(\$('po_holder".$proposal_hash."').readAttribute('style') && \$('po_holder".$proposal_hash."').getStyle('display')=='block'){toggle_display('po_holder".$proposal_hash."','none');\$('po_holder".$proposal_hash."').innerHTML='';} else{agent.call('reports','sf_loadcontent','cf_loadcontent','show_po_details','proposal_hash=".$proposal_hash."','report_type=backlog');}\" title=\"Show/Hide Proposal Details\" class=\"link_standard\">Show Proposal Details</a>
                                            </div>
                                            <div id=\"po_holder".$proposal_hash."\" >".($this->current_report['detail'] == 1 ? 
                                                ($this->sub_detail[$proposal_hash] ? 
                                                    $this->sub_detail[$proposal_hash] : "<img src=\"images/content_loader.gif\" content_holder=\"1\" content_id=\"".$proposal_list[0]['pobj_id']."\" style=\"margin-left:20px;margin-top:5px;\" />") : "<img src=\"images/placeholder.gif\" simple_holder=\"1\" content_id=\"".$proposal_list[0]['pobj_id']."\" />")."                                            
                                            </div>
                                        </div>
            						</td>
								</tr>
							</table>
                        </div>";
					}
					
					$tbl .= "
    					</td>
					</tr>";
				}
			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\">There are no results to show.</td>
				</tr>";
									
            if (!$active_limit_start)
	                $tbl .= "
	                <tr id=\"table_content_control\">
	                    <td style=\"background-color:#ffffff;padding-top:10px;\">&nbsp;</td>
	                </tr>
	                <tr style=\"background-color:#ffffff;\">
	                    <td style=\"text-align:right;background-color:#efefef;font-size:10pt;font-weight:bold;vertical-align:middle;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc\">
	                        <table style=\"text-align:right;\" border=\"0\">
	                            <tr>
	                                <td style=\"text-align:right;padding-right:15px;padding-left:10px;vertical-align:bottom;\" nowrap>Report Total:</td>
	                                <td style=\"width:105px;font-size:8pt;\">
	                                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"report_cost\">".($this->current_report['detail'] != 1 ? 
	                                        ($report_totals['cost'] < 0 ?
	                                            "($".number_format($report_totals['cost'] * -1,2).")" : "$".number_format($report_totals['cost'],2)) : "<img src=\"images/content_loader.gif\" />")."
	                                    </div>
	                                </td>
	                                <td style=\"width:105px;font-size:8pt;\">
	                                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"report_sell\">".($this->current_report['detail'] != 1 ? 
	                                        ($report_totals['sell'] < 0 ?
	                                            "($".number_format($report_totals['sell'] * -1,2).")" : "$".number_format($report_totals['sell'],2)) : "<img src=\"images/content_loader.gif\" />")."
	                                    </div>
	                                </td>
	                                <td style=\"padding-right:20px;width:60px;font-size:8pt;\">
	                                    <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\" id=\"report_margin\">".($this->current_report['detail'] != 1 ? 
	                                        (math::gp_margin($report_totals['cost'],$report_totals['sell']) * 100 < 0 ? 
	                                            "(".((math::gp_margin($report_totals['cost'],$report_totals['sell']) * 100) * -1).")" : (math::gp_margin($report_totals['cost'],$report_totals['sell']) * 100))."%" : "<img src=\"images/content_loader.gif\" />")."
	                                    </div>
	                                </td>
	                            </tr>
	                        </table>
	                    </td>
	                </tr>           
                </table>";                      

            if (!$active_limit_start) {
                $jscript = '
                remote_fetch = function() {
                    if (agent.in_progress == true) {
                        setTimeout("remote_fetch();",1000);
                        return;
                    }
                    var pending = $$(\'img[content_holder=1]\');
                    var i=0, c, str=\'\', atr;                    
                    while (c = pending[i++]) {
                        var yes = true;
                        if (i > 30)
                            break;
                            
                        if (atr = c.readAttribute(\'content_id\'))
                            str += atr + \'|\';
                                                        
                    }
                    if (yes)
                        agent.call(\'reports\',\'sf_loadcontent\',\'cf_loadcontent\',\'show_po_details\',\'report_hash='.$this->report_hash.'\',\'report_type=backlog\',\'pstr=\' + str);
                    else {
                        var pending = $$(\'img[simple_holder=1]\');
                        if (pending && pending.length > 0) {
		                    var i=0, c, str=\'\', atr;
		                    while (c = pending[i++]) {
		                        var yes = true;
		                            
		                        if (atr = c.readAttribute(\'content_id\'))
		                            str += atr + \'|\';
		                                                        
		                    }
		                    if (yes)
                                agent.call(\'reports\',\'sf_loadcontent\',\'cf_loadcontent\',\'show_po_details\',\'report_hash='.$this->report_hash.'\',\'report_type=backlog\',\'simple_view=1\',\'pstr=\' + str);		                    
                        }
                        populate_totals();
                    }                        
                }
                populate_totals = function() {
                    if (agent.in_progress == true) {
                        setTimeout("populate_totals()",1000);
                        return;
                    }
                    agent.call(\'reports\',\'sf_loadcontent\',\'cf_loadcontent\',\'backlog_totals\',\'report_hash='.$this->report_hash.'\');                    
                }';            
                $this->content['jscript'][] = $jscript;
            }                
                
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			
			
			if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
				$this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);
			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
				$this->current_report['customer_filter'] = array($this->current_report['customer_filter']);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_backlog_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_backlog_report','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Backlog Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
														$tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<!tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=proposal",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'),'account_suggest');key_call('reports','proposal','proposal_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
												if (is_array($this->current_report['proposal_filter'])) {
													for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++) 
														$tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">What do you want to show?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->select("report_detail",
                                                                      array("Line items remaining to be invoiced",
                                                                            "Proposals partially booked showing line items remaining to be booked",
                                                                            "Line items booked but not yet received",
                                                                            "Line items booked but not yet shipped",
                                                                            "Line items booked but not yet delivered",
                                                                            "Line items booked and shipped but not yet invoiced",
                                                                            "Line items booked and received but not yet invoiced",
                                                                            "Line items booked, shipped and received but not yet invoiced",
                                                                            "Lines items booked, invoiced and paid in full",
                                                                            "Proposals not yet booked"),
                                                                      $this->current_report['report_detail'],
                                                                      array(1,2,3,4,5,7,6,8,10,9),
                                                                      "blank=1",
                                                                      "style=width:350px;")."
                                            </td>
                                        </tr>										
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]",array_merge(array("All Sales Reps"),$this->user_name),$this->current_report['sales_rep_match'],array_merge(array(''),$this->user_hash),"multiple","blank=1","size=4","style=width:200px;")."</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales coordinator?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("sales_coord_match[]",array_merge(array("All Sales Reps"),$this->user_name),$this->current_report['sales_coord_match'],array_merge(array(''),$this->user_hash),"multiple","blank=1","size=4","style=width:200px;")."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by designer?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("designer_match[]",array_merge(array("All Sales Reps"),$this->user_name),$this->current_report['designer_match'],array_merge(array(''),$this->user_hash),"multiple","blank=1","size=4","style=width:200px;")."</td>
                                        </tr>                                                                                
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by project manager?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("proj_mngr_match[]",array_merge(array("All Sales Reps"),$this->user_name),$this->current_report['proj_mngr_match'],array_merge(array(''),$this->user_hash),"multiple","blank=1","size=4","style=width:200px;")."</td>
                                        </tr>                                                                                                                        
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Details?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("detail",array("Show Detail View","Show Simple View"),$this->current_report['detail'],array(1,0),"blank=1")."</td>
                                        </tr>                                        										
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}		
	}
	
	
	function proposal_no($proposal_hash) {
		$result = $this->db->query("SELECT `proposal_no`
									FROM `".DB_PREFIX."proposals`
									WHERE `proposal_hash` = '$proposal_hash'");
		return $this->db->result($result);
	}
	
	function doit_sales_tax() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		$doit_print = $_POST['doit_print'];
		$report_hash = $_POST['report_hash'];
		
		if ($doit_print && $report_hash) {
			$this->fetch_report_settings($report_hash);
			
			$timeframe = $this->current_report['timeframe'];
			$tax_state = $this->current_report['tax_state'];
			$sort_from_date = $this->current_report['sort_from_date'];
			$sort_to_date = $this->current_report['sort_to_date'];
		} else {
			$timeframe = $_POST['timeframe'];
			$tax_state = $_POST['tax_state'];
			$sort_from_date = $_POST['sort_from_date'];
			$sort_to_date = $_POST['sort_to_date'];
		}
		$save = $_POST['save'];
		$saved_cat = "sales_tax_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
				
		if ($this->content['error'])
			return;
		
		$s = new system_config();
		if ($tax_state) {
			$s->fetch_tax_tables($tax_state);
			//$tax_state = array($tax_state);
		} else {
			$s->fetch_tax_tables();
			//while ($state,$t_array) = each($s->tax_tables))
				//$tax_state[] = $state;
		}
		switch ($timeframe) {
			//This Month
			case 1:
			$this->report_date_start = date("Y-m-01");
			$this->report_date_end = date("Y-m-t");
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
			
			//Last Month
			case 2:
			$this->report_date_start = date("Y-m-01",strtotime(date("Y-m-d")." -1 month"));
			$this->report_date_end = date("Y-m-t",strtotime(date("Y-m-d")." -1 month"));
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//This Quarter
			case 3:
			list($this->report_date_start,$this->report_date_end) = get_quarter_dates(get_quarter(date("Y-m-d")),date("Y"));
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//Last Quarter
			case 4:
			$current_qtr = get_quarter(date("Y-m-d"));
			if ($current_qtr == 1) {
				$previous_qtr = get_quarter(date("Y-m-d",strtotime(date("Y-m-d")." -4 months")));
				list($start,$date) = get_quarter_dates($previous_qtr,date("Y",strtotime(date("Y-m-d")." -4 months")));
			} else
				list($this->report_date_start,$this->report_date_end) = get_quarter_dates($current_qtr - 1,date("Y"));
			
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//This Period
			case 5:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//Last Period
			case 6:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_date_start = $period_info['period_start'];
				$this->report_date_end = $period_info['period_end'];
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//This Year
			case 7:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$this->report_date_start = date("Y")."-".$month."-".$day;
			$this->report_date_end = date("Y")."-".($month + 11)."-".date("t",strtotime(date("Y-".($month + 11)."-01")));
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
			
			//Last Year
			case 8:
			list($month,$day) = explode("/",FISCAL_YEAR_START);
			if (!$month || !$day)
				$month = $day = 1;
			$last_year = date("Y") - 1;
			$this->report_date_start = $last_year."-".$month."-".$day;
			$this->report_date_end = $last_year."-".($month + 11)."-".date("t",strtotime(date($last_year."-".($month + 11)."-01")));
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;

			//Specific Date
			case 9:
			$this->report_date_start = $sort_from_date;
			$this->report_date_end = $sort_to_date;
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$this->report_date_start."' AND '".$this->report_date_end."'";
			break;
		}
		
		if ($sql_p) 
			$sql = implode(" AND ",$sql_p);
		
		$str = "timeframe=$timeframe|tax_state=$tax_state|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date";	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		global $states,$stateNames;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."customer_invoice.invoice_date , ".DB_PREFIX."customer_invoice.invoice_no , 
									".DB_PREFIX."customer_invoice.invoice_hash , ".DB_PREFIX."customer_invoice.proposal_hash , 
									".DB_PREFIX."customer_invoice.amount , ".DB_PREFIX."customer_invoice.tax , ".DB_PREFIX."proposals.proposal_no , ".DB_PREFIX."proposals.proposal_descr , 
									".DB_PREFIX."customers.customer_name , ".DB_PREFIX."customers.tax_exempt_id , ".DB_PREFIX."customers.gsa , ".DB_PREFIX."proposal_install.install_addr_hash 
									FROM `".DB_PREFIX."customer_invoice`
									LEFT JOIN ".DB_PREFIX."proposals ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."customer_invoice.proposal_hash
									LEFT JOIN ".DB_PREFIX."proposal_install ON ".DB_PREFIX."proposal_install.proposal_hash = ".DB_PREFIX."proposals.proposal_hash
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."customer_invoice.customer_hash
									WHERE ".($sql ? $sql." AND " : NULL).DB_PREFIX."customer_invoice.type = 'I' AND ".DB_PREFIX."customer_invoice.direct_bill = 0
									GROUP BY ".DB_PREFIX."customer_invoice.invoice_hash
									ORDER BY ".DB_PREFIX."customer_invoice.invoice_date , ".DB_PREFIX."customer_invoice.invoice_no ASC");
		$this->proposal_detail = array();
		
		while ($row = $this->db->fetch_assoc($result)) {
			$this->proposal_detail[$row['proposal_hash']]['detail'] = array('proposal_no'			=>	$row['proposal_no'],
																		    'proposal_descr'		=>	$row['proposal_descr'],
																		    'install_addr'			=>	$row['install_addr_hash'],
																		    'customer'				=>	$row['customer_name'],
																		    'customer_hash'			=>	$row['customer_hash'],
																		    'tax_exempt'			=>	$row['tax_exempt_id'],
																		    'gsa'					=>	$row['gsa']);
			
			unset($state);
			if (!$this->proposal_detail[$row['proposal_hash']]['install_detail'] && $row['install_addr_hash']) {
				list($class,$id,$hash) = explode("|",$row['install_addr_hash']);
				$obj = new $class($_SESSION['id_hash']);
				
				unset($location,$city,$state,$zip);
				if ($hash) {
					$obj->fetch_location_record($hash);
					$location = $obj->current_location['location_name'];
					$city = $obj->current_location['location_name'];
					$state = $obj->current_location['location_state'];
					$zip = $obj->current_location['location_zip'];
				} else {
					$obj->fetch_master_record($id);
					$location = $obj->{"current_".strrev(substr(strrev($class),1))}[strrev(substr(strrev($class),1))."_name"];
					$city = $obj->{"current_".strrev(substr(strrev($class),1))}["city"];
					$state = $obj->{"current_".strrev(substr(strrev($class),1))}["state"];
					$zip = $obj->{"current_".strrev(substr(strrev($class),1))}["zip"];
				}
				$this->proposal_detail[$row['proposal_hash']]['install_detail'] = array('location'	=>	$location,
																						'city'		=>	$city,
																						'state'		=>	$state,
																						'zip'		=>	$zip);
				unset($obj);				
			}
			
			if (($state && array_key_exists($state,$s->tax_tables)) || ($this->proposal_detail[$row['proposal_hash']]['install_detail']['state'] && array_key_exists($this->proposal_detail[$row['proposal_hash']]['install_detail']['state'],$s->tax_tables)))
				$this->proposal_detail[$row['proposal_hash']]['invoices'][] = array('invoice_hash'		=>	$row['invoice_hash'],
																					'amount'			=>	$row['amount'],
																					'tax'				=>	$row['tax'],
																					'invoice_no'		=>	$row['invoice_no'],
																					'invoice_date'		=>	$row['invoice_date']);
		}

		$tax_tables =& $s->tax_tables;		
		$this->tax_tables =& $s->tax_tables;		
		while (list($proposal_hash,$proposal_info) = each($this->proposal_detail)) {
			$invoice_total_taxable = $invoice_total_nontaxable = $tax_collected = 0;
			$state = $this->proposal_detail[$proposal_hash]['install_detail']['state'];
			if (array_key_exists($state,$s->tax_tables)) {
				$tax_rule = $tax_tables[$state];
				for ($i = 0; $i < count($proposal_info['invoices']); $i++) {
					$result = $this->db->query("SELECT SUM( ".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty ) AS total_taxable_sell 
												FROM `".DB_PREFIX."tax_collected`
												LEFT JOIN `".DB_PREFIX."line_items` ON ".DB_PREFIX."line_items.item_hash = ".DB_PREFIX."tax_collected.item_hash
												WHERE ".DB_PREFIX."tax_collected.invoice_hash = '".$proposal_info['invoices'][$i]['invoice_hash']."' AND `tax_hash` = '".$tax_rule['state']['tax_hash']."'");
					$invoice_total_taxable = $this->db->result($result,0,'total_taxable_sell');
					$invoice_total_nontaxable = ($proposal_info['invoices'][$i]['amount'] - $proposal_info['invoices'][$i]['tax']) - $this->db->result($result,0,'total_taxable_sell');
					$tax_collected = $proposal_info['invoices'][$i]['tax'];
					
					unset($tax_collect);
					$result = $this->db->query("SELECT ".DB_PREFIX."tax_collected.tax_hash , SUM(ROUND((".DB_PREFIX."line_items.sell * ".DB_PREFIX."line_items.qty * ".DB_PREFIX."tax_collected.rate),3)) AS total_tax_collect ,
												".DB_PREFIX."tax_table.local
												FROM `".DB_PREFIX."tax_collected`
												LEFT JOIN `".DB_PREFIX."line_items` ON ".DB_PREFIX."line_items.item_hash = ".DB_PREFIX."tax_collected.item_hash
												LEFT JOIN `".DB_PREFIX."tax_table` ON ".DB_PREFIX."tax_table.tax_hash = ".DB_PREFIX."tax_collected.tax_hash											
												WHERE ".DB_PREFIX."tax_collected.invoice_hash = '".$proposal_info['invoices'][$i]['invoice_hash']."' 
												GROUP BY ".DB_PREFIX."tax_collected.tax_hash");
					if ($this->db->num_rows($result) > 0) {							
						while ($row = $this->db->fetch_assoc($result)) {
							//$total_tax_collect = _round($row['ext_sell'] * $row['rate'],3);
							if (!$row['local'])
								$tax_info[$state]['state']['invoices'][$proposal_info['invoices'][$i]['invoice_hash']] = array("invoice_no" 	=>  $proposal_info['invoices'][$i]['invoice_no'],
																															   "invoice_date" 	=>	$proposal_info['invoices'][$i]['invoice_date'],
																															   "invoice_hash" 	=>	$proposal_info['invoices'][$i]['invoice_hash'],
																															   "proposal_hash" 	=>	$proposal_hash,
																															   "invoice_net"	=>	$proposal_info['invoices'][$i]['amount'],
																															   "city"			=>	$this->proposal_detail[$proposal_hash]['install_detail']['city'],
																															   "zip"			=>	$this->proposal_detail[$proposal_hash]['install_detail']['zip'],
																															   "taxable" 		=>  $invoice_total_taxable,
																															   "nontaxable"		=>  $invoice_total_nontaxable,
																															   "tax_collect"	=>	$row['total_tax_collect']);
							else {
								$tax_info[$state]['local'][$row['tax_hash']]['local'] = array("local_name"	=>	$row['local']);
								$tax_info[$state]['local'][$row['tax_hash']]['invoices'][$proposal_info['invoices'][$i]['invoice_hash']] = array("invoice_no" 	=>  $proposal_info['invoices'][$i]['invoice_no'],
																															   "invoice_date" 	=>	$proposal_info['invoices'][$i]['invoice_date'],
																															   "invoice_hash" 	=>	$proposal_info['invoices'][$i]['invoice_hash'],
																															   "proposal_hash" 	=>	$proposal_hash,
																															   "invoice_net"	=>	$proposal_info['invoices'][$i]['amount'],
																															   "city"			=>	$this->proposal_detail[$proposal_hash]['install_detail']['city'],
																															   "zip"			=>	$this->proposal_detail[$proposal_hash]['install_detail']['zip'],
																															   "taxable" 		=>  $invoice_total_taxable,
																															   "nontaxable"		=>  $invoice_total_nontaxable,
																															   "tax_collect"	=>	$row['total_tax_collect']);
							
		
							}
						}
					} else
						$tax_info[$state]['state']['invoices'][$proposal_info['invoices'][$i]['invoice_hash']] = array("invoice_no" 	=>  $proposal_info['invoices'][$i]['invoice_no'],
																													   "invoice_date" 	=>	$proposal_info['invoices'][$i]['invoice_date'],
																													   "invoice_hash" 	=>	$proposal_info['invoices'][$i]['invoice_hash'],
																													   "proposal_hash" 	=>	$proposal_hash,
																													   "invoice_net"	=>	$proposal_info['invoices'][$i]['amount'],
																													   "city"			=>	$this->proposal_detail[$proposal_hash]['install_detail']['city'],
																													   "zip"			=>	$this->proposal_detail[$proposal_hash]['install_detail']['zip'],
																													   "taxable" 		=>  $invoice_total_taxable,
																													   "nontaxable"		=>  $invoice_total_nontaxable,
																													   "tax_collect"	=>	$row['total_tax_collect']);					
				}
				$tax_info[$state]['state']['tax_collected'] += $tax_collected;
				$tax_info[$state]['state']['taxable'] += $invoice_total_taxable;
				$tax_info[$state]['state']['nontaxable'] += $invoice_total_nontaxable;
				$tax_info[$state]['state']['net_invoiced'] += ($invoice_total_taxable + $invoice_total_nontaxable);
			}
		}
		$this->results = $tax_info;	
		$this->content['action'] = 'close';
			
		$this->total = count($this->results);
		if ($local)
			return true;
		else
			$this->content['html']['place_holder'] = $this->sales_tax(1);
		return;
	}
	
	function sales_tax($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);

			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"3\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"7\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Sales Tax Liability Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','sales_tax','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=sales_tax','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>					
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;font-size:8pt;\">
					<td style=\"padding:5px 5px 5px 50px;width:125px;text-align:left;padding-left:50px;font-size:8pt;\">Invoice No.</td>
					<td style=\"padding:5px;width:105px;font-size:8pt;\" >Invoice Date</td>
					<td style=\"padding:5px;width:125px;font-size:8pt;\" class=\"num_field\">Invoice Total</td>
					<td style=\"padding:5px;width:105px;text-align:right;font-size:8pt;\" class=\"num_field\">Taxable</td>
					<td style=\"padding:5px;width:105px;text-align:right;font-size:8pt;\" class=\"num_field\">Non-Taxable</td>
					<td style=\"padding:5px;width:105px;text-align:right;font-size:8pt;\" class=\"num_field\">Tax Collected</td>
					<td style=\"padding:5px 5px 5px 15px;width:230px;font-size:8pt;\">Installation City State & Zip</td>
				</tr>";
			if (is_array($this->results)) {
				reset($this->results);
				global $states,$stateNames;
				while (list($state,$invoice_details) = each($this->results)) {
					$k++;
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"7\" style=\"font-weight:bold;font-size:12pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">
							".$stateNames[array_search($state,$states)]."
						</td>
					</tr>";
					
					//State first
					$total_taxable = $total_non = $total_net = $total_collected = 0;
					while (list($invoice_hash,$detail) = each($invoice_details['state']['invoices'])) {
						$tbl .= "
						<tr>
							<td style=\"background-color:#ffffff;font-size:8pt;padding-left:50px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$invoice_hash."','proposal_hash=".$detail['proposal_hash']."','popup_id=line_item');\" class=\"link_standard\">".$detail['invoice_no']."</a></td>
							<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($detail['invoice_date']))."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($detail['invoice_net'],2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($detail['taxable'],2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($detail['nontaxable'],2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($detail['tax_collect'],2)."</td>
							<td style=\"background-color:#ffffff;font-size:8pt;padding-left:15px;\">".$detail['city'].", ".$state." ".$detail['zip']."</td>
						</tr>";
						
						$total_taxable += $detail['taxable'];
						$total_non += $detail['nontaxable'];
						$total_net += $detail['invoice_net'];
						$total_collected += $detail['tax_collect'];
						
						$invoice_array[$invoice_hash] = array('net'				=>	$detail['invoice_net'],
															  'taxable'			=>	$detail['taxable'],
															  'nontaxable'		=>	$detail['nontaxable'],
															  'tax_collected'	=>	$detail['tax_collect']);														
						
					}
					$tbl .= "
					<tr>
						<td colspan=\"2\" style=\"background-color:#ffffff;\"></td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">
							<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
								$".number_format($total_net,2)."
							</div>
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">
							<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
								$".number_format($total_taxable,2)."
							</div>
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">
							<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
								$".number_format($total_non,2)."
							</div>
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">
							<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
								$".number_format($total_collected,2)."
							</div>
						</td>
						<td style=\"background-color:#ffffff;\"></td>
					</tr>";
					
					$local =& $invoice_details['local']; 
					while (list($tax_hash,$detail) = each($local)) {
						$tbl .= "
						<tr style=\"background-color:#efefef;\">
							<td colspan=\"7\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">
								<div style=\"margin-left:25px;\">
									".$detail['local']['local_name']."
								</div>
							</td>
						</tr>";

						$total_taxable = $total_non = $total_net = $total_collected = 0;
						if (is_array($detail['invoices'])) {
							while (list($invoice_hash,$invoice_detail) = each($detail['invoices'])) {
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;font-size:8pt;padding-left:50px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$invoice_hash."','proposal_hash=".$invoice_detail['proposal_hash']."','popup_id=line_item');\" class=\"link_standard\">".$invoice_detail['invoice_no']."</a></td>
									<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($invoice_detail['invoice_date']))."</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_detail['invoice_net'],2)."</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_detail['taxable'],2)."</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_detail['nontaxable'],2)."</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_detail['tax_collect'],2)."</td>
									<td style=\"background-color:#ffffff;font-size:8pt;padding-left:15px;\">".$invoice_detail['city'].", ".$state." ".$invoice_detail['zip']."</td>
								</tr>";
								
								$total_taxable += $invoice_detail['taxable'];
								$total_non += $invoice_detail['nontaxable'];
								$total_net += $invoice_detail['invoice_net'];
								$total_collected += $invoice_detail['tax_collect'];
							
								if ($invoice_array[$invoice_hash])
									$invoice_array[$invoice_hash]['tax_collected'] += $invoice_detail['tax_collect'];
								else
									$invoice_array[$invoice_hash] = array('net'				=>	$invoice_detail['invoice_net'],
																	   	  'taxable'			=>	$invoice_detail['taxable'],
																	   	  'nontaxable'		=>	$invoice_detail['nontaxable'],
																	   	  'tax_collected'	=>	$invoice_detail['tax_collect']);														
							}
						}
						$tbl .= "
						<tr>
							<td colspan=\"2\" style=\"background-color:#ffffff;\"></td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
									$".number_format($total_net,2)."
								</div>
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
									$".number_format($total_taxable,2)."
								</div>
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
									$".number_format($total_non,2)."
								</div>
							</td>
							<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">
								<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
									$".number_format($total_collected,2)."
								</div>
							</td>
							<td style=\"background-color:#ffffff;\"></td>
						</tr>";					
					}
					$net = $taxable = $non_taxable = $tax_collected = 0;
					while (list($ihash,$itotals) = each($invoice_array)) {
						$net += $itotals['net'];
						$taxable += $itotals['taxable'];
						$non_taxable += $itotals['nontaxable'];
						$tax_collected += $itotals['tax_collected'];															
					}	
					unset($invoice_array);			
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"7\" style=\"font-weight:bold;font-size:10pt;padding-top:15px;padding:5px;border-top:1px solid #cccccc;\">
							<div style=\"margin-left:50px;\">
								Grand Total for ".$stateNames[array_search($state,$states)]." and all local tax rules
							</div>
						</td>
					</tr>
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"2\" style=\"font-weight:bold;padding:5px;padding-bottom:15px;border-bottom:1px solid #cccccc;\" class=\"num_field\">&nbsp;</td>
						<td style=\"font-weight:bold;font-size:8pt;padding:5px;padding-bottom:15px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
							<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
								$".number_format($net,2)."
							</div>
						</td>
						<td style=\"font-weight:bold;font-size:8pt;padding:5px;padding-bottom:15px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
							<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
								$".number_format($taxable,2)."
							</div>					
						</td>
						<td style=\"font-weight:bold;font-size:8pt;padding:5px;padding-bottom:15px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
							<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
								$".number_format($non_taxable,2)."
							</div>					
						</td>
						<td style=\"font-weight:bold;font-size:8pt;padding:5px;padding-bottom:15px;border-bottom:1px solid #cccccc;\" class=\"num_field\">
							<div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">
								$".number_format($tax_collected,2)."
							</div>					
						</td>
						<td class=\"num_field\" style=\"padding-bottom:15px;\">&nbsp;</td>
					</tr>";				
				}
			} else
				$tbl .= "
				<tr style=\"background-color:#ffffff;\">
					<td style=\"padding-left:50px;border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"7\">Your report is empty.</td>
				</tr>";

			$tbl .= "
			</table>".
			$this->form->close_form();						
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			
			
			global $stateNames,$states;
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			$result = $this->db->query("SELECT `state`
										FROM `".DB_PREFIX."tax_table`
										WHERE ISNULL(`local`) OR `local` = ''");
			while ($row = $this->db->fetch_assoc($result)) {
				$tax_state[] = $stateNames[array_search($row['state'],$states)];			
				$tax_abbrev[] = $row['state'];
			}
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_sales_tax');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_sales_tax','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Sales Tax Liability Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",
																    array("This Month",
																    	  "Last Month",
																    	  "This Quarter",
																    	  "Last Quarter",
																    	  "This Period",
																    	  "Last Period",
																    	  "This Year",
																    	  "Last Year",
																    	  "A specific date range"),
																	$this->current_report['timeframe'],
																	array(1,
																		  2,
																		  3,
																		  4,
																		  5,
																		  6,
																		  7,
																		  8,
																		  9),"onChange=if(this.options[this.selectedIndex].value==9){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 9 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 9 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Should the report be<br />filtered to a specific state? </td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->select("tax_state",$tax_state,$this->current_report['tax_state'],$tax_abbrev)."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				

	}


	function customer_name($customer_hash) {
		$result = $this->db->query("SELECT `customer_name`
									FROM `".DB_PREFIX."customers`
									WHERE `customer_hash` = '$customer_hash'");
		$name = $this->db->result($result);
		if (!$name) {
			$result = $this->db->query("SELECT `vendor_name`
										FROM `".DB_PREFIX."vendors`
										WHERE `vendor_hash` = '$customer_hash'");
			$name = $this->db->result($result);
		}
		
		return $name;
	}
	

	function doit_ap() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		$doit_print = $_POST['doit_print'];
		$report_hash = $_POST['report_hash'];
		
		if ($doit_print && $report_hash) {
			$this->fetch_report_settings($report_hash);
			
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$age1 = $this->current_report['age1'];
			$age2 = $this->current_report['age2'];
			$age3 = $this->current_report['age3'];
			$vendor_filter = $this->current_report['vendor_filter'];
			if ($vendor_filter && !is_array($vendor_filter))
				$vendor_filter = array($vendor_filter);
				
			$showdetail = $this->current_report['showdetail'];
			$invoices_paid = $this->current_report['invoices_paid'];
			$report_date = $this->current_report['report_date'];
			$credits = $this->current_report['credits'];
		} else {
			$timeframe = $_POST['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $_POST['sort_from_date'];
				$sort_to_date = $_POST['sort_to_date'];
			}
			$age1 = $_POST['age1'];
			$age2 = $_POST['age2'];
			$age3 = $_POST['age3'];
			$vendor_filter = $_POST['vendor_filter'];
			if ($vendor_filter && !is_array($vendor_filter))
				$vendor_filter = array($vendor_filter);
				
			$showdetail = $_POST['showdetail'];
			$invoices_paid = $_POST['invoices_paid'];
			$report_date = $_POST['report_date'];
			$credits = $_POST['credits'];
		}		
		if ($from_report = $_POST['from_report']) {
			$this->fetch_report_settings($report_hash);
                			
			$vendor_filter = $this->current_report['vendor_filter'];
			if ($vendor_filter && !is_array($vendor_filter))
				$vendor_filter = array($vendor_filter);
				
			$timeframe = $this->current_report['timeframe'];
			if ($timeframe == 5) {
				$sort_from_date = $this->current_report['sort_from_date'];
				$sort_to_date = $this->current_report['sort_to_date'];
			}
			$age1 = $this->current_report['age1'];
			$age2 = $this->current_report['age2'];
			$age3 = $this->current_report['age3'];
            $invoices_paid = $this->current_report['invoices_paid'];
            $report_date = $this->current_report['report_date'];
            $credits = $this->current_report['credits'];
		}
		
		$save = $_POST['save'];
		$saved_cat = "ap_report";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if (($timeframe == 5 && $sort_to_date && $sort_from_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you select a valid date range.";
		}
		if (!$age1 || !$age2 || !$age3 || $age3 < $age2 || $age3 < $age1 || $age2 < $age1 || strspn($age1,"0123456789") != strlen($age1) || strspn($age2,"0123456789") != strlen($age2) || strspn($age3,"0123456789") != strlen($age3) || $age1 <= 0 || $age2 <= 0 || $age3 <= 0) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "Please enter valid aging schedules. Each of the 3 schedules must be specified and Age 3 must be greater than Age 2, Age 2 greater than Age 1, etc.";
		}		
		
		if ($this->content['error'])
			return;
			
        if (is_array($vendor_filter) && count($vendor_filter)) {
            $vendor_filter = array_unique($vendor_filter);
            $vendor_filter = array_values($vendor_filter);
            array_walk($vendor_filter,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."vendor_payables.vendor_hash IN (".implode(" , ",$vendor_filter).")";
            array_walk($vendor_filter,'strip_quotes');
        }			
			
		switch ($timeframe) {
			case 1:
			$sql_p[] = "YEAR($report_date) = '".date("Y")."'";
			$sql_p_sub[] = "((!ISNULL(".DB_PREFIX."vendor_payment.posting_date) AND YEAR(".DB_PREFIX."vendor_payment.posting_date) <= '".date("Y")."') OR YEAR(FROM_UNIXTIME(".DB_PREFIX."vendor_payment.timestamp)) <= '".date("Y")."')";
			$this->report_title = " dated this year";
			break;

			case 2:
			$sql_p[] = "YEAR($report_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
            $sql_p_sub[] = "((!ISNULL(".DB_PREFIX."vendor_payment.posting_date) AND YEAR(".DB_PREFIX."vendor_payment.posting_date) <= '".date("Y",strtotime(date("Y-m-d")." -1 year"))."') OR YEAR(FROM_UNIXTIME(".DB_PREFIX."vendor_payment.timestamp)) <= '".date("Y",strtotime(date("Y-m-d")." -1 year"))."')";
			$compare_date = date("Y-12-31",strtotime(date("Y-m-d")." -1 year"));
            $this->report_title = " dated last year";
			break;
			
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$sql_p[] = $report_date." BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
	            $sql_p_sub[] = "((!ISNULL(".DB_PREFIX."vendor_payment.posting_date) AND ".DB_PREFIX."vendor_payment.posting_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."') OR ".DB_PREFIX."vendor_payment.timestamp BETWEEN '".strtotime($period_info['period_start'])."' AND '".strtotime($period_info['period_end'])."')";
				$this->report_title = " dated within the current period";
			} else {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
                return;
		    }
			break;
			
			case 4:
			$period_info = get_period_info(date("Y-m-d"));
			$previos_period_date = date("Y-m-d",strtotime($period_info['period_start']." -1 day"));
			
			$period_info = get_period_info($previos_period_date);
            if ($period_info['period_start']) {			
				$sql_p[] = $report_date." BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
	            $sql_p_sub[] = "((!ISNULL(".DB_PREFIX."vendor_payment.posting_date) AND ".DB_PREFIX."vendor_payment.posting_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."') OR ".DB_PREFIX."vendor_payment.timestamp BETWEEN '".strtotime($period_info['period_start'])."' AND '".strtotime($period_info['period_end'])."')";
				$compare_date = date("Y-m-d",strtotime($period_info['period_end']));
	            $this->report_title = " dated last period";
            } else {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
                return;
            }
            break;
			
			case 5:
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = $report_date." BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
                $sql_p_sub[] = "((!ISNULL(".DB_PREFIX."vendor_payment.posting_date) AND ".DB_PREFIX."vendor_payment.posting_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."') OR ".DB_PREFIX."vendor_payment.timestamp BETWEEN '".strtotime($sort_from_date)."' AND '".strtotime($sort_to_date)."')";
			    if (strtotime($sort_to_date) < strtotime(date("Y-m-d")))			    
                    $compare_date = date("Y-m-d",strtotime($sort_to_date));
			 
                $this->report_title = " dated between ".date(DATE_FORMAT,strtotime($sort_from_date))." and ".date(DATE_FORMAT,strtotime($sort_to_date));
			} elseif (!$sort_to_date && $sort_from_date) {
				$sql_p[] = $report_date." >= '".$sort_from_date."'";
                $sql_p_sub[] = "((!ISNULL(".DB_PREFIX."vendor_payment.posting_date) AND ".DB_PREFIX."vendor_payment.posting_date >= '".$sort_from_date."') OR ".DB_PREFIX."vendor_payment.timestamp >= '".strtotime($sort_from_date)."')";
			    $this->report_title = " dated on or after ".date(DATE_FORMAT,strtotime($sort_from_date));
			} elseif ($sort_to_date && !$sort_from_date) {
				$sql_p[] = $report_date." <= '".$sort_to_date."'";
                $sql_p_sub[] = "((!ISNULL(".DB_PREFIX."vendor_payment.posting_date) AND ".DB_PREFIX."vendor_payment.posting_date <= '".$sort_to_date."') OR ".DB_PREFIX."vendor_payment.timestamp <= '".strtotime($sort_to_date)."')";
                if (strtotime($sort_to_date) < strtotime(date("Y-m-d")))                
                    $compare_date = date("Y-m-d",strtotime($sort_to_date));
                    
                $this->report_title = " dated on or before ".date(DATE_FORMAT,strtotime($sort_to_date));
			} elseif (!$sort_from_date && !$sort_to_date)
                unset($timeframe);
			
            break;
            
            default:
                $this->report_title = " dated as of ".date(DATE_FORMAT);            
		}
		if ($invoices_paid == 1) {
		    $sql_p[] = "(((".DB_PREFIX."vendor_payables.type = 'I' OR ".DB_PREFIX."vendor_payables.type = 'R' OR ".DB_PREFIX."vendor_payables.type = 'D') AND ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid) OR (!ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid) AND ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid != 0))".($credits ? " OR (".DB_PREFIX."vendor_payables.type = 'C' AND ".DB_PREFIX."vendor_payables.balance = 0) " : NULL).")";
            $sql_p_sub_alt = "(((".DB_PREFIX."vendor_payables.type = 'I' OR ".DB_PREFIX."vendor_payables.type = 'R' OR ".DB_PREFIX."vendor_payables.type = 'D') AND ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid) OR (!ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid) AND ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid != 0))".($credits ? " OR (".DB_PREFIX."vendor_payables.type = 'C' AND ".DB_PREFIX."vendor_payables.balance = 0) " : NULL).")";
		    $this->report_title = "Unpaid invoices".$this->report_title;
		}
		if ($invoices_paid == 2) {
            $sql_p[] = DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid <= 0";
		    $sql_p_sub_alt = DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid <= 0";
		    $this->report_title = "Invoices paid in full".$this->report_title;
		}
		if ($sql_p) 
		    $sql = implode(" AND ",$sql_p);
	       
		if ($sql_p_sub)
		    $sql_sub = implode(" AND ",$sql_p_sub)." AND ";
			
		$str = "timeframe=$timeframe|sort_from_date=$sort_from_date|showdetail=$showdetail|sort_to_date=$sort_to_date|age1=$age1|age2=$age2|age3=$age3|vendor_filter=".@implode("&",$vendor_filter)."|invoices_paid=$invoices_paid|report_date=$report_date|credits=$credits";	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;
		
		$result = $this->db->query("SELECT ".DB_PREFIX."vendor_payables.invoice_hash , ".DB_PREFIX."vendor_payables.invoice_no , ".DB_PREFIX."vendor_payables.receipt_date , 
									".DB_PREFIX."vendor_payables.invoice_date , ".DB_PREFIX."vendor_payables.due_date , ".DB_PREFIX."vendor_payables.vendor_hash , ".DB_PREFIX."vendor_payables.po_hash , 
									".DB_PREFIX."vendor_payables.type , ".DB_PREFIX."purchase_order.po_no , ".DB_PREFIX."vendor_payables.amount , ".DB_PREFIX."vendor_payables.balance , ".DB_PREFIX."purchase_order.proposal_hash , ".DB_PREFIX."purchase_order.po_product ,
									".DB_PREFIX."vendors.vendor_name , ".DB_PREFIX."vendor_payment.total_amount_paid ,
									CASE 
									WHEN ISNULL(".DB_PREFIX."vendors.vendor_name)
									    THEN ".DB_PREFIX."customers.customer_name
									    ELSE 0
									END AS customer_name ,
									(SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ".DB_PREFIX."vendor_payables.due_date ) <= 0 AND (".DB_PREFIX."vendor_payables.type = 'I' OR ".DB_PREFIX."vendor_payables.type = 'R') ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid)
									                THEN ".DB_PREFIX."vendor_payables.amount
									                ELSE ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid
									             END)
									        ELSE 0
									    END) - 
									SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ".DB_PREFIX."vendor_payables.due_date ) <= 0 AND (".DB_PREFIX."vendor_payables.type = 'D') ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid)
									                THEN ".DB_PREFIX."vendor_payables.amount
									                ELSE ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid
									             END)
									        ELSE 0
									    END)
									) AS balance_current ,
									(SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ".DB_PREFIX."vendor_payables.due_date ) BETWEEN 1 AND ".($age1 - 1)." AND (".DB_PREFIX."vendor_payables.type = 'I' OR ".DB_PREFIX."vendor_payables.type = 'R') ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid)
									                THEN ".DB_PREFIX."vendor_payables.amount
									                ELSE ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid
									             END)
									        ELSE 0
									    END) - 
									SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ".DB_PREFIX."vendor_payables.due_date ) BETWEEN 1 AND ".($age1 - 1)." AND (".DB_PREFIX."vendor_payables.type = 'D') ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid)
									                THEN ".DB_PREFIX."vendor_payables.amount
									                ELSE ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid
									             END)
									        ELSE 0
									    END)
									) AS balance_sched1 ,
									(SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ".DB_PREFIX."vendor_payables.due_date ) BETWEEN $age1 AND ".($age2 - 1)." AND (".DB_PREFIX."vendor_payables.type = 'I' OR ".DB_PREFIX."vendor_payables.type = 'R') ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid)
									                THEN ".DB_PREFIX."vendor_payables.amount
									                ELSE ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid
									             END)
									        ELSE 0
									    END) - 
									SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ".DB_PREFIX."vendor_payables.due_date ) BETWEEN $age1 AND ".($age2 - 1)." AND (".DB_PREFIX."vendor_payables.type = 'D') ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid)
									                THEN ".DB_PREFIX."vendor_payables.amount
									                ELSE ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid
									             END)
									        ELSE 0
									    END)
									) AS balance_sched2 ,
									(SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ".DB_PREFIX."vendor_payables.due_date ) >= $age2 AND (".DB_PREFIX."vendor_payables.type = 'I' OR ".DB_PREFIX."vendor_payables.type = 'R') ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid)
									                THEN ".DB_PREFIX."vendor_payables.amount
									                ELSE ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid
									             END)
									        ELSE 0
									    END) - 
									SUM(CASE
									    WHEN DATEDIFF( ".($compare_date ? "'".$compare_date."'" : "CURDATE( )")." , ".DB_PREFIX."vendor_payables.due_date ) >= $age2 AND (".DB_PREFIX."vendor_payables.type = 'D') ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid)
									                THEN ".DB_PREFIX."vendor_payables.amount
									                ELSE ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid
									             END)
									        ELSE 0
									    END)
									) AS balance_sched3 ,
									(SUM(CASE
									    WHEN (".DB_PREFIX."vendor_payables.type = 'I' OR ".DB_PREFIX."vendor_payables.type = 'R') ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid)
									                THEN ".DB_PREFIX."vendor_payables.amount
									                ELSE ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid
									             END)
									        ELSE 0
									    END) - 
									SUM(CASE
									    WHEN (".DB_PREFIX."vendor_payables.type = 'D') ".($sql_p_sub_alt ? "AND ".$sql_p_sub_alt : NULL)."
									        THEN (CASE 
									             WHEN ISNULL(".DB_PREFIX."vendor_payment.total_amount_paid)
									                THEN ".DB_PREFIX."vendor_payables.amount
									                ELSE ".DB_PREFIX."vendor_payables.amount - ".DB_PREFIX."vendor_payment.total_amount_paid
									             END)
									        ELSE 0
									    END)
									) AS balance_total 
									FROM ".DB_PREFIX."vendor_payables
									LEFT JOIN ".DB_PREFIX."purchase_order ON ".DB_PREFIX."purchase_order.po_hash = ".DB_PREFIX."vendor_payables.po_hash
									LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."vendor_payables.vendor_hash
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."vendor_payables.vendor_hash
									LEFT JOIN ( SELECT invoice_hash , 
									            (CASE
									             WHEN !ISNULL(payment_amount)
									                THEN SUM(payment_amount)
									                ELSE 0
									             END +
									             CASE
									             WHEN !ISNULL(deposit_used)
									                THEN SUM(deposit_used)
									                ELSE 0
									             END +
									             CASE
									             WHEN !ISNULL(discount_taken)
									                THEN SUM(discount_taken)
									                ELSE 0
									             END +
									             CASE
									             WHEN !ISNULL(credit_used)
									                THEN SUM(credit_used)
									                ELSE 0
									             END ) AS total_amount_paid
									             FROM ".DB_PREFIX."vendor_payment
									             LEFT JOIN ".DB_PREFIX."check_register ON ".DB_PREFIX."check_register.check_no = ".DB_PREFIX."vendor_payment.check_no
									             WHERE ".($sql_sub ? $sql_sub : NULL).DB_PREFIX."check_register.void = 0
									             GROUP BY invoice_hash 
									           ) AS ".DB_PREFIX."vendor_payment ON ".DB_PREFIX."vendor_payment.invoice_hash = ".DB_PREFIX."vendor_payables.invoice_hash".($sql ? "
									WHERE ".$sql : NULL)."
									GROUP BY ".DB_PREFIX."vendor_payables.invoice_hash
									ORDER BY ".DB_PREFIX."vendor_payables.invoice_date ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			$result_list[$row['vendor_hash']][$row['po_hash']][] = $row;
			$sort_list[$row['vendor_hash']] = ($row['vendor_name'] ? $row['vendor_name'] : $row['customer_name']);
		}
		//Asending order					
		@asort($sort_list);	
		if (is_array($sort_list)) {
			while (list($hash,$name) = each($sort_list)) 
				$this->results[$hash] =& $result_list[$hash];
			
		}				
		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';
		
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->ap_report(1);
		return;
	}

	function ap_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"9\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Accounts Payable Report")."
                            <span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
                                [<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','ap_report','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
                            </span>								
							<div style=\"margin-left:15px;margin-top:10px;margin-bottom:10px;font-size:10pt;\">".$this->report_title."</div>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:5px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=ap_report','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:200px;text-align:left;padding:5px 5px 5px 50px;\">Invoice No.</td>
					<td style=\"width:100px;padding:5px;\">Invoice Date</td>
					<td style=\"width:100px;padding:5px;\">Due Date</td>
                    <td style=\"width:100px;padding:5px;\" class=\"num_field\">Orig Amt</td>
                    <td style=\"width:100px;padding:5px;\" class=\"num_field\">Balance</td>
                    <td style=\"width:100px;padding:5px;\" class=\"num_field\">Current</td>
                    <td style=\"width:100px;padding:5px;\" class=\"num_field\">".$this->current_report['age1']." Days</td>
                    <td style=\"width:100px;padding:5px;\" class=\"num_field\">".$this->current_report['age2']." Days</td>
                    <td style=\"width:100px;padding:5px;\" class=\"num_field\">".$this->current_report['age3']." Days</td>
				</tr>";
				
			$customers = new customers($this->current_hash);
			$vendors = new vendors($this->current_hash);
            
			if (is_array($this->results)) {
				$k = 0;
				while (list($vendor_hash,$invoice_array) = each($this->results)) {
					$total_invoice = $total_balance = $total_current = $total_sched1 = $total_sched2 = $total_sched3 = 0;
					reset($invoice_array);
					$current = current($invoice_array);
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"3\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($current[0]['vendor_name'] ? $current[0]['vendor_name'] : $current[0]['customer_name'])."</td>
                        <td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? "Amount" : "&nbsp;")."</td>
                        <td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? "Balance" : "&nbsp;")."</td>
                        <td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? "Current" : "&nbsp;")."</td>
						<td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? ACCOUNT_AGING_SCHED1." Days" : "&nbsp;")."</td>
						<td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? ACCOUNT_AGING_SCHED2." Days" : "&nbsp;")."</td>
						<td class=\"num_field\" style=\"font-weight:bold;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;\">".($k > 0 ? ACCOUNT_AGING_SCHED3." Days" : "&nbsp;")."</td>
					</tr>";
					$k++;
					while (list($po_hash,$details) = each($invoice_array)) {
						if ($this->current_report['showdetail'] == 2) 
							$tbl .= "
							<tr>
								<td colspan=\"9\" style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;\">".($po_hash ? "
								    Purchase Order: <a href=\"javascript:void(0);\" onClick=\"agent.call('purchase_order','sf_loadcontent','show_popup_window','edit_po','po_hash=".$po_hash."','proposal_hash=".$details[0]['proposal_hash']."','popup_id=line_item');\" class=\"link_standard\">".$details[0]['po_no']."</a>".($details[0]['po_product'] ? " - ".$details[0]['po_product'] : NULL) : NULL)."
								  </td>
							</tr>";
							
						for ($i = 0; $i < count($details); $i++) {
                            if ($details[$i]['type'] == 'I' || $details[$i]['type'] == 'R') {
                                $balance = $details[$i]['balance_current'] + $details[$i]['balance_sched1'] + $details[$i]['balance_sched2'] + $details[$i]['balance_sched3'];
                                $total_balance += $balance;
                                $total_invoice += $details[$i]['amount'] + $details[$i]['total_amount_paid'];
                            } elseif ($details[$i]['type'] == 'D' || $details[$i]['type'] == 'C') {
                                $balance = $details[$i]['amount'];
                                $total_balance += ($balance * -1);
                                $total_invoice += ($details[$i]['amount'] * -1);
                            }							
							
                            $total_current += $details[$i]['balance_current'];
							$total_sched1 += $details[$i]['balance_sched1'];
							$total_sched2 += $details[$i]['balance_sched2'];
							$total_sched3 += $details[$i]['balance_sched3'];
							
							if ($this->current_report['showdetail'] == 2)
								$tbl .= "
								<tr>
									<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('payables','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$details[$i]['invoice_hash']."','popup_id=line_item');\" class=\"link_standard\">".($details[$i]['type'] == 'I' ? "Invoice: " : ($details[$i]['type'] == 'D' ? "Vendor Deposit: " : ($details[$i]['type'] == 'C' ? "Vendor Credit: " : "Customer Refund: "))).$details[$i]['invoice_no']."</a></td>
									<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($details[$i]['invoice_date']))."</td>
									<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($details[$i]['due_date']))."</td>
                                    <td style=\"background-color:#ffffff;font-size:8pt;".(($details[$i]['type'] == 'I' && $details[$i]['amount'] < 0) || ($details[$i]['type'] == 'C' && $details[$i]['amount'] > 0) || ($details[$i]['type'] == 'D' && $details[$i]['amount'] > 0) ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(($details[$i]['type'] == 'I' && $details[$i]['amount'] < 0) || ($details[$i]['type'] == 'C' && $details[$i]['amount'] > 0) || ($details[$i]['type'] == 'D' && $details[$i]['amount'] > 0) ?
								        "($".number_format(($details[$i]['type'] == 'I' ? ($details[$i]['amount'] * -1) : $details[$i]['amount']),2).")" : "$".number_format(($details[$i]['type'] == 'C' || $details[$i]['type'] == 'D' ? ($details[$i]['amount'] * -1) : $details[$i]['amount']),2))."
								    </td>
									<td style=\"background-color:#ffffff;font-size:8pt;".(($details[$i]['type'] == 'I' && $balance < 0) || ($details[$i]['type'] == 'C' && $balance > 0) || ($details[$i]['type'] == 'D' && $balance > 0) ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".(($details[$i]['type'] == 'I' && $balance < 0) || ($details[$i]['type'] == 'C' && $balance > 0) || ($details[$i]['type'] == 'D' && $balance > 0) ? 
								        "($".number_format(($details[$i]['type'] == 'I' ? ($balance * -1) : $balance),2).")" : "$".number_format($balance,2))."									
									</td>
									<td style=\"background-color:#ffffff;font-size:8pt;".($details[$i]['balance_current'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details[$i]['balance_current'] != 0 ? 
										($details[$i]['balance_current'] < 0 ? 
											"($".number_format($details[$i]['balance_current'] * -1,2).")" : "$".number_format($details[$i]['balance_current'],2)) : NULL)."
									</td>
									<td style=\"background-color:#ffffff;font-size:8pt;".($details[$i]['balance_sched1'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details[$i]['balance_sched1'] != 0 ? 
										($details[$i]['balance_sched1'] < 0 ? 
											"($".number_format($details[$i]['balance_sched1'] * -1,2).")" : "$".number_format($details[$i]['balance_sched1'],2)) : NULL)."
									</td>
									<td style=\"background-color:#ffffff;font-size:8pt;".($details[$i]['balance_sched2'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details[$i]['balance_sched2'] != 0 ? 
										($details[$i]['balance_sched2'] < 0 ? 
											"($".number_format($details[$i]['balance_sched2'] * -1,2).")" : "$".number_format($details[$i]['balance_sched2'],2)) : NULL)."
									</td>
									<td style=\"background-color:#ffffff;font-size:8pt;".($details[$i]['balance_sched3'] < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($details[$i]['balance_sched3'] != 0 ?
										($details[$i]['balance_sched3'] < 0 ? 
											"($".number_format($details[$i]['balance_sched3'] * -1,2).")" : "$".number_format($details[$i]['balance_sched3'],2)) : NULL)."
									</td>
								</tr>";
						}
					}					
					$grand_total['invoice'] += $total_invoice;
					$grand_total['balance'] += $total_balance;
					$grand_total['current'] += $total_current;
					$grand_total['sched1'] += $total_sched1;
					$grand_total['sched2'] += $total_sched2;
					$grand_total['sched3'] += $total_sched3;
					
					$tbl .= "
					<tr>
						<td style=\"font-size:8pt;background-color:#ffffff;padding-top:8px;\" colspan=\"3\"></td>
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:8px;".($total_invoice < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                            <div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_invoice < 0 ?
					            "($".number_format($total_invoice * -1,2).")" : "$".number_format($total_invoice,2))."
                            </div>
                        </td>
						<td style=\"font-size:8pt;background-color:#ffffff;padding-top:8px;".($total_balance < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
						    <div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_balance < 0 ? 
					            "($".number_format($total_balance*-1,2).")" : "$".number_format($total_balance,2))."
						    </div>
						</td>
						<td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_current < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_current != 0 ? "
							<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_current < 0 ? 
								"($".number_format($total_current * -1,2).")" : "$".number_format($total_current,2))."
							</div>" : NULL)."
						</td>
						<td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched1 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_sched1 != 0 ? "
							<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_sched1 < 0 ? 
								"($".number_format($total_sched1 * -1,2).")" : "$".number_format($total_sched1,2))."
							</div>" : NULL)."
						</td>
						<td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched2 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_sched2 != 0 ? "
							<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_sched2 < 0 ? 
								"($".number_format($total_sched2 * -1,2).")" : "$".number_format($total_sched2,2))."
							</div>" : NULL)."
						</td>
						<td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched3 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">".($total_sched3 != 0 ? "
							<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">".($total_sched3 < 0 ? 
								"($".number_format($total_sched3 * -1,2).")" : "$".number_format($total_sched3,2))."
							</div>" : NULL)."
						</td>
					</tr>";
						
				}
			}
			$grand_total_all = $grand_total['current'] + $grand_total['sched1'] + $grand_total['sched2'] + $grand_total['sched3'];
			
			$tbl .= "
                    <tr>
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:8px;\" colspan=\"3\"></td>
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:8px;\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">
                                $".number_format($grand_total['invoice'],2)."
                            </div>
                        </td>
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:8px;\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['balance'] < 0 ? 
                                "($".number_format($grand_total['balance']*-1).")" : "$".number_format($grand_total['balance'],2))."
                            </div>
                        </td>
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_current < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['current'] < 0 ? 
                                "($".number_format($grand_total['current'] * -1,2).")" : "$".number_format($grand_total['current'],2))."
                            </div>
                        </td>
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched1 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['sched1'] < 0 ? 
                                "($".number_format($grand_total['sched1'] * -1,2).")" : "$".number_format($grand_total['sched1'],2))."
                            </div>
                        </td>
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched2 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['sched2'] < 0 ? 
                                "($".number_format($grand_total['sched2'] * -1,2).")" : "$".number_format($grand_total['sched2'],2))."
                            </div>
                        </td>
                        <td style=\"font-size:8pt;background-color:#ffffff;padding-top:5px;".($total_sched3 < 0 ? "color:#ff0000;" : NULL)."\" class=\"num_field\">
                            <div style=\"border-top:1px dashed #000000;font-weight:bold;width:90%;padding-top:5px;\">".($grand_total['sched3'] < 0 ? 
                                "($".number_format($grand_total['sched3'] * -1,2).")" : "$".number_format($grand_total['sched3'],2))."
                            </div>
                        </td>
                    </tr>
			</table>";
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			array_shift($this->user_name);
			array_shift($this->user_hash);			

			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_ap');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_ap','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Accounts Payable Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",array("All invoice dates","Invoices dated this year","Invoices dated last year","Invoices from the current period","Invoices from the previous period","A specific date range"),$this->current_report['timeframe'],array('*',1,2,3,4,5),"onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">How should the aging<br />schedule be shown?</td>
											<td style=\"background-color:#ffffff;\">	
												".$this->form->text_box("name=age1","value=".($this->current_report['age1'] ? $this->current_report['age1'] : ACCOUNT_AGING_SCHED1),"size=3","style=text-align:right;padding-right:5px;")." days
												<br />
												".$this->form->text_box("name=age2","value=".($this->current_report['age2'] ? $this->current_report['age2'] : ACCOUNT_AGING_SCHED2),"size=3","style=text-align:right;padding-right:5px;")." days
												<br />
												".$this->form->text_box("name=age3","value=".($this->current_report['age3'] ? $this->current_report['age3'] : ACCOUNT_AGING_SCHED3),"size=3","style=text-align:right;padding-right:5px;")." days
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','vendor','vendor_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++) 
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Include Vendor Credits?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->checkbox("name=credits","value=1",($this->current_report['credits'] ? "checked" : NULL))."
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Should the report reflect<br />paid or unpaid invoices?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("invoices_paid",array("Show invoices that are unpaid","Show invoices that are paid in full"),$this->current_report['invoices_paid'],array('1','2'),"blank=1")."
                                            </td>
                                        </tr>                                       
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Which date should the report<br />use to generate its results?</td>
                                            <td style=\"background-color:#ffffff;padding-top:10px;\">
                                                ".$this->form->select("report_date",
											                          array("Invoice Date","Due Date","Receipt Date"),
											                          ($this->current_report['report_date'] ? $this->current_report['report_date'] : DB_PREFIX."vendor_payables.due_date"),
											                          array(DB_PREFIX."vendor_payables.invoice_date",DB_PREFIX."vendor_payables.due_date",DB_PREFIX."vendor_payables.receipt_date"),
											                          "blank=1")."
                                            </td>
                                        </tr>                                                                               
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail",array("Show Detail View","Show Simple View"),$this->current_report['showdetail'],array('2','1'),"blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}

	function doit_cash_requirements() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		
		if ($doit_print && $report_hash) {
			$this->fetch_report_settings($report_hash);
			
			$sched_start_date = $this->current_report['sched_start_date'];
			$vendor_filter = $this->current_report['vendor_filter'];
			$showdetail = $this->current_report['showdetail'];
			$day_schedule = ereg_replace("[^.0-9]", "",$this->current_report['day_schedule']);
			$showdiscounts = $this->current_report['showdiscounts'];
			if ($vendor_filter && !is_array($vendor_filter))
				$vendor_filter = array($vendor_filter);
		} else {
			$sched_start_date = $_POST['sched_start_date'];
			$vendor_filter = $_POST['vendor_filter'];
			$showdetail = $_POST['showdetail'];
			$day_schedule = ereg_replace("[^.0-9]", "",$_POST['day_schedule']);
			$showdiscounts = $_POST['showdiscounts'];
		}
		
		$save = $_POST['save'];
		$saved_cat = "cash_requirements";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if ($this->content['error'])
			return;
		
		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."vendor_payables.vendor_hash IN (".implode(" , ",$vendor_filter).")";
			array_walk($vendor_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = " AND ".implode(" AND ",$sql_p);
		
		$str = "sched_start_date=$sched_start_date|showdetail=$showdetail|showdiscounts=$showdiscounts|day_schedule=".$day_schedule."|sort_to_date=$sort_to_date|vendor_filter=".@implode("&",$vendor_filter);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;	
		$sched = $day_schedule;	
		for ($i = 1; $i <= 3; $i++) {
			$this->schedule[$i] = strtotime($sched_start_date." +".$sched." days");
			$sched += $day_schedule;
		}
		$result = $this->db->query("SELECT ".DB_PREFIX."vendor_payables.invoice_hash , ".DB_PREFIX."vendor_payables.invoice_no , ".DB_PREFIX."vendor_payables.amount , 
									".DB_PREFIX."vendor_payables.balance , ".DB_PREFIX."vendor_payables.invoice_date , ".DB_PREFIX."vendor_payables.due_date , ".DB_PREFIX."vendor_payables.vendor_hash , 
									".DB_PREFIX."vendor_payables.type , ".DB_PREFIX."vendors.vendor_name as vendor_name , ".DB_PREFIX."vendors.discount_days , ".DB_PREFIX."vendors.payment_discount ,
								    CASE 
								    WHEN ISNULL(".DB_PREFIX."vendors.vendor_name)
									  	THEN ".DB_PREFIX."customers.customer_name
									  	ELSE 0
								   	END AS customer_name
									FROM ".DB_PREFIX."vendor_payables
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."vendor_payables.vendor_hash
									LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."vendor_payables.vendor_hash
									WHERE ".DB_PREFIX."vendor_payables.balance > 0 ".($sql ? $sql : NULL)."
									GROUP BY ".DB_PREFIX."vendor_payables.invoice_hash");
		while ($row = $this->db->fetch_assoc($result)) {
			$result_list[$row['vendor_hash']][] = $row;
			$sort_list[$row['vendor_hash']] = ($row['vendor_name'] ? $row['vendor_name'] : $row['customer_name']);
		}
		//Asending order					
		@asort($sort_list);	
		if (is_array($sort_list)) {
			while (list($hash,$name) = each($sort_list)) 
				$results[$hash] =& $result_list[$hash];
			
		}		
		
		while (list($vendor_hash,$invoice) = each($results)) {
			$pay_schedule = array();
			for ($i = 0; $i < count($invoice); $i++) {
				if ($showdiscounts && $invoice[$i]['discount_days'] && $invoice[$i]['payment_discount']) {
					$due_date = strtotime($invoice[$i]['due_date']." -".$invoice[$i]['discount_days']." days");
					$invoice[$i]['balance'] -= ($invoice[$i]['balance'] * $invoice[$i]['payment_discount']);
				} else
					$due_date = strtotime($invoice[$i]['due_date']);
					
				if ($due_date < ($this->schedule[1] - ($day_schedule * 86400)))
					$pay_schedule[] = array('invoice'	=> $invoice[$i],
											'sched'		=> 'past');
				elseif ($due_date > $this->schedule[3])
					$pay_schedule[] = array('invoice'	=> $invoice[$i],
											'sched'		=> 'future');
				else {
					for ($j = 1; $j <= 3; $j++) {
						if (date("Y-m-d",$due_date) >= date("Y-m-d",($this->schedule[$j] - ($day_schedule * 86400))) && date("Y-m-d",$due_date) <= date("Y-m-d",$this->schedule[$j])) {
							$pay_schedule[] = array('invoice'	=> $invoice[$i],
													'sched'		=> $j);
							break 1;
						}
					}
				}
			}
			$this->results[$vendor_hash] = array("vendor_name"		=>		($invoice[0]['vendor_name'] ? $invoice[0]['vendor_name'] : $invoice[0]['customer_name']),
												 "pay_schedule"		=>		$pay_schedule);
		}
		
				
		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';
		
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->cash_requirements(1);
		return;
	}

	function cash_requirements($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"8\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Cash Requirements Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','cash_requirements','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>							
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=cash_requirements','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:150px;text-align:left;padding:5px 5px 5px 25px;\">Invoice No.</td>
					<td style=\"width:125px;padding:5px;\">Invoice Date</td>
					<td style=\"width:125px;padding:5px;\">Due Date</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Past</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y",$this->schedule[1])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y",$this->schedule[2])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y",$this->schedule[3])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Future</td>
				</tr>";
				
			if (is_array($this->results)) {
				$k = 0;
				while (list($vendor_hash,$invoice_array) = each($this->results)) {
					$tbl_past = $tbl_sched1 = $tbl_sched2 = $tbl_sched3 = $tbl_future = '';
					$total_past = $total_sched1 = $total_sched2 = $total_sched3 = $total_future = 0;
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"8\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">".$invoice_array['vendor_name']."</td>
					</tr>";
						
					for ($i = 0; $i < count($invoice_array['pay_schedule']); $i++) {
						$invoice_amt = array();
						switch ($invoice_array['pay_schedule'][$i]['sched']) {
							case 'past':
							$total_past += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['past'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
							
							case '1':
							$total_sched1 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched1'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
							
							case '2':
							$total_sched2 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched2'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
							
							case '3':
							$total_sched3 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched3'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
							
							case 'future':
							$total_future += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['future'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
						}
						if ($this->current_report['showdetail'] == 2)
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('payables','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$invoice_array['pay_schedule'][$i]['invoice']['invoice_hash']."','popup_id=line_item');\" class=\"link_standard\">".($invoice_array['pay_schedule'][$i]['invoice']['type'] == 'I' ? "Invoice: " : ($invoice_array['pay_schedule'][$i]['invoice']['type'] == 'D' ? "Vendor Deposit: " : "Customer Refund: ")).$invoice_array['pay_schedule'][$i]['invoice']['invoice_no']."</a></td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($invoice_array['pay_schedule'][$i]['invoice']['invoice_date']))."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($invoice_array['pay_schedule'][$i]['invoice']['due_date']))."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['past'] != 0 ? 
									"$".number_format($invoice_amt['past'],2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['sched1'] != 0 ? 
									"$".number_format($invoice_amt['sched1'],2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['sched2'] != 0 ? 
									"$".number_format($invoice_amt['sched2'],2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['sched3'] != 0 ? 
									"$".number_format($invoice_amt['sched3'],2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['future'] != 0 ? 
									"$".number_format($invoice_amt['future'],2) : NULL)."
								</td>
							</tr>";
					}
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;\" colspan=\"3\">
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_past != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_past,2)."

							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched1 != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sched1,2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched2 != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sched2,2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched3 != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sched3,2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_future != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_future,2)."
							</div>" : NULL)."
						</td>
					</tr>";
					
					$grand_total['past'] += $total_past;
					$grand_total['sched1'] += $total_sched1;
					$grand_total['sched2'] += $total_sched2;
					$grand_total['sched3'] += $total_sched3;
					$grand_total['future'] += $total_future;
				}
				$tbl .= "
				<tr style=\"background-color:#efefef;\">
					<td colspan=\"3\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">&nbsp;</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['past'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['past'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sched1'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sched1'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sched2'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sched2'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sched3'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sched3'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['future'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['future'],2)."
						</div>" : "&nbsp;")."
					</td>
				</tr>";
					
			} else
				$tbl .= "
				<tr>
					<td colspan=\"8\" style=\"\">Your report returned an empty result.</td>
				</tr>";
			
			$tbl .= "
			</table>";
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
			
			for ($i = 1; $i <= 30; $i++) 
				$gen_array[] = $i." day".($i > 1 ? "s" : NULL);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_cash_requirements');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_cash_requirements','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Cash Requirements Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','vendor','vendor_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++) 
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">When should the report<br />start tracking cash requirements?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\" id=\"sched_start_date_holder\">";
												$jscript[] = "setTimeout('DateInput(\'sched_start_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['sched_start_date'] ? $this->current_report['sched_start_date'] : date("Y-m-d"))."\',1,\'sched_start_date_holder\')',500);";
												$tbl .= "													
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">How should the payment<br />schedule be broken down?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("day_schedule",$gen_array,($this->current_report['day_schedule'] ? $this->current_report['day_schedule'] : '15 days'),$gen_array,"blank=1")."
												<div style=\"margin-top:10px;\">
													".$this->form->checkbox("name=showdiscounts","value=1",($this->current_report['showdiscounts'] ? "checked" : NULL))."
													&nbsp;
													Show opportunities to take discounts?
												</div>	
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail",array("Show Detail View","Show Simple View"),$this->current_report['showdetail'],array('2','1'),"blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}

	function doit_cash_flow_exp() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}

		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		
		if ($report_hash && $doit_print) {
			$this->fetch_report_settings($report_hash); 
			$sched_start_date = $this->current_report['sched_start_date'];
			$showdetail = $this->current_report['showdetail'];
			$day_schedule = $this->current_report['day_schedule'];
			
			$customer_filter = $this->current_report['customer_vendor_filter'];
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
				
			$showdetail = $this->current_report['showdetail'];			
			
		} else {
			$sched_start_date = $_POST['sched_start_date'];
			$customer_filter = $_POST['customer_vendor_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);			
			
			$showdetail = $_POST['showdetail'];
			$day_schedule = ereg_replace("[^.0-9]", "",$_POST['day_schedule']);
		
			$report_hash = $_POST['report_hash'];
			$save = $_POST['save'];
			$saved_cat = "cash_flow_exp";
			$report_name = $_POST['report_name'];
			$report_descr = $_POST['report_descr'];
			$share = $_POST['share'];
			$sales_rep_share = $_POST['sales_rep_share'];
			$group_share = $_POST['group_share'];
		
		}
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if ($this->content['error'])
			return;
		
		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."customer_invoice.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}
		if ($sql_p) 
			$sql = " AND ".implode(" AND ",$sql_p);
		
		$str = "sched_start_date=$sched_start_date|showdetail=$showdetail|day_schedule=".$day_schedule."|customer_filter=".@implode("&",$customer_filter);	
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;	
		$sched = $day_schedule;	
		for ($i = 1; $i <= 3; $i++) {
			$this->schedule[$i] = strtotime($sched_start_date." +".$sched." days");
			$sched += $day_schedule;
		}

		$result = $this->db->query("SELECT ".DB_PREFIX."customer_invoice.invoice_hash , ".DB_PREFIX."customer_invoice.invoice_no , ".DB_PREFIX."customer_invoice.amount , 
									".DB_PREFIX."customer_invoice.balance , ".DB_PREFIX."customer_invoice.invoice_date , ".DB_PREFIX."customer_invoice.customer_hash , ".DB_PREFIX."customer_invoice.customer_hash AS parent_customer_hash , 
									(
										SELECT AVG(DATEDIFF(".DB_PREFIX."customer_payment.receipt_date , ".DB_PREFIX."customer_invoice.invoice_date))
										FROM `".DB_PREFIX."customer_invoice`
										LEFT JOIN `".DB_PREFIX."customer_payment` ON ".DB_PREFIX."customer_payment.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash
										WHERE ".DB_PREFIX."customer_invoice.customer_hash = parent_customer_hash AND ".DB_PREFIX."customer_invoice.type = 'I' AND !ISNULL(".DB_PREFIX."customer_payment.receipt_date)
									) AS avg_pay_days , 
									(
										SELECT COUNT(".DB_PREFIX."customer_payment.receipt_date)
										FROM `".DB_PREFIX."customer_invoice`
										LEFT JOIN ".DB_PREFIX."customer_payment ON ".DB_PREFIX."customer_payment.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash
										WHERE ".DB_PREFIX."customer_invoice.customer_hash = parent_customer_hash AND ".DB_PREFIX."customer_invoice.type = 'I' AND !ISNULL(".DB_PREFIX."customer_payment.receipt_date)
									) AS num_payments ,
									".DB_PREFIX."customers.payment_terms , ".DB_PREFIX."customers.customer_name ,
								    CASE 
								    WHEN ISNULL(".DB_PREFIX."customers.customer_name)
									  	THEN ".DB_PREFIX."vendors.vendor_name
									  	ELSE 0
								   	END AS vendor_name 
									FROM ".DB_PREFIX."customer_invoice
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."customer_invoice.customer_hash
									LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."customer_invoice.customer_hash
									WHERE ".DB_PREFIX."customer_invoice.type = 'I' AND ".DB_PREFIX."customer_invoice.balance > 0 ".($sql ? $sql : NULL)."
									GROUP BY ".DB_PREFIX."customer_invoice.invoice_hash");

		while ($row = $this->db->fetch_assoc($result)) {
			$result_list[$row['customer_hash']][] = $row;
			$sort_list[$row['customer_hash']] = ($row['customer_name'] ? $row['customer_name'] : $row['vendor_name']);
		}
		//Asending order					
		@asort($sort_list);	
		if (is_array($sort_list)) {
			while (list($hash,$name) = each($sort_list)) 
				$results[$hash] =& $result_list[$hash];
			
		}		
		
		while (list($customer_hash,$invoice) = each($results)) {
			$pay_schedule = array();
			for ($i = 0; $i < count($invoice); $i++) {
				$due_date = strtotime($invoice[$i]['invoice_date']." +".($invoice[$i]['payment_terms'] ? $invoice[$i]['payment_terms'] : DEFAULT_CUST_PAY_TERMS)." days");
				$exp_date = strtotime($invoice[$i]['invoice_date']." +".($invoice[$i]['num_payments'] >= 15 && $invoice[$i]['avg_pay_days'] > 0 ? ceil($invoice[$i]['avg_pay_days']) : ($invoice[$i]['payment_terms'] ? $invoice[$i]['payment_terms'] : DEFAULT_CUST_PAY_TERMS))." days");
				$invoice[$i]['exp_date'] = $exp_date;
				$invoice[$i]['due_date'] = $due_date;
				if ($exp_date < ($this->schedule[1] - ($day_schedule * 86400)))
					$pay_schedule[] = array('invoice'	=> $invoice[$i],
											'sched'		=> 'past');
				elseif ($exp_date > $this->schedule[3])
					$pay_schedule[] = array('invoice'	=> $invoice[$i],
											'sched'		=> 'future');
				else {
					for ($j = 1; $j <= 3; $j++) {
						if (date("Y-m-d",$exp_date) >= date("Y-m-d",($this->schedule[$j] - ($day_schedule * 86400))) && date("Y-m-d",$exp_date) <= date("Y-m-d",$this->schedule[$j])) {
							$pay_schedule[] = array('invoice'	=> $invoice[$i],
													'sched'		=> $j);
							break 1;
						}
					}
				}
			}
			$this->results[$customer_hash] = array("customer_name"	=>		($invoice[0]['customer_name'] ? $invoice[0]['customer_name'] : $invoice[0]['vendor_name']),
												 "pay_schedule"		=>		$pay_schedule);
		}
		

		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';
		
		$this->total = count($this->results);
		if (!$doit_print)
			$this->content['html']['place_holder'] = $this->cash_flow_exp(1);
		return;
	}

	function cash_flow_exp($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"9\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Cash Flow Expectations Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','cash_flow_exp','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
						<a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=cash_flow_exp','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:125px;text-align:left;padding:5px 5px 5px 25px;\">Invoice No.</td>
					<td style=\"width:91px;padding:5px;\">Invoice Date</td>
					<td style=\"width:91px;padding:5px;\">Due Date</td>
					<td style=\"width:91px;padding:5px;\">Expected</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Past</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y",$this->schedule[1])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y",$this->schedule[2])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">".date("m/d/y",$this->schedule[3])."</td>
					<td style=\"width:100px;padding:5px;\" class=\"num_field\">Future</td>
				</tr>";
				
			if (is_array($this->results)) {
				$k = 0;
				while (list($customer_hash,$invoice_array) = each($this->results)) {
					$tbl_past = $tbl_sched1 = $tbl_sched2 = $tbl_sched3 = $tbl_future = '';
					$total_past = $total_sched1 = $total_sched2 = $total_sched3 = $total_future = 0;
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"9\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">".$invoice_array['customer_name']."</td>
					</tr>";
						
					for ($i = 0; $i < count($invoice_array['pay_schedule']); $i++) {
						$invoice_amt = array();
						switch ($invoice_array['pay_schedule'][$i]['sched']) {
							case 'past':
							$total_past += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['past'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
							
							case '1':
							$total_sched1 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched1'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
							
							case '2':
							$total_sched2 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched2'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
							
							case '3':
							$total_sched3 += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['sched3'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
							
							case 'future':
							$total_future += $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							$invoice_amt['future'] = $invoice_array['pay_schedule'][$i]['invoice']['balance'];
							break;
						}
						if ($this->current_report['showdetail'] == 2)
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$invoice_array['pay_schedule'][$i]['invoice']['invoice_hash']."','popup_id=line_item');\" class=\"link_standard\">".$invoice_array['pay_schedule'][$i]['invoice']['invoice_no']."</a></td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,strtotime($invoice_array['pay_schedule'][$i]['invoice']['invoice_date']))."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,$invoice_array['pay_schedule'][$i]['invoice']['due_date'])."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".date(DATE_FORMAT,$invoice_array['pay_schedule'][$i]['invoice']['exp_date'])."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['past'] != 0 ? 
									"$".number_format($invoice_amt['past'],2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['sched1'] != 0 ? 
									"$".number_format($invoice_amt['sched1'],2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['sched2'] != 0 ? 
									"$".number_format($invoice_amt['sched2'],2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['sched3'] != 0 ? 
									"$".number_format($invoice_amt['sched3'],2) : NULL)."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($invoice_amt['future'] != 0 ? 
									"$".number_format($invoice_amt['future'],2) : NULL)."
								</td>
							</tr>";
					}
					$tbl .= "
					<tr>
						<td style=\"background-color:#ffffff;\" colspan=\"4\">
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_past != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_past,2)."

							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched1 != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sched1,2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched2 != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sched2,2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_sched3 != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sched3,2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".($total_future != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_future,2)."
							</div>" : NULL)."
						</td>
					</tr>";
					
					$grand_total['past'] += $total_past;
					$grand_total['sched1'] += $total_sched1;
					$grand_total['sched2'] += $total_sched2;
					$grand_total['sched3'] += $total_sched3;
					$grand_total['future'] += $total_future;
				}
				$tbl .= "
				<tr style=\"background-color:#efefef;\">
					<td colspan=\"4\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">&nbsp;</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['past'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['past'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sched1'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sched1'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sched2'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sched2'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sched3'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sched3'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['future'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['future'],2)."
						</div>" : "&nbsp;")."
					</td>
				</tr>";
					
			} else
				$tbl .= "
				<tr>
					<td colspan=\"9\" style=\"background-color:#ffffff;\">Your report returned an empty result.</td>
				</tr>";
			
			$tbl .= "
			</table>";
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
				$this->current_report['customer_filter'] = array($this->current_report['customer_filter']);
			
			for ($i = 1; $i <= 30; $i++) 
				$gen_array[] = $i." day".($i > 1 ? "s" : NULL);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_cash_flow_exp');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_cash_flow_exp','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Cash Flow Expectations Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers or vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer_vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer_vendor','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
														$tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">When should the report<br />start tracking cash expectations?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\" id=\"sched_start_date_holder\">";
												$jscript[] = "setTimeout('DateInput(\'sched_start_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['sched_start_date'] ? $this->current_report['sched_start_date'] : date("Y-m-d"))."\',1,\'sched_start_date_holder\')',500);";
												$tbl .= "													
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">How should the expectation<br />schedule be broken down?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("day_schedule",$gen_array,($this->current_report['day_schedule'] ? $this->current_report['day_schedule'] : '15 days'),$gen_array,"blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail",array("Show Detail View","Show Simple View"),$this->current_report['showdetail'],array('2','1'),"blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	
	function doit_product_sales_report() {
		$date = date("U") - 3600;
		$result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
							  		WHERE `saved` = 0 AND `timestamp` <= '$date'");
		
		if ($_POST['rm'] == 1 && $_POST['report_hash']) {
			$this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
							  FROM `".DB_PREFIX."reports`
							  LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
							  WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
			$this->content['action'] = 'close';
			$this->content['page_feedback'] = "Report has been deleted.";
			$this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
			return;							  
		}
		
		$report_hash = $_POST['report_hash'];
		$doit_print = $_POST['doit_print'];
		
		if ($report_hash && $doit_print) {
			$this->fetch_report_settings($report_hash);
			$timeframe = $this->current_report['timeframe'];	
			$sort_from_date = $this->current_report['sort_from_date'];
			$sort_to_date = $this->current_report['sort_to_date'];
			$customer_filter = $this->current_report['customer_filter'];
			$customer_vendor_filter = $this->current_report['customer_vendor_filter'];		
			$vendor_filter = $this->current_report['vendor_filter'];
			$showdetail = $this->current_report['showdetail'];
			$product_match = $this->current_report['product_match'];
			$sales_rep_match = $this->current_report['sales_rep_match'];	
			if ($customer_filter && !is_array($customer_filter))
				$customer_filter = array($customer_filter);
			if ($customer_vendor_filter && !is_array($customer_vendor_filter))
				$customer_vendor_filter = array($customer_vendor_filter);
			if ($vendor_filter && !is_array($vendor_filter))
				$vendor_filter = array($vendor_filter);
			if ($product_match && !is_array($product_match))
				$product_match = array($product_match);
			if ($sales_rep_match && !is_array($sales_rep_match))
				$sales_rep_match = array($sales_rep_match);
				
		} else {
			$timeframe = $_POST['timeframe'];	
			$sort_from_date = $_POST['sort_from_date'];
			$sort_to_date = $_POST['sort_to_date'];
			$customer_filter = $_POST['customer_filter'];
            if ($customer_filter && !is_array($customer_filter))
                $customer_filter = array($customer_filter);
			$customer_vendor_filter = $_POST['customer_vendor_filter'];	
            if ($customer_vendor_filter && !is_array($customer_vendor_filter))
                $customer_vendor_filter = array($customer_vendor_filter);				
			$vendor_filter = $_POST['vendor_filter'];
            if ($vendor_filter && !is_array($vendor_filter))
                $vendor_filter = array($vendor_filter);			
			$showdetail = $_POST['showdetail'];
			$product_match = $_POST['product_match'];
            if ($product_match && !is_array($product_match))
                $product_match = array($product_match);			
			$sales_rep_match = $_POST['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);			
		}
		if (is_array($customer_vendor_filter)) {
			if (is_array($customer_filter))
				$customer_filter = array_combine($customer_filter,$customer_vendor_filter);
			else
				$customer_filter = $customer_vendor_filter;
				
			$customer_filter = array_values($customer_filter);
		}

		if ($sales_rep_match && $sales_rep_match[0] == '')
			unset($sales_rep_match);
			
	
		$save = $_POST['save'];
		$saved_cat = "cash_flow_exp";
		$report_name = $_POST['report_name'];
		$report_descr = $_POST['report_descr'];
		$share = $_POST['share'];
		$sales_rep_share = $_POST['sales_rep_share'];
		$group_share = $_POST['group_share'];
		
		if ($save && !$report_name) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
		}
		if ($save && !$report_hash) {
			$result = $this->db->query("SELECT COUNT(*) AS Total
										FROM `".DB_PREFIX."reports`
										WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
			if ($this->db->result($result)) {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
			}
		}
		if ($share && !count($sales_rep_share) && !count($group_share)) {
			$this->content['error'] = 1;
			$this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
		}
		
		if ($this->content['error'])
			return;
		
		switch ($timeframe) {
			//This year
			case 1:
			$this->report_title = "Year To Date ".date(DATE_FORMAT,strtotime(date("Y-m-d")));
			$sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y")."'";
			$sub_sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y")."'";
			break;

			//last year
			case 2:
			$this->report_title = "Year Ending ".date("Y",strtotime(date("Y-m-d")." -1 year"));
			$sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			$sub_sql_p[] = "YEAR(".DB_PREFIX."customer_invoice.invoice_date) = '".date("Y",strtotime(date("Y-m-d")." -1 year"))."'";
			break;
			
			//current period
			case 3:
			$period_info = get_period_info(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			//previous period
			case 4:
			$period_info = get_previous_period(date("Y-m-d"));
			if ($period_info['period_start']) {
				$this->report_title = "As of Period - ".date(DATE_FORMAT,strtotime($period_info['period_start']))." thru ".date(DATE_FORMAT,strtotime($period_info['period_end']));
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
				$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$period_info['period_start']."' AND '".$period_info['period_end']."'";
			} else {
				$this->content['error'] = 1;
				$this->content['form_return']['feedback'] = "You have not set up the period layout dates for the period you are trying to report on. Please configure your period closing dates within your Accounting->Business Cycle Settings";
				return;
			}
			break;
			
			case 5:
			if ($sort_from_date && $sort_to_date) {
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".$sort_from_date."' AND '".$sort_to_date."'";
				$this->report_title = date(DATE_FORMAT,strtotime($sort_from_date))." thru ".date(DATE_FORMAT,strtotime($sort_to_date));
			} else {
				$sql_p[] = DB_PREFIX."customer_invoice.invoice_date >= '".$sort_from_date."'";
				$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date >= '".$sort_from_date."'";
				$this->report_title = "From ".date(DATE_FORMAT,strtotime($sort_from_date))." To Present";
			} 
			break;

			//This Month
			case 6:
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01")."' AND '".date("Y-m-t")."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT,strtotime(date("Y-m-t")));
			break;
			
			//Last Month
			case 7:
			$sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01",strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))."'";
			$sub_sql_p[] = DB_PREFIX."customer_invoice.invoice_date BETWEEN '".date("Y-m-01",strtotime(date("Y-m-d")." -1 month"))."' AND '".date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))."'";
			$this->report_title = "Month Ending ".date(DATE_FORMAT,strtotime(date("Y-m-t",strtotime(date("Y-m-d")." -1 month"))));
			break;
			
			default:
			$this->report_title = "To Date";
			break;
		}

		if (is_array($customer_filter) && count($customer_filter)) {
			$customer_filter = array_unique($customer_filter);
			$customer_filter = array_values($customer_filter);
			array_walk($customer_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."customer_invoice.customer_hash IN (".implode(" , ",$customer_filter).")";
			array_walk($customer_filter,'strip_quotes');
		}
		if (is_array($vendor_filter) && count($vendor_filter)) {
			$vendor_filter = array_unique($vendor_filter);
			$vendor_filter = array_values($vendor_filter);
			array_walk($vendor_filter,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."line_items.vendor_hash IN (".implode(" , ",$vendor_filter).")";
			array_walk($vendor_filter,'strip_quotes');
		}
		if (is_array($product_match) && count($product_match)) {
			$product_match = array_unique($product_match);
			$product_match = array_values($product_match);
			array_walk($product_match,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."line_items.product_hash IN (".implode(" , ",$product_match).")";
			array_walk($product_match,'strip_quotes');
		}
		if (is_array($sales_rep_match) && count($sales_rep_match)) {
			$sales_rep_match = array_unique($sales_rep_match);
			$sales_rep_match = array_values($sales_rep_match);
			array_walk($sales_rep_match,'add_quotes',"'");
			$sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
			array_walk($sales_rep_match,'strip_quotes');
		}
		
		if ($sql_p) 
			$sql = " AND ".implode(" AND ",$sql_p);
		
		$str = "timeframe=$timeframe|showdetail=$showdetail|sort_from_date=$sort_from_date|sort_to_date=$sort_to_date|customer_filter=".@implode("&",$customer_filter)."|vendor_filter=".@implode("&",$vendor_filter)."|product_match=".@implode("&",$product_match)."|sales_rep_match=".@implode("&",$sales_rep_match);
		
		if (!$report_hash) {
			$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
			while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
				$report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
				
			$this->db->query("INSERT INTO `".DB_PREFIX."reports`
							  (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
							  VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

			if ($share && (count($group_share) || count($sales_rep_share))) {
				for ($i = 0; $i < count($group_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `group_hash`)
									  VALUES ('$report_hash' , '".$group_share[$i]."')");
				
				for ($i = 0; $i < count($sales_rep_share); $i++)
					$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
									  (`report_hash` , `user_hash`)
									  VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
			}		
		} else {
			$existing = true;
			$this->db->query("UPDATE `".DB_PREFIX."reports`
							  SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
							  WHERE `report_hash` = '$report_hash'");
		
			if (!$share)
				$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
								  WHERE `report_hash` = '".$this->report_hash."'");
			else {
				if (!is_array($sales_rep_share))
					$sales_rep_share = array();
				if (!is_array($group_share))
					$group_share = array();
					
				//Share or revoke to users
				$result = $this->db->query("SELECT `user_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_users[] = $row['user_hash'];
					
				if (!is_array($current_share_users))
					$current_share_users = array();
					
				$to_remove = array_diff($current_share_users,$sales_rep_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `user_hash` = '".$current_share_users[$i]."'");
				}
				$to_add = array_diff($sales_rep_share,$current_share_users);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `user_hash`)
										  VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
				}

				//Share or revoke to groups
				$result = $this->db->query("SELECT `group_hash`
											FROM `".DB_PREFIX."reports_share`
											WHERE `report_hash` = '$report_hash'");
				while ($row = $this->db->fetch_assoc($result))
					$current_share_groups[] = $row['group_hash'];
					
				if (!is_array($current_share_groups))
					$current_share_groups = array();
					
				$to_remove = array_diff($current_share_groups,$group_share);
				if (is_array($to_remove)) {
					while (list($i) = each($to_remove))
						$this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
										  WHERE `group_hash` = '".$current_share_groups[$i]."'");
				}
				$to_add = array_diff($group_share,$current_share_groups);
				if (is_array($to_add)) {
					while (list($i) = each($to_add))
						$this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
										  (`report_hash` , `group_hash`)
										  VALUES ('$report_hash' , '".$group_share[$i]."'");
				}
			}
		}
		$this->report_hash = $report_hash;	
		$sched = $day_schedule;	
		for ($i = 1; $i <= 3; $i++) {
			$this->schedule[$i] = strtotime($sched_start_date." +".$sched." days");
			$sched += $day_schedule;
		}
		$result = $this->db->query("SELECT ".DB_PREFIX."vendor_products.product_hash , ".DB_PREFIX."vendor_products.product_name , ".DB_PREFIX."customer_invoice.invoice_hash , ".DB_PREFIX."customer_invoice.invoice_no , ".DB_PREFIX."customer_invoice.invoice_date , ".DB_PREFIX."customer_invoice.customer_hash , 
									".DB_PREFIX."customers.customer_name , ".DB_PREFIX."proposals.proposal_descr , ".DB_PREFIX."line_items.ext_sell , ".DB_PREFIX."line_items.ext_cost , ".DB_PREFIX."line_items.qty ,
									FORMAT(((".DB_PREFIX."line_items.ext_sell - ".DB_PREFIX."line_items.ext_cost) / ".DB_PREFIX."line_items.ext_sell) * 100 , 2) AS gp_margin ,
									CASE
									WHEN ISNULL(".DB_PREFIX."customers.customer_name)
									THEN ".DB_PREFIX."vendors.vendor_name
									ELSE 0
									END AS vendor_name 
									FROM ".DB_PREFIX."customer_invoice
									LEFT JOIN ".DB_PREFIX."customers ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."customer_invoice.customer_hash
									LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."customer_invoice.customer_hash
									LEFT JOIN ".DB_PREFIX."proposals ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."customer_invoice.proposal_hash
									LEFT JOIN (SELECT invoice_hash , product_hash , qty ,
									           SUM(sell * qty) AS ext_sell , SUM(cost * qty) AS ext_cost
									           FROM ".DB_PREFIX."line_items
									           GROUP BY product_hash , invoice_hash) AS ".DB_PREFIX."line_items ON ".DB_PREFIX."line_items.invoice_hash = ".DB_PREFIX."customer_invoice.invoice_hash
									LEFT JOIN ".DB_PREFIX."vendor_products ON ".DB_PREFIX."vendor_products.product_hash = ".DB_PREFIX."line_items.product_hash
									WHERE ".DB_PREFIX."customer_invoice.type = 'I' AND ".DB_PREFIX."customer_invoice.amount > 0 ".($sql ? $sql : NULL)."
									ORDER BY ".DB_PREFIX."customer_invoice.invoice_date , ".DB_PREFIX."customer_invoice.invoice_no ASC");
		while ($row = $this->db->fetch_assoc($result)) {
			if ($row['product_hash']) {
				$result_list[$row['product_hash']][] = $row;
				$sort_list[$row['product_hash']] = stripslashes($row['product_name']);
			}
		}
		//Asending order					
		@asort($sort_list);	
		if (is_array($sort_list)) {
			while (list($hash,$name) = each($sort_list)) 
				$this->results[$hash] =& $result_list[$hash];
			
		}		
				
		if ($from_report)
			$this->content['action'] = 'continue';
		else
			$this->content['action'] = 'close';
		
		$this->total = count($this->results);
		$this->content['html']['place_holder'] = $this->product_sales_report(1);
		return;
	}
	
	function product_sales_report($step=NULL) {
		$this->unlock("_");

		if ($step) {
			$this->fetch_report_settings($this->report_hash);
			$tbl = $this->form->form_tag().$this->form->hidden(array('test' => 1, 'popup_id' => ''))."
			<table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\">
				<tr>
					<td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"8\">
						<h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
							".($this->current_report['saved'] ? 
								$this->current_report['report_name'] : "Product Sales Report")."
							<span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
								[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','product_sales_report','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
							</span>
						</h3>
						<small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
						&nbsp;&nbsp;
					</td>
				</tr>
				<tr class=\"thead\" style=\"font-weight:bold;\">
					<td style=\"width:100px;text-align:left;padding:5px 5px 5px 25px;\">Invoice Date</td>
					<td style=\"width:100px;padding:5px;\">Invoice No.</td>
					<td style=\"width:240px;padding:5px;\">Customer</td>
					<td style=\"width:240px;padding:5px;\">Description</td>
					<td style=\"width:60px;padding:5px;\" class=\"num_field\">Qty</td>
					<td style=\"width:125px;padding:5px;\" class=\"num_field\">Ext Cost</td>
					<td style=\"width:125px;padding:5px;\" class=\"num_field\">Ext Sell</td>
					<td style=\"width:35px;padding:5px;\" class=\"num_field\">".($this->current_report['showdetail'] == 2 ? "GP" : "&nbsp;")."</td>
				</tr>";
				
			if (is_array($this->results)) {
				$k = 0;
				while (list($product_hash,$invoice_array) = each($this->results)) {
					$total_qty = $total_cost = $total_sell = 0;
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"8\" style=\"font-weight:bold;font-size:8pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">".$invoice_array[0]['product_name']."</td>
					</tr>";
						
					for ($i = 0; $i < count($invoice_array); $i++) {
						if ($this->current_report['showdetail'] == 2)
							$tbl .= "
							<tr>
								<td style=\"background-color:#ffffff;font-size:8pt;padding-left:25px;\">".date(DATE_FORMAT,strtotime($invoice_array[$i]['invoice_date']))."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('customer_invoice','sf_loadcontent','show_popup_window','edit_invoice','invoice_hash=".$invoice_array[$i]['invoice_hash']."','popup_id=line_item');\" class=\"link_standard\">".$invoice_array[$i]['invoice_no']."</a></td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".($invoice_array[$i]['customer_name'] ? 
									(strlen($invoice_array[$i]['customer_name']) > 40 ? 
										substr($invoice_array[$i]['customer_name'],0,37)."..." : $invoice_array[$i]['customer_name']) : (strlen($invoice_array[$i]['vendor_name']) > 40 ? 
											substr($invoice_array[$i]['vendor_name'],0,37)."..." : $invoice_array[$i]['vendor_name']))."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\">".(strlen($invoice_array[$i]['proposal_descr']) > 40 ? 
									substr($invoice_array[$i]['proposal_descr'],0,37)."..." : $invoice_array[$i]['proposal_descr'])."
								</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">".$invoice_array[$i]['qty']."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['ext_cost'],2)."</td>
								<td style=\"background-color:#ffffff;font-size:8pt;\" class=\"num_field\">$".number_format($invoice_array[$i]['ext_sell'],2)."</td>
								<td nowrap style=\"background-color:#ffffff;font-size:8pt;".(defined('MARGIN_FLAG') && $invoice_array[$i]['gp_margin']*.01 < MARGIN_FLAG ? "color:red;" : NULL)."\" class=\"num_field\">". 
									($invoice_array[$i] < 0 ? "(".(round($invoice_array[$i]['gp_margin'],4) * -1).")" : round($invoice_array[$i]['gp_margin'],4))."%
								</td>
							</tr>"; 
						
						$total_qty += $invoice_array[$i]['qty'];
						$total_cost += $invoice_array[$i]['ext_cost'];
						$total_sell += $invoice_array[$i]['ext_sell'];
						
					}
					$total_gp = math::gp_margin($total_cost,$total_sell);
					$tbl .= "
					<tr style=\"background-color:#efefef;\">
						<td colspan=\"3\" style=\"font-weight:bold;font-size:8pt;background-color:#ffffff;\">Total for ".$invoice_array[0]['product_name']."</td>
						<td colspan=\"2\" style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;\" class=\"num_field\">".($total_qty != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:40%;padding-top:5px;\">
								".number_format($total_qty,2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;\" class=\"num_field\">".($total_cost != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_cost,2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;\" class=\"num_field\">".($total_sell != 0 ? 
							"<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;\">
								$".number_format($total_sell,2)."
							</div>" : NULL)."
						</td>
						<td style=\"background-color:#ffffff;font-size:8pt;font-weight:bold;\" class=\"num_field\"> 
							<div style=\"".($this->current_report['showdetail'] == 2 ? "border-top:1px dashed #000000;" : NULL)."width:90%;padding-top:5px;".($total_gp < MARGIN_FLAG ? "color:red;" : NULL)."\">
								".($total_gp < 0 ? "(".($total_gp * -100).")" : $total_gp * 100)."%
							</div>
						</td>
					</tr>";
					
					$grand_total['qty'] += $total_qty;
					$grand_total['cost'] += $total_cost;
					$grand_total['sell'] += $total_sell;
				}
				$grand_total['gp'] = math::gp_margin($grand_total['cost'],$grand_total['sell']);
				$tbl .= "
				<tr style=\"background-color:#efefef;\">
					<td colspan=\"3\" style=\"font-weight:bold;font-size:10pt;padding:5px;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc;background-color:#efefef;\">&nbsp;</td>
					<td colspan=\"2\" style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['qty'] != 0 ? 
						"<div style=\"width:40%;padding-top:10px;\">
							".number_format($grand_total['qty'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['cost'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['cost'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['sell'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;\">
							$".number_format($grand_total['sell'],2)."
						</div>" : "&nbsp;")."
					</td>
					<td style=\"font-weight:bold;border-top:1px solid #cccccc;font-size:8pt;\" class=\"num_field\">".($grand_total['gp'] != 0 ? 
						"<div style=\"width:90%;padding-top:10px;".($grand_total['gp'] < MARGIN_FLAG ? "color:red;" : NULL)."\">
							".($grand_total['gp'] < 0 ? "(".($grand_total['gp'] * -100).")" : $grand_total['gp'] * 100)."%
						</div>" : "&nbsp;")."
					</td>
				</tr>";
					
			} else
				$tbl .= "
				<tr>
					<td colspan=\"7\" style=\"background-color:#ffffff;\">Your report returned an empty result.</td>
				</tr>";
			
			$tbl .= "
			</table>";
									
			return $tbl;
		} else {
			$report_hash = $this->ajax_vars['report_hash'];
			$this->fetch_report_settings($report_hash);
			
			$this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
			if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
				unset($report_hash);
			
			if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
				$this->current_report['customer_filter'] = array($this->current_report['customer_filter']);
			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
				$this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);
			if ($this->current_report['product_match'] && !is_array($this->current_report['product_match']))
				$this->current_report['product_match'] = array($this->current_report['product_match']);
			
			$result = $this->db->query("SELECT ".DB_PREFIX."vendor_products.product_name , ".DB_PREFIX."vendor_products.product_hash , ".DB_PREFIX."vendors.vendor_hash , ".DB_PREFIX."vendors.vendor_name
										FROM `".DB_PREFIX."vendor_products`
										LEFT JOIN `".DB_PREFIX."vendors` ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."vendor_products.vendor_hash
										ORDER BY ".DB_PREFIX."vendors.vendor_name , ".DB_PREFIX."vendor_products.product_name");
			while ($row = $this->db->fetch_assoc($result)) {
				$vendor[($row['vendor_hash'] ? $row['vendor_hash'] : "DEFAULT")] = ($row['vendor_name'] ? $row['vendor_name'] : MY_COMPANY_NAME);
				$products[($row['vendor_hash'] ? $row['vendor_hash'] : "DEFAULT")][] = array("name" =>	stripslashes($row['product_name']),
																						     "hash" =>	$row['product_hash']);
			}
			while (list($vendor_hash,$product_array) = each($products)) {
				$select .= "
				<optgroup label=\"".$vendor[$vendor_hash]."\">";
				for ($i = 0; $i < count($product_array); $i++)
					$select .= "
					<option value=\"".$product_array[$i]['hash']."\" ".(@in_array($product_array[$i]['hash'],$this->current_report['product_match']) ? "selected=\"selected\"" : NULL).">".$product_array[$i]['name']."</option>";
				$select .= "
				</optgroup>";
			}
			$product_select = "
			<select name=\"product_match[]\" class=\"txtSearch\" size=\"6\" style=\"width:400px;\" multiple>
				".$select."
			</select>";
			
			if ($this->current_report['vendor_filter'] && !is_array($this->current_report['vendor_filter']))
                $this->current_report['vendor_filter'] = array($this->current_report['vendor_filter']);			  
			
			for ($i = 1; $i <= 30; $i++) 
				$gen_array[] = $i." day".($i > 1 ? "s" : NULL);
			
			$tbl = $this->form->form_tag().
			$this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
			<div class=\"panel\">
				<div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
					<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
						<p id=\"feedback_message".$this->popup_id."\"></p>
				</div>
				<table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
					<tr>
						<td style=\"padding:0;\">
							 <div style=\"background-color:#ffffff;height:100%;\">
								<div style=\"margin:15px 35px;\">
									<div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
										".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_product_sales_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
											"&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_product_sales_report','rm=1');") : NULL)."
									</div>
									<h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
										$this->current_report['report_name'] : "Product Sales Report")."</h3>
									<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">What time frame should<br />the report reflect?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">".
												$this->form->select("timeframe",array("All dates","Invoiced sales dated this year","Invoiced sales dated last year","Invoiced sales from the current period","Invoiced sales from the previous period","Invoiced sales dated this month","Invoiced sales dated last month","A specific date range"),$this->current_report['timeframe'],array('*',1,2,3,4,6,7,5),"onChange=if(this.options[this.selectedIndex].value==5){toggle_display('date_range','block');}else{toggle_display('date_range','none');}","blank=1")."
												<div style=\"margin-top:10px;display:".($this->current_report['timeframe'] == 5 ? "block" : "none").";\" id=\"date_range\">
													<span id=\"sort_from_date_holder\"></span>
													<span id=\"sort_to_date_holder\"></span>";
												$jscript[] = "setTimeout('DateInput(\'sort_from_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_from_date'] ? $this->current_report['sort_from_date'] : '')."\',1,\'sort_from_date_holder\',\'From: \')',500);";
												$jscript[] = "setTimeout('DateInput(\'sort_to_date\',false,\'YYYY-MM-DD\',\'".($this->current_report['timeframe'] == 5 && $this->current_report['sort_to_date'] ? $this->current_report['sort_to_date'] : '')."\',1,\'sort_to_date_holder\',\'&nbsp;&nbsp;&nbsp;&nbsp;To:\')',800);";
												$tbl .= "													
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to show sales for specific customers?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=customer_vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer_vendor','customer_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_vendor_filter_holder\">";
												if (is_array($this->current_report['customer_filter'])) {
													for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
														$tbl .= "<div id=\"customer_vendor_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_vendor_filter\" name=\"customer_vendor_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to show products/services for specific vendors?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->text_box("name=vendor",
																		"value=",
																		"autocomplete=off",
																		"size=30",
																		"onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','vendor','vendor_hash',1);",
																		"onBlur=vtobj.reset_keyResults();key_clear();"
																		)."
												
												<div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['vendor_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"vendor_filter_holder\">";
												if (is_array($this->current_report['vendor_filter'])) {
													for ($i = 0; $i < count($this->current_report['vendor_filter']); $i++) 
														$tbl .= "<div id=\"vendor_".$this->current_report['vendor_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['vendor_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['vendor_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['vendor_filter'][$i])))."<input type=\"hidden\" id=\"vendor_filter\" name=\"vendor_filter[]\" value=\"".$this->current_report['vendor_filter'][$i]."\" /></div>";
												}
											$tbl .= "
												</div>
											</td>
										</tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Model Number:</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->text_box("name=model_no","value=")."</td>
                                        </tr>                                                                               										
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to show only specific products and services?</td>
											<td style=\"background-color:#ffffff;\">".$product_select."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
											<td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]",$this->user_name,(is_array($this->current_report['sales_rep']) ? $this->current_report['sales_rep'] : ''),$this->user_hash,"multiple","blank=1","size=4","style=width:200px;")."</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;padding-top:10px;width:40%\">Show Report Details?</td>
											<td style=\"background-color:#ffffff;padding-top:10px;\">
												".$this->form->select("showdetail",array("Show Detail View","Show Simple View"),$this->current_report['showdetail'],array('2','1'),"blank=1")."
											</td>
										</tr>
										<tr>
											<td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
											<td style=\"background-color:#ffffff;\">
												".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
												<div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
													What should the report be called?
													<br />
													".$this->form->text_box("name=report_name",
																			"value=".$this->current_report['report_name'],
																			"autocomplete=off",
																			"size=30",
																			"style=margin-top:5px;margin-bottom:10px;"
																			)."
													<br />
													Optional description for the report:
													<br />
													".$this->form->text_area("name=report_descr",
																			"value=".$this->current_report['report_descr'],
																			"rows=3",
																			"cols=50",
																			"style=margin-top:5px;"
																			)."
													<div style=\"padding-top:5px\">														
														".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
														<div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
															Share to the following users:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
															Share to the following groups:
															<div style=\"padding-top:5px;padding-bottom:5px;\">
																".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
															</div>
														</div>
													</div>
												</div>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</td>
					</tr>
				</table>
			</div>".
			$this->form->close_form();

			$this->content['popup_controls']["cmdTable"] = $tbl;
			$this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
			$this->content['jscript'] = $jscript;
			
			return;
		}				
	}
	
	
	function navigator() {
		$this->unlock("_");
		
		$this->fetch_custom_reports();
		$this->fetch_shared_reports();
		
		if ($this->p->ck(get_class($this),'V','ar') || $this->p->ck(get_class($this),'V','ar_reconcile') || $this->p->ck(get_class($this),'V','cash_receipts') || $this->p->ck(get_class($this),'V','cash_flow_exp') || $this->p->ck(get_class($this),'V','customer_balance'))
			$ar = true;
		if ($this->p->ck(get_class($this),'V','ap') || $this->p->ck(get_class($this),'V','cash_req') || $this->p->ck(get_class($this),'V','cash_disp') || $this->p->ck(get_class($this),'V','vendor_balance') || $this->p->ck(get_class($this),'V','sales_tax') || $this->p->ck(get_class($this),'V','po') || $this->p->ck(get_class($this),'V','vendor_discounting') || $this->p->ck(get_class($this),'V','wip_reconcile') || $this->p->ck(get_class($this),'V','1099'))
			$ap = true;
		if ($this->p->ck(get_class($this),'V','commissions') || $this->p->ck(get_class($this),'V','work_order') || $this->p->ck(get_class($this),'V','job_costing') || $this->p->ck(get_class($this),'V','product_sales') || $this->p->ck(get_class($this),'V','bookings') || $this->p->ck(get_class($this),'V','invoiced_sales') || $this->p->ck(get_class($this),'V','backlog'))
			$proposals = true;
		if ($this->p->ck(get_class($this),'V','check_reconcile') || $this->p->ck(get_class($this),'V','check_reg') || $this->p->ck(get_class($this),'V','cash_flow') || $this->p->ck(get_class($this),'V','trial_balance') || $this->p->ck(get_class($this),'V','income_stmtm') || $this->p->ck(get_class($this),'V','balance_sheet'))
			$finance = true;
		
		$tbl .= $this->form->form_tag().
		$this->form->hidden(array('test' => 1))."
		<div id=\"feedback_holder\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
			<h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
				<p id=\"feedback_message\"></p>
		</div>
		<table cellspacing=\"1\" cellpadding=\"5\" class=\"main_tab_table\">
			<tr>
				<td style=\"padding:0;\">
					 <div style=\"background-color:#ffffff;height:100%;\">
					 	<div style=\"margin:15px 35px;\">
							<h3 style=\"margin-bottom:15px;color:#00477f;\">Reports Navigator</h3>
							<table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:700px;margin-top:0;\" class=\"smallfont\">".($ar ? "
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">Customers & Receivables Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">".($this->p->ck(get_class($this),'V','ar') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','ar_report','popup_id=report_filter');\">Accounts Receivable Report</a>
											<div style=\"padding-top:5px;\">
												Report showing the current and aged accounts receivables owed by customers.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','ar_reconcile') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','ar_reconcile','popup_id=report_filter');\">Accounts Receivable Reconciliation Report</a>
											<div style=\"padding-top:5px;\">
												Reconcile outstanding receivables to a clearing account, a doubtful allowance account, or another account of your choosing.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','cash_receipts') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','cash_receipts','popup_id=report_filter');\">Cash Receipts</a>
											<div style=\"padding-top:5px;\">
												This report shows the receipts received from your customers and itemizes those receipts against their respective invoices.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','cash_flow_exp') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','cash_flow_exp','popup_id=report_filter');\">Cash Flow Expectations Report</a>
											<div style=\"padding-top:5px;\">
												This report calculates your expected cash flow based on factors such as your customers average days to pay. This report will identify your anticipated receipts down to the day.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','customer_balance') ? "
										<div >
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','customer_balance','popup_id=report_filter');\">Customer Balance Summary</a>
											<div style=\"padding-top:5px;\">
												This report shows the current balance of each of your customers. The report can be expanded to show balance 
												trends for a given customer.
											</div>	
										</div>" : NULL)."
									</td>
								</tr>" : NULL).($ap ? "
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">Vendors & Payables Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">".($this->p->ck(get_class($this),'V','ap') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','ap_report','popup_id=report_filter');\">Accounts Payable Report</a>
											<div style=\"padding-top:5px;\">
												This report shows the current and aged accounts payables owed to vendors.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','cash_req') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','cash_requirements','popup_id=report_filter');\">Cash Requirements Report</a>
											<div style=\"padding-top:5px;\">
												This report shows the cash requirements needed to pay outstanding bills and refunds. 
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','cash_disp') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','cash_disp','popup_id=report_filter');\">Cash Disbursements Report</a>
											<div style=\"padding-top:5px;\">
												This report shows the cash disbursed on a specific date or period of time when invoices are paid or deposits are issued. 
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','vendor_balance') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','vendor_balance','popup_id=report_filter');\">Vendor Balance Summary</a>
											<div style=\"padding-top:5px;\">
												This report shows the current balance of each of your vendors. The report can be expanded to show balance 
												trends for a given vendor.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','sales_tax') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','sales_tax','popup_id=report_filter');\">Sales Tax Liability Report</a>
											<div style=\"padding-top:5px;\">
												This report shows the sales tax liability owed for each of the areas you collect sales tax. 
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','po') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','po_report','popup_id=report_filter');\">Purchase Order Report</a>
											<div style=\"padding-top:5px;\">
												This report shows purchase orders that were issued on a specific date or date range. 
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','vendor_discounting') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','vendor_discounting','popup_id=report_filter');\">Vendor Discounting</a>
											<div style=\"padding-top:5px;\">
												This report shows all vendors and their respective discounts, along with discount IDs, effective and expiration dates, and product discounting tiers.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','wip_reconcile') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','wip_reconcile','popup_id=report_filter');\">WIP Reconciliation</a>
											<div style=\"padding-top:5px;\">
												This report reconciles outstanding Work In Progress against its payables, allowing you to balance any outstanding WIP that may exist against a specific payable.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','1099') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','vendor_1099','popup_id=report_filter');\">Vendor 1099 Report</a>
											<div style=\"padding-top:5px;\">
												This report identifies payments you have made to your 1099 vendors. 
											</div>	
										</div>" : NULL)."
									</td>
								</tr>" : NULL).($proposals ? "
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">Proposals & Sales Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">".($this->p->ck(get_class($this),'V','project_status') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','status_report','popup_id=report_filter');\">Project Status Report</a>
											<div style=\"padding-top:5px;\">
												This report tracks all proposals once they have been booked. It contains shipping &amp; delivery information and allows you to record acknowledgment information.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','backlog') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','backlog_report','popup_id=report_filter');\">Backlog Report</a>
											<div style=\"padding-top:5px;\">
												This report identifies all proposals and line items that are awaiting specific actions. These actions can include those lines remaining to be invoiced, booked, shipped, etc. 
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','invoiced_sales') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','invoiced_sales','popup_id=report_filter');\">Invoiced Sales Summary</a>
											<div style=\"padding-top:5px;\">
												This report identifies invoiced sales within a specific date or date range.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','bookings') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','bookings_report','popup_id=report_filter');\">Bookings Report Summary</a>
											<div style=\"padding-top:5px;\">
												This report shows all sales bookings and their profitability within a specific date or date range.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','product_sales') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','product_sales_report','popup_id=report_filter');\">Product Sales Report</a>
											<div style=\"padding-top:5px;\">
												This report shows all customer sales by product and service.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','job_costing') ? "
                                        <div style=\"padding-bottom:10px;\">
                                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','job_costing','popup_id=report_filter');\">Job Costing/Profitability Report</a>
                                            <div style=\"padding-top:5px;\">
                                                This report helps you to identify how profitable your orders are, identifying true costs and actual project margins. 
                                            </div>    
                                        </div>" : NULL).($this->p->ck(get_class($this),'V','work_order') ? "
                                        <div style=\"padding-bottom:10px;\">
                                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','work_order_bookings','popup_id=report_filter');\">Work Order Bookings Report</a>
                                            <div style=\"padding-top:5px;\">
                                                This report details the work order bookings and their profitability.
                                            </div>    
                                        </div>" : NULL).($this->p->ck(get_class($this),'V','commissions') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','commission_report','popup_id=report_filter');\">Commissions Report</a>
											<div style=\"padding-top:5px;\">
												This report identifies and manages commissions that are owed to your sales reps. 
											</div>	
										</div>
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','commissions_paid_report','popup_id=report_filter');\">Commissions Paid Report</a>
											<div style=\"padding-top:5px;\">
												This report shows all commissions that have been previously paid to your sales reps.
											</div>	
										</div>" : NULL)."
									</td>
								</tr>" : NULL).($finance ? "
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">Financial Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">".($this->p->ck(get_class($this),'V','balance_sheet') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','balance_sheet','popup_id=report_filter')\">Balance Sheet</a>
											<div style=\"padding-top:5px;\">
												The summary of the value of all assets, liabilities and owners' equity on a specific date. The balance sheet can be 
												run to show multiple comparisons such as monthly or quarterly.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','income_stmtm') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','income_statement','popup_id=report_filter')\">Income Statement</a>
											<div style=\"padding-top:5px;\">
												Identifies profit and loss within a specific period of time.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','trial_balance') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','trial_balance','popup_id=report_filter')\">Trial Balance</a>
											<div style=\"padding-top:5px;\">
												Identifies the closing balances of your accounts at a specific point in time. 
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','cash_flow') ? "
										<div style=\"padding-bottom:10px;\">
											<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','cash_flows','popup_id=report_filter')\">Statement of Cash Flows</a>
											<div style=\"padding-top:5px;\">
												This statement shows your company's incoming and outgoing money over a specific date or date range.
											</div>	
										</div>" : NULL).($this->p->ck(get_class($this),'V','check_reg') ? "
                                        <div style=\"padding-bottom:10px;\">
                                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('accounting','sf_loadcontent','cf_loadcontent','check_reg')\">Check Register</a>
                                            <div style=\"padding-top:5px;\">
                                                A list of the checks issued by your company.
                                            </div>    
                                        </div>" : NULL).($this->p->ck(get_class($this),'V','check_reconcile') ? "
                                        <div style=\"padding-bottom:10px;\">
                                            <a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','check_reconcile')\">Check Reconciliation Report</a>
                                            <div style=\"padding-top:5px;\">
                                                Identifies outstanding checks and provides a tool to reconcile.
                                            </div>    
                                        </div>" : NULL)."
									</td>
								</tr>" : NULL)."
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">My Saved Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">";
									if (count($this->custom_reports)) {
										while (list($report_hash,$report_info) = each($this->custom_reports))
											$tbl .= "
											<div style=\"padding-bottom:10px;\">
												<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','".$report_info['saved_catagory']."','popup_id=report_filter','report_hash=".$report_hash."');\">".$report_info['report_name']."</a>
												&nbsp;-&nbsp;".date(DATE_FORMAT." ".TIMESTAMP_FORMAT,$report_info['timestamp'])."
												<div style=\"padding-top:5px;\">
													".$report_info['report_descr']."
												</div>	
											</div>";
									} else
										$tbl .= "
										<i>No custom reports</i>";
								
								$tbl .= "
									</td>
								</tr>
								<tr>
									<td style=\"background-color:#efefef;padding:5px;font-weight:bold;color:#00477f;\">Shared Reports</td>
								</tr>
								<tr>
									<td style=\"background-color:#ffffff;padding:15px 25px;\">";
									if (count($this->shared_reports)) {
										while (list($report_hash,$report_info) = each($this->shared_reports))
											$tbl .= "
											<div style=\"padding-bottom:10px;\">
												<a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','".$report_info['saved_catagory']."','popup_id=report_filter','report_hash=".$report_hash."');\">".$report_info['report_name']."</a>
												&nbsp;-&nbsp;".date(DATE_FORMAT." ".TIMESTAMP_FORMAT,$report_info['timestamp'])."
												<div style=\"padding-top:5px;\">
													".$report_info['report_descr']."
												</div>	
											</div>";
									} else
										$tbl .= "
										<i>No shared reports</i>";
								
								$tbl .= "
									</td>
								</tr>
							</table>
						</div>
					</div>
				</td>
			</tr>
		</table>".		
		$this->form->close_form();

		
		$this->content['html']['place_holder'] = $tbl;
	}
	
	function doit_status_report() {
        $date = date("U") - 3600;
        $result = $this->db->query("DELETE FROM `".DB_PREFIX."reports`
                                    WHERE `saved` = 0 AND `timestamp` <= '$date'");
        
        if ($_POST['rm'] == 1 && $_POST['report_hash']) {
            $this->db->query("DELETE ".DB_PREFIX."reports.* , ".DB_PREFIX."reports_share.*
                              FROM `".DB_PREFIX."reports`
                              LEFT JOIN `".DB_PREFIX."reports_share` ON ".DB_PREFIX."reports_share.report_hash = ".DB_PREFIX."reports.report_hash
                              WHERE ".DB_PREFIX."reports.report_hash = '".$_POST['report_hash']."'");
            $this->content['action'] = 'close';
            $this->content['page_feedback'] = "Report has been deleted.";
            $this->content['jscript_action'] = "agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');";
            return;                           
        }
        
        if ($method = $_POST['method']) {
        	$proposal_hash = $_POST['proposal_hash'];
            if ($method == 'save_note') {		        
		        $target_install_date = $_POST['target_install_date'];
		        $actual_install_date = $_POST['actual_install_date'];
		        
			    $this->db->query("UPDATE ".DB_PREFIX."proposal_install
			                      LEFT JOIN ".DB_PREFIX."proposals ON ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."proposals.proposal_hash
			                      SET ".DB_PREFIX."proposal_install.target_install_date = '$target_install_date' , 
			                      ".DB_PREFIX."proposal_install.actual_install_date = '$actual_install_date' , 
			                      ".DB_PREFIX."proposals.closed = '".($_POST['final'] == 1 ? 1 : 0)."'
			                      WHERE ".DB_PREFIX."proposals.proposal_hash = '$proposal_hash'");

                if ($target_install_date)			                      
    			    $this->content['html']['target_date_'.$proposal_hash] = date(DATE_FORMAT,strtotime($target_install_date));
                if ($target_install_date)
                    $this->content['html']['actual_date_'.$proposal_hash] = date(DATE_FORMAT,strtotime($actual_install_date));              
                    
                $this->content['jscript'] = "toggle_display('proposalList".$proposal_hash."','none');";		                                  
		        $this->content['page_feedback'] = "Your information has been updated.";		        
            } elseif ($method == 'clear_ack_info') {
                $po_hash = $_POST['po_hash'];
            	
		        $this->db->query("UPDATE `".DB_PREFIX."line_items`
		                          SET `ship_date` = '' , `receive_date` = '' , `ack_no` = ''
		                          WHERE `proposal_hash` = '$proposal_hash' AND `po_hash` = '$po_hash'");
		                          
                $this->content['html']['receive_date_'.$po_hash] = $this->content['html']['ship_date_'.$po_hash] = $this->content['html']['ack_'.$po_hash] = '';		                          
                $this->content['jscript'] = "toggle_display('poListHolder".$po_hash."','none');agent.call('reports','sf_loadcontent','cf_loadcontent','show_po_details','proposal_hash=$proposal_hash');";		                       
		        $this->content['page_feedback'] = "Acknowledgement information has been cleared for the selected PO.";              	
            }
            $this->content['action'] = 'continue';
            return;
        }
        $report_hash = ($_POST['report_hash'] ? $_POST['report_hash'] : $this->ajax_vars['report_hash']);
        $limit_start = $this->ajax_vars['limit_start'];
        $total_rows = $this->ajax_vars['total_rows'];
        $doit_print = $_POST['doit_print'];
        
        if ($report_hash && ($doit_print || $limit_start)) {
            $this->fetch_report_settings($report_hash);
            $detail = $this->current_report['detail'];

            $customer_filter = $this->current_report['customer_vendor_filter'];
	        if ($customer_filter && !is_array($customer_filter))
	            $customer_filter = array($customer_filter);
                        
            $sales_rep_match = $this->current_report['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);
                
            $designer_match = $this->current_report['designer_match'];
            if ($designer_match && !is_array($designer_match))
                $designer_match = array($designer_match);

            $sales_coord_match = $this->current_report['sales_coord_match'];
            if ($sales_coord_match && !is_array($sales_coord_match))
                $sales_coord_match = array($sales_coord_match);

            $proj_mngr_match = $this->current_report['proj_mngr_match'];
            if ($proj_mngr_match && !is_array($proj_mngr_match))
                $proj_mngr_match = array($proj_mngr_match);                
                
            $proposal_filter = $this->current_report['proposal_filter'];
            if ($prosal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter);   

            $status = $this->current_report['status'];
                            
        } else {
            $detail = $_POST['detail'];

            $customer_filter = $_POST['customer_filter'];
	        if ($customer_filter && !is_array($customer_filter))
	            $customer_filter = array($customer_filter);
                        
            $sales_rep_match = $_POST['sales_rep_match'];
            if ($sales_rep_match && !is_array($sales_rep_match))
                $sales_rep_match = array($sales_rep_match);

            $designer_match = $_POST['designer_match'];
            if ($designer_match && !is_array($designer_match))
                $designer_match = array($designer_match);

            $sales_coord_match = $_POST['sales_coord_match'];
            if ($sales_coord_match && !is_array($sales_coord_match))
                $sales_coord_match = array($sales_coord_match);

            $proj_mngr_match = $_POST['proj_mngr_match'];
            if ($proj_mngr_match && !is_array($proj_mngr_match))
                $proj_mngr_match = array($proj_mngr_match);                
                
            $proposal_filter = $_POST['proposal_filter'];
            if ($prosal_filter && !is_array($proposal_filter))
                $proposal_filter = array($proposal_filter); 

            $status = $_POST['status'];                              
        }        
        
        $save = $_POST['save'];
        $saved_cat = "cash_disp_report";
        $report_name = $_POST['report_name'];
        $report_descr = $_POST['report_descr'];
        $share = $_POST['share'];
        $sales_rep_share = $_POST['sales_rep_share'];
        $group_share = $_POST['group_share'];
        $from_report = $_POST['from_report'];
        
        if ($save && !$report_name) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to save this report you must give the report a name.";
        }
        if ($save && !$report_hash) {
            $result = $this->db->query("SELECT COUNT(*) AS Total
                                        FROM `".DB_PREFIX."reports`
                                        WHERE `owner_hash` = '".$this->current_hash."' AND `saved` = 1 AND `report_name` = '$report_name'");
            if ($this->db->result($result)) {
                $this->content['error'] = 1;
                $this->content['form_return']['feedback'][] = "You already have a report saved under the same name! Please make sure you are not creating a duplicate.";
            }
        }
        if ($share && !count($sales_rep_share) && !count($group_share)) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "In order to share this report please select a user or group to share to.";
        }
        
        if (($timeframe == 13 && !$sort_from_date) || ($timeframe == 13 && $sort_to_date && strtotime($sort_from_date) > strtotime($sort_to_date))) {
            $this->content['error'] = 1;
            $this->content['form_return']['feedback'][] = "The sort dates you specified are invalid! Please make sure you include at least a sort from date, and that if you specified a sort to date, that date is greater than the sort from date.";
        }
        
        if ($this->content['error'])
            return;            
        
        if (is_array($customer_filter) && count($customer_filter)) {
            $customer_filter = array_unique($customer_filter);
            $customer_filter = array_values($customer_filter);
            array_walk($customer_filter,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."proposals.customer_hash IN (".implode(" , ",$customer_filter).")";
            array_walk($customer_filter,'strip_quotes');
        }
        
        if (is_array($proposal_filter) && count($proposal_filter)) {
            $proposal_filter = array_unique($proposal_filter);
            $proposal_filter = array_values($proposal_filter);
            array_walk($proposal_filter,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."proposals.proposal_hash IN (".implode(" , ",$proposal_filter).")";
            array_walk($proposal_filter,'strip_quotes');
        } 
          
        if (@in_array("",$sales_rep_match) && count($sales_rep_match) > 1)
            unset($sales_rep_match[array_search("",$sales_rep_match)]);
        elseif (@in_array("",$sales_rep_match) && count($sales_rep_match) == 1)
            unset($sales_rep_match);        
        
        if (is_array($sales_rep_match) && count($sales_rep_match)) {        	
            array_walk($sales_rep_match,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."proposals.sales_hash IN (".implode(" , ",$sales_rep_match).")";
            array_walk($sales_rep_match,'strip_quotes');
        }  

        if (@in_array("",$designer_match) && count($designer_match) > 1)
            unset($designer_match[array_search("",$designer_match)]);
        elseif (@in_array("",$designer_match) && count($designer_match) == 1)
            unset($designer_match);        
                    
        if (is_array($designer_match) && count($designer_match)) {
            array_walk($designer_match,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."proposals.designer_hash IN (".implode(" , ",$designer_match).")";
            array_walk($designer_match,'strip_quotes');
        }  
        
        if (@in_array("",$sales_coord_match) && count($sales_coord_match) > 1)
            unset($sales_coord_match[array_search("",$sales_coord_match)]);
        elseif (@in_array("",$sales_coord_match) && count($sales_coord_match) == 1)
            unset($sales_coord_match);                

        if (is_array($sales_coord_match) && count($sales_coord_match)) {
            array_walk($sales_coord_match,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."proposals.sales_coord_hash IN (".implode(" , ",$sales_coord_match).")";
            array_walk($sales_coord_match,'strip_quotes');
        }  
        
        if (@in_array("",$proj_mngr_match) && count($proj_mngr_match) > 1)
            unset($proj_mngr_match[array_search("",$proj_mngr_match)]);
        elseif (@in_array("",$proj_mngr_match) && count($proj_mngr_match) == 1)
            unset($proj_mngr_match);                        


        if (is_array($proj_mngr_match) && count($proj_mngr_match)) {
            array_walk($proj_mngr_match,'add_quotes',"'");
            $sql_p[] = DB_PREFIX."proposals.proj_mngr_hash IN (".implode(" , ",$proj_mngr_match).")";
            array_walk($proj_mngr_match,'strip_quotes');
        }  

        //proposal_fully_invoiced => when zero means that it is fully invoiced
        
        switch ($status) {
            case 1:
            $sql_p[] = DB_PREFIX."proposals.closed = 0";
            $having_p[] = "proposal_booked > 0";
            $this->report_title = "Proposals that are booked but not yet complete";
            break;
            
            case 2:
            $sql_p[] = DB_PREFIX."proposals.closed = 0";
            $having_p[] = "proposal_booked > 0 AND proposal_fully_invoiced = 0";
            $this->report_title = "Proposals that are booked and invoiced but not yet complete";            
            break;
            
            case 13:
            $sql_p[] = DB_PREFIX."proposals.closed = 1";
            $this->report_title = "Proposals that have been marked complete";
            break;
            
            case 3:
            $having_p[] = "proposal_booked > 0 AND proposal_fully_invoiced > 0";
            $this->report_title = "Proposals that are booked but not yet invoiced";            
            break;
            
            case 4:
            $having_p[] = "proposal_booked > 0 AND total_ack_lines = proposal_booked AND proposal_fully_invoiced > 0";
            $this->report_title = "Proposals that are booked and fully acknowledged, but not yet invoiced";            
            break;
            
            case 5:
            $having_p[] = "proposal_booked > 0 AND total_ack_lines > 0 AND proposal_fully_invoiced >= 0";
            $this->report_title = "Proposals that are booked and partially acknowledged, but not yet invoiced";
            break;
            
            case 6:
            $having_p[] = "proposal_booked > 0 AND total_unshipped > 0";
            $this->report_title = "Proposals that are booked and only partially shipped";
            break;
            
            case 7:
            $having_p[] = "proposal_booked > 0 AND proposal_booked = total_shipped AND total_received = 0 AND total_unreceived > 0";
            $this->report_title = "Proposals that are booked, fully shipped, but not yet received";
            break;
            
            case 8:
            $having_p[] = "proposal_booked > 0 AND proposal_booked = total_shipped AND total_received > 0 AND total_unreceived > 0";
            $this->report_title = "Proposals that are booked, fully shipped, and partially received";
            break;
            
            case 9:
            $having_p[] = "proposal_booked > 0 AND proposal_booked = total_shipped AND total_received = total_shipped AND proposal_fully_invoiced > 0";
            $this->report_title = "Proposals that are booked, fully shipped, fully received, but not yet invoiced";
            break;
            
            case 10:
            $having_p[] = "proposal_booked > 0 AND proposal_booked = total_shipped AND total_received = total_shipped AND proposal_fully_invoiced = 0";
            $this->report_title = "Proposals that are booked, fully shipped, fully received, and invoiced in full";
            break;
            
            case 11:
            $having_p[] = "proposal_booked = 0 AND proposed_lines > 0";    
            $this->report_title = "Proposals that are partially booked, containing lines remaining to be booked";        
            break; 

            case 15:
            $sql_p[] = DB_PREFIX."proposals.closed = 0";
            $having_p[] = "total_punchlist_lines > 0 AND total_punchlist_booked = total_punchlist_lines";
            $this->report_title = "Proposals that containg punchlist that are booked but not yet complete";
            break;
            
            case 14:
            $having_p[] = "total_punchlist_lines > 0 AND total_punchlist_booked < total_punchlist_lines";
            $this->report_title = "Proposals that containg punchlist that have not yet booked";
            break;    

            case 16:
            $having_p[] = "total_punchlist_lines > 0 AND total_punchlist_invoiced < total_punchlist_booked";           
            $this->report_title = "Proposals that containg punchlist that are booked but not yet invoiced";
            break;
            
            case 12:
            $having_p[] = "proposed_lines > proposal_booked";
            $this->report_title = "Proposals that are proposed, but not yet booked";            
            break;  
           	

        }
        
        if ($sql_p) 
            $sql = implode(" AND ",$sql_p);
        if ($having_p) 
            $having = implode(" AND ",$having_p);        
            
        $str = "detail=$detail|customer_filter=".@implode("&",$customer_filter)."|proposal_filter=".@implode("&",$proposal_filter)."|sales_rep_match=".@implode("&",$sales_rep_match)."|sales_coord_match=".@implode("&",$sales_coord_match)."|proj_mngr_match=".@implode("&",$proj_mngr_match)."|designer_match=".@implode("&",$designer_match)."|status=$status";
        
        if (!$report_hash) {
            $report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
            while (global_classes::key_exists(DB_PREFIX.'reports','report_hash',$report_hash))
                $report_hash = md5(global_classes::get_rand_id(32,"global_classes"));
                
            $this->db->query("INSERT INTO `".DB_PREFIX."reports`
                              (`timestamp` , `saved` , `saved_catagory` , `report_hash` , `owner_hash` , `report_name` , `report_descr` , `str`)
                              VALUES (".time()." , '".($save ? 1 : 0)."' , '$saved_cat' , '$report_hash' , '".$this->current_hash."' , '$report_name' , '$report_descr' , '$str')");

            if ($share && (count($group_share) || count($sales_rep_share))) {
                for ($i = 0; $i < count($group_share); $i++)
                    $this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
                                      (`report_hash` , `group_hash`)
                                      VALUES ('$report_hash' , '".$group_share[$i]."')");
                
                for ($i = 0; $i < count($sales_rep_share); $i++)
                    $this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
                                      (`report_hash` , `user_hash`)
                                      VALUES ('$report_hash' , '".$sales_rep_share[$i]."')");
            }       
        } elseif (!$limit_start) {
            $existing = true;
            $this->db->query("UPDATE `".DB_PREFIX."reports`
                              SET `timestamp` = ".time()." , `saved` = '$save' , `saved_catagory` = '$saved_cat' , `owner_hash` = '".$this->current_hash."' , `report_name` = '$report_name' , `report_descr` = '$report_descr' , `str` = '$str' 
                              WHERE `report_hash` = '$report_hash'");
        
            if (!$share)
                $this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
                                  WHERE `report_hash` = '".$this->report_hash."'");
            else {
                if (!is_array($sales_rep_share))
                    $sales_rep_share = array();
                if (!is_array($group_share))
                    $group_share = array();
                    
                //Share or revoke to users
                $result = $this->db->query("SELECT `user_hash`
                                            FROM `".DB_PREFIX."reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_users[] = $row['user_hash'];
                    
                if (!is_array($current_share_users))
                    $current_share_users = array();
                    
                $to_remove = array_diff($current_share_users,$sales_rep_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
                                          WHERE `user_hash` = '".$current_share_users[$i]."'");
                }
                $to_add = array_diff($sales_rep_share,$current_share_users);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
                                          (`report_hash` , `user_hash`)
                                          VALUES ('$report_hash' , '".$sales_rep_share[$i]."'");
                }

                //Share or revoke to groups
                $result = $this->db->query("SELECT `group_hash`
                                            FROM `".DB_PREFIX."reports_share`
                                            WHERE `report_hash` = '$report_hash'");
                while ($row = $this->db->fetch_assoc($result))
                    $current_share_groups[] = $row['group_hash'];
                    
                if (!is_array($current_share_groups))
                    $current_share_groups = array();
                    
                $to_remove = array_diff($current_share_groups,$group_share);
                if (is_array($to_remove)) {
                    while (list($i) = each($to_remove))
                        $this->db->query("DELETE FROM `".DB_PREFIX."reports_share`
                                          WHERE `group_hash` = '".$current_share_groups[$i]."'");
                }
                $to_add = array_diff($group_share,$current_share_groups);
                if (is_array($to_add)) {
                    while (list($i) = each($to_add))
                        $this->db->query("INSERT INTO `".DB_PREFIX."reports_share`
                                          (`report_hash` , `group_hash`)
                                          VALUES ('$report_hash' , '".$group_share[$i]."'");
                }
            }
        }
        $max_memory = server_info('memory_limit');
        $this->report_hash = $report_hash;

        $result = $this->db->query("SELECT ".(!$limit_start ? "SQL_CALC_FOUND_ROWS " : NULL) . DB_PREFIX."proposals.obj_id AS pobj_id , ".DB_PREFIX."proposals.proposal_hash , 
                                    ".DB_PREFIX."proposals.sales_hash , ".DB_PREFIX."proposals.proposal_no , 
                                    ".DB_PREFIX."proposals.proposal_descr  , ".DB_PREFIX."customers.customer_name , 
                                    ".DB_PREFIX."proposal_install.target_install_date , ".DB_PREFIX."proposal_install.actual_install_date , 
                                    ".DB_PREFIX."proposals.status , ".DB_PREFIX."users.full_name AS sales_rep ,
                                    (
                                        SELECT `full_name`
                                        FROM `".DB_PREFIX."users`
                                        WHERE `id_hash` = ".DB_PREFIX."proposals.proj_mngr_hash
                                    ) AS project_mngr ,
                                    ( 
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.po_hash != ''
                                    ) AS proposal_booked ,
                                    ( 
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND (".DB_PREFIX."line_items.invoice_hash = '' AND ".DB_PREFIX."line_items.sell != 0)
                                    ) AS proposal_fully_invoiced ,
                                    (
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.ack_no != ''                                   
                                    ) AS total_ack_lines ,
                                    (
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.ship_date != '' AND ".DB_PREFIX."line_items.ship_date <= '".date("Y-m-d")."'                                   
                                    ) AS total_shipped ,      
                                    (
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.po_hash != '' AND (".DB_PREFIX."line_items.ship_date = '' OR ".DB_PREFIX."line_items.ship_date > '".date("Y-m-d")."')  
                                    ) AS total_unshipped ,   
                                    (
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.receive_date != '' AND ".DB_PREFIX."line_items.receive_date <= '".date("Y-m-d")."'  
                                    ) AS total_received ,  
                                    (
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.po_hash != '' AND (".DB_PREFIX."line_items.receive_date = '' OR ".DB_PREFIX."line_items.receive_date > '".date("Y-m-d")."')  
                                    ) AS total_unreceived ,
                                    (
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.po_hash = ''
                                    ) AS proposed_lines ,  
                                    (
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.punch = 1
                                    ) AS total_punchlist_lines ,
                                    (
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.punch = 1 AND ".DB_PREFIX."line_items.po_hash != ''
                                    ) AS total_punchlist_booked ,  
                                    (
                                        SELECT COUNT(".DB_PREFIX."line_items.obj_id)
                                        FROM ".DB_PREFIX."line_items
                                        WHERE ".DB_PREFIX."line_items.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."line_items.punch = 1 AND ".DB_PREFIX."line_items.po_hash != '' AND ".DB_PREFIX."line_items.invoice_hash != ''
                                    ) AS total_punchlist_invoiced ,                                                                      
                                    (
                                        SELECT COUNT(".DB_PREFIX."purchase_order.obj_id)
                                        FROM ".DB_PREFIX."purchase_order
                                        WHERE ".DB_PREFIX."purchase_order.proposal_hash = ".DB_PREFIX."proposals.proposal_hash
                                    ) AS total_po ,
                                    (
                                        SELECT COUNT(".DB_PREFIX."purchase_order.obj_id)
                                        FROM ".DB_PREFIX."purchase_order
                                        WHERE ".DB_PREFIX."purchase_order.proposal_hash = ".DB_PREFIX."proposals.proposal_hash AND ".DB_PREFIX."purchase_order.punch = 1
                                    ) AS total_punch_po                                                                     
                                    FROM `".DB_PREFIX."proposals`
                                    LEFT JOIN `".DB_PREFIX."proposal_install` ON ".DB_PREFIX."proposal_install.proposal_hash = ".DB_PREFIX."proposals.proposal_hash
                                    LEFT JOIN `".DB_PREFIX."customers` ON ".DB_PREFIX."customers.customer_hash = ".DB_PREFIX."proposals.customer_hash
                                    LEFT JOIN `".DB_PREFIX."users` ON ".DB_PREFIX."users.id_hash = ".DB_PREFIX."proposals.sales_hash".($sql ? "
                                    WHERE ".$sql : NULL).($having ? "
                                    HAVING ".$having : NULL)."
                                    ORDER BY ".DB_PREFIX."proposals.sales_hash , ".DB_PREFIX."proposals.proposal_no ASC".($limit_start ? "
                                    LIMIT $limit_start , $total_rows" : NULL));
        while ($row = $this->db->fetch_assoc($result)) {
            if ($row['sales_hash']) 
                $this->results[$row['sales_hash']][] = $row;
                            
            if (!$limit_start && $detail == 1 && $k < 10) 
            	$this->sub_detail[$row['proposal_hash']] = $this->show_po_details($row['proposal_hash']);
            if ($k > 0 && $k % 10 == 0) {
                if ($k > 200 || bcdiv(memory_get_usage(),$max_memory,4) >= .8) {
                    $this->limit_start = $k + 1 + ($limit_start ? $limit_start : 0);		
				    if ($detail != 1 || !$this->total_rows || !is_numeric($this->total_rows)) {
                        $r = $this->db->query("SELECT FOUND_ROWS() AS t");
                        $this->total_rows = $this->db->result($r,0,'t');
				    }
				    $this->db->free_result($result);
                    break;
                }
            } 
            $k++;            
        }                 

        if (!$limit_start)
            $this->content['action'] = 'close';
        else        
            $this->content['action'] = 'continue';            

        if ($limit_start) {
        	if ($this->ajax_vars['sales_map'])
                $this->sales_map = explode("|",$this->ajax_vars['sales_map']);        	
        	
            $str = $this->status_report(1,$limit_start);
            //Write the contents to a temp file so that we can remove line breaks for the javascript function call
    	    $temp = tempnam(SITE_ROOT.'core/tmp','pre_');
    	    $fh = fopen($temp,'w');
    	    fwrite($fh,trim($str));
    	    fclose($fh);	

    	    unset($str);
    	    $file_str = file($temp);
    	    for ($i = 0; $i < count($file_str); $i++) 
        		$str .= trim(str_replace("'","\'",$file_str[$i]));
	    
            unlink($temp,$this->sub_detail);
	    
    	    $this->content['jscript'][] = "\$('table_content_control').insert({bottom:'".$str."'});";	    
        } else 
            $this->content['html']['place_holder'] = $this->status_report(1);
        
        if ($this->limit_start) {
        	if ($this->sales_map)
                $sales_keys = array_values($this->sales_map);
        	
            $this->content['jscript'][] = "agent.call('reports','sf_loadcontent','cf_loadcontent','doit_status_report','report_hash=".$this->report_hash."','limit_start=".$this->limit_start."','total_rows=".$this->total_rows."'".($sales_keys ? ",'sales_map=".@implode("|",$sales_keys)."'" : NULL).");";
        } elseif ($detail == 1) 
            $this->content['jscript'][] = "remote_fetch();";                
	
        return;	
	}	
	
    function fetch_proposal_notes($proposal_hash=NULL) {
        if ($proposal_hash)
            $local = true;
        elseif ($this->ajax_vars['proposal_hash'])
            $proposal_hash = $this->ajax_vars['proposal_hash'];
        else
            return;
            
        $result = $this->db->query("SELECT ".DB_PREFIX."proposal_notes.note , ".DB_PREFIX."proposal_notes.type , ".DB_PREFIX."proposal_notes.timestamp , 
                                    ".DB_PREFIX."users.full_name , ".DB_PREFIX."proposal_notes.note_hash , ".DB_PREFIX."proposal_notes.user_hash
                                    FROM `".DB_PREFIX."proposal_notes`
                                    LEFT JOIN `".DB_PREFIX."users` ON ".DB_PREFIX."users.id_hash = ".DB_PREFIX."proposal_notes.user_hash
                                    WHERE `proposal_hash` = '$proposal_hash'
                                    ORDER BY ".DB_PREFIX."proposal_notes.type , ".DB_PREFIX."proposal_notes.timestamp ASC");
        while ($row = $this->db->fetch_assoc($result))
            $note[$row['type']][] = $row;
            
        if ($note['p'] || $note['d'] || $note['i']) {
            $note_tbl .= "
            <div style=\"margin-left:10px;background-color:#efefef;border:1px solid #cccccc;width:90%;padding:5px;font-size:8pt;\">";
            if ($note['p']) {
                $note_tbl .= "
                <div style=\"font-weight:bold;margin-bottom:5px;\">Proposal Notes:</div>";
                for ($j = 0; $j < count($note['p']); $j++)
                    $note_tbl .= "
                    <div style=\"margin-bottom:5px;\">
                    ".stripslashes($note['p'][$j]['full_name'])." (".date(DATE_FORMAT." ".TIMESTAMP_FORMAT,$note['p'][$j]['timestamp']).") - ".stripslashes($note['p'][$j]['note'])."
                    ".($note['p'][$j]['user_hash'] == $this->current_hash ? 
                        "[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('status_reports','sf_loadcontent','show_popup_window','addnote','proposal_hash=$proposal_hash','note_hash=".$note['p'][$j]['note_hash']."','popup_id=note_win');\" class=\"link_standard\">edit</a></small>]" : NULL)."
                    </div>";
            }
            if ($note['d']) {
                $note_tbl .= "
                <div style=\"font-weight:bold;margin-bottom:5px;\">Design Notes:</div>";
                for ($j = 0; $j < count($note['d']); $j++)
                    $note_tbl .= "
                    <div style=\"margin-bottom:5px;\">
                    ".stripslashes($note['d'][$j]['full_name'])." (".date(DATE_FORMAT." ".TIMESTAMP_FORMAT,$note['d'][$j]['timestamp']).") - ".stripslashes($note['d'][$j]['note'])."
                    ".($note['d'][$j]['user_hash'] == $this->current_hash ? 
                        "[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('status_reports','sf_loadcontent','show_popup_window','addnote','proposal_hash=$proposal_hash','note_hash=".$note['d'][$j]['note_hash']."','popup_id=note_win');\" class=\"link_standard\">edit</a></small>]" : NULL)."
                    </div>";
            }
            if ($note['i']) {
                $note_tbl .= "
                <div style=\"font-weight:bold;margin-bottom:5px;\">Install Notes:</div>";
                for ($j = 0; $j < count($note['i']); $j++)
                    $note_tbl .= "
                    <div style=\"margin-bottom:5px;\">
                    ".stripslashes($note['i'][$j]['full_name'])." (".date(DATE_FORMAT." ".TIMESTAMP_FORMAT,$note['i'][$j]['timestamp']).") - ".stripslashes($note['i'][$j]['note'])."
                    ".($note['i'][$j]['user_hash'] == $this->current_hash ? 
                        "[<small><a href=\"javascript:void(0);\" onClick=\"agent.call('status_reports','sf_loadcontent','show_popup_window','addnote','proposal_hash=$proposal_hash','note_hash=".$note['i'][$j]['note_hash']."','popup_id=note_win');\" class=\"link_standard\">edit</a></small>]" : NULL)."
                    </div>";
            }
        
            $note_tbl .= "
            </div>";
        }

        if ($local)
            return $note_tbl;
        else
            $this->content['html']['note_table_holder'.$proposal_hash] = $note_tbl;
    }	
	
    function status_report($step=NULL,$active_limit_start=NULL) {
        $this->unlock("_");
        
        if ($step) {
            $this->fetch_report_settings($this->report_hash);
            
            $tbl = (!$active_limit_start ? "
	            <table class=\"tborder\" cellspacing=\"0\" cellpadding=\"6\" style=\"background-color:#8c8c8c;width:900px;margin-top:0;\" id=\"table_content_control\">
	                <tr>
	                    <td style=\"width:100%;background-color:#ffffff;padding:10px;\" colspan=\"7\">
	                        <h3 style=\"margin-bottom:5px;color:#00477f;margin-top:-5px;\">
	                            ".($this->current_report['saved'] ? 
	                                $this->current_report['report_name'] : "Project Status Report")."
	                            <span style=\"font-size:10pt;padding-left:15px;font-weight:normal;\">
	                                [<small><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','status_report','popup_id=report_filter','report_hash=".$this->report_hash."');\" class=\"link_standard\">Update Report Settings</a></small>]
	                            </span>
	                        </h3>
	                        <div style=\"margin-left:20px;margin-bottom:10px;margin-top:10px;\">
	                            <small style=\"margin-left:20px;margin-bottom:10px;\"><a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','navigator');\" class=\"link_standard\"><strong><- Back to Report Navigator</a></small>
	                            <!--&nbsp;&nbsp;
	                            <a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','show_popup_window','print_it','type=cash_disp','report_hash=".$this->report_hash."');\"><img src=\"images/print.gif\" border=\"0\" alt=\"Print this report\" /></a>
	                            &nbsp;&nbsp;
	                            <a href=\"javascript:void(0);\" class=\"link_standard\" ><img src=\"images/excel.gif\" alt=\"Export report into a spreadsheet.\" border=\"0\" /></a>-->
	                        </div>
	                    </td>
	                </tr>" : NULL);
                
                if ($this->results) {                           
	                while (list($sales_hash,$details) = each($this->results)) {
	                    $tbl .= (!$active_limit_start || ($active_limit_start && (!is_array($this->sales_map) || !in_array($sales_hash,$this->sales_map))) ? "
	                    <tr class=\"thead\" style=\"font-weight:bold;\">
    	                    <td style=\"font-size:8pt;width:125px;vertical-align:bottom;\">Proposal No.</td>
    	                    <td style=\"font-size:8pt;vertical-align:bottom;\">Customer</td>
    	                    <td style=\"font-size:8pt;vertical-align:bottom;\">Project Description</td>
    	                    <td style=\"font-size:8pt;\" nowrap>Target Install</td>
    	                    <td style=\"font-size:8pt;\" nowrap>Sched Install</td> 
    	                    <td style=\"font-size:8pt;\" nowrap>Project Mngr</td>
    	                    <td style=\"font-size:8pt;text-align:right;padding-right:5px;vertical-align:bottom;\">Invoiced</td>
    	                </tr>
    	                <tr>
        	                <td colspan=\"7\" style=\"font-size:8pt;background-color:#efefef;font-weight:bold;vertical-align:middle;border-top:1px solid #cccccc;border-bottom:1px solid #cccccc\">
            	                Sales Rep: ".stripslashes($details[0]['sales_rep'])." (".count($details).")<br />
            	            </td>
            	        </tr>" : NULL);
	                    if (!is_array($this->sales_map) || !in_array($sales_hash,$this->sales_map))
    	                    $this->sales_map[] = $sales_hash;                    
    	                    
	                    $b = 0;
                        
	                    $count_details = count($details);
	                    for ($i = 0; $i < $count_details; $i++) {
	                        $b++;
	                        $po_date_flag = false;
	                        
	                        unset($po_list_tbl);
	                        if ($details[$i]['total_po'] > 0) {                               
	                            $po_list_tbl = "
	                            <tr>
	                                <td colspan=\"7\" style=\"font-size:8pt;background-color:#ffffff;\">
	                                    <div style=\"margin-left:10px;\">
	                                        <div style=\"padding-bottom:4px;font-size:8pt\" >
	                                            <img src=\"images/".($this->current_report['detail'] == 1 ? "collapse" : "expand").".gif\" />
	                                            &nbsp;
	                                            <a href=\"javascript:void(0);\" onClick=\"if(\$('po_holder".$details[$i]['proposal_hash']."').getStyle('display')=='block'){toggle_display('po_holder".$details[$i]['proposal_hash']."','none');\$('po_holder".$details[$i]['proposal_hash']."').innerHTML='';} else{agent.call('reports','sf_loadcontent','cf_loadcontent','show_po_details','proposal_hash=".$details[$i]['proposal_hash']."');}\" title=\"Show/Hide PO Details\" class=\"link_standard\">".$details[$i]['total_po']." Purchase Order".($details[$i]['total_po'] > 1 ? "s" : NULL)."</a>".($details[$i]['total_punch_po'] ? "
	                                            <span style=\"padding-left:5px;color:green;\">(".$details[$i]['total_punch_po']." Punchlist PO".($details[$i]['total_punch_po'] > 1 ? "s" : NULL).")</span>" : NULL)."
	                                        </div>
	                                        <div id=\"po_holder".$details[$i]['proposal_hash']."\" style=\"display:".($this->current_report['detail'] == 1 ? "block" : "none").";\">".($this->current_report['detail'] == 1 ? 
                                                ($this->sub_detail[$details[$i]['proposal_hash']] ? 
                                                    $this->sub_detail[$details[$i]['proposal_hash']] : "<img src=\"images/content_loader.gif\" content_holder=\"1\" content_id=\"".$details[$i]['pobj_id']."\" style=\"margin-left:20px;margin-top:5px;\" />") : NULL)."	                                        
	                                        </div>
	                                    </div>
	                                </td>
	                            </tr>";
	                        }
	                        $tbl .= "
	                        <tr>
	                            <td style=\"font-weight:bold;background-color:#ffffff;font-size:8pt;\">
	                                <a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','get_notes','proposal_hash=".$details[$i]['proposal_hash']."','report_hash=".$this->report_hash."');\" class=\"link_standard\" title=\"Update information on this proposal\">
	                                    <strong>".$details[$i]['proposal_no']."</strong>
	                                </a>
	                                <div id=\"proposalListHolder".$details[$i]['proposal_hash']."\"></div>
	                            </td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;\">".$details[$i]['customer_name']."</td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;\">".(strlen($details[$i]['proposal_descr']) > 75 ? 
	                                substr($details[$i]['proposal_descr'],0,75)."...." : $details[$i]['proposal_descr'])."
	                            </td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;\" id=\"target_date_".$details[$i]['proposal_hash']."\">".($details[$i]['target_install_date'] && date("Y",strtotime($details[$i]['target_install_date'])) > 2000 ? 
	                                date(DATE_FORMAT,strtotime($details[$i]['target_install_date'])) : NULL)."
	                            </td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;\" id=\"actual_date_".$details[$i]['proposal_hash']."\">".($details[$i]['actual_install_date'] && date("Y",strtotime($details[$i]['actual_install_date'])) > 2000 ? 
	                                ($po_date_flag ? "
	                                    <img src=\"images/alert.gif\" alt=\"Storage notification may be required for one or more purchase orders under this proposal!\" />&nbsp;&nbsp;" : NULL).
	                                date(DATE_FORMAT,strtotime($details[$i]['actual_install_date'])) : NULL)."
	                            </td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;\">".$this->user_map[$details[$i]['proj_mngr_hash']]."</td>
	                            <td style=\"font-size:8pt;background-color:#ffffff;text-align:right;padding-right:5px;\">".($details[$i]['proposal_fully_invoiced'] == 0 ? 
	                                "<img src=\"images/check.gif\" alt=\"This proposal has been invoiced in full\" />" : "&nbsp;")."
	                            </td>
	                        </tr>
	                        <tr>
	                            <td colspan=\"7\" style=\"font-size:8pt;background-color:#ffffff;padding-bottom:10px;\">
	                                <div style=\"margin-left:10px;margin-bottom:3px;\">
	                                    [<small><a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"agent.call('status_reports','sf_loadcontent','show_popup_window','addnote','proposal_hash=".$details[$i]['proposal_hash']."','popup_id=note_win');\">new note</a></small>]
	                                </div>
	                                <div id=\"note_table_holder".$details[$i]['proposal_hash']."\">".$this->fetch_proposal_notes($details[$i]['proposal_hash'])."</div>
	                            </td>
	                        </tr>" . 
	                        ($po_list_tbl ? 
	                            $po_list_tbl : NULL)."
	                        <tr>
	                            <td style=\"font-size:8pt;background-color:#cccccc;\" colspan=\"7\"></td>
	                        </tr>";
	                    }
	                }
                } else                                                              
	                $tbl .= "
	                <tr style=\"font-size:8pt;background-color:#ffffff;\">
	                    <td style=\"border-top:1px solid #cccccc;padding-top:15px;\" colspan=\"7\">There are no results to show.</td>
	                </tr>";

    	    if (!$active_limit_start)
            	$tbl .= "
            	</table>";                      
            
            if (!$active_limit_start) {
	            $jscript = '
	            remote_fetch = function() {
					if (agent.in_progress == true) {
						setTimeout("remote_fetch();",1000);
						return;
					}
					var pending = $$(\'img[content_holder=1]\');
	                var i=0, c, str=\'\', atr;
	                while (c = pending[i++]) {
	                    var yes = true;
	                    if (i > 30)
	                        break;
	                        
	                    if (atr = c.readAttribute(\'content_id\'))
	                        str += atr + \'|\';
	                }
	                if (yes)
	                    agent.call(\'reports\',\'sf_loadcontent\',\'cf_loadcontent\',\'show_po_details\',\'report_hash='.$this->report_hash.'\',\'pstr=\' + str);
	            }';            
                $this->content['jscript'][] = $jscript;
            }
            
            return $tbl;
        } else {
            $report_hash = $this->ajax_vars['report_hash'];
            $this->fetch_report_settings($report_hash);
            
            array_shift($this->user_name);
            array_shift($this->user_hash);  

            if ($this->current_report['customer_filter'] && !is_array($this->current_report['customer_filter']))
                $this->current_report['customer_filter'] = array($this->current_report['customer_filter']);
            if ($this->current_report['proposal_filter'] && !is_array($this->current_report['proposal_filter']))
                $this->current_report['proposal_filter'] = array($this->current_report['proposal_filter']);                                     

            $this->content['popup_controls']['popup_id'] = $this->popup_id = $this->ajax_vars['popup_id'];
            if ($report_hash && $this->current_report['report_owner'] != $this->current_hash)
                unset($report_hash);
            
            $tbl = $this->form->form_tag().
            $this->form->hidden(array('test' => 1, 'report_hash' => $report_hash, 'popup_id' => $this->popup_id))."
            <div class=\"panel\">
                <div id=\"feedback_holder".$this->popup_id."\" style=\"background-color:#ffffff;border:1px solid #cccccc;font-weight:bold;padding:5px;display:none;margin-bottom:5px;\">
                    <h3 class=\"error_msg\" style=\"margin-top:0;\">Error!</h3>
                        <p id=\"feedback_message".$this->popup_id."\"></p>
                </div>
                <table cellspacing=\"1\" cellpadding=\"5\" class=\"popup_tab_table\">
                    <tr>
                        <td style=\"padding:0;\">
                             <div style=\"background-color:#ffffff;height:100%;\">
                                <div style=\"margin:15px 35px;\">
                                    <div style=\"float:right;margin-right:25px;margin-top:10px;margin-bottom:15px;\" id=\"go_btn\">
                                        ".$this->form->button("value=Print Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_status_report');").($this->current_report['saved'] && $this->current_hash == $this->current_report['owner_hash'] ? 
                                            "&nbsp;&nbsp;".$this->form->button("value=Delete Report","onClick=submit_form(this.form,'reports','exec_post','refresh_form','action=doit_status_report','rm=1');") : NULL)."
                                    </div>
                                    <h3 style=\"margin-bottom:5px;color:#00477f;\">".($this->current_report['saved'] ? 
                                        $this->current_report['report_name'] : "Project Status Report")."</h3>
                                    <table cellspacing=\"1\" cellpadding=\"5\" style=\"background-color:#8c8c8c;width:100%;margin-top:0;\"
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific proposals?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=proposal",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'),'account_suggest');key_call('reports','proposal','proposal_hash',1);",
                                                                        "onBlur=vtobj.reset_keyResults();key_clear();"
                                                                        )."
                                                
                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['proposal_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"proposal_filter_holder\">";
                                                if (is_array($this->current_report['proposal_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['proposal_filter']); $i++) 
                                                        $tbl .= "<div id=\"proposal_".$this->current_report['proposal_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes($this->proposal_no($this->current_report['proposal_filter'][$i]))."<input type=\"hidden\" id=\"proposal_filter\" name=\"proposal_filter[]\" value=\"".$this->current_report['proposal_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>                                        
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered to specific customers?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->text_box("name=customer",
                                                                        "value=",
                                                                        "autocomplete=off",
                                                                        "size=30",
                                                                        "onFocus=position_element($('keyResults'),findPos(this,'top')+20,findPos(this,'left'));key_call('reports','customer','customer_hash',1);",
                                                                        "onBlur=vtobj.reset_keyResults();key_clear();"
                                                                        )."
                                                
                                                <div style=\"margin-top:15px;width:250px;height:45px;overflow:auto;display:".(is_array($this->current_report['customer_filter']) ? "block" : "none").";background-color:#efefef;border:1px outset #cccccc;\" id=\"customer_filter_holder\">";
                                                if (is_array($this->current_report['customer_filter'])) {
                                                    for ($i = 0; $i < count($this->current_report['customer_filter']); $i++) 
                                                        $tbl .= "<div id=\"customer_".$this->current_report['customer_filter'][$i]."\" style=\"padding:5px 2px 0 5px;\">[<small><a href=\"javascript:void(0);\" onClick=\"remove_el(this.parentElement.parentElement)\" class=\"link_standard\" title=\"Remove from filter\">x</a></small>]&nbsp;".addslashes((strlen($this->customer_name($this->current_report['customer_filter'][$i])) > 25 ? substr($this->customer_name($this->current_report['customer_filter'][$i]),0,22)."..." : $this->customer_name($this->current_report['customer_filter'][$i])))."<input type=\"hidden\" id=\"customer_filter\" name=\"customer_filter[]\" value=\"".$this->current_report['customer_filter'][$i]."\" /></div>";
                                                }
                                            $tbl .= "
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by proposal status?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->select("status",
                                                                      array("Proposals that are booked but not yet complete",
                                                                            "Proposals that are booked and invoiced but not yet complete",
                                                                            "Proposals that have been marked complete",
                                                                            "Proposals that are booked and not yet invoiced",
                                                                            "Proposals that are booked and fully acknowledged, but not yet invoiced",
                                                                            "Proposals that are booked and partially acknowledged, but not yet invoiced",                                                                      
                                                                            "Proposals that are booked and only partially shipped",
                                                                            "Proposals that are booked, fully shipped, but not yet received",
                                                                            "Proposals that are booked, fully shipped, and partially received",
                                                                            "Proposals that are booked, fully shipped, fully received, but not yet invoiced",
                                                                            "Proposals that are booked, fully shipped, fully received, and invoiced in full",
                                                                            "Proposals that are partially booked, containing lines remaining to be booked",
                                                                            "Proposals that containg punchlist that are booked but not yet complete",
                                                                            "Proposals that containg punchlist that have not yet booked",
                                                                            "Proposals that containg punchlist that are booked but not yet invoiced",
                                                                            "Proposals that are proposed, but not yet booked"),
                                                                      $this->current_report['status'],
                                                                      array(1,2,13,3,4,5,6,7,8,9,10,11,15,14,16,12),
                                                                      "blank=1",
                                                                      "style=width:400px")."
                                            </td>                                            
                                        </tr>                                        
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales rep?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("sales_rep_match[]",array_merge(array("All Sales Reps"),$this->user_name),(is_array($this->current_report['sales_rep_match']) ? $this->current_report['sales_rep_match'] : array($this->current_report['sales_rep_match'])),array_merge(array(''),$this->user_hash),"multiple","blank=1","size=4","style=width:200px;")."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by sales coordinator?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("sales_coord_match[]",array_merge(array("All Sales Reps"),$this->user_name),(is_array($this->current_report['sales_coord_match']) ? $this->current_report['sales_coord_match'] : array($this->current_report['sales_coord_match'])),array_merge(array(''),$this->user_hash),"multiple","blank=1","size=4","style=width:200px;")."</td>
                                        </tr>
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by designer?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("designer_match[]",array_merge(array("All Sales Reps"),$this->user_name),(is_array($this->current_report['designer_match']) ? $this->current_report['designer_match'] : array($this->current_report['designer_match'])),array_merge(array(''),$this->user_hash),"multiple","blank=1","size=4","style=width:200px;")."</td>
                                        </tr>                                                                                
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Should the report be<br />filtered by project manager?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("proj_mngr_match[]",array_merge(array("All Sales Reps"),$this->user_name),(is_array($this->current_report['proj_mngr_match']) ? $this->current_report['proj_mngr_match'] : array($this->current_report['proj_mngr_match'])),array_merge(array(''),$this->user_hash),"multiple","blank=1","size=4","style=width:200px;")."</td>
                                        </tr>                                                                                                                        
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Show Purchase Order Detail?</td>
                                            <td style=\"background-color:#ffffff;\">".$this->form->select("detail",array("Show Detail View","Show Simple View"),$this->current_report['detail'],array(1,0),"blank=1")."</td>
                                        </tr>                                        
                                        <tr>
                                            <td style=\"text-align:right;background-color:#efefef;vertical-align:top;\">Add this report to<br />your saved reports?</td>
                                            <td style=\"background-color:#ffffff;\">
                                                ".$this->form->checkbox("name=save","value=1",($this->current_report['saved'] ? "checked" : NULL),"onClick=toggle_display('saved_report_name',this.checked?'block':'none')")."
                                                <div style=\"padding-top:5px;display:".($this->current_report['saved'] ? "block" : "none").";\" id=\"saved_report_name\">
                                                    What should the report be called?
                                                    <br />
                                                    ".$this->form->text_box("name=report_name",
                                                                            "value=".$this->current_report['report_name'],
                                                                            "autocomplete=off",
                                                                            "size=30",
                                                                            "style=margin-top:5px;margin-bottom:10px;"
                                                                            )."
                                                    <br />
                                                    Optional description for the report:
                                                    <br />
                                                    ".$this->form->text_area("name=report_descr",
                                                                            "value=".$this->current_report['report_descr'],
                                                                            "rows=3",
                                                                            "cols=50",
                                                                            "style=margin-top:5px;"
                                                                            )."
                                                    <div style=\"padding-top:5px\">                                                     
                                                        ".$this->form->checkbox("name=share","value=1",($this->current_report['share'] ? "checked" : NULL),"onClick=toggle_display('share_report_select',this.checked?'block':'none')")."&nbsp;Share this report?
                                                        <div style=\"padding-top:10px;display:".($this->current_report['share'] ? "block" : "none").";\" id=\"share_report_select\">
                                                            Share to the following users:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("sales_rep_share[]",$this->user_name,$this->current_report['sales_rep_share'],$this->user_hash,"multiple","size=4","blank=1","style=width:200px;")."
                                                            </div>
                                                            Share to the following groups:
                                                            <div style=\"padding-top:5px;padding-bottom:5px;\">
                                                                ".$this->form->select("group_share[]",$this->group_name,$this->current_report['group_share'],$this->group_hash,"multiple","size=4","blank=1","style=width:200px;")."
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>".
            $this->form->close_form();

            $this->content['popup_controls']["cmdTable"] = $tbl;
            $this->content['popup_controls']['popup_title'] = "Report Settings & Preferences";
            $this->content['jscript'] = $jscript;
            
            return;
        }               
    }
    
    function get_notes() {
        $proposal_hash = $this->ajax_vars['proposal_hash'];
        $report_hash = $this->ajax_vars['report_hash'];
        $p = new proposals($this->current_hash);
        $p->fetch_master_record($proposal_hash);
        
        $tbl = 
        $this->form->form_tag().
        $this->form->hidden(array("proposal_hash" => $proposal_hash, 
                                  "report_hash" => $report_hash))."
        <div id=\"proposalList".$proposal_hash."\" class=\"function_menu\" style=\"width:465px;display:block;z-index:1\">
            <div style=\"float:right;padding:3px\">
                <a href=\"javascript:void(0);\" onClick=\"toggle_display('proposalList".$proposal_hash."','none');\"><img src=\"images/close.gif\" border=\"0\"></a>
            </div>
            <div class=\"function_menu_item\" style=\"font-weight:bold;background-color:#365082;color:#ffffff;\">
                <span style=\"font-size:8pt;\">Proposal ".$p->current_proposal['proposal_no']."&nbsp;</span>
                <span style=\"font-weight:normal;color:#ffffff;\">
                    [<small><a style=\"color:#ffffff;\" href=\"javascript:void(0);\" onClick=\"agent.call('proposals','sf_loadcontent','show_popup_window','edit_proposal','proposal_hash=".$proposal_hash."','popup_id=proposal_win','from_report=1');\">view proposal</a></small>]
                </span>
            </div>
            <table cellpadding=\"0\" cellspacing=\"1\" style=\"width:100%;\">
                <tr>
                    <td style=\"width:100%;background-color:#bbc7ce;\">
                        <table style=\"width:100%;\" cellpadding=\"5\" cellspacing=\"0\">
                            <tr>
                                <td style=\"text-align:left;width:50%;padding-left:5px;border-bottom:1px solid #ffffff;color:#000000;\">
                                    <div style=\"padding-bottom:5px;font-size:8pt;\">Target Install Date:</div> 
                                    <div id=\"proposal_target_install_date".$proposal_hash."\">";
                                    $this->content['jscript'][] = "setTimeout('DateInput(\'target_install_date\',false, \'YYYY-MM-DD\',\'".($p->current_proposal['target_install_date'] && date("Y",strtotime($p->current_proposal['target_install_date'])) > 2000 ? $p->current_proposal['target_install_date'] : NULL)."\',1,\'proposal_target_install_date".$proposal_hash."\')',100);";                     
                                    $tbl .= "
                                    </div>
                                </td>
                                <td style=\"text-align:left;padding-left:5px;border-bottom:1px solid #ffffff;color:#000000;\">
                                    <div style=\"padding-bottom:5px;font-size:8pt;\">Actual Install Date:</div> 
                                    <div id=\"proposal_actual_install_date".$proposal_hash."\">";
                                    $this->content['jscript'][] = "setTimeout('DateInput(\'actual_install_date\',false, \'YYYY-MM-DD\',\'".($p->current_proposal['actual_install_date'] && date("Y",strtotime($p->current_proposal['actual_install_date'])) > 2000 ? $p->current_proposal['actual_install_date'] : NULL)."\',1,\'proposal_actual_install_date".$proposal_hash."\')',200);";                     
                                    $tbl .= "
                                    </div>
                                </td>
                            </tr>".($p->current_proposal['status'] == 2 ? "
                            <tr>
                                <td style=\"text-align:left;padding-left:5px;border-bottom:1px solid #ffffff;color:#000000;\" colspan=\"2\">
                                    <div style=\"padding-bottom:5px;\">
                                        ".$this->form->checkbox("name=final",
                                                                ($p->current_proposal['closed'] ? "checked" : NULL),
                                                                "value=1")."&nbsp;Mark this proposal complete.
                                    </div>
                                </td>
                            </tr>" : NULL)."
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan=\"2\" style=\"text-align:right;padding:5px;background-color:#bbc7ce;\">
                        ".$this->form->button("value=Save",
                                              ($p->current_proposal['closed'] ? "checked" : NULL),
                                              "onclick=submit_form(this.form,'reports','exec_post','refresh_form','proposal_hash=".$proposal_hash."','action=doit_status_report','method=save_note');")."
                    </td>
                </tr>
            </table>
        </div>".$this->form->close_form();
                                    
        $this->content['html']['proposalListHolder'.$proposal_hash] = $tbl;        
        return;
    }
    
    
    function ship_to($hash) {
        list($class,$id,$hash) = explode("|",$hash);
        if ($class) {
            $obj = new $class($this->current_hash);
            if ($hash) {
                $obj->fetch_location_record($hash);
                $name = $obj->current_location['location_name']."<br />".$obj->current_location['location_street1'].($obj->current_location['location_street2'] ? 
                    "<br />".$obj->current_location['location_street2'] : NULL).($obj->current_location['location_street3'] ? 
                        "<br />".$obj->current_location['location_street3'] : NULL)."<br />".$obj->current_location['location_city'].", ".$obj->current_location['location_state']."&nbsp;".$obj->current_location['location_zip'];
            } else {
                $obj->fetch_master_record($id);
                $name = $obj->{"current_".strrev(substr(strrev($class),1))}[strrev(substr(strrev($class),1))."_name"]."<br />".$obj->{"current_".strrev(substr(strrev($class),1))}["street1"].($obj->{"current_".strrev(substr(strrev($class),1))}["street2"] ? 
                    "<br />".$obj->{"current_".strrev(substr(strrev($class),1))}["street2"] : NULL).($obj->{"current_".strrev(substr(strrev($class),1))}["street3"] ? 
                        "<br />".$obj->{"current_".strrev(substr(strrev($class),1))}["street3"] : NULL)."<br />".$obj->{"current_".strrev(substr(strrev($class),1))}["city"].", ".$obj->{"current_".strrev(substr(strrev($class),1))}["state"]."&nbsp;".$obj->{"current_".strrev(substr(strrev($class),1))}["zip"];
            }
            unset($obj);    
        }
        return $name;           
    }    
    
    function show_po_details($passed_hash=NULL,$report='status_report') {
    	if ($this->ajax_vars['pstr']) {
    		$multi = true;
    		$proposal_hash = explode("|",$this->ajax_vars['pstr']);
    		$report_hash = $this->ajax_vars['report_hash'];
    		$report = ($this->ajax_vars['report_type'] ? $this->ajax_vars['report_type'] : 'status_report');
    		$simple_view = $this->ajax_vars['simple_view'];
    	} elseif ($this->ajax_vars['proposal_hash']) {
            $proposal_hash = array($this->ajax_vars['proposal_hash']);    	            	        
            $report = ($this->ajax_vars['report_type'] ? $this->ajax_vars['report_type'] : 'status_report');           
    	} elseif ($passed_hash) {
        	$proposal_hash = array($passed_hash);
        	$report_hash = $this->report_hash;
        	$local = 1;
        }
		if ($local && (!$this->total_rows || !is_numeric($this->total_rows))) {
		    $r = $this->db->query("SELECT FOUND_ROWS() AS t");
		    $this->total_rows = $this->db->result($r,0,'t');
		}

    	for ($i = 0; $i < count($proposal_hash); $i++) {
    		if ($proposal_hash[$i]) {
		        if ($report == 'status_report') {
	                $po = new purchase_order($proposal_hash[$i],$multi);
	                $po->fetch_purchase_orders(0,$po->total);
	                
	                $lines = new line_items($po->proposal_hash);		        	
		        	
			        $tbl = "
			        <table class=\"tborder\" cellspacing=\"0\" cellpadding=\"7\" style=\"width:95%;\" >
			            <tr style=\"font-weight:bold;background-color:#efefef;\">
			                <td></td>
			                <td style=\"font-size:8pt;\" nowrap >
			                    Vendor / Product or Service
			                    <div style=\"padding-top:5px;\">PO No.</div>
			                </td>
			                <td style=\"font-size:8pt;vertical-align:bottom;\" nowrap>Order Date</td>
			                <td style=\"font-size:8pt;vertical-align:bottom;\" nowrap>Ack No.</td>
			                <td style=\"font-size:8pt;vertical-align:bottom;\" nowrap>Ship Date</td>
			                <td style=\"font-size:8pt;vertical-align:bottom;\" nowrap>Receive Date</td>
			                <td style=\"font-size:8pt;vertical-align:bottom;\" nowrap>Shipping To</td>
			            </tr>
			            <tr>
			                <td colspan=\"7\" style=\"background-color:#cccccc;\"></td>
			            </tr>";
			            
			        for ($j = 0; $j < $po->total; $j++) {
			            $po->fetch_po_record($po->proposal_hash,$po->po_info[$j]['po_hash']);
			            if ($multi && $j == 0)
                            $proposal_hash[$i] = $po->current_po['proposal_hash'];			            
			            
			            $ship_date = $po->fetch_ship_dates($po->po_info[$j]['po_hash']);
			            $time += 30;
			            if (defined('PO_DATE_ALERT') && $ship_date[0] && (strtotime($details[$i]['actual_install_date'] ? $details[$i]['actual_install_date'] : date("Y-m-d")) - strtotime($ship_date[0])) / 86400 >= PO_DATE_ALERT) {
			                $po_date_flag = true;
			                $po_alert = "<img src=\"images/alert.gif\" alt=\"Storage notification may be required for this purchase order!\" />&nbsp;&nbsp;";
			            } else
			                unset($po_alert);
			            
			            $ack_no = $po->fetch_ack_no($po->po_info[$j]['po_hash']);
			            $receive_date = $po->fetch_receive_dates($po->po_info[$j]['po_hash']);
			            $tbl .= "
			            <tr ".($po->po_info[$j]['punch'] == 1 ? "style=\"background-color:#00D647;\" title=\"Punchlist\"" : NULL).">
			                <td style=\"width:18px;padding:3px;vertical-align:top;\" rowspan=\"2\">".($this->p->ck('purchase_order','E') ? "
			                    <a href=\"javascript:void(0);\" onClick=\"agent.call('reports','sf_loadcontent','cf_loadcontent','get_items','po_hash=".$po->po_info[$j]['po_hash']."','proposal_hash=".$proposal_hash[$i]."');\">
	    		                    <img src=\"images/edit_po_item.gif\" border=\"0\" alt=\"Update acknowledgement numbers, shipping &amp; receiving dates for this purchase order.\">
	    		                </a>" : NULL)."
			                    <div id=\"poListHolder".$po->po_info[$j]['po_hash']."\"></div>
			                </td>
			                <td colspan=\"5\" style=\"font-size:8pt;font-style:italic;padding-bottom:0;\">
			                    ".$po->po_info[$j]['vendor_name'].($po->current_po['po_product'] ? " 
			                        : ".$po->current_po['po_product'] : " : Various Products")." 
			                </td>
			                <td style=\"font-size:8pt;vertical-align:bottom;width:150px;\" rowspan=\"2\">".strrev(substr(strrchr(strrev($this->ship_to($po->po_info[$j]['ship_to_hash'])),"<br />"),1))."</td>
			            </tr>
			            <tr ".($po->po_info[$j]['punch'] == 1 ? "style=\"background-color:#00D647;\" title=\"Punchlist\"" : NULL).">
			                <td style=\"width:100px;font-size:8pt;\" >".($this->p->ck('purchase_order','V') ? "
			                    <a href=\"javascript:void(0);\" onClick=\"agent.call('purchase_order','sf_loadcontent','show_popup_window','edit_po','proposal_hash=".$po->proposal_hash."','po_hash=".$po->po_info[$j]['po_hash']."','popup_id=line_item');\" title=\"View this purchase order\" class=\"link_standard\">
			                        ".$po->po_info[$j]['line_items'][0].$po->po_info[$j]['po_no']."</a>" : $po->po_info[$j]['line_items'][0].$po->po_info[$j]['po_no'])."
			                    &nbsp;&nbsp;
			                </td>
			                <td style=\"font-size:8pt;\">".date(DATE_FORMAT." ".TIMESTAMP_FORMAT,$po->po_info[$j]['creation_date'])."</td>
			                <td style=\"font-size:8pt;\" id=\"ack_".$po->po_info[$j]['po_hash']."\">".($po->current_po['fully_ack'] ? 
			                    "<img src=\"images/check.gif\" alt=\"This purchase order is fully acknowledged.\" />" : NULL).($ack_no ? 
			                        " <small>".@implode(", ",$ack_no)."</small>" : NULL)."
			                </td>
			                <td style=\"font-size:8pt;\" id=\"ship_date_".$po->po_info[$j]['po_hash']."\">".($ship_date ? 
			                        "<small>".@implode(", ",$ship_date)."</small>" : NULL)."
			                </td>
			                <td style=\"font-size:8pt;\" id=\"receive_date_".$po->po_info[$j]['po_hash']."\">".($receive_date ? 
			                        "<small>".@implode(", ",$receive_date)."</small>" : NULL)."
			                </td>
			            </tr>".($j < $po->total - 1 ? "
			            <tr>
			                <td colspan=\"7\" style=\"background-color:#cccccc;\" ></td>
			            </tr>" : NULL);
			        }
			        
			        $tbl .= "
			        </table>";
		        } elseif ($report == 'backlog') {
		        	$this->fetch_report_settings($report_hash);
		        	
		        	if ($simple_view) {
		        		$proposal_totals = $this->fetch_backlog_items($proposal_hash[$i],1,1);

						$_SESSION['backlog_total'][$report_hash][$proposal_totals['sales_hash']]['cost'] += ($proposal_totals['ext_cost'] != 0 ? $proposal_totals['ext_cost'] : 0);
						$_SESSION['backlog_total'][$report_hash][$proposal_totals['sales_hash']]['sell'] += ($proposal_totals['ext_sell'] != 0 ? $proposal_totals['ext_sell'] : 0);
		        	} else {
			        	$tbl = "
	                    <table style=\"width:99%;border:1px solid #cccccc\" cellpadding=\"3\" cellspacing=\"0\">
	                        <tr>
	                            <td style=\"background-color:#efefef;font-size:8pt;width:40px;\">Qty</td>
	                            <td style=\"background-color:#efefef;font-size:8pt;width:100px\">Item No.</td>
	                            <td style=\"background-color:#efefef;font-size:8pt;width:225px\">Item Descr.</td>
	                            <td style=\"background-color:#efefef;font-size:8pt;width:95px;\">Ack No.</td>
	                            <td style=\"background-color:#efefef;font-size:8pt;width:95px;\">Ship Date</td>
	                            <td style=\"background-color:#efefef;font-size:8pt;width:95px;\">Receive Date</td>
	                            <td style=\"text-align:right;background-color:#efefef;font-size:8pt;width:100px;\">Ext Cost</td>
	                            <td style=\"text-align:right;background-color:#efefef;font-size:8pt;width:100px;\">Ext Sell</td>
	                            <td style=\"text-align:right;background-color:#efefef;font-size:8pt;padding-right:10px;width:50px\">GP</td>
	                        </tr>";
	                    
	                    $proposal_totals = array();
	                    $backlog_items = $this->fetch_backlog_items($proposal_hash[$i],$multi); 
	                    while (list($po_hash,$item_array) = each($backlog_items)) {
	                    	if ($po_hash != 'UNORDERED') {
		                        $r = $this->db->query("SELECT ".DB_PREFIX."purchase_order.po_no , ".DB_PREFIX."purchase_order.ship_to_hash ,
		                                                ".DB_PREFIX."vendors.vendor_name , ".DB_PREFIX."purchase_order.po_product ,
		                                                ".DB_PREFIX."purchase_order.proposal_hash AS proposal_hash , 
		                                                (
		                                                    SELECT COUNT(*) AS Total
		                                                    FROM `".DB_PREFIX."line_items`
		                                                    WHERE ".DB_PREFIX."line_items.po_hash = ".DB_PREFIX."purchase_order.po_hash AND ".DB_PREFIX."line_items.ack_no != ''
		                                                ) AS total_ack_lines ,
		                                                (
		                                                    SELECT COUNT(*) AS Total
		                                                    FROM `".DB_PREFIX."line_items`
		                                                    WHERE ".DB_PREFIX."line_items.po_hash = ".DB_PREFIX."purchase_order.po_hash AND ".DB_PREFIX."line_items.ack_no = ''
		                                                ) AS total_unack_lines ,
		                                                (
		                                                    SELECT ".DB_PREFIX."proposals.proposal_no
		                                                    FROM ".DB_PREFIX."proposals
		                                                    WHERE ".DB_PREFIX."proposals.proposal_hash = ".DB_PREFIX."purchase_order.proposal_hash
		                                                ) AS proposal_no
		                                               FROM ".DB_PREFIX."purchase_order
		                                               LEFT JOIN ".DB_PREFIX."vendors ON ".DB_PREFIX."vendors.vendor_hash = ".DB_PREFIX."purchase_order.vendor_hash
		                                               WHERE ".DB_PREFIX."purchase_order.po_hash = '$po_hash'");
		                        $po_info = $this->db->fetch_assoc($r);
	                    	}	                        
	                        if ($multi)
	                            $proposal_hash[$i] = ($po_info['proposal_hash'] ? $po_info['proposal_hash'] : $item_array[0]['proposal_hash']);
	                        
	                        if ($po_hash != 'UNORDERED')
	                            $tbl .= "
	                            <tr>
	                                <td style=\"background-color:#ffffff;font-style:italic;font-size:8pt;border-bottom:1px solid #cccccc;border-top:1px solid #cccccc\" colspan=\"9\">
	                                    <a href=\"javascript:void(0);\" onClick=\"agent.call('purchase_order','sf_loadcontent','show_popup_window','edit_po','po_hash=".$po_hash."','proposal_hash=".$proposal_hash[$i]."','popup_id=po_win');\" class=\"link_standard\" title=\"View purchase order\">
	                                        Purchase Order: ".$po_info['po_no']."</a> : ".$po_info['vendor_name']." : ".$po_info['po_product'].($po_info['total_ack_lines'] > 0 ? 
	                                            " ".($po_info['total_unack_lines'] == 0 ? "Fully" : "Partially")." Acknowledged" : NULL)."
	                                    <div style=\"margin:5px;15px;\">
	                                        ".$this->ship_to($po_info['ship_to_hash'])."
	                                    </div>
	                                </td>
	                            </tr>";
	                        
	                        for ($j = 0; $j < count($item_array); $j++) {
	                            $proposal_totals['cost'] += $item_array[$j]['ext_cost'];
	                            $proposal_totals['sell'] += $item_array[$j]['ext_sell'];
	                                
	                            $tbl .= "
	                            <tr onMouseOver=\"this.className='item_row_over'\" onMouseOut=\"this.className=''\" onClick=\"agent.call('proposals','sf_loadcontent','show_popup_window','edit_item','proposal_hash=".$proposal_hash[$i]."','item_hash=".$item_array[$j]['item_hash']."','popup_id=item_win');\" title=\"View line item\">
	                                <td style=\"font-size:8pt;".($j < count($item_array) - 1 ? "border-bottom:1px solid #cccccc;" : NULL)."\">".$item_array[$j]['qty']."&nbsp;</td>
	                                <td style=\"font-size:8pt;".($j < count($item_array) - 1 ? "border-bottom:1px solid #cccccc;" : NULL)."\">".$item_array[$j]['item_no']."&nbsp;</td>
	                                <td style=\"font-size:8pt;".($j < count($item_array) - 1 ? "border-bottom:1px solid #cccccc;" : NULL)."\" ".(strlen($item_array[$j]['item_descr']) > 32 ? "title=\"".htmlspecialchars($item_array[$j]['item_descr'])."\"" : NULL).">".(strlen($item_array[$j]['item_descr']) > 32 ? 
	                                    stripslashes(substr($item_array[$j]['item_descr'],0,29))."..." : stripslashes($item_array[$j]['item_descr']))."
	                                </td>
	                                <td style=\"font-size:8pt;".($j < count($item_array) - 1 ? "border-bottom:1px solid #cccccc;" : NULL)."\">".(trim($item_array[$j]['ack_no']) ? 
	                                    $item_array[$j]['ack_no'] : "&nbsp;")."
	                                </td>
	                                <td style=\"font-size:8pt;".($j < count($item_array) - 1 ? "border-bottom:1px solid #cccccc;" : NULL)."\">".($item_array[$j]['ship_date'] && $item_array[$j]['ship_date'] != '0000-00-00' ? 
	                                    date(DATE_FORMAT,strtotime($item_array[$j]['ship_date'])) : "&nbsp;")."
	                                </td>
	                                <td style=\"font-size:8pt;".($j < count($item_array) - 1 ? "border-bottom:1px solid #cccccc;" : NULL)."\">".($item_array[$j]['receive_date'] && $item_array[$j]['receive_date'] != '0000-00-00' ? 
	                                    date(DATE_FORMAT,strtotime($item_array[$j]['receive_date'])) : "&nbsp;")."
	                                </td>
	                                <td style=\"text-align:right;font-size:8pt;".($j < count($item_array) - 1 ? "border-bottom:1px solid #cccccc;" : NULL)."\">".($item_array[$j]['ext_cost'] < 0 ? 
	                                    "($".number_format($item_array[$j]['ext_cost'] * -1,2).")" : "$".number_format($item_array[$j]['ext_cost'],2))."</td>
	                                <td style=\"text-align:right;font-size:8pt;".($j < count($item_array) - 1 ? "border-bottom:1px solid #cccccc;" : NULL)."\">".($item_array[$j]['ext_sell'] < 0 ? 
	                                    "($".number_format($item_array[$j]['ext_sell'] * -1,2).")" : "$".number_format($item_array[$j]['ext_sell'],2))."</td>
	                                <td style=\"text-align:right;font-size:8pt;".($j < count($item_array) - 1 ? "border-bottom:1px solid #cccccc;" : NULL).(defined('MARGIN_FLAG') && math::gp_margin($item_array[$j]['ext_cost'],$item_array[$j]['ext_sell']) < MARGIN_FLAG ? "color:#ff0000;" : NULL)."padding-right:5px;\">".(math::gp_margin($item_array[$j]['ext_cost'],$item_array[$j]['ext_sell']) * 100 < 0 ? 
	                                    "(".((math::gp_margin($item_array[$j]['ext_cost'],$item_array[$j]['ext_sell']) * 100) * -1).")" : math::gp_margin($item_array[$j]['ext_cost'],$item_array[$j]['ext_sell']) * 100)."%</td>
	                            </tr>"; 
	                        }  
	                           
	                        $sales_hash = $item_array[0]['sales_hash'];                                          
	                    }
	                    
	                    $tbl .= "
	                        <tr>
	                            <td style=\"background-color:#efefef;text-align:right;font-weight:bold;font-size:8pt;border-top:1px solid #cccccc;padding-right:5px;\" colspan=\"6\">
	                                <div style=\"padding-top:5px;padding-right:10px;\">Totals for Proposal ".$po_info['proposal_no'].":</div>
	                            </td>
	                            <td style=\"background-color:#efefef;text-align:right;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;padding-right:5px;\">
	                                <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".($proposal_totals['cost'] < 0 ? 
	                                    "($".number_format($proposal_totals['cost'] * -1,2).")" : "$".number_format($proposal_totals['cost'],2))."                                                       
	                                
	                                </div>
	                            </td>
	                            <td style=\"background-color:#efefef;text-align:right;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;padding-right:5px;\">
	                                <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".($proposal_totals['sell'] < 0 ? 
	                                    "($".number_format($proposal_totals['sell'] * -1,2).")" : "$".number_format($proposal_totals['sell'],2))."                                                        
	                                
	                                </div>
	                            </td>
	                            <td style=\"background-color:#efefef;text-align:right;font-size:8pt;font-weight:bold;border-top:1px solid #cccccc;padding-right:5px;\">
	                                <div style=\"border-top:1px dashed #000000;width:90%;padding-top:5px;\">".(math::gp_margin($proposal_totals['cost'],$proposal_totals['sell']) * 100 < 0 ? 
	                                    "(".((math::gp_margin($proposal_totals['cost'],$proposal_totals['sell']) * 100) * -1).")" : (math::gp_margin($proposal_totals['cost'],$proposal_totals['sell']) * 100))."%
	                                
	                                </div>
	                            </td>
	                        </tr>
	                    </table>";   
	                    
	                    if ($report_hash) {
	                        $_SESSION['backlog_total'][$report_hash][$sales_hash]['cost'] += $proposal_totals['cost'];
	                        $_SESSION['backlog_total'][$report_hash][$sales_hash]['sell'] += $proposal_totals['sell'];
	                    }
		        	}

		        }
		        if ($local)
                    return $tbl;		          
                    
                if ($tbl) {
    		        $this->content['html']['po_holder'.$proposal_hash[$i]] = $tbl;
    		        $this->content['jscript'][] = "toggle_display('po_holder".$proposal_hash[$i]."','block');";
                }
    		}
    	}
    	if ($tbl && $multi) 
	    	$this->content['jscript'][] = "remote_fetch();";
    	

    	return;
    }    
    
    function get_items($po_hash=NULL,$proposal_hash=NULL) {
        if (!$po_hash)
            $po_hash = $this->ajax_vars['po_hash'];
        if (!$proposal_hash)
            $proposal_hash = $this->ajax_vars['proposal_hash'];
            
        $po = new purchase_order($proposal_hash);
        $po->fetch_po_record($proposal_hash,$po_hash);
        $lines = new line_items($proposal_hash);
        
        $item_menu = array();
        
        for ($k = 0; $k < $po->current_po['total_items']; $k++) {
            $result = $this->db->query("SELECT `ack_no` , `item_descr` , `ship_date` , `receive_date`
                                        FROM `".DB_PREFIX."line_items`
                                        WHERE `item_hash` = '".$po->current_po['line_items'][$k]."'");
            $ship_date = ($this->db->result($result,0,'ship_date') != '0000-00-00' ? $this->db->result($result,0,'ship_date') : NULL);
            $receive_date = ($this->db->result($result,0,'receive_date') != '0000-00-00' ? $this->db->result($result,0,'receive_date') : NULL);
            $item_menu[] = "
            <div style=\"font-size:8pt;padding:0 0 5px 5px;\" ".($this->db->result($result,0,'ack_no') ? "title=\"This line item has already been acknowledged!\"" : NULL).">
                ".$this->form->checkbox("name=po_line[]","value=".$po->current_po['line_items'][$k],"checked").
                "&nbsp;".(strlen($this->db->result($result,0,'item_descr')) > 45 ? 
                    substr($this->db->result($result,0,'item_descr'),0,43)."..." : $this->db->result($result,0,'item_descr')).
                "<div style=\"margin-left:5px;margin-bottom:5px;font-style:italic;\">".($this->db->result($result,0,'ack_no') ? 
                    "<br />Ack No: ".$this->db->result($result,0,'ack_no') : NULL).($ship_date ? 
                    "<br />Shipping: ".$ship_date : NULL).($receive_date ? 
                    "<br />Received: ".$receive_date : NULL)."  
                </div>
            </div>";
        }
        
        $time += 30;
        
        $tbl = $this->form->form_tag()."
        <div id=\"poList".$po_hash."\" class=\"function_menu\" style=\"width:465px;display:block;\">
            <div style=\"float:right;padding:3px\">
                <a href=\"javascript:void(0);\" onClick=\"toggle_display('poList".$po_hash."','none');\"><img src=\"images/close.gif\" border=\"0\"></a>
            </div>
            <div class=\"function_menu_item\" style=\"font-weight:bold;background-color:#365082;color:#ffffff;\">
                Enter PO Information Below:".($po->current_po['fully_ack'] ? "
                    <span style=\"padding-left:5px;font-style:italic;font-weight:normal;\">(fully acknowledged)</span>" : NULL)."
            </div>
            <table cellpadding=\"0\" cellspacing=\"1\" style=\"width:100%;\">
                <tr>
                    <td style=\"width:40%;background-color:#bbc7ce;\">
                        <div style=\"color:#000000;height:86px;margin-right:1px;overflow:auto;\">
                            ".@implode("",$item_menu)."
                        </div>
                    </td>
                    <td style=\"width:60%;background-color:#bbc7ce;\">
                        <table style=\"width:100%;\" cellpadding=\"5\" cellspacing=\"0\">
                            <tr>
                                <td style=\"text-align:right;width:35%;padding-right:5px;border-bottom:1px solid #ffffff;color:#000000;\">Ack No:</td>
                                <td style=\"border-bottom:1px solid #ffffff;\">".$this->form->text_box("name=ack_no","value=","size=25")."</td>
                            </tr>
                        </table>
                        <table style=\"width:100%;\" cellpadding=\"5\" cellspacing=\"0\">
                            <tr>
                                <td style=\"text-align:right;width:35%;padding-right:5px;border-bottom:1px solid #ffffff;color:#000000;\">Ship Date: </td>
                                <td style=\"border-bottom:1px solid #ffffff;color:#000000;\" id=\"po_ship_date".$po_hash."\">";
                                $this->content['jscript'][] = "setTimeout('DateInput(\'ship_date\',false, \'YYYY-MM-DD\',\'\',1,\'po_ship_date".$po_hash."\')',".$time.");";                        
                                $tbl .= "
                                </td>
                            </tr>
                        </table>
                        <table style=\"width:100%;\" cellpadding=\"5\" cellspacing=\"0\">
                            <tr>
                                <td style=\"text-align:right;width:35%;padding-right:5px;color:#000000;\">Receive Date: </td>
                                <td id=\"po_receive_date".$po_hash."\" style=\"color:#000000;\">";
                                $this->content['jscript'][] = "setTimeout('DateInput(\'receive_date\',false, \'YYYY-MM-DD\',\'\',1,\'po_receive_date".$po_hash."\')',".($time + 15).");";                       
                                $tbl .= "
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan=\"2\" style=\"padding:5px;background-color:#bbc7ce;\">
                        <div style=\"float:right;\">".$this->form->button("value=Save","onclick=submit_form(this.form,'purchase_order','exec_post','refresh_form','method=tag','proposal_hash=".$proposal_hash."','po_hash=".$po_hash."','jscript_action=agent.call(\'reports\',\'sf_loadcontent\',\'cf_loadcontent\',\'show_po_details\',\'proposal_hash:".$proposal_hash."\');');window.setTimeout('toggle_display(\'poList".$po_hash."\',\'none\');',1000);")."</div>
                        [<small><a href=\"javascript:void(0);\" class=\"link_standard\" onClick=\"if(confirm('Are you sure you want to erase all the acknowledgement information stored for this PO?')){submit_form(\$('receive_date').form,'reports','exec_post','refresh_form','action=doit_status_report','method=clear_ack_info','proposal_hash=$proposal_hash','po_hash=".$po_hash."');}\">clear all acknowledgement info</a></small>]
                    </td>
                </tr>
            </table>
        </div>".$this->form->close_form();
                        
        $this->content['html']['poListHolder'.$po_hash] = $tbl;
        return;
    }    
	
	
	/**
	 * Return a correctly formatted dollar amount string given a decimal number. Returns null if 0. 
	 * Ex:  format_dollars(47282.492) returns $47,282.49
	 * Ex2: format_dollars(-52.22) returns ($52.22)
	 * Ex3: format_dollars(0) returns NULL
	 */	
	function format_dollars($number) {
		return ($number != 0 ? ($number < 0 ? "($".number_format($number * -1,2).")" : "$".number_format($number,2)) : NULL);
	}
	/**
	 * Return a correctly formatted dollar amount string given a decimal number. Returns $0.00 if 0. 
	 * Ex:  format_dollars(47282.492) returns $47,282.49
	 * Ex2: format_dollars(-52.22) returns ($52.22)
	 * Ex3: format_dollars(0) returns $0.00
	 */
	function format_dollars_show_zero($number) {
		return ($number != 0 ? ($number < 0 ? "($".number_format($number * -1,2).")" : "$".number_format($number,2)) : "$0.00");
	}	
}
?>
